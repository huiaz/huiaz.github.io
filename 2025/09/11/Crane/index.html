<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Crane | Hui's Blog</title><meta name="author" content="六一"><meta name="copyright" content="六一"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="CraneCrane 是一个基于 FinOps 的云资源分析与成本优化平台，它的愿景是在保证客户应用运行质量的前提下实现极致的降本。Crane 已经在腾讯内部自研业务实现了大规模落地，部署数百个 Kubernetes 集群、管控 CPU 核数达百万，在降本增效方面取得了阶段性成果。以腾讯某部门集群优化为例，通过使用 FinOps Crane，该部门在保障业务稳定的情况下，资源利用率提升了 3 倍；">
<meta property="og:type" content="article">
<meta property="og:title" content="Crane">
<meta property="og:url" content="https://huiaz.github.io/2025/09/11/Crane/index.html">
<meta property="og:site_name" content="Hui&#39;s Blog">
<meta property="og:description" content="CraneCrane 是一个基于 FinOps 的云资源分析与成本优化平台，它的愿景是在保证客户应用运行质量的前提下实现极致的降本。Crane 已经在腾讯内部自研业务实现了大规模落地，部署数百个 Kubernetes 集群、管控 CPU 核数达百万，在降本增效方面取得了阶段性成果。以腾讯某部门集群优化为例，通过使用 FinOps Crane，该部门在保障业务稳定的情况下，资源利用率提升了 3 倍；">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://huiaz.github.io/img/butterfly-icon.png">
<meta property="article:published_time" content="2025-09-11T12:32:34.000Z">
<meta property="article:modified_time" content="2025-09-11T14:26:45.063Z">
<meta property="article:author" content="六一">
<meta property="article:tag" content="运维">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="FinOps">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://huiaz.github.io/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Crane",
  "url": "https://huiaz.github.io/2025/09/11/Crane/",
  "image": "https://huiaz.github.io/img/butterfly-icon.png",
  "datePublished": "2025-09-11T12:32:34.000Z",
  "dateModified": "2025-09-11T14:26:45.063Z",
  "author": [
    {
      "@type": "Person",
      "name": "六一",
      "url": "https://huiaz.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://huiaz.github.io/2025/09/11/Crane/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.13.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Crane',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">274</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">45</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Hui's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">Crane</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Crane</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-11T12:32:34.000Z" title="发表于 2025-09-11 20:32:34">2025-09-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-11T14:26:45.063Z" title="更新于 2025-09-11 22:26:45">2025-09-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/k8s/">k8s</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/k8s/%E5%85%B6%E4%BB%96/">其他</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Crane"><a href="#Crane" class="headerlink" title="Crane"></a>Crane</h1><p><a target="_blank" rel="noopener" href="https://gocrane.io/">Crane</a> 是一个基于 FinOps 的云资源分析与成本优化平台，它的愿景是在保证客户应用运行质量的前提下实现极致的降本。Crane 已经在腾讯内部自研业务实现了大规模落地，部署数百个 Kubernetes 集群、管控 CPU 核数达百万，在降本增效方面取得了阶段性成果。以腾讯某部门集群优化为例，通过使用 FinOps Crane，该部门在保障业务稳定的情况下，资源利用率提升了 3 倍；腾讯另一自研业务落地 Crane 后，在一个月内实现了总 CPU 规模 40 万核的节省量，相当于成本节约超 1000 万元&#x2F;月。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1666249414588.png" alt="FinOps"></p>
<blockquote>
<p>FinOps 是将 DevOps、财务和业务整合在一起的变革，其目标在于优化一个组织在云计算上的支出的财务规范和技术解决方案，即根据支出的历史记录和来自预期负载的信息，FinOps 可以在需要时预分配资源或估算成本。FinOps 可以称为“财务运维” ，或者更直白地称为“成本优化”，是将财务问责制引入云的 IT 支持，进行调整以优化质量和支出。</p>
</blockquote>
<p><code>Crane</code> 会通过下面 3 个方面来开启成本优化之旅：</p>
<ul>
<li>成本展示: Kubernetes 资源( Deployments, StatefulSets )的多维度聚合与展示。</li>
<li>成本分析: 周期性的分析集群资源的状态并提供优化建议。</li>
<li>成本优化: 通过丰富的优化工具更新配置达成降本的目标。</li>
</ul>
<p><img src="https://picdn.youdianzhishi.com/images/1666249357026.jpg" alt="Crane整体架构"></p>
<p><strong>成本可视化和优化评估</strong></p>
<ul>
<li>提供一组 Exporter 计算集群云资源的计费和账单数据并存储到你的监控系统，比如 Prometheus。</li>
<li>多维度的成本洞察，优化评估。通过 Cloud Provider 支持多云计费。</li>
</ul>
<p><strong>推荐框架</strong></p>
<ul>
<li>提供了一个可扩展的推荐框架以支持多种云资源的分析，内置了多种推荐器：<code>资源推荐</code>、<code>副本推荐</code>、<code>闲置资源推荐</code>。</li>
</ul>
<p><strong>基于预测的水平弹性器</strong></p>
<ul>
<li><code>EffectiveHorizontalPodAutoscaler</code> 支持预测驱动的弹性。它基于社区 HPA 做底层的弹性控制，支持更丰富的弹性触发策略（预测、观测、周期），让弹性更加高效，并保障了服务的质量。</li>
</ul>
<p><strong>负载感知的调度器</strong></p>
<ul>
<li>动态调度器根据实际的节点利用率构建了一个简单但高效的模型，并过滤掉那些负载高的节点来平衡集群。</li>
</ul>
<p><strong>基于 QOS 的混部</strong></p>
<ul>
<li><code>QOS</code> 相关能力保证了运行在 Kubernetes 上的 Pod 的稳定性。具有多维指标条件下的干扰检测和主动回避能力，支持精确操作和自定义指标接入；具有预测算法增强的弹性资源超卖能力，复用和限制集群内的空闲资源；具备增强的旁路 cpuset 管理能力，在绑核的同时提升资源利用效率。</li>
</ul>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p>Crane 的整体架构如下图所示：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1666249962271.jpg" alt="架构"></p>
<p><strong>Craned</strong>：Craned 是 Crane 的最核心组件，它管理了 CRDs 的生命周期以及 API，Craned 通过 Deployment 方式部署且由两个容器组成：</p>
<ul>
<li>Craned: 运行了 Operators 用来管理 CRDs，向 Dashboard 提供 WebApi，Predictors 提供了 TimeSeries API</li>
<li>Dashboard: 基于 TDesign’s Starter 脚手架研发的前端项目，提供了易于上手的产品功能</li>
</ul>
<p><strong>Fadvisor</strong>：<code>Fadvisor</code> 提供一组 Exporter 计算集群云资源的计费和账单数据并存储到你的监控系统，比如 Prometheus。Fadvisor 通过 Cloud Provider 支持了多云计费的 API。</p>
<p><strong>Metric Adapter</strong>：<code>Metric Adapter</code> 实现了一个 Custom Metric Apiserver，Metric Adapter 读取 CRDs 信息并提供基于 Custom&#x2F;External Metric API 的 HPA Metric 的数据。</p>
<p><strong>Crane Agent</strong>：Crane Agent 通过 DaemonSet 部署在集群的节点上。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>我们这里使用 Helm 的方式来进行安装，首先需要安装 Prometheus 和 Grafana（如果您已经在环境中部署了 Prometheus 和 Grafana，可以跳过该步骤）。</p>
<p><code>Crane</code> 使用 Prometheus 获取集群工作负载对资源的使用情况，可以使用如下所示命令安装 Prometheus：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add prometheus-community https://finops-helm.pkg.coding.net/gocrane/prometheus-community</span><br><span class="line">$ helm upgrade --install prometheus -n crane-system \</span><br><span class="line">    --<span class="built_in">set</span> pushgateway.enabled=<span class="literal">false</span> \</span><br><span class="line">    --<span class="built_in">set</span> alertmanager.enabled=<span class="literal">false</span> \</span><br><span class="line">    --<span class="built_in">set</span> server.persistentVolume.enabled=<span class="literal">false</span> \</span><br><span class="line">    -f https://gitee.com/finops/helm-charts/raw/main/integration/prometheus/override_values.yaml \</span><br><span class="line">    --create-namespace  prometheus-community/prometheus</span><br></pre></td></tr></table></figure>



<p>由于 Crane 的 <code>Fadvisor</code> 会使用 Grafana 来展示成本预估，所以我们也需要安装 Grafana：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add grafana https://finops-helm.pkg.coding.net/gocrane/grafana</span><br><span class="line">$ helm upgrade --install grafana \</span><br><span class="line">    -f https://gitee.com/finops/helm-charts/raw/main/integration/grafana/override_values.yaml \</span><br><span class="line">    -n crane-system \</span><br><span class="line">    --create-namespace grafana/grafana</span><br></pre></td></tr></table></figure>



<p>上面我们指定的 values 文件中配置了 Prometheus 数据源以及一些相关的 Dashboard，直接安装后即可使用。</p>
<p>然后接下来安装 crane 与 fadvisor，同样直接使用 Helm Chart 安装即可，如下命令所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add crane https://finops-helm.pkg.coding.net/gocrane/gocrane</span><br><span class="line">$ helm upgrade --install crane -n crane-system --create-namespace crane/crane</span><br><span class="line">$ helm upgrade --install fadvisor -n crane-system --create-namespace crane/fadvisor</span><br></pre></td></tr></table></figure>



<p>安装后可以查看 Pod 列表了解应用状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n crane-system</span><br><span class="line">NAME                                             READY   STATUS             RESTARTS         AGE</span><br><span class="line">crane-agent-8jrs5                                0/1     CrashLoopBackOff   71 (2m26s ago)   3h23m</span><br><span class="line">crane-agent-t2rpz                                0/1     CrashLoopBackOff   71 (65s ago)     3h23m</span><br><span class="line">craned-776c7b6c75-gx8cp                          2/2     Running            0                3h28m</span><br><span class="line">fadvisor-56fcc547b6-zvf6r                        1/1     Running            0                158m</span><br><span class="line">grafana-5cd57f9f6b-d7nk5                         1/1     Running            0                3h32m</span><br><span class="line">metric-adapter-887f6548d-qcbb8                   1/1     Running            0                3h28m</span><br><span class="line">prometheus-kube-state-metrics-5f6f856ffb-4lrrr   1/1     Running            0                3h34m</span><br><span class="line">prometheus-node-exporter-97vmz                   1/1     Running            0                3h27m</span><br><span class="line">prometheus-node-exporter-m2gr9                   1/1     Running            0                3h27m</span><br><span class="line">prometheus-server-7744f66fb4-lw2sz               2/2     Running            0                3h34m</span><br></pre></td></tr></table></figure>



<p>需要注意我们这里 crane-agent 启动失败了，这是因为我的 K8s 集群使用的是 containerd 这种容器运行时，需要明确声明指定使用的运行时 endpoint：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit ds crane-agent -n crane-system</span><br><span class="line"><span class="comment"># ......</span></span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - --v=2</span><br><span class="line">        - --runtime-endpoint=/run/containerd/containerd.sock  <span class="comment"># 指定有containerd的sock文件</span></span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - /crane-agent</span><br><span class="line"><span class="comment"># ......</span></span><br></pre></td></tr></table></figure>



<p>此外还需要更新 crane-agent 的 rbac 权限：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit clusterrole crane-agent</span><br><span class="line"><span class="comment"># ......</span></span><br><span class="line">- apiGroups:</span><br><span class="line">  - ensurance.crane.io</span><br><span class="line">  resources:</span><br><span class="line">  - podqosensurancepolicies</span><br><span class="line">  - nodeqoss  <span class="comment"># 增加 nodeqoss 和 podqoss 资源的权限</span></span><br><span class="line">  - podqoss</span><br><span class="line"><span class="comment"># ......</span></span><br></pre></td></tr></table></figure>



<p>然后我们可以再创建一个 Ingress 对象来暴露 crane 的 dashboard 服务：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-crane-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">crane-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">crane.k8s.local</span> <span class="comment"># change to your domain</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">craned</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">9090</span></span><br></pre></td></tr></table></figure>



<p>直接应用该 ingress 资源对象即可，当然前提是你已经安装了 ingress-nginx：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n ingress-nginx</span><br><span class="line">NAME                                            READY   STATUS    RESTARTS      AGE</span><br><span class="line">ingress-nginx-controller-7647c44fb9-6gcsf       1/1     Running   8 (44m ago)   21d</span><br><span class="line">ingress-nginx-defaultbackend-7fc5bfd66c-gqmmj   1/1     Running   8 (44m ago)   21d</span><br><span class="line">$ kubectl get ingress -n crane-system</span><br><span class="line">NAME                      CLASS   HOSTS             ADDRESS        PORTS   AGE</span><br><span class="line">ingress-crane-dashboard   nginx   crane.k8s.local   192.168.0.52   80      11s</span><br></pre></td></tr></table></figure>



<p>将 <code>crane.k8s.local</code> 映射到 <code>192.168.0.52</code> 后就可以访问 crane 的 dashboard 了：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1666251698513.png" alt="crane dashboard"></p>
<p>第一次访问 dashboard 的时候需要添加一个 K8s 集群，添加<code>添加集群</code>按钮开始添加，填入正确的 <code>CRNE Endpoint</code> 地址即可。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1666251839866.png" alt="添加集群"></p>
<p>然后切换到<code>集群总览</code>可以查看到当前集群的一些成本相关数据，由于目前数据还不足，所以会有一些空的图表。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1666256619382.png" alt="集群总览"></p>
<p>在成本分布页面可以按照维度成本、集群成本和利用率指标以及命名空间成本来展示成本的分布情况。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1666260576817.jpg" alt="成本分布"></p>
<h2 id="智能推荐"><a href="#智能推荐" class="headerlink" title="智能推荐"></a>智能推荐</h2><p>在 dasbhoard 中开箱后就可以看到相关的成本数据，是因为在添加集群的时候我们安装了推荐的规则。</p>
<p>推荐框架会自动分析集群的各种资源的运行情况并给出优化建议。<code>Crane</code> 的推荐模块会定期检测发现集群资源配置的问题，并给出优化建议。智能推荐提供了多种 Recommender 来实现面向不同资源的优化推荐。</p>
<p>在<code>成本分析&gt;推荐规则</code>页面可以看到我们安装的两个推荐规则。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1666252873850.jpg" alt="推荐规则"></p>
<p>这些推荐规则实际上是安装在 K8s 集群上的 <code>RecommendationRule CRD</code> 对象：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get RecommendationRule</span><br><span class="line">NAME             RUNINTERVAL   AGE</span><br><span class="line">idlenodes-rule   24h           16m</span><br><span class="line">workloads-rule   24h           16m</span><br></pre></td></tr></table></figure>



<p><code>workloads-rule</code> 这个推荐规则的资源对象如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">analysis.crane.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RecommendationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">workloads-rule</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">analysis.crane.io/recommendation-rule-preinstall:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">resourceSelectors:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">any:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">runInterval:</span> <span class="string">24h</span></span><br><span class="line">  <span class="attr">recommenders:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Replicas</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Resource</span></span><br></pre></td></tr></table></figure>



<p><code>RecommendationRule</code> 是一个全部范围内的对象，该推荐规则会对所有命名空间中的 Deployments 和 StatefulSets 做资源推荐和副本数推荐。相关规范属性如下所示：</p>
<ul>
<li>每隔 24 小时运行一次分析推荐，<code>runInterval</code> 格式为时间间隔，比如: 1h，1m，设置为空表示只运行一次。</li>
<li>待分析的资源通过配置 <code>resourceSelectors</code> 数组设置，每个 <code>resourceSelector</code> 通过 <code>kind</code>、<code>apiVersion</code>、<code>name</code> 选择 K8s 中的资源，当不指定 name 时表示在 <code>namespaceSelector</code> 基础上的所有资源。</li>
<li><code>namespaceSelector</code> 定义了待分析资源的命名空间，<code>any: true</code> 表示选择所有命名空间。</li>
<li><code>recommenders</code> 定义了待分析的资源需要通过哪些 <code>Recommender</code> 进行分析。目前支持两种 <code>Recommender</code>：<ul>
<li>资源推荐(Resource): 通过 VPA 算法分析应用的真实用量推荐更合适的资源配置</li>
<li>副本数推荐(Replicas): 通过 HPA 算法分析应用的真实用量推荐更合适的副本数量</li>
</ul>
</li>
</ul>
<p><strong>资源推荐</strong></p>
<p>Kubernetes 用户在创建应用资源时常常是基于经验值来设置 request 和 limit，通过资源推荐的算法分析应用的真实用量推荐更合适的资源配置，你可以参考并采纳它提升集群的资源利用率。该推荐算法模型采用了 VPA 的滑动窗口（Moving Window）算法进行推荐：</p>
<ul>
<li>通过监控数据，获取 Workload 过去一周（可配置）的 CPU 和内存的历史用量。</li>
<li>算法考虑数据的时效性，较新的数据采样点会拥有更高的权重。</li>
<li>CPU 推荐值基于用户设置的目标百分位值计算，内存推荐值基于历史数据的最大值。</li>
</ul>
<p><strong>副本数推荐</strong></p>
<p>Kubernetes 用户在创建应用资源时常常是基于经验值来设置副本数。通过副本数推荐的算法分析应用的真实用量推荐更合适的副本配置，同样可以参考并采纳它提升集群的资源利用率。其实现的基本算法是基于工作负载历史 CPU 负载，找到过去七天内每小时负载最低的 CPU 用量，计算按 50%（可配置）利用率和工作负载 CPU Request 应配置的副本数。</p>
<p>当我们部署 crane 的时候会在同一个命名空间中创建一个名为 <code>recommendation-configuration</code> 的 ConfigMap 对象，包含一个 yaml 格式的 <code>RecommendationConfiguration</code>，该配置订阅了 <code>recommender</code> 的配置，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">cm</span> <span class="string">recommendation-configuration</span> <span class="string">-n</span> <span class="string">crane-system</span> <span class="string">-oyaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">config.yaml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    apiVersion: analysis.crane.io/v1alpha1</span></span><br><span class="line"><span class="string">    kind: RecommendationConfiguration</span></span><br><span class="line"><span class="string">    recommenders:</span></span><br><span class="line"><span class="string">      - name: Replicas  # 副本数推荐</span></span><br><span class="line"><span class="string">        acceptedResources:</span></span><br><span class="line"><span class="string">          - kind: Deployment</span></span><br><span class="line"><span class="string">            apiVersion: apps/v1</span></span><br><span class="line"><span class="string">          - kind: StatefulSet</span></span><br><span class="line"><span class="string">            apiVersion: apps/v1</span></span><br><span class="line"><span class="string">      - name: Resource  # 资源推荐</span></span><br><span class="line"><span class="string">        acceptedResources:</span></span><br><span class="line"><span class="string">          - kind: Deployment</span></span><br><span class="line"><span class="string">            apiVersion: apps/v1</span></span><br><span class="line"><span class="string">          - kind: StatefulSet</span></span><br><span class="line"><span class="string">            apiVersion: apps/v1</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">recommendation-configuration</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">crane-system</span></span><br></pre></td></tr></table></figure>



<p>需要注意的是资源类型和 recommenders 需要可以匹配，比如 Resource 推荐默认只支持 Deployments 和 StatefulSets。</p>
<p>同样的也可以再查看一次闲置节点推荐规则的资源对象，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">recommendationrule</span> <span class="string">idlenodes-rule</span> <span class="string">-oyaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">analysis.crane.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RecommendationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">analysis.crane.io/recommendation-rule-preinstall:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">idlenodes-rule</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">any:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">recommenders:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IdleNode</span></span><br><span class="line">  <span class="attr">resourceSelectors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Node</span></span><br><span class="line">  <span class="attr">runInterval:</span> <span class="string">24h</span></span><br></pre></td></tr></table></figure>



<p>创建 <code>RecommendationRule</code> 配置后，RecommendationRule 控制器会根据配置定期运行推荐任务，给出优化建议生成 <code>Recommendation</code> 对象，然后我们可以根据优化建议 <code>Recommendation</code> 调整资源配置。</p>
<p>比如我们这里集群中已经生成了多个优化建议 <code>Recommendation</code> 对象。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get recommendations</span><br><span class="line">NAME                            TYPE       TARGETKIND    TARGETNAMESPACE   TARGETNAME       STRATEGY   PERIODSECONDS   ADOPTIONTYPE          AGE</span><br><span class="line">workloads-rule-resource-8whzs   Resource   StatefulSet   default           nacos            Once                       StatusAndAnnotation   34m</span><br><span class="line">workloads-rule-resource-hx4cp   Resource   StatefulSet   default           redis-replicas   Once                       StatusAndAnnotation   34m</span><br><span class="line"><span class="comment"># ......</span></span><br></pre></td></tr></table></figure>



<p>可以随便查看任意一个优化建议对象。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">recommend</span> <span class="string">workloads-rule-resource-g7nwp</span> <span class="string">-n</span> <span class="string">crane-system</span> <span class="string">-oyaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">analysis.crane.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Recommendation</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">workloads-rule-resource-g7nwp</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">crane-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">adoptionType:</span> <span class="string">StatusAndAnnotation</span></span><br><span class="line">  <span class="attr">completionStrategy:</span></span><br><span class="line">    <span class="attr">completionStrategyType:</span> <span class="string">Once</span></span><br><span class="line">  <span class="attr">targetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">fadvisor</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">crane-system</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">Patch</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-10-20T07:43:49Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Recommendation</span> <span class="string">is</span> <span class="string">ready</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">RecommendationReady</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">  <span class="attr">currentInfo:</span> <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;template&quot;:&#123;&quot;spec&quot;:&#123;&quot;containers&quot;:[&#123;&quot;name&quot;:&quot;fadvisor&quot;,&quot;resources&quot;:&#123;&quot;requests&quot;:&#123;&quot;cpu&quot;:&quot;0&quot;,&quot;memory&quot;:&quot;0&quot;&#125;&#125;&#125;]&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class="line">  <span class="attr">lastUpdateTime:</span> <span class="string">&quot;2022-10-20T07:43:49Z&quot;</span></span><br><span class="line">  <span class="attr">recommendedInfo:</span> <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;template&quot;:&#123;&quot;spec&quot;:&#123;&quot;containers&quot;:[&#123;&quot;name&quot;:&quot;fadvisor&quot;,&quot;resources&quot;:&#123;&quot;requests&quot;:&#123;&quot;cpu&quot;:&quot;114m&quot;,&quot;memory&quot;:&quot;120586239&quot;&#125;&#125;&#125;]&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class="line">  <span class="attr">recommendedValue:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    resourceRequest:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - containerName: fadvisor</span></span><br><span class="line"><span class="string">        target:</span></span><br><span class="line"><span class="string">          cpu: 114m</span></span><br><span class="line"><span class="string">          memory: &quot;120586239&quot;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">targetRef:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>



<p>在 dashboard 的<code>资源推荐</code>页面也能查看到优化建议列表。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1666253982497.jpg" alt="资源推荐"></p>
<p>在页面中可以看到当前资源(容器&#x2F;CPU&#x2F;Memory)与推荐的资源数据，点击<code>采纳建议</code>即可获取优化的执行命令。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1666254060338.png" alt="查看优化命令"></p>
<p>执行命令即可完成优化，其实就是修改资源对象的 <code>resources</code> 资源数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patchData=`kubectl get recommend workloads-rule-resource-g7nwp -n crane-system -o jsonpath=<span class="string">&#x27;&#123;.status.recommendedInfo&#125;&#x27;</span>`;kubectl patch Deployment fadvisor -n crane-system --patch <span class="string">&quot;<span class="variable">$&#123;patchData&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>



<p>对于闲置节点推荐，由于节点的下线在不同平台上的步骤不同，用户可以根据自身需求进行节点的下线或者缩容。</p>
<p>应用在监控系统（比如 Prometheus）中的历史数据越久，推荐结果就越准确，建议生产上超过两周时间。对新建应用的预测往往不准。</p>
<h3 id="自定义推荐"><a href="#自定义推荐" class="headerlink" title="自定义推荐"></a>自定义推荐</h3><p>Recommendation Framework 提供了一套可扩展的 Recommender 框架并支持了内置的 Recommender，用户可以实现一个自定义的 Recommender，或者修改一个已有的 Recommender。</p>
<p>和 K8s 调度框架类似，Recommender 接口定义了一次推荐需要实现的<strong>四个阶段和八个扩展点</strong>，这些扩展点会在推荐过程中按顺序被调用。这些扩展点中的一些可以改变推荐决策，而另一些仅用来提供信息。</p>
<p><img src="https://mudutestmenu.mudu.tv/upload/2um5u9.jpg" alt="推荐框架架构"></p>
<p>Recommender 接口定义如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Recommender <span class="keyword">interface</span> &#123;</span><br><span class="line">    Name() <span class="type">string</span></span><br><span class="line">    framework.Filter</span><br><span class="line">    framework.PrePrepare</span><br><span class="line">    framework.Prepare</span><br><span class="line">    framework.PostPrepare</span><br><span class="line">    framework.PreRecommend</span><br><span class="line">    framework.Recommend</span><br><span class="line">    framework.PostRecommend</span><br><span class="line">    framework.Observe</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Phase: Filter</span></span><br><span class="line"><span class="keyword">type</span> Filter <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// Filter 将过滤无法通过目标推荐器推荐的资源</span></span><br><span class="line">    Filter(ctx *RecommendationContext) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Phase: Prepare</span></span><br><span class="line"><span class="keyword">type</span> PrePrepare <span class="keyword">interface</span> &#123;</span><br><span class="line">    CheckDataProviders(ctx *RecommendationContext) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Prepare <span class="keyword">interface</span> &#123;</span><br><span class="line">    CollectData(ctx *RecommendationContext) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PostPrepare <span class="keyword">interface</span> &#123;</span><br><span class="line">    PostProcessing(ctx *RecommendationContext) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PreRecommend <span class="keyword">interface</span> &#123;</span><br><span class="line">    PreRecommend(ctx *RecommendationContext) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Phase: Recommend</span></span><br><span class="line"><span class="keyword">type</span> Recommend <span class="keyword">interface</span> &#123;</span><br><span class="line">    Recommend(ctx *RecommendationContext) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PostRecommend <span class="keyword">interface</span> &#123;</span><br><span class="line">    Policy(ctx *RecommendationContext) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Phase: Observe</span></span><br><span class="line"><span class="keyword">type</span> Observe <span class="keyword">interface</span> &#123;</span><br><span class="line">    Observe(ctx *RecommendationContext) <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>整个推荐过程分成了四个阶段：<code>Filter</code>、<code>Prepare</code>、<code>Recommend</code>、<code>Observe</code>，阶段的输入是需要分析的 Kubernetes 资源，输出是推荐的优化建议。接口中的 <code>RecommendationContext</code> 保存了一次推荐过程中的上下文，包括推荐目标、RecommendationConfiguration 等信息，我们可以根据自身需求增加更多的内容。</p>
<ul>
<li><strong>Filter</strong>：Filter 阶段用于预处理推荐数据，通常，在预处理时需判断推荐目标是否和 Recommender 匹配，比如资源推荐默认只支持处理 Deployment 和 StatefulSet。除此之外，还可以判断推荐目标状态是否适合推荐，比如是否删除中，是否刚创建等。当返回 error 会终止此次推荐。</li>
<li><strong>Prepare</strong>：Prepare 阶段用于数据准备，请求外部监控系统并将时序数据保存在上下文中。<ul>
<li><code>PrePrepare</code> 扩展点用于检测监控系统的链接情况</li>
<li><code>Prepare</code> 扩展点用于查询时序数据</li>
<li><code>PostPrepare</code> 扩展点用于对时序数据的数据处理，比如：应用冷启动的异常数据，部分数据的缺失，数据聚合，异常数据清理等。</li>
</ul>
</li>
<li><strong>Recommend</strong>：Recommend 阶段用于基于时序数据和资源配置进行优化建议，优化建议的类型取决于推荐的类型。比如，如果是资源推荐，那么输出就是 K8s workload 的资源配置。<ul>
<li><code>Recommend</code> 扩展点用于采用 Crane 的算法模块对数据进行分析计算</li>
<li><code>PostRecommend</code> 扩展点对分析结果进行最后处理</li>
</ul>
</li>
<li><code>Observe</code>：Observe 阶段用于推荐结果的可观测。比如，在资源推荐时，将优化建议的信息通过 Metric 保存到监控系统，再通过 Dashboard 观测优化建议带来的收益。</li>
</ul>
<p>比如资源推荐就实现了 Recommender 接口，主要做了下面 3 个阶段的处理：</p>
<ul>
<li>Filter 阶段：过滤没有 Pod 的工作负载</li>
<li>Recommend 推荐：采用 VPA 的滑动窗口算法分别计算每个容器的 CPU 和内存并给出对应的推荐值</li>
<li>Observe 推荐：将推荐资源配置记录到 <code>crane_analytics_replicas_recommendation</code> 指标</li>
</ul>
<p>除了核心的智能推荐功能之外，Crane 还有很多高级特性，比如可以根据实际的节点利用率的动态调度器、基于流量预测的弹性 HPA 等等。</p>
<h2 id="智能调度器"><a href="#智能调度器" class="headerlink" title="智能调度器"></a>智能调度器</h2><p><code>Crane</code> 除了提供了智能推荐功能之外，还提供了一个调度器插件 <code>Crane-scheduler</code> 可以实现智能调度和完成拓扑感知调度与资源分配的工作。</p>
<h3 id="动态调度器"><a href="#动态调度器" class="headerlink" title="动态调度器"></a>动态调度器</h3><p>K8s 的原生调度器只能通过资源的 requests 值来调度 pod，这很容易造成一系列负载不均的问题：</p>
<ul>
<li>对于某些节点，实际负载与资源请求相差不大，这会导致很大概率出现稳定性问题。</li>
<li>对于其他节点来说，实际负载远小于资源请求，这将导致资源的巨大浪费。</li>
</ul>
<p>为了解决这些问题，动态调度器根据实际的节点利用率构建了一个简单但高效的模型，并过滤掉那些负载高的节点来平衡集群。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1666261847798.jpg" alt="动态调度器架构"></p>
<p>动态调度器依赖于 prometheus 和 node-exporter 收集汇总指标数据，它由两个组件组成：</p>
<ul>
<li><code>Node-annotator</code> 定期从 Prometheus 拉取数据，并以 annotations 的形式在节点上用时间戳标记它们。</li>
<li><code>Dynamic plugin</code> 直接从节点的 annotations 中读取负载数据，过滤并基于简单的算法对候选节点进行评分。</li>
</ul>
<p>动态调度器提供了一个默认值调度策略，配置文件如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># policy.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">scheduler.policy.crane.io/v1alpha1</span></span><br><span class="line"> <span class="attr">kind:</span> <span class="string">DynamicSchedulerPolicy</span></span><br><span class="line"> <span class="attr">spec:</span></span><br><span class="line">   <span class="attr">syncPolicy:</span></span><br><span class="line">     <span class="comment">##cpu usage</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpu_usage_avg_5m</span></span><br><span class="line">       <span class="attr">period:</span> <span class="string">3m</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpu_usage_max_avg_1h</span></span><br><span class="line">       <span class="attr">period:</span> <span class="string">15m</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpu_usage_max_avg_1d</span></span><br><span class="line">       <span class="attr">period:</span> <span class="string">3h</span></span><br><span class="line">     <span class="comment">##memory usage</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mem_usage_avg_5m</span></span><br><span class="line">       <span class="attr">period:</span> <span class="string">3m</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mem_usage_max_avg_1h</span></span><br><span class="line">       <span class="attr">period:</span> <span class="string">15m</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mem_usage_max_avg_1d</span></span><br><span class="line">       <span class="attr">period:</span> <span class="string">3h</span></span><br><span class="line"></span><br><span class="line">   <span class="attr">predicate:</span></span><br><span class="line">     <span class="comment">##cpu usage</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpu_usage_avg_5m</span></span><br><span class="line">       <span class="attr">maxLimitPecent:</span> <span class="number">0.65</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpu_usage_max_avg_1h</span></span><br><span class="line">       <span class="attr">maxLimitPecent:</span> <span class="number">0.75</span></span><br><span class="line">     <span class="comment">##memory usage</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mem_usage_avg_5m</span></span><br><span class="line">       <span class="attr">maxLimitPecent:</span> <span class="number">0.65</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mem_usage_max_avg_1h</span></span><br><span class="line">       <span class="attr">maxLimitPecent:</span> <span class="number">0.75</span></span><br><span class="line"></span><br><span class="line">   <span class="attr">priority:</span></span><br><span class="line">     <span class="comment">##cpu usage</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpu_usage_avg_5m</span></span><br><span class="line">       <span class="attr">weight:</span> <span class="number">0.2</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpu_usage_max_avg_1h</span></span><br><span class="line">       <span class="attr">weight:</span> <span class="number">0.3</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpu_usage_max_avg_1d</span></span><br><span class="line">       <span class="attr">weight:</span> <span class="number">0.5</span></span><br><span class="line">     <span class="comment">##memory usage</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mem_usage_avg_5m</span></span><br><span class="line">       <span class="attr">weight:</span> <span class="number">0.2</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mem_usage_max_avg_1h</span></span><br><span class="line">       <span class="attr">weight:</span> <span class="number">0.3</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mem_usage_max_avg_1d</span></span><br><span class="line">       <span class="attr">weight:</span> <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">   <span class="attr">hotValue:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">timeRange:</span> <span class="string">5m</span></span><br><span class="line">       <span class="attr">count:</span> <span class="number">5</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">timeRange:</span> <span class="string">1m</span></span><br><span class="line">       <span class="attr">count:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>



<p>我们可以根据实际需求自定义该策略配置，默认策略依赖于以下指标：</p>
<ul>
<li>cpu_usage_avg_5m</li>
<li>cpu_usage_max_avg_1h</li>
<li>cpu_usage_max_avg_1d</li>
<li>mem_usage_avg_5m</li>
<li>mem_usage_max_avg_1h</li>
<li>mem_usage_max_avg_1d</li>
</ul>
<p>这几个指标我们这里是通过记录规则创建的，可以查看 Prometheus 的配置文件来了解详细信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">cm</span> <span class="string">-n</span> <span class="string">crane-system</span> <span class="string">prometheus-server</span> <span class="string">-oyaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">alerting_rules.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">alerts:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">allow-snippet-annotations:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      evaluation_interval: 1m</span></span><br><span class="line"><span class="string">      scrape_interval: 1m</span></span><br><span class="line"><span class="string">      scrape_timeout: 10s</span></span><br><span class="line"><span class="string">    rule_files:</span></span><br><span class="line"><span class="string">    - /etc/config/recording_rules.yml</span></span><br><span class="line"><span class="string">    - /etc/config/alerting_rules.yml</span></span><br><span class="line"><span class="string">    - /etc/config/rules</span></span><br><span class="line"><span class="string">    - /etc/config/alerts</span></span><br><span class="line"><span class="string">    scrape_configs:</span></span><br><span class="line"><span class="string">    - job_name: prometheus</span></span><br><span class="line"><span class="string">      static_configs:</span></span><br><span class="line"><span class="string">      - targets:</span></span><br><span class="line"><span class="string">        - localhost:9090</span></span><br><span class="line"><span class="string">    # ......</span></span><br><span class="line"><span class="string"></span>  <span class="attr">recording_rules.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    groups:</span></span><br><span class="line"><span class="string">    - interval: 3600s</span></span><br><span class="line"><span class="string">      name: costs.rules</span></span><br><span class="line"><span class="string">      rules:</span></span><br><span class="line"><span class="string">    #   ......</span></span><br><span class="line"><span class="string">    - interval: 30s</span></span><br><span class="line"><span class="string">      name: scheduler.rules.30s</span></span><br><span class="line"><span class="string">      rules:</span></span><br><span class="line"><span class="string">      - expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[90s]))</span></span><br><span class="line"><span class="string">          * 100)</span></span><br><span class="line"><span class="string">        record: cpu_usage_active</span></span><br><span class="line"><span class="string">      - expr: 100*(1-node_memory_MemAvailable_bytes/node_memory_MemTotal_bytes)</span></span><br><span class="line"><span class="string">        record: mem_usage_active</span></span><br><span class="line"><span class="string">    - interval: 1m</span></span><br><span class="line"><span class="string">      name: scheduler.rules.1m</span></span><br><span class="line"><span class="string">      rules:</span></span><br><span class="line"><span class="string">      - expr: avg_over_time(cpu_usage_active[5m])</span></span><br><span class="line"><span class="string">        record: cpu_usage_avg_5m</span></span><br><span class="line"><span class="string">      - expr: avg_over_time(mem_usage_active[5m])</span></span><br><span class="line"><span class="string">        record: mem_usage_avg_5m</span></span><br><span class="line"><span class="string">    - interval: 5m</span></span><br><span class="line"><span class="string">      name: scheduler.rules.5m</span></span><br><span class="line"><span class="string">      rules:</span></span><br><span class="line"><span class="string">      - expr: max_over_time(cpu_usage_avg_5m[1h])</span></span><br><span class="line"><span class="string">        record: cpu_usage_max_avg_1h</span></span><br><span class="line"><span class="string">      - expr: max_over_time(cpu_usage_avg_5m[1d])</span></span><br><span class="line"><span class="string">        record: cpu_usage_max_avg_1d</span></span><br><span class="line"><span class="string">      - expr: max_over_time(mem_usage_avg_5m[1h])</span></span><br><span class="line"><span class="string">        record: mem_usage_max_avg_1h</span></span><br><span class="line"><span class="string">      - expr: max_over_time(mem_usage_avg_5m[1d])</span></span><br><span class="line"><span class="string">        record: mem_usage_max_avg_1d</span></span><br><span class="line"><span class="string"></span>  <span class="attr">rules:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">crane-system</span></span><br></pre></td></tr></table></figure>



<p>在调度的 Filter 阶段，如果该节点的实际使用率大于上述任一指标的阈值，则该节点将被过滤。而在 Score 阶段，最终得分是这些指标值的加权和。</p>
<p>在生产集群中，可能会频繁出现调度热点，因为创建 Pod 后节点的负载不能立即增加。因此，我们定义了一个额外的指标，名为 <code>hotValue</code>，表示节点最近几次的调度频率，并且节点的最终优先级是最终得分减去 hotValue。</p>
<p>我们可以在 K8s 集群中安装 <code>Crane-scheduler</code> 作为第二个调度器来进行验证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add crane https://finops-helm.pkg.coding.net/gocrane/gocrane</span><br><span class="line">$ helm upgrade --install scheduler -n crane-system --create-namespace --<span class="built_in">set</span> global.prometheusAddr=<span class="string">&quot;http://prometheus-server.crane-system.svc.cluster.local:8080&quot;</span> crane/scheduler</span><br></pre></td></tr></table></figure>



<p>安装后会创建一个名为 <code>scheduler-config</code> 的 ConfigMap 对象，里面包含的就是调度器的配置文件，我们会在配置中启用 Dynamic 动态调度插件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">cm</span> <span class="string">-n</span> <span class="string">crane-system</span> <span class="string">scheduler-config</span> <span class="string">-oyaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">scheduler-config.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    apiVersion: kubescheduler.config.k8s.io/v1beta2</span></span><br><span class="line"><span class="string">    kind: KubeSchedulerConfiguration</span></span><br><span class="line"><span class="string">    leaderElection:</span></span><br><span class="line"><span class="string">      leaderElect: false</span></span><br><span class="line"><span class="string">    profiles:</span></span><br><span class="line"><span class="string">    - schedulerName: crane-scheduler</span></span><br><span class="line"><span class="string">      plugins:</span></span><br><span class="line"><span class="string">        filter:</span></span><br><span class="line"><span class="string">          enabled:</span></span><br><span class="line"><span class="string">          - name: Dynamic</span></span><br><span class="line"><span class="string">        score:</span></span><br><span class="line"><span class="string">          enabled:</span></span><br><span class="line"><span class="string">          - name: Dynamic</span></span><br><span class="line"><span class="string">            weight: 3</span></span><br><span class="line"><span class="string">      pluginConfig:</span></span><br><span class="line"><span class="string">      - name: Dynamic</span></span><br><span class="line"><span class="string">        args:</span></span><br><span class="line"><span class="string">          policyConfigPath: /etc/kubernetes/policy.yaml</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">scheduler-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">crane-system</span></span><br></pre></td></tr></table></figure>



<p>安装完成后我们可以任意创建一个 Pod，并通过设置 <code>schedulerName: crane-scheduler</code> 属性明确指定使用该调度器进行调度，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-stress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">cpu-stress</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">cpu-stress</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">crane-scheduler</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node.kubernetes.io/network-unavailable</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">stress</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">docker.io/gocrane/stress:latest</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&#x27;stress&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;1&#x27;</span>]</span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&#x27;1Gi&#x27;</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&#x27;1Gi&#x27;</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&#x27;1&#x27;</span></span><br></pre></td></tr></table></figure>



<p>直接创建上面的资源对象，正常创建的 Pod 就会通过 <code>Crane Scheduler</code> 调度器进行调度了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From             Message</span><br><span class="line">  ----    ------     ----  ----             -------</span><br><span class="line">  Normal  Scheduled  22s   crane-scheduler  Successfully assigned default/cpu-stress-cc8656b6c-hsqdg to node2</span><br><span class="line">  Normal  Pulling    22s   kubelet          Pulling image <span class="string">&quot;docker.io/gocrane/stress:latest&quot;</span></span><br></pre></td></tr></table></figure>



<p>如果想默认使用该动态调度器，则可以使用该调度器去替换掉默认的调度器即可。</p>
<h3 id="使用拓扑感知调度对-Pod-进行精细化调度"><a href="#使用拓扑感知调度对-Pod-进行精细化调度" class="headerlink" title="使用拓扑感知调度对 Pod 进行精细化调度"></a>使用拓扑感知调度对 Pod 进行精细化调度</h3><p>Crane-Scheduler 和 Crane-Agent 配合工作可以完成拓扑感知调度与资源分配的工作。Crane-Agent 从节点采集资源拓扑，包括 NUMA、Socket、设备等信息，汇总到 <code>NodeResourceTopology</code> 这个自定义资源对象中。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1666938840993.jpg" alt="CPU 拓扑感知"></p>
<p>Crane-Scheduler 在调度时会参考节点的 <code>NodeResourceTopology</code> 对象获取到节点详细的资源拓扑结构，在调度到节点的同时还会为 Pod 分配拓扑资源，并将结果写到 Pod 的 annotations 中。Crane-Agent 在节点上 Watch 到 Pod 被调度后，从 Pod 的 annotations 中获取到拓扑分配结果，并按照用户给定的 CPU 绑定策略进行 CPUSet 的细粒度分配。</p>
<p>Crane 中提供了四种 CPU 分配策略，分别如下：</p>
<ul>
<li><code>none</code>：该策略不进行特别的 CPUSet 分配，Pod 会使用节点 CPU 共享池。</li>
<li><code>exclusive</code>：该策略对应 kubelet 的 static 策略，Pod 会独占 CPU 核心，其他任何 Pod 都无法使用。</li>
<li><code>numa</code>：该策略会指定 NUMA Node，Pod 会使用该 NUMA Node 上的 CPU 共享池。</li>
<li><code>immovable</code>：该策略会将 Pod 固定在某些 CPU 核心上，但这些核心属于共享池，其他 Pod 仍可使用。</li>
</ul>
<p>首先需要在 Crane-Agent 启动参数中添加 <code>--feature-gates=NodeResourceTopology=true,CraneCPUManager=true</code> 开启拓扑感知调度特性。然后安装下面的步骤修改 K8s 集群默认的调度器。</p>
<ol>
<li>备份 <code>/etc/kubernetes/manifests/kube-scheduler.yaml</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /etc/kubernetes/manifests/kube-scheduler.yaml /etc/kubernetes/</span><br></pre></td></tr></table></figure>



<ol>
<li>通过修改 kube-scheduler 的配置文件（<code>scheduler-config.yaml</code> ) 启用动态调度插件并配置插件参数：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeSchedulerConfiguration</span></span><br><span class="line"><span class="attr">leaderElection:</span></span><br><span class="line">  <span class="attr">leaderElect:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">clientConnection:</span></span><br><span class="line">  <span class="attr">kubeconfig:</span> <span class="string">&#x27;REPLACE_ME_WITH_KUBE_CONFIG_PATH&#x27;</span></span><br><span class="line"><span class="attr">profiles:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">    <span class="attr">plugins:</span></span><br><span class="line">      <span class="attr">preFilter:</span></span><br><span class="line">        <span class="attr">enabled:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeResourceTopologyMatch</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">enabled:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeResourceTopologyMatch</span></span><br><span class="line">      <span class="attr">score:</span></span><br><span class="line">        <span class="attr">enabled:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeResourceTopologyMatch</span></span><br><span class="line">            <span class="attr">weight:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">reserve:</span></span><br><span class="line">        <span class="attr">enabled:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeResourceTopologyMatch</span></span><br><span class="line">      <span class="attr">preBind:</span></span><br><span class="line">        <span class="attr">enabled:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NodeResourceTopologyMatch</span></span><br></pre></td></tr></table></figure>



<ol>
<li>添加 RBAC 规则</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:kube-scheduler:plugins</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">topology.crane.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:kube-scheduler:plugins</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:kube-scheduler:plugins</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">    <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">system:kube-scheduler</span></span><br></pre></td></tr></table></figure>



<ol>
<li>修改 <code>kube-scheduler.yaml</code> 并用 Crane-scheduler 的镜像替换 kube-scheduler 镜像</li>
</ol>
<p>正确安装组件后，每个节点均会生成 <code>NodeResourceTopology</code> 对象。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nrt</span><br><span class="line">NAME    CRANE CPU MANAGER POLICY   CRANE TOPOLOGY MANAGER POLICY   AGE</span><br><span class="line">node1   Static                     SingleNUMANodePodLevel          35d</span><br></pre></td></tr></table></figure>



<p>可以看出集群中节点 <code>node1</code> 已生成对应的 NRT 对象，此时 Crane 的 CPU Manager Policy 为 <code>Static</code>，节点默认的 Topology Manager Policy 为 <code>SingleNUMANodePodLevel</code>，代表节点不允许跨 NUMA 分配资源。</p>
<p>使用以下实例进行调度测试：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">topology.crane.io/topology-awareness:</span> <span class="string">&#x27;true&#x27;</span> <span class="comment"># 添加注解，表示Pod需要感知CPU拓扑，资源分配不允许跨NUMA。若不指定，则拓扑策略默认继承节点上的topology.crane.io/topology-awareness标签</span></span><br><span class="line">        <span class="attr">topology.crane.io/cpu-policy:</span> <span class="string">&#x27;exclusive&#x27;</span> <span class="comment"># 添加注解，表示Pod的CPU分配策略为exclusive策略。</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&#x27;2&#x27;</span> <span class="comment"># 需要limits.cpu值，如果要开启绑核，则该值必须等于requests.cpu。</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2Gi</span></span><br></pre></td></tr></table></figure>



<p>应用后可以从 annotations 中查看 Pod 的拓扑分配结果，发现 Pod 在 NUMA Node0 上被分配了 2 个 CPU 核心。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -o custom-columns=name:metadata.name,topology-result:metadata.annotations.<span class="string">&quot;topology\.crane\.io/topology-result&quot;</span></span><br><span class="line">name                                topology-result</span><br><span class="line">nginx-deployment-754d99dcdf-mtcdp   [&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;node0&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;Node&quot;</span>,<span class="string">&quot;resources&quot;</span>:&#123;<span class="string">&quot;capacity&quot;</span>:&#123;<span class="string">&quot;cpu&quot;</span>:<span class="string">&quot;2&quot;</span>&#125;&#125;&#125;]</span><br></pre></td></tr></table></figure>



<h2 id="实现基于流量预测的弹性"><a href="#实现基于流量预测的弹性" class="headerlink" title="实现基于流量预测的弹性"></a>实现基于流量预测的弹性</h2><p>Kubernetes HPA 支持了丰富的弹性扩展能力，Kubernetes 平台开发者部署服务实现自定义 Metric 的服务，Kubernetes 用户配置多项内置的资源指标或者自定义 Metric 指标实现自定义水平弹性。</p>
<p><code>EffectiveHorizontalPodAutoscaler</code>（简称 <code>EHPA</code>）是 Crane 提供的弹性伸缩产品，它基于社区 HPA 做底层的弹性控制，支持更丰富的弹性触发策略（预测，观测，周期），让弹性更加高效，并保障了服务的质量。</p>
<ul>
<li>提前扩容，保证服务质量：通过算法预测未来的流量洪峰提前扩容，避免扩容不及时导致的雪崩和服务稳定性故障。</li>
<li>减少无效缩容：通过预测未来可减少不必要的缩容，稳定工作负载的资源使用率，消除突刺误判。</li>
<li>支持 Cron 配置：支持 Cron-based 弹性配置，应对大促等异常流量洪峰。</li>
<li>兼容社区：使用社区 HPA 作为弹性控制的执行层，能力完全兼容社区。</li>
</ul>
<p>Effective HPA 兼容社区的 Kubernetes HPA 的能力，提供了更智能的弹性策略，比如基于预测的弹性和基于 Cron 周期的弹性等。</p>
<h3 id="基于自定义指标的容器弹性伸缩"><a href="#基于自定义指标的容器弹性伸缩" class="headerlink" title="基于自定义指标的容器弹性伸缩"></a>基于自定义指标的容器弹性伸缩</h3><p>在了解如何使用 EHPA 之前，我们有必要来详细了解下 K8s 中的 HPA 对象。通过此伸缩组件，Kubernetes 集群可以利用监控指标（CPU 使用率等）自动扩容或者缩容服务中的 Pod 数量，当业务需求增加时，HPA 将自动增加服务的 Pod 数量，提高系统稳定性，而当业务需求下降时，HPA 将自动减少服务的 Pod 数量，减少对集群资源的请求量，甚至还可以配合 Cluster Autoscaler 实现集群规模的自动伸缩，节省 IT 成本。</p>
<p>不过目前默认的 HPA 对象只能支持根据 CPU 和内存的阈值检测扩缩容，但也可以通过 custom metric api 来调用 Prometheus 实现自定义 metric，这样就可以实现更加灵活的监控指标实现弹性伸缩了。</p>
<p>默认情况下，HPA 会通过 <code>metrics.k8s.io</code> 这个接口服务来获取 Pod 的 CPU、内存指标，CPU 和内存这两者属于核心指标，<code>metrics.k8s.io</code> 服务对应的后端服务一般是 metrics-server，所以在使用 HPA 的时候需要安装该应用。</p>
<p>如果 HPA 要通过非 CPU、内存的其他指标来伸缩容器，我们则需要部署一套监控系统如 Prometheus，让 Prometheus 采集各种指标，但是 Prometheus 采集到的 metrics 指标并不能直接给 K8s 使用，因为两者数据格式是不兼容的，因此需要使用到另外一个组件 <code>prometheus-adapter</code>，该组件可以将 Prometheus 的 metrics 指标数据格式转换成 K8s API 接口能识别的格式，另外我们还需要在 K8s 注册一个服务（即 <code>custom.metrics.k8s.io</code>），以便 HPA 能通过 <code>/apis/</code> 进行访问。</p>
<p>需要注意的是 Crane 提供了一个 <code>metric-adapter</code> 组件，该组件和 <code>prometheus-adapter</code> 都基于 <code>custom-metric-apiserver</code> 实现了 Custom Metric 和 External Metric 的 <code>ApiService</code>，在安装 Crane 时会将对应的 <code>ApiService</code> 安装为 Crane 的 <code>metric-adapter</code>，所以它会和 <code>prometheus-adapter</code> 冲突，因为 Prometheus 是当下最流行的开源监控系统，所以我们更愿意使用它来获取用户的自定义指标，那么我们就需要去安装 <code>prometheus-adapter</code>，但是在安装之前需要删除 Crane 提供的 <code>ApiService</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前集群 ApiService</span></span><br><span class="line">$ kubectl get apiservice |grep crane-system</span><br><span class="line">v1beta1.custom.metrics.k8s.io          crane-system/metric-adapter                    True                      3h51m</span><br><span class="line">v1beta1.external.metrics.k8s.io        crane-system/metric-adapter                    True                      3h51m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 crane 安装的 ApiService</span></span><br><span class="line">$ kubectl delete apiservice v1beta1.custom.metrics.k8s.io</span><br><span class="line">$ kubectl delete apiservice v1beta1.external.metrics.k8s.io</span><br></pre></td></tr></table></figure>



<p>然后通过 Helm Chart 来安装 Prometheus Adapter：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts</span><br><span class="line">$ helm repo update</span><br><span class="line"><span class="comment"># 指定有 prometheus 地址</span></span><br><span class="line">$ helm upgrade --install prometheus-adapter -n crane-system prometheus-community/prometheus-adapter --<span class="built_in">set</span> image.repository=cnych/prometheus-adapter,prometheus.url=http://prometheus-server.crane-system.svc,prometheus.port=8080</span><br></pre></td></tr></table></figure>



<p>当 <code>prometheus-adapter</code> 安装成功后我们再将 ApiService 改回 Crane 的 <code>metric-adapter</code>，应用下面的资源清单即可：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">APIService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v1beta1.custom.metrics.k8s.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">metric-adapter</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">crane-system</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">custom.metrics.k8s.io</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1beta1</span></span><br><span class="line">  <span class="attr">insecureSkipTLSVerify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">groupPriorityMinimum:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">versionPriority:</span> <span class="number">100</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">APIService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v1beta1.external.metrics.k8s.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">metric-adapter</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">crane-system</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">external.metrics.k8s.io</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1beta1</span></span><br><span class="line">  <span class="attr">insecureSkipTLSVerify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">groupPriorityMinimum:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">versionPriority:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>



<p>应用了上面的对象后，ApiService 改回了 Crane 的 <code>metric-adapter</code>，那么就不能使用 <code>prometheus-adapter</code> 的自定义 Metrics 功能，我们可以通过 Crane 的 <code>metric-adapter</code> 提供的 <code>RemoteAdapter</code> 功能将请求转发给 <code>prometheus-adapter</code>。</p>
<p>修改 <code>metric-adapter</code> 的配置，将 <code>prometheus-adapter</code> 的 Service 配置成 Crane Metric Adapter 的 <code>RemoteAdapter</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit deploy metric-adapter -n crane-system</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: metric-adapter</span><br><span class="line">  namespace: crane-system</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        <span class="comment"># 添加外部 Adapter 配置</span></span><br><span class="line">        - --remote-adapter=<span class="literal">true</span></span><br><span class="line">        - --remote-adapter-service-namespace=crane-system</span><br><span class="line">        - --remote-adapter-service-name=prometheus-adapter</span><br><span class="line">        - --remote-adapter-service-port=443</span><br><span class="line"><span class="comment"># ......</span></span><br></pre></td></tr></table></figure>



<p>这是因为 Kubernetes <strong>限制一个 ApiService 只能配置一个后端服务</strong>，为了在一个集群内使用 Crane 提供的 Metric 和 <code>prometheus-adapter</code> 提供的 Metric，Crane 支持了 <code>RemoteAdapter</code> 来解决该问题：</p>
<ul>
<li>Crane Metric-Adapter 支持配置一个 Kubernetes Service 作为一个远程 Adapter</li>
<li>Crane Metric-Adapter 处理请求时会先检查是否是 Crane 提供的 Local Metric，如果不是，则转发给远程 Adapter</li>
</ul>
<p>下面我们来部署一个示例应用，用来测试自定义指标的容器弹性伸缩。如下所示的应用暴露了 Metric 展示每秒收到的 http 请求数量。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sample-app.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-app</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sample-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">sample-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">sample-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">luxas/autoscale-demo:v0.1.2</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">metrics-provider</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sample-app</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sample-app</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>



<p>当应用部署完成后，我们可以通过命令检查 <code>http_requests_total</code> 指标数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://$(kubectl get service sample-app -o jsonpath=<span class="string">&#x27;&#123; .spec.clusterIP &#125;&#x27;</span>)/metrics</span><br><span class="line"><span class="comment"># HELP http_requests_total The amount of requests served by the server in total</span></span><br><span class="line"><span class="comment"># TYPE http_requests_total counter</span></span><br><span class="line">http_requests_total 1</span><br></pre></td></tr></table></figure>



<p>然后我们需要在 Prometheus 中配置抓取 <code>sample-app</code> 的指标，我们这里使用如下所示命令添加抓取配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit cm -n crane-system prometheus-server</span><br><span class="line"><span class="comment"># 添加抓取 sample-app 配置</span></span><br><span class="line">- job_name: sample-app</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: keep</span><br><span class="line">    regex: default;sample-app-(.+)</span><br><span class="line">    source_labels:</span><br><span class="line">    - __meta_kubernetes_namespace</span><br><span class="line">    - __meta_kubernetes_pod_name</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - action: replace</span><br><span class="line">    source_labels:</span><br><span class="line">    - __meta_kubernetes_namespace</span><br><span class="line">    target_label: namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: pod</span><br></pre></td></tr></table></figure>



<p>配置生效后我们可以在 Prometheus Dashboard 中查询对应的指标：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1666422933054.png" alt="查询指标"></p>
<p>为了让 HPA 能够用到 Prometheus 采集到的指标，<code>prometheus-adapter</code> 通过使用 promql 语句来获取指标，然后修改数据格式，并把重新组装的指标和值通过自己的接口暴露。而 HPA 会通过 <code>/apis/custom.metrics.k8s.io/</code> 代理到 <code>prometheus-adapter</code> 的 service 上来获取这些指标。</p>
<p>如果把 Prometheus 的所有指标到获取一遍并重新组装，那 adapter 的效率必然十分低下，因此 adapter 将需要读取的指标设计成可配置，让用户通过 ConfigMap 来决定读取 Prometheus 的哪些监控指标。</p>
<p>我们这里使用 Helm Chart 方式安装的 <code>prometheus-adapter</code>，其默认的 Rule 配置如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get cm -n crane-system prometheus-adapter -oyaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  config.yaml: |</span><br><span class="line">    rules:</span><br><span class="line">    - seriesQuery: <span class="string">&#x27;&#123;__name__=~&quot;^container_.*&quot;,container!=&quot;POD&quot;,namespace!=&quot;&quot;,pod!=&quot;&quot;&#125;&#x27;</span></span><br><span class="line">      seriesFilters: []</span><br><span class="line">      resources:</span><br><span class="line">        overrides:</span><br><span class="line">          namespace:</span><br><span class="line">            resource: namespace</span><br><span class="line">          pod:</span><br><span class="line">            resource: pod</span><br><span class="line">      name:</span><br><span class="line">        matches: ^container_(.*)_seconds_total$</span><br><span class="line">        as: <span class="string">&quot;&quot;</span></span><br><span class="line">      metricsQuery: <span class="built_in">sum</span>(rate(&lt;&lt;.Series&gt;&gt;&#123;&lt;&lt;.LabelMatchers&gt;&gt;,container!=<span class="string">&quot;POD&quot;</span>&#125;[5m]))</span><br><span class="line">        by (&lt;&lt;.GroupBy&gt;&gt;)</span><br><span class="line">    - seriesQuery: <span class="string">&#x27;&#123;__name__=~&quot;^container_.*&quot;,container!=&quot;POD&quot;,namespace!=&quot;&quot;,pod!=&quot;&quot;&#125;&#x27;</span></span><br><span class="line">      seriesFilters:</span><br><span class="line">      - isNot: ^container_.*_seconds_total$</span><br><span class="line">      resources:</span><br><span class="line">        overrides:</span><br><span class="line">          namespace:</span><br><span class="line">            resource: namespace</span><br><span class="line">          pod:</span><br><span class="line">            resource: pod</span><br><span class="line">      name:</span><br><span class="line">        matches: ^container_(.*)_total$</span><br><span class="line">        as: <span class="string">&quot;&quot;</span></span><br><span class="line">      metricsQuery: <span class="built_in">sum</span>(rate(&lt;&lt;.Series&gt;&gt;&#123;&lt;&lt;.LabelMatchers&gt;&gt;,container!=<span class="string">&quot;POD&quot;</span>&#125;[5m]))</span><br><span class="line">        by (&lt;&lt;.GroupBy&gt;&gt;)</span><br><span class="line">    - seriesQuery: <span class="string">&#x27;&#123;__name__=~&quot;^container_.*&quot;,container!=&quot;POD&quot;,namespace!=&quot;&quot;,pod!=&quot;&quot;&#125;&#x27;</span></span><br><span class="line">      seriesFilters:</span><br><span class="line">      - isNot: ^container_.*_total$</span><br><span class="line">      resources:</span><br><span class="line">        overrides:</span><br><span class="line">          namespace:</span><br><span class="line">            resource: namespace</span><br><span class="line">          pod:</span><br><span class="line">            resource: pod</span><br><span class="line">      name:</span><br><span class="line">        matches: ^container_(.*)$</span><br><span class="line">        as: <span class="string">&quot;&quot;</span></span><br><span class="line">      metricsQuery: <span class="built_in">sum</span>(&lt;&lt;.Series&gt;&gt;&#123;&lt;&lt;.LabelMatchers&gt;&gt;,container!=<span class="string">&quot;POD&quot;</span>&#125;) by (&lt;&lt;.GroupBy&gt;&gt;)</span><br><span class="line">    - seriesQuery: <span class="string">&#x27;&#123;namespace!=&quot;&quot;,__name__!~&quot;^container_.*&quot;&#125;&#x27;</span></span><br><span class="line">      seriesFilters:</span><br><span class="line">      - isNot: .*_total$</span><br><span class="line">      resources:</span><br><span class="line">        template: &lt;&lt;.Resource&gt;&gt;</span><br><span class="line">      name:</span><br><span class="line">        matches: <span class="string">&quot;&quot;</span></span><br><span class="line">        as: <span class="string">&quot;&quot;</span></span><br><span class="line">      metricsQuery: <span class="built_in">sum</span>(&lt;&lt;.Series&gt;&gt;&#123;&lt;&lt;.LabelMatchers&gt;&gt;&#125;) by (&lt;&lt;.GroupBy&gt;&gt;)</span><br><span class="line">    - seriesQuery: <span class="string">&#x27;&#123;namespace!=&quot;&quot;,__name__!~&quot;^container_.*&quot;&#125;&#x27;</span></span><br><span class="line">      seriesFilters:</span><br><span class="line">      - isNot: .*_seconds_total</span><br><span class="line">      resources:</span><br><span class="line">        template: &lt;&lt;.Resource&gt;&gt;</span><br><span class="line">      name:</span><br><span class="line">        matches: ^(.*)_total$</span><br><span class="line">        as: <span class="string">&quot;&quot;</span></span><br><span class="line">      metricsQuery: <span class="built_in">sum</span>(rate(&lt;&lt;.Series&gt;&gt;&#123;&lt;&lt;.LabelMatchers&gt;&gt;&#125;[5m])) by (&lt;&lt;.GroupBy&gt;&gt;)</span><br><span class="line">    - seriesQuery: <span class="string">&#x27;&#123;namespace!=&quot;&quot;,__name__!~&quot;^container_.*&quot;&#125;&#x27;</span></span><br><span class="line">      seriesFilters: []</span><br><span class="line">      resources:</span><br><span class="line">        template: &lt;&lt;.Resource&gt;&gt;</span><br><span class="line">      name:</span><br><span class="line">        matches: ^(.*)_seconds_total$</span><br><span class="line">        as: <span class="string">&quot;&quot;</span></span><br><span class="line">      metricsQuery: <span class="built_in">sum</span>(rate(&lt;&lt;.Series&gt;&gt;&#123;&lt;&lt;.LabelMatchers&gt;&gt;&#125;[5m])) by (&lt;&lt;.GroupBy&gt;&gt;)</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-adapter</span><br><span class="line">  namespace: crane-system</span><br></pre></td></tr></table></figure>



<p>Prometheus adapter 的配置文件格式如上所示，它分为两个部分，第一个是 <code>rules</code>，用于 custom metrics，另一个是 <code>resourceRules</code>，用于 metrics，如果你只用 Prometheus adapter 做 HPA，那么 <code>resourceRules</code> 就可以省略。</p>
<p>我们可以看到 <code>rules</code> 规则下面有很多的查询语句，这些查询语句的作用就是尽可能多的获取指标，从而让这些指标都可以用于 HPA。也就是说通过 <code>prometheus-adapter</code> 可以将 Prometheus 中的任何一个指标都用于 HPA，但是前提是你得通过查询语句将它拿到（包括指标名称和其对应的值）。也就是说，如果你只需要使用一个指标做 HPA，那么你完全就可以只写一条查询，而不像上面使用了好多个查询。</p>
<p>整体上每个规则大致可以分为 4 个部分：</p>
<ul>
<li><code>Discovery</code>：它指定 Adapter 应该如何找到该规则的所有 Prometheus 指标</li>
<li><code>Association</code>：指定 Adapter 应该如何确定和特定的指标关联的 Kubernetes 资源</li>
<li><code>Naming</code>：指定 Adapter 应该如何在自定义指标 API 中暴露指标</li>
<li><code>Querying</code>：指定如何将对一个获多个 Kubernetes 对象上的特定指标的请求转换为对 Prometheus 的查询</li>
</ul>
<p><strong>Discovery</strong></p>
<p>指定待转换的 Prometheus 指标，你可以通过 <code>seriesFilters</code> 精确过滤指标，<code>seriesQuery</code> 可以根据标签进行查找(如下)，也可以直接指定 metric name 查找。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seriesQuery:</span> <span class="string">http_requests_total&#123;namespace!=&quot;&quot;,pod!=&quot;&quot;&#125;</span></span><br><span class="line"><span class="attr">seriesFilters:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">isNot:</span> <span class="string">&#x27;^container_.*_seconds_total&#x27;</span></span><br></pre></td></tr></table></figure>



<p>其中 <code>seriesFilters</code> 为非必填项，用来过滤指标：</p>
<ul>
<li><code>is：&lt;regex&gt;</code>：匹配包含该正则表达式的指标。</li>
<li><code>isNot：&lt;regex&gt;</code>：匹配不包含该正则表达式的指标。</li>
</ul>
<p><strong>Association</strong></p>
<p>设置 Prometheus 指标标签与 Kubernetes 中的资源映射关系，Kubernetes Resources 可以通过 <code>kubectl api-resources</code> 命令查看。<code>overrides</code> 会将 Prometheus metric label 与一个 Kubernetes resource(下例为 deployment)关联。需要注意的是该 label 必须是一个真实的 Kubernetes resource，如 metric 的 pod 标签可以映射为 Kubernetes 的 pod resource，但不能将 container_image 映射为 Kubernetes 的 pod resource，映射错误会导致无法通过 custom metrics API 获取正确的值，这也表示 metric 中必须存在一个真实的 resource 名称，将其映射为 Kubernetes resource。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># microservice 标签对应于 apps.deployment 资源</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">overrides:</span></span><br><span class="line">    <span class="comment"># 此处 resource 为 Kubernetes 的 API Resource，可通过 kubectl api-resources -o wide 查看。</span></span><br><span class="line">    <span class="attr">microservice:</span> &#123; <span class="attr">group:</span> <span class="string">&#x27;apps&#x27;</span>, <span class="attr">resource:</span> <span class="string">&#x27;deployment&#x27;</span> &#125;</span><br><span class="line">    <span class="comment"># 此处 key(microservice)对应 Prometheus 数据中的 LabelName，请确认 Prometheus 指标数据中有此 LabelName。</span></span><br></pre></td></tr></table></figure>



<p><strong>Naming</strong></p>
<p>将 Prometheus 指标名称转换为自定义指标 API 中的指标的过程，它由 <code>name</code> 字段控制。命名通过指定一种模式来控制的，以从 Prometheus 名称中提取 API 名称，并可能对该提取的值进行转换。</p>
<p>模式在 <code>matches</code> 字段中指定，并且只是一个正则表达式。如果未指定，则默认为 <code>.*</code>。转换由 <code>as</code> 字段指定，可以使用 <code>matches</code> 字段中定义的任何捕获组，如果 <code>matches</code> 字段不包含捕获组，则 <code>as</code> 字段默认为 <code>$0</code>，如果它包含单个捕获组，则 <code>as</code> 字段默认为 <code>$1</code>，<code>as</code> 为空就是使用默认值的意思。例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将任意名称 `＜name＞_total` 转换为 `＜name＞_per_second`</span></span><br><span class="line"><span class="comment"># e.g. http_requests_total 变成 http_requests_per_second</span></span><br><span class="line"><span class="attr">name:</span></span><br><span class="line">  <span class="attr">matches:</span> <span class="string">&#x27;^(.*)_total$&#x27;</span></span><br><span class="line">  <span class="attr">as:</span> <span class="string">&#x27;$&#123;1&#125;_per_second&#x27;</span></span><br></pre></td></tr></table></figure>



<p><strong>Querying</strong></p>
<p>处理调用 custom metrics API 获取到的 metrics 的 value，该值最终提供给 HPA 进行扩缩容，它由 <code>metricsQuery</code> 字段控制。<code>metricsQuery</code> 字段使用 Go template 将 URL 请求转变为 Prometheus 的请求，它会提取 custom metrics API 请求中的字段，并将其划分为 metric name、group-resource 以及 group-resource 中的一个或多个 objects，对应如下字段：</p>
<ul>
<li><code>Series</code>: metric 名称</li>
<li><code>LabelMatchers</code>: 以逗号分割的 objects，当前表示特定 group-resource 加上命名空间的 label(如果该 group-resource 是 namespaced 的)</li>
<li><code>GroupBy</code>：以逗号分割的 label 的集合，当前表示 <code>LabelMatchers</code> 中的 group-resource label</li>
</ul>
<p>假设有一个如下所示的 <code>http_requests_per_second</code> 指标：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http_requests_per_second&#123;pod=<span class="string">&quot;pod1&quot;</span>,service=<span class="string">&quot;nginx1&quot;</span>,namespace=<span class="string">&quot;somens&quot;</span>&#125;</span><br><span class="line">http_requests_per_second&#123;pod=<span class="string">&quot;pod2&quot;</span>,service=<span class="string">&quot;nginx2&quot;</span>,namespace=<span class="string">&quot;somens&quot;</span>&#125;</span><br></pre></td></tr></table></figure>



<p>当调用 <code>kubectl get --raw &quot;/apis/&#123;APIService-name&#125;/v1beta1/namespaces/somens/pods/*/http_request_per_second&quot;</code> 时，<code>metricsQuery</code> 字段的模板的实际内容如下：</p>
<ul>
<li>Series: “http_requests_total”</li>
<li>LabelMatchers: “pod&#x3D;~&quot;pod1|pod2”, namespace&#x3D;”somens”</li>
<li>GroupBy:pod</li>
</ul>
<p>我们这里使用的 sample-app 应用的指标名叫 <code>http_requests_total</code>，通过上面的规则后会将 <code>http_requests_total</code> 转换成 Pods 类型的 Custom Metric，可以获得类似于 <code>pods/http_requests</code> 这样的数据。</p>
<p>执行以下命令，通过 Custom Metrics 指标查询方式，查看 HPA 可用指标详情。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get --raw <span class="string">&quot;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/http_requests&quot;</span> | jq .</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;MetricValueList&quot;</span>,</span><br><span class="line">  <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;custom.metrics.k8s.io/v1beta1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;selfLink&quot;</span>: <span class="string">&quot;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/%2A/http_requests&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;items&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;describedObject&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;Pod&quot;</span>,</span><br><span class="line">        <span class="string">&quot;namespace&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;sample-app-6876d5585b-wv8fl&quot;</span>,</span><br><span class="line">        <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;/v1&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;metricName&quot;</span>: <span class="string">&quot;http_requests&quot;</span>,</span><br><span class="line">      <span class="string">&quot;timestamp&quot;</span>: <span class="string">&quot;2022-10-27T11:19:05Z&quot;</span>,</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: <span class="string">&quot;18m&quot;</span>,</span><br><span class="line">      <span class="string">&quot;selector&quot;</span>: null</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后我们可以创建一个如下所示的 HPA 对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sample-app-hpa.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-app-hpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># HPA的伸缩对象描述，HPA 会动态修改该对象的 Pod 数量。</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sample-app</span></span><br><span class="line">  <span class="comment"># HPA 的最小 Pod 数量和最大 Pod 数量。</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="comment"># 监控的指标数组，支持多种类型的指标共存。</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Pods</span></span><br><span class="line">      <span class="attr">pods:</span></span><br><span class="line">        <span class="comment">#使用指标：pods/http_requests。</span></span><br><span class="line">        <span class="attr">metricName:</span> <span class="string">http_requests</span></span><br><span class="line">        <span class="comment"># AverageValue 类型的目标值，Pods 指标类型下只支持 AverageValue 类型的目标值。</span></span><br><span class="line">        <span class="attr">targetAverageValue:</span> <span class="string">500m</span> <span class="comment"># 当出现了小数点，K8s 又需要高精度时，会使用单位 m 或k。例如1001m=1.001，1k=1000。</span></span><br></pre></td></tr></table></figure>



<p>直接应用该资源对象即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f sample-app-hpa.yaml</span><br><span class="line">horizontalpodautoscaler.autoscaling/sample-app-hpa created</span><br><span class="line">$ kubectl get hpa</span><br><span class="line">NAME             REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">sample-app-hpa   Deployment/sample-app   16m/50m   1         10        1          25s</span><br></pre></td></tr></table></figure>



<p>然后针对 <code>sample-app</code> 服务做压力测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc sample-app</span><br><span class="line">NAME         TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">sample-app   NodePort   10.104.163.144   &lt;none&gt;        80:31941/TCP   3h59m</span><br><span class="line">$ ab -c 50 -n 2000 http://192.168.0.106:31941/</span><br></pre></td></tr></table></figure>



<p>然后查看 HPA 的状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME             REFERENCE               TARGETS     MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">sample-app-hpa   Deployment/sample-app   8001m/50m   1         10        4          7m58s</span><br><span class="line">$ kubectl describe hpa sample-app-hpa</span><br><span class="line">Name:                       sample-app-hpa</span><br><span class="line">Namespace:                  default</span><br><span class="line">Labels:                     &lt;none&gt;</span><br><span class="line">Annotations:                &lt;none&gt;</span><br><span class="line">CreationTimestamp:          Thu, 27 Oct 2022 19:24:16 +0800</span><br><span class="line">Reference:                  Deployment/sample-app</span><br><span class="line">Metrics:                    ( current / target )</span><br><span class="line">  <span class="string">&quot;http_requests&quot;</span> on pods:  2093m / 50m</span><br><span class="line">Min replicas:               1</span><br><span class="line">Max replicas:               10</span><br><span class="line">Deployment pods:            10 current / 10 desired</span><br><span class="line">Conditions:</span><br><span class="line">  Type            Status  Reason            Message</span><br><span class="line">  ----            ------  ------            -------</span><br><span class="line">  AbleToScale     True    ReadyForNewScale  recommended size matches current size</span><br><span class="line">  ScalingActive   True    ValidMetricFound  the HPA was able to successfully calculate a replica count from pods metric http_requests</span><br><span class="line">  ScalingLimited  True    TooManyReplicas   the desired replica count is more than the maximum replica count</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age   From                       Message</span><br><span class="line">  ----    ------             ----  ----                       -------</span><br><span class="line">  Normal  SuccessfulRescale  105s  horizontal-pod-autoscaler  New size: 4; reason: pods metric http_requests above target</span><br><span class="line">  Normal  SuccessfulRescale  90s   horizontal-pod-autoscaler  New size: 8; reason: pods metric http_requests above target</span><br><span class="line">  Normal  SuccessfulRescale  75s   horizontal-pod-autoscaler  New size: 10; reason: pods metric http_requests above target</span><br></pre></td></tr></table></figure>



<p>可以看到基于我们自定义的指标实现容器的弹性已经成功了。</p>
<h3 id="基于流量预测的容器弹性伸缩"><a href="#基于流量预测的容器弹性伸缩" class="headerlink" title="基于流量预测的容器弹性伸缩"></a>基于流量预测的容器弹性伸缩</h3><p>接下来我们再来测试下基于流量预测的容器弹性伸缩，这就需要用到 Crane 的 EHPA 对象了。我们可以使用上面的 <code>pods/http_requests</code> 自定义指标来实现弹性功能。</p>
<p>许多业务在时间序列上天然存在周期性的，尤其是对于那些直接或间接为“人”服务的业务。这种周期性是由人们日常活动的规律性决定的。例如，人们习惯于中午和晚上点外卖；早晚总有交通高峰；即使是搜索等模式不那么明显的服务，夜间的请求量也远低于白天时间。对于这类业务相关的应用来说，从过去几天的历史数据中推断出次日的指标，或者从上周一的数据中推断出下周一的访问量是很自然的想法。通过预测未来 24 小时内的指标或流量模式，我们可以更好地管理我们的应用程序实例，稳定我们的系统，同时降低成本。EHPA 对象可以使用 DSP 算法来预测应用未来的时间序列数据，DSP 是一种预测时间序列的算法，它基于 FFT（快速傅里叶变换），擅长预测一些具有季节性和周期的时间序列。</p>
<p>接下来我们创建一个如下所示的 EHPA 资源对象，并开启预测功能：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sample-app-ehpa.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling.crane.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EffectiveHorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-app-ehpa</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># metric-query.autoscaling.crane.io 是固定的前缀</span></span><br><span class="line">    <span class="comment"># 后面是 prefix.Metrics，前缀支持 pods、resource、external 类型</span></span><br><span class="line">    <span class="attr">metric-query.autoscaling.crane.io/pods.http_requests:</span> <span class="string">&#x27;sum(rate(http_requests_total[5m])) by (pod)&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># ScaleTargetRef 是对需要缩放的工作负载的引用</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sample-app</span></span><br><span class="line">  <span class="comment"># minReplicas 是可以缩小到的缩放目标的最小副本数</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># maxReplicas 是可以扩大到的缩放目标的最大副本数</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="comment"># scaleStrategy 表示缩放目标的策略，值可以是 Auto 或 Manual</span></span><br><span class="line">  <span class="attr">scaleStrategy:</span> <span class="string">Auto</span></span><br><span class="line">  <span class="comment"># metrics 包含用于计算所需副本数的规范。</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">    <span class="comment"># 在使用预测算法预测时，你可能会担心预测数据不准带来一定的风险，EHPA 在计算副本数时，不仅会按预测数据计算，同时也会考虑实际监控数据来兜底，提升弹性的安全性，所以可以定义下面的 Resource 监控数据来兜底</span></span><br><span class="line">    <span class="comment"># - type: Resource</span></span><br><span class="line">    <span class="comment">#   resource:</span></span><br><span class="line">    <span class="comment">#     name: cpu</span></span><br><span class="line">    <span class="comment">#     target:</span></span><br><span class="line">    <span class="comment">#       type: Utilization</span></span><br><span class="line">    <span class="comment">#       averageUtilization: 50</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Pods</span></span><br><span class="line">      <span class="attr">pods:</span></span><br><span class="line">        <span class="attr">metric:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http_requests</span> <span class="comment"># 和上面注解中的 metric-query.autoscaling.crane.io/pods.(.*) 必须一致</span></span><br><span class="line">        <span class="attr">target:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">AverageValue</span></span><br><span class="line">          <span class="attr">averageValue:</span> <span class="string">500m</span> <span class="comment"># 当出现了小数点，K8s 又需要高精度时，会使用单位 m 或k。例如1001m=1.001，1k=1000。</span></span><br><span class="line">  <span class="comment"># prediction 定义了预测资源的配置，如果未指定，则默认不启用预测功能</span></span><br><span class="line">  <span class="attr">prediction:</span></span><br><span class="line">    <span class="attr">predictionWindowSeconds:</span> <span class="number">3600</span> <span class="comment"># PredictionWindowSeconds 是预测未来指标的时间窗口</span></span><br><span class="line">    <span class="attr">predictionAlgorithm:</span></span><br><span class="line">      <span class="attr">algorithmType:</span> <span class="string">dsp</span> <span class="comment"># 指定dsp为预测算法</span></span><br><span class="line">      <span class="attr">dsp:</span></span><br><span class="line">        <span class="attr">sampleInterval:</span> <span class="string">&#x27;60s&#x27;</span> <span class="comment"># 监控数据的采样间隔为1分钟</span></span><br><span class="line">        <span class="attr">historyLength:</span> <span class="string">&#x27;7d&#x27;</span> <span class="comment"># 拉取过去7天的监控指标作为预测的依据</span></span><br></pre></td></tr></table></figure>



<p>在上面的资源对象中添加了一个 <code>metric-query.autoscaling.crane.io/pods.http_requests: &quot;sum(rate(http_requests_total[5m])) by (pod)&quot;</code> 的注解，这样就可以开启自定义指标的预测功能了，该注解的前缀 <code>metric-query.autoscaling.crane.io/</code> 是固定不变的，后面的 <code>pods.http_requests</code> 需要根据我们指定的指标类型而定，注意的是我们这里是指定 Pods 类型的指标，所以这里的注解 key 后面是 <code>pods.http_requests</code>，后面的 <code>http_requests</code> 就是配置的指标名称。</p>
<p>相应的在规范中定义了 <code>spec.prediction</code> 属性，用来指定预测资源的配置，其中的 <code>predictionWindowSeconds</code> 属性用来指定预测未来指标的时间窗口，<code>predictionAlgorithm</code> 属性用来指定预测的算法，比如我们这里配置的 <code>algorithmType: dsp</code> 表示使用 DSP（Digital Signal Processing）算法进行预测，该算法使用在数字信号处理领域中常用的的离散傅里叶变换、自相关函数等手段来识别、预测周期性的时间序列，关于该算法的实现原理可以查看官方文档 <code>https://gocrane.io/zh-cn/docs/tutorials/timeseriees-forecasting-by-dsp/</code> 的相关介绍，或者查看源码以了解背后原理，相关代码位于 <code>pkg/prediction/dsp</code> 目录下。此外在 <code>prediction.predictionAlgorithm.dsp</code> 下面还可以配置 dsp 算法的相关参数，比如我们这里配置的 <code>sampleInterval: &quot;60s&quot;</code> 表示监控数据的采样间隔为 1 分钟，<code>historyLength: &quot;7d&quot;</code> 表示拉取过去 7 天的监控指标作为预测的依据，此外还可以配置预测方式等。</p>
<p>然后核心的配置就是 <code>spec.metrics</code> 了，用来指定计算所需副本数的规范，我们这里指定了基于 <code>Pods</code> 指标的计算方式。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Pods</span></span><br><span class="line">  <span class="attr">pods:</span></span><br><span class="line">    <span class="attr">metric:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http_requests</span></span><br><span class="line">    <span class="attr">target:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">AverageValue</span></span><br><span class="line">      <span class="attr">averageValue:</span> <span class="string">500m</span></span><br></pre></td></tr></table></figure>



<p>上面的配置表示当 <code>pods/http_requests</code> 的自定义指标平均值达到 500m 后就可以触发 HPA 缩放，这里有一个点需要注意自定义指标的 <code>pods.metric.name</code> 的值必须和 annotations 注解 <code>metric-query.autoscaling.crane.io/&lt;metric name&gt;</code> 指标名保持一致。</p>
<p>EHPA 对象水平弹性的执行流程如下所示：</p>
<ul>
<li><code>EffectiveHPAController</code> 创建 <code>HorizontalPodAutoscaler</code> 和 <code>TimeSeriesPrediction</code> 对象</li>
<li><code>PredictionCore</code> 从 Prometheus 获取历史 metric 通过预测算法计算，将结果记录到 <code>TimeSeriesPrediction</code></li>
<li><code>HPAController</code> 通过 metric client 从 KubeApiServer 读取 metric 数据</li>
<li><code>KubeApiServer</code> 将请求路由到 Crane 的 Metric-Adapter。</li>
<li><code>HPAController</code> 计算所有的 Metric 返回的结果得到最终的弹性副本推荐。</li>
<li><code>HPAController</code> 调用 scale API 对目标应用扩&#x2F;缩容。</li>
</ul>
<p>整体流程如下所示：</p>
<p><img src="https://picdn.youdianzhishi.com/images/1666921205654.jpg" alt="ehpa 流程"></p>
<p>直接应用上面的 EPHA 对象即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f sample-app-ehpa.yaml</span><br><span class="line">effectivehorizontalpodautoscaler.autoscaling.crane.io/sample-app-ehpa created</span><br><span class="line">$ kubectl get ehpa</span><br><span class="line">NAME              STRATEGY   MINPODS   MAXPODS   SPECIFICPODS   REPLICAS   AGE</span><br><span class="line">sample-app-ehpa   Auto       1         10                       1          17s</span><br></pre></td></tr></table></figure>



<p>由于我们开启了自动预测功能，所以 EPHA 对象创建后会创建一个对应的 <code>TimeSeriesPrediction</code> 对象：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get tsp</span><br><span class="line">NAME                   TARGETREFNAME   TARGETREFKIND   PREDICTIONWINDOWSECONDS   AGE</span><br><span class="line">ehpa-sample-app-ehpa   sample-app      Deployment      3600                      3m50s</span><br><span class="line">$ kubectl get tsp ehpa-sample-app-ehpa -oyaml</span><br><span class="line">apiVersion: prediction.crane.io/v1alpha1</span><br><span class="line">kind: TimeSeriesPrediction</span><br><span class="line">metadata:</span><br><span class="line">  name: ehpa-sample-app-ehpa</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  predictionMetrics:</span><br><span class="line">  - algorithm:</span><br><span class="line">      algorithmType: dsp</span><br><span class="line">      dsp:</span><br><span class="line">        estimators: &#123;&#125;</span><br><span class="line">        historyLength: 7d</span><br><span class="line">        sampleInterval: 60s</span><br><span class="line">    expressionQuery:</span><br><span class="line">      expression: <span class="built_in">sum</span>(rate(http_requests_total[5m])) by (pod)</span><br><span class="line">    resourceIdentifier: pods.http_requests</span><br><span class="line">    <span class="built_in">type</span>: ExpressionQuery</span><br><span class="line">  predictionWindowSeconds: 3600</span><br><span class="line">  targetRef:</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: sample-app</span><br><span class="line">    namespace: default</span><br><span class="line">status:</span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: <span class="string">&quot;2022-10-29T06:50:46Z&quot;</span></span><br><span class="line">    message: not all metric predicted</span><br><span class="line">    reason: PredictPartial</span><br><span class="line">    status: <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="built_in">type</span>: Ready</span><br><span class="line">  predictionMetrics:</span><br><span class="line">  - ready: <span class="literal">false</span></span><br><span class="line">    resourceIdentifier: pods.http_requests</span><br></pre></td></tr></table></figure>



<p>在 status 中可以看到包含 <code>not all metric predicted</code> 这样的信息，这是因为应用运行时间较短，可能会出现无法预测的情况。同样也会自动创建一个对应的 HPA 对象：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME                   REFERENCE               TARGETS    MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">ehpa-sample-app-ehpa   Deployment/sample-app   16m/500m   1         10        1          69m</span><br></pre></td></tr></table></figure>



<p>然后我们可以重新使用 <code>ab</code> 命令对 sample-app 做一次压力测试，正常也可以触发该应用的弹性扩容。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME                   REFERENCE               TARGETS      MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">ehpa-sample-app-ehpa   Deployment/sample-app   7291m/500m   1         10        10         71m</span><br><span class="line">$ kubectl describe hpa ehpa-sample-app-ehpa</span><br><span class="line">Name:                       ehpa-sample-app-ehpa</span><br><span class="line">Namespace:                  default</span><br><span class="line">Labels:                     app.kubernetes.io/managed-by=effective-hpa-controller</span><br><span class="line">                            app.kubernetes.io/name=ehpa-sample-app-ehpa</span><br><span class="line">                            app.kubernetes.io/part-of=sample-app-ehpa</span><br><span class="line">                            autoscaling.crane.io/effective-hpa-uid=8fad0b0b-8a53-433e-b483-9f2ff61aaa58</span><br><span class="line">Annotations:                &lt;none&gt;</span><br><span class="line">CreationTimestamp:          Thu, 27 Oct 2022 21:01:13 +0800</span><br><span class="line">Reference:                  Deployment/sample-app</span><br><span class="line">Metrics:                    ( current / target )</span><br><span class="line">  <span class="string">&quot;http_requests&quot;</span> on pods:  8350m / 500m</span><br><span class="line">Min replicas:               1</span><br><span class="line">Max replicas:               10</span><br><span class="line">Deployment pods:            10 current / 10 desired</span><br><span class="line">Conditions:</span><br><span class="line">  Type            Status  Reason            Message</span><br><span class="line">  ----            ------  ------            -------</span><br><span class="line">  AbleToScale     True    ReadyForNewScale  recommended size matches current size</span><br><span class="line">  ScalingActive   True    ValidMetricFound  the HPA was able to successfully calculate a replica count from pods metric http_requests</span><br><span class="line">  ScalingLimited  True    TooManyReplicas   the desired replica count is more than the maximum replica count</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age   From                       Message</span><br><span class="line">  ----    ------             ----  ----                       -------</span><br><span class="line">  Normal  SuccessfulRescale  57s   horizontal-pod-autoscaler  New size: 4; reason: pods metric http_requests above target</span><br><span class="line">  Normal  SuccessfulRescale  42s   horizontal-pod-autoscaler  New size: 8; reason: pods metric http_requests above target</span><br><span class="line">  Normal  SuccessfulRescale  27s   horizontal-pod-autoscaler  New size: 10; reason: pods metric http_requests above target</span><br></pre></td></tr></table></figure>



<p>我们可以使用如下所示命令来查看 EHPA 自动生成的 HPA 对象的资源清单：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get hpa.v2beta2.autoscaling ehpa-sample-app-ehpa -oyaml</span><br><span class="line">apiVersion: autoscaling/v2beta2</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: ehpa-sample-app-ehpa</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  maxReplicas: 10</span><br><span class="line">  metrics:</span><br><span class="line">  - pods:</span><br><span class="line">      metric:</span><br><span class="line">        name: http_requests</span><br><span class="line">      target:</span><br><span class="line">        averageValue: 500m</span><br><span class="line">        <span class="built_in">type</span>: AverageValue</span><br><span class="line">    <span class="built_in">type</span>: Pods</span><br><span class="line">  minReplicas: 1</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: sample-app</span><br><span class="line">status:</span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: <span class="string">&quot;2022-10-27T13:01:28Z&quot;</span></span><br><span class="line">    message: recent recommendations were higher than current one, applying the highest</span><br><span class="line">      recent recommendation</span><br><span class="line">    reason: ScaleDownStabilized</span><br><span class="line">    status: <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="built_in">type</span>: AbleToScale</span><br><span class="line">  - lastTransitionTime: <span class="string">&quot;2022-10-27T13:01:28Z&quot;</span></span><br><span class="line">    message: the HPA was able to successfully calculate a replica count from pods</span><br><span class="line">      metric http_requests</span><br><span class="line">    reason: ValidMetricFound</span><br><span class="line">    status: <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="built_in">type</span>: ScalingActive</span><br><span class="line">  - lastTransitionTime: <span class="string">&quot;2022-10-27T14:11:24Z&quot;</span></span><br><span class="line">    message: the desired replica count is more than the maximum replica count</span><br><span class="line">    reason: TooManyReplicas</span><br><span class="line">    status: <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="built_in">type</span>: ScalingLimited</span><br><span class="line">  currentMetrics:</span><br><span class="line">  - pods:</span><br><span class="line">      current:</span><br><span class="line">        averageValue: 15m</span><br><span class="line">      metric:</span><br><span class="line">        name: http_requests</span><br><span class="line">    <span class="built_in">type</span>: Pods</span><br><span class="line">  currentReplicas: 10</span><br><span class="line">  desiredReplicas: 10</span><br><span class="line">  lastScaleTime: <span class="string">&quot;2022-10-27T14:11:54Z&quot;</span></span><br></pre></td></tr></table></figure>



<p>可以观测到已经创建出基于自定义指标预测的 Metric: <code>http_requests</code>，由于生产环境的复杂性，基于多指标的弹性（CPU&#x2F;Memory&#x2F;自定义指标）往往是生产应用的常见选择，因此 Effective HPA 通过预测算法覆盖了多指标的弹性，达到了帮助更多业务在生产环境落地水平弹性的成效。</p>
<p>除此之外 EHPA 对象还支持基于 cron 的自动缩放，除了基于监控指标，有时节假日和工作日的工作负载流量存在差异，简单的预测算法可能效果不佳。然后可以通过设置周末 cron 来支持更大数量的副本来弥补预测的不足。对于一些非 web 流量的应用，比如一些应用不需要在周末使用，可以把工作负载的副本数减少到 1，也可以配置 cron 来降低你的服务成本。</p>
<h2 id="QOS-增强与混部"><a href="#QOS-增强与混部" class="headerlink" title="QOS 增强与混部"></a>QOS 增强与混部</h2><p>除了上面介绍的主要功能之外，crane 还具有很多 QOS 增强功能，QOS 相关能力保证了运行在 Kubernetes 上的 Pod 的稳定性。</p>
<h3 id="干扰检测和主动回避"><a href="#干扰检测和主动回避" class="headerlink" title="干扰检测和主动回避"></a>干扰检测和主动回避</h3><p><img src="https://picdn.youdianzhishi.com/images/1666938915729.jpg" alt="干扰检测和主动回避"></p>
<p>干扰检测和主动回避功能主要涉及到以下几个 CRD 对象：</p>
<ul>
<li><code>AvoidanceAction</code>：定义了检测到干扰后需要执行的操作，包含了 <code>Disable Scheduling</code>、<code>throttle</code>、<code>eviction</code> 等操作，并且定义了其相关的一些参数。</li>
<li><code>NodeQOS</code>：定义了指标采集方式和参数，水位线指标相关参数，以及指标异常时关联的回避操作，同时通过 label selector 将上面的内容关联到指定的节点。</li>
<li><code>PodQOS</code>：定义了指定 pod 可以被执行的 <code>AvoidanceAction</code>，通常和 <code>NodeQOS</code> 搭配起来，从节点和 pod 的维度共同限制执行动作的范围，<code>PodQOS</code> 支持的 seletor 包含 label selector、还支持筛选特定 QOSClass(“BestEffort”、“Guaranteed”等)、特定 Priority、特定 Namespace 的 pod，并且之间采用<strong>与</strong>的方式关联。</li>
</ul>
<p><strong>Disable Scheduling</strong></p>
<p>定义如下所示几个 <code>AvoidanceAction</code>、<code>PodQOS</code> 和 <code>NodeQOS</code> 资源对象。当节点 CPU 使用率触发回避阈值时，将该节点设置为禁用调度。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">ensurance.crane.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AvoidanceAction</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">system</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">disablescheduling</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">disable</span> <span class="string">schedule</span> <span class="string">new</span> <span class="string">pods</span> <span class="string">to</span> <span class="string">the</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">coolDownSeconds:</span> <span class="number">300</span> <span class="comment"># 节点从禁止调度状态到正常状态的最小等待时间</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">ensurance.crane.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NodeQOS</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&#x27;watermark1&#x27;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">&#x27;system&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeQualityProbe:</span></span><br><span class="line">    <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">nodeLocalGet:</span></span><br><span class="line">      <span class="attr">localCacheTTLSeconds:</span> <span class="number">60</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;cpu-usage&#x27;</span></span><br><span class="line">      <span class="attr">avoidanceThreshold:</span> <span class="number">2</span> <span class="comment"># 当达到阈值并持续多次，那么我们认为规则被触发</span></span><br><span class="line">      <span class="attr">restoreThreshold:</span> <span class="number">2</span> <span class="comment"># 当阈值未达到并继续多次, 那么我们认为规则已恢复</span></span><br><span class="line">      <span class="attr">actionName:</span> <span class="string">&#x27;disablescheduling&#x27;</span> <span class="comment"># 关联到 AvoidanceAction 名称</span></span><br><span class="line">      <span class="attr">strategy:</span> <span class="string">&#x27;None&#x27;</span> <span class="comment"># 动作的策略，你可以将其设置为“Preview”以不实际执行</span></span><br><span class="line">      <span class="attr">metricRule:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">&#x27;cpu_total_usage&#x27;</span> <span class="comment"># 指标名称</span></span><br><span class="line">        <span class="attr">value:</span> <span class="number">4000</span> <span class="comment"># 指标的阈值</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">ensurance.crane.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodQOS</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">all-elastic-pods</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">allowedActions:</span> <span class="comment"># 被该PodQOS关联的pod允许被执行的action为eviction</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">eviction</span></span><br><span class="line">  <span class="attr">labelSelector:</span> <span class="comment"># 通过label selector关联具有preemptible_job: “true&quot;的pod</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">preemptible_job:</span> <span class="string">&#x27;true&#x27;</span></span><br></pre></td></tr></table></figure>



<p><strong>Throttle</strong></p>
<p>定义 <code>AvoidanceAction</code> 和 <code>NodeQOS</code>。当节点 CPU 使用率触发回避阈值时，将执行节点的 Throttle Action。示例 YAML 如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">ensurance.crane.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AvoidanceAction</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">throttle</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">coolDownSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">throttle:</span></span><br><span class="line">    <span class="attr">cpuThrottle:</span></span><br><span class="line">      <span class="attr">minCPURatio:</span> <span class="number">10</span> <span class="comment"># CPU 配额的最小比例，如果 pod 被限制低于这个比例，就会被设置为这个</span></span><br><span class="line">      <span class="attr">stepCPURatio:</span> <span class="number">10</span> <span class="comment"># 该配置设置给Throttle Action。它将在每个触发的回避动作中减少这个 CPU 配额占比。它会在每个恢复动作中增加这个 CPU 配额占比</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">&#x27;throttle low priority pods&#x27;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">ensurance.crane.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NodeQOS</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&#x27;watermark2&#x27;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">&#x27;system&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeQualityProbe:</span></span><br><span class="line">    <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">nodeLocalGet:</span></span><br><span class="line">      <span class="attr">localCacheTTLSeconds:</span> <span class="number">60</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;cpu-usage&#x27;</span></span><br><span class="line">      <span class="attr">avoidanceThreshold:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">restoredThreshold:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">actionName:</span> <span class="string">&#x27;throttle&#x27;</span></span><br><span class="line">      <span class="attr">strategy:</span> <span class="string">&#x27;None&#x27;</span></span><br><span class="line">      <span class="attr">metricRule:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">&#x27;cpu_total_usage&#x27;</span></span><br><span class="line">        <span class="attr">value:</span> <span class="number">6000</span></span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">ensurance.crane.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodQOS</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">all-be-pods</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">allowedActions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">throttle</span></span><br><span class="line">  <span class="attr">scopeSelector:</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">        <span class="attr">scopeName:</span> <span class="string">QOSClass</span></span><br><span class="line">        <span class="attr">values:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">BestEffort</span></span><br></pre></td></tr></table></figure>



<p><strong>Eviction</strong></p>
<p>下面的 YAML 是另一种情况，当节点 CPU 使用率触发阈值时，节点上的低优先级 pod 将被驱逐。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">ensurance.crane.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AvoidanceAction</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">eviction</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">coolDownSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">eviction:</span></span><br><span class="line">    <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span> <span class="comment"># pod 需要优雅终止的持续时间（以秒为单位）</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">&#x27;evict low priority pods&#x27;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">ensurance.crane.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NodeQOS</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&#x27;watermark3&#x27;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">&#x27;system&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeQualityProbe:</span></span><br><span class="line">    <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">nodeLocalGet:</span></span><br><span class="line">      <span class="attr">localCacheTTLSeconds:</span> <span class="number">60</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;cpu-usage&#x27;</span></span><br><span class="line">      <span class="attr">avoidanceThreshold:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">restoreThreshold:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">actionName:</span> <span class="string">&#x27;eviction&#x27;</span></span><br><span class="line">      <span class="attr">strategy:</span> <span class="string">&#x27;Preview&#x27;</span> <span class="comment"># 回避动作策略。当设置为Preview时，将不会被实际执行</span></span><br><span class="line">      <span class="attr">metricRule:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">&#x27;cpu_total_usage&#x27;</span></span><br><span class="line">        <span class="attr">value:</span> <span class="number">6000</span></span><br></pre></td></tr></table></figure>



<p><strong>支持的水位线指标</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>cpu_total_usage</td>
<td>node cpu usage</td>
</tr>
<tr>
<td>cpu_total_utilization</td>
<td>node cpu utilization percent</td>
</tr>
<tr>
<td>memory_total_usage</td>
<td>node mem usage</td>
</tr>
<tr>
<td>memory_total_utilization</td>
<td>node mem utilization percent</td>
</tr>
</tbody></table>
<p><strong>灵活的异常规则配置与可自定义的主动回避规则</strong></p>
<p>针对异常规则的配置，Crane 支持静态阈值，基于 OPA 的灵活定义和多种算法支持，用户也可以根据接口自行定义自己的异常判断逻辑，实现灵活配置，具有较好的扩展能力；</p>
<p>针对主动回避规则，可以为业务设置优先级和 QoS 质量保障，在资源紧张时对低优业务进行抢占和压制，通过 NodeQOS 和 PodQOS 的配合，保障节点和业务的稳定性。 PodQOS 定义了可以选择 pod 被执行的具体 AvoidanceAction，同时支持具有如指定 QOSClass,priority 或具体 label 等丰富的 pod 关联方式，通过这两种方式，即可实现丰富和精确的回避策略，精准操作 workload，避免误伤。</p>
<p>比如可以结合弹性资源回收，只允许离线作业被执行驱逐等操作，避免主动回避操作对于高优先级业务的影响，误驱逐了重要业务，从而在资源紧张时将低优或者使用扩展资源的 pod 优先回收，保证了节点上的核心业务的稳定。</p>
<p>如下面的例子，为打有 <code>preemptible_job: &quot;true&quot;</code> 标签的 Pod 和 BestEffor pod 配置可驱逐。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">ensurance.crane.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodQOS</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">all-elastic-pods</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">allowedActions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">eviction</span></span><br><span class="line">  <span class="attr">labelSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">preemptible_job:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">ensurance.crane.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodQOS</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">all-be-pods</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">allowedActions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">eviction</span></span><br><span class="line">  <span class="attr">scopeSelector:</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">        <span class="attr">scopeName:</span> <span class="string">QOSClass</span></span><br><span class="line">        <span class="attr">values:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">BestEffort</span></span><br></pre></td></tr></table></figure>



<p><strong>与弹性资源搭配使用</strong></p>
<p>为了避免主动回避操作对于高优先级业务的影响，比如误驱逐了重要业务，建议使用 <code>PodQOS</code> 关联使用了弹性资源的 workload，这样在执行动作的时候只会影响这些使用了空闲资源的 workload，保证了节点上的核心业务的稳定。</p>
<p><strong>自定义指标接入干扰检测框架</strong></p>
<ul>
<li><ol>
<li>提供了丰富的 pod 排序策略可以供自定义指标任意搭配组合，一个合适的 pod 排序策略组合，能够更快地将指标调整到水位线以下，也可以方便地实现自己的排序策略</li>
</ol>
</li>
<li><ol>
<li>能够避免过度操作，以 NodeQOS 中的指标值作为水位，操作到刚好低于水位线，能避免对低优先级服务的过度影响</li>
</ol>
</li>
<li><ol>
<li>一次操作过程兼顾多条不同指标的水位线，尽量短的时间内完成整个过程，避免对高优业务和整机的影响</li>
</ol>
</li>
<li><ol>
<li>在回避过程中考虑到实时指标暂时无法获取以及部分指标在 pod 被执行操作后无法量化的问题；由于低于水位线时会存在 restore 的反向过程，考虑到了避免指标在水位线附近来回摇摆的情况</li>
</ol>
</li>
</ul>
<p>用户按照规范完善自定义指标的一些属性和实现，即可在无需关心具体细节的情况下，复用以上能力和整个干扰检测主动回避过程，可以便捷扩展。</p>
<p>通过便捷的自定义指标复用流程的能力，用户可以定义一些各维度的指标用来保证集群的稳定，比如将弹性资源的总体使用量作为指标，即可实现无侵入的“离线资源大框”；比如将高优业务的关键指标作为指标，即可时刻保障高优业务的稳定运行。</p>
<h3 id="预测算法增强的动态资源超卖"><a href="#预测算法增强的动态资源超卖" class="headerlink" title="预测算法增强的动态资源超卖"></a>预测算法增强的动态资源超卖</h3><p>为了提高稳定性，通常用户在部署应用的时候会设置高于实际使用量的 Request 值，造成资源的浪费，为了提高节点的资源利用率，用户会搭配部署一些 BestEffort 的应用，利用闲置资源，实现超卖。但是这些应用由于缺乏资源 limit 和 request 的约束和相关信息，调度器依旧可能将这些 pod 调度到负载较高的节点上去，这与我们的初衷是不符的，所以最好能依据节点的空闲资源量进行调度。</p>
<p>crane 通过如下两种方式收集了节点的空闲资源量，综合后作为节点的空闲资源量，增强了资源评估的准确性：</p>
<p>这里以 cpu 为例，同时也支持内存的空闲资源回收和计算。</p>
<ol>
<li>通过本地收集的 cpu 用量信息 <code>nodeCpuCannotBeReclaimed := nodeCpuUsageTotal + exclusiveCPUIdle - extResContainerCpuUsageTotal</code><ul>
<li><code>exclusiveCPUIdle</code> 是指被 cpu manager policy 为 exclusive 的 pod 占用的 cpu 的空闲量，虽然这部分资源是空闲的，但是因为独占的原因，是无法被复用的，因此加上被算作已使用量</li>
<li><code>extResContainerCpuUsageTotal</code> 是指被作为动态资源使用的 cpu 用量，需要减去以免被二次计算</li>
</ul>
</li>
<li>创建节点 cpu 使用量的 TSP，默认情况下自动创建，会根据历史预测节点 CPU 用量</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">spec:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    predictionMetrics:</span></span><br><span class="line"><span class="string">    - algorithm:</span></span><br><span class="line"><span class="string">        algorithmType: dsp</span></span><br><span class="line"><span class="string">        dsp:</span></span><br><span class="line"><span class="string">          estimators:</span></span><br><span class="line"><span class="string">            fft:</span></span><br><span class="line"><span class="string">            - highFrequencyThreshold: &quot;0.05&quot;</span></span><br><span class="line"><span class="string">              lowAmplitudeThreshold: &quot;1.0&quot;</span></span><br><span class="line"><span class="string">              marginFraction: &quot;0.2&quot;</span></span><br><span class="line"><span class="string">              maxNumOfSpectrumItems: 20</span></span><br><span class="line"><span class="string">              minNumOfSpectrumItems: 10</span></span><br><span class="line"><span class="string">          historyLength: 3d</span></span><br><span class="line"><span class="string">          sampleInterval: 60s</span></span><br><span class="line"><span class="string">      resourceIdentifier: cpu</span></span><br><span class="line"><span class="string">      type: ExpressionQuery</span></span><br><span class="line"><span class="string">      expressionQuery:</span></span><br><span class="line"><span class="string">        expression: &#x27;sum(count(node_cpu_seconds_total&#123;mode=&quot;idle&quot;,instance=~&quot;(&#123;&#123;.metadata.name&#125;&#125;)(:\\d+)?&quot;&#125;) by (mode, cpu)) - sum(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;,instance=~&quot;(&#123;&#123;.metadata.name&#125;&#125;)(:\\d+)?&quot;&#125;[5m]))&#x27;</span></span><br><span class="line"><span class="string">    predictionWindowSeconds: 3600</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">noderesource-tsp-template</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>



<p>结合预测算法和当前实际用量推算节点的剩余可用资源，并将其作为拓展资源赋予节点，pod 可标明使用该扩展资源作为离线作业将空闲资源利用起来，以提升节点的资源利用率。</p>
<p>在部署 pod 时 limit 和 request 使用 <code>gocrane.io/&lt;$ResourceName&gt;：&lt;$value&gt;</code> 即可，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">extended-resource-demo-ctr</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">gocrane.io/cpu:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line">          <span class="attr">gocrane.io/memory:</span> <span class="string">&#x27;2000Mi&#x27;</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">gocrane.io/cpu:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line">          <span class="attr">gocrane.io/memory:</span> <span class="string">&#x27;2000Mi&#x27;</span></span><br></pre></td></tr></table></figure>



<p><strong>弹性资源限制功能</strong></p>
<p>原生的 BestEffort 应用缺乏资源用量的公平保证，Crane 保证使用动态资源的 BestEffort pod 其 cpu 使用量被限制在其允许使用的合理范围内，agent 保证使用扩展资源的 pod 实际用量也不会超过其声明限制，同时在 cpu 竞争时也能按照各自声明量公平竞争；同时使用弹性资源的 pod 也会受到水位线功能的管理。</p>
<p>同样在部署 pod 时 limit 和 request 使用<code>gocrane.io/&lt;$ResourceName&gt;：&lt;$value&gt;</code>即可</p>
<p><strong>适配场景</strong></p>
<p>为了提升节点的负载，可以将一些离线作业或者重要性较低的作业通过使用弹性资源的方式调度部署到集群中，这类作业会使用空闲的弹性资源，搭配 QOS 的水位线保障，在节点出现负载较高的时候，也会优先被驱逐和压制，在保证高优先级业务稳定的前提下提升节点利用率。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>2022 年，腾讯云原生 FinOps Crane 项目组，结合行业及产业的发展趋势，联动中国产业互联网发展联盟、中国信通院、中国电子节能技术协会、FinOps 基金会及中国内外众多生态合作伙伴，开展及推动技术标准、国内联盟、国际开源、双碳升级等多维度的成果落地，输出了系列白皮书和标准指南，旨在助力企业和生态更良性发展和应用先进技术，达成降本增效，节能减排目标方向。</p>
<p><img src="https://picdn.youdianzhishi.com/images/1666922649467.png" alt="Crane 能力全景图"></p>
<p>我们可以自己在 Kubernetes 集群中安装 crane 来获取这些相关功能，此外这些能力也都会在腾讯云 TKE 的原生节点产品 <code>Housekeeper</code> 中提供，新推出的 TKE Housekeeper 是腾讯云推出的全新 K8s 运维范式，可以帮助企业像管理 Workload 一样声明式管理 Node 节点，高效解决节点维护、资源规划等各种各样的运维问题。</p>
<p>毫无疑问，Crane 已经是 Kubernetes 集群中用于云资源分析和经济的最佳 FinOps 平台了。目前，腾讯云 Crane 已进入 CNCF LandScape，这意味着 Crane 已成为云原生领域的重要项目。面向未来，腾讯云还将持续反馈开源社区、共建开源生态，帮助更多企业通过云原生全面释放生产力，加速实现数字化和绿色化双转型。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://huiaz.github.io">六一</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://huiaz.github.io/2025/09/11/Crane/">https://huiaz.github.io/2025/09/11/Crane/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://huiaz.github.io" target="_blank">Hui's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%BF%90%E7%BB%B4/">运维</a><a class="post-meta__tags" href="/tags/k8s/">k8s</a><a class="post-meta__tags" href="/tags/FinOps/">FinOps</a></div><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/09/11/DHCP%20%E5%8D%8F%E8%AE%AE/" title="DHCP 协议"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">DHCP 协议</div></div><div class="info-2"><div class="info-item-1">DHCP 协议的工作原理及应用场景什么是 DHCP 协议？DHCP (Dynamic Host Configuration Protocol，动态主机配置协议) 是一种网络协议，用于自动化管理和分配网络中的 IP 地址以及其他相关配置信息（如子网掩码、默认网关、DNS 服务器地址等）。它的核心思想是取代手动配置每台设备的网络参数，实现即插即用，大大简化了大型网络的管理。 DHCP 协议的工作原理 (DORA 过程)DHCP 协议通常通过四步过程（称为 DORA 过程）来完成 IP 地址分配：  Discover (发现)  客户端行为： 当一台新设备（或一台没有配置 IP 地址的设备）连接到网络时，它不知道网络中是否有 DHCP 服务器，也不知道自己的 IP 地址。因此，它会广播一个 DHCP Discover 消息到局域网内的所有设备（使用目的 IP 地址 255.255.255.255，源 IP 地址 0.0.0.0）。 目的： 寻找网络中的 DHCP 服务器。   Offer (提供)  服务器行为： 网络中的 DHCP 服务器收到 DHCP Discover 消息后，会从...</div></div></div></a><a class="pagination-related" href="/2025/09/11/CoreDNS/" title="CoreDNS"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">CoreDNS</div></div><div class="info-2"><div class="info-item-1">服务发现上面我们讲解了 Service 的用法，我们可以通过 Service 生成的 ClusterIP(VIP) 来访问 Pod 提供的服务，但是在使用的时候还有一个问题：我们怎么知道某个应用的 VIP 呢？比如我们有两个应用，一个是 api 应用，一个是 db 应用，两个应用都是通过 Deployment 进行管理的，并且都通过 Service 暴露出了端口提供服务。api 需要连接到 db 这个应用，我们只知道 db 应用的名称和 db 对应的 Service 的名称，但是并不知道它的 VIP 地址，我们前面的 Service 课程中是不是学习到我们通过 ClusterIP 就可以访问到后面的 Pod 服务，如果我们知道了 VIP 的地址是不是就行了？ 环境变量为了解决上面的问题，在之前的版本中，Kubernetes 采用了环境变量的方法，每个 Pod 启动的时候，会通过环境变量设置所有服务的 IP 和 port 信息，这样 Pod 中的应用可以通过读取环境变量来获取依赖服务的地址信息，这种方法使用起来相对简单，但是有一个很大的问题就是依赖的服务必须在 Pod 启动之前就存...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/09/11/k8s_12/" title="k8s_12"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-11</div><div class="info-item-2">k8s_12</div></div><div class="info-2"><div class="info-item-1">如何在 Kubernetes 中实现服务的自动伸缩（autoscaling）？Of course. Automating the scaling of services is one of Kubernetes’ most powerful features, enabling applications to be both resilient to traffic spikes and cost-effective during quiet periods. This is achieved through a combination of several components. 🤔 分析过程：该问题旨在考察对Kubernetes核心动态管理能力的理解。一个全面的回答不能只提及一种自动伸缩方式，而应结构化地介绍Kubernetes中三个主要层次的自动伸缩器：HPA (水平), VPA (垂直), 和 CA (集群)。回答的重点在于阐明每种伸缩器的触发机制、作用范围和典型用例，并解释它们如何协同工作，共同构建一个弹性的、资源高效的系统。 💡 答案生成：1. 概念或定义Kube...</div></div></div></a><a class="pagination-related" href="/2025/09/11/Pod%20%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/" title="Pod 基本原理"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-11</div><div class="info-item-2">Pod 基本原理</div></div><div class="info-2"><div class="info-item-1">Pod 基本原理 前面的课程中我们了解了 Kubernetes 的基本架构，以及如何使用资源清单在集群中部署一个应用。我们也了解到了 Pod 是 Kubernetes 集群中最基本的调度单元，我们平时在集群中部署的应用都是以 Pod 为单位的，而并不是我们熟知的容器，这样设计的目的是什么呢？为何不直接使用容器呢？ 为什么需要 Pod假设 Kubernetes 中调度的基本单元就是容器，对于一个非常简单的应用可以直接被调度直接使用，没有什么问题，但是往往还有很多应用程序是由多个进程组成的，有的同学可能会说把这些进程都打包到一个容器中去不就可以了吗？理论上是可以实现的，但是不要忘记了容器运行时管理的进程是 pid=1 的主进程，其他进程死掉了就会成为僵尸进程，没办法进行管理了，这种方式本身也不是容器推荐的运行方式，一个容器最好只干一件事情，所以在真实的环境中不会使用这种方式。 那么我们就把这个应用的进程进行拆分，拆分成一个一个的容器总可以了吧？但是不要忘记一个问题，拆分成一个一个的容器后，是不是就有可能出现一个应用下面的某个进程容器被调度到了不同的节点上呀？往往我们应用内部的进程与进...</div></div></div></a><a class="pagination-related" href="/2025/09/11/%E6%96%B0%E4%B8%80%E4%BB%A3%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F%20CubeFS/" title="新一代云原生存储系统 CubeFS"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-11</div><div class="info-item-2">新一代云原生存储系统 CubeFS</div></div><div class="info-2"><div class="info-item-1">新一代云原生存储系统 CubeFSCubeFS是一种新一代云原生存储系统，支持 S3、HDFS 和 POSIX 等访问协议，支持多副本与纠删码两种存储引擎，为用户提供多租户、 多 AZ 部署以及跨区域复制等多种特性。  CubeFS 作为一个云原生的分布式存储平台，提供了多种访问协议，因此其应用场景也非常广泛，下面简单介绍几种比较典型的应用场景  大数据分析：兼容 HDFS 协议，为 Hadoop 生态（如 Spark、Hive）提供统一存储底座，为计算引擎提供无限的存储空间以及大带宽的数据存储能力。 深度训练&#x2F;机器学习：作为分布式并行文件系统，支撑 AI 训练、模型存储及分发、IO 加速等需求。 容器共享存储：容器集群可以将容器镜像的配置文件或初始化加载数据存储在 CubeFS 上，在容器批量加载时实时读取。多 Pod 间通过 CubeFS 共享持久化数据，在 Pod 故障时可以进行快速故障切换。 数据库&amp;中间件：为数据库应用如 MySQL、ElasticSearch、ClickHouse 提供高并发、低时延云盘服务，实现彻底的存算分离。 在线服务：为在线业务...</div></div></div></a><a class="pagination-related" href="/2025/09/11/k8s%20Namespace/" title="k8s Namespace"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-11</div><div class="info-item-2">k8s Namespace</div></div><div class="info-2"><div class="info-item-1">请描述 Kubernetes 中的 Namespace 的作用，并解释其使用场景。 🤔 分析过程：此问题考察的是对Kubernetes基本组织单元——Namespace（命名空间）的理解。一个优秀的回答需要解释其核心功能，即逻辑隔离，并能从不同维度（名称、资源、权限）阐述这种隔离。更重要的是，要能结合实际工作场景，说明为什么以及如何使用命名空间来组织集群，这直接反映了面试者的集群治理和多租户管理经验。 💡 答案生成：1. 概念或定义Namespace（命名空间）是Kubernetes中一种实现逻辑隔离的机制，它能将一个物理的Kubernetes集群划分为多个虚拟集群。每个命名空间都是一个独立的作用域，用于组织和隔离集群中的资源对象。 需要强调的是，这种隔离是逻辑上的，而非物理上的。不同命名空间中的Pod可能会运行在同一个物理节点上，但它们在API层面、策略层面和名称层面是相互隔离的。 2. Namespace 的核心作用Namespace为一组资源提供了三个维度的隔离：  1. 名称范围隔离 (Scope for Names):  作用： 这是最基本的作用。在同一个命名空间内...</div></div></div></a><a class="pagination-related" href="/2025/09/11/%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C/" title="集合操作"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-11</div><div class="info-item-2">集合操作</div></div><div class="info-2"><div class="info-item-1">集合操作有的时候我们需要过滤或将一组时间序列与另一组时间序列进行合并，Prometheus 提供了 3 个在瞬时向量之间操作的集合运算符。  and（集合交集）：比如对较高错误率触发报警，但是只有当对应的总错误率超过某个阈值的时候才会触发报警 or（集合并集）：对序列进行并集计算 unless（除非）：比如要对磁盘空间不足进行告警，除非它是只读文件系统。   与算术和过滤二元运算符类似，这些集合运算符会尝试根据相同的标签集在左侧和右侧之间查找来匹配序列，除非你提供 on() 或 ignoring() 修饰符来指定应该如何找到匹配。  注意：与算术和过滤二进制运算符相比，集合运算符没有 group_left() 或 group_right() 修饰符，因为集合运算符总是进行多对多的匹配，也就是说，它们总是允许任何一边的匹配序列与另一边的多个序列相匹配。  对于 and 运算符，如果找到一个匹配的，左边的序列就会成为输出结果的一部分，如果右边没有匹配的序列，则不会输出任何结果。 例如我们想筛选出第 90 个百分位延迟高于 50ms 的所有 HTTP 端点，但只针对每秒收到多个请求的维...</div></div></div></a><a class="pagination-related" href="/2025/09/11/Gateway%20API/" title="Gateway API"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-11</div><div class="info-item-2">Gateway API</div></div><div class="info-2"><div class="info-item-1">Gateway APIGateway API（之前叫 Service API）是由 SIG-NETWORK 社区管理的开源项目，项目地址：https://gateway-api.sigs.k8s.io/。主要原因是 Ingress 资源对象不能很好的满足网络需求，很多场景下 Ingress 控制器都需要通过定义 annotations 或者 crd 来进行功能扩展，这对于使用标准和支持是非常不利的，新推出的 Gateway API 旨在通过可扩展的面向角色的接口来增强服务网络。 Gateway API 是 Kubernetes 中的一个 API 资源集合，包括 GatewayClass、Gateway、HTTPRoute、TCPRoute、Service 等，这些资源共同为各种网络用例构建模型。  Gateway API 的改进比当前的 Ingress 资源对象有很多更好的设计：  面向角色 - Gateway 由各种 API 资源组成，这些资源根据使用和配置 Kubernetes 服务网络的角色进行建模。 通用性 - 和 Ingress 一样是一个具有众多实现的通用规范，Gat...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">六一</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">274</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">45</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/huiaz"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Crane"><span class="toc-number">1.</span> <span class="toc-text">Crane</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E6%8E%A8%E8%8D%90"><span class="toc-number">1.3.</span> <span class="toc-text">智能推荐</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A8%E8%8D%90"><span class="toc-number">1.3.1.</span> <span class="toc-text">自定义推荐</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E8%B0%83%E5%BA%A6%E5%99%A8"><span class="toc-number">1.4.</span> <span class="toc-text">智能调度器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%B0%83%E5%BA%A6%E5%99%A8"><span class="toc-number">1.4.1.</span> <span class="toc-text">动态调度器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%8B%93%E6%89%91%E6%84%9F%E7%9F%A5%E8%B0%83%E5%BA%A6%E5%AF%B9-Pod-%E8%BF%9B%E8%A1%8C%E7%B2%BE%E7%BB%86%E5%8C%96%E8%B0%83%E5%BA%A6"><span class="toc-number">1.4.2.</span> <span class="toc-text">使用拓扑感知调度对 Pod 进行精细化调度</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%9F%BA%E4%BA%8E%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B%E7%9A%84%E5%BC%B9%E6%80%A7"><span class="toc-number">1.5.</span> <span class="toc-text">实现基于流量预测的弹性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E6%A0%87%E7%9A%84%E5%AE%B9%E5%99%A8%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9"><span class="toc-number">1.5.1.</span> <span class="toc-text">基于自定义指标的容器弹性伸缩</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B%E7%9A%84%E5%AE%B9%E5%99%A8%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9"><span class="toc-number">1.5.2.</span> <span class="toc-text">基于流量预测的容器弹性伸缩</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#QOS-%E5%A2%9E%E5%BC%BA%E4%B8%8E%E6%B7%B7%E9%83%A8"><span class="toc-number">1.6.</span> <span class="toc-text">QOS 增强与混部</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B2%E6%89%B0%E6%A3%80%E6%B5%8B%E5%92%8C%E4%B8%BB%E5%8A%A8%E5%9B%9E%E9%81%BF"><span class="toc-number">1.6.1.</span> <span class="toc-text">干扰检测和主动回避</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E6%B5%8B%E7%AE%97%E6%B3%95%E5%A2%9E%E5%BC%BA%E7%9A%84%E5%8A%A8%E6%80%81%E8%B5%84%E6%BA%90%E8%B6%85%E5%8D%96"><span class="toc-number">1.6.2.</span> <span class="toc-text">预测算法增强的动态资源超卖</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.7.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/27/hexo-beautify/" title="Hexo 博客美化笔记：从零搭建高颜值技术博客">Hexo 博客美化笔记：从零搭建高颜值技术博客</a><time datetime="2026-02-27T04:00:00.000Z" title="发表于 2026-02-27 12:00:00">2026-02-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/11/Jenkens-Blue%20Ocean%20%E6%8F%92%E4%BB%B6/" title="Jenkins Blue Ocean">Jenkins Blue Ocean</a><time datetime="2025-09-11T12:42:57.000Z" title="发表于 2025-09-11 20:42:57">2025-09-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/11/jenkins-jenkinsfile/" title="Jenkins Jenkinsfile">Jenkins Jenkinsfile</a><time datetime="2025-09-11T12:40:44.000Z" title="发表于 2025-09-11 20:40:44">2025-09-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/11/shell-trap/" title="Linux-trap">Linux-trap</a><time datetime="2025-09-11T12:40:44.000Z" title="发表于 2025-09-11 20:40:44">2025-09-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/11/shell-%E6%95%B0%E7%BB%84/" title="Shell-数组">Shell-数组</a><time datetime="2025-09-11T12:40:44.000Z" title="发表于 2025-09-11 20:40:44">2025-09-11</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By 六一</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.4</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true}});</script></body></html>