<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="TraefikTraefik 是一个开源的可以使服务发布变得轻松有趣的边缘路由器。它负责接收你系统的请求，然后使用合适的组件来对这些请求进行处理。  除了众多的功能之外，Traefik 的与众不同之处还在于它会自动发现适合你服务的配置。当 Traefik 在检查你的服务时，会找到服务的相关信息并找到合适的服务来满足对应的请求。 Traefik 兼容所有主流的集群技术，比如 Kubernetes，D">
<meta property="og:type" content="article">
<meta property="og:title" content="Traefik">
<meta property="og:url" content="http://example.com/2025/09/11/Traefik/index.html">
<meta property="og:site_name" content="Hui&#39;s Blog">
<meta property="og:description" content="TraefikTraefik 是一个开源的可以使服务发布变得轻松有趣的边缘路由器。它负责接收你系统的请求，然后使用合适的组件来对这些请求进行处理。  除了众多的功能之外，Traefik 的与众不同之处还在于它会自动发现适合你服务的配置。当 Traefik 在检查你的服务时，会找到服务的相关信息并找到合适的服务来满足对应的请求。 Traefik 兼容所有主流的集群技术，比如 Kubernetes，D">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/1gb4v5.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/hm4kjx.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/bjb58u.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/xgwdeb.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/uoz3bo.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/yoo7cy.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/dda981.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/yhonhy.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/5kvdzc.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/ohsye7.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/qmbqmo.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/2465yp.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/zkcd2q.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/phzpr2.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/yllo5b.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/hygqta.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/336u4h.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/5qi25e.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/ufn9wa.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/n4ad03.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/vyl0l0.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/q74cr4.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/7r95le.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/e3fak1.png">
<meta property="og:image" content="https://picdn.youdianzhishi.com/images/20201224173045.png">
<meta property="og:image" content="https://mudutestmenu.mudu.tv/upload/rsufj1.png">
<meta property="article:published_time" content="2025-09-11T12:32:34.000Z">
<meta property="article:modified_time" content="2025-09-11T14:08:37.872Z">
<meta property="article:author" content="六一">
<meta property="article:tag" content="运维">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mudutestmenu.mudu.tv/upload/1gb4v5.png">

<link rel="canonical" href="http://example.com/2025/09/11/Traefik/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Traefik | Hui's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hui's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Code Life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/Traefik/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Traefik
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:08:37" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>33k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>30 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Traefik"><a href="#Traefik" class="headerlink" title="Traefik"></a>Traefik</h1><p><a target="_blank" rel="noopener" href="https://github.com/containous/traefik">Traefik</a> 是一个开源的可以使服务发布变得轻松有趣的边缘路由器。它负责接收你系统的请求，然后使用合适的组件来对这些请求进行处理。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/1gb4v5.png" alt="traefik architecture"></p>
<p>除了众多的功能之外，Traefik 的与众不同之处还在于它会自动发现适合你服务的配置。当 Traefik 在检查你的服务时，会找到服务的相关信息并找到合适的服务来满足对应的请求。</p>
<p>Traefik 兼容所有主流的集群技术，比如 Kubernetes，Docker，Docker Swarm，AWS，Mesos，Marathon，等等；并且可以同时处理多种方式。（甚至可以用于在裸机上运行的比较旧的软件。）</p>
<p>使用 Traefik，不需要维护或者同步一个独立的配置文件：因为一切都会自动配置，实时操作的（无需重新启动，不会中断连接）。使用 Traefik，你可以花更多的时间在系统的开发和新功能上面，而不是在配置和维护工作状态上面花费大量时间。</p>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><p>Traefik 是一个边缘路由器，是你整个平台的大门，拦截并路由每个传入的请求：它知道所有的逻辑和规则，这些规则确定哪些服务处理哪些请求；传统的反向代理需要一个配置文件，其中包含路由到你服务的所有可能路由，而 Traefik 会实时检测服务并自动更新路由规则，可以自动服务发现。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/hm4kjx.png" alt="traefik architecture overview"></p>
<p>首先，当启动 Traefik 时，需要定义 <code>entrypoints</code>（入口点），然后，根据连接到这些 entrypoints 的<strong>路由</strong>来分析传入的请求，来查看他们是否与一组<strong>规则</strong>相匹配，如果匹配，则路由可能会将请求通过一系列<strong>中间件</strong>转换过后再转发到你的<strong>服务</strong>上去。在了解 Traefik 之前有几个核心概念我们必须要了解：</p>
<ul>
<li><code>Providers</code> 用来自动发现平台上的服务，可以是编排工具、容器引擎或者 key-value 存储等，比如 Docker、Kubernetes、File</li>
<li><code>Entrypoints</code> 监听传入的流量（端口等…），是网络入口点，它们定义了接收请求的端口（HTTP 或者 TCP）。</li>
<li><code>Routers</code> 分析请求（host, path, headers, SSL, …），负责将传入请求连接到可以处理这些请求的服务上去。</li>
<li><code>Services</code> 将请求转发给你的应用（load balancing, …），负责配置如何获取最终将处理传入请求的实际服务。</li>
<li><code>Middlewares</code> 中间件，用来修改请求或者根据请求来做出一些判断（authentication, rate limiting, headers, …），中间件被附件到路由上，是一种在请求发送到你的<strong>服务</strong>之前（或者在服务的响应发送到客户端之前）调整请求的一种方法。</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>由于 Traefik 2.X 版本和之前的 1.X 版本不兼容，我们这里选择功能更加强大的 2.X 版本来和大家进行讲解。</p>
<p>在 Traefik 中的配置可以使用两种不同的方式：</p>
<ul>
<li>动态配置：完全动态的路由配置</li>
<li>静态配置：启动配置</li>
</ul>
<p><code>静态配置</code>中的元素（这些元素不会经常更改）连接到 providers 并定义 Treafik 将要监听的 entrypoints。</p>
<blockquote>
<p>在 Traefik 中有三种方式定义静态配置：在配置文件中、在命令行参数中、通过环境变量传递</p>
</blockquote>
<p><code>动态配置</code>包含定义系统如何处理请求的所有配置内容，这些配置是可以改变的，而且是无缝热更新的，没有任何请求中断或连接损耗。</p>
<p>这里我们还是使用 Helm 来快速安装 traefik，首先获取 Helm Chart 包：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜ git clone https://github.com/traefik/traefik-helm-chart</span><br><span class="line">➜ cd traefik-helm-chart</span><br></pre></td></tr></table></figure>



<p>创建一个定制的 values 配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ci/deployment-prod.yaml</span></span><br><span class="line"><span class="attr">deployment:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 IngressClass. Traefik 版本&lt;2.3 或者 Kubernetes 版本 &lt; 1.18.x 会被忽略</span></span><br><span class="line"><span class="attr">ingressClass:</span></span><br><span class="line">  <span class="comment"># 还没有进行完整的单元测试，pending https://github.com/rancher/helm-unittest/pull/12</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">isDefaultClass:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ingressRoute:</span> <span class="comment"># 不用自动创建，我们自己处理</span></span><br><span class="line">  <span class="attr">dashboard:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 配置 providers</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">providers:</span></span><br><span class="line">  <span class="attr">kubernetesCRD:</span> <span class="comment"># 开启 crd provider</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">allowCrossNamespace:</span> <span class="literal">true</span> <span class="comment"># 是否允许跨命名空间</span></span><br><span class="line">    <span class="attr">allowExternalNameServices:</span> <span class="literal">true</span> <span class="comment"># 是否允许使用 ExternalName 的服务</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubernetesIngress:</span> <span class="comment"># 开启 ingress provider</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">allowExternalNameServices:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logs:</span></span><br><span class="line">  <span class="attr">general:</span></span><br><span class="line">    <span class="comment"># format: json</span></span><br><span class="line">    <span class="attr">level:</span> <span class="string">DEBUG</span></span><br><span class="line">  <span class="attr">access:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">80</span> <span class="comment"># 使用 hostport 模式</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">websecure:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">443</span> <span class="comment"># 使用 hostport 模式</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9100</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">9101</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span> <span class="comment"># host 模式就不需要创建 Service 了，云端环境可以用 Service 模式</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">requests:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">&#x27;100Mi&#x27;</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">&#x27;100Mi&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tolerations:   # kubeadm 安装的集群默认情况下master是有污点，如果需要安装在master节点需要添加容忍</span></span><br><span class="line"><span class="comment"># - key: &quot;node-role.kubernetes.io/master&quot;</span></span><br><span class="line"><span class="comment">#   operator: &quot;Equal&quot;</span></span><br><span class="line"><span class="comment">#   effect: &quot;NoSchedule&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">nodeSelector:</span> <span class="comment"># 固定到node1这个边缘节点</span></span><br><span class="line">  <span class="attr">kubernetes.io/hostname:</span> <span class="string">&#x27;node1&#x27;</span></span><br></pre></td></tr></table></figure>



<p>这里我们使用 hostport 模式将 Traefik 固定到 master1 节点上，因为只有这个节点有外网 IP，所以我们这里 master1 是作为流量的入口点。直接使用上面的 values 文件安装 traefik：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜ helm upgrade --install traefik ./traefik -f ./traefik/ci/deployment-prod.yaml --namespace kube-system</span><br><span class="line">Release &quot;traefik&quot; does not exist. Installing it now.</span><br><span class="line">NAME: traefik</span><br><span class="line">LAST DEPLOYED: Thu Dec 23 17:03:29 2021</span><br><span class="line">NAMESPACE: kube-system</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">➜ kubectl get pods -n kube-system -l app.kubernetes.io/name=traefik</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">traefik-684d76779f-wpp8n   1/1     Running   0          3m15s</span><br></pre></td></tr></table></figure>



<p>安装完成后我们可以通过查看 Pod 的资源清单来了解 Traefik 的运行方式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get deploy -n kube-system traefik -o yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">......</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - --global.checknewversion</span><br><span class="line">        - --global.sendanonymoususage</span><br><span class="line">        - --entryPoints.metrics.address=:9100/tcp</span><br><span class="line">        - --entryPoints.traefik.address=:9000/tcp</span><br><span class="line">        - --entryPoints.web.address=:8000/tcp</span><br><span class="line">        - --entryPoints.websecure.address=:8443/tcp</span><br><span class="line">        - --api.dashboard=true</span><br><span class="line">        - --ping=true</span><br><span class="line">        - --metrics.prometheus=true</span><br><span class="line">        - --metrics.prometheus.entrypoint=metrics</span><br><span class="line">        - --providers.kubernetescrd</span><br><span class="line">        - --providers.kubernetescrd.allowExternalNameServices=true</span><br><span class="line">        - --providers.kubernetesingress</span><br><span class="line">        - --providers.kubernetesingress.allowExternalNameServices=true</span><br><span class="line">        - --log.level=DEBUG</span><br><span class="line">        - --accesslog=true</span><br><span class="line">        - --accesslog.fields.defaultmode=keep</span><br><span class="line">        - --accesslog.fields.headers.defaultmode=drop</span><br><span class="line">        image: traefik:2.5.4</span><br><span class="line">......</span><br></pre></td></tr></table></figure>



<p>其中 <code>entryPoints</code> 属性定义了 <code>web</code> 和 <code>websecure</code> 这两个入口点的，并开启 <code>kubernetesingress</code> 和 <code>kubernetescrd</code> 这两个 provider，也就是我们可以使用 Kubernetes 原本的 Ingress 资源对象，也可以使用 Traefik 自己扩展的 <code>IngressRoute</code> 这样的 CRD 资源对象。</p>
<p>我们可以首先创建一个用于 Dashboard 访问的 IngressRoute 资源清单：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">➜ cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: traefik.containo.us/v1alpha1</span><br><span class="line">kind: IngressRoute</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  entryPoints:</span><br><span class="line">  - web</span><br><span class="line">  routes:</span><br><span class="line">  - match: Host(`traefik.qikqiak.com`)  # 指定域名</span><br><span class="line">    kind: Rule</span><br><span class="line">    services:</span><br><span class="line">    - name: api@internal</span><br><span class="line">      kind: TraefikService  # 引用另外的 Traefik Service</span><br><span class="line">EOF</span><br><span class="line">➜ kubectl get ingressroute -n kube-system</span><br><span class="line">NAME                AGE</span><br><span class="line">traefik-dashboard   19m</span><br></pre></td></tr></table></figure>



<p>其中的 <code>TraefikService</code> 是 <code>Traefik Service</code> 的一个 CRD 实现，这里我们使用的 <code>api@internal</code> 这个 <code>TraefikService</code>，表示我们访问的是 Traefik 内置的应用服务。</p>
<p>部署完成后我们可以通过在本地 <code>/etc/hosts</code> 中添加上域名 <code>traefik.qikqiak.com</code> 的映射即可访问 Traefik 的 Dashboard 页面了：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/bjb58u.png" alt="traefik dashboard demo"></p>
<p>!!! info “注意”</p>
<p>另外需要注意的是默认情况下 Traefik 的 IngressRoute 已经允许跨 namespace 进行通信了，可以通过设置参数 <code>--providers.kubernetescrd.allowCrossNamespace=true</code> 开启（默认已经开启），开启后 IngressRoute 就可以引用 IngressRoute 命名空间以外的其他命名空间中的任何资源了。</p>
<p>如果要让 Traefik 去处理默认的 Ingress 资源对象，则我们就需要使用名为 <code>traefik</code>的 IngressClass 了，因为没有指定默认的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get ingressclass</span><br><span class="line">NAME      CONTROLLER                      PARAMETERS   AGE</span><br><span class="line">nginx     k8s.io/ingress-nginx            &lt;none&gt;       46h</span><br><span class="line">traefik   traefik.io/ingress-controller   &lt;none&gt;       122m</span><br></pre></td></tr></table></figure>



<p>创建如下所示的一个 Ingress 资源对象，这里的核心是 <code>ingressClassName</code> 要指向 <code>traefik</code> 这个 IngressClass：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx-by-traefik</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">traefik</span> <span class="comment"># 使用 traefk 的 IngressClass</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">ngdemo-by-traefik.qikqiak.com</span> <span class="comment"># 将域名映射到 my-nginx 服务</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span> <span class="comment"># 将所有请求发送到 my-nginx 服务的 80 端口</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>直接创建上面的资源对象即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  kubectl get ingress</span><br><span class="line">NAME                  CLASS     HOSTS                           ADDRESS         PORTS     AGE</span><br><span class="line">my-nginx              nginx     ngdemo.qikqiak.com              192.168.31.31   80        3d23h</span><br><span class="line">my-nginx-by-traefik   traefik   ngdemo-by-traefik.qikqiak.com                   80        4s</span><br></pre></td></tr></table></figure>



<p>然后就可以正常访问 <code>ngdemo-by-traefik.qikqiak.com</code> 域名了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">➜  curl ngdemo-by-traefik.qikqiak.com</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<h2 id="ACME"><a href="#ACME" class="headerlink" title="ACME"></a>ACME</h2><p>Traefik 通过扩展 CRD 的方式来扩展 Ingress 的功能，除了默认的用 Secret 的方式可以支持应用的 HTTPS 之外，还支持自动生成 HTTPS 证书。</p>
<p>比如现在我们有一个如下所示的 <code>whoami</code> 应用：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">whoami</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">whoami</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">whoami</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">whoami</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">whoami</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">whoami</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">whoami</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">containous/whoami</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>然后定义一个 IngressRoute 对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressroute-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`who.qikqiak.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">PathPrefix(`/notls`)</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">whoami</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>通过 <code>entryPoints</code> 指定了我们这个应用的入口点是 <code>web</code>，也就是通过 80 端口访问，然后访问的规则就是要匹配 <code>who.qikqiak.com</code> 这个域名，并且具有 <code>/notls</code> 的路径前缀的请求才会被 <code>whoami</code> 这个 Service 所匹配。我们可以直接创建上面的几个资源对象，然后对域名做对应的解析后，就可以访问应用了：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/xgwdeb.png" alt="traefik whoami http demo"></p>
<p>在 <code>IngressRoute</code> 对象中我们定义了一些匹配规则，这些规则在 Traefik 中有如下定义方式：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/uoz3bo.png" alt="traefik route matcher"></p>
<p>如果我们需要用 HTTPS 来访问我们这个应用的话，就需要监听 <code>websecure</code> 这个入口点，也就是通过 443 端口来访问，同样用 HTTPS 访问应用必然就需要证书，这里我们用 <code>openssl</code> 来创建一个自签名的证书：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/CN=who.qikqiak.com&quot;</span><br></pre></td></tr></table></figure>



<p>然后通过 Secret 对象来引用证书文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">要注意证书文件名称必须是 tls.crt 和 tls.key</span></span><br><span class="line">➜ kubectl create secret tls who-tls --cert=tls.crt --key=tls.key</span><br></pre></td></tr></table></figure>



<p>这个时候我们就可以创建一个 HTTPS 访问应用的 IngressRoute 对象了：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressroute-tls-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">websecure</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`who.qikqiak.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">PathPrefix(`/tls`)</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">whoami</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">who-tls</span></span><br></pre></td></tr></table></figure>



<p>创建完成后就可以通过 HTTPS 来访问应用了，由于我们是自签名的证书，所以证书是不受信任的：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/yoo7cy.png" alt="traefik whoami https demo"></p>
<p>除了手动提供证书的方式之外 Traefik 同样也支持使用 <code>Let’s Encrypt</code> 自动生成证书，要使用 <code>Let’s Encrypt</code> 来进行自动化 HTTPS，就需要首先开启 <code>ACME</code>，开启 <code>ACME</code> 需要通过静态配置的方式，也就是说可以通过环境变量、启动参数等方式来提供。</p>
<p>ACME 有多种校验方式 <code>tlsChallenge</code>、<code>httpChallenge</code> 和 <code>dnsChallenge</code> 三种验证方式，之前更常用的是 http 这种验证方式，关于这几种验证方式的使用可以查看文档：<a target="_blank" rel="noopener" href="https://www.qikqiak.com/traefik-book/https/acme/">https://www.qikqiak.com/traefik-book/https/acme/</a> 了解他们之间的区别。要使用 tls 校验方式的话需要保证 Traefik 的 443 端口是可达的，dns 校验方式可以生成通配符的证书，只需要配置上 DNS 解析服务商的 API 访问密钥即可校验。我们这里用 DNS 校验的方式来为大家说明如何配置 ACME。</p>
<p>我们可以重新修改 Helm 安装的 values 配置文件，添加如下所示的定制参数：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ci/deployment-prod.yaml</span></span><br><span class="line"><span class="attr">additionalArguments:</span></span><br><span class="line">  <span class="comment"># 使用 dns 验证方式</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--certificatesResolvers.ali.acme.dnsChallenge.provider=alidns</span></span><br><span class="line">  <span class="comment"># 先使用staging环境进行验证，验证成功后再使用移除下面一行的配置</span></span><br><span class="line">  <span class="comment"># - --certificatesResolvers.ali.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory</span></span><br><span class="line">  <span class="comment"># 邮箱配置</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--certificatesResolvers.ali.acme.email=ych_1024@163.com</span></span><br><span class="line">  <span class="comment"># 保存 ACME 证书的位置</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--certificatesResolvers.ali.acme.storage=/data/acme.json</span></span><br><span class="line"></span><br><span class="line"><span class="attr">envFrom:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">secretRef:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">traefik-alidns-secret</span></span><br><span class="line">      <span class="comment"># ALICLOUD_ACCESS_KEY</span></span><br><span class="line">      <span class="comment"># ALICLOUD_SECRET_KEY</span></span><br><span class="line">      <span class="comment"># ALICLOUD_REGION_ID</span></span><br><span class="line"></span><br><span class="line"><span class="attr">persistence:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启持久化</span></span><br><span class="line">  <span class="attr">accessMode:</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">size:</span> <span class="string">128Mi</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于上面持久化了ACME的数据，需要重新配置下面的安全上下文</span></span><br><span class="line"><span class="attr">securityContext:</span></span><br><span class="line">  <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">runAsGroup:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">runAsNonRoot:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>



<p>这样我们可以通过设置 <code>--certificatesresolvers.ali.acme.dnschallenge.provider=alidns</code> 参数来指定指定阿里云的 DNS 校验，要使用阿里云的 DNS 校验我们还需要配置 3 个环境变量：<code>ALICLOUD_ACCESS_KEY</code>、<code>ALICLOUD_SECRET_KEY</code>、<code>ALICLOUD_REGION_ID</code>，分别对应我们平时开发阿里云应用的时候的密钥，可以登录阿里云后台 <a target="_blank" rel="noopener" href="https://ram.console.aliyun.com/manage/ak">https://ram.console.aliyun.com/manage/ak</a> 获取，由于这是比较私密的信息，所以我们用 Secret 对象来创建：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl create secret generic traefik-alidns-secret --from-literal=ALICLOUD_ACCESS_KEY=&lt;aliyun ak&gt; --from-literal=ALICLOUD_SECRET_KEY=&lt;aliyun sk&gt; --from-literal=ALICLOUD_REGION_ID=cn-beijing -n kube-system</span><br></pre></td></tr></table></figure>



<p>创建完成后将这个 Secret 通过环境变量配置到 Traefik 的应用中，还有一个值得注意的是验证通过的证书我们这里存到 <code>/data/acme.json</code> 文件中，我们一定要将这个文件持久化，否则每次 Traefik 重建后就需要重新认证，而 <code>Let’s Encrypt</code> 本身校验次数是有限制的。所以我们在 values 中重新开启了数据持久化，不过开启过后需要我们提供一个可用的 PV 存储，由于我们将 Traefik 固定到 master1 节点上的，所以我们可以创建一个 hostpath 类型的 PV（后面会详细讲解）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜ cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 128Mi</span><br><span class="line">  hostPath:</span><br><span class="line">    path: /data/k8s/traefik</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<p>然后使用如下所示的命令更新 Traefik：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ helm upgrade --install traefik ./traefik -f ./traefik/ci/deployment-prod.yaml --namespace kube-system</span><br></pre></td></tr></table></figure>



<p>更新完成后现在我们来修改上面我们的 <code>whoami</code> 应用：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressroute-tls-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">websecure</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`who.qikqiak.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">PathPrefix(`/tls`)</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">whoami</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="attr">certResolver:</span> <span class="string">ali</span></span><br><span class="line">    <span class="attr">domains:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">main:</span> <span class="string">&#x27;*.qikqiak.com&#x27;</span></span><br></pre></td></tr></table></figure>



<p>其他的都不变，只需要将 tls 部分改成我们定义的 <code>ali</code> 这个证书解析器，如果我们想要生成一个通配符的域名证书的话可以定义 <code>domains</code> 参数来指定，然后更新 IngressRoute 对象，这个时候我们再去用 HTTPS 访问我们的应用（当然需要将域名在阿里云 DNS 上做解析）：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/dda981.png" alt="traefik wildcard domain"></p>
<p>我们可以看到访问应用已经是受浏览器信任的证书了，查看证书我们还可以发现该证书是一个通配符的证书。</p>
<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><p>中间件是 Traefik2.x 中一个非常有特色的功能，我们可以根据自己的各种需求去选择不同的中间件来满足服务，Traefik 官方已经内置了许多不同功能的中间件，其中一些可以修改请求，头信息，一些负责重定向，一些添加身份验证等等，而且中间件还可以通过链式组合的方式来适用各种情况。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/yhonhy.png" alt="traefik middleware overview"></p>
<h3 id="跳转-https"><a href="#跳转-https" class="headerlink" title="跳转 https"></a>跳转 https</h3><p>同样比如上面我们定义的 whoami 这个应用，我们可以通过 <code>https://who.qikqiak.com/tls</code> 来访问到应用，但是如果我们用 <code>http</code> 来访问的话呢就不行了，就会 404 了，因为我们根本就没有简单 80 端口这个入口点，所以要想通过 <code>http</code> 来访问应用的话自然我们需要监听下 <code>web</code> 这个入口点：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressroutetls-http</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`who.qikqiak.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">PathPrefix(`/tls`)</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">whoami</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>注意这里我们创建的 IngressRoute 的 entryPoints 是 <code>web</code>，然后创建这个对象，这个时候我们就可以通过 http 访问到这个应用了。</p>
<p>但是我们如果只希望用户通过 https 来访问应用的话呢？按照以前的知识，我们是不是可以让 http 强制跳转到 https 服务去，对的，在 Traefik 中也是可以配置强制跳转的，只是这个功能现在是通过中间件来提供的了。如下所示，我们使用 <code>redirectScheme</code> 中间件来创建提供强制跳转服务：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Middleware</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redirect-https</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">redirectScheme:</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">https</span></span><br></pre></td></tr></table></figure>



<p>然后将这个中间件附加到 http 的服务上面去，因为 https 的不需要跳转：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressroutetls-http</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`who.qikqiak.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">PathPrefix(`/tls`)</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">whoami</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">middlewares:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redirect-https</span></span><br></pre></td></tr></table></figure>



<p>这个时候我们再去访问 http 服务可以发现就会自动跳转到 https 去了。</p>
<h3 id="URL-Rewrite"><a href="#URL-Rewrite" class="headerlink" title="URL Rewrite"></a>URL Rewrite</h3><p>接着我们再介绍如何使用 Traefik 来实现 URL Rewrite 操作，比如我们现部署一个 Nexus 应用，通过 IngressRoute 来暴露服务，对应的资源清单如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nexus.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">cnych/nexus:3.20.1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nexusport</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8081</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nexus</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span> <span class="comment"># 和Service不在同一个命名空间</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">match:</span> <span class="string">Host(`nexus.qikqiak.com`)</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>



<p>由于我们开启了 Traefik 的跨命名空间功能（参数 <code>--providers.kubernetescrd.allowCrossNamespace=true</code>），所以可以引用其他命名空间中的 Service 或者中间件，直接部署上面的应用即可:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl apply -f nexus.yaml</span><br><span class="line">➜ kubectl get ingressroute -n kube-system</span><br><span class="line">NAME                AGE</span><br><span class="line">nexus               19h</span><br><span class="line">➜ kubectl get pods -l app=nexus</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nexus-6f78b79d4c-8xns6   1/1     Running   0          3m37s</span><br><span class="line">➜ kubectl get svc -l app=nexus</span><br><span class="line">NAME    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">nexus   ClusterIP   10.110.135.97   &lt;none&gt;        8081/TCP   50s</span><br></pre></td></tr></table></figure>



<p>部署完成后，我们根据 <code>IngressRoute</code> 对象中的配置，只需要将域名 <code>nexus.qikqiak.com</code> 解析到 Traefik 的节点即可访问：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/5kvdzc.png" alt="nexus url"></p>
<p>到这里我们都可以很简单的来完成，同样的现在我们有一个需求是目前我们只有一个域名可以使用，但是我们有很多不同的应用需要暴露，这个时候我们就只能通过 PATH 路径来进行区分了，比如我们现在希望当我们访问 <code>http:/nexus.qikqiak.com/foo</code> 的时候就是访问的我们的 Nexus 这个应用，当路径是 <code>/bar</code> 开头的时候是其他应用，这种需求是很正常的，这个时候我们就需要来做 URL Rewrite 了。</p>
<p>首先我们使用 <a target="_blank" rel="noopener" href="https://www.qikqiak.com/traefik-book/middlewares/stripprefix/">StripPrefix</a> 这个中间件，这个中间件的功能是<strong>在转发请求之前从路径中删除前缀</strong>，在使用中间件的时候我们只需要理解中间件操作的都是我们直接的请求即可，并不是真实的应用接收到请求过后来进行修改。</p>
<p>现在我们添加一个如下的中间件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Middleware</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">strip-foo-path</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span> <span class="comment"># 注意这里的中间件我们定义在default命名空间下面的</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">stripPrefix:</span></span><br><span class="line">    <span class="attr">prefixes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/foo</span></span><br></pre></td></tr></table></figure>



<p>然后现在我们就需要从 <code>http:/nexus.qikqiak.com/foo</code> 请求中去匹配 <code>/foo</code> 的请求，把这个路径下面的请求应用到上面的中间件中去，因为最终我们的 Nexus 应用接收到的请求是不会带有 <code>/foo</code> 路径的，所以我们需要在请求到达应用之前将这个前缀删除，更新 IngressRoute 对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">match:</span> <span class="string">Host(`nexus.qikqiak.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">PathPrefix(`/foo`)</span> <span class="comment"># 匹配 /foo 路径</span></span><br><span class="line">      <span class="attr">middlewares:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">strip-foo-path</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">default</span> <span class="comment"># 由于我们开启了traefik的跨命名空间功能，所以可以引用其他命名空间中的中间件</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>



<p>创建中间件更新完成上面的 IngressRoute 对象后，这个时候我们前往浏览器中访问 <code>http:/nexus.qikqiak.com/foo</code>，这个时候发现我们的页面任何样式都没有了：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/ohsye7.png" alt="nexus rewrite url error"></p>
<p>我们通过 Chrome 浏览器的 Network 可以查看到 <code>/foo</code> 路径的请求是 200 状态码，但是其他的静态资源对象确全都是 404 了，这是为什么呢？我们仔细观察上面我们的 IngressRoute 资源对象，我们现在是不是只匹配了 <code>/foo</code> 的请求，而我们的静态资源是 <code>/static</code> 路径开头的，当然就匹配不到了，所以就出现了 404，所以我们只需要加上这个 <code>/static</code> 路径的匹配就可以了，同样更新 IngressRoute 对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">match:</span> <span class="string">Host(`nexus.qikqiak.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">PathPrefix(`/foo`)</span></span><br><span class="line">      <span class="attr">middlewares:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">strip-foo-path</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">match:</span> <span class="string">Host(`nexus.qikqiak.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">PathPrefix(`/static`)</span> <span class="comment"># 匹配 /static 的请求</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>



<p>然后更新 IngressRoute 资源对象，这个时候再次去访问应用，可以发现页面样式已经正常了，也可以正常访问应用了：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/qmbqmo.png" alt="nexus rewrite url error2"></p>
<p>但进入应用后发现还是有错误提示信息，通过 Network 分析发现还有一些 <code>/service</code> 开头的请求是 404，当然我们再加上这个前缀的路径即可：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">match:</span> <span class="string">Host(`nexus.qikqiak.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">PathPrefix(`/foo`)</span></span><br><span class="line">      <span class="attr">middlewares:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">strip-foo-path</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">match:</span> <span class="string">Host(`nexus.qikqiak.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">(PathPrefix(`/static`)</span> <span class="string">||</span> <span class="string">PathPrefix(`/service`))</span> <span class="comment"># 匹配 /static 和 /service 的请求</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nexus</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>



<p>更新后，再次访问应用就已经完全正常了：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/2465yp.png" alt="nexus rewrite url ok"></p>
<p>Traefik2.X 版本中的中间件功能非常强大，基本上官方提供的系列中间件可以满足我们大部分需求了，其他中间件的用法，可以参考文档：<a target="_blank" rel="noopener" href="https://www.qikqiak.com/traefik-book/middlewares/overview/%E3%80%82">https://www.qikqiak.com/traefik-book/middlewares/overview/。</a></p>
<h2 id="Traefik-Pilot"><a href="#Traefik-Pilot" class="headerlink" title="Traefik Pilot"></a>Traefik Pilot</h2><p>虽然 Traefik 已经默认实现了很多中间件，可以满足大部分我们日常的需求，但是在实际工作中，用户仍然还是有自定义中间件的需求，这就 <a target="_blank" rel="noopener" href="https://pilot.traefik.io/">Traefik Pilot</a> 的功能了。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/zkcd2q.png" alt="pilot"></p>
<p>Traefik Pilot 是一个 SaaS 平台，和 Traefik 进行链接来扩展其功能，它提供了很多功能，通过一个全局控制面板和 Dashboard 来增强对 Traefik 的观测和控制：</p>
<ul>
<li>Traefik 代理和代理组的网络活动的指标</li>
<li>服务健康问题和安全漏洞警报</li>
<li>扩展 Traefik 功能的插件</li>
</ul>
<p>在 Traefik 可以使用 <code>Traefik Pilot</code> 的功能之前，必须先连接它们，我们只需要对 Traefik 的静态配置进行少量更改即可。</p>
<blockquote>
<p>Traefik 代理必须要能访问互联网才能连接到 <code>Traefik Pilot</code>，通过 HTTPS 在 443 端口上建立连接。</p>
</blockquote>
<p>首先我们需要在 <code>Traefik Pilot</code> 主页上(<a target="_blank" rel="noopener" href="https://pilot.traefik.io/)%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%B8%90%E6%88%B7%EF%BC%8C%E6%B3%A8%E5%86%8C%E6%96%B0%E7%9A%84">https://pilot.traefik.io/)创建一个帐户，注册新的</a> <code>Traefik</code> 实例并开始使用 <code>Traefik Pilot</code>。登录后，可以通过选择 <code>Register New Traefik Instance</code>来创建新实例。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/phzpr2.png" alt="创建实例"></p>
<p>另外，当我们的 Traefik 尚未连接到 <code>Traefik Pilot</code> 时，Traefik Web UI 中将出现一个响铃图标，我们可以选择 <code>Connect with Traefik Pilot</code> 导航到 Traefik Pilot UI 进行操作。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/yllo5b.png" alt="Pilot UI"></p>
<p>登录完成后，<code>Traefik Pilot</code> 会生成一个新实例的令牌，我们需要将这个 Token 令牌添加到 Traefik 静态配置中。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/hygqta.png" alt="Pilot 配置"></p>
<p>我们这里就是在 <code>ci/deployment-prod.yaml</code> 文件中启用 Pilot 的配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ci/deployment-prod.yaml</span></span><br><span class="line"><span class="comment"># Activate Pilot integration</span></span><br><span class="line"><span class="attr">pilot:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">&#x27;e079ea6e-536a-48c6-b3e3-f7cfaf94f477&#x27;</span></span><br></pre></td></tr></table></figure>



<p>然后重新更新 Traefik：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ helm upgrade --install traefik --namespace=kube-system ./traefik -f ./traefik/ci/deployment-prod.yaml</span><br></pre></td></tr></table></figure>



<p>更新完成后，我们在 Traefik 的 Web UI 中就可以看到 Traefik Pilot UI 相关的信息了。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/336u4h.png" alt="更新完成"></p>
<p>接下来我们就可以在 Traefik Pilot 的插件页面选择我们想要使用的插件，比如我们这里使用 <a target="_blank" rel="noopener" href="https://github.com/traefik/plugindemo">Demo Plugin</a> 这个插件。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/5qi25e.png" alt="Demo 插件"></p>
<p>点击右上角的 <code>Install Plugin</code> 按钮安装插件会弹出一个对话框提示我们如何安装。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/ufn9wa.png" alt="插件提示"></p>
<p>首先我们需要将当前 Traefik 注册到 Traefik Pilot（已完成），然后需要以静态配置的方式添加这个插件到 Traefik 中，这里我们同样更新 <code>ci/deployment-prod.yaml</code> 文件中的 Values 值即可：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ci/deployment-prod.yaml</span></span><br><span class="line"><span class="comment"># Activate Pilot integration</span></span><br><span class="line"><span class="attr">pilot:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">&#x27;e079ea6e-536a-48c6-b3e3-f7cfaf94f477&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">additionalArguments:</span></span><br><span class="line">  <span class="comment"># 添加 demo plugin 的支持</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--experimental.plugins.plugindemo.modulename=github.com/traefik/plugindemo</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--experimental.plugins.plugindemo.version=v0.2.1</span></span><br><span class="line"><span class="comment"># 其他配置</span></span><br></pre></td></tr></table></figure>



<p>同样重新更新 Traefik：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ helm upgrade --install traefik --namespace=kube-system ./traefik -f ./ci/deployment-prod.yaml</span><br></pre></td></tr></table></figure>



<p>更新完成后创建一个如下所示的 Middleware 对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span> <span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">|</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Middleware</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myplugin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">plugin:</span></span><br><span class="line">    <span class="attr">plugindemo:</span>  <span class="comment"># 插件名</span></span><br><span class="line">      <span class="attr">Headers:</span></span><br><span class="line">        <span class="attr">X-Demo:</span> <span class="string">test</span></span><br><span class="line">        <span class="attr">Foo:</span> <span class="string">bar</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>



<p>然后添加到上面的 whoami 应用的 IngressRoute 对象中去：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressroute-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`who.qikqiak.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">PathPrefix(`/notls`)</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">whoami</span> <span class="comment"># K8s Service</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">middlewares:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myplugin</span> <span class="comment"># 使用上面新建的 middleware</span></span><br></pre></td></tr></table></figure>



<p>更新完成后，当我们去访问 <code>http://who.qikqiak.com/notls</code> 的时候就可以看到新增了两个上面插件中定义的两个 Header。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/n4ad03.png" alt="自定义插件显示"></p>
<p>当然除了使用 Traefik Pilot 上开发者提供的插件之外，我们也可以根据自己的需求自行开发自己的插件，可以自行参考文档：<a target="_blank" rel="noopener" href="https://doc.traefik.io/traefik-pilot/plugins/plugin-dev/%E3%80%82">https://doc.traefik.io/traefik-pilot/plugins/plugin-dev/。</a></p>
<h2 id="私有插件"><a href="#私有插件" class="headerlink" title="私有插件"></a>私有插件</h2><p>上面我们介绍了可以使用 Traefik Pilot 来使用插件，但是这是一个 SaaS 服务平台，对于大部分企业场景下面不是很适用，我们更多的场景下需要在本地环境加载插件，为解决这个问题，在 Traefik v2.5 版本后，就提供了一种直接从本地存储目录加载插件的新方法，不需要启用 Traefik Pilot，只需要将插件源码放入一个名为 <code>/plugins-local</code> 的新目录，相对于当前工作目录去创建这个目录，比如我们直接使用的是 traefik 的 docker 镜像，则入口点则是根目录 <code>/</code>，Traefik 本身会去构建你的插件，所以我们要做的就是编写源代码，并把它放在正确的目录下，让 Traefik 来加载它即可。</p>
<p>需要注意的是由于在每次启动的时候插件只加载一次，所以如果我们希望重新加载你的插件源码的时候需要重新启动 Traefik。</p>
<p>下面我们使用一个简单的自定义插件示例来说明如何使用私有插件。首先我们定义一个名为 <code>Dockerfile.demo</code> 的 Dockerfile 文件，先从 git 仓库中克隆插件源码，然后以 <code>traefik:v2.5</code> 为基础镜像，将插件源码拷贝刀 <code>/plugins-local</code> 目录，如下所示：</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3</span></span><br><span class="line"><span class="keyword">ARG</span> PLUGIN_MODULE=github.com/traefik/plugindemo</span><br><span class="line"><span class="keyword">ARG</span> PLUGIN_GIT_REPO=https://github.com/traefik/plugindemo.git</span><br><span class="line"><span class="keyword">ARG</span> PLUGIN_GIT_BRANCH=master</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add --update git &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    git <span class="built_in">clone</span> <span class="variable">$&#123;PLUGIN_GIT_REPO&#125;</span> /plugins-local/src/<span class="variable">$&#123;PLUGIN_MODULE&#125;</span> \</span></span><br><span class="line"><span class="language-bash">      --depth 1 --single-branch --branch <span class="variable">$&#123;PLUGIN_GIT_BRANCH&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> traefik:v2.<span class="number">5</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=0 /plugins-local /plugins-local</span></span><br></pre></td></tr></table></figure>



<p>我们这里使用的演示插件和上面 Pilot 中演示的是同一个插件，我们可以通过该插件去自定义请求头信息。</p>
<p>然后在 <code>Dockerfile.demo</code> 目录下面，构建镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ docker build -f Dockerfile.demo -t cnych/traefik-private-demo-plugin:2.5.4 .</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送到镜像仓库</span></span><br><span class="line">➜ docker push cnych/traefik-private-demo-plugin:2.5.4</span><br></pre></td></tr></table></figure>



<p>镜像构建完成后就可以使用这个镜像来测试 demo 插件了，同样我们这里直接去覆盖的 Values 文件，更新 <code>ci/deployment-prod.yaml</code> 文件中的 Values 值，将镜像修改成上面我们自定义的镜像地址：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ci/deployment-prod.yaml</span></span><br><span class="line"><span class="attr">image:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cnych/traefik-private-demo-plugin</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="number">2.5</span><span class="number">.4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他省略</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不需要开启 pilot 了</span></span><br><span class="line"><span class="attr">pilot:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">additionalArguments:</span></span><br><span class="line">  <span class="comment"># 添加 demo plugin 的本地支持</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--experimental.localPlugins.plugindemo.moduleName=github.com/traefik/plugindemo</span></span><br><span class="line"><span class="comment"># 其他省略</span></span><br></pre></td></tr></table></figure>



<p>注意上面我们添加 Traefik 的启动参数的时候使用的 <code>--experimental.localPlugins</code>。然后重新更新 Traefik：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ helm upgrade --install traefik --namespace=kube-system ./traefik -f ./ci/deployment-prod.yaml</span><br></pre></td></tr></table></figure>



<p>更新完成后就可以使用我们的私有插件来创建一个 Middleware 对象了：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span> <span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">|</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Middleware</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-private-plugin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">plugin:</span></span><br><span class="line">    <span class="attr">plugindemo:</span>  <span class="comment"># 插件名</span></span><br><span class="line">      <span class="attr">Headers:</span></span><br><span class="line">        <span class="attr">X-Demo:</span> <span class="string">private-demo</span></span><br><span class="line">        <span class="attr">Foo:</span> <span class="string">bar</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>



<p>然后添加到上面的 whoami 应用的 IngressRoute 对象中去：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressroute-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`who.qikqiak.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">PathPrefix(`/notls`)</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">whoami</span> <span class="comment"># K8s Service</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">middlewares:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-private-plugin</span> <span class="comment"># 使用上面新建的 middleware</span></span><br></pre></td></tr></table></figure>



<p>更新上面的资源对象后，我们再去访问 <code>http://who.qikqiak.com/notls</code> 就可以看到新增了两个上面插件中定义的两个 Header，证明我们的私有插件配置成功了：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/vyl0l0.png" alt="自定义插件显示"></p>
<h2 id="灰度发布"><a href="#灰度发布" class="headerlink" title="灰度发布"></a>灰度发布</h2><p>Traefik2.0 的一个更强大的功能就是灰度发布，灰度发布我们有时候也会称为金丝雀发布（Canary），主要就是让一部分测试的服务也参与到线上去，经过测试观察看是否符号上线要求。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/q74cr4.png" alt="canary deployment"></p>
<p>比如现在我们有两个名为 <code>appv1</code> 和 <code>appv2</code> 的服务，我们希望通过 Traefik 来控制我们的流量，将 3⁄4 的流量路由到 appv1，1&#x2F;4 的流量路由到 appv2 去，这个时候就可以利用 Traefik2.0 中提供的<strong>带权重的轮询（WRR）</strong>来实现该功能，首先在 Kubernetes 集群中部署上面的两个服务。为了对比结果我们这里提供的两个服务一个是 whoami，一个是 nginx，方便测试。</p>
<p>appv1 服务的资源清单如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># appv1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">appv1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">appv1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">use:</span> <span class="string">test</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">appv1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">whoami</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">containous/whoami</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">portv1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">appv1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">appv1</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">portv1</span></span><br></pre></td></tr></table></figure>



<p>appv2 服务的资源清单如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># appv2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">appv2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">appv2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">use:</span> <span class="string">test</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">appv2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">portv2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">appv2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">appv2</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">portv2</span></span><br></pre></td></tr></table></figure>



<p>直接创建上面两个服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl apply -f appv1.yaml</span><br><span class="line">➜ kubectl apply -f appv2.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过下面的命令可以查看服务是否运行成功</span></span><br><span class="line">➜ kubectl get pods -l use=test</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">appv1-58f856c665-shm9j   1/1     Running   0          12s</span><br><span class="line">appv2-ff5db55cf-qjtrf    1/1     Running   0          12s</span><br></pre></td></tr></table></figure>



<p>在 Traefik2.1 中新增了一个 <code>TraefikService</code> 的 CRD 资源，我们可以直接利用这个对象来配置 WRR，之前的版本需要通过 File Provider，比较麻烦，新建一个描述 WRR 的资源清单：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wrr.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">TraefikService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-wrr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">weighted:</span></span><br><span class="line">    <span class="attr">services:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">appv1</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">3</span> <span class="comment"># 定义权重</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">kind:</span> <span class="string">Service</span> <span class="comment"># 可选，默认就是 Service</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">appv2</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>然后为我们的灰度发布的服务创建一个 IngressRoute 资源对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wrr-ingressroute.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wrr-ingressroute</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`wrr.qikqiak.com`)</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-wrr</span></span><br><span class="line">          <span class="attr">kind:</span> <span class="string">TraefikService</span></span><br></pre></td></tr></table></figure>



<p>不过需要注意的是现在我们配置的 Service 不再是直接的 Kubernetes 对象了，而是上面我们定义的 TraefikService 对象，直接创建上面的两个资源对象，这个时候我们对域名 <code>wrr.qikqiak.com</code> 做上解析，去浏览器中连续访问 4 次，我们可以观察到 appv1 这应用会收到 3 次请求，而 appv2 这个应用只收到 1 次请求，符合上面我们的 <code>3:1</code> 的权重配置。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/7r95le.png" alt="traefik wrr demo"></p>
<h2 id="流量复制"><a href="#流量复制" class="headerlink" title="流量复制"></a>流量复制</h2><p>除了灰度发布之外，Traefik 2.0 还引入了流量镜像服务，是一种可以将流入流量复制并同时将其发送给其他服务的方法，镜像服务可以获得给定百分比的请求同时也会忽略这部分请求的响应。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/e3fak1.png" alt="traefik mirror"></p>
<p>现在我们部署两个 whoami 的服务，资源清单文件如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">v2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">v2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>直接创建上面的资源对象：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">v1-77cfb86999-wfbl2                       1/1     Running   0          94s</span><br><span class="line">v2-6f45d498b7-g6qjt                       1/1     Running   0          91s</span><br><span class="line">➜ kubectl get svc</span><br><span class="line">NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)     AGE</span><br><span class="line">v1              ClusterIP   10.96.218.173   &lt;none&gt;        80/TCP      99s</span><br><span class="line">v2              ClusterIP   10.99.98.48     &lt;none&gt;        80/TCP      96s</span><br></pre></td></tr></table></figure>



<p>现在我们创建一个 IngressRoute 对象，将服务 v1 的流量复制 50% 到服务 v2，如下资源对象所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mirror-ingress-route.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">TraefikService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-mirror</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">mirroring:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">v1</span> <span class="comment"># 发送 100% 的请求到 K8S 的 Service &quot;v1&quot;</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">mirrors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span> <span class="comment"># 然后复制 50% 的请求到 v2</span></span><br><span class="line">        <span class="attr">percent:</span> <span class="number">50</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mirror-ingress-route</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`mirror.qikqiak.com`)</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-mirror</span></span><br><span class="line">          <span class="attr">kind:</span> <span class="string">TraefikService</span> <span class="comment"># 使用声明的 TraefikService 服务，而不是 K8S 的 Service</span></span><br></pre></td></tr></table></figure>



<p>然后直接创建这个资源对象即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl apply -f mirror-ingress-route.yaml</span><br></pre></td></tr></table></figure>



<p>这个时候我们在浏览器中去连续访问 4 次 <code>mirror.qikqiak.com</code> 可以发现有一半的请求也出现在了 <code>v2</code> 这个服务中： <img data-src="https://picdn.youdianzhishi.com/images/20201224173045.png" alt="traefik mirror demo"></p>
<h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><p>另外 Traefik2.X 已经支持了 TCP 服务的，下面我们以 mongo 为例来了解下 Traefik 是如何支持 TCP 服务得。</p>
<h3 id="简单-TCP-服务"><a href="#简单-TCP-服务" class="headerlink" title="简单 TCP 服务"></a>简单 TCP 服务</h3><p>首先部署一个普通的 mongo 服务，资源清单文件如下所示：（mongo.yaml）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo-traefik</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mongo-traefik</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mongo-traefik</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mongo-traefik</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongo</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">mongo:4.0</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">27017</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo-traefik</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mongo-traefik</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">27017</span></span><br></pre></td></tr></table></figure>



<p>直接创建 mongo 应用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl apply -f mongo.yaml</span><br><span class="line">deployment.apps/mongo-traefik created</span><br><span class="line">service/mongo-traefik created</span><br></pre></td></tr></table></figure>



<p>创建成功后就可以来为 mongo 服务配置一个路由了。由于 Traefik 中使用 TCP 路由配置需要 <code>SNI</code>，而 <code>SNI</code> 又是依赖 <code>TLS</code> 的，所以我们需要配置证书才行，如果没有证书的话，我们可以使用通配符 <code>*</code> 进行配置，我们这里创建一个 <code>IngressRouteTCP</code> 类型的 CRD 对象（前面我们就已经安装了对应的 CRD 资源）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongo-ingressroute-tcp.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRouteTCP</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo-traefik-tcp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mongo</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">HostSNI(`*`)</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongo-traefik</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">27017</span></span><br></pre></td></tr></table></figure>



<p>要注意的是这里的 <code>entryPoints</code> 部分，是根据我们启动的 Traefik 的静态配置中的 entryPoints 来决定的，我们当然可以使用前面我们定义得 80 和 443 这两个入口点，但是也可以可以自己添加一个用于 mongo 服务的专门入口点，更新 <code>values-prod.yaml</code> 文件，新增 mongo 这个入口点：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># values-prod.yaml</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">websecure:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">mongo:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">27017</span></span><br></pre></td></tr></table></figure>



<p>然后更新 Traefik 即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ helm upgrade --install traefik --namespace=kube-system ./traefik -f ./ci/deployment-prod.yaml</span><br></pre></td></tr></table></figure>



<p>这里给入口点添加 <code>hostPort</code> 是为了能够通过节点的端口访问到服务，关于 entryPoints 入口点的更多信息，可以查看文档 <a target="_blank" rel="noopener" href="https://www.qikqiak.com/traefik-book/routing/entrypoints/">entrypoints</a> 了解更多信息。</p>
<p>然后更新 Traefik 后我们就可以直接创建上面的资源对象：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl apply -f mongo-ingressroute-tcp.yaml</span><br></pre></td></tr></table></figure>



<p>创建完成后，同样我们可以去 Traefik 的 Dashboard 页面上查看是否生效：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/rsufj1.png" alt="traefik-tcp-mongo-1"></p>
<p>然后我们配置一个域名 <code>mongo.local</code> 解析到 Traefik 所在的节点，然后通过 27017 端口来连接 mongo 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜ mongo --host mongo.local --port 27017</span><br><span class="line">mongo(75243,0x1075295c0) malloc: *** malloc_zone_unregister() failed for 0x7fffa56f4000</span><br><span class="line">MongoDB shell version: 2.6.1</span><br><span class="line">connecting to: mongo.local:27017/test</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">show dbs</span></span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local   0.000GB</span><br></pre></td></tr></table></figure>



<p>到这里我们就完成了将 mongo（TCP）服务暴露给外部用户了。</p>
<h3 id="带-TLS-证书的-TCP"><a href="#带-TLS-证书的-TCP" class="headerlink" title="带 TLS 证书的 TCP"></a>带 TLS 证书的 TCP</h3><p>上面我们部署的 mongo 是一个普通的服务，然后用 Traefik 代理的，但是有时候为了安全 mongo 服务本身还会使用 TLS 证书的形式提供服务，下面是用来生成 mongo tls 证书的脚本文件：（generate-certificates.sh）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># From https://medium.com/@rajanmaharjan/secure-your-mongodb-connections-ssl-tls-92e2addb3c89</span></span></span><br><span class="line"></span><br><span class="line">set -eu -o pipefail</span><br><span class="line"></span><br><span class="line">DOMAINS=&quot;$&#123;1&#125;&quot;</span><br><span class="line">CERTS_DIR=&quot;$&#123;2&#125;&quot;</span><br><span class="line">[ -d &quot;$&#123;CERTS_DIR&#125;&quot; ]</span><br><span class="line">CURRENT_DIR=&quot;$(cd &quot;$(dirname &quot;$&#123;0&#125;&quot;)&quot; &amp;&amp; pwd -P)&quot;</span><br><span class="line"></span><br><span class="line">GENERATION_DIRNAME=&quot;$(echo &quot;$&#123;DOMAINS&#125;&quot; | cut -d, -f1)&quot;</span><br><span class="line"></span><br><span class="line">rm -rf &quot;$&#123;CERTS_DIR&#125;/$&#123;GENERATION_DIRNAME:?&#125;&quot; &quot;$&#123;CERTS_DIR&#125;/certs&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;== Checking Requirements...&quot;</span><br><span class="line">command -v go &gt;/dev/null 2&gt;&amp;1 || echo &quot;Golang is required&quot;</span><br><span class="line">command -v minica &gt;/dev/null 2&gt;&amp;1 || go get github.com/jsha/minica &gt;/dev/null</span><br><span class="line"></span><br><span class="line">echo &quot;== Generating Certificates for the following domains: $&#123;DOMAINS&#125;...&quot;</span><br><span class="line">cd &quot;$&#123;CERTS_DIR&#125;&quot;</span><br><span class="line">minica --ca-cert &quot;$&#123;CURRENT_DIR&#125;/minica.pem&quot; --ca-key=&quot;$&#123;CURRENT_DIR&#125;/minica-key.pem&quot; --domains=&quot;$&#123;DOMAINS&#125;&quot;</span><br><span class="line">mv &quot;$&#123;GENERATION_DIRNAME&#125;&quot; &quot;certs&quot;</span><br><span class="line">cat certs/key.pem certs/cert.pem &gt; certs/mongo.pem</span><br><span class="line"></span><br><span class="line">echo &quot;== Certificates Generated in the directory $&#123;CERTS_DIR&#125;/certs&quot;</span><br></pre></td></tr></table></figure>



<p>将上面证书放置到 certs 目录下面，然后我们新建一个 <code>02-tls-mongo</code> 的目录，在该目录下面执行如下命令来生成证书：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ bash ../certs/generate-certificates.sh mongo.local .</span><br><span class="line">== Checking Requirements...</span><br><span class="line">== Generating Certificates for the following domains: mongo.local...</span><br></pre></td></tr></table></figure>



<p>最后的目录如下所示，在 <code>02-tls-mongo</code> 目录下面会生成包含证书的 certs 目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜ tree .</span><br><span class="line">.</span><br><span class="line">├── 01-mongo</span><br><span class="line">│   ├── mongo-ingressroute-tcp.yaml</span><br><span class="line">│   └── mongo.yaml</span><br><span class="line">├── 02-tls-mongo</span><br><span class="line">│   └── certs</span><br><span class="line">│       ├── cert.pem</span><br><span class="line">│       ├── key.pem</span><br><span class="line">│       └── mongo.pem</span><br><span class="line">└── certs</span><br><span class="line">    ├── generate-certificates.sh</span><br><span class="line">    ├── minica-key.pem</span><br><span class="line">    └── minica.pem</span><br></pre></td></tr></table></figure>



<p>在 <code>02-tls-mongo/certs</code> 目录下面执行如下命令通过 Secret 来包含证书内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl create secret tls traefik-mongo-certs --cert=cert.pem --key=key.pem</span><br><span class="line">secret/traefik-mongo-certs created</span><br></pre></td></tr></table></figure>



<p>然后重新更新 <code>IngressRouteTCP</code> 对象，增加 TLS 配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRouteTCP</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo-traefik-tcp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mongo</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">HostSNI(`mongo.local`)</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongo-traefik</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">traefik-mongo-certs</span></span><br></pre></td></tr></table></figure>



<p>同样更新后，现在我们直接去访问应用就会被 hang 住，因为我们没有提供证书：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ mongo --host mongo.local --port 27017</span><br><span class="line">MongoDB shell version: 2.6.1</span><br><span class="line">connecting to: mongo1.local:27017/test</span><br></pre></td></tr></table></figure>



<p>这个时候我们可以带上证书来进行连接：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜ mongo --host mongo.local --port 27017 --ssl --sslCAFile=../certs/minica.pem --sslPEMKeyFile=./certs/mongo.pem</span><br><span class="line">MongoDB shell version v4.0.3</span><br><span class="line">connecting to: mongodb://mongo.local:27017/</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;e7409ef6-8ebe-4c5a-9642-42059bdb477b&quot;) &#125;</span><br><span class="line">MongoDB server version: 4.0.14</span><br><span class="line">......</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">show dbs;</span></span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local   0.000GB</span><br></pre></td></tr></table></figure>



<p>可以看到现在就可以连接成功了，这样就完成了一个使用 TLS 证书代理 TCP 服务的功能，这个时候如果我们使用其他的域名去进行连接就会报错了，因为现在我们指定的是特定的 HostSNI：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜ mongo --host mongo.k8s.local --port 27017 --ssl --sslCAFile=../certs/minica.pem --sslPEMKeyFile=./certs/mongo.pem</span><br><span class="line">MongoDB shell version v4.0.3</span><br><span class="line">connecting to: mongodb://mongo.k8s.local:27017/</span><br><span class="line">2019-12-29T15:03:52.424+0800 E NETWORK  [js] SSL peer certificate validation failed: Certificate trust failure: CSSMERR_TP_NOT_TRUSTED; connection rejected</span><br><span class="line">2019-12-29T15:03:52.429+0800 E QUERY    [js] Error: couldn&#x27;t connect to server mongo.qikqiak.com:27017, connection attempt failed: SSLHandshakeFailed: SSL peer certificate validation failed: Certificate trust failure: CSSMERR_TP_NOT_TRUSTED; connection rejected :</span><br><span class="line">connect@src/mongo/shell/mongo.js:257:13</span><br><span class="line">@(connect):1:6</span><br><span class="line">exception: connect failed</span><br></pre></td></tr></table></figure>



<h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><p>此外 Traefik2.3.x 版本也已经提供了对 UDP 的支持，所以我们可以用于诸如 DNS 解析的服务提供负载。同样首先部署一个如下所示的 UDP 服务：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">whoamiudp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">udp</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">whoamiudp</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">whoamiudp</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">whoamiudp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">whoamiudp</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">whoamiudp</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">whoamiudp</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">containous/whoamiudp</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">udp</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>



<p>直接部署上面的应用，部署完成后我们需要在 Traefik 中定义一个 UDP 的 entryPoint 入口点，修改我们部署 Traefik 的 <code>values-prod.yaml</code> 文件，增加 UDP 协议的入口点：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configure ports</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">websecure:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">mongo:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">27017</span></span><br><span class="line">  <span class="attr">udpep:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">18080</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">18080</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">UDP</span></span><br></pre></td></tr></table></figure>



<p>我们这里定义了一个名为 udpep 的入口点，但是 protocol 协议是 UDP（此外 TCP 和 UDP 共用同一个端口也是可以的，但是协议一定要声明为不一样），然后重新更新 Traefik：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ helm upgrade --install traefik --namespace=kube-system ./traefik -f ./ci/deployment-prod.yaml</span><br></pre></td></tr></table></figure>



<p>更新完成后我们可以导出 Traefik 部署的资源清单文件来检测是否增加上了 UDP 的入口点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get deploy traefik -n kube-system -o yaml</span><br><span class="line">......</span><br><span class="line">containers:</span><br><span class="line">- args:</span><br><span class="line">  - --entryPoints.mongo.address=:27017/tcp</span><br><span class="line">  - --entryPoints.traefik.address=:9000/tcp</span><br><span class="line">  - --entryPoints.udpep.address=:18080/udp</span><br><span class="line">  - --entryPoints.web.address=:8000/tcp</span><br><span class="line">  - --entryPoints.websecure.address=:8443/tcp</span><br><span class="line">  - --api.dashboard=true</span><br><span class="line">  - --ping=true</span><br><span class="line">  - --providers.kubernetescrd</span><br><span class="line">  - --providers.kubernetesingress</span><br><span class="line">......</span><br></pre></td></tr></table></figure>



<p>UDP 的入口点增加成功后，接下来我们可以创建一个 <code>IngressRouteUDP</code> 类型的资源对象，用来代理 UDP 请求：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜ cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: traefik.containo.us/v1alpha1</span><br><span class="line">kind: IngressRouteUDP</span><br><span class="line">metadata:</span><br><span class="line">  name: whoamiudp</span><br><span class="line">spec:</span><br><span class="line">  entryPoints:</span><br><span class="line">  - udpep</span><br><span class="line">  routes:</span><br><span class="line">  - services:</span><br><span class="line">    - name: whoamiudp</span><br><span class="line">      port: 8080</span><br><span class="line">EOF</span><br><span class="line">➜ kubectl get ingressrouteudp</span><br><span class="line">NAME        AGE</span><br><span class="line">whoamiudp   31s</span><br></pre></td></tr></table></figure>



<p>创建成功后我们首先在集群上通过 Service 来访问上面的 UDP 应用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get svc</span><br><span class="line">NAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                 AGE</span><br><span class="line">whoamiudp           ClusterIP   10.106.10.185    &lt;none&gt;        8080/UDP                                36m</span><br><span class="line">➜ echo &quot;WHO&quot; | socat - udp4-datagram:10.106.10.185:8080</span><br><span class="line">Hostname: whoamiudp-d884bdb64-6mpk6</span><br><span class="line">IP: 127.0.0.1</span><br><span class="line">IP: 10.244.1.145</span><br><span class="line">➜ echo &quot;othermessage&quot; | socat - udp4-datagram:10.106.10.185:8080</span><br><span class="line">Received: othermessage</span><br></pre></td></tr></table></figure>



<p>我们这个应用当我们输入 <code>WHO</code> 的时候，就会打印出访问的 Pod 的 Hostname 这些信息，如果不是则打印接收到字符串。现在我们通过 Traefik 所在节点的 IP（10.151.30.11）与 18080 端口来访问 UDP 应用进行测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜ echo &quot;othermessage&quot; | socat - udp4-datagram:10.151.30.11:18080</span><br><span class="line">Received: othermessage</span><br><span class="line">➜  echo &quot;WHO&quot; | socat - udp4-datagram:10.151.30.11:18080</span><br><span class="line">Hostname: whoamiudp-d884bdb64-hkw6k</span><br><span class="line">IP: 127.0.0.1</span><br><span class="line">IP: 10.244.2.87</span><br></pre></td></tr></table></figure>



<p>我们可以看到测试成功了，证明我就用 Traefik 来代理 UDP 应用成功了。除此之外 Traefik 还有很多功能，特别是强大的中间件和自定义插件的功能，为我们提供了不断扩展其功能的能力，我们完成可以根据自己的需求进行二次开发。</p>
<h2 id="多控制器"><a href="#多控制器" class="headerlink" title="多控制器"></a>多控制器</h2><p>有的业务场景下可能需要在一个集群中部署多个 traefik，不同的实例控制不同的 IngressRoute 资源对象，要实现该功能有两种方法：</p>
<p>第一种方法：通过 annotations 注解筛选:</p>
<ul>
<li>首先在 traefik 中增加启动参数 <code>--providers.kubernetescrd.ingressclass=traefik-in</code></li>
<li>然后在 IngressRoute 资源对象中添加 <code>kubernetes.io/ingress.class: traefik-in</code> 注解即可</li>
</ul>
<p>第二种方法：通过标签选择器进行过滤：</p>
<ul>
<li>首先在 traefik 中增加启动参数 <code>--providers.kubernetescrd.labelselector=ingressclass=traefik-out</code></li>
<li>然后在 IngressRoute 资源对象中添加 <code>ingressclass: traefik-out</code> 这个标签即可</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E8%BF%90%E7%BB%B4/" rel="tag"># 运维</a>
              <a href="/tags/k8s/" rel="tag"># k8s</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/09/11/byte/" rel="prev" title="byte">
      <i class="fa fa-chevron-left"></i> byte
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/09/11/categraf/" rel="next" title="categraf">
      categraf <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Traefik"><span class="nav-number">1.</span> <span class="nav-text">Traefik</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">1.1.</span> <span class="nav-text">核心概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">1.2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ACME"><span class="nav-number">1.3.</span> <span class="nav-text">ACME</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">1.4.</span> <span class="nav-text">中间件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%B3%E8%BD%AC-https"><span class="nav-number">1.4.1.</span> <span class="nav-text">跳转 https</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#URL-Rewrite"><span class="nav-number">1.4.2.</span> <span class="nav-text">URL Rewrite</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Traefik-Pilot"><span class="nav-number">1.5.</span> <span class="nav-text">Traefik Pilot</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%81%E6%9C%89%E6%8F%92%E4%BB%B6"><span class="nav-number">1.6.</span> <span class="nav-text">私有插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83"><span class="nav-number">1.7.</span> <span class="nav-text">灰度发布</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E5%A4%8D%E5%88%B6"><span class="nav-number">1.8.</span> <span class="nav-text">流量复制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TCP"><span class="nav-number">1.9.</span> <span class="nav-text">TCP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95-TCP-%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.9.1.</span> <span class="nav-text">简单 TCP 服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%A6-TLS-%E8%AF%81%E4%B9%A6%E7%9A%84-TCP"><span class="nav-number">1.9.2.</span> <span class="nav-text">带 TLS 证书的 TCP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UDP"><span class="nav-number">1.10.</span> <span class="nav-text">UDP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">1.11.</span> <span class="nav-text">多控制器</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">六一</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">273</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/huiaz" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;huiaz" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">六一</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.7m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">25:34</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true}});</script></body>
</html>
