<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>OPA | Hui's Blog</title><meta name="author" content="六一"><meta name="copyright" content="六一"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="OPA 策略引擎Open Policy Agent 简称 OPA，是一种开源的通用策略代理引擎，是 CNCF 毕业的项目。OPA 提供了一种高级声明式语言 Rego，简化了策略规则的定义，以减轻程序中策略的决策负担。在微服务、Kubernetes、CI&#x2F;CD、API 网关等场景中均可以使用 OPA 来定义策略。  我们这里主要讲解在 Kubernetes 中如何集成 OPA，在 Kube">
<meta property="og:type" content="article">
<meta property="og:title" content="OPA">
<meta property="og:url" content="https://huiaz.github.io/2025/09/11/OPA/index.html">
<meta property="og:site_name" content="Hui&#39;s Blog">
<meta property="og:description" content="OPA 策略引擎Open Policy Agent 简称 OPA，是一种开源的通用策略代理引擎，是 CNCF 毕业的项目。OPA 提供了一种高级声明式语言 Rego，简化了策略规则的定义，以减轻程序中策略的决策负担。在微服务、Kubernetes、CI&#x2F;CD、API 网关等场景中均可以使用 OPA 来定义策略。  我们这里主要讲解在 Kubernetes 中如何集成 OPA，在 Kube">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://huiaz.github.io/img/butterfly-icon.png">
<meta property="article:published_time" content="2025-09-11T12:32:34.000Z">
<meta property="article:modified_time" content="2025-09-11T13:50:59.287Z">
<meta property="article:author" content="六一">
<meta property="article:tag" content="运维">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://huiaz.github.io/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "OPA",
  "url": "https://huiaz.github.io/2025/09/11/OPA/",
  "image": "https://huiaz.github.io/img/butterfly-icon.png",
  "datePublished": "2025-09-11T12:32:34.000Z",
  "dateModified": "2025-09-11T13:50:59.287Z",
  "author": [
    {
      "@type": "Person",
      "name": "六一",
      "url": "https://huiaz.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://huiaz.github.io/2025/09/11/OPA/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.13.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'OPA',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">274</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">45</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Hui's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">OPA</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">OPA</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-11T12:32:34.000Z" title="发表于 2025-09-11 20:32:34">2025-09-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-11T13:50:59.287Z" title="更新于 2025-09-11 21:50:59">2025-09-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/k8s/">k8s</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/k8s/%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">配置管理</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="OPA-策略引擎"><a href="#OPA-策略引擎" class="headerlink" title="OPA 策略引擎"></a>OPA 策略引擎</h1><p><a target="_blank" rel="noopener" href="https://www.openpolicyagent.org/">Open Policy Agent</a> 简称 OPA，是一种开源的通用策略代理引擎，是 CNCF 毕业的项目。OPA 提供了一种高级声明式语言 Rego，简化了策略规则的定义，以减轻程序中策略的决策负担。在微服务、Kubernetes、CI&#x2F;CD、API 网关等场景中均可以使用 OPA 来定义策略。</p>
<p><img src="https://mudutestmenu.mudu.tv/upload/p98vq1.png" alt="集成OPA"></p>
<p>我们这里主要讲解在 Kubernetes 中如何集成 OPA，在 Kubernetes 中 OPA 是通过 Admission Controllers 来实现安全策略的。事实上使用 Pod 安全策略（要废弃了）来执行我们的安全策略并没有什么问题，然而，根据定义，PSP 只能应用于 pods。它们不能处理其他 Kubernetes 资源，如 Ingresses、Deployments、Services 等，OPA 的强大之处在于它可以应用于任何 Kubernetes 资源。OPA 作为一个准入控制器部署到 Kubernetes，它拦截发送到 APIServer 的 API 调用，并验证和&#x2F;或修改它们。你可以有一个统一的 OPA 策略，适用于系统的不同组件，而不仅仅是 pods，例如，有一种策略，强制用户在其服务中使用公司的域，并确保用户只从公司的镜像仓库中拉取镜像。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>OPA 将策略决策与策略执行分离，当应用需要做出策略决策时，它会查询 OPA 并提供结构化数据（例如 JSON）作为输入，OPA 接受任意结构化数据作为输入。</p>
<p><img src="https://mudutestmenu.mudu.tv/upload/0khzif.png" alt="OPA decouples"></p>
<p>OPA 通过评估查询输入策略和数据来生成策略决策，你可以在你的策略中描述几乎任何的不变因素，例如：</p>
<ul>
<li>哪些用户可以访问哪些资源</li>
<li>哪些子网的出口流量被允许</li>
<li>工作负载必须部署到哪些集群</li>
<li>二进制文件可以从哪里下载</li>
<li>容器可以用哪些操作系统的能力来执行</li>
<li>系统在一天中的哪些时间可以被访问</li>
</ul>
<p>策略决定不限于简单的<strong>是&#x2F;否或允许&#x2F;拒绝</strong>，与查询输入一样，你的策略可以生成任意结构化数据作为输出。 让我们看一个例子。OPA 的策略是用一种叫做 Rego 的高级声明性语言来声明的，Rego 是专门为表达复杂的分层数据结构的策略而设计的。</p>
<p>在 Kubernetes 中，准入控制器在创建、更新和删除操作期间对对象实施策略。准入控制是 Kubernetes 中策略执行的基础。通过将 OPA 部署为准入控制器，可以：</p>
<ul>
<li>要求在所有资源上使用特定标签</li>
<li>要求容器镜像来自企业镜像仓库</li>
<li>要求所有 Pod 指定资源请求和限制</li>
<li>防止创建冲突的 Ingress 对象</li>
<li>……</li>
</ul>
<p>Kubernetes APIServer 配置为在创建、更新或删除对象时查询 OPA 以获取准入控制策略。APIServer 将 webhook 请求中的整个对象发送给 OPA，OPA 使用准入审查作为输入来评估它已加载的策略。这个其实和我们自己去实现一个准入控制器是类似的，只是不需要我们去编写代码，只需要编写策略规则，OPA 就可以根据我们的规则去对输入的对象进行验证。</p>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>接下来我们介绍下如何在 Kubernetes 集群中集成 OPA，由于 Kubernetes 中是通过准入控制器来集成 OPA 的，所以我们必须在集群中启用 <code>ValidatingAdmissionWebhook</code> 这个准入控制器。</p>
<p><img src="https://mudutestmenu.mudu.tv/upload/zzls81.png" alt="Admission"></p>
<p>首先创建一个名为 <code>opa</code> 的命名空间，可以让 OPA 从该命名空间中的 ConfigMap 去加载策略：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl create namespace opa</span><br></pre></td></tr></table></figure>



<p>并将上下文更改为 opa 命名空间：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl config current-context</span><br><span class="line">kubernetes-admin@kubernetes</span><br><span class="line">➜ kubectl config set-context kubernetes-admin@kubernetes --namespace=opa</span><br><span class="line">Context &quot;kubernetes-admin@kubernetes&quot; modified.</span><br><span class="line">➜ kubectl get pods</span><br><span class="line">No resources found in opa namespace.</span><br></pre></td></tr></table></figure>



<p>为了保护 APIServer 和 OPA 之间的通信，我们需要配置 TLS 证书。</p>
<ol>
<li>创建证书颁发机构和密钥：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜ openssl genrsa -out ca.key 2048</span><br><span class="line">➜ openssl req -x509 -new -nodes -key ca.key -days 100000 -out ca.crt -subj &quot;/CN=admission_ca&quot;</span><br></pre></td></tr></table></figure>



<ol>
<li>为 OPA 生成密钥和证书：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;server.conf &lt;&lt;EOF</span><br><span class="line">[req]</span><br><span class="line">req_extensions = v3_req</span><br><span class="line">distinguished_name = req_distinguished_name</span><br><span class="line">[req_distinguished_name]</span><br><span class="line">[ v3_req ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth, serverAuth</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line">[ alt_names ]</span><br><span class="line">DNS.1 = opa.opa.svc</span><br><span class="line">EOF</span><br><span class="line">➜ openssl genrsa -out server.key 2048</span><br><span class="line">➜ openssl req -new -key server.key -out server.csr -subj &quot;/CN=opa.opa.svc&quot; -config server.conf</span><br><span class="line">➜ openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 100000 -extensions v3_req -extfile server.conf</span><br></pre></td></tr></table></figure>



<ol>
<li>创建一个 Kubernetes TLS Secret 来存储我们的 OPA 凭证：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl create secret tls opa-server --cert=server.crt --key=server.key</span><br></pre></td></tr></table></figure>



<p>证书准备好后就可以部署准入控制器了，对应的资源清单文件如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># opa-admission-controller.yaml</span></span><br><span class="line"><span class="comment"># Grant OPA/kube-mgmt read-only access to resources. This lets kube-mgmt</span></span><br><span class="line"><span class="comment"># replicate resources into OPA so they can be used in policies.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">opa-viewer</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">view</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">system:serviceaccounts:opa</span></span><br><span class="line">    <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Define role for OPA/kube-mgmt to update configmaps with policy status.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">opa</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">configmap-modifier</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&#x27;&#x27;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&#x27;configmaps&#x27;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;patch&#x27;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Grant OPA/kube-mgmt role defined above.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">opa</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">opa-configmap-modifier</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">configmap-modifier</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">system:serviceaccounts:opa</span></span><br><span class="line">    <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">opa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">opa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">opa</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">443</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">opa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">opa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">opa</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">opa</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">opa</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">openpolicyagent/opa:latest</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;run&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--server&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--tls-cert-file=/certs/tls.crt&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--tls-private-key-file=/certs/tls.key&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--addr=0.0.0.0:443&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--addr=http://127.0.0.1:8181&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--log-level=debug&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--log-format=json-pretty&#x27;</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/certs</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">opa-server</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">15</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-mgmt</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">openpolicyagent/kube-mgmt:4.0.0</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--replicate-cluster=v1/namespaces</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--replicate=networking.k8s.io/v1/ingresses</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--opa-url=http://127.0.0.1:8181/v1</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--enable-data=true</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--enable-policies=true</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--policies=opa</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--require-policy-label=true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">opa-server</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">opa-server</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">opa-default-system-main</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">opa</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">openpolicyagent.org/policy:</span> <span class="string">rego</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">main:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    package system</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="string">import</span> <span class="string">data.kubernetes.admission</span></span><br><span class="line"></span><br><span class="line">    <span class="string">main</span> <span class="string">=</span> &#123;</span><br><span class="line">      <span class="attr">&quot;apiVersion&quot;:</span> <span class="string">&quot;admission.k8s.io/v1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;kind&quot;:</span> <span class="string">&quot;AdmissionReview&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;response&quot;:</span> <span class="string">response</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">default</span> <span class="string">uid</span> <span class="string">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="string">uid</span> <span class="string">=</span> <span class="string">input.request.uid</span></span><br><span class="line">    <span class="string">response</span> <span class="string">=</span> &#123;</span><br><span class="line">        <span class="attr">&quot;allowed&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;uid&quot;:</span> <span class="string">uid</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;message&quot;:</span> <span class="string">reason</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125; &#123;</span><br><span class="line">        <span class="string">reason</span> <span class="string">=</span> <span class="string">concat(&quot;</span>, <span class="string">&quot;, admission.deny)</span></span><br><span class="line"><span class="string">        reason != &quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    else = &#123;&quot;</span><span class="string">allowed&quot;:</span> <span class="literal">true</span>, <span class="attr">&quot;uid&quot;:</span> <span class="string">uid</span>&#125;</span><br></pre></td></tr></table></figure>



<p>上面的资源清单中我们添加了一个 <code>kube-mgmt</code> 的 Sidecar 容器，该容器可以将 ConfigMap 对象中的策略动态加载到 OPA 中，<code>kube-mgmt</code> 容器还可以将任何其他 Kubernetes 对象作为 JSON 数据加载到 OPA 中。</p>
<p><img src="https://mudutestmenu.mudu.tv/upload/nobebs.png" alt="kube-mgmt"></p>
<p>另外需要注意的是 Service 的名称（opa）必须与我们证书配置的 CN 匹配，否则 TLS 通信会失败。在 <code>kube-mgmt</code> 容器中还指定了以下命令行参数：</p>
<ul>
<li>–replicate-cluster&#x3D;v1&#x2F;namespaces</li>
<li>–replicate&#x3D;networking.k8s.io&#x2F;v1&#x2F;ingresses</li>
<li>–enable-policies&#x3D;true</li>
<li>–policies&#x3D;opa</li>
<li>–require-policy-label&#x3D;true</li>
</ul>
<p>前两个参数允许 sidecar 容器复制命名空间、Ingress 对象，并将它们加载到 OPA 引擎中，<code>enable-policies=true</code> 表示会通过 Configmap 加载 OPA 策略，下面的 <code>--policies=opa</code> 表示从 <code>opa</code> 命名空间中的 Configmap 来加载策略，如果还配置了 <code>--require-policy-label=true</code> 参数，则需要 Configmap 中带有 <code>openpolicyagent.org/policy=rego</code> 这个标签才会被自动加载。</p>
<p>现在直接应用上面的资源清单即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl apply -f opa-admission-controller.yaml</span><br><span class="line">➜ kubectl get pods</span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">opa-6cd68f74f-s9zcv   2/2     Running   0          5m28s</span><br></pre></td></tr></table></figure>



<p>为了让准入控制器工作，我们还需要一个准入 webhook 来接收准入 HTTP 回调并执行它们，创建如下所示的 webhook 配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">➜ cat &gt; webhook-configuration.yaml &lt;&lt;EOF</span><br><span class="line">kind: ValidatingWebhookConfiguration</span><br><span class="line">apiVersion: admissionregistration.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: opa-validating-webhook</span><br><span class="line">webhooks:</span><br><span class="line">  - name: validating-webhook.openpolicyagent.org</span><br><span class="line">    admissionReviewVersions: [&quot;v1&quot;, &quot;v1beta1&quot;]</span><br><span class="line">    namespaceSelector:</span><br><span class="line">      matchExpressions:</span><br><span class="line">      - key: openpolicyagent.org/webhook</span><br><span class="line">        operator: NotIn</span><br><span class="line">        values:</span><br><span class="line">        - ignore</span><br><span class="line">    failurePolicy: Ignore</span><br><span class="line">    rules:</span><br><span class="line">      - apiGroups:</span><br><span class="line">        - &#x27;*&#x27;</span><br><span class="line">        apiVersions:</span><br><span class="line">        - &#x27;*&#x27;</span><br><span class="line">        operations:</span><br><span class="line">        - &#x27;*&#x27;</span><br><span class="line">        resources:</span><br><span class="line">        - &#x27;*&#x27;</span><br><span class="line">    sideEffects: None</span><br><span class="line">    clientConfig:</span><br><span class="line">      caBundle: $(cat ca.crt | base64 | tr -d &#x27;\n&#x27;)</span><br><span class="line">      service:</span><br><span class="line">        namespace: opa</span><br><span class="line">        name: opa</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<p>上面的 webhook 中配置了以下属性：</p>
<ul>
<li>不会监听来自带有 <code>openpolicyagent.org/webhook=ignore</code> 标签的命名空间的操作</li>
<li>会监听所有资源上的 CREATE 和 UPDATE 操作</li>
<li>它使用我们之前创建的 CA 证书，以便能够与 OPA 通信</li>
</ul>
<p>现在，在使用配置之前，我们标记 <code>kube-system</code> 和 <code>opa</code> 命名空间，使它们不在 webhook 范围内：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl label ns kube-system openpolicyagent.org/webhook=ignore</span><br><span class="line">➜ kubectl label ns opa openpolicyagent.org/webhook=ignore</span><br></pre></td></tr></table></figure>



<p>然后应用上面的配置对象将 OPA 注册为准入控制器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl apply -f webhook-configuration.yaml</span><br><span class="line">➜ kubectl get pods</span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">opa-6cd68f74f-s9zcv   2/2     Running   0          72m</span><br><span class="line">➜ kubectl get validatingwebhookconfiguration</span><br><span class="line">NAME                                      WEBHOOKS   AGE</span><br><span class="line">opa-validating-webhook                    1          2m14s</span><br></pre></td></tr></table></figure>



<h2 id="策略示例"><a href="#策略示例" class="headerlink" title="策略示例"></a>策略示例</h2><p>OPA 使用 Rego 语言来描述策略，这里我们使用官方文档中提到的示例来进行说明，创建一个限制 Ingress 可以使用的主机名策略，只允许匹配指定正则表达式的主机名。</p>
<p>创建如下所示名为 <code>ingress-allowlist.rego</code> 的策略文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 在这里，我们声明规则属于什么包，这与其他语言的包装类似，是将类似规则归入同一命名空间的一种方式。 --&gt;</span><br><span class="line">package kubernetes.admission</span><br><span class="line"></span><br><span class="line">import data.kubernetes.namespaces</span><br><span class="line"></span><br><span class="line">operations = &#123;&quot;CREATE&quot;, &quot;UPDATE&quot;&#125;</span><br><span class="line"></span><br><span class="line">deny[msg] &#123;</span><br><span class="line">    input.request.kind.kind == &quot;Ingress&quot;</span><br><span class="line">    operations[input.request.operation]</span><br><span class="line">    host := input.request.object.spec.rules[_].host</span><br><span class="line">    not fqdn_matches_any(host, valid_ingress_hosts)</span><br><span class="line">    msg := sprintf(&quot;invalid ingress host %q&quot;, [host])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">valid_ingress_hosts = &#123;host |</span><br><span class="line">    allowlist := namespaces[input.request.namespace].metadata.annotations[&quot;ingress-allowlist&quot;]</span><br><span class="line">    hosts := split(allowlist, &quot;,&quot;)</span><br><span class="line">    host := hosts[_]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fqdn_matches_any(str, patterns) &#123;</span><br><span class="line">    fqdn_matches(str, patterns[_])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fqdn_matches(str, pattern) &#123;</span><br><span class="line">    pattern_parts := split(pattern, &quot;.&quot;)</span><br><span class="line">    pattern_parts[0] == &quot;*&quot;</span><br><span class="line">    str_parts := split(str, &quot;.&quot;)</span><br><span class="line">    n_pattern_parts := count(pattern_parts)</span><br><span class="line">    n_str_parts := count(str_parts)</span><br><span class="line">    suffix := trim(pattern, &quot;*.&quot;)</span><br><span class="line">    endswith(str, suffix)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fqdn_matches(str, pattern) &#123;</span><br><span class="line">    not contains(pattern, &quot;*&quot;)</span><br><span class="line">    str == pattern</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>如果你是 Rego 新手，上面的代码看上去可能有点陌生，但 Rego 让定义策略变得非常容易，我们来分析下这个策略是如何使用白名单中的 Ingress 命名空间强制执行的：</p>
<ul>
<li><p>第 1 行：<code>package</code> 的使用方式与在其他语言中的使用方式是一样的</p>
</li>
<li><p>第 5 行：我们定义一个包含两项操作的数据集：<code>CREATE</code> 和 <code>UPDATE</code></p>
</li>
<li><p>第 7 行：这是策略的核心部分，以 <code>deny</code> 开头，然后是策略正文。如果正文中的语句组合评估为真，则违反策略，便会阻止操作，并将消息返回给用户，说明操作被阻止的原因</p>
</li>
<li><p>第 8 行：指定输入对象，发送到 OPA 的任何 JSON 消息都是从输入对象的根部开始的，我们遍历 JSON 对象，直到找到有问题的资源，并且它必须是 <code>Ingress</code> 才能应用该策略</p>
</li>
<li><p>第 9 行：我们需要应用策略来创建或更新资源，在 Rego 中，我们可以通过使用 <code>operations[input.requset.operations]</code> 来实现，方括号内的代码会提取请求中指定的操作，如果它与第 5 行的操作集中定义的元素相匹配，则该语句为真</p>
</li>
<li><p>第 10 行：为了提取 Ingress 对象的 host 信息，我们需要迭代 JSON 对象的 rules 数组，同样 Rego 提供了 <code>_</code> 字符来循环浏览数组，并将所有元素返回到 <code>host</code> 变量中</p>
</li>
<li><p>第 11 行：现在我们有了 host 变量，我们需要确保它不是列入白名单的主机，要记住，只有在评估为 true 时才会违反该策略，为了检查主机是否有效，我们使用第 21 行中定义的 <code>fqdn_matches_any</code> 函数</p>
</li>
<li><p>第 12 行：定义应返回给用户的消息，说明无法创建 Ingress 对象的原因</p>
</li>
<li><p>第 15-19 行：这部分从 Ingress 命名空间的 <code>annotations</code> 中提取列入白名单的主机名，主机名添加在逗号分隔的列表中，使用 <code>split</code> 内置函数用于将其转换为列表。最后，<code>_</code> 用于遍历所有提取的主机列表，将结果通过 <code>|</code> 管道传送给 <code>host</code> 变量（这与 Python 中的列表推导非常类似）</p>
</li>
<li><p>第 21 行：该函数只接受一个字符串，并在一个 patterns 列表中搜索它，这是第二个参数。实际上是调用的下方的 <code>fqdn_matches</code> 函数来实现的。在 Rego 中，<strong>可以定义具有多个相同名称的函数</strong>，只要它们都产生相同的输出，当调用多次定义的函数时，将调用该函数的所有实例</p>
</li>
<li><p>第 25-33 行：第一个</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fqdn_matches</span></span><br></pre></td></tr></table></figure>

<p>函数的定义。</p>
<ul>
<li>首先它通过点 <code>.</code> 将 pattern 进行拆分，比如 <code>*.example.com</code> 会分割成 <code>*</code>、<code>example</code> 和 <code>com</code></li>
<li>接下来确保 pattern 的第一个标记是星号，同样对输入的字符串按照 <code>.</code> 进行拆分</li>
<li>删除 pattern 中的 <code>*.</code></li>
<li>最后评估输入字符串是否以后缀结尾，比如如果允许的模式字符串是 <code>*.mydomain.com</code>，被评估的字符串是 <code>www.example.com</code>，则违反了该策略，因为该字符串不是 <code>mydomain.com</code> 的一部分</li>
</ul>
</li>
<li><p>第 35-38 行：第二个验证函数，该函数用于验证不使用通配符的模式，例如，当模式写为</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mycompany<span class="selector-class">.mydomain</span>.com</span><br></pre></td></tr></table></figure>

<p>的时候</p>
<ul>
<li>首先，需要确保提供的模式不包含通配符，否则，该语句将评估为 false 并且函数将不会继续</li>
<li>如果模式指的是特定的域名，那么我们只需要确保 fqdn 与该模式匹配。换句话说，如果模式是 <code>mycompany.mydomain.com</code>，那么主机的 fqdn 也必须是 <code>mycompany.mydomain.com</code></li>
</ul>
</li>
</ul>
<p>我们之所以有两个具有相同名称的函数，是因为 Rego 语言的一个限制，它会阻止函数产生一个以上的输出结果，所以，要想在同一时间用不同的逻辑进行多个验证，必须使用多个同名的函数。</p>
<p>在生产环境中，在将 Rego 代码应用到集群之前一定要进行全方位测试，比如可以添加单元测试，同时也可以使用 <a target="_blank" rel="noopener" href="https://play.openpolicyagent.org/">Rego Playground</a> 来对代码进行验证。</p>
<p>要将该策略应用于集群，我们需要将上面的 Rego 文件以 Configmap 的形式应用到 opa 命名空间中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl create configmap ingress-allowlist --from-file=ingress-allowlist.rego</span><br><span class="line">➜ kubectl label  configmap ingress-allowlist openpolicyagent.org/policy=rego</span><br></pre></td></tr></table></figure>



<p>由于我们开启了 <code>--require-policy-label</code> 参数，所以还需要带上对应的标签。创建完成后最好检查下我们的策略是否被 OPA 获取了，并且没有语法错误，可以通过检查 ConfigMap 的状态来判断：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get cm ingress-allowlist  -o json | jq &#x27;.metadata.annotations&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;openpolicyagent.org/policy-status&quot;: &quot;&#123;\&quot;status\&quot;:\&quot;ok\&quot;&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>接下来，让我们创建两个命名空间，一个用于 QA 环境，另一个用于生产环境。要注意它们都包含 <code>ingress-allowlist</code> 注解，其中包含 Ingress 主机名应该匹配的模式。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># qa-namespace.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">ingress-allowlist:</span> <span class="string">&#x27;*.qa.qikqiak.com,*.internal.qikqiak.com&#x27;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">qa</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># production-namespace.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">ingress-allowlist:</span> <span class="string">&#x27;*.qikqiak.com&#x27;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">production</span></span><br></pre></td></tr></table></figure>



<p>直接应用上面的两个资源清单文件即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl apply -f qa-namespace.yaml -f production-namespace.yaml</span><br></pre></td></tr></table></figure>



<p>接下来让我们创建一个被策略允许的 Ingress 对象：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl apply -f - &lt;&lt;EOT</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-ok</span><br><span class="line">  namespace: production</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  rules:</span><br><span class="line">  - host: prod.qikqiak.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">        path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">EOT</span><br></pre></td></tr></table></figure>



<p>正常上面的资源对象可以创建：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get ing -n production</span><br><span class="line">NAME         CLASS   HOSTS              ADDRESS   PORTS   AGE</span><br><span class="line">ingress-ok   nginx   prod.qikqiak.com             80      17s</span><br></pre></td></tr></table></figure>



<p>接着我们创建一个不符合策略的 Ingress 对象：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl apply -f - &lt;&lt;EOT</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-bad</span><br><span class="line">  namespace: qa</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  rules:</span><br><span class="line">  - host: opa.k8s.local</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">        path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">EOT</span><br><span class="line">Error from server: error when creating &quot;test.yaml&quot;: admission webhook &quot;validating-webhook.openpolicyagent.org&quot; denied the request: invalid ingress host &quot;opa.k8s.local&quot;</span><br></pre></td></tr></table></figure>



<p>从输出中可以看出，APIServer 拒绝创建 Ingress 对象，因为上面的对象违反了我们的 OPA 策略规则。</p>
<p>到这里我们就完成了理由 OPA 在 Kubernetes 集群中实施准入控制策略，而无需修改或重新编译任何 Kubernetes 组件。此外，还可以通过 OPA 的 Bundle 功能策略，可以定期从远程服务器下载以满足不断变化的操作要求。</p>
<h2 id="gatekeeper"><a href="#gatekeeper" class="headerlink" title="gatekeeper"></a>gatekeeper</h2><p>上面我们介绍了使用 <code>kube-mgmt</code> 这个 sidecar 容器来完成 OPA 策略的自动同步，此外还有另外一个更加高级的工具 <a target="_blank" rel="noopener" href="https://open-policy-agent.github.io/gatekeeper/website/docs/">Gatekeeper</a>，相比于之前的模式，<code>Gatekeeper(v3.0)</code> 准入控制器集成了 <code>OPA Constraint Framework</code>，以执行基于 CRD 的策略，并允许声明式配置的策略可靠地共享，使用 kubebuilder 构建，它提供了验证和修改准入控制和审计功能。这允许为 Rego 策略创建策略模板，将策略创建为 CRD，并在策略 CRD 上存储审计结果，这个项目是谷歌、微软、红帽和 Styra 一起合作实现的。</p>
<p><img src="https://mudutestmenu.mudu.tv/upload/wuyp4s.png" alt="gatekeeper"></p>
<p>直接使用下面的命令即可安装 <code>Gatekeeper</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.7/deploy/gatekeeper.yaml</span><br></pre></td></tr></table></figure>



<p>默认会将 <code>Gatekeeper</code> 安装到 <code>gatekeeper-system</code> 命名空间下面，同样会安装几个相关的 CRD：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get pods -n gatekeeper-system</span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">gatekeeper-audit-5cf4b9686-glndv                 1/1     Running   0          2m2s</span><br><span class="line">gatekeeper-controller-manager-77b7dc99fb-dvkvp   1/1     Running   0          2m2s</span><br><span class="line">gatekeeper-controller-manager-77b7dc99fb-gk4gr   1/1     Running   0          2m2s</span><br><span class="line">gatekeeper-controller-manager-77b7dc99fb-mt5wn   1/1     Running   0          2m2s</span><br><span class="line">➜ kubectl get crd |grep gate</span><br><span class="line">assign.mutations.gatekeeper.sh                       2022-03-27T06:47:24Z</span><br><span class="line">assignmetadata.mutations.gatekeeper.sh               2022-03-27T06:47:24Z</span><br><span class="line">configs.config.gatekeeper.sh                         2022-03-27T06:47:24Z</span><br><span class="line">constraintpodstatuses.status.gatekeeper.sh           2022-03-27T06:47:24Z</span><br><span class="line">constrainttemplatepodstatuses.status.gatekeeper.sh   2022-03-27T06:47:24Z</span><br><span class="line">constrainttemplates.templates.gatekeeper.sh          2022-03-27T06:47:24Z</span><br><span class="line">modifyset.mutations.gatekeeper.sh                    2022-03-27T06:47:24Z</span><br><span class="line">mutatorpodstatuses.status.gatekeeper.sh              2022-03-27T06:47:25Z</span><br><span class="line">providers.externaldata.gatekeeper.sh                 2022-03-27T06:47:25Z</span><br></pre></td></tr></table></figure>



<p><code>Gatekeeper</code> 使用 OPA 约束框架来描述和执行策略，在定义约束之前必须首先定义一个 <code>ConstraintTemplate</code> 对象，它描述了强制执行约束的 Rego 和约束的模式。约束的模式允许管理员对约束的行为进行微调，就像函数的参数一样。</p>
<p>如下所示是一个约束模板，描述了验证的对象必须要有标签存在：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k8srequiredlabels_template.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">templates.gatekeeper.sh/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConstraintTemplate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8srequiredlabels</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">crd:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">names:</span></span><br><span class="line">        <span class="attr">kind:</span> <span class="string">K8sRequiredLabels</span></span><br><span class="line">      <span class="attr">validation:</span></span><br><span class="line">        <span class="attr">openAPIV3Schema:</span> <span class="comment"># Schema for the `parameters` field</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">Describe</span> <span class="string">K8sRequiredLabels</span> <span class="string">crd</span> <span class="string">parameters</span></span><br><span class="line">          <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">labels:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">              <span class="attr">items:</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">description:</span> <span class="string">A</span> <span class="string">label</span> <span class="string">string</span></span><br><span class="line">  <span class="attr">targets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="string">admission.k8s.gatekeeper.sh</span></span><br><span class="line">      <span class="attr">rego:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        package k8srequiredlabels</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">        <span class="string">violation[&#123;&quot;msg&quot;:</span> <span class="string">msg,</span> <span class="attr">&quot;details&quot;:</span> &#123;<span class="attr">&quot;missing_labels&quot;:</span> <span class="string">missing</span>&#125;<span class="string">&#125;]</span> &#123;</span><br><span class="line">          <span class="string">provided</span> <span class="string">:=</span> &#123;<span class="string">label</span> <span class="string">|</span> <span class="string">input.review.object.metadata.labels</span>[<span class="string">label</span>]&#125;</span><br><span class="line">          <span class="string">required</span> <span class="string">:=</span> &#123;<span class="string">label</span> <span class="string">|</span> <span class="string">label</span> <span class="string">:=</span> <span class="string">input.parameters.labels</span>[<span class="string">_</span>]&#125;</span><br><span class="line">          <span class="string">missing</span> <span class="string">:=</span> <span class="string">required</span> <span class="bullet">-</span> <span class="string">provided</span></span><br><span class="line">          <span class="string">count(missing)</span> <span class="string">&gt;</span> <span class="number">0</span></span><br><span class="line">          <span class="string">msg</span> <span class="string">:=</span> <span class="string">sprintf(&quot;you</span> <span class="attr">must provide labels:</span> <span class="string">%v&quot;</span>, [<span class="string">missing</span>]<span class="string">)</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<p>直接应用上面的 <code>ConstraintTemplate</code> 资源清单：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl apply -f k8srequiredlabels_template.yaml</span><br><span class="line">constrainttemplate.templates.gatekeeper.sh/k8srequiredlabels created</span><br><span class="line">➜ kubectl get ConstraintTemplate</span><br><span class="line">NAME                AGE</span><br><span class="line">k8srequiredlabels   68s</span><br></pre></td></tr></table></figure>



<p>上面我们的定义的 <code>ConstraintTemplate</code> 对象就是一个模板，其中的 <code>crd</code> 部分描述了我们定义的 CRD 模板，比如类型叫 <code>K8sRequiredLabels</code>，需要和模板的名称保持一致，然后通过下面的 <code>validation</code> 定义了我们的 CRD 的属性 Schema，比如有一个 <code>labels</code> 的属性参数，类似是字符串数据类型：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">crd:</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">names:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">K8sRequiredLabels</span></span><br><span class="line">    <span class="attr">validation:</span></span><br><span class="line">      <span class="attr">openAPIV3Schema:</span> <span class="comment"># Schema for the `parameters` field</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Describe</span> <span class="string">K8sRequiredLabels</span> <span class="string">crd</span> <span class="string">parameters</span></span><br><span class="line">        <span class="attr">properties:</span></span><br><span class="line">          <span class="attr">labels:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">array</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">              <span class="attr">description:</span> <span class="string">A</span> <span class="string">label</span> <span class="string">string</span></span><br></pre></td></tr></table></figure>



<p>然后下面的 <code>targets</code> 部分就是定义的约束目标，使用 Rego 进行编写。</p>
<ul>
<li>首先通过 <code>provided := &#123;label | input.review.object.metadata.labels[label]&#125;</code> 获取到创建对象的所有 label 标签</li>
<li>然后通过 <code>required := &#123;label | label := input.parameters.labels[_]&#125;</code> 获取到需要提供的 label 标签</li>
<li>将上面两个标签集合相减（rego 语言支持该操作），得到未满足的 label</li>
<li>断言未满足的 label 数量&gt;0，如果大于 0，说明条件满足，violation 为 true，说明违反了约束，返回错误</li>
</ul>
<p>上面的约束模板创建完成后，实际上相当于创建了一个名为的 <code>K8sRequiredLabels</code> 对象，我们定义的属性位于 <code>spec.parameters</code> 属性下面：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get K8sRequiredLabels</span><br><span class="line">No resources found</span><br><span class="line">➜ kubectl explain K8sRequiredLabels.spec.parameters.labels</span><br><span class="line">KIND:     K8sRequiredLabels</span><br><span class="line">VERSION:  constraints.gatekeeper.sh/v1beta1</span><br><span class="line"></span><br><span class="line">FIELD:    labels &lt;[]string&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line"></span><br><span class="line">     A label string</span><br></pre></td></tr></table></figure>



<p>现在我们就可以使用上面的 <code>K8sRequiredLabels</code> 这个约束模板来定义策略了，比如我们要求在所有命名空间上都定义一个 <code>gatekeeper</code> 的标签，则可以创建如下所示的对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># all_ns_must_have_gatekeeper.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">constraints.gatekeeper.sh/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">K8sRequiredLabels</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ns-must-have-gk</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">match:</span></span><br><span class="line">    <span class="attr">kinds:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&#x27;&#x27;</span>]</span><br><span class="line">        <span class="attr">kinds:</span> [<span class="string">&#x27;Namespace&#x27;</span>] <span class="comment"># 表示这个约束会在创建命名空间的时候被应用，可以使用 namespaceSelector、namespaces等进行过滤</span></span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">labels:</span> [<span class="string">&#x27;gatekeeper&#x27;</span>] <span class="comment"># 根据schema规范定义</span></span><br></pre></td></tr></table></figure>



<p>注意 match 字段，它定义了将应用给定约束的对象的范围，其中 <code>kinds: [&quot;Namespace&quot;]</code> 表示这个约束会在创建命名空间的时候被应用，此外它还支持其他匹配器：</p>
<ul>
<li><code>kind</code> 接受带有 apiGroups 和 kind 字段的对象列表，这些字段列出了约束将应用到的对象的组&#x2F;种类。如果指定了多个组&#x2F;种类对象，则资源在范围内只需要一个匹配项。</li>
<li><code>scope</code> 接受 <em>、Cluster 或 Namespaced 决定是否选择集群范围和&#x2F;或命名空间范围的资源。（默认为</em>）</li>
<li><code>namespaces</code> 是命名空间名称的列表。如果已定义，则约束仅适用于列出的命名空间中的资源。命名空间还支持基于前缀的 glob。例如，namespaces: [kube-*] 匹配 kube-system 和 kube-public。</li>
<li><code>excludeNamespaces</code> 是命名空间名称的列表。如果已定义，则约束仅适用于不在列出的命名空间中的资源。ExcludedNamespaces 还支持基于前缀的 glob，例如，excludedNamespaces: [kube-*] 匹配 kube-system 和 kube-public。</li>
<li><code>labelSelector</code> 是标准的 Kubernetes 标签选择器。</li>
<li><code>namespaceSelector</code> 是针对对象的包含名称空间或对象本身的标签选择器，如果对象是名称空间。name 是对象的名称。如果已定义，则匹配具有指定名称的对象。Name 还支持基于前缀的 glob。例如，名称：pod-* 匹配 pod-a 和 pod-b。</li>
</ul>
<p>下面的 <code>parameters.labels</code> 就是根据上面的 CRD 规范定义的属性，该值是传递给 opa 的参数，此处表示一个 key 为 labels，value 为一个列表的字典，与 <code>ConstraintTemplate</code> 里的 <code>properties</code> 要匹配上，此处表示要创建的对象需要含有 <code>gatekeeper</code> 的 label。</p>
<p>直接应用上面的这个资源对象即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl apply -f all_ns_must_have_gatekeeper.yaml</span><br><span class="line">k8srequiredlabels.constraints.gatekeeper.sh/ns-must-have-gk created</span><br></pre></td></tr></table></figure>



<p>创建完成后可以查看到这个 <code>constraints</code> 对象：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get k8srequiredlabels</span><br><span class="line">NAME              AGE</span><br><span class="line">ns-must-have-gk   73s</span><br><span class="line">➜ kubectl get constraints  # 和上面对象一样</span><br><span class="line">NAME              AGE</span><br><span class="line">ns-must-have-gk   81s</span><br></pre></td></tr></table></figure>



<p>由于 <code>Gatekeeper</code> 具有审计功能，可以根据集群中执行的约束条件对资源进行定期评估，以检测预先存在的错误配置，<code>Gatekeeper</code> 将审计结果存储为相关约束条件的 <code>status</code> 字段中列出违规行为。我们可以查看 <code>K8sRequiredLabels</code> 对象的 <code>status</code> 字段来查看不符合约束的行为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get constraints ns-must-have-gk -o yaml</span><br><span class="line">apiVersion: constraints.gatekeeper.sh/v1beta1</span><br><span class="line">kind: K8sRequiredLabels</span><br><span class="line">......</span><br><span class="line">status:</span><br><span class="line">  auditTimestamp: &quot;2022-03-27T07:42:38Z&quot;</span><br><span class="line">  ......</span><br><span class="line">  totalViolations: 11</span><br><span class="line">  violations:</span><br><span class="line">  - enforcementAction: deny</span><br><span class="line">    kind: Namespace</span><br><span class="line">    message: &#x27;you must provide labels: &#123;&quot;gatekeeper&quot;&#125;&#x27;</span><br><span class="line">    name: apisix</span><br><span class="line">  - enforcementAction: deny</span><br><span class="line">    kind: Namespace</span><br><span class="line">    message: &#x27;you must provide labels: &#123;&quot;gatekeeper&quot;&#125;&#x27;</span><br><span class="line">    name: default</span><br><span class="line">  ......</span><br></pre></td></tr></table></figure>



<p>比如现在我们创建一个如下所示的 Namespace：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test-namespace.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ns-test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">a:</span> <span class="string">b</span></span><br><span class="line">    <span class="comment">#gatekeeper: abc</span></span><br></pre></td></tr></table></figure>



<p>此时不给命名空间添加 key 为 <code>gatekeeper</code> 的 label，创建的时候就会报错：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error from server ([ns-must-have-gk] you must provide labels: &#123;&quot;gatekeeper&quot;&#125;): error when creating &quot;test-namespace.yaml&quot;: admission webhook &quot;validation.gatekeeper.sh&quot; denied the request: [ns-must-have-gk] you must provide labels: &#123;&quot;gatekeeper&quot;&#125;</span><br></pre></td></tr></table></figure>



<p>然后把 <code>gatekeeper: abc</code> 这行的注释打开，则能成功创建了，这就是 <code>Gatekeeper</code> 的基本用法。</p>
<p>从上面我们可以知道定义约束模板的策略会经常从 <code>input</code> 对象中获取数据，但是如果需要创建自己的约束，但是不知道传入的参数即 <code>input</code> 是什么，有一种简单方法是使用拒绝所有请求并将请求对象作为其拒绝消息输出的约束&#x2F;模板。我们可以在创建模板时在 <code>violation</code> 中只保留一行 <code>msg := sprintf(&quot;input: %v&quot;, [input])</code>，此时创建对象时必定会失败，然后获取到输出的错误信息，里面即包含所有 <code>input</code> 信息，之后再通过 Rego 语法去获取需要的数据即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: templates.gatekeeper.sh/v1</span><br><span class="line">kind: ConstraintTemplate</span><br><span class="line">metadata:</span><br><span class="line">  name: k8sdenyall</span><br><span class="line">spec:</span><br><span class="line">  crd:</span><br><span class="line">    spec:</span><br><span class="line">      names:</span><br><span class="line">        kind: K8sDenyAll</span><br><span class="line">  targets:</span><br><span class="line">    - target: admission.k8s.gatekeeper.sh</span><br><span class="line">      rego: |</span><br><span class="line">        package k8sdenyall</span><br><span class="line"></span><br><span class="line">        violation[&#123;&quot;msg&quot;: msg&#125;] &#123;</span><br><span class="line">          msg := sprintf(&quot;input:  %v&quot;, [input])</span><br><span class="line">        &#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: constraints.gatekeeper.sh/v1beta1</span><br><span class="line">kind: K8sDenyAll</span><br><span class="line">metadata:</span><br><span class="line">  name: deny-all-namespaces</span><br><span class="line">spec:</span><br><span class="line">  match:</span><br><span class="line">    kinds:</span><br><span class="line">      - apiGroups: [&quot;&quot;]</span><br><span class="line">        kinds: [&quot;Namespace&quot;]</span><br></pre></td></tr></table></figure>



<p>由于约束模板或者说策略库具有一定的通用性，所以 <code>OPA Gatekeeper</code> 社区提供了一个通用的策略库：<a target="_blank" rel="noopener" href="https://github.com/open-policy-agent/gatekeeper-library%EF%BC%8C%E8%AF%A5%E4%BB%93%E5%BA%93%E4%B8%AD%E5%8C%85%E5%90%AB%E4%BA%86%E5%A4%A7%E9%87%8F%E9%80%9A%E7%94%A8%E7%9A%84%E7%BA%A6%E6%9D%9F%E6%A8%A1%E6%9D%BF%E3%80%82">https://github.com/open-policy-agent/gatekeeper-library，该仓库中包含了大量通用的约束模板。</a></p>
<p><img src="https://mudutestmenu.mudu.tv/upload/1jmruk.png" alt="gatekeeper-library"></p>
<p>每个模板库下面都包含一个 <code>template.yaml</code> 文件用来描述约束模板，<code>samples</code> 目录下面就包含具体的约束对象和示例资源清单，这些策略也是我们去学习 Rego 语言的很好的案例。</p>
<h2 id="Rego"><a href="#Rego" class="headerlink" title="Rego"></a>Rego</h2><p>上面的示例为我们详细介绍了如何使用 OPA 来配置我们的策略规则，其中最核心的就是使用 Rego 编写的策略规则，Rego 是专门为表达复杂的分层数据结构的策略而设计的，所以要掌握 OPA 的使用对 Rego 的了解是必不可少的。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://huiaz.github.io">六一</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://huiaz.github.io/2025/09/11/OPA/">https://huiaz.github.io/2025/09/11/OPA/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://huiaz.github.io" target="_blank">Hui's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%BF%90%E7%BB%B4/">运维</a><a class="post-meta__tags" href="/tags/k8s/">k8s</a></div><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/09/11/POD%20Pending/" title="POD Pending"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">POD Pending</div></div><div class="info-2"><div class="info-item-1">彻底搞懂 K8S Pod Pending 故障原因及解决方案即使在高成熟度级别 Kubernetes 集群中 pod pending 也是无处不在。 如果您随机询问任何使用 Kubernetes DevOps 工程师来确定折磨他们噩梦的最常见错误，pod pending 可能是非常常见的问题（可能仅次于 CrashLoopBackOff）。 尝试推送更新并看到它卡住会使 DevOps 紧张。即使解决方案相当简单，找到 pod 挂起的原因并了解您需要应用的更改也很重要（Kubernetes 故障排除很少是微不足道的）。  在本文中，我们将阐明导致此问题的不同情况，让 DevOps 团队能够快速找到解决方案，最重要的是，尽可能避免它。 Kubernetes Pod pending 是什么意思？Kubernetes 中的 Pod 的生命周期由几个不同的阶段组成：  创建 pod 时，它从Pending阶段开始。 一旦 pod 被调度并且容器已经启动，pod 就会进入Running阶段。  大多数 pod 只需要几秒钟就可以从 Pending 到 Running 并在该状态下度过大部分时...</div></div></div></a><a class="pagination-related" href="/2025/09/11/Nginx/" title="Nginx"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Nginx</div></div><div class="info-2"><div class="info-item-1">你好！作为一名运维工程师，我来为你详细解释一下 Nginx。 Nginx 是什么？Nginx是一个高性能的、免费开源的 Web 服务器 和 反向代理服务器，也可以用作 负载均衡器 和 HTTP 缓存。 Nginx 采用了事件驱动（event-driven）的异步非阻塞架构。这种架构使得 Nginx 在处理大量并发连接时，能够以极低的内存消耗和 CPU 占用率提供卓越的性能。 主要特点：  高性能和高并发： Nginx 的核心优势在于其事件驱动架构，能够以极低的资源消耗处理大量并发连接。 低内存消耗： 即使在处理数万个并发请求时，Nginx 也只需要极少的内存。 高可靠性： 即使在面对高负载时也能保持稳定运行。 模块化设计： 易于扩展和维护。 支持多种协议： 不仅支持 HTTP，还支持 HTTPS、SMTP、POP3、IMAP 等。 反向代理能力： 可以将客户端请求转发到后端服务器，提高安全性、性能和可扩展性。 负载均衡： 可以将流量分配到多个后端服务器，提高系统可用性和吞吐量。 HTTP 缓存： 可以缓存静态或动态内容，减少后端服务器的压力并加速响应。  Nginx 有哪些应用场...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/09/11/%E6%96%B0%E4%B8%80%E4%BB%A3%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F%20CubeFS/" title="新一代云原生存储系统 CubeFS"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-11</div><div class="info-item-2">新一代云原生存储系统 CubeFS</div></div><div class="info-2"><div class="info-item-1">新一代云原生存储系统 CubeFSCubeFS是一种新一代云原生存储系统，支持 S3、HDFS 和 POSIX 等访问协议，支持多副本与纠删码两种存储引擎，为用户提供多租户、 多 AZ 部署以及跨区域复制等多种特性。  CubeFS 作为一个云原生的分布式存储平台，提供了多种访问协议，因此其应用场景也非常广泛，下面简单介绍几种比较典型的应用场景  大数据分析：兼容 HDFS 协议，为 Hadoop 生态（如 Spark、Hive）提供统一存储底座，为计算引擎提供无限的存储空间以及大带宽的数据存储能力。 深度训练&#x2F;机器学习：作为分布式并行文件系统，支撑 AI 训练、模型存储及分发、IO 加速等需求。 容器共享存储：容器集群可以将容器镜像的配置文件或初始化加载数据存储在 CubeFS 上，在容器批量加载时实时读取。多 Pod 间通过 CubeFS 共享持久化数据，在 Pod 故障时可以进行快速故障切换。 数据库&amp;中间件：为数据库应用如 MySQL、ElasticSearch、ClickHouse 提供高并发、低时延云盘服务，实现彻底的存算分离。 在线服务：为在线业务...</div></div></div></a><a class="pagination-related" href="/2025/09/11/%E5%9C%A8%20Kubernetes%20%E4%B8%8A%E9%83%A8%E7%BD%B2%20LLM%20%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/" title="在 Kubernetes 上部署 LLM 大语言模型"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-11</div><div class="info-item-2">在 Kubernetes 上部署 LLM 大语言模型</div></div><div class="info-2"><div class="info-item-1">在 Kubernetes 上部署 LLM 大语言模型从今年开始，人们对大型语言模型 (LLM) 及其在 GPU 基础设施上的部署的兴趣显着增加。这种不断增长的热情是由人工智能和机器学习的进步推动的，这需要 GPU 能够有效提供大量的计算能力。GPU 领先制造商 Nvidia 的股价也因这一趋势而飙升。同样诞生了大量的大模型，对于这些模型的部署和管理也变得越来越重要，在这方面 Ollama 和 OpenUI 是一个不错的选择。 Ollama 是一个开源的机器学习模型部署工具，它可以帮助您将模型部署到生产环境中，简化大型语言模型 (LLM) 的管理和交互。Ollama 拥有各种一流的开源模型，例如 Llama 3、Phi 3、Mistral 等等，我们可以将 Ollama 看成是 Docker，但是专注于机器学习模型。  使用 Ollama 部署模型非常简单，就类似于使用 Docker 部署应用程序一样。但是，如果你对 CLI 不熟悉，那么使用 Ollama 会有点痛苦。为了解决这个问题，我们可以使用一个 open-webui 的项目，它提供了一个漂亮的界面，可以让您更轻松地部署模型...</div></div></div></a><a class="pagination-related" href="/2025/09/11/Kubernetes%20%E7%AE%80%E4%BB%8B/" title="Kubernetes 简介"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-11</div><div class="info-item-2">Kubernetes 简介</div></div><div class="info-2"><div class="info-item-1">Kubernetes 简介Kubernetes（简称 K8S） 的出现是容器化技术发展的必然结果，容器化是应用程序级别的虚拟化，运行单个内核上有多个独立的用户空间实例，这些实例就是容器；容器提供了将应用程序的代码、运行时、系统工具、系统库和配置打包到一个实例中的标准方法，而且容器是共享一个内核的；由于容器技术的兴起，导致大量的容器应用出现，所以就出现了一些用来支持应用程序容器化部署和组织的容器编排技术，一些流行的开源容器编排工具有 Docker Swarm、Kubernetes 等，但是在发展过程中 Kubernetes 现在已经成为了容器编排领域事实上的一个标准了。  Kubernetes 是 Google 团队发起的一个开源项目，它的目标是管理跨多个主机的容器，用于自动部署、扩展和管理容器化的应用程序，主要实现语言为 Go 语言，他的理论基础来源与 Google 内部的 Borg 项目，所以 Kubernetes 项目的理论基础就比其他开源项目要“先进”很多，因为 Borg 系统一直依赖就被称为 Google 公司内部最强大的“私密武器”。 架构Kubernetes 项目依托...</div></div></div></a><a class="pagination-related" href="/2025/09/11/DaemonSet/" title="DaemonSet"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-11</div><div class="info-item-2">DaemonSet</div></div><div class="info-2"><div class="info-item-1">DaemonSet 控制器通过该控制器的名称我们可以看出它的用法：Daemon，就是用来部署守护进程的，DaemonSet用于在每个 Kubernetes 节点中将守护进程的副本作为后台进程运行，说白了就是在每个节点部署一个 Pod 副本，当节点加入到 Kubernetes 集群中，Pod 会被调度到该节点上运行，当节点从集群只能够被移除后，该节点上的这个 Pod 也会被移除，当然，如果我们删除 DaemonSet，所有和这个对象相关的 Pods 都会被删除。那么在哪种情况下我们会需要用到这种业务场景呢？其实这种场景还是比较普通的，比如：  集群存储守护程序，如 glusterd、ceph 要部署在每个节点上以提供持久性存储； 节点监控守护进程，如 Prometheus 监控集群，可以在每个节点上运行一个 node-exporter 进程来收集监控节点的信息； 日志收集守护程序，如 fluentd 或 logstash，在每个节点上运行以收集容器的日志 节点网络插件，比如 flannel、calico，在每个节点上运行为 Pod 提供网络服务。  这里需要特别说明的一个就是关于 ...</div></div></div></a><a class="pagination-related" href="/2025/09/11/Containerd/" title="Containerd"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-11</div><div class="info-item-2">Containerd</div></div><div class="info-2"><div class="info-item-1">Containerd 使用我们知道很早之前的 Docker Engine 中就有了 containerd，只不过现在是将 containerd 从 Docker Engine 里分离出来，作为一个独立的开源项目，目标是提供一个更加开放、稳定的容器运行基础设施。分离出来的 containerd 将具有更多的功能，涵盖整个容器运行时管理的所有需求，提供更强大的支持。 containerd 是一个工业级标准的容器运行时，它强调简单性、健壮性和可移植性，containerd 可以负责干下面这些事情：  管理容器的生命周期（从创建容器到销毁容器） 拉取&#x2F;推送容器镜像 存储管理（管理镜像及容器数据的存储） 调用 runc 运行容器（与 runc 等容器运行时交互） 管理容器网络接口及网络  架构containerd 可用作 Linux 和 Windows 的守护程序，它管理其主机系统完整的容器生命周期，从镜像传输和存储到容器执行和监测，再到底层存储到网络附件等等。  上图是 containerd 官方提供的架构图，可以看出 containerd 采用的也是 C&#x2F;S 架构，...</div></div></div></a><a class="pagination-related" href="/2025/09/11/YAML%20%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6/" title="K8S YAML 资源清单文件"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-11</div><div class="info-item-2">K8S YAML 资源清单文件</div></div><div class="info-2"><div class="info-item-1">K8S YAML 资源清单文件前面我们得 Kubernetes 集群已经搭建成功了，现在我们就可以在集群里面来跑我们的应用了。要在集群里面运行我们自己的应用，首先我们需要知道几个概念。 第一个当然就是应用的镜像，因为我们在集群中运行的是容器，所以首先需要将我们的应用打包成镜像。镜像准备好了，Kubernetes 集群也准备好了，其实我们就可以把我们的应用部署到集群中了。但是镜像到集群中运行这个过程如何完成呢？必然有一个地方可以来描述我们的应用，然后把这份描述告诉集群，然后集群按照这个描述来部署应用。 在之前 Docker 环境下面我们是直接通过命令 docker run 来运行我们的应用的，在 Kubernetes 环境下面我们同样也可以用类似 kubectl run 这样的命令来运行我们的应用，但是在 Kubernetes 中却是不推荐使用命令行的方式，而是希望使用我们称为资源清单的东西来描述应用，资源清单可以用 YAML 或者 JSON 文件来编写，一般来说 YAML 文件更方便阅读和理解，所以我们的课程中都会使用 YAML 文件来进行描述。 通过一个资源清单文件来定义好一个...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">六一</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">274</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">45</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/huiaz"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#OPA-%E7%AD%96%E7%95%A5%E5%BC%95%E6%93%8E"><span class="toc-number">1.</span> <span class="toc-text">OPA 策略引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.</span> <span class="toc-text">部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.</span> <span class="toc-text">策略示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gatekeeper"><span class="toc-number">1.4.</span> <span class="toc-text">gatekeeper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rego"><span class="toc-number">1.5.</span> <span class="toc-text">Rego</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/27/hexo-beautify/" title="Hexo 博客美化笔记：从零搭建高颜值技术博客">Hexo 博客美化笔记：从零搭建高颜值技术博客</a><time datetime="2026-02-27T04:00:00.000Z" title="发表于 2026-02-27 12:00:00">2026-02-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/11/Jenkens-Blue%20Ocean%20%E6%8F%92%E4%BB%B6/" title="Jenkins Blue Ocean">Jenkins Blue Ocean</a><time datetime="2025-09-11T12:42:57.000Z" title="发表于 2025-09-11 20:42:57">2025-09-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/11/jenkins-jenkinsfile/" title="Jenkins Jenkinsfile">Jenkins Jenkinsfile</a><time datetime="2025-09-11T12:40:44.000Z" title="发表于 2025-09-11 20:40:44">2025-09-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/11/shell-trap/" title="Linux-trap">Linux-trap</a><time datetime="2025-09-11T12:40:44.000Z" title="发表于 2025-09-11 20:40:44">2025-09-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/11/shell-%E6%95%B0%E7%BB%84/" title="Shell-数组">Shell-数组</a><time datetime="2025-09-11T12:40:44.000Z" title="发表于 2025-09-11 20:40:44">2025-09-11</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By 六一</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.4</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true}});</script></body></html>