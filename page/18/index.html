<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hui&#39;s Blog">
<meta property="og:url" content="http://example.com/page/18/index.html">
<meta property="og:site_name" content="Hui&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="å…­ä¸€">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/18/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hui's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hui's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Code Life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/interface/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="å…­ä¸€">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/interface/" class="post-title-link" itemprop="url">Go interface</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-11 20:32:34 / ä¿®æ”¹æ—¶é—´ï¼š21:40:58" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>2.8k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>3 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Goè¯­è¨€çš„æ¥å£æ˜¯ä¸€ç§éå¸¸å¼ºå¤§ä¸”çµæ´»çš„ç±»å‹ç³»ç»Ÿç‰¹æ€§ï¼Œå®ƒé€šè¿‡<strong>éä¾µå…¥å¼</strong>çš„é¸­å­ç±»å‹ï¼ˆDuck Typingï¼‰å®ç°äº†å¤šæ€ã€‚åœ¨è¿è¡Œæ—¶ï¼ŒGoè¯­è¨€çš„æ¥å£å˜é‡å®é™…ä¸Šæ˜¯ä¸€ä¸ªå†…éƒ¨çš„æ•°æ®ç»“æ„ï¼Œå®ƒå­˜å‚¨äº†å…³äºâ€œç±»å‹â€å’Œâ€œå€¼â€çš„ä¿¡æ¯ã€‚</p>
<h3 id="æ¥å£çš„åº•å±‚æ•°æ®ç»“æ„"><a href="#æ¥å£çš„åº•å±‚æ•°æ®ç»“æ„" class="headerlink" title="æ¥å£çš„åº•å±‚æ•°æ®ç»“æ„"></a>æ¥å£çš„åº•å±‚æ•°æ®ç»“æ„</h3><p>Goè¯­è¨€çš„æ¥å£åœ¨è¿è¡Œæ—¶æœ‰ä¸¤ç§åŸºæœ¬å½¢å¼ï¼Œä½†å®ƒä»¬çš„åº•å±‚ç»“æ„æ˜¯ç›¸ä¼¼ä¸”ç²¾ç®€çš„ï¼š</p>
<ol>
<li><strong>ç©ºæ¥å£ (<code>interface&#123;&#125;</code>) &#x2F; <code>eface</code> (empty interface)</strong></li>
<li><strong>éç©ºæ¥å£ (<code>interface S</code>) &#x2F; <code>iface</code> (interface with methods)</strong></li>
</ol>
<p>è¿™ä¸¤ç§æ¥å£åœ¨å†…å­˜ä¸­éƒ½ç”±ä¸¤ä¸ªå•è¯ï¼ˆé€šå¸¸æ˜¯ä¸¤ä¸ªæŒ‡é’ˆå¤§å°çš„å†…å­˜å•å…ƒï¼‰ç»„æˆã€‚åœ¨Goçš„æºç ä¸­ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”<code>runtime.eface</code>å’Œ<code>runtime.iface</code>ç»“æ„ä½“ã€‚</p>
<h4 id="1-ç©ºæ¥å£-eface-çš„å®ç°"><a href="#1-ç©ºæ¥å£-eface-çš„å®ç°" class="headerlink" title="1. ç©ºæ¥å£ (eface) çš„å®ç°"></a>1. ç©ºæ¥å£ (<code>eface</code>) çš„å®ç°</h4><p><code>interface&#123;&#125;</code> æ˜¯æœ€ç®€å•çš„æ¥å£ï¼Œå®ƒå¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„å€¼ï¼Œå› ä¸ºå®ƒä¸è¦æ±‚è¢«å­˜å‚¨çš„å€¼å®ç°ä»»ä½•æ–¹æ³•ã€‚</p>
<p><code>runtime.eface</code> ç»“æ„ä½“ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> eface <span class="keyword">struct</span> &#123;</span><br><span class="line">    _type *_type <span class="comment">// æŒ‡å‘å€¼çš„ç±»å‹ä¿¡æ¯</span></span><br><span class="line">    data  unsafe.Pointer <span class="comment">// æŒ‡å‘å®é™…å€¼çš„æŒ‡é’ˆ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_type</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>runtime._type</code> ç»“æ„ä½“çš„æŒ‡é’ˆã€‚<code>_type</code> åŒ…å«äº†å…³äºå€¼æœ¬èº«çš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚ç±»å‹åç§°ã€å¤§å°ã€å¯¹é½æ–¹å¼ä»¥åŠå…¶æ–¹æ³•é›†ï¼ˆå³ä½¿æ˜¯ç©ºæ¥å£ï¼Œå®ƒå®é™…å­˜å‚¨çš„å€¼ä¹Ÿæœ‰è‡ªèº«çš„æ–¹æ³•é›†ï¼Œæ¯”å¦‚ <code>int</code> ç±»å‹å°±æ²¡æœ‰æ–¹æ³•ï¼Œ<code>string</code> æœ‰ <code>Len()</code> ç­‰ï¼‰ã€‚</li>
<li><code>data</code>: è¿™æ˜¯ä¸€ä¸ª <code>unsafe.Pointer</code>ï¼Œå®ƒæŒ‡å‘æ¥å£ä¸­å®é™…å­˜å‚¨çš„æ•°æ®ã€‚</li>
</ul>
<p><strong><code>eface</code> çš„å·¥ä½œåŸç†ï¼š</strong></p>
<p>å½“ä¸€ä¸ªå€¼è¢«èµ‹ç»™ä¸€ä¸ªç©ºæ¥å£æ—¶ï¼š</p>
<ul>
<li>Goè¿è¡Œæ—¶ä¼šè·å–è¯¥å€¼çš„<strong>ç±»å‹ä¿¡æ¯</strong>ï¼ˆ<code>_type</code>ï¼‰ï¼Œå¹¶å­˜å‚¨åœ¨ <code>_type</code> å­—æ®µä¸­ã€‚</li>
<li>å¦‚æœè¯¥å€¼æ˜¯<strong>éæŒ‡é’ˆç±»å‹</strong>ï¼ˆå¦‚ <code>int</code>, <code>string</code>, <code>struct</code> ç­‰ï¼‰ï¼Œå¹¶ä¸”å®ƒçš„å¤§å°<strong>è¶…è¿‡ä¸€ä¸ªå­—å¤§å°</strong>ï¼ˆé€šå¸¸æ˜¯8å­—èŠ‚ï¼Œå–å†³äºæ¶æ„ï¼Œæˆ–ä¸é€‚åˆç›´æ¥åµŒå…¥ï¼‰ï¼ŒGoä¼šåˆ›å»ºè¯¥å€¼çš„ä¸€ä¸ª<strong>å‰¯æœ¬ï¼ˆæ‹·è´ï¼‰</strong>ï¼Œå¹¶æŠŠè¿™ä¸ªå‰¯æœ¬å­˜å‚¨åœ¨å †ä¸Šã€‚<code>data</code> å­—æ®µä¼šæŒ‡å‘è¿™ä¸ªå †ä¸Šçš„å‰¯æœ¬ã€‚</li>
<li>å¦‚æœè¯¥å€¼æ˜¯<strong>æŒ‡é’ˆç±»å‹</strong>ï¼ˆå¦‚ <code>*MyStruct</code>ï¼‰æˆ–è€…<strong>å¾ˆå°çš„å€¼</strong>ï¼ˆå¦‚ <code>int</code>, <code>bool</code>ï¼‰ï¼Œé‚£ä¹ˆ <code>data</code> å­—æ®µå¯èƒ½ç›´æ¥å­˜å‚¨è¿™ä¸ªå€¼æœ¬èº«ï¼ˆå¯¹äºå°å€¼ï¼‰æˆ–è€…ç›´æ¥å­˜å‚¨è¿™ä¸ªæŒ‡é’ˆã€‚å¯¹äºæŒ‡é’ˆï¼Œ<code>data</code> å­—æ®µä¼šæŒ‡å‘è¿™ä¸ªæŒ‡é’ˆæ‰€å¼•ç”¨çš„æ•°æ®ã€‚</li>
<li><strong>æ³¨æ„ï¼š</strong> ç©ºæ¥å£åœ¨å†…éƒ¨å§‹ç»ˆå­˜å‚¨çš„æ˜¯å€¼çš„<strong>ä¸€ä¸ªå‰¯æœ¬æˆ–å‰¯æœ¬çš„æŒ‡é’ˆ</strong>ã€‚åŸå§‹å˜é‡å’Œæ¥å£å†…çš„å˜é‡æ˜¯ç‹¬ç«‹çš„ã€‚</li>
</ul>
<h4 id="2-éç©ºæ¥å£-iface-çš„å®ç°"><a href="#2-éç©ºæ¥å£-iface-çš„å®ç°" class="headerlink" title="2. éç©ºæ¥å£ (iface) çš„å®ç°"></a>2. éç©ºæ¥å£ (<code>iface</code>) çš„å®ç°</h4><p>éç©ºæ¥å£ï¼Œæˆ–è€…è¯´å¸¦æœ‰æ–¹æ³•é›†çš„æ¥å£ï¼ˆå¦‚ <code>io.Reader</code>, <code>fmt.Stringer</code>ï¼‰ï¼Œå…¶åº•å±‚ç»“æ„ç¨å¾®å¤æ‚ä¸€äº›ï¼Œå› ä¸ºå®ƒè¿˜éœ€è¦è®°å½•æ¥å£æ‰€è¦æ±‚çš„å…·ä½“æ–¹æ³•ã€‚</p>
<p><code>runtime.iface</code> ç»“æ„ä½“ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> iface <span class="keyword">struct</span> &#123;</span><br><span class="line">    tab  *itab <span class="comment">// æŒ‡å‘æ¥å£è¡¨æ ¼çš„æŒ‡é’ˆ</span></span><br><span class="line">    data unsafe.Pointer <span class="comment">// æŒ‡å‘å®é™…å€¼çš„æŒ‡é’ˆ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>data</code>: ä¸ç©ºæ¥å£ç±»ä¼¼ï¼Œå®ƒæŒ‡å‘å®é™…å­˜å‚¨çš„å€¼ã€‚åŒæ ·ï¼Œå¯¹äºéæŒ‡é’ˆç±»å‹ï¼Œé€šå¸¸ä¼šæœ‰ä¸€ä¸ªå€¼æ‹·è´ã€‚</li>
<li><code>tab</code>: è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>runtime.itab</code> ç»“æ„ä½“çš„æŒ‡é’ˆã€‚<code>itab</code> æ˜¯ interface table çš„ç¼©å†™ï¼Œå®ƒæ˜¯ Go è¿è¡Œæ—¶åœ¨ç¼–è¯‘æ—¶æˆ–è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆçš„ä¸€ä¸ªè¡¨æ ¼ï¼Œå®ƒè¿æ¥äº†<strong>æ¥å£ç±»å‹</strong>å’Œ<strong>å®é™…ç±»å‹</strong>ã€‚</li>
</ul>
<p><code>runtime.itab</code> ç»“æ„ä½“ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> itab <span class="keyword">struct</span> &#123;</span><br><span class="line">    inter *IType <span class="comment">// æ¥å£çš„ç±»å‹ä¿¡æ¯ (å¦‚ Reader æ¥å£)</span></span><br><span class="line">    _type *_type <span class="comment">// å®ç°è¯¥æ¥å£çš„ç±»å‹ä¿¡æ¯ (å¦‚ MyStruct)</span></span><br><span class="line">    hash  <span class="type">uint32</span> <span class="comment">// ç”¨äºå¿«é€ŸæŸ¥æ‰¾çš„å“ˆå¸Œå€¼</span></span><br><span class="line">    _     [<span class="number">4</span>]<span class="type">byte</span> <span class="comment">// padding</span></span><br><span class="line">    fun   [<span class="number">1</span>]<span class="type">uintptr</span> <span class="comment">// åŠ¨æ€æ•°ç»„ï¼Œå­˜å‚¨å®é™…ç±»å‹å®ç°æ¥å£æ–¹æ³•çš„å‡½æ•°æŒ‡é’ˆåˆ—è¡¨</span></span><br><span class="line">    <span class="comment">// fun æ•°ç»„çš„å®é™…å¤§å°æ˜¯ç”±æ¥å£å®šä¹‰çš„æ–¹æ³•æ•°é‡å†³å®šçš„</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>itab</code> æ˜¯éç©ºæ¥å£çš„æ ¸å¿ƒã€‚å®ƒè®°å½•äº†ï¼š</p>
<ul>
<li><code>inter</code>: æ¥å£æœ¬èº«çš„ç±»å‹ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ª <code>io.Reader</code> æ¥å£å˜é‡ï¼Œè¿™ä¸ªå­—æ®µå°±æŒ‡å‘ <code>io.Reader</code> æ¥å£çš„ç±»å‹å…ƒæ•°æ®ï¼‰ã€‚</li>
<li><code>_type</code>: å®ç°è¯¥æ¥å£çš„<strong>å®é™…ç±»å‹</strong>çš„å…ƒæ•°æ®ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœ <code>io.Reader</code> æ¥å£å˜é‡ä¸­å­˜å‚¨äº†ä¸€ä¸ª <code>*bytes.Buffer</code> ç±»å‹çš„å€¼ï¼Œè¿™ä¸ªå­—æ®µå°±æŒ‡å‘ <code>*bytes.Buffer</code> çš„ç±»å‹å…ƒæ•°æ®ï¼‰ã€‚</li>
<li><code>fun</code>: è¿™æ˜¯ä¸€ä¸ªæ–¹æ³•è¡¨ï¼Œå­˜å‚¨äº†å®é™…ç±»å‹ (<code>_type</code>) åŒ¹é…æ¥å£ (<code>inter</code>) è¦æ±‚çš„æ‰€æœ‰æ–¹æ³•çš„<strong>å‡½æ•°æŒ‡é’ˆ</strong>ã€‚è¿™äº›å‡½æ•°æŒ‡é’ˆæŒ‰ç…§æ¥å£æ–¹æ³•å£°æ˜çš„é¡ºåºæ’åˆ—ã€‚</li>
</ul>
<p><strong><code>iface</code> çš„å·¥ä½œåŸç†ï¼š</strong></p>
<p>å½“ä¸€ä¸ªå€¼è¢«èµ‹ç»™ä¸€ä¸ªéç©ºæ¥å£æ—¶ï¼š</p>
<ol>
<li><strong>æŸ¥æ‰¾ <code>itab</code>ï¼š</strong> Goè¿è¡Œæ—¶ä¼šæŸ¥æ‰¾æˆ–åˆ›å»ºä¸€ä¸ª <code>itab</code>ã€‚è¿™ä¸ªæŸ¥æ‰¾è¿‡ç¨‹æ˜¯æ ¹æ®<strong>æ¥å£ç±»å‹</strong>å’Œ<strong>å®é™…ç±»å‹</strong>è¿›è¡Œçš„ã€‚å¦‚æœ <code>(å®é™…ç±»å‹, æ¥å£ç±»å‹)</code> ç»„åˆå·²ç»å­˜åœ¨å¯¹åº”çš„ <code>itab</code>ï¼Œå°±ç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™ï¼ŒGoä¼šåœ¨è¿è¡Œæ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>itab</code>ã€‚</li>
<li><strong>å¡«å…… <code>itab</code>ï¼š</strong> <code>itab</code> ä¼šè®°å½•æ¥å£ç±»å‹ã€å®ç°è¯¥æ¥å£çš„å®é™…ç±»å‹ï¼Œå¹¶æ„å»ºä¸€ä¸ªæ–¹æ³•è¡¨ (<code>fun</code> å­—æ®µ)ã€‚æ–¹æ³•è¡¨ä¸­çš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘å®é™…ç±»å‹æ‰€å®ç°çš„æ–¹æ³•ã€‚è¿™äº›æŸ¥æ‰¾å’ŒåŒ¹é…åœ¨ç¼–è¯‘æ—¶ä¼šåšä¸€éƒ¨åˆ†ï¼Œ<strong>ä¸»è¦åœ¨è¿è¡Œæ—¶è¿›è¡ŒåŠ¨æ€æŸ¥æ‰¾å’Œç¼“å­˜</strong>ã€‚</li>
<li><strong>å¡«å…… <code>iface</code>ï¼š</strong><ul>
<li><code>iface.tab</code> æŒ‡å‘æ„å»ºå¥½çš„ <code>itab</code>ã€‚</li>
<li><code>iface.data</code> æŒ‡å‘å®é™…çš„å€¼ã€‚åŒæ ·ï¼Œå¯¹äºéæŒ‡é’ˆç±»å‹ï¼Œè¿™é‡Œé€šå¸¸ä¼šæœ‰ä¸€ä¸ªæ‹·è´ã€‚</li>
</ul>
</li>
</ol>
<h3 id="æ¥å£æ–¹æ³•è°ƒç”¨çš„å®ç°"><a href="#æ¥å£æ–¹æ³•è°ƒç”¨çš„å®ç°" class="headerlink" title="æ¥å£æ–¹æ³•è°ƒç”¨çš„å®ç°"></a>æ¥å£æ–¹æ³•è°ƒç”¨çš„å®ç°</h3><p>å½“é€šè¿‡æ¥å£å˜é‡è°ƒç”¨æ–¹æ³•æ—¶ï¼ˆä¾‹å¦‚ <code>myReader.Read(buf)</code>ï¼‰ï¼š</p>
<ol>
<li>Goè¿è¡Œæ—¶ä» <code>myReader</code> æ¥å£å˜é‡çš„ <code>tab</code> å­—æ®µè·å– <code>itab</code> æŒ‡é’ˆã€‚</li>
<li>é€šè¿‡ <code>itab</code> ç»“æ„ä½“çš„ <code>fun</code> å­—æ®µï¼Œæ‰¾åˆ°å¯¹åº”æ–¹æ³•çš„å‡½æ•°æŒ‡é’ˆã€‚ä¾‹å¦‚ï¼Œ<code>Read</code> æ–¹æ³•å¯èƒ½æ˜¯ <code>fun[0]</code>ã€‚</li>
<li>å°† <code>myReader</code> æ¥å£å˜é‡çš„ <code>data</code> å­—æ®µä½œä¸ºæ–¹æ³•çš„ç¬¬ä¸€ä¸ªæ¥æ”¶è€…å‚æ•°ä¼ é€’ç»™æ‰¾åˆ°çš„å‡½æ•°æŒ‡é’ˆã€‚</li>
</ol>
<p>è¿™ç§æœºåˆ¶ä½¿å¾—Goè¯­è¨€èƒ½å¤Ÿå®ç°è¿è¡Œæ—¶å¤šæ€ï¼šå³ä½¿åœ¨ç¼–è¯‘æ—¶ä¸çŸ¥é“æ¥å£å˜é‡ä¸­å…·ä½“å­˜å‚¨çš„æ˜¯å“ªç§ç±»å‹ï¼Œåœ¨è¿è¡Œæ—¶ä¹Ÿèƒ½é€šè¿‡ <code>itab</code> æ­£ç¡®åœ°æ‰¾åˆ°å¹¶è°ƒç”¨ç›¸åº”ç±»å‹çš„æ–¹æ³•ã€‚</p>
<h3 id="æ€»ç»“è¦ç‚¹ï¼š"><a href="#æ€»ç»“è¦ç‚¹ï¼š" class="headerlink" title="æ€»ç»“è¦ç‚¹ï¼š"></a>æ€»ç»“è¦ç‚¹ï¼š</h3><ul>
<li><strong>ç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œè¿è¡Œæ—¶è°ƒåº¦ï¼š</strong> ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥ä¸€ä¸ªç±»å‹æ˜¯å¦å®ç°äº†æ¥å£çš„æ‰€æœ‰æ–¹æ³•ã€‚è€Œåœ¨è¿è¡Œæ—¶ï¼Œé€šè¿‡æ¥å£çš„å†…éƒ¨ç»“æ„ï¼ˆ<code>itab</code>ï¼‰æ¥åŠ¨æ€åœ°è°ƒç”¨æ­£ç¡®çš„æ–¹æ³•ã€‚</li>
<li><strong>éä¾µå…¥å¼ï¼š</strong> ä¸€ä¸ªç±»å‹è¦å®ç°æŸä¸ªæ¥å£ï¼Œä¸éœ€è¦æ˜¾å¼å£°æ˜ï¼ˆå¦‚Javaçš„<code>implements</code>ï¼‰ï¼Œåªéœ€è¦å®ç°æ¥å£å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•å³å¯ã€‚</li>
<li><strong>å€¼æ‹·è´çš„è€ƒé‡ï¼š</strong> å½“ä¸€ä¸ª<strong>éæŒ‡é’ˆç±»å‹</strong>çš„å€¼èµ‹ç»™æ¥å£æ—¶ï¼Œä¼šå‘ç”Ÿä¸€æ¬¡<strong>å€¼æ‹·è´</strong>ã€‚è¿™æ„å‘³ç€æ¥å£å†…éƒ¨æŒæœ‰çš„å€¼æ˜¯åŸå€¼çš„ä¸€ä¸ªå‰¯æœ¬ã€‚å¦‚æœæ–¹æ³•é€šè¿‡æ¥å£ä¿®æ”¹äº†å†…éƒ¨çš„å€¼ï¼Œå¹¶ä¸ä¼šå½±å“åˆ°åŸå˜é‡ã€‚<ul>
<li><strong>é‡è¦æç¤ºï¼š</strong> ä¸ºäº†é¿å…ä¸å¿…è¦çš„æ‹·è´æˆ–ç¡®ä¿æ¥å£æ“ä½œèƒ½ä¿®æ”¹åŸå§‹æ•°æ®ï¼Œé€šå¸¸ä¼šä¼ é€’<strong>æŒ‡é’ˆç±»å‹</strong>åˆ°æ¥å£ï¼ˆä¾‹å¦‚ <code>var r io.Reader = &amp;MyStruct&#123;&#125;</code> è€Œé <code>var r io.Reader = MyStruct&#123;&#125;</code>ï¼‰ï¼Œå› ä¸ºæ­¤æ—¶æ¥å£å†…éƒ¨å­˜å‚¨çš„æ˜¯æŒ‡é’ˆçš„æ‹·è´ï¼Œè€Œå¤šä¸ªæŒ‡é’ˆå‰¯æœ¬éƒ½æŒ‡å‘åŒä¸€ä»½åº•å±‚æ•°æ®ã€‚</li>
</ul>
</li>
<li><strong>æ€§èƒ½å¼€é”€ï¼š</strong> æ¥å£è°ƒç”¨çš„å¼€é”€ç•¥é«˜äºç›´æ¥å‡½æ•°è°ƒç”¨ï¼Œå› ä¸ºå®ƒæ¶‰åŠé¢å¤–çš„æŒ‡é’ˆè§£å¼•ç”¨å’Œ <code>itab</code> æŸ¥æ‰¾ã€‚ä½†åœ¨ç»å¤§å¤šæ•°åº”ç”¨åœºæ™¯ä¸‹ï¼Œè¿™ç§å¼€é”€å¾®ä¹å…¶å¾®ï¼Œå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</li>
</ul>
<p>ç†è§£Goæ¥å£çš„è¿™äº›åº•å±‚å®ç°ç»†èŠ‚ï¼Œèƒ½å¤Ÿå¸®åŠ©æ‚¨æ›´å¥½åœ°è®¾è®¡æ¥å£ï¼Œå¤„ç†å€¼çš„ä¼ é€’ï¼Œé¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é…å’Œæ½œåœ¨çš„bugã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/k8s%20Deployment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="å…­ä¸€">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/k8s%20Deployment/" class="post-title-link" itemprop="url">k8s Deployment</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-11 20:32:34 / ä¿®æ”¹æ—¶é—´ï¼š21:43:26" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/%E9%9D%A2%E8%AF%95%E9%A2%98/" itemprop="url" rel="index"><span itemprop="name">é¢è¯•é¢˜</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>2k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>2 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Kubernetes-ä¸­çš„-Deployment-å’Œ-StatefulSet-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#Kubernetes-ä¸­çš„-Deployment-å’Œ-StatefulSet-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="Kubernetes ä¸­çš„ Deployment å’Œ StatefulSet æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>Kubernetes ä¸­çš„ Deployment å’Œ StatefulSet æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h3><h3 id="ğŸ¤”-åˆ†æè¿‡ç¨‹ï¼š"><a href="#ğŸ¤”-åˆ†æè¿‡ç¨‹ï¼š" class="headerlink" title="ğŸ¤” åˆ†æè¿‡ç¨‹ï¼š"></a>ğŸ¤” åˆ†æè¿‡ç¨‹ï¼š</h3><p>è¯¥é—®é¢˜æ—¨åœ¨è€ƒå¯Ÿå¯¹Kubernetesä¸­ä¸¤ç§æ ¸å¿ƒå·¥ä½œè´Ÿè½½æ§åˆ¶å™¨ï¼ˆWorkload Controllersï¼‰çš„ç†è§£å’ŒåŒºåˆ†èƒ½åŠ›ã€‚ä¸€ä¸ªä¼˜ç§€çš„å›ç­”ä¸ä»…è¦ç½—åˆ—å‡ºåŠŸèƒ½ä¸Šçš„å·®å¼‚ï¼Œæ›´è¦é˜æ˜è¿™ä¸¤ç§æ§åˆ¶å™¨åœ¨è®¾è®¡å“²å­¦ä¸Šçš„æ ¹æœ¬ä¸åŒï¼Œå³å®ƒä»¬åˆ†åˆ«æ˜¯ä¸ºäº†è§£å†³<strong>æ— çŠ¶æ€åº”ç”¨ï¼ˆStatelessï¼‰</strong>å’Œ<strong>æœ‰çŠ¶æ€åº”ç”¨ï¼ˆStatefulï¼‰</strong>è¿™ä¸¤å¤§ç±»é—®é¢˜çš„ã€‚æœ¬å›ç­”å°†é€šè¿‡ä¸€ä¸ªæ¸…æ™°çš„å¯¹æ¯”è¡¨æ ¼æ¥çªå‡ºæ ¸å¿ƒåŒºåˆ«ï¼Œå¹¶ç»“åˆåº”ç”¨åœºæ™¯å’Œé€‰å‹æŒ‡å—ï¼Œå¸®åŠ©é¢è¯•è€…å»ºç«‹æ·±åˆ»çš„ç†è§£ã€‚</p>
<h3 id="ğŸ’¡-ç­”æ¡ˆç”Ÿæˆï¼š"><a href="#ğŸ’¡-ç­”æ¡ˆç”Ÿæˆï¼š" class="headerlink" title="ğŸ’¡ ç­”æ¡ˆç”Ÿæˆï¼š"></a>ğŸ’¡ ç­”æ¡ˆç”Ÿæˆï¼š</h3><h4 id="1-æ ¸å¿ƒæ¦‚å¿µå®šä¹‰"><a href="#1-æ ¸å¿ƒæ¦‚å¿µå®šä¹‰" class="headerlink" title="1. æ ¸å¿ƒæ¦‚å¿µå®šä¹‰"></a>1. æ ¸å¿ƒæ¦‚å¿µå®šä¹‰</h4><ul>
<li><p><strong>Deployment:</strong> æ˜¯Kubernetesä¸­ç”¨äºç®¡ç†<strong>æ— çŠ¶æ€åº”ç”¨</strong>çš„æ§åˆ¶å™¨ã€‚å®ƒç¡®ä¿æŒ‡å®šæ•°é‡çš„ã€å®Œå…¨ç›¸åŒçš„Podå‰¯æœ¬ï¼ˆReplicasï¼‰å¤„äºè¿è¡ŒçŠ¶æ€ã€‚è¿™äº›Podæ˜¯<strong>å¯äº’æ¢çš„ï¼ˆInterchangeable&#x2F;Fungibleï¼‰</strong>ï¼Œå¯ä»¥è¢«éšæ„åœ°åˆ›å»ºå’Œé”€æ¯ï¼Œè€Œä¸ä¼šå½±å“åº”ç”¨çš„æ•´ä½“çŠ¶æ€ã€‚</p>
</li>
<li><p><strong>StatefulSet:</strong> æ˜¯ç”¨äºç®¡ç†<strong>æœ‰çŠ¶æ€åº”ç”¨</strong>çš„æ§åˆ¶å™¨ã€‚å®ƒä¸ºæ¯ä¸ªPodæä¾›<strong>å”¯ä¸€çš„ã€ç¨³å®šçš„èº«ä»½æ ‡è¯†</strong>ï¼Œå¹¶ä¿è¯Podçš„éƒ¨ç½²ã€ä¼¸ç¼©å’Œæ›´æ–°æ˜¯æœ‰åºçš„ã€‚è¿™äº›Podä¸æ˜¯å¯äº’æ¢çš„ï¼Œå®ƒä»¬å„è‡ªæ‹¥æœ‰éœ€è¦æŒä¹…åŒ–çš„çŠ¶æ€ã€‚</p>
</li>
</ul>
<p>è¿™æ˜¯äº‘è®¡ç®—ä¸­ç»å…¸çš„<strong>â€œCattle vs. Petsâ€</strong>ï¼ˆç‰›ç¾¤ vs. å® ç‰©ï¼‰æ¯”å–»çš„ä½“ç°ï¼š</p>
<ul>
<li><strong>Deploymentsç®¡ç†çš„æ˜¯â€œç‰›ç¾¤ï¼ˆCattleï¼‰â€ï¼š</strong> æ‰€æœ‰ç‰›éƒ½ä¸€æ ·ï¼Œä¸€åªç”Ÿç—…äº†ï¼Œå°±ç”¨å¦ä¸€åªå¥åº·çš„æ›¿æ¢æ‰ï¼Œæ— éœ€åœ¨æ„å®ƒæ˜¯å“ªä¸€åªã€‚</li>
<li><strong>StatefulSetsç®¡ç†çš„æ˜¯â€œå® ç‰©ï¼ˆPetsï¼‰â€ï¼š</strong> æ¯åªå® ç‰©éƒ½æœ‰è‡ªå·±çš„åå­—å’Œç‹¬ç‰¹æ€§æ ¼ã€‚å¦‚æœâ€œå°çŒ«å’ª-0â€ç”Ÿç—…äº†ï¼Œä½ éœ€è¦æ²»å¥½å®ƒï¼Œæˆ–è€…ç”¨ä¸€åªæ–°çš„ã€ä½†åŒæ ·å«åšâ€œå°çŒ«å’ª-0â€çš„å® ç‰©æ¥æ›¿æ¢å®ƒï¼Œå¹¶ç¡®ä¿å®ƒèƒ½æ‰¾å›è‡ªå·±åŸæ¥çš„çŒ«çªï¼ˆå­˜å‚¨ï¼‰ã€‚</li>
</ul>
<hr>
<h4 id="2-æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”"><a href="#2-æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”" class="headerlink" title="2. æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”"></a>2. æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”</h4><table>
<thead>
<tr>
<th align="left">ç‰¹æ€§</th>
<th align="left">Deployment (ç”¨äºæ— çŠ¶æ€åº”ç”¨)</th>
<th align="left">StatefulSet (ç”¨äºæœ‰çŠ¶æ€åº”ç”¨)</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>Pod èº«ä»½</strong></td>
<td align="left"><strong>åŠ¨æ€ä¸”éšæœº</strong>ã€‚Podåç§°æ˜¯éšæœºç”Ÿæˆçš„ï¼ˆå¦‚<code>myapp-deploy-7d5f...</code>ï¼‰ï¼ŒPodè¢«é”€æ¯åï¼Œæ–°åˆ›å»ºçš„Podä¼šæœ‰å…¨æ–°çš„åå­—å’Œèº«ä»½ã€‚</td>
<td align="left"><strong>ç¨³å®šä¸”å”¯ä¸€</strong>ã€‚Podåç§°æ˜¯å¯é¢„æµ‹ä¸”æœ‰åºçš„ï¼ˆå¦‚<code>db-0</code>, <code>db-1</code>, <code>db-2</code>ï¼‰ã€‚Podè¢«é”€æ¯åï¼Œæ–°åˆ›å»ºçš„Podä¼šç»§æ‰¿ç›¸åŒçš„åå­—å’Œèº«ä»½ã€‚</td>
</tr>
<tr>
<td align="left"><strong>ç½‘ç»œæ ‡è¯†</strong></td>
<td align="left"><strong>ä¸å”¯ä¸€</strong>ã€‚Pod IPåœ°å€æ˜¯ä¸´æ—¶çš„ã€‚é€šå¸¸é€šè¿‡ä¸€ä¸ªClusterIP Serviceæ¥æš´éœ²ä¸€ç»„Podï¼Œå®¢æˆ·ç«¯åªä¸Serviceé€šä¿¡ï¼Œä¸å…³å¿ƒå…·ä½“æ˜¯å“ªä¸ªPodã€‚</td>
<td align="left"><strong>ç¨³å®šä¸”å”¯ä¸€</strong>ã€‚é€šè¿‡<strong>Headless Service</strong>ï¼Œæ¯ä¸ªPodéƒ½ä¼šè·å¾—ä¸€ä¸ª<strong>ç¨³å®šçš„ã€å”¯ä¸€çš„DNSè®°å½•</strong>ï¼ˆå¦‚ <code>db-0.my-headless-service.default.svc.cluster.local</code>ï¼‰ã€‚è¿™ä½¿å¾—å…¶ä»–åº”ç”¨å¯ä»¥ç²¾ç¡®åœ°å¯»å€åˆ°ç‰¹å®šçš„Podã€‚</td>
</tr>
<tr>
<td align="left"><strong>å­˜å‚¨ (PVC)</strong></td>
<td align="left">Podé€šå¸¸å…±äº«åŒä¸€ä¸ªPersistentVolumeClaim (PVC)ï¼Œæˆ–è€…ä½¿ç”¨ä¸´æ—¶å­˜å‚¨ã€‚å½“Podè¢«æ›¿æ¢æ—¶ï¼Œæ–°çš„Podä¸ä¼šè‡ªåŠ¨æŒ‚è½½æ—§Podçš„å­˜å‚¨å·ã€‚</td>
<td align="left">æ¯ä¸ªPodå‰¯æœ¬éƒ½ä¼šè·å¾—ä¸€ä¸ª<strong>ä¸ä¹‹ç»‘å®šçš„ã€å”¯ä¸€çš„PVC</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>db-0</code>ä¼šç»‘å®šåˆ°<code>data-db-0</code>è¿™ä¸ªPVCã€‚å³ä½¿<code>db-0</code>è¢«é‡å»ºï¼Œæ–°çš„<code>db-0</code>ä¹Ÿä¼šé‡æ–°æŒ‚è½½å›<code>data-db-0</code>ï¼Œä»è€Œ<strong>ä¿æŒäº†æ•°æ®çš„æŒä¹…åŒ–å’ŒçŠ¶æ€çš„è¿ç»­æ€§</strong>ã€‚</td>
</tr>
<tr>
<td align="left"><strong>ä¼¸ç¼©ä¸æ›´æ–°</strong></td>
<td align="left"><strong>å¹¶è¡Œä¸”æ— åº</strong>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ä»¥åŒæ—¶åˆ›å»ºæˆ–é”€æ¯å¤šä¸ªPodä»¥å¿«é€Ÿå“åº”æ‰©ç¼©å®¹ã€‚æ»šåŠ¨æ›´æ–°ä¹Ÿæ˜¯æ— åºçš„ï¼Œåªè¦ä¿è¯å¯ç”¨Podæ•°é‡å³å¯ã€‚</td>
<td align="left"><strong>æœ‰åºä¸”é€ä¸ªè¿›è¡Œ</strong>ã€‚æ— è®ºæ˜¯éƒ¨ç½²ã€æ‰©å®¹è¿˜æ˜¯æ›´æ–°ï¼Œéƒ½ä¸¥æ ¼æŒ‰ç…§Podçš„åºå·è¿›è¡Œã€‚ä¾‹å¦‚ï¼Œæ‰©å®¹æ—¶å¿…é¡»å…ˆåˆ›å»ºå¥½<code>db-0</code>å¹¶ä½¿å…¶Readyï¼Œç„¶åæ‰èƒ½åˆ›å»º<code>db-1</code>ã€‚ç¼©å®¹æ—¶åˆ™ç›¸åï¼ˆä»<code>db-N</code>å¼€å§‹ï¼‰ã€‚è¿™å¯¹äºéœ€è¦æœ‰åºå¯åŠ¨å’Œå…³é—­çš„é›†ç¾¤åº”ç”¨ï¼ˆå¦‚æ•°æ®åº“ä¸»ä»åŒæ­¥ï¼‰è‡³å…³é‡è¦ã€‚</td>
</tr>
</tbody></table>
<hr>
<h4 id="3-åº”ç”¨åœºæ™¯"><a href="#3-åº”ç”¨åœºæ™¯" class="headerlink" title="3. åº”ç”¨åœºæ™¯"></a>3. åº”ç”¨åœºæ™¯</h4><ul>
<li><p><strong>Deployment çš„ç†æƒ³åœºæ™¯:</strong></p>
<ul>
<li>WebæœåŠ¡å™¨ï¼ˆNginx, Apacheï¼‰</li>
<li>APIç½‘å…³ã€æ— çŠ¶æ€çš„å¾®æœåŠ¡</li>
<li>ç¼“å­˜æœåŠ¡ï¼ˆå¦‚æœçŠ¶æ€å¯ä»¥ä¸¢å¤±æˆ–é‡å»ºï¼‰</li>
<li>ä»»ä½•å¯ä»¥è½»æ¾è¿›è¡Œæ°´å¹³æ‰©å±•ä¸”å®ä¾‹ä¹‹é—´æ— éœ€åŒºåˆ†å½¼æ­¤çš„åº”ç”¨ã€‚</li>
</ul>
</li>
<li><p><strong>StatefulSet çš„ç†æƒ³åœºæ™¯:</strong></p>
<ul>
<li><strong>æ•°æ®åº“é›†ç¾¤:</strong> MySQL&#x2F;PostgreSQL (ä¸»ä»å¤åˆ¶), MongoDB (å‰¯æœ¬é›†), Cassandra, CockroachDBã€‚</li>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—:</strong> Kafka, RabbitMQã€‚</li>
<li><strong>åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ:</strong> GlusterFS, Cephã€‚</li>
<li>ä»»ä½•éœ€è¦ç¨³å®šç½‘ç»œæ ‡è¯†ã€æŒä¹…åŒ–å­˜å‚¨å’Œæœ‰åºéƒ¨ç½²çš„åº”ç”¨ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h4 id="4-ä½•æ—¶é€‰æ‹©-é€‰å‹æŒ‡å—"><a href="#4-ä½•æ—¶é€‰æ‹©-é€‰å‹æŒ‡å—" class="headerlink" title="4. ä½•æ—¶é€‰æ‹© (é€‰å‹æŒ‡å—)"></a>4. ä½•æ—¶é€‰æ‹© (é€‰å‹æŒ‡å—)</h4><p>åœ¨é€‰æ‹©ä½¿ç”¨å“ªç§æ§åˆ¶å™¨æ—¶ï¼Œå¯ä»¥é—®è‡ªå·±ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li><strong>åº”ç”¨å®ä¾‹æ˜¯å¦éœ€è¦å”¯ä¸€çš„èº«ä»½ï¼Ÿ</strong> å¦‚æœæ˜¯çš„ï¼Œé€‰æ‹© <strong>StatefulSet</strong>ã€‚</li>
<li><strong>åº”ç”¨æ˜¯å¦éœ€è¦ç¨³å®šçš„ã€å¯é¢„æµ‹çš„ç½‘ç»œåœ°å€ï¼Ÿ</strong> å¦‚æœæ˜¯çš„ï¼Œé€‰æ‹© <strong>StatefulSet</strong>ã€‚</li>
<li><strong>åº”ç”¨æ˜¯å¦éœ€è¦ä¸ºæ¯ä¸ªå®ä¾‹ç»‘å®šä¸€ä¸ªç‹¬æœ‰çš„ã€æŒä¹…åŒ–çš„å­˜å‚¨å·ï¼Ÿ</strong> å¦‚æœæ˜¯çš„ï¼Œé€‰æ‹© <strong>StatefulSet</strong>ã€‚</li>
<li><strong>åº”ç”¨çš„å¯åŠ¨ã€å…³é—­æˆ–æ›´æ–°æ˜¯å¦æœ‰ä¸¥æ ¼çš„é¡ºåºè¦æ±‚ï¼Ÿ</strong> å¦‚æœæ˜¯çš„ï¼Œé€‰æ‹© <strong>StatefulSet</strong>ã€‚</li>
<li>å¦‚æœä»¥ä¸Šé—®é¢˜çš„ç­”æ¡ˆéƒ½æ˜¯â€œå¦â€ï¼Œé‚£ä¹ˆ <strong>Deployment</strong> é€šå¸¸æ˜¯æ›´ç®€å•ã€æ›´åˆé€‚çš„é€‰æ‹©ã€‚</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/jenkins-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="å…­ä¸€">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/jenkins-k8s/" class="post-title-link" itemprop="url">jenkins-k8s</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-11 20:32:34 / ä¿®æ”¹æ—¶é—´ï¼š21:42:32" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index"><span itemprop="name">DevOps</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/Jenkins/" itemprop="url" rel="index"><span itemprop="name">Jenkins</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>8.7k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>8 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Jenkins-ä¸-Kubernetes-é›†æˆçš„æ ¸å¿ƒä»·å€¼"><a href="#Jenkins-ä¸-Kubernetes-é›†æˆçš„æ ¸å¿ƒä»·å€¼" class="headerlink" title="Jenkins ä¸ Kubernetes é›†æˆçš„æ ¸å¿ƒä»·å€¼"></a>Jenkins ä¸ Kubernetes é›†æˆçš„æ ¸å¿ƒä»·å€¼</h3><ol>
<li><strong>å¼¹æ€§ä¼¸ç¼©çš„æ„å»ºç¯å¢ƒï¼š</strong> Jenkins å¯ä»¥æ ¹æ®æ„å»ºéœ€æ±‚åŠ¨æ€åˆ›å»º Kubernetes Pod ä½œä¸º Jenkins Agentï¼Œæ„å»ºå®Œæˆåè‡ªåŠ¨é”€æ¯ï¼ŒèŠ‚çœèµ„æºã€‚</li>
<li><strong>æ„å»ºç¯å¢ƒéš”ç¦»ä¸ä¸€è‡´æ€§ï¼š</strong> æ¯ä¸ªæ„å»ºéƒ½åœ¨ç‹¬ç«‹çš„ã€é¢„å®šä¹‰çš„ Pod ä¸­è¿è¡Œï¼Œç¡®ä¿ç¯å¢ƒçš„çº¯å‡€å’Œä¸€è‡´æ€§ï¼Œé¿å…â€œæ±¡æŸ“â€å’Œå†²çªã€‚</li>
<li><strong>èµ„æºåˆ©ç”¨ç‡æœ€å¤§åŒ–ï¼š</strong> Kubernetes è´Ÿè´£è°ƒåº¦ Agent Pod åˆ°å¯ç”¨èŠ‚ç‚¹ï¼Œä¼˜åŒ–é›†ç¾¤èµ„æºåˆ©ç”¨ã€‚</li>
<li><strong>äº‘åŸç”Ÿéƒ¨ç½²ï¼š</strong> å°†åº”ç”¨ç¨‹åºæ‰“åŒ…æˆ Docker é•œåƒåï¼Œé€šè¿‡ Jenkins Pipeline ç›´æ¥éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ã€‚</li>
<li><strong>è‡ªåŠ¨åŒ–ä¸”å¯é çš„éƒ¨ç½²ï¼š</strong> åˆ©ç”¨ Kubernetes çš„åŸç”Ÿéƒ¨ç½²ï¼ˆDeploymentï¼‰ã€æœåŠ¡å‘ç°ï¼ˆServiceï¼‰ã€é…ç½®ç®¡ç†ï¼ˆConfigMap&#x2F;Secretï¼‰ç­‰èƒ½åŠ›ï¼Œå®ç°å£°æ˜å¼ã€ä¸å¯å˜çš„åŸºç¡€è®¾æ–½éƒ¨ç½²ã€‚</li>
<li><strong>å¯è§‚æµ‹æ€§ä¸å›æ»šï¼š</strong> ç»“åˆ Kubernetes çš„æ»šåŠ¨æ›´æ–°å’Œå›æ»šæœºåˆ¶ï¼ŒJenkins Pipeline å¯ä»¥è½»æ¾å®ç°é›¶åœæœºéƒ¨ç½²å’Œå¿«é€Ÿå›æ»šã€‚</li>
</ol>
<h3 id="Jenkins-ä¸-Kubernetes-é›†æˆæ–¹å¼"><a href="#Jenkins-ä¸-Kubernetes-é›†æˆæ–¹å¼" class="headerlink" title="Jenkins ä¸ Kubernetes é›†æˆæ–¹å¼"></a>Jenkins ä¸ Kubernetes é›†æˆæ–¹å¼</h3><p>Jenkins ä¸ Kubernetes çš„é›†æˆä¸»è¦åœ¨ä¸¤ä¸ªå±‚é¢ï¼š</p>
<ol>
<li><strong>Jenkins Agent è¿è¡Œåœ¨ Kubernetes Pod ä¸­ï¼š</strong> Jenkins å°†æ„å»ºä»»åŠ¡è´Ÿè½½åˆ†å‘åˆ°åŠ¨æ€åˆ›å»ºçš„ Kubernetes Agent Pod ä¸Šã€‚</li>
<li><strong>Jenkins Pipeline éƒ¨ç½²åº”ç”¨åˆ° Kubernetesï¼š</strong> æ„å»ºå¥½çš„åº”ç”¨ï¼ˆDocker é•œåƒï¼‰é€šè¿‡æµæ°´çº¿éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ã€‚</li>
</ol>
<h4 id="1-Jenkins-Agent-è¿è¡Œåœ¨-Kubernetes-Pod-ä¸­ï¼ˆå¼¹æ€§æ„å»ºç¯å¢ƒï¼‰"><a href="#1-Jenkins-Agent-è¿è¡Œåœ¨-Kubernetes-Pod-ä¸­ï¼ˆå¼¹æ€§æ„å»ºç¯å¢ƒï¼‰" class="headerlink" title="1. Jenkins Agent è¿è¡Œåœ¨ Kubernetes Pod ä¸­ï¼ˆå¼¹æ€§æ„å»ºç¯å¢ƒï¼‰"></a>1. Jenkins Agent è¿è¡Œåœ¨ Kubernetes Pod ä¸­ï¼ˆå¼¹æ€§æ„å»ºç¯å¢ƒï¼‰</h4><p>è¿™æ˜¯æœ€æ¨èå’Œæœ€å…ˆè¿›çš„ Jenkins Agent ç®¡ç†æ–¹å¼ã€‚</p>
<p><strong>a. å®‰è£… Kubernetes æ’ä»¶</strong></p>
<ul>
<li>ç™»å½• Jenkinsã€‚</li>
<li>å‰å¾€ <code>Manage Jenkins</code> -&gt; <code>Manage Plugins</code>ã€‚</li>
<li>åœ¨ <code>Available</code> æ ‡ç­¾é¡µæœç´¢å¹¶å®‰è£… <strong>â€œKubernetes CLIâ€</strong> å’Œ <strong>â€œKubernetesâ€</strong> æ’ä»¶ã€‚</li>
</ul>
<p><strong>b. é…ç½® Kubernetes Cloud</strong></p>
<ul>
<li>å‰å¾€ <code>Manage Jenkins</code> -&gt; <code>Configure System</code>ã€‚</li>
<li>æ‰¾åˆ° <code>Cloud</code> éƒ¨åˆ†ï¼Œç‚¹å‡» <code>Add a new cloud</code> -&gt; <code>Kubernetes</code>ã€‚</li>
<li><strong>Kubernetes URLï¼š</strong> å¡«å†™æ‚¨çš„ Kubernetes API Server URLã€‚<ul>
<li>å¦‚æœæ‚¨ Jenkins Master ä¹Ÿåœ¨ Kubernetes é›†ç¾¤å†…è¿è¡Œï¼Œé€šå¸¸å¯ä»¥ä½¿ç”¨ <code>https://kubernetes.default.svc.cluster.local</code>ã€‚</li>
<li>å¦‚æœæ˜¯å¤–éƒ¨é›†ç¾¤ï¼Œéœ€è¦å¡«å†™å®Œæ•´åœ°å€ã€‚</li>
</ul>
</li>
<li><strong>å‡­æ® (Credentials)ï¼š</strong> é€‰æ‹©æˆ–æ·»åŠ è¿æ¥ Kubernetes çš„å‡­æ®ã€‚æœ€å¸¸è§çš„æ˜¯ï¼š<ul>
<li><strong>Kubernetes service accountï¼š</strong> å¦‚æœ Jenkins Master è¿è¡Œåœ¨ K8s ä¸­ï¼Œå¯ä»¥ä½¿ç”¨æœ¬ Pod çš„ Service Accountã€‚</li>
<li><strong>Kubeconfigï¼š</strong> ä¸Šä¼ ä¸€ä¸ª Kubeconfig æ–‡ä»¶ã€‚</li>
<li><strong>Username with password &#x2F; Secret textï¼š</strong> ç”¨äºå¤–éƒ¨è®¿é—®ã€‚</li>
</ul>
</li>
<li><strong>Jenkins URLï¼š</strong> å¡«å†™ Jenkins Master çš„å¤–éƒ¨å¯è®¿é—® URLï¼Œç”¨äº Agent è¿æ¥ Masterã€‚</li>
<li><strong>Jenkins tunnelï¼š</strong> å¦‚æœéœ€è¦ JNLP åè®®çš„ Agentï¼Œé…ç½®éš§é“åœ°å€ã€‚</li>
<li><strong>Pod Templatesï¼š</strong> æ­¤å¤„æ˜¯æ ¸å¿ƒé…ç½®ï¼Œå®šä¹‰äº† Jenkins Agent Pod çš„ä¸åŒè§„æ ¼ã€‚ç‚¹å‡» <code>Add Pod Template</code>ã€‚<ul>
<li><strong>Nameï¼š</strong> æ¨¡æ¿åç§°ã€‚</li>
<li><strong>Labelsï¼š</strong> å…³é”®ï¼è¿™æ˜¯ Jenkins Job é€‰æ‹© Agent çš„æ ‡ç­¾ï¼Œä¾‹å¦‚ <code>maven-jdk11</code>ã€<code>nodejs-16</code>ã€‚</li>
<li><strong>Namespaceï¼š</strong> Agent Pod å°†è¢«åˆ›å»ºåˆ°å“ªä¸ª K8s Namespaceã€‚</li>
<li><strong>Containersï¼š</strong> å®šä¹‰ Agent Pod ä¸­çš„å®¹å™¨ã€‚<ul>
<li><strong>Container Nameï¼š</strong> å¿…é¡»æ˜¯ <code>jnlp</code> (å¦‚æœä½¿ç”¨ JNLP åè®®è¿æ¥) æˆ–å…¶ä»–è‡ªå®šä¹‰åç§°ã€‚</li>
<li><strong>Docker Imageï¼š</strong> ä¾‹å¦‚ <code>maven:3.8.6-openjdk-11</code>ã€<code>node:16-alpine</code>ã€‚</li>
<li><strong>Command &#x2F; Argsï¼š</strong> é€šå¸¸ç•™ç©ºï¼Œæˆ–æ ¹æ®é•œåƒè¦æ±‚å¡«å†™å¯åŠ¨å‘½ä»¤ã€‚</li>
<li><strong>Resource Requests&#x2F;Limitsï¼š</strong> é…ç½® CPU&#x2F;å†…å­˜è¯·æ±‚å’Œé™åˆ¶ï¼Œç¡®ä¿èµ„æºéš”ç¦»å’Œè°ƒåº¦ã€‚</li>
<li><strong>Working Directoryï¼š</strong> <code>/home/jenkins/agent</code> æˆ– <code>/var/jenkins_home/workspace</code>ã€‚</li>
<li><strong>Environment Variables &#x2F; Volume Mountsï¼š</strong> é…ç½®å…¶ä»–ç¯å¢ƒå˜é‡æˆ–æŒ‚è½½æ‰€éœ€çš„å·ã€‚</li>
</ul>
</li>
<li><strong>ServiceAccountï¼š</strong> ä¸º Agent Pod æŒ‡å®šä¸€ä¸ª ServiceAccountï¼Œè¯¥ ServiceAccount éœ€å…·å¤‡æ‰§è¡Œæ„å»ºä»»åŠ¡æ‰€éœ€çš„ K8s æƒé™ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœ Agent éœ€è¦æ‰§è¡Œ <code>kubectl</code> å‘½ä»¤æ¥éƒ¨ç½²åº”ç”¨ï¼‰ã€‚</li>
</ul>
</li>
<li>ç‚¹å‡» **â€œä¿å­˜â€ (Save)**ã€‚</li>
</ul>
<p><strong>c. åœ¨ <code>Jenkinsfile</code> ä¸­ä½¿ç”¨ Kubernetes Agent</strong></p>
<p>åœ¨æ‚¨çš„ <code>Jenkinsfile</code> ä¸­ï¼Œåªéœ€æŒ‡å®šæ‚¨åœ¨ Pod Template ä¸­å®šä¹‰çš„æ ‡ç­¾å³å¯ï¼š</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Jenkinsfile</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">    <span class="comment">// Jenkins ä¼šæ ¹æ®æ ‡ç­¾ &#x27;maven-jdk11&#x27; åŠ¨æ€å¯åŠ¨ä¸€ä¸ªå¯¹åº”çš„ Kubernetes Pod ä½œä¸º Agent</span></span><br><span class="line">    agent &#123; label <span class="string">&#x27;maven-jdk11&#x27;</span> &#125; </span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo <span class="string">&quot;Building application on Kubernetes Pod: $&#123;env.HOSTNAME&#125;&quot;</span></span><br><span class="line">                sh <span class="string">&#x27;mvn clean install -Dmaven.test.skip=true&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœéœ€è¦ä¸åŒç¯å¢ƒï¼Œå¯ä»¥åˆ‡æ¢ Pod æ¨¡æ¿</span></span><br><span class="line">            <span class="comment">// agent &#123; label &#x27;nodejs-16&#x27; &#125; </span></span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn test&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;Build Docker Image&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœå½“å‰ Agent Pod ä¸­æ²¡æœ‰ Docker å®¢æˆ·ç«¯ï¼Œä¸”éœ€è¦è®¿é—® K8s é›†ç¾¤ Docker daemon</span></span><br><span class="line">                <span class="comment">// ç¡®ä¿ä½ çš„ Pod æ¨¡æ¿å·²ç»æŒ‚è½½äº† /var/run/docker.sock (Kube-Dind æˆ– DooD æ–¹æ¡ˆ)</span></span><br><span class="line">                <span class="comment">// æˆ–è€…ä½ çš„ Agent Pod å·²ç»éƒ¨ç½²äº† Docker daemon (çœŸæ­£ Docker-in-Docker)</span></span><br><span class="line">                <span class="comment">// å¦ä¸€ç§æ›´æ ‡å‡†çš„åšæ³•æ˜¯ä½¿ç”¨ Kaniko æˆ– Buildah åœ¨ K8s å†…æ„å»ºé•œåƒï¼Œæ— éœ€ Docker daemon</span></span><br><span class="line">                sh <span class="string">&quot;docker build -t myapp:$&#123;env.BUILD_NUMBER&#125; .&quot;</span> </span><br><span class="line">                withCredentials([usernamePassword(<span class="attr">credentialsId:</span> <span class="string">&#x27;docker-registry-creds&#x27;</span>, <span class="attr">passwordVariable:</span> <span class="string">&#x27;DOCKERHUB_PASSWORD&#x27;</span>, <span class="attr">usernameVariable:</span> <span class="string">&#x27;DOCKERHUB_USERNAME&#x27;</span>)]) &#123;</span><br><span class="line">                    sh <span class="string">&quot;docker login -u $&#123;DOCKERHUB_USERNAME&#125; -p $&#123;DOCKERHUB_PASSWORD&#125;&quot;</span></span><br><span class="line">                    sh <span class="string">&quot;docker push myapp:$&#123;env.BUILD_NUMBER&#125;&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    post &#123;</span><br><span class="line">        always &#123;</span><br><span class="line">            <span class="comment">// æ¸…ç†æˆ–é€šçŸ¥</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>d. å¤šå®¹å™¨ Pod (Sidecar Pattern)</strong></p>
<p>ä¸€ä¸ª Agent Pod å¯ä»¥åŒ…å«å¤šä¸ªå®¹å™¨ã€‚ä¾‹å¦‚ï¼Œä¸»å®¹å™¨æ˜¯ JNLP Agentï¼Œæ—è¾¹å¯ä»¥è¿è¡Œä¸€ä¸ªåŒ…å« <code>kubectl</code> æˆ– Helm çš„ Sidecar å®¹å™¨ã€‚åœ¨ <code>Jenkinsfile</code> ä¸­ï¼Œå¯ä»¥é€šè¿‡ <code>container</code> æŒ‡ä»¤åœ¨ä¸åŒçš„å®¹å™¨ä¸­æ‰§è¡Œæ­¥éª¤ï¼š</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Jenkinsfile</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;</span><br><span class="line">        kubernetes &#123;</span><br><span class="line">            cloud <span class="string">&#x27;kubernetes&#x27;</span> <span class="comment">// å¼•ç”¨é…ç½®çš„ Kubernetes Cloud åç§°</span></span><br><span class="line">            yaml <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: my-jenkins-agent</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: jnlp # Jenkins agent ä¸»å®¹å™¨</span></span><br><span class="line"><span class="string">    image: jenkins/jnlp-agent:latest</span></span><br><span class="line"><span class="string">    args: [&#x27;$(JENKINS_SECRET)&#x27;, &#x27;$(JENKINS_NAME)&#x27;]</span></span><br><span class="line"><span class="string">    env:</span></span><br><span class="line"><span class="string">    - name: EXAMPLE_ENV</span></span><br><span class="line"><span class="string">      value: &quot;hello&quot;</span></span><br><span class="line"><span class="string">  - name: kubectl-tools # Sidecar å®¹å™¨ï¼ŒåŒ…å« kubectl å’Œ helm</span></span><br><span class="line"><span class="string">    image: bitnami/kubectl:latest</span></span><br><span class="line"><span class="string">    command: [&#x27;cat&#x27;]</span></span><br><span class="line"><span class="string">    tty: true</span></span><br><span class="line"><span class="string">  - name: maven-tools # Sidecar å®¹å™¨ï¼ŒåŒ…å« Maven</span></span><br><span class="line"><span class="string">    image: maven:3.8.6-openjdk-11</span></span><br><span class="line"><span class="string">    command: [&#x27;cat&#x27;]</span></span><br><span class="line"><span class="string">    tty: true</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">            <span class="comment">// or podTemplate &#x27;my-complex-pod-template&#x27; // å¼•ç”¨é¢„å…ˆå®šä¹‰çš„ Pod Template</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Build with Maven&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                container(<span class="string">&#x27;maven-tools&#x27;</span>) &#123; <span class="comment">// åœ¨åä¸º &#x27;maven-tools&#x27; çš„å®¹å™¨ä¸­æ‰§è¡Œ</span></span><br><span class="line">                    sh <span class="string">&#x27;mvn clean install&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Deploy with Kubectl&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                container(<span class="string">&#x27;kubectl-tools&#x27;</span>) &#123; <span class="comment">// åœ¨åä¸º &#x27;kubectl-tools&#x27; çš„å®¹å™¨ä¸­æ‰§è¡Œ</span></span><br><span class="line">                    <span class="comment">// ç¡®ä¿ Agent Pod çš„ ServiceAccount æœ‰è¶³å¤Ÿçš„ K8s éƒ¨ç½²æƒé™</span></span><br><span class="line">                    sh <span class="string">&#x27;kubectl apply -f k8s/deployment.yaml&#x27;</span></span><br><span class="line">                    sh <span class="string">&#x27;kubectl rollout status deployment/my-app&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-Jenkins-Pipeline-éƒ¨ç½²åº”ç”¨åˆ°-Kubernetes"><a href="#2-Jenkins-Pipeline-éƒ¨ç½²åº”ç”¨åˆ°-Kubernetes" class="headerlink" title="2. Jenkins Pipeline éƒ¨ç½²åº”ç”¨åˆ° Kubernetes"></a>2. Jenkins Pipeline éƒ¨ç½²åº”ç”¨åˆ° Kubernetes</h4><p>ä¸€æ—¦æ‚¨çš„åº”ç”¨ç¨‹åºè¢«æ„å»ºæˆ Docker é•œåƒå¹¶æ¨é€åˆ°é•œåƒä»“åº“ï¼ŒJenkins Pipeline å°±å¯ä»¥è´Ÿè´£å°†å…¶éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ã€‚</p>
<p><strong>a. ä½¿ç”¨ <code>kubectl</code> CLI</strong></p>
<p>æœ€ç›´æ¥çš„æ–¹å¼æ˜¯åœ¨ Jenkins Agent ä¸­å®‰è£… <code>kubectl</code>ï¼Œç„¶åç›´æ¥æ‰§è¡Œ <code>kubectl</code> å‘½ä»¤ã€‚</p>
<ul>
<li><p><strong>å‰æï¼š</strong> Jenkins Agent æ‰€åœ¨çš„ Pod æˆ–æœåŠ¡å™¨éœ€è¦å®‰è£… <code>kubectl</code> å¹¶åœ¨ PATH ä¸­ã€‚</p>
</li>
<li><p><strong>æƒé™ï¼š</strong> Agent éœ€è¦é…ç½® Kubeconfig æˆ– Service Account æ¥è®¿é—®ç›®æ ‡ Kubernetes é›†ç¾¤ã€‚</p>
</li>
<li><p><strong>ç¤ºä¾‹ (<code>Jenkinsfile</code>)ï¼š</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123; label <span class="string">&#x27;kubectl-agent&#x27;</span> &#125; <span class="comment">// ç¡®ä¿è¿™ä¸ª Agent æœ‰ kubectl</span></span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Deploy to Kubernetes&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="comment">// åˆ‡æ¢åˆ°ç›®æ ‡å‘½åç©ºé—´ (å¦‚æœéœ€è¦)</span></span><br><span class="line">                <span class="comment">// sh &#x27;kubectl config set-context --current --namespace=my-app-namespace&#x27;</span></span><br><span class="line">                <span class="comment">// ç”Ÿæˆå¸¦æœ‰åŠ¨æ€æ ‡ç­¾çš„éƒ¨ç½²æ–‡ä»¶ï¼ˆä¾‹å¦‚ä½¿ç”¨ sed æˆ– yqï¼‰</span></span><br><span class="line">                sh <span class="string">&quot;sed -i &#x27;s/APP_VERSION/$&#123;env.BUILD_NUMBER&#125;/g&#x27; k8s/deployment.yaml&quot;</span> </span><br><span class="line">                sh <span class="string">&quot;sed -i &#x27;s/REGISTRY_IMG/myregistry\/myapp/g&#x27; k8s/deployment.yaml&quot;</span></span><br><span class="line">              </span><br><span class="line">                <span class="comment">// åº”ç”¨ Kubernetes é…ç½®</span></span><br><span class="line">                sh <span class="string">&#x27;kubectl apply -f k8s/deployment.yaml&#x27;</span></span><br><span class="line">              </span><br><span class="line">                <span class="comment">// ç­‰å¾…éƒ¨ç½²å®Œæˆ</span></span><br><span class="line">                sh <span class="string">&#x27;kubectl rollout status deployment/my-app&#x27;</span></span><br><span class="line">              </span><br><span class="line">                <span class="comment">// å¯é€‰ï¼šéªŒè¯éƒ¨ç½²</span></span><br><span class="line">                sh <span class="string">&#x27;kubectl get pods -l app=my-app&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Smoke Test&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="comment">// éƒ¨ç½²åæ‰§è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•</span></span><br><span class="line">                sh <span class="string">&#x27;curl -f http://my-app-service:8080/health || exit 1&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>b. ä½¿ç”¨ Helm (æ¨èç”¨äºå¤æ‚åº”ç”¨)</strong></p>
<p>Helm æ˜¯ Kubernetes çš„åŒ…ç®¡ç†å™¨ï¼Œå¯ä»¥å®šä¹‰ã€å®‰è£…å’Œå‡çº§å¤æ‚çš„ Kubernetes åº”ç”¨ç¨‹åºã€‚Jenkins Pipeline å¯ä»¥åˆ©ç”¨ Helm è¿›è¡Œéƒ¨ç½²ã€‚</p>
<ul>
<li><p><strong>å‰æï¼š</strong> Jenkins Agent ä¸Šå®‰è£… Helm CLIã€‚</p>
</li>
<li><p><strong>ç¤ºä¾‹ (<code>Jenkinsfile</code>)ï¼š</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123; label <span class="string">&#x27;helm-agent&#x27;</span> &#125; <span class="comment">// ç¡®ä¿è¿™ä¸ª Agent æœ‰ Helm å’Œ kubectl</span></span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Package Helm Chart&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&quot;helm package ./helm-chart --version $&#123;env.BUILD_NUMBER&#125;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Deploy with Helm&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="comment">// ä¾‹å¦‚ï¼Œéƒ¨ç½²æˆ–å‡çº§ä¸€ä¸ªåä¸º &#x27;my-app&#x27; çš„ Helm Release</span></span><br><span class="line">                sh <span class="string">&quot;helm upgrade --install my-app ./helm-chart --namespace my-app-namespace --set image.tag=$&#123;env.BUILD_NUMBER&#125;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Rollback (Manual Trigger)&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// ä»…åœ¨æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œç”¨äºå›æ»š</span></span><br><span class="line">            when &#123; manualInput(<span class="string">&#x27;Rollback to previous version?&#x27;</span>) &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="comment">// è·å–ä¸Šæ¬¡æˆåŠŸçš„ç‰ˆæœ¬ (è¿™é‡Œç®€åŒ–ï¼Œå®é™…å¯èƒ½éœ€è¦æ›´å¤æ‚é€»è¾‘æˆ–å‚æ•°)</span></span><br><span class="line">                sh <span class="string">&#x27;helm rollback my-app&#x27;</span> </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>c. ä½¿ç”¨ Kubernetes Pipeline Plugin &#x2F; Kubernetes Client Library (æ›´é«˜çº§)</strong></p>
<p>Jenkins æœ‰ä¸“é—¨çš„ Kubernetes Pipeline æ’ä»¶ï¼Œå®ƒæä¾› Groovy DSL æ¥ä¸ Kubernetes API ç›´æ¥äº¤äº’ï¼Œè€Œæ— éœ€å®‰è£… <code>kubectl</code> CLIã€‚è¿™å¯¹äºæ›´å¤æ‚çš„å£°æ˜å¼ Pod å®šä¹‰å’Œæ“ä½œéå¸¸æœ‰ç”¨ã€‚</p>
<ul>
<li><p><strong>å®‰è£… <code>Kubernetes Pipeline</code> æ’ä»¶ã€‚</strong></p>
</li>
<li><p><strong>ç¤ºä¾‹ (<code>Jenkinsfile</code>)ï¼š</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Jenkinsfile</span></span><br><span class="line"><span class="meta">@Library</span>(<span class="string">&#x27;kubernetes-shared-library&#x27;</span>) _ <span class="comment">// å‡è®¾ä½ æœ‰ä¸€ä¸ªå°è£…äº† K8s æ“ä½œçš„å…±äº«åº“</span></span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123; label <span class="string">&#x27;maven-jdk11&#x27;</span> &#125; </span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Deploy to K8s via DSL&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    <span class="comment">// ä½¿ç”¨ Kubernetes Plugin æä¾›çš„ Groovy DSL</span></span><br><span class="line">                    <span class="comment">// å®šä¹‰ä¸€ä¸ª Deployment</span></span><br><span class="line">                    <span class="keyword">def</span> deployment = <span class="keyword">new</span> LinkedHashMap()</span><br><span class="line">                    deployment.apiVersion = <span class="string">&#x27;apps/v1&#x27;</span></span><br><span class="line">                    deployment.kind = <span class="string">&#x27;Deployment&#x27;</span></span><br><span class="line">                    deployment.metadata = [<span class="attr">name:</span> <span class="string">&quot;my-app-$&#123;env.BUILD_NUMBER&#125;&quot;</span>, <span class="attr">namespace:</span> <span class="string">&quot;default&quot;</span>]</span><br><span class="line">                    deployment.spec = [</span><br><span class="line">                        <span class="symbol">selector:</span> [<span class="attr">matchLabels:</span> [<span class="attr">app:</span> <span class="string">&quot;my-app-$&#123;env.BUILD_NUMBER&#125;&quot;</span>]],</span><br><span class="line">                        <span class="symbol">replicas:</span> <span class="number">2</span>,</span><br><span class="line">                        <span class="symbol">template:</span> [</span><br><span class="line">                            <span class="symbol">metadata:</span> [<span class="attr">labels:</span> [<span class="attr">app:</span> <span class="string">&quot;my-app-$&#123;env.BUILD_NUMBER&#125;&quot;</span>]],</span><br><span class="line">                            <span class="symbol">spec:</span> [</span><br><span class="line">                                <span class="symbol">containers:</span> [[</span><br><span class="line">                                    <span class="symbol">name:</span> <span class="string">&#x27;my-app&#x27;</span>,</span><br><span class="line">                                    <span class="symbol">image:</span> <span class="string">&quot;myregistry/myapp:$&#123;env.BUILD_NUMBER&#125;&quot;</span>,</span><br><span class="line">                                    <span class="symbol">ports:</span> [[<span class="attr">containerPort:</span> <span class="number">8080</span>]]</span><br><span class="line">                                ]]</span><br><span class="line">                            ]</span><br><span class="line">                        ]</span><br><span class="line">                    ]</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// åº”ç”¨ Deployment</span></span><br><span class="line">                    k8s.resource(deployment).createOrReplace()</span><br><span class="line">                    k8s.resource(deployment).waitUntilReady(<span class="number">300</span>) <span class="comment">// ç­‰å¾… Pod å°±ç»ª</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æˆ–è€…è°ƒç”¨å…±äº«åº“ä¸­å°è£…çš„ K8s éƒ¨ç½²å‡½æ•°</span></span><br><span class="line">                    <span class="comment">// sh.deployToK8s(&#x27;myapp&#x27;, env.BUILD_NUMBER) </span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹"><a href="#æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹" class="headerlink" title="æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹"></a>æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹</h3><ul>
<li><strong>ServiceAccount æƒé™ï¼š</strong> Jenkins Agent Pod æ‰€ä½¿ç”¨çš„ Kubernetes ServiceAccount å¿…é¡»ä»…æ‹¥æœ‰æ‰§è¡Œå…¶ä»»åŠ¡æ‰€å¿…éœ€çš„æœ€å°æƒé™ï¼ˆæœ€å°æƒé™åŸåˆ™ï¼‰ã€‚</li>
<li><strong>å‡­æ®ç®¡ç†ï¼š</strong> æ‰€æœ‰æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚ Docker Registry å‡­æ®ã€Kubeconfig å†…å®¹ï¼‰éƒ½åº”é€šè¿‡ Jenkins Credentials è¿›è¡Œç®¡ç†ï¼Œå¹¶é€šè¿‡ <code>withCredentials</code> åœ¨ <code>Jenkinsfile</code> ä¸­å®‰å…¨ä½¿ç”¨ã€‚</li>
<li><strong>ç‰ˆæœ¬ç®¡ç†ï¼š</strong> ç¡®ä¿ Kubernetes Manifests (YAML æ–‡ä»¶) å’Œ Helm Charts ä¸åº”ç”¨ç¨‹åºä»£ç ä¸€åŒè¿›è¡Œç‰ˆæœ¬æ§åˆ¶ã€‚</li>
<li><strong>å…±äº«åº“ï¼š</strong> å¼ºçƒˆå»ºè®®å°†å¤æ‚çš„ Kubernetes éƒ¨ç½²é€»è¾‘å°è£…åœ¨ Jenkins Shared Libraries ä¸­ã€‚è¿™å¯ä»¥ä½¿ <code>Jenkinsfile</code> ä¿æŒç®€æ´ï¼Œå¹¶ä¿ƒè¿›å›¢é˜Ÿå†…çš„CI&#x2F;CDå®è·µæ ‡å‡†åŒ–å’Œå¤ç”¨ã€‚<ul>
<li>ä¾‹å¦‚ï¼Œå¯ä»¥å°è£… <code>deployAppToK8s(appName, imageTag, namespace)</code> ç­‰å‡½æ•°ã€‚</li>
</ul>
</li>
<li><strong>å›æ»šç­–ç•¥ï¼š</strong> Pipeline åº”åŒ…å«å›æ»šæœºåˆ¶ï¼Œåˆ©ç”¨ Kubernetes çš„å†…ç½®èƒ½åŠ›ï¼ˆå¦‚ <code>kubectl rollout undo</code>ï¼‰ã€‚</li>
<li><strong>ç¯å¢ƒéš”ç¦»ï¼š</strong> ä½¿ç”¨ä¸åŒçš„ Kubernetes Namespace æˆ–é›†ç¾¤æ¥éš”ç¦»å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒã€‚</li>
<li><strong>å¯è§‚æµ‹æ€§ï¼š</strong> éƒ¨ç½²åé›†æˆæ—¥å¿—ã€ç›‘æ§å’Œé“¾è·¯è¿½è¸ªç³»ç»Ÿï¼Œç¡®ä¿åº”ç”¨çš„å¥åº·å’Œæ€§èƒ½ã€‚</li>
<li><strong>Jenkins Master çš„éƒ¨ç½²ï¼š</strong> è€ƒè™‘å°† Jenkins Master æœ¬èº«ä¹Ÿéƒ¨ç½²åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼ˆä¾‹å¦‚ä½¿ç”¨ Helm Chartï¼‰ï¼Œä»¥å……åˆ†åˆ©ç”¨ K8s çš„é«˜å¯ç”¨æ€§ã€ä¼¸ç¼©æ€§å’Œç®¡ç†èƒ½åŠ›ã€‚</li>
</ul>
<p>å°† Jenkins ä¸ Kubernetes æ·±åº¦é›†æˆï¼Œæ˜¯å®ç°é«˜æ•ˆã€å¥å£®å’Œå¯æ‰©å±•çš„äº‘åŸç”Ÿ CI&#x2F;CD æµç¨‹çš„å…³é”®ä¸€æ­¥ã€‚å®ƒä¸ä»…ç®€åŒ–äº†éƒ¨ç½²å¤æ‚æ€§ï¼Œè¿˜ä¸ºæ‚¨çš„å›¢é˜Ÿå¸¦æ¥äº†å‰æ‰€æœªæœ‰çš„æ•æ·æ€§å’Œæ§åˆ¶åŠ›ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/k8s%20Namespace/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="å…­ä¸€">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/k8s%20Namespace/" class="post-title-link" itemprop="url">k8s Namespace</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-11 20:32:34 / ä¿®æ”¹æ—¶é—´ï¼š21:43:39" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/%E9%9D%A2%E8%AF%95%E9%A2%98/" itemprop="url" rel="index"><span itemprop="name">é¢è¯•é¢˜</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>2.6k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>2 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>è¯·æè¿° Kubernetes ä¸­çš„ Namespace çš„ä½œç”¨ï¼Œå¹¶è§£é‡Šå…¶ä½¿ç”¨åœºæ™¯ã€‚</p>
<h3 id="ğŸ¤”-åˆ†æè¿‡ç¨‹ï¼š"><a href="#ğŸ¤”-åˆ†æè¿‡ç¨‹ï¼š" class="headerlink" title="ğŸ¤” åˆ†æè¿‡ç¨‹ï¼š"></a>ğŸ¤” åˆ†æè¿‡ç¨‹ï¼š</h3><p>æ­¤é—®é¢˜è€ƒå¯Ÿçš„æ˜¯å¯¹KubernetesåŸºæœ¬ç»„ç»‡å•å…ƒâ€”â€”<strong>Namespace</strong>ï¼ˆå‘½åç©ºé—´ï¼‰çš„ç†è§£ã€‚ä¸€ä¸ªä¼˜ç§€çš„å›ç­”éœ€è¦è§£é‡Šå…¶æ ¸å¿ƒåŠŸèƒ½ï¼Œå³<strong>é€»è¾‘éš”ç¦»</strong>ï¼Œå¹¶èƒ½ä»ä¸åŒç»´åº¦ï¼ˆåç§°ã€èµ„æºã€æƒé™ï¼‰é˜è¿°è¿™ç§éš”ç¦»ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œè¦èƒ½ç»“åˆå®é™…å·¥ä½œåœºæ™¯ï¼Œè¯´æ˜ä¸ºä»€ä¹ˆä»¥åŠå¦‚ä½•ä½¿ç”¨å‘½åç©ºé—´æ¥ç»„ç»‡é›†ç¾¤ï¼Œè¿™ç›´æ¥åæ˜ äº†é¢è¯•è€…çš„é›†ç¾¤æ²»ç†å’Œå¤šç§Ÿæˆ·ç®¡ç†ç»éªŒã€‚</p>
<h3 id="ğŸ’¡-ç­”æ¡ˆç”Ÿæˆï¼š"><a href="#ğŸ’¡-ç­”æ¡ˆç”Ÿæˆï¼š" class="headerlink" title="ğŸ’¡ ç­”æ¡ˆç”Ÿæˆï¼š"></a>ğŸ’¡ ç­”æ¡ˆç”Ÿæˆï¼š</h3><h4 id="1-æ¦‚å¿µæˆ–å®šä¹‰"><a href="#1-æ¦‚å¿µæˆ–å®šä¹‰" class="headerlink" title="1. æ¦‚å¿µæˆ–å®šä¹‰"></a>1. æ¦‚å¿µæˆ–å®šä¹‰</h4><p><strong>Namespace</strong>ï¼ˆå‘½åç©ºé—´ï¼‰æ˜¯Kubernetesä¸­ä¸€ç§å®ç°<strong>é€»è¾‘éš”ç¦»</strong>çš„æœºåˆ¶ï¼Œå®ƒèƒ½å°†ä¸€ä¸ªç‰©ç†çš„Kubernetesé›†ç¾¤åˆ’åˆ†ä¸ºå¤šä¸ª<strong>è™šæ‹Ÿé›†ç¾¤</strong>ã€‚æ¯ä¸ªå‘½åç©ºé—´éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ä½œç”¨åŸŸï¼Œç”¨äºç»„ç»‡å’Œéš”ç¦»é›†ç¾¤ä¸­çš„èµ„æºå¯¹è±¡ã€‚</p>
<p>éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œè¿™ç§éš”ç¦»æ˜¯<strong>é€»è¾‘ä¸Šçš„ï¼Œè€Œéç‰©ç†ä¸Šçš„</strong>ã€‚ä¸åŒå‘½åç©ºé—´ä¸­çš„Podå¯èƒ½ä¼šè¿è¡Œåœ¨åŒä¸€ä¸ªç‰©ç†èŠ‚ç‚¹ä¸Šï¼Œä½†å®ƒä»¬åœ¨APIå±‚é¢ã€ç­–ç•¥å±‚é¢å’Œåç§°å±‚é¢æ˜¯ç›¸äº’éš”ç¦»çš„ã€‚</p>
<h4 id="2-Namespace-çš„æ ¸å¿ƒä½œç”¨"><a href="#2-Namespace-çš„æ ¸å¿ƒä½œç”¨" class="headerlink" title="2. Namespace çš„æ ¸å¿ƒä½œç”¨"></a>2. Namespace çš„æ ¸å¿ƒä½œç”¨</h4><p>Namespaceä¸ºä¸€ç»„èµ„æºæä¾›äº†ä¸‰ä¸ªç»´åº¦çš„éš”ç¦»ï¼š</p>
<ul>
<li><p><strong>1. åç§°èŒƒå›´éš”ç¦» (Scope for Names):</strong></p>
<ul>
<li><strong>ä½œç”¨ï¼š</strong> è¿™æ˜¯æœ€åŸºæœ¬çš„ä½œç”¨ã€‚åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´å†…ï¼Œèµ„æºå¯¹è±¡çš„åç§°ï¼ˆå¦‚Podã€Serviceã€Deploymentçš„åç§°ï¼‰å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚ä½†æ˜¯ï¼Œåœ¨ä¸åŒçš„å‘½åç©ºé—´ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨å®Œå…¨ç›¸åŒçš„èµ„æºåç§°ã€‚</li>
<li><strong>ç¤ºä¾‹ï¼š</strong> ä½ å¯ä»¥åœ¨<code>development</code>å‘½åç©ºé—´ä¸­æœ‰ä¸€ä¸ªåä¸º<code>my-app</code>çš„Deploymentï¼ŒåŒæ—¶åœ¨<code>production</code>å‘½åç©ºé—´ä¸­ä¹Ÿæœ‰ä¸€ä¸ªåä¸º<code>my-app</code>çš„Deploymentï¼Œå®ƒä»¬æ˜¯ä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„å¯¹è±¡ï¼Œäº’ä¸å½±å“ã€‚</li>
</ul>
</li>
<li><p><strong>2. èµ„æºå’Œç­–ç•¥éš”ç¦» (Scope for Resources and Policies):</strong></p>
<ul>
<li><strong>ä½œç”¨ï¼š</strong> Namespaceæ˜¯åº”ç”¨èµ„æºé…é¢å’Œç½‘ç»œç­–ç•¥çš„åŸºæœ¬å•ä½ã€‚</li>
<li><strong>ResourceQuota:</strong> ä½ å¯ä»¥ä¸ºä¸€ä¸ªå‘½åç©ºé—´è®¾ç½®èµ„æºé…é¢ï¼ˆå¦‚CPUã€å†…å­˜ã€å­˜å‚¨çš„æ€»é‡ï¼‰ï¼Œç¡®ä¿è¯¥å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰èµ„æºæ¶ˆè€—ä¸ä¼šè¶…å‡ºé¢„è®¾çš„â€œé¢„ç®—â€ã€‚</li>
<li><strong>LimitRange:</strong> ä½ å¯ä»¥ä¸ºå‘½åç©ºé—´å†…çš„Podè®¾ç½®é»˜è®¤çš„èµ„æºè¯·æ±‚&#x2F;é™åˆ¶ã€‚</li>
<li><strong>NetworkPolicy:</strong> ä½ å¯ä»¥å®šä¹‰ç½‘ç»œç­–ç•¥æ¥æ§åˆ¶å‘½åç©ºé—´å†…éƒ¨ä»¥åŠå‘½åç©ºé—´ä¹‹é—´çš„ç½‘ç»œæµé‡ï¼Œä¾‹å¦‚ï¼Œé»˜è®¤ç¦æ­¢<code>dev</code>å‘½åç©ºé—´è®¿é—®<code>prod</code>å‘½åç©ºé—´çš„æ•°æ®åº“ã€‚</li>
</ul>
</li>
<li><p><strong>3. è®¿é—®æ§åˆ¶éš”ç¦» (Scope for Access Control):</strong></p>
<ul>
<li><strong>ä½œç”¨ï¼š</strong> Kubernetesçš„RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰æ˜¯ä¸å‘½åç©ºé—´ç´§å¯†é›†æˆçš„ã€‚</li>
<li><strong>Role å’Œ RoleBinding:</strong> æƒé™ï¼ˆ<code>Role</code>ï¼‰å’Œæƒé™ç»‘å®šï¼ˆ<code>RoleBinding</code>ï¼‰æ˜¯å‘½åç©ºé—´çº§åˆ«çš„å¯¹è±¡ã€‚ä½ å¯ä»¥ä¸ºç”¨æˆ·Aæˆäºˆ<code>development</code>å‘½åç©ºé—´çš„å®Œå…¨ç®¡ç†å‘˜æƒé™ï¼Œä½†å¯¹å…¶åœ¨<code>production</code>å‘½åç©ºé—´ä¸­åªæœ‰åªè¯»æƒé™ã€‚è¿™ä½¿å¾—åœ¨å¤šå›¢é˜Ÿç¯å¢ƒä¸­è¿›è¡Œç²¾ç»†åŒ–çš„æƒé™ç®¡ç†æˆä¸ºå¯èƒ½ã€‚</li>
</ul>
</li>
</ul>
<h4 id="3-ä½¿ç”¨åœºæ™¯"><a href="#3-ä½¿ç”¨åœºæ™¯" class="headerlink" title="3. ä½¿ç”¨åœºæ™¯"></a>3. ä½¿ç”¨åœºæ™¯</h4><p>åŸºäºä¸Šè¿°ä½œç”¨ï¼ŒNamespaceåœ¨ä»¥ä¸‹åœºæ™¯ä¸­è‡³å…³é‡è¦ï¼š</p>
<ul>
<li><p><strong>å¤šç¯å¢ƒéš”ç¦» (Development, Staging, Production):</strong></p>
<ul>
<li>è¿™æ˜¯æœ€ç»å…¸çš„ä½¿ç”¨åœºæ™¯ã€‚ä½ å¯ä»¥ä¸ºå¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒåˆ›å»ºä¸åŒçš„å‘½åç©ºé—´ (<code>dev</code>, <code>staging</code>, <code>prod</code>)ã€‚</li>
<li><strong>ä¼˜åŠ¿:</strong><ul>
<li>ç¯å¢ƒä¹‹é—´é…ç½®ç‹¬ç«‹ï¼ˆä½¿ç”¨ä¸åŒçš„ConfigMap&#x2F;Secretï¼‰ã€‚</li>
<li>æƒé™åˆ†æ˜ï¼ˆå¼€å‘äººå‘˜åœ¨<code>dev</code>ä¸­æœ‰é«˜æƒé™ï¼Œåœ¨<code>prod</code>ä¸­åªæœ‰åªè¯»æƒé™ï¼‰ã€‚</li>
<li>èµ„æºç‹¬ç«‹ï¼ˆä¸º<code>prod</code>åˆ†é…æ›´å¤šçš„èµ„æºé…é¢ï¼‰ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>å¤šå›¢é˜Ÿ&#x2F;å¤šé¡¹ç›®éš”ç¦» (Multi-tenancy):</strong></p>
<ul>
<li>å½“å¤šä¸ªå›¢é˜Ÿæˆ–é¡¹ç›®å…±äº«åŒä¸€ä¸ªKubernetesé›†ç¾¤æ—¶ï¼Œä¸ºæ¯ä¸ªå›¢é˜Ÿæˆ–é¡¹ç›®åˆ›å»ºä¸€ä¸ªä¸“å±çš„å‘½åç©ºé—´ï¼ˆå¦‚<code>team-a</code>, <code>team-b</code>, <code>project-x</code>ï¼‰ã€‚</li>
<li><strong>ä¼˜åŠ¿:</strong><ul>
<li>é˜²æ­¢å›¢é˜Ÿé—´çš„åç§°å†²çªã€‚</li>
<li>å®ç°èµ„æºçš„å…¬å¹³åˆ†é…å’Œæˆæœ¬åˆ†æ‘Šã€‚</li>
<li>å„å›¢é˜Ÿå¯ä»¥ç‹¬ç«‹ç®¡ç†è‡ªå·±çš„åº”ç”¨å’Œæƒé™ï¼Œäº’ä¸å¹²æ‰°ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>ç®¡ç†ç¬¬ä¸‰æ–¹åº”ç”¨æˆ–ç³»ç»Ÿç»„ä»¶:</strong></p>
<ul>
<li>åœ¨é›†ç¾¤ä¸­å®‰è£…ç¬¬ä¸‰æ–¹åº”ç”¨ï¼ˆå¦‚Prometheusç›‘æ§å¥—ä»¶ã€IstioæœåŠ¡ç½‘æ ¼ã€Ingressæ§åˆ¶å™¨ï¼‰æ—¶ï¼Œæœ€ä½³å®è·µæ˜¯å°†å…¶å®‰è£…åœ¨å®ƒä»¬è‡ªå·±çš„å‘½åç©ºé—´ä¸­ï¼ˆå¦‚<code>monitoring</code>, <code>istio-system</code>, <code>ingress-nginx</code>ï¼‰ã€‚</li>
<li><strong>ä¼˜åŠ¿:</strong><ul>
<li>å°†æ ¸å¿ƒç³»ç»Ÿç»„ä»¶ä¸æ™®é€šåº”ç”¨éš”ç¦»å¼€ï¼Œä¾¿äºç®¡ç†å’Œç»´æŠ¤ã€‚</li>
<li>å‡çº§æˆ–å¸è½½è¿™äº›ç»„ä»¶æ—¶ï¼Œåªéœ€åˆ é™¤å¯¹åº”çš„å‘½åç©ºé—´å³å¯ï¼Œå¹²å‡€åˆ©è½ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>è“ç»¿éƒ¨ç½²&#x2F;é‡‘ä¸é›€å‘å¸ƒ:</strong></p>
<ul>
<li>åœ¨è¿›è¡Œå¤æ‚çš„å‘å¸ƒç­–ç•¥æ—¶ï¼Œæœ‰æ—¶ä¼šä½¿ç”¨ä¸åŒçš„å‘½åç©ºé—´æ¥éƒ¨ç½²æ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬çš„åº”ç”¨ï¼Œä»¥ä¾¿é€šè¿‡Ingressè§„åˆ™æˆ–æœåŠ¡ç½‘æ ¼ç²¾ç»†åœ°æ§åˆ¶æµé‡åˆ‡æ¢ã€‚</li>
</ul>
</li>
</ul>
<h4 id="4-é»˜è®¤å­˜åœ¨çš„å‘½åç©ºé—´"><a href="#4-é»˜è®¤å­˜åœ¨çš„å‘½åç©ºé—´" class="headerlink" title="4. é»˜è®¤å­˜åœ¨çš„å‘½åç©ºé—´"></a>4. é»˜è®¤å­˜åœ¨çš„å‘½åç©ºé—´</h4><p>ä¸€ä¸ªæ–°åˆ›å»ºçš„Kubernetesé›†ç¾¤é€šå¸¸åŒ…å«ä»¥ä¸‹å‡ ä¸ªå‘½åç©ºé—´ï¼š</p>
<ul>
<li><strong><code>default</code>:</strong> å¦‚æœä½ åœ¨åˆ›å»ºèµ„æºå¯¹è±¡æ—¶æ²¡æœ‰æŒ‡å®šå‘½åç©ºé—´ï¼Œå®ƒå°±ä¼šè¢«æ”¾åˆ°è¿™é‡Œã€‚<strong>æœ€ä½³å®è·µæ˜¯é¿å…åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨<code>default</code>å‘½åç©ºé—´æ¥éƒ¨ç½²åº”ç”¨ã€‚</strong></li>
<li><strong><code>kube-system</code>:</strong> Kubernetesç³»ç»Ÿç»„ä»¶ï¼ˆå¦‚etcd, kube-apiserver, kube-scheduler, kube-proxy, CoreDNSï¼‰æ‰€åœ¨çš„å‘½åç©ºé—´ã€‚<strong>ç»å¯¹ä¸è¦åœ¨æ­¤å‘½åç©ºé—´ä¸­éƒ¨ç½²ä½ çš„åº”ç”¨ã€‚</strong></li>
<li><strong><code>kube-public</code>:</strong> ä¸€ä¸ªç‰¹æ®Šçš„å‘½åç©ºé—´ï¼Œæ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬æœªè®¤è¯ç”¨æˆ·ï¼‰éƒ½å¯ä»¥è¯»å–å®ƒã€‚é€šå¸¸ç”¨äºå­˜æ”¾ä¸€äº›éœ€è¦å¯¹æ•´ä¸ªé›†ç¾¤å…¬å¼€çš„æ•°æ®ã€‚</li>
<li><strong><code>kube-node-lease</code>:</strong> ç”¨äºå­˜æ”¾æ¯ä¸ªèŠ‚ç‚¹çš„ç§Ÿçº¦å¯¹è±¡ï¼Œkubeletä¼šå®šæœŸæ›´æ–°å®ƒæ¥è¡¨æ˜èŠ‚ç‚¹æ˜¯å­˜æ´»çš„ã€‚</li>
</ul>
<h4 id="5-æ‰©å±•çŸ¥è¯†-æœ€ä½³å®è·µ"><a href="#5-æ‰©å±•çŸ¥è¯†-æœ€ä½³å®è·µ" class="headerlink" title="5. æ‰©å±•çŸ¥è¯†&#x2F;æœ€ä½³å®è·µ"></a>5. æ‰©å±•çŸ¥è¯†&#x2F;æœ€ä½³å®è·µ</h4><ul>
<li><strong>è·¨å‘½åç©ºé—´é€šä¿¡:</strong> é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰å‘½åç©ºé—´ä¹‹é—´çš„ç½‘ç»œæ˜¯äº’é€šçš„ã€‚è‹¥è¦ä»ä¸€ä¸ªå‘½åç©ºé—´ä¸­çš„Podè®¿é—®å¦ä¸€ä¸ªå‘½åç©ºé—´ä¸­çš„Serviceï¼Œéœ€è¦ä½¿ç”¨å…¶å®Œå…¨é™å®šåŸŸåï¼ˆFQDNï¼‰ï¼š<code>&lt;service-name&gt;.&lt;namespace-name&gt;.svc.cluster.local</code>ã€‚ä¾‹å¦‚ï¼š<code>database-svc.prod.svc.cluster.local</code>ã€‚</li>
<li><strong>éå‘½åç©ºé—´èµ„æº:</strong> ä¸æ˜¯æ‰€æœ‰çš„Kubernetesèµ„æºéƒ½å±äºå‘½åç©ºé—´ã€‚ä¸€äº›èµ„æºæ˜¯<strong>é›†ç¾¤çº§åˆ«</strong>çš„ï¼Œä¾‹å¦‚<code>Node</code>, <code>PersistentVolume</code>, <code>StorageClass</code>, <code>ClusterRole</code>, <code>ClusterRoleBinding</code>ã€‚</li>
<li><strong>ç»„ç»‡åŸåˆ™:</strong> ä»¥ä¸šåŠ¡ã€å›¢é˜Ÿæˆ–ç¯å¢ƒä¸ºå•ä½æ¥åˆ’åˆ†å‘½åç©ºé—´æ˜¯è‰¯å¥½çš„å®è·µã€‚é¿å…åˆ›å»ºè¿‡å¤šä¸å¿…è¦çš„å‘½åç©ºé—´ï¼Œä»¥å…å¢åŠ ç®¡ç†å¤æ‚æ€§ã€‚</li>
</ul>
<p><strong>ç»“è®ºï¼š</strong> Namespaceæ˜¯Kubernetesä¸­å®ç°é€»è¾‘éš”ç¦»ã€èµ„æºæ²»ç†å’Œè®¿é—®æ§åˆ¶çš„åŸºæœ¬å•å…ƒã€‚å®ƒé€šè¿‡åˆ’åˆ†è™šæ‹Ÿé›†ç¾¤ï¼Œä½¿å¾—åœ¨å•ä¸€ç‰©ç†é›†ç¾¤ä¸Šå®ç°å¤šç¯å¢ƒã€å¤šå›¢é˜Ÿçš„å®‰å…¨ã€é«˜æ•ˆå’Œæœ‰åºç®¡ç†æˆä¸ºå¯èƒ½ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/ingress-nginx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="å…­ä¸€">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/ingress-nginx/" class="post-title-link" itemprop="url">ingress-nginx</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-11 20:32:34 / ä¿®æ”¹æ—¶é—´ï¼š21:39:48" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">ç½‘ç»œ</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>41k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>37 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ingress-nginx"><a href="#ingress-nginx" class="headerlink" title="ingress-nginx"></a>ingress-nginx</h1><p>æˆ‘ä»¬å·²ç»äº†è§£äº† Ingress èµ„æºå¯¹è±¡åªæ˜¯ä¸€ä¸ªè·¯ç”±è¯·æ±‚æè¿°é…ç½®æ–‡ä»¶ï¼Œè¦è®©å…¶çœŸæ­£ç”Ÿæ•ˆè¿˜éœ€è¦å¯¹åº”çš„ Ingress æ§åˆ¶å™¨æ‰è¡Œï¼ŒIngress æ§åˆ¶å™¨æœ‰å¾ˆå¤šï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆä»‹ç»ä½¿ç”¨æœ€å¤šçš„ <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/">ingress-nginx</a>ï¼Œå®ƒæ˜¯åŸºäº Nginx çš„ Ingress æ§åˆ¶å™¨ã€‚</p>
<h2 id="è¿è¡ŒåŸç†"><a href="#è¿è¡ŒåŸç†" class="headerlink" title="è¿è¡ŒåŸç†"></a>è¿è¡ŒåŸç†</h2><p><code>ingress-nginx</code> æ§åˆ¶å™¨ä¸»è¦æ˜¯ç”¨æ¥ç»„è£…ä¸€ä¸ª <code>nginx.conf</code> çš„é…ç½®æ–‡ä»¶ï¼Œå½“é…ç½®æ–‡ä»¶å‘ç”Ÿä»»ä½•å˜åŠ¨çš„æ—¶å€™å°±éœ€è¦é‡æ–°åŠ è½½ Nginx æ¥ç”Ÿæ•ˆï¼Œä½†æ˜¯å¹¶ä¸ä¼šåªåœ¨å½±å“ <code>upstream</code> é…ç½®çš„å˜æ›´åå°±é‡æ–°åŠ è½½ Nginxï¼Œæ§åˆ¶å™¨å†…éƒ¨ä¼šä½¿ç”¨ä¸€ä¸ª <code>lua-nginx-module</code> æ¥å®ç°è¯¥åŠŸèƒ½ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ Kubernetes æ§åˆ¶å™¨ä½¿ç”¨æ§åˆ¶å¾ªç¯æ¨¡å¼æ¥æ£€æŸ¥æ§åˆ¶å™¨ä¸­æ‰€éœ€çš„çŠ¶æ€æ˜¯å¦å·²æ›´æ–°æˆ–æ˜¯å¦éœ€è¦å˜æ›´ï¼Œæ‰€ä»¥ <code>ingress-nginx</code> éœ€è¦ä½¿ç”¨é›†ç¾¤ä¸­çš„ä¸åŒå¯¹è±¡æ¥æ„å»ºæ¨¡å‹ï¼Œæ¯”å¦‚ Ingressã€Serviceã€Endpointsã€Secretã€ConfigMap ç­‰å¯ä»¥ç”Ÿæˆåæ˜ é›†ç¾¤çŠ¶æ€çš„é…ç½®æ–‡ä»¶çš„å¯¹è±¡ï¼Œæ§åˆ¶å™¨éœ€è¦ä¸€ç›´ Watch è¿™äº›èµ„æºå¯¹è±¡çš„å˜åŒ–ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åŠæ³•çŸ¥é“ç‰¹å®šçš„æ›´æ”¹æ˜¯å¦ä¼šå½±å“åˆ°æœ€ç»ˆç”Ÿæˆçš„ <code>nginx.conf</code> é…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸€æ—¦ Watch åˆ°äº†ä»»ä½•å˜åŒ–æ§åˆ¶å™¨éƒ½å¿…é¡»æ ¹æ®é›†ç¾¤çš„çŠ¶æ€é‡å»ºä¸€ä¸ªæ–°çš„æ¨¡å‹ï¼Œå¹¶å°†å…¶ä¸å½“å‰çš„æ¨¡å‹è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ¨¡å‹ç›¸åŒåˆ™å°±å¯ä»¥é¿å…ç”Ÿæˆæ–°çš„ Nginx é…ç½®å¹¶è§¦å‘é‡æ–°åŠ è½½ï¼Œå¦åˆ™è¿˜éœ€è¦æ£€æŸ¥æ¨¡å‹çš„å·®å¼‚æ˜¯å¦åªå’Œç«¯ç‚¹æœ‰å…³ï¼Œå¦‚æœæ˜¯è¿™æ ·ï¼Œåˆ™ç„¶åéœ€è¦ä½¿ç”¨ HTTP POST è¯·æ±‚å°†æ–°çš„ç«¯ç‚¹åˆ—è¡¨å‘é€åˆ°åœ¨ Nginx å†…è¿è¡Œçš„ Lua å¤„ç†ç¨‹åºï¼Œå¹¶å†æ¬¡é¿å…ç”Ÿæˆæ–°çš„ Nginx é…ç½®å¹¶è§¦å‘é‡æ–°åŠ è½½ï¼Œå¦‚æœè¿è¡Œå’Œæ–°æ¨¡å‹ä¹‹é—´çš„å·®å¼‚ä¸ä»…ä»…æ˜¯ç«¯ç‚¹ï¼Œé‚£ä¹ˆå°±ä¼šåŸºäºæ–°æ¨¡å‹åˆ›å»ºä¸€ä¸ªæ–°çš„ Nginx é…ç½®äº†ï¼Œè¿™æ ·æ„å»ºæ¨¡å‹æœ€å¤§çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯åœ¨çŠ¶æ€æ²¡æœ‰å˜åŒ–æ—¶é¿å…ä¸å¿…è¦çš„é‡æ–°åŠ è½½ï¼Œå¯ä»¥èŠ‚çœå¤§é‡ Nginx é‡æ–°åŠ è½½ã€‚</p>
<p>ä¸‹é¢ç®€å•æè¿°äº†éœ€è¦é‡æ–°åŠ è½½çš„ä¸€äº›åœºæ™¯ï¼š</p>
<ul>
<li>åˆ›å»ºäº†æ–°çš„ Ingress èµ„æº</li>
<li>TLS æ·»åŠ åˆ°ç°æœ‰ Ingress</li>
<li>ä» Ingress ä¸­æ·»åŠ æˆ–åˆ é™¤ path è·¯å¾„</li>
<li>Ingressã€Serviceã€Secret è¢«åˆ é™¤äº†</li>
<li>Ingress çš„ä¸€äº›ç¼ºå¤±å¼•ç”¨å¯¹è±¡å˜å¯ç”¨äº†ï¼Œä¾‹å¦‚ Service æˆ– Secret</li>
<li>æ›´æ–°äº†ä¸€ä¸ª Secret</li>
</ul>
<p>å¯¹äºé›†ç¾¤è§„æ¨¡è¾ƒå¤§çš„åœºæ™¯ä¸‹é¢‘ç¹çš„å¯¹ Nginx è¿›è¡Œé‡æ–°åŠ è½½æ˜¾ç„¶ä¼šé€ æˆå¤§é‡çš„æ€§èƒ½æ¶ˆè€—ï¼Œæ‰€ä»¥è¦å°½å¯èƒ½å‡å°‘å‡ºç°é‡æ–°åŠ è½½çš„åœºæ™¯ã€‚</p>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>ç”±äº <code>ingress-nginx</code> æ‰€åœ¨çš„èŠ‚ç‚¹éœ€è¦èƒ½å¤Ÿè®¿é—®å¤–ç½‘ï¼Œè¿™æ ·åŸŸåå¯ä»¥è§£æåˆ°è¿™äº›èŠ‚ç‚¹ä¸Šç›´æ¥ä½¿ç”¨ï¼Œæ‰€ä»¥éœ€è¦è®© <code>ingress-nginx</code> ç»‘å®šèŠ‚ç‚¹çš„ 80 å’Œ 443 ç«¯å£ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ hostPort æ¥è¿›è¡Œè®¿é—®ï¼Œå½“ç„¶å¯¹äºçº¿ä¸Šç¯å¢ƒæ¥è¯´ä¸ºäº†ä¿è¯é«˜å¯ç”¨ï¼Œä¸€èˆ¬æ˜¯éœ€è¦è¿è¡Œå¤šä¸ª Â·ingress-nginx å®ä¾‹çš„ï¼Œç„¶åå¯ä»¥ç”¨ä¸€ä¸ª nginx&#x2F;haproxy ä½œä¸ºå…¥å£ï¼Œé€šè¿‡ keepalived æ¥è®¿é—®è¾¹ç¼˜èŠ‚ç‚¹çš„ vip åœ°å€ã€‚</p>
<p>!!! info â€œè¾¹ç¼˜èŠ‚ç‚¹â€ æ‰€è°“çš„è¾¹ç¼˜èŠ‚ç‚¹å³é›†ç¾¤å†…éƒ¨ç”¨æ¥å‘é›†ç¾¤å¤–æš´éœ²æœåŠ¡èƒ½åŠ›çš„èŠ‚ç‚¹ï¼Œé›†ç¾¤å¤–éƒ¨çš„æœåŠ¡é€šè¿‡è¯¥èŠ‚ç‚¹æ¥è°ƒç”¨é›†ç¾¤å†…éƒ¨çš„æœåŠ¡ï¼Œè¾¹ç¼˜èŠ‚ç‚¹æ˜¯é›†ç¾¤å†…å¤–äº¤æµçš„ä¸€ä¸ª Endpointã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Helm Chartï¼ˆåé¢ä¼šè¯¦ç»†è®²è§£ï¼‰çš„æ–¹å¼æ¥è¿›è¡Œå®‰è£…ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¦‚æœä½ ä¸å–œæ¬¢ä½¿ç”¨ helm chart è¿›è¡Œå®‰è£…ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ä¸€é”®å®‰è£…</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.0/deploy/static/provider/cloud/deploy.yaml</span></span><br><span class="line">âœ helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span><br><span class="line">âœ helm repo update</span><br><span class="line">âœ helm fetch ingress-nginx/ingress-nginx</span><br><span class="line">âœ tar -xvf ingress-nginx-4.0.13.tgz &amp;&amp; cd ingress-nginx</span><br><span class="line">âœ tree .</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ CHANGELOG.md</span><br><span class="line">â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”œâ”€â”€ OWNERS</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ ci</span><br><span class="line">â”‚   â”œâ”€â”€ controller-custom-ingressclass-flags.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ daemonset-customconfig-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ daemonset-customnodeport-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ daemonset-headers-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ daemonset-internal-lb-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ daemonset-nodeport-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ daemonset-podannotations-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ daemonset-tcp-udp-configMapNamespace-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ daemonset-tcp-udp-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ daemonset-tcp-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deamonset-default-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deamonset-metrics-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deamonset-psp-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deamonset-webhook-and-psp-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deamonset-webhook-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-autoscaling-behavior-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-autoscaling-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-customconfig-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-customnodeport-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-default-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-headers-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-internal-lb-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-metrics-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-nodeport-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-podannotations-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-psp-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-tcp-udp-configMapNamespace-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-tcp-udp-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-tcp-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-webhook-and-psp-values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ deployment-webhook-resources-values.yaml</span><br><span class="line">â”‚   â””â”€â”€ deployment-webhook-values.yaml</span><br><span class="line">â”œâ”€â”€ templates</span><br><span class="line">â”‚   â”œâ”€â”€ NOTES.txt</span><br><span class="line">â”‚   â”œâ”€â”€ _helpers.tpl</span><br><span class="line">â”‚   â”œâ”€â”€ _params.tpl</span><br><span class="line">â”‚   â”œâ”€â”€ admission-webhooks</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ job-patch</span><br><span class="line">â”‚   â”‚   â”‚   â”œâ”€â”€ clusterrole.yaml</span><br><span class="line">â”‚   â”‚   â”‚   â”œâ”€â”€ clusterrolebinding.yaml</span><br><span class="line">â”‚   â”‚   â”‚   â”œâ”€â”€ job-createSecret.yaml</span><br><span class="line">â”‚   â”‚   â”‚   â”œâ”€â”€ job-patchWebhook.yaml</span><br><span class="line">â”‚   â”‚   â”‚   â”œâ”€â”€ psp.yaml</span><br><span class="line">â”‚   â”‚   â”‚   â”œâ”€â”€ role.yaml</span><br><span class="line">â”‚   â”‚   â”‚   â”œâ”€â”€ rolebinding.yaml</span><br><span class="line">â”‚   â”‚   â”‚   â””â”€â”€ serviceaccount.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ validating-webhook.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ clusterrole.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ clusterrolebinding.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-configmap-addheaders.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-configmap-proxyheaders.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-configmap-tcp.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-configmap-udp.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-configmap.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-daemonset.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-deployment.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-hpa.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-ingressclass.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-keda.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-poddisruptionbudget.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-prometheusrules.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-psp.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-role.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-rolebinding.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-service-internal.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-service-metrics.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-service-webhook.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-service.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-serviceaccount.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ controller-servicemonitor.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ default-backend-deployment.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ default-backend-hpa.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ default-backend-poddisruptionbudget.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ default-backend-psp.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ default-backend-role.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ default-backend-rolebinding.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ default-backend-service.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ default-backend-serviceaccount.yaml</span><br><span class="line">â”‚   â””â”€â”€ dh-param-secret.yaml</span><br><span class="line">â””â”€â”€ values.yaml</span><br><span class="line"></span><br><span class="line">4 directories, 81 files</span><br></pre></td></tr></table></figure>



<p>Helm Chart åŒ…ä¸‹è½½ä¸‹æ¥åè§£å‹å°±å¯ä»¥çœ‹åˆ°é‡Œé¢åŒ…å«çš„æ¨¡æ¿æ–‡ä»¶ï¼Œå…¶ä¸­çš„ <code>ci</code> ç›®å½•ä¸­å°±åŒ…å«äº†å„ç§åœºæ™¯ä¸‹é¢å®‰è£…çš„ Values é…ç½®æ–‡ä»¶ï¼Œ<code>values.yaml</code> æ–‡ä»¶ä¸­åŒ…å«çš„æ˜¯æ‰€æœ‰å¯é…ç½®çš„é»˜è®¤å€¼ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹è¿™äº›é»˜è®¤å€¼è¿›è¡Œè¦†ç›–ï¼Œæˆ‘ä»¬è¿™é‡Œæµ‹è¯•ç¯å¢ƒå°±å°† master1 èŠ‚ç‚¹çœ‹æˆè¾¹ç¼˜èŠ‚ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ç›´æ¥å°† <code>ingress-nginx</code> å›ºå®šåˆ° master1 èŠ‚ç‚¹ä¸Šï¼Œé‡‡ç”¨ hostNetwork æ¨¡å¼(ç”Ÿäº§ç¯å¢ƒå¯ä»¥ä½¿ç”¨ LB + DaemonSet hostNetwork æ¨¡å¼)ï¼Œä¸ºäº†é¿å…åˆ›å»ºçš„é”™è¯¯ Ingress ç­‰èµ„æºå¯¹è±¡å½±å“æ§åˆ¶å™¨é‡æ–°åŠ è½½ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¼ºçƒˆå»ºè®®å¤§å®¶å¼€å¯å‡†å…¥æ§åˆ¶å™¨ï¼Œ<code>ingess-nginx</code> ä¸­ä¼šæä¾›ä¸€ä¸ªç”¨äºæ ¡éªŒèµ„æºå¯¹è±¡çš„ Admission Webhookï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Values æ–‡ä»¶è¿›è¡Œå¼€å¯ã€‚ç„¶åæ–°å»ºä¸€ä¸ªåä¸º <code>ci/daemonset-prod.yaml</code> çš„ Values æ–‡ä»¶ï¼Œç”¨æ¥è¦†ç›– ingress-nginx é»˜è®¤çš„ Values å€¼ã€‚</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/1rao2j.png" alt="ä¸»æœºç½‘ç»œæ¨¡å¼"></p>
<p>å¯¹åº”çš„ Values é…ç½®æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ci/daemonset-prod.yaml</span></span><br><span class="line"><span class="attr">controller:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">controller</span></span><br><span class="line">  <span class="attr">image:</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">cnych/ingress-nginx</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="string">&#x27;v1.1.0&#x27;</span></span><br><span class="line">    <span class="attr">digest:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">publishService:</span> <span class="comment"># hostNetwork æ¨¡å¼ä¸‹è®¾ç½®ä¸ºfalseï¼Œé€šè¿‡èŠ‚ç‚¹IPåœ°å€ä¸ŠæŠ¥ingress statusæ•°æ®</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># æ˜¯å¦éœ€è¦å¤„ç†ä¸å¸¦ ingressClass æ³¨è§£æˆ–è€… ingressClassName å±æ€§çš„ Ingress å¯¹è±¡</span></span><br><span class="line">  <span class="comment"># è®¾ç½®ä¸º true ä¼šåœ¨æ§åˆ¶å™¨å¯åŠ¨å‚æ•°ä¸­æ–°å¢ä¸€ä¸ª --watch-ingress-without-class æ ‡æ³¨</span></span><br><span class="line">  <span class="attr">watchIngressWithoutClass:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tolerations:</span> <span class="comment"># kubeadm å®‰è£…çš„é›†ç¾¤é»˜è®¤æƒ…å†µä¸‹masteræ˜¯æœ‰æ±¡ç‚¹ï¼Œéœ€è¦å®¹å¿è¿™ä¸ªæ±¡ç‚¹æ‰å¯ä»¥éƒ¨ç½²</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&#x27;node-role.kubernetes.io/master&#x27;</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">&#x27;Equal&#x27;</span></span><br><span class="line">      <span class="attr">effect:</span> <span class="string">&#x27;NoSchedule&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nodeSelector:</span> <span class="comment"># å›ºå®šåˆ°master1èŠ‚ç‚¹</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">master1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">service:</span> <span class="comment"># HostNetwork æ¨¡å¼ä¸éœ€è¦åˆ›å»ºservice</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">admissionWebhooks:</span> <span class="comment"># å¼ºçƒˆå»ºè®®å¼€å¯ admission webhook</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">createSecretJob:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">20Mi</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">20Mi</span></span><br><span class="line">    <span class="attr">patchWebhookJob:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">20Mi</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">20Mi</span></span><br><span class="line">    <span class="attr">patch:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">image:</span></span><br><span class="line">        <span class="attr">repository:</span> <span class="string">cnych/ingress-nginx-webhook-certgen</span></span><br><span class="line">        <span class="attr">tag:</span> <span class="string">v1.1.1</span></span><br><span class="line">        <span class="attr">digest:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">defaultBackend:</span> <span class="comment"># é…ç½®é»˜è®¤åç«¯</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">defaultbackend</span></span><br><span class="line">  <span class="attr">image:</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">cnych/ingress-nginx-defaultbackend</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="string">&#x27;1.5&#x27;</span></span><br></pre></td></tr></table></figure>



<p>ç„¶åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£… <code>ingress-nginx</code> åº”ç”¨åˆ° <code>ingress-nginx</code> çš„å‘½åç©ºé—´ä¸­ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl create ns ingress-nginx</span><br><span class="line">âœ helm upgrade --install ingress-nginx . -f ./ci/daemonset-prod.yaml --namespace ingress-nginx</span><br><span class="line">Release &quot;ingress-nginx&quot; does not exist. Installing it now.</span><br><span class="line"></span><br><span class="line">NAME: ingress-nginx</span><br><span class="line">LAST DEPLOYED: Thu Dec 16 16:47:20 2021</span><br><span class="line">NAMESPACE: ingress-nginx</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">The ingress-nginx controller has been installed.</span><br><span class="line">It may take a few minutes for the LoadBalancer IP to be available.</span><br><span class="line">You can watch the status by running &#x27;kubectl --namespace ingress-nginx get services -o wide -w ingress-nginx-controller&#x27;</span><br><span class="line"></span><br><span class="line">An example Ingress that makes use of the controller:</span><br><span class="line">  apiVersion: networking.k8s.io/v1</span><br><span class="line">  kind: Ingress</span><br><span class="line">  metadata:</span><br><span class="line">    name: example</span><br><span class="line">    namespace: foo</span><br><span class="line">  spec:</span><br><span class="line">    ingressClassName: nginx</span><br><span class="line">    rules:</span><br><span class="line">      - host: www.example.com</span><br><span class="line">        http:</span><br><span class="line">          paths:</span><br><span class="line">            - backend:</span><br><span class="line">                service:</span><br><span class="line">                  name: exampleService</span><br><span class="line">                  port:</span><br><span class="line">                    number: 80</span><br><span class="line">              path: /</span><br><span class="line">    # This section is only required if TLS is to be enabled for the Ingress</span><br><span class="line">    tls:</span><br><span class="line">      - hosts:</span><br><span class="line">        - www.example.com</span><br><span class="line">        secretName: example-tls</span><br><span class="line"></span><br><span class="line">If TLS is enabled for the Ingress, a Secret containing the certificate and key must also be provided:</span><br><span class="line"></span><br><span class="line">  apiVersion: v1</span><br><span class="line">  kind: Secret</span><br><span class="line">  metadata:</span><br><span class="line">    name: example-tls</span><br><span class="line">    namespace: foo</span><br><span class="line">  data:</span><br><span class="line">    tls.crt: &lt;base64 encoded cert&gt;</span><br><span class="line">    tls.key: &lt;base64 encoded key&gt;</span><br><span class="line">  type: kubernetes.io/tls</span><br></pre></td></tr></table></figure>



<p>éƒ¨ç½²å®ŒæˆåæŸ¥çœ‹ Pod çš„è¿è¡ŒçŠ¶æ€ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl get svc -n ingress-nginx</span><br><span class="line">NAME                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">ingress-nginx-controller-admission   ClusterIP   10.96.15.99     &lt;none&gt;        443/TCP   11m</span><br><span class="line">ingress-nginx-defaultbackend         ClusterIP   10.97.250.253   &lt;none&gt;        80/TCP    11m</span><br><span class="line">âœ kubectl get pods -n ingress-nginx</span><br><span class="line">NAME                                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">ingress-nginx-controller-5dfdd4659c-9g7c2       1/1     Running   0          11m</span><br><span class="line">ingress-nginx-defaultbackend-84854cd6cb-xb7rv   1/1     Running   0          11m</span><br><span class="line">âœ POD_NAME=$(kubectl get pods -l app.kubernetes.io/name=ingress-nginx -n ingress-nginx -o jsonpath=&#x27;&#123;.items[0].metadata.name&#125;&#x27;)</span><br><span class="line">âœ kubectl exec -it $POD_NAME -n ingress-nginx -- /nginx-ingress-controller --version</span><br><span class="line">kubectl logs -f ingress-nginx-controller-5dfdd4659c-9g7c2 -n ingress-nginxW1216 08:51:22.179213       7 client_config.go:615] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.</span><br><span class="line">I1216 08:51:22.179525       7 main.go:223] &quot;Creating API client&quot; host=&quot;https://10.96.0.1:443&quot;</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">NGINX Ingress controller</span><br><span class="line">  Release:       v1.1.0</span><br><span class="line">  Build:         cacbee86b6ccc45bde8ffc184521bed3022e7dee</span><br><span class="line">  Repository:    https://github.com/kubernetes/ingress-nginx</span><br><span class="line">  nginx version: nginx/1.19.9</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">I1216 08:51:22.198221       7 main.go:267] &quot;Running in Kubernetes cluster&quot; major=&quot;1&quot; minor=&quot;22&quot; git=&quot;v1.22.2&quot; state=&quot;clean&quot; commit=&quot;8b5a19147530eaac9476b0ab82980b4088bbc1b2&quot; platform=&quot;linux/amd64&quot;</span><br><span class="line">I1216 08:51:22.200478       7 main.go:86] &quot;Valid default backend&quot; service=&quot;ingress-nginx/ingress-nginx-defaultbackend&quot;</span><br><span class="line">I1216 08:51:22.611100       7 main.go:104] &quot;SSL fake certificate created&quot; file=&quot;/etc/ingress-controller/ssl/default-fake-certificate.pem&quot;</span><br><span class="line">I1216 08:51:22.627386       7 ssl.go:531] &quot;loading tls certificate&quot; path=&quot;/usr/local/certificates/cert&quot; key=&quot;/usr/local/certificates/key&quot;</span><br><span class="line">I1216 08:51:22.651187       7 nginx.go:255] &quot;Starting NGINX Ingress controller&quot;</span><br></pre></td></tr></table></figure>



<p>å½“çœ‹åˆ°ä¸Šé¢çš„ä¿¡æ¯è¯æ˜ <code>ingress-nginx</code> éƒ¨ç½²æˆåŠŸäº†ï¼Œè¿™é‡Œæˆ‘ä»¬å®‰è£…çš„æ˜¯æœ€æ–°ç‰ˆæœ¬çš„æ§åˆ¶å™¨ï¼Œå®‰è£…å®Œæˆåä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª åä¸º <code>nginx</code> çš„ <code>IngressClass</code> å¯¹è±¡ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl get ingressclass</span><br><span class="line">NAME    CONTROLLER             PARAMETERS   AGE</span><br><span class="line">nginx   k8s.io/ingress-nginx   &lt;none&gt;       18m</span><br><span class="line">âœ kubectl get ingressclass nginx -o yaml</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: IngressClass</span><br><span class="line">metadata:</span><br><span class="line">  ......</span><br><span class="line">  name: nginx</span><br><span class="line">  resourceVersion: &quot;1513966&quot;</span><br><span class="line">  uid: 70340e62-cab6-4a11-9982-2108f1db786b</span><br><span class="line">spec:</span><br><span class="line">  controller: k8s.io/ingress-nginx</span><br></pre></td></tr></table></figure>



<p>ä¸è¿‡è¿™é‡Œæˆ‘ä»¬åªæä¾›äº†ä¸€ä¸ª <code>controller</code> å±æ€§ï¼Œå¦‚æœè¿˜éœ€è¦é…ç½®ä¸€äº›é¢å¤–çš„å‚æ•°ï¼Œåˆ™å¯ä»¥åœ¨å®‰è£…çš„ values æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®ã€‚</p>
<h2 id="ç¬¬ä¸€ä¸ªç¤ºä¾‹"><a href="#ç¬¬ä¸€ä¸ªç¤ºä¾‹" class="headerlink" title="ç¬¬ä¸€ä¸ªç¤ºä¾‹"></a>ç¬¬ä¸€ä¸ªç¤ºä¾‹</h2><p>å®‰è£…æˆåŠŸåï¼Œç°åœ¨æˆ‘ä»¬æ¥ä¸ºä¸€ä¸ª nginx åº”ç”¨åˆ›å»ºä¸€ä¸ª Ingress èµ„æºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my-nginx.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">my-nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span> <span class="comment"># ä½¿ç”¨ nginx çš„ IngressClassï¼ˆå…³è”çš„ ingress-nginx æ§åˆ¶å™¨ï¼‰</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">ngdemo.qikqiak.com</span> <span class="comment"># å°†åŸŸåæ˜ å°„åˆ° my-nginx æœåŠ¡</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span> <span class="comment"># å°†æ‰€æœ‰è¯·æ±‚å‘é€åˆ° my-nginx æœåŠ¡çš„ 80 ç«¯å£</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line"><span class="comment"># ä¸è¿‡éœ€è¦æ³¨æ„å¤§éƒ¨åˆ†Ingressæ§åˆ¶å™¨éƒ½ä¸æ˜¯ç›´æ¥è½¬å‘åˆ°Service</span></span><br><span class="line"><span class="comment"># è€Œæ˜¯åªæ˜¯é€šè¿‡Serviceæ¥è·å–åç«¯çš„Endpointsåˆ—è¡¨ï¼Œç›´æ¥è½¬å‘åˆ°Podï¼Œè¿™æ ·å¯ä»¥å‡å°‘ç½‘ç»œè·³è½¬ï¼Œæé«˜æ€§èƒ½</span></span><br></pre></td></tr></table></figure>



<p>ç›´æ¥åˆ›å»ºä¸Šé¢çš„èµ„æºå¯¹è±¡ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl apply -f my-nginx.yaml</span><br><span class="line">deployment.apps/my-nginx created</span><br><span class="line">service/my-nginx created</span><br><span class="line">ingress.networking.k8s.io/my-nginx created</span><br><span class="line">âœ kubectl get ingress</span><br><span class="line">NAME           CLASS    HOSTS                ADDRESS         PORTS   AGE</span><br><span class="line">my-nginx       nginx    ngdemo.qikqiak.com   192.168.31.31   80      30m</span><br></pre></td></tr></table></figure>



<p>åœ¨ä¸Šé¢çš„ Ingress èµ„æºå¯¹è±¡ä¸­æˆ‘ä»¬ä½¿ç”¨é…ç½® <code>ingressClassName: nginx</code> æŒ‡å®šè®©æˆ‘ä»¬å®‰è£…çš„ <code>ingress-nginx</code> è¿™ä¸ªæ§åˆ¶å™¨æ¥å¤„ç†æˆ‘ä»¬çš„ Ingress èµ„æºï¼Œé…ç½®çš„åŒ¹é…è·¯å¾„ç±»å‹ä¸ºå‰ç¼€çš„æ–¹å¼å»åŒ¹é… <code>/</code>ï¼Œå°†æ¥è‡ªåŸŸå <code>ngdemo.qikqiak.com</code> çš„æ‰€æœ‰è¯·æ±‚è½¬å‘åˆ° <code>my-nginx</code> æœåŠ¡çš„åç«¯ Endpoints ä¸­å»ã€‚</p>
<p>ä¸Šé¢èµ„æºåˆ›å»ºæˆåŠŸåï¼Œç„¶åæˆ‘ä»¬å¯ä»¥å°†åŸŸå <code>ngdemo.qikqiak.com</code> è§£æåˆ° <code>ingress-nginx</code> æ‰€åœ¨çš„<strong>è¾¹ç¼˜èŠ‚ç‚¹</strong>ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨æœ¬åœ° <code>/etc/hosts</code> ä¸­æ·»åŠ å¯¹åº”çš„æ˜ å°„ä¹Ÿå¯ä»¥ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡åŸŸåè¿›è¡Œè®¿é—®äº†ã€‚</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/dmpgpt.png" alt="ngdemo"></p>
<p>ä¸‹å›¾æ˜¾ç¤ºäº†å®¢æˆ·ç«¯æ˜¯å¦‚ä½•é€šè¿‡ Ingress æ§åˆ¶å™¨è¿æ¥åˆ°å…¶ä¸­ä¸€ä¸ª Pod çš„æµç¨‹ï¼Œå®¢æˆ·ç«¯é¦–å…ˆå¯¹ <code>ngdemo.qikqiak.com</code> æ‰§è¡Œ DNS è§£æï¼Œå¾—åˆ° Ingress æ§åˆ¶å™¨æ‰€åœ¨èŠ‚ç‚¹çš„ IPï¼Œç„¶åå®¢æˆ·ç«¯å‘ Ingress æ§åˆ¶å™¨å‘é€ HTTP è¯·æ±‚ï¼Œç„¶åæ ¹æ® Ingress å¯¹è±¡é‡Œé¢çš„æè¿°åŒ¹é…åŸŸåï¼Œæ‰¾åˆ°å¯¹åº”çš„ Service å¯¹è±¡ï¼Œå¹¶è·å–å…³è”çš„ Endpoints åˆ—è¡¨ï¼Œå°†å®¢æˆ·ç«¯çš„è¯·æ±‚è½¬å‘ç»™å…¶ä¸­ä¸€ä¸ª Podã€‚</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/lranff.png" alt="ingress controller workflow"></p>
<p>å‰é¢æˆ‘ä»¬ä¹Ÿæåˆ°äº† <code>ingress-nginx</code> æ§åˆ¶å™¨çš„æ ¸å¿ƒåŸç†å°±æ˜¯å°†æˆ‘ä»¬çš„ <code>Ingress</code> è¿™äº›èµ„æºå¯¹è±¡æ˜ å°„ç¿»è¯‘æˆ Nginx é…ç½®æ–‡ä»¶ <code>nginx.conf</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹æ§åˆ¶å™¨ä¸­çš„é…ç½®æ–‡ä»¶æ¥éªŒè¯è¿™ç‚¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl exec -it $POD_NAME -n ingress-nginx -- cat /etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">upstream upstream_balancer &#123;</span><br><span class="line">        server 0.0.0.1; # placeholder</span><br><span class="line">        balancer_by_lua_block &#123;</span><br><span class="line">                balancer.balance()</span><br><span class="line">        &#125;</span><br><span class="line">        keepalive 320;</span><br><span class="line">        keepalive_timeout  60s;</span><br><span class="line">        keepalive_requests 10000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># start server ngdemo.qikqiak.com</span></span></span><br><span class="line">server &#123;</span><br><span class="line">        server_name ngdemo.qikqiak.com ;</span><br><span class="line"></span><br><span class="line">        listen 80  ;</span><br><span class="line">        listen [::]:80  ;</span><br><span class="line">        listen 443  ssl http2 ;</span><br><span class="line">        listen [::]:443  ssl http2 ;</span><br><span class="line"></span><br><span class="line">        set $proxy_upstream_name &quot;-&quot;;</span><br><span class="line"></span><br><span class="line">        ssl_certificate_by_lua_block &#123;</span><br><span class="line">                certificate.call()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line"></span><br><span class="line">                set $namespace      &quot;default&quot;;</span><br><span class="line">                set $ingress_name   &quot;my-nginx&quot;;</span><br><span class="line">                set $service_name   &quot;my-nginx&quot;;</span><br><span class="line">                set $service_port   &quot;80&quot;;</span><br><span class="line">                set $location_path  &quot;/&quot;;</span><br><span class="line">                set $global_rate_limit_exceeding n;</span><br><span class="line">                ......</span><br><span class="line">                proxy_next_upstream_timeout             0;</span><br><span class="line">                proxy_next_upstream_tries               3;</span><br><span class="line"></span><br><span class="line">                proxy_pass http://upstream_balancer;</span><br><span class="line"></span><br><span class="line">                proxy_redirect                          off;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># end server ngdemo.qikqiak.com</span></span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>



<p>æˆ‘ä»¬å¯ä»¥åœ¨ <code>nginx.conf</code> é…ç½®æ–‡ä»¶ä¸­çœ‹åˆ°ä¸Šé¢æˆ‘ä»¬æ–°å¢çš„ Ingress èµ„æºå¯¹è±¡çš„ç›¸å…³é…ç½®ä¿¡æ¯ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ç°åœ¨å¹¶ä¸ä¼šä¸ºæ¯ä¸ª backend åç«¯éƒ½åˆ›å»ºä¸€ä¸ª <code>upstream</code> é…ç½®å—ï¼Œç°åœ¨æ˜¯ä½¿ç”¨ Lua ç¨‹åºè¿›è¡ŒåŠ¨æ€å¤„ç†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ²¡æœ‰ç›´æ¥çœ‹åˆ°åç«¯çš„ Endpoints ç›¸å…³é…ç½®æ•°æ®ã€‚</p>
<h2 id="Nginx-é…ç½®"><a href="#Nginx-é…ç½®" class="headerlink" title="Nginx é…ç½®"></a>Nginx é…ç½®</h2><p>å¦‚æœæˆ‘ä»¬è¿˜æƒ³è¿›è¡Œä¸€äº›è‡ªå®šä¹‰é…ç½®ï¼Œåˆ™æœ‰å‡ ç§æ–¹å¼å¯ä»¥å®ç°ï¼šä½¿ç”¨ Configmap åœ¨ Nginx ä¸­è®¾ç½®å…¨å±€é…ç½®ã€é€šè¿‡ Ingress çš„ Annotations è®¾ç½®ç‰¹å®š Ingress çš„è§„åˆ™ã€è‡ªå®šä¹‰æ¨¡æ¿ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹ç»™å¤§å®¶ä»‹ç»ä½¿ç”¨æ³¨è§£æ¥å¯¹ Ingress å¯¹è±¡è¿›è¡Œè‡ªå®šä¹‰ã€‚</p>
<h3 id="Basic-Auth"><a href="#Basic-Auth" class="headerlink" title="Basic Auth"></a>Basic Auth</h3><p>æˆ‘ä»¬å¯ä»¥åœ¨ Ingress å¯¹è±¡ä¸Šé…ç½®ä¸€äº›åŸºæœ¬çš„ Auth è®¤è¯ï¼Œæ¯”å¦‚ Basic Authï¼Œå¯ä»¥ç”¨ <code>htpasswd</code> ç”Ÿæˆä¸€ä¸ªå¯†ç æ–‡ä»¶æ¥éªŒè¯èº«ä»½éªŒè¯ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">âœ htpasswd -c auth foo</span><br><span class="line">New password:</span><br><span class="line">Re-type new password:</span><br><span class="line">Adding password for user foo</span><br></pre></td></tr></table></figure>



<p>ç„¶åæ ¹æ®ä¸Šé¢çš„ auth æ–‡ä»¶åˆ›å»ºä¸€ä¸ª secret å¯¹è±¡ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl create secret generic basic-auth --from-file=auth</span><br><span class="line">secret/basic-auth created</span><br><span class="line">âœ kubectl get secret basic-auth -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  auth: Zm9vOiRhcHIxJFUxYlFZTFVoJHdIZUZQQ1dyZTlGRFZONTQ0dXVQdC4K</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: basic-auth</span><br><span class="line">  namespace: default</span><br><span class="line">type: Opaque</span><br></pre></td></tr></table></figure>



<p>ç„¶åå¯¹ä¸Šé¢çš„ my-nginx åº”ç”¨åˆ›å»ºä¸€ä¸ªå…·æœ‰ Basic Auth çš„ Ingress å¯¹è±¡ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-with-auth</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-type:</span> <span class="string">basic</span> <span class="comment"># è®¤è¯ç±»å‹</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-secret:</span> <span class="string">basic-auth</span> <span class="comment"># åŒ…å« user/password å®šä¹‰çš„ secret å¯¹è±¡å</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-realm:</span> <span class="string">&#x27;Authentication Required - foo&#x27;</span> <span class="comment"># è¦æ˜¾ç¤ºçš„å¸¦æœ‰é€‚å½“ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯ï¼Œè¯´æ˜éœ€è¦èº«ä»½éªŒè¯çš„åŸå› </span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span> <span class="comment"># ä½¿ç”¨ nginx çš„ IngressClassï¼ˆå…³è”çš„ ingress-nginx æ§åˆ¶å™¨ï¼‰</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">bauth.qikqiak.com</span> <span class="comment"># å°†åŸŸåæ˜ å°„åˆ° my-nginx æœåŠ¡</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span> <span class="comment"># å°†æ‰€æœ‰è¯·æ±‚å‘é€åˆ° my-nginx æœåŠ¡çš„ 80 ç«¯å£</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>ç›´æ¥åˆ›å»ºä¸Šé¢çš„èµ„æºå¯¹è±¡ï¼Œç„¶åé€šè¿‡ä¸‹é¢çš„å‘½ä»¤æˆ–è€…åœ¨æµè§ˆå™¨ä¸­ç›´æ¥æ‰“å¼€é…ç½®çš„åŸŸåï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl get ingress</span><br><span class="line">NAME                CLASS    HOSTS                        ADDRESS         PORTS   AGE</span><br><span class="line">ingress-with-auth   nginx    bauth.qikqiak.com            192.168.31.31   80      6m55s</span><br><span class="line">âœ curl -v http://192.168.31.31 -H &#x27;Host: bauth.qikqiak.com&#x27;</span><br><span class="line">*   Trying 192.168.31.31...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 192.168.31.31 (192.168.31.31) port 80 (#0)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">GET / HTTP/1.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Host: bauth.qikqiak.com</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">User-Agent: curl/7.64.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Accept: */*</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&lt; HTTP/1.1 401 Unauthorized</span></span><br><span class="line">&lt; Date: Thu, 16 Dec 2021 10:49:03 GMT</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">&lt; Content-Length: 172</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt; WWW-Authenticate: Basic realm=&quot;Authentication Required - foo&quot;</span><br><span class="line">&lt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">* Connection #0 to host 192.168.31.31 left intact</span><br><span class="line">* Closing connection 0</span><br></pre></td></tr></table></figure>



<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡ºç°äº† 401 è®¤è¯å¤±è´¥é”™è¯¯ï¼Œç„¶åå¸¦ä¸Šæˆ‘ä»¬é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œè®¤è¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">âœ curl -v http://192.168.31.31 -H &#x27;Host: bauth.qikqiak.com&#x27; -u &#x27;foo:foo&#x27;</span><br><span class="line">*   Trying 192.168.31.31...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 192.168.31.31 (192.168.31.31) port 80 (#0)</span><br><span class="line">* Server auth using Basic with user &#x27;foo&#x27;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">GET / HTTP/1.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Host: bauth.qikqiak.com</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Authorization: Basic Zm9vOmZvbw==</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">User-Agent: curl/7.64.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Accept: */*</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&lt; HTTP/1.1 200 OK</span></span><br><span class="line">&lt; Date: Thu, 16 Dec 2021 10:49:38 GMT</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">&lt; Content-Length: 615</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt; Last-Modified: Tue, 02 Nov 2021 14:49:22 GMT</span><br><span class="line">&lt; ETag: &quot;61814ff2-267&quot;</span><br><span class="line">&lt; Accept-Ranges: bytes</span><br><span class="line">&lt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">* Connection #0 to host 192.168.31.31 left intact</span><br><span class="line">* Closing connection 0</span><br></pre></td></tr></table></figure>



<p>å¯ä»¥çœ‹åˆ°å·²ç»è®¤è¯æˆåŠŸäº†ã€‚é™¤äº†å¯ä»¥ä½¿ç”¨æˆ‘ä»¬è‡ªå·±åœ¨æœ¬åœ°é›†ç¾¤åˆ›å»ºçš„ Auth ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å¤–éƒ¨çš„ Basic Auth è®¤è¯ä¿¡æ¯ï¼Œæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨ <code>https://httpbin.org</code> çš„å¤–éƒ¨ Basic Auth è®¤è¯ï¼Œåˆ›å»ºå¦‚ä¸‹æ‰€ç¤ºçš„ Ingress èµ„æºå¯¹è±¡ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># é…ç½®å¤–éƒ¨è®¤è¯æœåŠ¡åœ°å€</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-url:</span> <span class="string">https://httpbin.org/basic-auth/user/passwd</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">external-auth</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">external-bauth.qikqiak.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>ä¸Šé¢çš„èµ„æºå¯¹è±¡åˆ›å»ºå®Œæˆåï¼Œå†è¿›è¡Œç®€å•çš„æµ‹è¯•ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl get ingress</span><br><span class="line">NAME                CLASS    HOSTS                        ADDRESS         PORTS   AGE</span><br><span class="line">external-auth       &lt;none&gt;   external-bauth.qikqiak.com                   80      72s</span><br><span class="line">âœ curl -k http://192.168.31.31 -v -H &#x27;Host: external-bauth.qikqiak.com&#x27;</span><br><span class="line">*   Trying 192.168.31.31...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 192.168.31.31 (192.168.31.31) port 80 (#0)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">GET / HTTP/1.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Host: external-bauth.qikqiak.com</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">User-Agent: curl/7.64.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Accept: */*</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&lt; HTTP/1.1 401 Unauthorized</span></span><br><span class="line">&lt; Date: Thu, 16 Dec 2021 10:57:25 GMT</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">&lt; Content-Length: 172</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt; WWW-Authenticate: Basic realm=&quot;Fake Realm&quot;</span><br><span class="line">&lt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">* Connection #0 to host 192.168.31.31 left intact</span><br><span class="line">* Closing connection 0</span><br></pre></td></tr></table></figure>



<p>ç„¶åä½¿ç”¨æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç æµ‹è¯•ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">âœ curl -k http://192.168.31.31 -v -H &#x27;Host: external-bauth.qikqiak.com&#x27; -u &#x27;user:passwd&#x27;</span><br><span class="line">*   Trying 192.168.31.31...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 192.168.31.31 (192.168.31.31) port 80 (#0)</span><br><span class="line">* Server auth using Basic with user &#x27;user&#x27;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">GET / HTTP/1.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Host: external-bauth.qikqiak.com</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Authorization: Basic dXNlcjpwYXNzd2Q=</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">User-Agent: curl/7.64.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Accept: */*</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&lt; HTTP/1.1 200 OK</span></span><br><span class="line">&lt; Date: Thu, 16 Dec 2021 10:58:31 GMT</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">&lt; Content-Length: 615</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt; Last-Modified: Tue, 02 Nov 2021 14:49:22 GMT</span><br><span class="line">&lt; ETag: &quot;61814ff2-267&quot;</span><br><span class="line">&lt; Accept-Ranges: bytes</span><br><span class="line">&lt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">* Connection #0 to host 192.168.31.31 left intact</span><br><span class="line">* Closing connection 0</span><br></pre></td></tr></table></figure>



<p>å¦‚æœç”¨æˆ·åæˆ–è€…å¯†ç é”™è¯¯åˆ™åŒæ ·ä¼šå‡ºç° 401 çš„çŠ¶æ€ç ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">âœ curl -k http://192.168.31.31 -v -H &#x27;Host: external-bauth.qikqiak.com&#x27; -u &#x27;user:passwd123&#x27;</span><br><span class="line">*   Trying 192.168.31.31...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 192.168.31.31 (192.168.31.31) port 80 (#0)</span><br><span class="line">* Server auth using Basic with user &#x27;user&#x27;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">GET / HTTP/1.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Host: external-bauth.qikqiak.com</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Authorization: Basic dXNlcjpwYXNzd2QxMjM=</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">User-Agent: curl/7.64.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Accept: */*</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&lt; HTTP/1.1 401 Unauthorized</span></span><br><span class="line">&lt; Date: Thu, 16 Dec 2021 10:59:18 GMT</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">&lt; Content-Length: 172</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">* Authentication problem. Ignoring this.</span><br><span class="line">&lt; WWW-Authenticate: Basic realm=&quot;Fake Realm&quot;</span><br><span class="line">&lt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">* Connection #0 to host 192.168.31.31 left intact</span><br><span class="line">* Closing connection 0</span><br></pre></td></tr></table></figure>



<p>å½“ç„¶é™¤äº† Basic Auth è¿™ä¸€ç§ç®€å•çš„è®¤è¯æ–¹å¼ä¹‹å¤–ï¼Œ<code>ingress-nginx</code> è¿˜æ”¯æŒä¸€äº›å…¶ä»–é«˜çº§çš„è®¤è¯ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ GitHub OAuth æ¥è®¤è¯ Kubernetes çš„ Dashboardã€‚</p>
<h3 id="URL-Rewrite"><a href="#URL-Rewrite" class="headerlink" title="URL Rewrite"></a>URL Rewrite</h3><p><code>ingress-nginx</code> å¾ˆå¤šé«˜çº§çš„ç”¨æ³•å¯ä»¥é€šè¿‡ Ingress å¯¹è±¡çš„ <code>annotation</code> è¿›è¡Œé…ç½®ï¼Œæ¯”å¦‚å¸¸ç”¨çš„ URL Rewrite åŠŸèƒ½ã€‚å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¼šå°† <code>ingress-nginx</code> å½“æˆç½‘å…³ä½¿ç”¨ï¼Œæ¯”å¦‚å¯¹è®¿é—®çš„æœåŠ¡åŠ ä¸Š <code>/app</code> è¿™æ ·çš„å‰ç¼€ï¼Œåœ¨ <code>nginx</code> çš„é…ç½®é‡Œé¢æˆ‘ä»¬çŸ¥é“æœ‰ä¸€ä¸ª <code>proxy_pass</code> æŒ‡ä»¤å¯ä»¥å®ç°ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /app/ &#123;</span><br><span class="line">  proxy_pass http://127.0.0.1/remote/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>proxy_pass</code> åé¢åŠ äº† <code>/remote</code> è¿™ä¸ªè·¯å¾„ï¼Œæ­¤æ—¶ä¼šå°†åŒ¹é…åˆ°è¯¥è§„åˆ™è·¯å¾„ä¸­çš„ <code>/app</code> ç”¨ <code>/remote</code> æ›¿æ¢æ‰ï¼Œç›¸å½“äºæˆªæ‰è·¯å¾„ä¸­çš„ <code>/app</code>ã€‚åŒæ ·çš„åœ¨ Kubernetes ä¸­ä½¿ç”¨ <code>ingress-nginx</code> åˆè¯¥å¦‚ä½•æ¥å®ç°å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>rewrite-target</code> çš„æ³¨è§£æ¥å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œæ¯”å¦‚ç°åœ¨æˆ‘ä»¬æƒ³è¦é€šè¿‡ <code>rewrite.qikqiak.com/gateway/</code> æ¥è®¿é—®åˆ° Nginx æœåŠ¡ï¼Œåˆ™æˆ‘ä»¬éœ€è¦å¯¹è®¿é—®çš„ URL è·¯å¾„åšä¸€ä¸ª Rewriteï¼Œåœ¨ PATH ä¸­æ·»åŠ ä¸€ä¸ª gateway çš„å‰ç¼€ï¼Œå…³äº Rewrite çš„æ“ä½œåœ¨ <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/examples/rewrite/">ingress-nginx å®˜æ–¹æ–‡æ¡£</a>ä¸­ä¹Ÿç»™å‡ºå¯¹åº”çš„è¯´æ˜:</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/i5of9x.png" alt="ingress nginx rewrite"></p>
<p>æŒ‰ç…§è¦æ±‚æˆ‘ä»¬éœ€è¦åœ¨ <code>path</code> ä¸­åŒ¹é…å‰ç¼€ <code>gateway</code>ï¼Œç„¶åé€šè¿‡ <code>rewrite-target</code> æŒ‡å®šç›®æ ‡ï¼ŒIngress å¯¹è±¡å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rewrite</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/$2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">rewrite.qikqiak.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/gateway(/|$)(.*)</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>æ›´æ–°åï¼Œæˆ‘ä»¬å¯ä»¥é¢„è§åˆ°ç›´æ¥è®¿é—®åŸŸåè‚¯å®šæ˜¯ä¸è¡Œäº†ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰åŒ¹é… <code>/</code> çš„ path è·¯å¾„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ curl rewrite.qikqiak.com</span><br><span class="line">default backend - 404</span><br></pre></td></tr></table></figure>



<p>ä½†æ˜¯æˆ‘ä»¬å¸¦ä¸Š <code>gateway</code> çš„å‰ç¼€å†å»è®¿é—®:</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/wyxyuy.png" alt="ingress nginx rewrite"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å·²ç»å¯ä»¥è®¿é—®åˆ°äº†ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨ <code>path</code> ä¸­é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ <code>/gateway(/|$)(.*)</code> å°†åŒ¹é…çš„è·¯å¾„è®¾ç½®æˆäº† <code>rewrite-target</code> çš„ç›®æ ‡è·¯å¾„äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¿é—® <code>rewite.qikqiak.com/gateway/</code> çš„æ—¶å€™å®é™…ä¸Šç›¸å½“äºè®¿é—®çš„å°±æ˜¯åç«¯æœåŠ¡çš„ <code>/</code> è·¯å¾„ã€‚</p>
<p>è¦è§£å†³æˆ‘ä»¬è®¿é—®ä¸»åŸŸåå‡ºç° 404 çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç»™åº”ç”¨è®¾ç½®ä¸€ä¸ª <code>app-root</code> çš„æ³¨è§£ï¼Œè¿™æ ·å½“æˆ‘ä»¬è®¿é—®ä¸»åŸŸåçš„æ—¶å€™ä¼šè‡ªåŠ¨è·³è½¬åˆ°æˆ‘ä»¬æŒ‡å®šçš„ <code>app-root</code> ç›®å½•ä¸‹é¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rewrite</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/app-root:</span> <span class="string">/gateway/</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/$2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">rewrite.qikqiak.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/gateway(/|$)(.*)</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ›´æ–°åº”ç”¨åè®¿é—®ä¸»åŸŸå <code>rewrite.qikqiak.com</code> å°±ä¼šè‡ªåŠ¨è·³è½¬åˆ° <code>rewrite.qikqiak.com/gateway/</code> è·¯å¾„ä¸‹é¢å»äº†ã€‚ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯æˆ‘ä»¬çš„ path è·¯å¾„å…¶å®ä¹ŸåŒ¹é…äº† <code>/app</code> è¿™æ ·çš„è·¯å¾„ï¼Œå¯èƒ½æˆ‘ä»¬æ›´åŠ å¸Œæœ›æˆ‘ä»¬çš„åº”ç”¨åœ¨æœ€åæ·»åŠ ä¸€ä¸ª <code>/</code> è¿™æ ·çš„ slashï¼ŒåŒæ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>configuration-snippet</code> é…ç½®æ¥å®Œæˆï¼Œå¦‚ä¸‹ Ingress å¯¹è±¡ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rewrite</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/app-root:</span> <span class="string">/gateway/</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/$2</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/configuration-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      rewrite ^(/gateway)$ $1/ redirect;</span></span><br><span class="line"><span class="string"></span><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">rewrite.qikqiak.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/gateway(/|$)(.*)</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>æ›´æ–°åæˆ‘ä»¬çš„åº”ç”¨å°±éƒ½ä¼šä»¥ <code>/</code> è¿™æ ·çš„ slash ç»“å°¾äº†ã€‚è¿™æ ·å°±å®Œæˆäº†æˆ‘ä»¬çš„éœ€æ±‚ï¼Œå¦‚æœä½ åŸæœ¬å¯¹ nginx çš„é…ç½®å°±éå¸¸ç†Ÿæ‚‰çš„è¯åº”è¯¥å¯ä»¥å¾ˆå¿«å°±èƒ½ç†è§£è¿™ç§é…ç½®æ–¹å¼äº†ã€‚</p>
<h3 id="ç°åº¦å‘å¸ƒ"><a href="#ç°åº¦å‘å¸ƒ" class="headerlink" title="ç°åº¦å‘å¸ƒ"></a>ç°åº¦å‘å¸ƒ</h3><p>åœ¨æ—¥å¸¸å·¥ä½œä¸­æˆ‘ä»¬ç»å¸¸éœ€è¦å¯¹æœåŠ¡è¿›è¡Œç‰ˆæœ¬æ›´æ–°å‡çº§ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨åˆ°æ»šåŠ¨å‡çº§ã€è“ç»¿å‘å¸ƒã€ç°åº¦å‘å¸ƒç­‰ä¸åŒçš„å‘å¸ƒæ“ä½œã€‚è€Œ <code>ingress-nginx</code> æ”¯æŒé€šè¿‡ Annotations é…ç½®æ¥å®ç°ä¸åŒåœºæ™¯ä¸‹çš„ç°åº¦å‘å¸ƒå’Œæµ‹è¯•ï¼Œå¯ä»¥æ»¡è¶³é‡‘ä¸é›€å‘å¸ƒã€è“ç»¿éƒ¨ç½²ä¸ A&#x2F;B æµ‹è¯•ç­‰ä¸šåŠ¡åœºæ™¯ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#canary">ingress-nginx çš„ Annotations</a> æ”¯æŒä»¥ä¸‹ 4 ç§ Canary è§„åˆ™ï¼š</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/canary-by-header</code>ï¼šåŸºäº Request Header çš„æµé‡åˆ‡åˆ†ï¼Œé€‚ç”¨äºç°åº¦å‘å¸ƒä»¥åŠ A&#x2F;B æµ‹è¯•ã€‚å½“ Request Header è®¾ç½®ä¸º always æ—¶ï¼Œè¯·æ±‚å°†ä¼šè¢«ä¸€ç›´å‘é€åˆ° Canary ç‰ˆæœ¬ï¼›å½“ Request Header è®¾ç½®ä¸º never æ—¶ï¼Œè¯·æ±‚ä¸ä¼šè¢«å‘é€åˆ° Canary å…¥å£ï¼›å¯¹äºä»»ä½•å…¶ä»– Header å€¼ï¼Œå°†å¿½ç•¥ Headerï¼Œå¹¶é€šè¿‡ä¼˜å…ˆçº§å°†è¯·æ±‚ä¸å…¶ä»–é‡‘ä¸é›€è§„åˆ™è¿›è¡Œä¼˜å…ˆçº§çš„æ¯”è¾ƒã€‚</li>
<li><code>nginx.ingress.kubernetes.io/canary-by-header-value</code>ï¼šè¦åŒ¹é…çš„ Request Header çš„å€¼ï¼Œç”¨äºé€šçŸ¥ Ingress å°†è¯·æ±‚è·¯ç”±åˆ° Canary Ingress ä¸­æŒ‡å®šçš„æœåŠ¡ã€‚å½“ Request Header è®¾ç½®ä¸ºæ­¤å€¼æ—¶ï¼Œå®ƒå°†è¢«è·¯ç”±åˆ° Canary å…¥å£ã€‚è¯¥è§„åˆ™å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ Request Header çš„å€¼ï¼Œå¿…é¡»ä¸ä¸Šä¸€ä¸ª annotation (<code>canary-by-header</code>) ä¸€èµ·ä½¿ç”¨ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/canary-weight</code>ï¼šåŸºäºæœåŠ¡æƒé‡çš„æµé‡åˆ‡åˆ†ï¼Œé€‚ç”¨äºè“ç»¿éƒ¨ç½²ï¼Œæƒé‡èŒƒå›´ 0 - 100 æŒ‰ç™¾åˆ†æ¯”å°†è¯·æ±‚è·¯ç”±åˆ° Canary Ingress ä¸­æŒ‡å®šçš„æœåŠ¡ã€‚æƒé‡ä¸º 0 æ„å‘³ç€è¯¥é‡‘ä¸é›€è§„åˆ™ä¸ä¼šå‘ Canary å…¥å£çš„æœåŠ¡å‘é€ä»»ä½•è¯·æ±‚ï¼Œæƒé‡ä¸º 100 æ„å‘³ç€æ‰€æœ‰è¯·æ±‚éƒ½å°†è¢«å‘é€åˆ° Canary å…¥å£ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/canary-by-cookie</code>ï¼šåŸºäº cookie çš„æµé‡åˆ‡åˆ†ï¼Œé€‚ç”¨äºç°åº¦å‘å¸ƒä¸ A&#x2F;B æµ‹è¯•ã€‚ç”¨äºé€šçŸ¥ Ingress å°†è¯·æ±‚è·¯ç”±åˆ° Canary Ingress ä¸­æŒ‡å®šçš„æœåŠ¡çš„ cookieã€‚å½“ cookie å€¼è®¾ç½®ä¸º always æ—¶ï¼Œå®ƒå°†è¢«è·¯ç”±åˆ° Canary å…¥å£ï¼›å½“ cookie å€¼è®¾ç½®ä¸º never æ—¶ï¼Œè¯·æ±‚ä¸ä¼šè¢«å‘é€åˆ° Canary å…¥å£ï¼›å¯¹äºä»»ä½•å…¶ä»–å€¼ï¼Œå°†å¿½ç•¥ cookie å¹¶å°†è¯·æ±‚ä¸å…¶ä»–é‡‘ä¸é›€è§„åˆ™è¿›è¡Œä¼˜å…ˆçº§çš„æ¯”è¾ƒã€‚</li>
</ul>
<blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯é‡‘ä¸é›€è§„åˆ™æŒ‰ä¼˜å…ˆé¡ºåºè¿›è¡Œæ’åºï¼š<code>canary-by-header - &gt; canary-by-cookie - &gt; canary-weight</code></p>
</blockquote>
<p>æ€»çš„æ¥è¯´å¯ä»¥æŠŠä»¥ä¸Šçš„å››ä¸ª annotation è§„åˆ™åˆ’åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»ï¼š</p>
<ul>
<li>åŸºäºæƒé‡çš„ Canary è§„åˆ™ <img data-src="https://mudutestmenu.mudu.tv/upload/3orjn0.png" alt="åŸºäºæƒé‡çš„ Canary è§„åˆ™"></li>
<li>åŸºäºç”¨æˆ·è¯·æ±‚çš„ Canary è§„åˆ™ <img data-src="https://picdn.youdianzhishi.com/images/20201213130856.png" alt="åŸºäºç”¨æˆ·è¯·æ±‚çš„ Canary è§„åˆ™"></li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç¤ºä¾‹åº”ç”¨æ¥å¯¹ç°åº¦å‘å¸ƒåŠŸèƒ½è¿›è¡Œè¯´æ˜ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥. éƒ¨ç½² Production åº”ç”¨</strong></p>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª production ç¯å¢ƒçš„åº”ç”¨èµ„æºæ¸…å•ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># production.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">production</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">production</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">production</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">production</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">production</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">cnych/echoserver</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_IP</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">production</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">production</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">production</span></span><br></pre></td></tr></table></figure>



<p>ç„¶ååˆ›å»ºä¸€ä¸ªç”¨äº production ç¯å¢ƒè®¿é—®çš„ Ingress èµ„æºå¯¹è±¡ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># production-ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">production</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">echo.qikqiak.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">production</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>ç›´æ¥åˆ›å»ºä¸Šé¢çš„å‡ ä¸ªèµ„æºå¯¹è±¡ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl apply -f production.yaml</span><br><span class="line">âœ kubectl apply -f production-ingress.yaml</span><br><span class="line">âœ kubectl get pods -l app=production</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">production-856d5fb99-d6bds   1/1     Running   0          2m50s</span><br><span class="line">âœ kubectl get ingress</span><br><span class="line">NAME         CLASS    HOSTS                ADDRESS        PORTS   AGE</span><br><span class="line">production   &lt;none&gt;   echo.qikqiak.com     10.151.30.11   80      90s</span><br></pre></td></tr></table></figure>



<p>åº”ç”¨éƒ¨ç½²æˆåŠŸåï¼Œå°†åŸŸå <code>echo.qikqiak.com</code> æ˜ å°„åˆ° master1 èŠ‚ç‚¹ï¼ˆingress-nginx æ‰€åœ¨çš„èŠ‚ç‚¹ï¼‰çš„ IP å³å¯æ­£å¸¸è®¿é—®åº”ç”¨ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">âœ curl http://echo.qikqiak.com</span><br><span class="line"></span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line"></span><br><span class="line">Pod Information:</span><br><span class="line">    node name:  node1</span><br><span class="line">    pod name:   production-856d5fb99-d6bds</span><br><span class="line">    pod namespace:  default</span><br><span class="line">    pod IP: 10.244.1.111</span><br><span class="line"></span><br><span class="line">Server values:</span><br><span class="line">    server_version=nginx: 1.13.3 - lua: 10008</span><br><span class="line"></span><br><span class="line">Request Information:</span><br><span class="line">    client_address=10.244.0.0</span><br><span class="line">    method=GET</span><br><span class="line">    real path=/</span><br><span class="line">    query=</span><br><span class="line">    request_version=1.1</span><br><span class="line">    request_scheme=http</span><br><span class="line">    request_uri=http://echo.qikqiak.com:8080/</span><br><span class="line"></span><br><span class="line">Request Headers:</span><br><span class="line">    accept=*/*</span><br><span class="line">    host=echo.qikqiak.com</span><br><span class="line">    user-agent=curl/7.64.1</span><br><span class="line">    x-forwarded-for=171.223.99.184</span><br><span class="line">    x-forwarded-host=echo.qikqiak.com</span><br><span class="line">    x-forwarded-port=80</span><br><span class="line">    x-forwarded-proto=http</span><br><span class="line">    x-real-ip=171.223.99.184</span><br><span class="line">    x-request-id=e680453640169a7ea21afba8eba9e116</span><br><span class="line">    x-scheme=http</span><br><span class="line"></span><br><span class="line">Request Body:</span><br><span class="line">    -no body in request-</span><br></pre></td></tr></table></figure>



<p><strong>ç¬¬äºŒæ­¥. åˆ›å»º Canary ç‰ˆæœ¬</strong> å‚è€ƒå°†ä¸Šè¿° Production ç‰ˆæœ¬çš„ <code>production.yaml</code> æ–‡ä»¶ï¼Œå†åˆ›å»ºä¸€ä¸ª Canary ç‰ˆæœ¬çš„åº”ç”¨ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># canary.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">canary</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">canary</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">canary</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">cnych/echoserver</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_IP</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">canary</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">canary</span></span><br></pre></td></tr></table></figure>



<p>æ¥ä¸‹æ¥å°±å¯ä»¥é€šè¿‡é…ç½® Annotation è§„åˆ™è¿›è¡Œæµé‡åˆ‡åˆ†äº†ã€‚</p>
<p><strong>ç¬¬ä¸‰æ­¥. Annotation è§„åˆ™é…ç½®</strong></p>
<p><strong>1. åŸºäºæƒé‡</strong>ï¼šåŸºäºæƒé‡çš„æµé‡åˆ‡åˆ†çš„å…¸å‹åº”ç”¨åœºæ™¯å°±æ˜¯è“ç»¿éƒ¨ç½²ï¼Œå¯é€šè¿‡å°†æƒé‡è®¾ç½®ä¸º 0 æˆ– 100 æ¥å®ç°ã€‚ä¾‹å¦‚ï¼Œå¯å°† Green ç‰ˆæœ¬è®¾ç½®ä¸ºä¸»è¦éƒ¨åˆ†ï¼Œå¹¶å°† Blue ç‰ˆæœ¬çš„å…¥å£é…ç½®ä¸º Canaryã€‚æœ€åˆï¼Œå°†æƒé‡è®¾ç½®ä¸º 0ï¼Œå› æ­¤ä¸ä¼šå°†æµé‡ä»£ç†åˆ° Blue ç‰ˆæœ¬ã€‚ä¸€æ—¦æ–°ç‰ˆæœ¬æµ‹è¯•å’ŒéªŒè¯éƒ½æˆåŠŸåï¼Œå³å¯å°† Blue ç‰ˆæœ¬çš„æƒé‡è®¾ç½®ä¸º 100ï¼Œå³æ‰€æœ‰æµé‡ä» Green ç‰ˆæœ¬è½¬å‘ Blueã€‚</p>
<p>åˆ›å»ºä¸€ä¸ªåŸºäºæƒé‡çš„ Canary ç‰ˆæœ¬çš„åº”ç”¨è·¯ç”± Ingress å¯¹è±¡ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># canary-ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary:</span> <span class="string">&#x27;true&#x27;</span> <span class="comment"># è¦å¼€å¯ç°åº¦å‘å¸ƒæœºåˆ¶ï¼Œé¦–å…ˆéœ€è¦å¯ç”¨ Canary</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary-weight:</span> <span class="string">&#x27;30&#x27;</span> <span class="comment"># åˆ†é…30%æµé‡åˆ°å½“å‰Canaryç‰ˆæœ¬</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">echo.qikqiak.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">canary</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>ç›´æ¥åˆ›å»ºä¸Šé¢çš„èµ„æºå¯¹è±¡å³å¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl apply -f canary.yaml</span><br><span class="line">âœ kubectl apply -f canary-ingress.yaml</span><br><span class="line">âœ kubectl get pods</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">canary-66cb497b7f-48zx4      1/1     Running   0          7m48s</span><br><span class="line">production-856d5fb99-d6bds   1/1     Running   0          21m</span><br><span class="line">......</span><br><span class="line">âœ kubectl get svc</span><br><span class="line">NAME                       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">canary                     ClusterIP   10.106.91.106    &lt;none&gt;        80/TCP                       8m23s</span><br><span class="line">production                 ClusterIP   10.105.182.15    &lt;none&gt;        80/TCP                       22m</span><br><span class="line">......</span><br><span class="line">âœ kubectl get ingress</span><br><span class="line">NAME         CLASS    HOSTS                ADDRESS        PORTS   AGE</span><br><span class="line">canary       &lt;none&gt;   echo.qikqiak.com     10.151.30.11   80      108s</span><br><span class="line">production   &lt;none&gt;   echo.qikqiak.com     10.151.30.11   80      22m</span><br></pre></td></tr></table></figure>



<p>Canary ç‰ˆæœ¬åº”ç”¨åˆ›å»ºæˆåŠŸåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åœ¨å‘½ä»¤è¡Œç»ˆç«¯ä¸­æ¥ä¸æ–­è®¿é—®è¿™ä¸ªåº”ç”¨ï¼Œè§‚å¯Ÿ Hostname å˜åŒ–ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">âœ for i in $(seq 1 10); do curl -s echo.qikqiak.com | grep &quot;Hostname&quot;; done</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br></pre></td></tr></table></figure>



<p>ç”±äºæˆ‘ä»¬ç»™ Canary ç‰ˆæœ¬åº”ç”¨åˆ†é…äº† 30% å·¦å³æƒé‡çš„æµé‡ï¼Œæ‰€ä»¥ä¸Šé¢æˆ‘ä»¬è®¿é—® 10 æ¬¡æœ‰ 3 æ¬¡è®¿é—®åˆ°äº† Canary ç‰ˆæœ¬çš„åº”ç”¨ï¼Œç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚</p>
<p><strong>2. åŸºäº Request Header</strong>: åŸºäº Request Header è¿›è¡Œæµé‡åˆ‡åˆ†çš„å…¸å‹åº”ç”¨åœºæ™¯å³ç°åº¦å‘å¸ƒæˆ– A&#x2F;B æµ‹è¯•åœºæ™¯ã€‚</p>
<p>åœ¨ä¸Šé¢çš„ Canary ç‰ˆæœ¬çš„ Ingress å¯¹è±¡ä¸­æ–°å¢ä¸€æ¡ annotation é…ç½® <code>nginx.ingress.kubernetes.io/canary-by-header: canary</code>ï¼ˆè¿™é‡Œçš„ value å¯ä»¥æ˜¯ä»»æ„å€¼ï¼‰ï¼Œä½¿å½“å‰çš„ Ingress å®ç°åŸºäº Request Header è¿›è¡Œæµé‡åˆ‡åˆ†ï¼Œç”±äº <code>canary-by-header</code> çš„ä¼˜å…ˆçº§å¤§äº <code>canary-weight</code>ï¼Œæ‰€ä»¥ä¼šå¿½ç•¥åŸæœ‰çš„ <code>canary-weight</code> çš„è§„åˆ™ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/canary:</span> <span class="string">&#x27;true&#x27;</span> <span class="comment"># è¦å¼€å¯ç°åº¦å‘å¸ƒæœºåˆ¶ï¼Œé¦–å…ˆéœ€è¦å¯ç”¨ Canary</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class="string">canary</span> <span class="comment"># åŸºäºheaderçš„æµé‡åˆ‡åˆ†</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/canary-weight:</span> <span class="string">&#x27;30&#x27;</span> <span class="comment"># ä¼šè¢«å¿½ç•¥ï¼Œå› ä¸ºé…ç½®äº† canary-by-headerCanaryç‰ˆæœ¬</span></span><br></pre></td></tr></table></figure>



<p>æ›´æ–°ä¸Šé¢çš„ Ingress èµ„æºå¯¹è±¡åï¼Œæˆ‘ä»¬åœ¨è¯·æ±‚ä¸­åŠ å…¥ä¸åŒçš„ Header å€¼ï¼Œå†æ¬¡è®¿é—®åº”ç”¨çš„åŸŸåã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šå½“ Request Header è®¾ç½®ä¸º never æˆ– always æ—¶ï¼Œè¯·æ±‚å°†ä¸ä¼šæˆ–ä¸€ç›´è¢«å‘é€åˆ° Canary ç‰ˆæœ¬ï¼Œå¯¹äºä»»ä½•å…¶ä»– Header å€¼ï¼Œå°†å¿½ç•¥ Headerï¼Œå¹¶é€šè¿‡ä¼˜å…ˆçº§å°†è¯·æ±‚ä¸å…¶ä»– Canary è§„åˆ™è¿›è¡Œä¼˜å…ˆçº§çš„æ¯”è¾ƒã€‚</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">âœ for i in $(seq 1 10); do curl -s -H &quot;canary: never&quot; echo.qikqiak.com | grep &quot;Hostname&quot;; done</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br></pre></td></tr></table></figure>



<p>è¿™é‡Œæˆ‘ä»¬åœ¨è¯·æ±‚çš„æ—¶å€™è®¾ç½®äº† <code>canary: never</code> è¿™ä¸ª Header å€¼ï¼Œæ‰€ä»¥è¯·æ±‚æ²¡æœ‰å‘é€åˆ° Canary åº”ç”¨ä¸­å»ã€‚å¦‚æœè®¾ç½®ä¸ºå…¶ä»–å€¼å‘¢ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">âœ for i in $(seq 1 10); do curl -s -H &quot;canary: other-value&quot; echo.qikqiak.com | grep &quot;Hostname&quot;; done</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: production-856d5fb99-d6bds</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br></pre></td></tr></table></figure>



<p>ç”±äºæˆ‘ä»¬è¯·æ±‚è®¾ç½®çš„ Header å€¼ä¸º <code>canary: other-value</code>ï¼Œæ‰€ä»¥ ingress-nginx ä¼šé€šè¿‡ä¼˜å…ˆçº§å°†è¯·æ±‚ä¸å…¶ä»– Canary è§„åˆ™è¿›è¡Œä¼˜å…ˆçº§çš„æ¯”è¾ƒï¼Œæˆ‘ä»¬è¿™é‡Œä¹Ÿå°±ä¼šè¿›å…¥ <code>canary-weight: &quot;30&quot;</code> è¿™ä¸ªè§„åˆ™å»ã€‚</p>
<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨ä¸Šä¸€ä¸ª annotation (å³ <code>canary-by-header</code>ï¼‰çš„åŸºç¡€ä¸Šæ·»åŠ ä¸€æ¡ <code>nginx.ingress.kubernetes.io/canary-by-header-value: user-value</code> è¿™æ ·çš„è§„åˆ™ï¼Œå°±å¯ä»¥å°†è¯·æ±‚è·¯ç”±åˆ° Canary Ingress ä¸­æŒ‡å®šçš„æœåŠ¡äº†ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/canary:</span> <span class="string">&#x27;true&#x27;</span> <span class="comment"># è¦å¼€å¯ç°åº¦å‘å¸ƒæœºåˆ¶ï¼Œé¦–å…ˆéœ€è¦å¯ç”¨ Canary</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/canary-by-header-value:</span> <span class="string">user-value</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class="string">canary</span> <span class="comment"># åŸºäºheaderçš„æµé‡åˆ‡åˆ†</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/canary-weight:</span> <span class="string">&#x27;30&#x27;</span> <span class="comment"># åˆ†é…30%æµé‡åˆ°å½“å‰Canaryç‰ˆæœ¬</span></span><br></pre></td></tr></table></figure>



<p>åŒæ ·æ›´æ–° Ingress å¯¹è±¡åï¼Œé‡æ–°è®¿é—®åº”ç”¨ï¼Œå½“ Request Header æ»¡è¶³ <code>canary: user-value</code>æ—¶ï¼Œæ‰€æœ‰è¯·æ±‚å°±ä¼šè¢«è·¯ç”±åˆ° Canary ç‰ˆæœ¬ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">âœ for i in $(seq 1 10); do curl -s -H &quot;canary: user-value&quot; echo.qikqiak.com | grep &quot;Hostname&quot;; done</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br></pre></td></tr></table></figure>



<p><strong>3. åŸºäº Cookie</strong>ï¼šä¸åŸºäº Request Header çš„ annotation ç”¨æ³•è§„åˆ™ç±»ä¼¼ã€‚ä¾‹å¦‚åœ¨ A&#x2F;B æµ‹è¯•åœºæ™¯ä¸‹ï¼Œéœ€è¦è®©åœ°åŸŸä¸ºåŒ—äº¬çš„ç”¨æˆ·è®¿é—® Canary ç‰ˆæœ¬ã€‚é‚£ä¹ˆå½“ cookie çš„ annotation è®¾ç½®ä¸º <code>nginx.ingress.kubernetes.io/canary-by-cookie: &quot;users_from_Beijing&quot;</code>ï¼Œæ­¤æ—¶åå°å¯å¯¹ç™»å½•çš„ç”¨æˆ·è¯·æ±‚è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœè¯¥ç”¨æˆ·è®¿é—®æºæ¥è‡ªåŒ—äº¬åˆ™è®¾ç½® cookie <code>users_from_Beijing</code> çš„å€¼ä¸º <code>always</code>ï¼Œè¿™æ ·å°±å¯ä»¥ç¡®ä¿åŒ—äº¬çš„ç”¨æˆ·ä»…è®¿é—® Canary ç‰ˆæœ¬ã€‚</p>
<p>åŒæ ·æˆ‘ä»¬æ›´æ–° Canary ç‰ˆæœ¬çš„ Ingress èµ„æºå¯¹è±¡ï¼Œé‡‡ç”¨åŸºäº Cookie æ¥è¿›è¡Œæµé‡åˆ‡åˆ†ï¼Œ</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/canary:</span> <span class="string">&#x27;true&#x27;</span> <span class="comment"># è¦å¼€å¯ç°åº¦å‘å¸ƒæœºåˆ¶ï¼Œé¦–å…ˆéœ€è¦å¯ç”¨ Canary</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/canary-by-cookie:</span> <span class="string">&#x27;users_from_Beijing&#x27;</span> <span class="comment"># åŸºäº cookie</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/canary-weight:</span> <span class="string">&#x27;30&#x27;</span> <span class="comment"># ä¼šè¢«å¿½ç•¥ï¼Œå› ä¸ºé…ç½®äº† canary-by-cookie</span></span><br></pre></td></tr></table></figure>



<p>æ›´æ–°ä¸Šé¢çš„ Ingress èµ„æºå¯¹è±¡åï¼Œæˆ‘ä»¬åœ¨è¯·æ±‚ä¸­è®¾ç½®ä¸€ä¸ª <code>users_from_Beijing=always</code> çš„ Cookie å€¼ï¼Œå†æ¬¡è®¿é—®åº”ç”¨çš„åŸŸåã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">âœ for i in $(seq 1 10); do curl -s -b &quot;users_from_Beijing=always&quot; echo.qikqiak.com | grep &quot;Hostname&quot;; done</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br><span class="line">Hostname: canary-66cb497b7f-48zx4</span><br></pre></td></tr></table></figure>



<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åº”ç”¨éƒ½è¢«è·¯ç”±åˆ°äº† Canary ç‰ˆæœ¬çš„åº”ç”¨ä¸­å»äº†ï¼Œå¦‚æœæˆ‘ä»¬å°†è¿™ä¸ª Cookie å€¼è®¾ç½®ä¸º neverï¼Œåˆ™ä¸ä¼šè·¯ç”±åˆ° Canary åº”ç”¨ä¸­ã€‚</p>
<h3 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h3><p>å¦‚æœæˆ‘ä»¬éœ€è¦ç”¨ HTTPS æ¥è®¿é—®æˆ‘ä»¬è¿™ä¸ªåº”ç”¨çš„è¯ï¼Œå°±éœ€è¦ç›‘å¬ 443 ç«¯å£äº†ï¼ŒåŒæ ·ç”¨ HTTPS è®¿é—®åº”ç”¨å¿…ç„¶å°±éœ€è¦è¯ä¹¦ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨ <code>openssl</code> æ¥åˆ›å»ºä¸€ä¸ªè‡ªç­¾åçš„è¯ä¹¦ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/CN=foo.bar.com&quot;</span><br></pre></td></tr></table></figure>



<p>ç„¶åé€šè¿‡ Secret å¯¹è±¡æ¥å¼•ç”¨è¯ä¹¦æ–‡ä»¶ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¦æ³¨æ„è¯ä¹¦æ–‡ä»¶åç§°å¿…é¡»æ˜¯ tls.crt å’Œ tls.key</span></span><br><span class="line">âœ kubectl create secret tls foo-tls --cert=tls.crt --key=tls.key</span><br><span class="line">secret/who-tls created</span><br></pre></td></tr></table></figure>



<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸€ä¸ª HTTPS è®¿é—®åº”ç”¨çš„ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-with-auth</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># è®¤è¯ç±»å‹</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-type:</span> <span class="string">basic</span></span><br><span class="line">    <span class="comment"># åŒ…å« user/password å®šä¹‰çš„ secret å¯¹è±¡å</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-secret:</span> <span class="string">basic-auth</span></span><br><span class="line">    <span class="comment"># è¦æ˜¾ç¤ºçš„å¸¦æœ‰é€‚å½“ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯ï¼Œè¯´æ˜éœ€è¦èº«ä»½éªŒè¯çš„åŸå› </span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-realm:</span> <span class="string">&#x27;Authentication Required - foo&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tls:</span> <span class="comment"># é…ç½® tls è¯ä¹¦</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">foo.bar.com</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">foo-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">foo.bar.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>é™¤äº†è‡ªç­¾åè¯ä¹¦æˆ–è€…è´­ä¹°æ­£è§„æœºæ„çš„ CA è¯ä¹¦ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä¸€äº›å·¥å…·æ¥è‡ªåŠ¨ç”Ÿæˆåˆæ³•çš„è¯ä¹¦ï¼Œ<a target="_blank" rel="noopener" href="https://cert-manager.io/">cert-manager</a> æ˜¯ä¸€ä¸ªäº‘åŸç”Ÿè¯ä¹¦ç®¡ç†å¼€æºé¡¹ç›®ï¼Œå¯ä»¥ç”¨äºåœ¨ Kubernetes é›†ç¾¤ä¸­æä¾› HTTPS è¯ä¹¦å¹¶è‡ªåŠ¨ç»­æœŸï¼Œæ”¯æŒ <code>Let&#39;s Encrypt/HashiCorp/Vault</code> è¿™äº›å…è´¹è¯ä¹¦çš„ç­¾å‘ã€‚åœ¨ Kubernetes ä¸­ï¼Œå¯ä»¥é€šè¿‡ Kubernetes Ingress å’Œ Letâ€™s Encrypt å®ç°å¤–éƒ¨æœåŠ¡çš„è‡ªåŠ¨åŒ– HTTPSã€‚</p>
<h3 id="TCP-ä¸-UDP"><a href="#TCP-ä¸-UDP" class="headerlink" title="TCP ä¸ UDP"></a>TCP ä¸ UDP</h3><p>ç”±äºåœ¨ Ingress èµ„æºå¯¹è±¡ä¸­æ²¡æœ‰ç›´æ¥å¯¹ TCP æˆ– UDP æœåŠ¡çš„æ”¯æŒï¼Œè¦åœ¨ <code>ingress-nginx</code> ä¸­æä¾›æ”¯æŒï¼Œéœ€è¦åœ¨æ§åˆ¶å™¨å¯åŠ¨å‚æ•°ä¸­æ·»åŠ  <code>--tcp-services-configmap</code> å’Œ <code>--udp-services-configmap</code> æ ‡å¿—æŒ‡å‘ä¸€ä¸ª ConfigMapï¼Œå…¶ä¸­çš„ key æ˜¯è¦ä½¿ç”¨çš„å¤–éƒ¨ç«¯å£ï¼Œvalue å€¼æ˜¯ä½¿ç”¨æ ¼å¼ <code>&lt;namespace/service name&gt;:&lt;service port&gt;:[PROXY]:[PROXY]</code> æš´éœ²çš„æœåŠ¡ï¼Œç«¯å£å¯ä»¥ä½¿ç”¨ç«¯å£å·æˆ–è€…ç«¯å£åç§°ï¼Œæœ€åä¸¤ä¸ªå­—æ®µæ˜¯å¯é€‰çš„ï¼Œç”¨äºé…ç½® PROXY ä»£ç†ã€‚</p>
<p>æ¯”å¦‚ç°åœ¨æˆ‘ä»¬è¦é€šè¿‡ <code>ingress-nginx</code> æ¥æš´éœ²ä¸€ä¸ª MongoDB æœåŠ¡ï¼Œé¦–å…ˆåˆ›å»ºå¦‚ä¸‹çš„åº”ç”¨ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mongo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mongo</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mongo</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongo</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">mongo:4.0</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">27017</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data/db</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mongo</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">27017</span></span><br></pre></td></tr></table></figure>



<p>ç›´æ¥åˆ›å»ºä¸Šé¢çš„èµ„æºå¯¹è±¡ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl apply -f mongo.yaml</span><br><span class="line">âœ kubectl get svc</span><br><span class="line">NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)     AGE</span><br><span class="line">mongo           ClusterIP   10.98.117.228    &lt;none&gt;        27017/TCP   2m26s</span><br><span class="line">âœ kubectl get pods -l app=mongo</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">mongo-84c587f547-gd7pv   1/1     Running   0          2m5s</span><br></pre></td></tr></table></figure>



<p>ç°åœ¨æˆ‘ä»¬è¦é€šè¿‡ <code>ingress-nginx</code> æ¥æš´éœ²ä¸Šé¢çš„ MongoDB æœåŠ¡ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„ ConfigMapï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tcp-services</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">&#x27;27017&#x27;:</span> <span class="string">default/mongo:27017</span></span><br></pre></td></tr></table></figure>



<p>ç„¶ååœ¨ <code>ingress-nginx</code> çš„å¯åŠ¨å‚æ•°ä¸­æ·»åŠ  <code>--tcp-services-configmap=$(POD_NAMESPACE)/ingress-nginx-tcp</code> è¿™æ ·çš„é…ç½®å³å¯ï¼Œç”±äºæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ Helm Chart è¿›è¡Œå®‰è£…çš„ï¼Œæˆ‘ä»¬åªéœ€è¦å»è¦†ç›– Values å€¼é‡æ–°å®‰è£…å³å¯ï¼Œä¿®æ”¹ <code>ci/daemonset-prod.yaml</code> æ–‡ä»¶ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ci/daemonset-prod.yaml</span></span><br><span class="line"><span class="comment"># ...... å…¶ä»–éƒ¨åˆ†çœç•¥ï¼Œå’Œä¹‹å‰çš„ä¿æŒä¸€è‡´</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tcp:</span> <span class="comment"># é…ç½® tcp æœåŠ¡</span></span><br><span class="line">  <span class="attr">27017:</span> <span class="string">&#x27;default/mongo:27017&#x27;</span> <span class="comment"># ä½¿ç”¨ 27017 ç«¯å£å»æ˜ å°„ mongo æœåŠ¡</span></span><br><span class="line">  <span class="comment"># 9000: &quot;default/test:8080&quot;   # å¦‚æœè¿˜éœ€è¦æš´éœ²å…¶ä»– TCP æœåŠ¡ï¼Œç»§ç»­æ·»åŠ å³å¯</span></span><br></pre></td></tr></table></figure>



<p>é…ç½®å®Œæˆåé‡æ–°æ›´æ–°å½“å‰çš„ <code>ingress-nginx</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ helm upgrade --install ingress-nginx . -f ./ci/daemonset-prod.yaml --namespace ingress-nginx</span><br></pre></td></tr></table></figure>



<p>é‡æ–°éƒ¨ç½²å®Œæˆåä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåä¸º <code>ingress-nginx-tcp</code> çš„ ConfigMap å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl get configmap -n ingress-nginx ingress-nginx-tcp -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  &quot;27017&quot;: default/mongo:27017</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  ......</span><br><span class="line">  name: ingress-nginx-tcp</span><br><span class="line">  namespace: ingress-nginx</span><br></pre></td></tr></table></figure>



<p>åœ¨ <code>ingress-nginx</code> çš„å¯åŠ¨å‚æ•°ä¸­ä¹Ÿæ·»åŠ ä¸Š <code>--tcp-services-configmap=$(POD_NAMESPACE)/ingress-nginx-tcp</code> è¿™æ ·çš„é…ç½®ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl get pods -n ingress-nginx</span><br><span class="line">NAME                                            READY   STATUS    RESTARTS        AGE</span><br><span class="line">ingress-nginx-controller-gc582                  1/1     Running   0               5m17s</span><br><span class="line">âœ kubectl get pod ingress-nginx-controller-gc582 -n ingress-nginx -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">......</span><br><span class="line">  containers:</span><br><span class="line">  - args:</span><br><span class="line">    - /nginx-ingress-controller</span><br><span class="line">    - --default-backend-service=$(POD_NAMESPACE)/ingress-nginx-defaultbackend</span><br><span class="line">    - --election-id=ingress-controller-leader</span><br><span class="line">    - --controller-class=k8s.io/ingress-nginx</span><br><span class="line">    - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller</span><br><span class="line">    - --tcp-services-configmap=$(POD_NAMESPACE)/ingress-nginx-tcp  # tcp é…ç½®å‚æ•°</span><br><span class="line">    - --validating-webhook=:8443</span><br><span class="line">    - --validating-webhook-certificate=/usr/local/certificates/cert</span><br><span class="line">    - --validating-webhook-key=/usr/local/certificates/key</span><br><span class="line">......</span><br><span class="line">    ports:</span><br><span class="line">......</span><br><span class="line">    - containerPort: 27017</span><br><span class="line">      hostPort: 27017</span><br><span class="line">      name: 27017-tcp</span><br><span class="line">      protocol: TCP</span><br><span class="line">......</span><br></pre></td></tr></table></figure>



<p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <code>ingress-nginx</code> æš´éœ²çš„ 27017 ç«¯å£å»è®¿é—® Mongo æœåŠ¡äº†ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">âœ mongo --host 192.168.31.31 --port 27017</span><br><span class="line">MongoDB shell version v4.0.3</span><br><span class="line">connecting to: mongodb://192.168.31.31:27017/</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;10f462eb-32b8-443b-ad85-99820db1aaa0&quot;) &#125;</span><br><span class="line">MongoDB server version: 4.0.27</span><br><span class="line">......</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">show dbs</span></span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local   0.000GB</span><br><span class="line"><span class="meta prompt_">&gt;</span></span><br></pre></td></tr></table></figure>



<p>åŒæ ·çš„æˆ‘ä»¬ä¹Ÿå¯ä»¥å»æŸ¥çœ‹æœ€ç»ˆç”Ÿæˆçš„ <code>nginx.conf</code> é…ç½®æ–‡ä»¶ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl exec -it ingress-nginx-controller-gc582 -n ingress-nginx -- cat /etc/nginx/nginx.conf</span><br><span class="line">......</span><br><span class="line">stream &#123;</span><br><span class="line">    ......</span><br><span class="line">    # TCP services</span><br><span class="line">    server &#123;</span><br><span class="line">            preread_by_lua_block &#123;</span><br><span class="line">                    ngx.var.proxy_upstream_name=&quot;tcp-default-mongo-27017&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">            listen                  27017;</span><br><span class="line">            listen                  [::]:27017;</span><br><span class="line">            proxy_timeout           600s;</span><br><span class="line">            proxy_next_upstream     on;</span><br><span class="line">            proxy_next_upstream_timeout 600s;</span><br><span class="line">            proxy_next_upstream_tries   3;</span><br><span class="line">            proxy_pass              upstream_balancer;</span><br><span class="line">    &#125;</span><br><span class="line">    # UDP services</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>TCP ç›¸å…³çš„é…ç½®ä½äº <code>stream</code> é…ç½®å—ä¸‹é¢ã€‚ä» Nginx 1.9.13 ç‰ˆæœ¬å¼€å§‹æä¾› UDP è´Ÿè½½å‡è¡¡ï¼ŒåŒæ ·æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ <code>ingress-nginx</code> ä¸­æ¥ä»£ç† UDP æœåŠ¡ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥å»æš´éœ² <code>kube-dns</code> çš„æœåŠ¡ï¼ŒåŒæ ·éœ€è¦åˆ›å»ºä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„ ConfigMapï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">udp-services</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">53:</span> <span class="string">&#x27;kube-system/kube-dns:53&#x27;</span></span><br></pre></td></tr></table></figure>



<p>ç„¶åéœ€è¦åœ¨ <code>ingress-nginx</code> å‚æ•°ä¸­æ·»åŠ ä¸€ä¸ª <code>- --udp-services-configmap=$(POD_NAMESPACE)/udp-services</code> è¿™æ ·çš„é…ç½®ï¼Œå½“ç„¶æˆ‘ä»¬è¿™é‡Œåªéœ€è¦å»ä¿®æ”¹ Values æ–‡ä»¶å€¼å³å¯ï¼Œä¿®æ”¹ <code>ci/daemonset-prod.yaml</code> æ–‡ä»¶ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ci/daemonset-prod.yaml</span></span><br><span class="line"><span class="comment"># ...... å…¶ä»–éƒ¨åˆ†çœç•¥ï¼Œå’Œä¹‹å‰çš„ä¿æŒä¸€è‡´</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tcp:</span> <span class="comment"># é…ç½® tcp æœåŠ¡</span></span><br><span class="line">  <span class="attr">27017:</span> <span class="string">&#x27;default/mongo:27017&#x27;</span> <span class="comment"># ä½¿ç”¨ 27017 ç«¯å£å»æ˜ å°„ mongo æœåŠ¡</span></span><br><span class="line">  <span class="comment"># 9000: &quot;default/test:8080&quot;   # å¦‚æœè¿˜éœ€è¦æš´éœ²å…¶ä»– TCP æœåŠ¡ï¼Œç»§ç»­æ·»åŠ å³å¯</span></span><br><span class="line"></span><br><span class="line"><span class="attr">udp:</span> <span class="comment"># é…ç½® udp æœåŠ¡</span></span><br><span class="line">  <span class="attr">53:</span> <span class="string">&#x27;kube-system/kube-dns:53&#x27;</span></span><br></pre></td></tr></table></figure>



<p>ç„¶åé‡æ–°æ›´æ–°å³å¯ã€‚</p>
<h3 id="å…¨å±€é…ç½®"><a href="#å…¨å±€é…ç½®" class="headerlink" title="å…¨å±€é…ç½®"></a>å…¨å±€é…ç½®</h3><p>é™¤äº†å¯ä»¥é€šè¿‡ <code>annotations</code> å¯¹æŒ‡å®šçš„ Ingress è¿›è¡Œå®šåˆ¶ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é…ç½® <code>ingress-nginx</code> çš„å…¨å±€é…ç½®ï¼Œåœ¨æ§åˆ¶å™¨å¯åŠ¨å‚æ•°ä¸­é€šè¿‡æ ‡å¿— <code>--configmap</code> æŒ‡å®šäº†ä¸€ä¸ªå…¨å±€çš„ ConfigMap å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¨å±€çš„ä¸€äº›é…ç½®ç›´æ¥å®šä¹‰åœ¨è¯¥å¯¹è±¡ä¸­å³å¯ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/nginx-ingress-controller</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--configmap=$(POD_NAMESPACE)/ingress-nginx-controller</span></span><br><span class="line">    <span class="string">......</span></span><br></pre></td></tr></table></figure>



<p>æ¯”å¦‚è¿™é‡Œæˆ‘ä»¬ç”¨äºå…¨å±€é…ç½®çš„ ConfigMap åä¸º <code>ingress-nginx-controller</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl get configmap -n ingress-nginx</span><br><span class="line">NAME                        DATA   AGE</span><br><span class="line">ingress-nginx-controller    1      5d2h</span><br></pre></td></tr></table></figure>



<p>æ¯”å¦‚æˆ‘ä»¬å¯ä»¥æ·»åŠ å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€äº›å¸¸ç”¨é…ç½®ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">âœ</span> <span class="string">kubectl</span> <span class="string">edit</span> <span class="string">configmap</span> <span class="string">ingress-nginx-controller</span> <span class="string">-n</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">allow-snippet-annotations:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">client-header-buffer-size:</span> <span class="string">32k</span>  <span class="comment"># æ³¨æ„ä¸æ˜¯ä¸‹åˆ’çº¿</span></span><br><span class="line">  <span class="attr">client-max-body-size:</span> <span class="string">5m</span></span><br><span class="line">  <span class="attr">use-gzip:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">gzip-level:</span> <span class="string">&quot;7&quot;</span></span><br><span class="line">  <span class="attr">large-client-header-buffers:</span> <span class="number">4</span> <span class="string">32k</span></span><br><span class="line">  <span class="attr">proxy-connect-timeout:</span> <span class="string">11s</span></span><br><span class="line">  <span class="attr">proxy-read-timeout:</span> <span class="string">12s</span></span><br><span class="line">  <span class="attr">keep-alive:</span> <span class="string">&quot;75&quot;</span>   <span class="comment"># å¯ç”¨keep-aliveï¼Œè¿æ¥å¤ç”¨ï¼Œæé«˜QPS</span></span><br><span class="line">  <span class="attr">keep-alive-requests:</span> <span class="string">&quot;100&quot;</span></span><br><span class="line">  <span class="attr">upstream-keepalive-connections:</span> <span class="string">&quot;10000&quot;</span></span><br><span class="line">  <span class="attr">upstream-keepalive-requests:</span> <span class="string">&quot;100&quot;</span></span><br><span class="line">  <span class="attr">upstream-keepalive-timeout:</span> <span class="string">&quot;60&quot;</span></span><br><span class="line">  <span class="attr">disable-ipv6:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">disable-ipv6-dns:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">max-worker-connections:</span> <span class="string">&quot;65535&quot;</span></span><br><span class="line">  <span class="attr">max-worker-open-files:</span> <span class="string">&quot;10240&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="string">......</span></span><br></pre></td></tr></table></figure>



<p>ä¿®æ”¹å®Œæˆå Nginx é…ç½®ä¼šè‡ªåŠ¨é‡è½½ç”Ÿæ•ˆï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ <code>nginx.conf</code> é…ç½®æ–‡ä»¶è¿›è¡ŒéªŒè¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl exec -it ingress-nginx-controller-gc582 -n ingress-nginx -- cat /etc/nginx/nginx.conf |grep large_client_header_buffers</span><br><span class="line">        large_client_header_buffers     4 32k;</span><br></pre></td></tr></table></figure>



<p>ç”±äºæˆ‘ä»¬è¿™é‡Œæ˜¯ Helm Chart å®‰è£…çš„ï¼Œä¸ºäº†ä¿è¯é‡æ–°éƒ¨ç½²åé…ç½®è¿˜åœ¨ï¼Œæˆ‘ä»¬åŒæ ·éœ€è¦é€šè¿‡ Values è¿›è¡Œå…¨å±€é…ç½®ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ci/daemonset-prod.yaml</span></span><br><span class="line"><span class="attr">controller:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">allow-snippet-annotations:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">client-header-buffer-size:</span> <span class="string">32k</span> <span class="comment"># æ³¨æ„ä¸æ˜¯ä¸‹åˆ’çº¿</span></span><br><span class="line">    <span class="attr">client-max-body-size:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">use-gzip:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">gzip-level:</span> <span class="string">&#x27;7&#x27;</span></span><br><span class="line">    <span class="attr">large-client-header-buffers:</span> <span class="number">4</span> <span class="string">32k</span></span><br><span class="line">    <span class="attr">proxy-connect-timeout:</span> <span class="string">11s</span></span><br><span class="line">    <span class="attr">proxy-read-timeout:</span> <span class="string">12s</span></span><br><span class="line">    <span class="attr">keep-alive:</span> <span class="string">&#x27;75&#x27;</span> <span class="comment"># å¯ç”¨keep-aliveï¼Œè¿æ¥å¤ç”¨ï¼Œæé«˜QPS</span></span><br><span class="line">    <span class="attr">keep-alive-requests:</span> <span class="string">&#x27;100&#x27;</span></span><br><span class="line">    <span class="attr">upstream-keepalive-connections:</span> <span class="string">&#x27;10000&#x27;</span></span><br><span class="line">    <span class="attr">upstream-keepalive-requests:</span> <span class="string">&#x27;100&#x27;</span></span><br><span class="line">    <span class="attr">upstream-keepalive-timeout:</span> <span class="string">&#x27;60&#x27;</span></span><br><span class="line">    <span class="attr">disable-ipv6:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">disable-ipv6-dns:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">max-worker-connections:</span> <span class="string">&#x27;65535&#x27;</span></span><br><span class="line">    <span class="attr">max-worker-open-files:</span> <span class="string">&#x27;10240&#x27;</span></span><br><span class="line"><span class="comment"># å…¶ä»–çœç•¥</span></span><br></pre></td></tr></table></figure>



<p>æ­¤å¤–å¾€å¾€æˆ‘ä»¬è¿˜éœ€è¦å¯¹ <code>ingress-nginx</code> éƒ¨ç½²çš„èŠ‚ç‚¹è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œä¿®æ”¹ä¸€äº›å†…æ ¸å‚æ•°ï¼Œä½¿å¾—é€‚é… Nginx çš„ä½¿ç”¨åœºæ™¯ï¼Œä¸€èˆ¬æˆ‘ä»¬æ˜¯ç›´æ¥å»ä¿®æ”¹èŠ‚ç‚¹ä¸Šçš„å†…æ ¸å‚æ•°ï¼Œä¸ºäº†èƒ½å¤Ÿç»Ÿä¸€ç®¡ç†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>initContainers</code> æ¥è¿›è¡Œé…ç½®ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">initContainers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">    mount -o remount rw /proc/sys</span></span><br><span class="line"><span class="string">    sysctl -w net.core.somaxconn=65535  # å…·ä½“çš„é…ç½®è§†å…·ä½“æƒ…å†µè€Œå®š</span></span><br><span class="line"><span class="string">    sysctl -w net.ipv4.tcp_tw_reuse=1</span></span><br><span class="line"><span class="string">    sysctl -w net.ipv4.ip_local_port_range=&quot;1024 65535&quot;</span></span><br><span class="line"><span class="string">    sysctl -w fs.file-max=1048576</span></span><br><span class="line"><span class="string">    sysctl -w fs.inotify.max_user_instances=16384</span></span><br><span class="line"><span class="string">    sysctl -w fs.inotify.max_user_watches=524288</span></span><br><span class="line"><span class="string">    sysctl -w fs.inotify.max_queued_events=16384</span></span><br><span class="line"><span class="string"></span><span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">init-sysctl</span></span><br><span class="line"><span class="attr">securityContext:</span></span><br><span class="line">  <span class="attr">capabilities:</span></span><br><span class="line">    <span class="attr">add:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">SYS_ADMIN</span></span><br><span class="line">    <span class="attr">drop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line"><span class="string">......</span></span><br></pre></td></tr></table></figure>



<p>ç”±äºæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ Helm Chart å®‰è£…çš„ <code>ingress-nginx</code>ï¼ŒåŒæ ·åªéœ€è¦å»é…ç½® Values å€¼å³å¯ï¼Œæ¨¡æ¿ä¸­æä¾›äº†å¯¹ <code>initContainers</code> çš„æ”¯æŒï¼Œé…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">controller:</span></span><br><span class="line">  <span class="comment"># å…¶ä»–çœç•¥ï¼Œé…ç½® initContainers</span></span><br><span class="line">  <span class="attr">extraInitContainers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-sysctl</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">capabilities:</span></span><br><span class="line">          <span class="attr">add:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">SYS_ADMIN</span></span><br><span class="line">          <span class="attr">drop:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          mount -o remount rw /proc/sys</span></span><br><span class="line"><span class="string">          sysctl -w net.core.somaxconn=65535  # socketç›‘å¬çš„backlogä¸Šé™</span></span><br><span class="line"><span class="string">          sysctl -w net.ipv4.tcp_tw_reuse=1  # å¼€å¯é‡ç”¨ï¼Œå…è®¸å°† TIME-WAIT sockets é‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥</span></span><br><span class="line"><span class="string">          sysctl -w net.ipv4.ip_local_port_range=&quot;1024 65535&quot;</span></span><br><span class="line"><span class="string">          sysctl -w fs.file-max=1048576</span></span><br><span class="line"><span class="string">          sysctl -w fs.inotify.max_user_instances=16384</span></span><br><span class="line"><span class="string">          sysctl -w fs.inotify.max_user_watches=524288</span></span><br><span class="line"><span class="string">          sysctl -w fs.inotify.max_queued_events=16384</span></span><br></pre></td></tr></table></figure>



<p>åŒæ ·é‡æ–°éƒ¨ç½²å³å¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ helm upgrade --install ingress-nginx . -f ./ci/daemonset-prod.yaml --namespace ingress-nginx</span><br></pre></td></tr></table></figure>



<p>éƒ¨ç½²å®Œæˆåé€šè¿‡ <code>initContainers</code> å°±å¯ä»¥ä¿®æ”¹èŠ‚ç‚¹å†…æ ¸å‚æ•°äº†ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®å¯¹èŠ‚ç‚¹å†…æ ¸å‚æ•°è¿›è¡Œç›¸åº”çš„ä¼˜åŒ–ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/k8s%20ReplicaSet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="å…­ä¸€">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/k8s%20ReplicaSet/" class="post-title-link" itemprop="url">k8s ReplicaSet</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-11 20:32:34 / ä¿®æ”¹æ—¶é—´ï¼š21:43:46" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/%E9%9D%A2%E8%AF%95%E9%A2%98/" itemprop="url" rel="index"><span itemprop="name">é¢è¯•é¢˜</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>2k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>2 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="ReplicaSet-ç®€ç§°-RS-å’Œ-ReplicationController-ç®€ç§°-RC-çš„åŒºåˆ«"><a href="#ReplicaSet-ç®€ç§°-RS-å’Œ-ReplicationController-ç®€ç§°-RC-çš„åŒºåˆ«" class="headerlink" title="ReplicaSet (ç®€ç§° RS) å’Œ ReplicationController (ç®€ç§° RC) çš„åŒºåˆ«"></a>ReplicaSet (ç®€ç§° RS) å’Œ ReplicationController (ç®€ç§° RC) çš„åŒºåˆ«</h3><p>ä»åŠŸèƒ½ä¸Šè®²ï¼ŒReplicaSet å’Œ ReplicationController çš„æ ¸å¿ƒç›®æ ‡æ˜¯<strong>ä¸€è‡´çš„</strong>ï¼š</p>
<ul>
<li><strong>ç¡®ä¿æŒ‡å®šæ•°é‡çš„ Pod å‰¯æœ¬å§‹ç»ˆåœ¨è¿è¡Œã€‚</strong></li>
<li><strong>å½“ Pod å‘ç”Ÿæ•…éšœã€åˆ é™¤æˆ–èŠ‚ç‚¹å¤±æ•ˆæ—¶ï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ Pod ä»¥ç»´æŒæ‰€éœ€æ•°é‡ã€‚</strong></li>
<li><strong>å½“å‰¯æœ¬æ•°é‡è¿‡å¤šæ—¶ï¼Œå®ƒä»¬ä¼šç»ˆæ­¢å¤šä½™çš„ Podã€‚</strong></li>
</ul>
<p>ä½†å®ƒä»¬ä¹‹é—´å­˜åœ¨å…³é”®çš„åŒºåˆ«ï¼Œä¸»è¦ä½“ç°åœ¨<strong>Selector (é€‰æ‹©å™¨)</strong> çš„æ”¯æŒä¸Šã€‚</p>
<hr>
<h4 id="1-ReplicationController-RC"><a href="#1-ReplicationController-RC" class="headerlink" title="1. ReplicationController (RC)"></a>1. ReplicationController (RC)</h4><ul>
<li><strong>å‡ºç°æ—¶é—´ï¼š</strong> è¿™æ˜¯ Kubernetes æœ€æ—©å¼•å…¥çš„æ§åˆ¶å™¨ä¹‹ä¸€ (Kubernetes v1.0 ä¹‹å‰)ã€‚</li>
<li><strong>é€‰æ‹©å™¨ (Selector) é™åˆ¶ï¼š</strong> åªæ”¯æŒ<strong>åŸºäºç­‰å€¼ï¼ˆEquality-basedï¼‰</strong>çš„é€‰æ‹©å™¨ã€‚è¿™æ„å‘³ç€ä½ åªèƒ½é€šè¿‡ç²¾ç¡®åŒ¹é…æ ‡ç­¾çš„å€¼æ¥é€‰æ‹© Podã€‚<ul>
<li>ä¾‹å¦‚ï¼š<code>selector: app=nginx</code>ï¼Œå®ƒä¼šé€‰æ‹©æ‰€æœ‰å¸¦æœ‰ <code>app: nginx</code> æ ‡ç­¾çš„ Podã€‚</li>
<li>å®ƒ<strong>ä¸æ”¯æŒ</strong>é›†åˆåŸºï¼ˆSet-basedï¼‰çš„é€‰æ‹©å™¨ï¼Œä¾‹å¦‚ <code>app in (nginx, apache)</code> æˆ– <code>version notin (v1, v2)</code>ã€‚</li>
</ul>
</li>
<li><strong>Pod æ¨¡æ¿ï¼ˆPod Templateï¼‰ï¼š</strong> è´Ÿè´£åˆ›å»ºæ–°çš„ Podï¼Œä½†ä¸ä¼šåˆ›å»ºä¸è‡ªèº«æ ‡ç­¾åŒ¹é…çš„ Podã€‚</li>
<li><strong>ç”¨é€”ï¼š</strong> éšç€ Kubernetes çš„å‘å±•ï¼ŒRC é€æ¸è¢«å¼ƒç”¨ï¼Œè¢«åŠŸèƒ½æ›´å¼ºå¤§çš„ ReplicaSet å–ä»£ã€‚</li>
</ul>
<hr>
<h4 id="2-ReplicaSet-RS"><a href="#2-ReplicaSet-RS" class="headerlink" title="2. ReplicaSet (RS)"></a>2. ReplicaSet (RS)</h4><ul>
<li><strong>å‡ºç°æ—¶é—´ï¼š</strong> Kubernetes v1.2 å¼•å…¥ï¼Œä½œä¸º ReplicationController çš„<strong>ä¸‹ä¸€ä»£å’Œæ¨èæ›¿ä»£å“</strong>ã€‚</li>
<li><strong>é€‰æ‹©å™¨ (Selector) åŠŸèƒ½å¢å¼ºï¼š</strong> æ”¯æŒ<strong>é›†åˆåŸºï¼ˆSet-basedï¼‰</strong>é€‰æ‹©å™¨ã€‚è¿™æ˜¯ RS ç›¸å¯¹äº RC æœ€ä¸»è¦ä¹Ÿæ˜¯æœ€é‡è¦çš„æ”¹è¿›ã€‚<ul>
<li>ä¾‹å¦‚ï¼š<ul>
<li><code>selector: matchLabels: &#123;app: nginx&#125;</code> ï¼ˆä»ç„¶æ”¯æŒç­‰å€¼åŒ¹é…ï¼Œå› ä¸ºç­‰å€¼åŒ¹é…æ˜¯é›†åˆåŒ¹é…çš„å­é›†ï¼‰</li>
<li><code>selector: matchExpressions:</code><ul>
<li><code>- &#123;key: tier, operator: In, values: [frontend, backend]&#125;</code></li>
<li><code>- &#123;key: version, operator: NotIn, values: [v1beta1]&#125;</code></li>
<li><code>- &#123;key: environment, operator: Exists&#125;</code></li>
</ul>
</li>
</ul>
</li>
<li>è¿™ç§æ›´çµæ´»çš„é€‰æ‹©å™¨èƒ½åŠ›ä½¿å¾— ReplicaSet å¯ä»¥åŒ¹é…æ›´å¤æ‚çš„ Pod æ ‡ç­¾æ¡ä»¶ï¼Œæ›´å¥½åœ°ç®¡ç† Podã€‚</li>
</ul>
</li>
<li><strong>Pod æ¨¡æ¿ï¼ˆPod Templateï¼‰ï¼š</strong> å¯ä»¥åˆ›å»ºä¸€ä¸ª Pod æ¨¡æ¿ï¼Œä½†ä¸ä¼šåˆ›å»ºä¸è‡ªèº«æ ‡ç­¾åŒ¹é…çš„ Podã€‚</li>
<li><strong>ç‹¬ç«‹ä½¿ç”¨ï¼š</strong> ReplicaSet å¯ä»¥ç‹¬ç«‹ä½¿ç”¨ï¼Œä½†é€šå¸¸ä¸å»ºè®®ç›´æ¥ç‹¬ç«‹ä½¿ç”¨ã€‚</li>
<li><strong>ä¸ Desployment çš„å…³ç³»ï¼š</strong> ReplicaSet ä¸»è¦ç”± <strong>Deployment</strong> èµ„æºè‡ªåŠ¨åŒ–ç®¡ç†ã€‚å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Deployment æ—¶ï¼ŒDeployment ä¼šåœ¨åº•å±‚è‡ªåŠ¨åˆ›å»ºå’Œç®¡ç† ReplicaSetã€‚è¿™æ˜¯ ReplicaSet æœ€å¸¸è§çš„ç”¨æ³•ã€‚Deployment è´Ÿè´£æ»šåŠ¨æ›´æ–°ã€å›æ»šç­‰é«˜çº§åŠŸèƒ½ï¼Œè€Œ ReplicaSet åˆ™è´Ÿè´£ç»´æŠ¤Podå‰¯æœ¬æ•°é‡çš„ç¨³å®šã€‚</li>
</ul>
<hr>
<h3 id="æ€»ç»“æ¯”è¾ƒè¡¨æ ¼"><a href="#æ€»ç»“æ¯”è¾ƒè¡¨æ ¼" class="headerlink" title="æ€»ç»“æ¯”è¾ƒè¡¨æ ¼"></a>æ€»ç»“æ¯”è¾ƒè¡¨æ ¼</h3><table>
<thead>
<tr>
<th align="left">ç‰¹æ€§</th>
<th align="left">ReplicationController (RC)</th>
<th align="left">ReplicaSet (RS)</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>å¼•å…¥æ—¶é—´</strong></td>
<td align="left">æ—©æœŸç‰ˆæœ¬ (v1.0 ä¹‹å‰)</td>
<td align="left">v1.2 åŠä¹‹å</td>
</tr>
<tr>
<td align="left"><strong>é€‰æ‹©å™¨æ”¯æŒ</strong></td>
<td align="left"><strong>ä»…æ”¯æŒåŸºäºç­‰å€¼</strong> (<code>key=value</code>)</td>
<td align="left"><strong>æ”¯æŒç­‰å€¼å’Œé›†åˆåŸº</strong> (<code>key in (v1,v2)</code>, <code>key exists</code>)</td>
</tr>
<tr>
<td align="left"><strong>åŠŸèƒ½</strong></td>
<td align="left">ç¡®ä¿Podå‰¯æœ¬æ•°</td>
<td align="left">ç¡®ä¿Podå‰¯æœ¬æ•°</td>
</tr>
<tr>
<td align="left"><strong>ç”¨é€”åœºæ™¯</strong></td>
<td align="left">å·²è¢«å–ä»£ï¼Œä¸æ¨èç›´æ¥ä½¿ç”¨</td>
<td align="left"><strong>é€šå¸¸ç”± Deployment ç®¡ç†</strong>ï¼Œæå°‘ç›´æ¥ç‹¬ç«‹ä½¿ç”¨</td>
</tr>
<tr>
<td align="left"><strong>æ¨èç¨‹åº¦</strong></td>
<td align="left"><strong>ä¸æ¨è</strong></td>
<td align="left"><strong>æ¨è</strong> (ä½œä¸º Deployment çš„ä¸€éƒ¨åˆ†)</td>
</tr>
</tbody></table>
<hr>
<h3 id="å®é™…è¿ç»´ä¸­çš„æ„ä¹‰"><a href="#å®é™…è¿ç»´ä¸­çš„æ„ä¹‰" class="headerlink" title="å®é™…è¿ç»´ä¸­çš„æ„ä¹‰"></a>å®é™…è¿ç»´ä¸­çš„æ„ä¹‰</h3><p>ä½œä¸ºè¿ç»´å·¥ç¨‹å¸ˆï¼Œä½ éœ€è¦çŸ¥é“ï¼š</p>
<ol>
<li><strong>å‡ ä¹æ‰€æœ‰æƒ…å†µä¸‹ï¼Œä½ éƒ½åº”è¯¥ä½¿ç”¨ Deployment è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ ReplicaSet æˆ– ReplicationControllerã€‚</strong> Deployment æä¾›äº†è‡ªåŠ¨åŒ–çš„æ»šåŠ¨æ›´æ–°ã€å›æ»šã€æš‚åœ&#x2F;ç»§ç»­ç­‰é«˜çº§åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½æ˜¯ ReplicaSet å’Œ ReplicationController ä¸å…·å¤‡çš„ï¼Œä½†å®ƒä»¬æ˜¯ç°ä»£åŒ–åº”ç”¨éƒ¨ç½²å’Œç®¡ç†æ‰€å¿…éœ€çš„ã€‚</li>
<li><strong>Deployment åœ¨åº•å±‚ä¼šè‡ªåŠ¨ä¸ºä½ åˆ›å»ºå’Œç®¡ç† ReplicaSetã€‚</strong> å½“ä½ æ‰§è¡Œä¸€æ¬¡æ»šåŠ¨æ›´æ–°æ—¶ï¼ŒDeployment ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ ReplicaSet æ¥ç®¡ç†æ–°ç‰ˆæœ¬çš„ Podï¼Œå¹¶é€æ­¥å‡å°‘æ—§ ReplicaSet çš„ Pod æ•°é‡ï¼Œç›´åˆ°æ–°ç‰ˆæœ¬å®Œå…¨å–ä»£æ—§ç‰ˆæœ¬ã€‚</li>
<li><strong>äº†è§£ ReplicaSet çš„å­˜åœ¨å¯¹äºæ’æŸ¥é—®é¢˜å¾ˆé‡è¦ã€‚</strong> å½“ Deployment å‡ºç°é—®é¢˜æ—¶ï¼Œä½ éœ€è¦çŸ¥é“å®ƒèƒŒåæ˜¯ç”± ReplicaSet æ¥æ§åˆ¶ Pod çš„æ•°é‡å’ŒçŠ¶æ€çš„ã€‚ä½ å¯ä»¥é€šè¿‡ <code>kubectl get rs</code> å’Œ <code>kubectl describe deploy &lt;deployment-name&gt;</code> æ¥æŸ¥çœ‹ Deployment æ§åˆ¶çš„ ReplicaSet åŠå…¶çŠ¶æ€ã€‚</li>
</ol>
<p>å› æ­¤ï¼Œç†è§£ RC å’Œ RS çš„åŒºåˆ«ï¼Œç‰¹åˆ«æ˜¯ RS å¼ºå¤§çš„é€‰æ‹©å™¨ä»¥åŠå®ƒä¸ Deployment ä¹‹é—´çš„å…³ç³»ï¼Œå¯¹äºé«˜æ•ˆåœ°ç®¡ç†å’Œæ’æŸ¥ Kubernetes é›†ç¾¤ä¸­çš„åº”ç”¨ç¨‹åºæ˜¯è‡³å…³é‡è¦çš„ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/k8s%20ResourceQuota/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="å…­ä¸€">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/k8s%20ResourceQuota/" class="post-title-link" itemprop="url">k8s ResourceQuota</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-11 20:32:34 / ä¿®æ”¹æ—¶é—´ï¼š21:43:52" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/%E9%9D%A2%E8%AF%95%E9%A2%98/" itemprop="url" rel="index"><span itemprop="name">é¢è¯•é¢˜</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>3 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æè¿°åœ¨ Kubernetes ä¸­å¦‚ä½•é…ç½®èµ„æºé…é¢ï¼Œå¹¶è§£é‡Šå…¶ä½œç”¨ã€‚	</p>
<h3 id="ğŸ¤”-åˆ†æè¿‡ç¨‹ï¼š"><a href="#ğŸ¤”-åˆ†æè¿‡ç¨‹ï¼š" class="headerlink" title="ğŸ¤” åˆ†æè¿‡ç¨‹ï¼š"></a>ğŸ¤” åˆ†æè¿‡ç¨‹ï¼š</h3><p>æ­¤é—®é¢˜æ—¨åœ¨è€ƒå¯Ÿå¯¹Kubernetesèµ„æºæ²»ç†å’Œå¤šç§Ÿæˆ·ç®¡ç†çš„ç†è§£ã€‚æ ¸å¿ƒæ˜¯<code>ResourceQuota</code>å¯¹è±¡ã€‚ä¸€ä¸ªé«˜è´¨é‡çš„å›ç­”ä¸ä»…è¦è¯´æ˜å¦‚ä½•åˆ›å»º<code>ResourceQuota</code>ï¼Œæ›´è¦é˜æ˜å…¶æ ¸å¿ƒç›®çš„ï¼šä¸ºå‘½åç©ºé—´ï¼ˆNamespaceï¼‰è®¾ç½®èµ„æºâ€œé¢„ç®—â€ã€‚è¿™åŒ…æ‹¬è®¡ç®—èµ„æºï¼ˆCPU&#x2F;Memoryï¼‰ã€å­˜å‚¨èµ„æºå’Œå¯¹è±¡æ•°é‡çš„é™åˆ¶ã€‚æ­¤å¤–ï¼Œè¿˜åº”æåŠå®ƒä¸<code>LimitRange</code>å¯¹è±¡çš„å…³ç³»ï¼Œè¿™èƒ½ä½“ç°å‡ºå¯¹èµ„æºç®¡ç†ä½“ç³»çš„æ·±å…¥ç†è§£ã€‚</p>
<h3 id="ğŸ’¡-ç­”æ¡ˆç”Ÿæˆï¼š"><a href="#ğŸ’¡-ç­”æ¡ˆç”Ÿæˆï¼š" class="headerlink" title="ğŸ’¡ ç­”æ¡ˆç”Ÿæˆï¼š"></a>ğŸ’¡ ç­”æ¡ˆç”Ÿæˆï¼š</h3><h4 id="1-æ¦‚å¿µæˆ–å®šä¹‰"><a href="#1-æ¦‚å¿µæˆ–å®šä¹‰" class="headerlink" title="1. æ¦‚å¿µæˆ–å®šä¹‰"></a>1. æ¦‚å¿µæˆ–å®šä¹‰</h4><p><strong>ResourceQuota</strong>ï¼ˆèµ„æºé…é¢ï¼‰æ˜¯Kubernetesä¸­çš„ä¸€ä¸ªç­–ç•¥å¯¹è±¡ï¼Œå®ƒä¸º<strong>å‘½åç©ºé—´ï¼ˆNamespaceï¼‰</strong>æä¾›äº†èµ„æºæ¶ˆè€—çš„æ€»é‡é™åˆ¶ã€‚å®ƒå…è®¸é›†ç¾¤ç®¡ç†å‘˜ä¸ºæ¯ä¸ªå‘½åç©ºé—´åˆ†é…ä¸€ä¸ªâ€œé¢„ç®—â€ï¼Œç¡®ä¿å•ä¸ªå›¢é˜Ÿæˆ–åº”ç”¨ä¸ä¼šæ¶ˆè€—æ‰è¶…å‡ºå…¶åˆ†é…é¢åº¦çš„èµ„æºï¼Œä»è€Œå½±å“åˆ°é›†ç¾¤ä¸­çš„å…¶ä»–ç”¨æˆ·ã€‚</p>
<p><strong>æ ¸å¿ƒè¦ç‚¹ï¼š</strong> èµ„æºé…é¢æ˜¯<strong>ä½œç”¨äºå‘½åç©ºé—´çº§åˆ«</strong>çš„ï¼Œä¸æ˜¯ä½œç”¨äºå•ä¸ªPodæˆ–èŠ‚ç‚¹çš„ã€‚</p>
<h4 id="2-ä½œç”¨ä¸ç›®çš„"><a href="#2-ä½œç”¨ä¸ç›®çš„" class="headerlink" title="2. ä½œç”¨ä¸ç›®çš„"></a>2. ä½œç”¨ä¸ç›®çš„</h4><p>é…ç½®èµ„æºé…é¢çš„ä¸»è¦ä½œç”¨æ˜¯å®ç°é›†ç¾¤çš„<strong>æ²»ç†å’Œå…¬å¹³æ€§</strong>ï¼Œå…·ä½“ç›®æ ‡åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>é˜²æ­¢â€œé‚»å±…åµé—¹â€é—®é¢˜ (Noisy Neighbor):</strong> é¿å…æŸä¸ªå‘½åç©ºé—´ä¸­çš„åº”ç”¨ï¼ˆæˆ–ç”¨æˆ·é”™è¯¯ï¼‰è¿‡åº¦æ¶ˆè€—èµ„æºï¼ˆå¦‚CPUã€å†…å­˜ï¼‰ï¼Œä»è€Œå½±å“å…¶ä»–å‘½åç©ºé—´ä¸­åº”ç”¨çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚</li>
<li><strong>æˆæœ¬æ§åˆ¶ä¸å®¹é‡è§„åˆ’:</strong> åœ¨å¤šç§Ÿæˆ·ç¯å¢ƒä¸­ï¼Œå¯ä»¥æ ¹æ®å›¢é˜Ÿæˆ–é¡¹ç›®çš„é¢„ç®—åˆ†é…èµ„æºï¼Œæœ‰åŠ©äºæˆæœ¬æ ¸ç®—å’Œæœªæ¥çš„å®¹é‡è§„åˆ’ã€‚</li>
<li><strong>é˜²æ­¢æ„å¤–é”™è¯¯:</strong> é™åˆ¶å¯åˆ›å»ºçš„å¯¹è±¡æ•°é‡ï¼ˆå¦‚Podsã€Servicesï¼‰ï¼Œå¯ä»¥é˜²æ­¢å› é…ç½®é”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªDeploymenté”™è¯¯åœ°è¯·æ±‚åˆ›å»º1000ä¸ªå‰¯æœ¬ï¼‰è€Œå¯¼è‡´é›†ç¾¤èµ„æºè¢«ç¬é—´è€—å°½ã€‚</li>
<li><strong>å¼ºåˆ¶æ‰§è¡Œæœ€ä½³å®è·µ:</strong> å¼ºåˆ¶è¦æ±‚ç”¨æˆ·ä¸ºå…¶PodæŒ‡å®šèµ„æºè¯·æ±‚ï¼ˆ<code>requests</code>ï¼‰ï¼Œå› ä¸ºåªæœ‰è®¾ç½®äº†<code>requests</code>çš„Podæ‰ä¼šè¢«è®¡å…¥è®¡ç®—èµ„æºçš„é…é¢ç»Ÿè®¡ä¸­ã€‚</li>
</ul>
<h4 id="3-å¦‚ä½•é…ç½®-YAMLç¤ºä¾‹"><a href="#3-å¦‚ä½•é…ç½®-YAMLç¤ºä¾‹" class="headerlink" title="3. å¦‚ä½•é…ç½® (YAMLç¤ºä¾‹)"></a>3. å¦‚ä½•é…ç½® (YAMLç¤ºä¾‹)</h4><p>èµ„æºé…é¢é€šè¿‡åˆ›å»ºä¸€ä¸ª<code>ResourceQuota</code>å¯¹è±¡æ¥å®šä¹‰ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç»¼åˆæ€§çš„ç¤ºä¾‹ï¼Œé™åˆ¶äº†ä¸€ä¸ªå‘½åç©ºé—´çš„è®¡ç®—èµ„æºã€å­˜å‚¨èµ„æºå’Œå¯¹è±¡æ•°é‡ã€‚</p>
<p>å°†ä»¥ä¸‹å†…å®¹ä¿å­˜ä¸º <code>my-namespace-quota.yaml</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my-namespace-quota.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># ResourceQuotaçš„åç§°</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-namespace-quota</span></span><br><span class="line">  <span class="comment"># å¿…é¡»æŒ‡å®šå®ƒæ‰€ä½œç”¨çš„å‘½åç©ºé—´</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">my-team-namespace</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># &quot;hard&quot; å­—æ®µå®šä¹‰äº†ç¡¬æ€§é™åˆ¶</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="comment"># 1. è®¡ç®—èµ„æºé…é¢</span></span><br><span class="line">    <span class="comment"># è¯¥å‘½åç©ºé—´ä¸­æ‰€æœ‰Podçš„CPUè¯·æ±‚æ€»å’Œä¸èƒ½è¶…è¿‡10ä¸ªæ ¸å¿ƒ</span></span><br><span class="line">    <span class="attr">requests.cpu:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="comment"># è¯¥å‘½åç©ºé—´ä¸­æ‰€æœ‰Podçš„CPUé™åˆ¶æ€»å’Œä¸èƒ½è¶…è¿‡20ä¸ªæ ¸å¿ƒ</span></span><br><span class="line">    <span class="attr">limits.cpu:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line">    <span class="comment"># è¯¥å‘½åç©ºé—´ä¸­æ‰€æœ‰Podçš„å†…å­˜è¯·æ±‚æ€»å’Œä¸èƒ½è¶…è¿‡20GiB</span></span><br><span class="line">    <span class="attr">requests.memory:</span> <span class="string">&quot;20Gi&quot;</span></span><br><span class="line">    <span class="comment"># è¯¥å‘½åç©ºé—´ä¸­æ‰€æœ‰Podçš„å†…å­˜é™åˆ¶æ€»å’Œä¸èƒ½è¶…è¿‡40GiB</span></span><br><span class="line">    <span class="attr">limits.memory:</span> <span class="string">&quot;40Gi&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. å­˜å‚¨èµ„æºé…é¢</span></span><br><span class="line">    <span class="comment"># è¯¥å‘½åç©ºé—´ä¸­æ‰€æœ‰PVCçš„å­˜å‚¨è¯·æ±‚æ€»å’Œä¸èƒ½è¶…è¿‡50GiB</span></span><br><span class="line">    <span class="attr">requests.storage:</span> <span class="string">&quot;50Gi&quot;</span></span><br><span class="line">    <span class="comment"># è¯¥å‘½åç©ºé—´ä¸­æ€»å…±å¯ä»¥åˆ›å»º10ä¸ªPVC</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="comment"># é’ˆå¯¹ç‰¹å®šçš„StorageClass (ä¾‹å¦‚é«˜æ€§èƒ½ssd) è¿›è¡Œé…é¢</span></span><br><span class="line">    <span class="attr">fast-ssd.storageclass.storage.k8s.io/requests.storage:</span> <span class="string">&quot;10Gi&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. å¯¹è±¡æ•°é‡é…é¢</span></span><br><span class="line">    <span class="comment"># è¯¥å‘½åç©ºé—´ä¸­æœ€å¤šåªèƒ½æœ‰20ä¸ªPod</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line">    <span class="comment"># æœ€å¤š10ä¸ªServices</span></span><br><span class="line">    <span class="attr">services:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="comment"># æœ€å¤š10ä¸ªReplicaSets</span></span><br><span class="line">    <span class="attr">replicasets:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="comment"># æœ€å¤š50ä¸ªSecrets</span></span><br><span class="line">    <span class="attr">secrets:</span> <span class="string">&quot;50&quot;</span></span><br><span class="line">    <span class="comment"># æœ€å¤š50ä¸ªConfigMaps</span></span><br><span class="line">    <span class="attr">configmaps:</span> <span class="string">&quot;50&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="4-ç®¡ç†ä¸éªŒè¯"><a href="#4-ç®¡ç†ä¸éªŒè¯" class="headerlink" title="4. ç®¡ç†ä¸éªŒè¯"></a>4. ç®¡ç†ä¸éªŒè¯</h4><ol>
<li><p><strong>åº”ç”¨é…é¢ï¼š</strong><br>é¦–å…ˆï¼Œç¡®ä¿å‘½åç©ºé—´å­˜åœ¨ï¼Œç„¶ååº”ç”¨è¯¥<code>ResourceQuota</code>å¯¹è±¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦‚æœå‘½åç©ºé—´ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºå®ƒ</span></span><br><span class="line">kubectl create namespace my-team-namespace</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†é…é¢åº”ç”¨åˆ°è¯¥å‘½åç©ºé—´</span></span><br><span class="line">kubectl apply -f my-namespace-quota.yaml -n my-team-namespace</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>æŸ¥çœ‹é…é¢ï¼š</strong><br>ä½¿ç”¨<code>describe</code>å‘½ä»¤å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°é…é¢çš„æ€»é‡ï¼ˆHardï¼‰å’Œå½“å‰å·²ä½¿ç”¨é‡ï¼ˆUsedï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe quota my-namespace-quota -n my-team-namespace</span><br></pre></td></tr></table></figure>
<p><strong>è¾“å‡ºç¤ºä¾‹ï¼š</strong></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Name:            <span class="keyword">my</span>-namespace-quota</span><br><span class="line">Namespace:       <span class="keyword">my</span>-team-namespace</span><br><span class="line">Resource         Used   Hard</span><br><span class="line"><span class="comment">--------         ----   ----</span></span><br><span class="line">configmaps       <span class="number">5</span>      <span class="number">50</span></span><br><span class="line">limits.cpu       <span class="number">500</span>m   <span class="number">20</span></span><br><span class="line">limits.memory    <span class="number">1</span>Gi    <span class="number">40</span>Gi</span><br><span class="line">pods             <span class="number">10</span>     <span class="number">20</span></span><br><span class="line"><span class="comment"># ... å…¶ä»–èµ„æº ...</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>è¿è§„è¡Œä¸ºï¼š</strong><br>å½“ç”¨æˆ·å°è¯•åœ¨è¯¥å‘½åç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ªä¼šè¶…å‡ºé…é¢çš„èµ„æºæ—¶ï¼ŒAPI Serverä¼š<strong>æ‹’ç»</strong>è¯¥è¯·æ±‚ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ˜ç¡®çš„é”™è¯¯ä¿¡æ¯ã€‚<br><strong>é”™è¯¯ç¤ºä¾‹ï¼š</strong> <code>Error from server (Forbidden): error when creating &quot;pod.yaml&quot;: pods &quot;my-pod&quot; is forbidden: exceeded quota: my-namespace-quota, requested: pods=1, used: pods=20, limited: pods=20</code></p>
</li>
</ol>
<h4 id="5-æ‰©å±•çŸ¥è¯†-æœ€ä½³å®è·µ"><a href="#5-æ‰©å±•çŸ¥è¯†-æœ€ä½³å®è·µ" class="headerlink" title="5. æ‰©å±•çŸ¥è¯†&#x2F;æœ€ä½³å®è·µ"></a>5. æ‰©å±•çŸ¥è¯†&#x2F;æœ€ä½³å®è·µ</h4><ul>
<li><strong>ä¸<code>LimitRange</code>ååŒå·¥ä½œ:</strong><ul>
<li><code>ResourceQuota</code>è®¾ç½®çš„æ˜¯<strong>å‘½åç©ºé—´çš„æ€»é¢„ç®—</strong>ã€‚</li>
<li><code>LimitRange</code>åˆ™ä¸ºè¯¥å‘½åç©ºé—´ä¸­çš„<strong>æ¯ä¸ªPodè®¾ç½®é»˜è®¤çš„ã€æœ€å°æˆ–æœ€å¤§çš„èµ„æºè¯·æ±‚&#x2F;é™åˆ¶</strong>ã€‚</li>
<li><strong>äºŒè€…å¿…é¡»ååŒä½¿ç”¨ã€‚</strong> å¦‚æœä½ è®¾ç½®äº†è®¡ç®—èµ„æºé…é¢ï¼ˆå¦‚<code>requests.cpu</code>ï¼‰ï¼Œä½†ç”¨æˆ·åˆ›å»ºçš„Podæ²¡æœ‰æŒ‡å®š<code>requests.cpu</code>ï¼Œé‚£ä¹ˆè¿™ä¸ªPodå°†æ— æ³•è¢«åˆ›å»ºã€‚<code>LimitRange</code>å¯ä»¥ä¸ºæœªæŒ‡å®šèµ„æºè¯·æ±‚çš„Podè‡ªåŠ¨æ·»åŠ é»˜è®¤å€¼ï¼Œä»è€Œç¡®ä¿å®ƒä»¬èƒ½è¢«<code>ResourceQuota</code>æ­£ç¡®åœ°ç»Ÿè®¡å’Œç®¡ç†ã€‚</li>
</ul>
</li>
<li><strong>é…é¢èŒƒå›´ (Scope):</strong> <code>ResourceQuota</code>å¯ä»¥é€šè¿‡<code>scopes</code>å­—æ®µæ¥è¿›ä¸€æ­¥é™å®šå…¶ä½œç”¨èŒƒå›´ï¼Œä¾‹å¦‚ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªåªå¯¹<code>BestEffort</code>ç±»å‹çš„Podç”Ÿæ•ˆçš„é…é¢ï¼Œæˆ–è€…åªå¯¹<code>NotTerminating</code>çš„Podç”Ÿæ•ˆçš„é…é¢ã€‚</li>
<li><strong>ç›‘æ§ä¸å‘Šè­¦:</strong> åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”è¯¥ä½¿ç”¨Prometheusç­‰ç›‘æ§å·¥å…·æ¥ç›‘æ§å„å‘½åç©ºé—´çš„é…é¢ä½¿ç”¨æƒ…å†µï¼ˆ<code>kube_resourcequota</code>æŒ‡æ ‡ï¼‰ï¼Œå¹¶åœ¨ä½¿ç”¨é‡æ¥è¿‘ç¡¬æ€§é™åˆ¶æ—¶å‘å‡ºå‘Šè­¦ï¼Œä»¥ä¾¿ç®¡ç†å‘˜åŠæ—¶è°ƒæ•´æˆ–é€šçŸ¥ç”¨æˆ·ã€‚</li>
<li><strong>åˆç†è§„åˆ’:</strong> é…é¢çš„è®¾ç½®éœ€è¦åŸºäºå¯¹åº”ç”¨è´Ÿè½½çš„ç†è§£å’Œä¸šåŠ¡éœ€æ±‚ã€‚è®¾ç½®å¾—è¿‡ä½ä¼šå½±å“å¼€å‘å’Œéƒ¨ç½²æ•ˆç‡ï¼Œè®¾ç½®å¾—è¿‡é«˜åˆ™å¤±å»äº†èµ„æºæ²»ç†çš„æ„ä¹‰ã€‚</li>
</ul>
<p><strong>ç»“è®ºï¼š</strong>  <code>ResourceQuota</code>æ˜¯Kubernetesä¸­å®ç°å¤šç§Ÿæˆ·èµ„æºæ²»ç†å’Œå…¬å¹³æ€§çš„æ ¸å¿ƒå·¥å…·ï¼Œå®ƒé€šè¿‡ä¸ºå‘½åç©ºé—´è®¾ç½®è®¡ç®—ã€å­˜å‚¨å’Œå¯¹è±¡æ•°é‡çš„ç¡¬æ€§ä¸Šé™ï¼Œæœ‰æ•ˆé˜²æ­¢èµ„æºæ»¥ç”¨ï¼Œå¹¶å¼ºåˆ¶æ¨è¡Œèµ„æºç®¡ç†çš„æœ€ä½³å®è·µã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/k8s%20POD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="å…­ä¸€">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/k8s%20POD/" class="post-title-link" itemprop="url">k8s POD</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-11 20:32:34 / ä¿®æ”¹æ—¶é—´ï¼š21:43:43" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/%E9%9D%A2%E8%AF%95%E9%A2%98/" itemprop="url" rel="index"><span itemprop="name">é¢è¯•é¢˜</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>4k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>4 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="ğŸ¤”-åˆ†æè¿‡ç¨‹ï¼š"><a href="#ğŸ¤”-åˆ†æè¿‡ç¨‹ï¼š" class="headerlink" title="ğŸ¤” åˆ†æè¿‡ç¨‹ï¼š"></a>ğŸ¤” åˆ†æè¿‡ç¨‹ï¼š</h3><p>è¯¥é—®é¢˜æ—¨åœ¨è€ƒå¯Ÿå¯¹Kubernetesæœ€åŸºæœ¬æ“ä½œçš„æŒæ¡ç¨‹åº¦ï¼Œå³å¦‚ä½•åˆ›å»ºä¸€ä¸ªPodã€‚ä¸€ä¸ªå®Œæ•´çš„å›ç­”ä¸ä»…è¦ç»™å‡ºç¤ºä¾‹é…ç½®æ–‡ä»¶ï¼Œè¿˜åº”è¯¥è§£é‡Šæ¸…æ¥šåˆ›å»ºPodçš„ä¸¤ç§ä¸»è¦æ–¹æ³•ï¼ˆå£°æ˜å¼å’Œå‘½ä»¤å¼ï¼‰ã€å„è‡ªçš„é€‚ç”¨åœºæ™¯ï¼Œä»¥åŠä¸ºä»€ä¹ˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬é€šå¸¸ä¸ç›´æ¥åˆ›å»ºâ€œè£¸Podâ€ã€‚è¿™èƒ½ä½“ç°å‡ºé¢è¯•è€…æ˜¯å¦å…·å¤‡å®é™…çš„ã€è§„èŒƒçš„æ“ä½œç»éªŒã€‚</p>
<h3 id="ğŸ’¡-ç­”æ¡ˆç”Ÿæˆï¼š"><a href="#ğŸ’¡-ç­”æ¡ˆç”Ÿæˆï¼š" class="headerlink" title="ğŸ’¡ ç­”æ¡ˆç”Ÿæˆï¼š"></a>ğŸ’¡ ç­”æ¡ˆç”Ÿæˆï¼š</h3><h4 id="1-æ¦‚å¿µæˆ–å®šä¹‰"><a href="#1-æ¦‚å¿µæˆ–å®šä¹‰" class="headerlink" title="1. æ¦‚å¿µæˆ–å®šä¹‰"></a>1. æ¦‚å¿µæˆ–å®šä¹‰</h4><p>åœ¨Kubernetesä¸­åˆ›å»ºä¸€ä¸ªPodï¼Œæ„å‘³ç€ä½ å‘é›†ç¾¤ä¸‹è¾¾ä¸€ä¸ªæŒ‡ä»¤ï¼Œè¦æ±‚å®ƒè¿è¡Œä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„å®ä¾‹ã€‚è¿™ä¸ªè¿‡ç¨‹çš„æ ¸å¿ƒæ˜¯å‘API Serveræäº¤ä¸€ä¸ªæè¿°PodæœŸæœ›çŠ¶æ€çš„<strong>æ¸…å•ï¼ˆManifestï¼‰</strong>ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªYAMLæˆ–JSONæ ¼å¼çš„æ–‡ä»¶ã€‚</p>
<h4 id="2-åˆ›å»ºæ–¹æ³•"><a href="#2-åˆ›å»ºæ–¹æ³•" class="headerlink" title="2. åˆ›å»ºæ–¹æ³•"></a>2. åˆ›å»ºæ–¹æ³•</h4><p>åˆ›å»ºPodä¸»è¦æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p>
<ul>
<li><p><strong>1. å£°æ˜å¼æ–¹æ³• (Declarative Method) - å¼ºçƒˆæ¨è</strong></p>
<ul>
<li><strong>æè¿°ï¼š</strong> è¿™æ˜¯Kubernetesç®¡ç†çš„<strong>æ ‡å‡†å’Œæœ€ä½³å®è·µ</strong>ã€‚ä½ é¦–å…ˆç¼–å†™ä¸€ä¸ªYAMLæ–‡ä»¶æ¥â€œå£°æ˜â€ä½ æƒ³è¦çš„Podæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨ä»€ä¹ˆé•œåƒã€éœ€è¦å¤šå°‘èµ„æºã€å¼€æ”¾å“ªä¸ªç«¯å£ç­‰ï¼‰ã€‚ç„¶åï¼Œä½ ä½¿ç”¨<code>kubectl apply -f &lt;filename.yaml&gt;</code>å‘½ä»¤å°†è¿™ä¸ªå£°æ˜æäº¤ç»™é›†ç¾¤ã€‚</li>
<li><strong>å·¥ä½œæœºåˆ¶ï¼š</strong> Kubernetesä¼šè¯»å–ä½ çš„YAMLæ–‡ä»¶ï¼Œå¹¶æŒç»­å·¥ä½œä»¥ç¡®ä¿é›†ç¾¤çš„å®é™…çŠ¶æ€ä¸ä½ çš„å£°æ˜ç›¸åŒ¹é…ã€‚å¦‚æœPodè¢«æ„å¤–åˆ é™¤ï¼Œï¼ˆè™½ç„¶è£¸Podä¸ä¼šï¼Œä½†Deploymentä¼šï¼‰æ§åˆ¶å™¨ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªã€‚å¦‚æœé…ç½®éœ€è¦å˜æ›´ï¼Œä½ åªéœ€ä¿®æ”¹YAMLæ–‡ä»¶å¹¶å†æ¬¡<code>apply</code>å³å¯ã€‚</li>
<li><strong>ä¼˜ç‚¹ï¼š</strong> é…ç½®å¯è¢«ç‰ˆæœ¬æ§åˆ¶ï¼ˆå¦‚Gitï¼‰ã€å¯å¤ç”¨ã€å¯å®¡è®¡ï¼Œæ˜¯ç”Ÿäº§ç¯å¢ƒçš„å”¯ä¸€æ­£ç¡®é€‰æ‹©ã€‚</li>
</ul>
</li>
<li><p><strong>2. å‘½ä»¤å¼æ–¹æ³• (Imperative Method)</strong></p>
<ul>
<li><strong>æè¿°ï¼š</strong> ä½ å¯ä»¥é€šè¿‡ä¸€ä¸ªç›´æ¥çš„å‘½ä»¤æ¥åˆ›å»ºèµ„æºï¼Œè€Œæ— éœ€ç¼–å†™YAMLæ–‡ä»¶ã€‚ä¾‹å¦‚ <code>kubectl run my-nginx --image=nginx</code>ã€‚</li>
<li><strong>å·¥ä½œæœºåˆ¶ï¼š</strong> è¿™æ¡å‘½ä»¤ä¼šç›´æ¥å‘API Serverå‘é€ä¸€ä¸ªåˆ›å»ºPodçš„è¯·æ±‚ã€‚å®ƒè·³è¿‡äº†æ–‡ä»¶ç®¡ç†çš„æ­¥éª¤ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> ä¸»è¦ç”¨äº<strong>å­¦ä¹ ã€å¼€å‘æˆ–ä¸€æ¬¡æ€§çš„è°ƒè¯•ä»»åŠ¡</strong>ã€‚å› ä¸ºå®ƒå¿«é€Ÿä¾¿æ·ï¼Œä½†é…ç½®ä¸æ˜“äºç®¡ç†å’Œå¤ç°ã€‚<strong>ä¸¥ç¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ­¤æ–¹æ³•è¿›è¡Œéƒ¨ç½²ã€‚</strong></li>
</ul>
</li>
</ul>
<hr>
<h4 id="3-ç¤ºä¾‹é…ç½®æ–‡ä»¶-YAML-Manifest"><a href="#3-ç¤ºä¾‹é…ç½®æ–‡ä»¶-YAML-Manifest" class="headerlink" title="3. ç¤ºä¾‹é…ç½®æ–‡ä»¶ (YAML Manifest)"></a>3. ç¤ºä¾‹é…ç½®æ–‡ä»¶ (YAML Manifest)</h4><p>è¿™æ˜¯ä½¿ç”¨<strong>å£°æ˜å¼æ–¹æ³•</strong>åˆ›å»ºä¸€ä¸ªç®€å•Nginx Podçš„ç¤ºä¾‹YAMLæ–‡ä»¶ã€‚å°†ä»¥ä¸‹å†…å®¹ä¿å­˜ä¸º <code>my-nginx-pod.yaml</code>ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># APIç‰ˆæœ¬ï¼ŒPodèµ„æºå±äºæ ¸å¿ƒv1ç‰ˆæœ¬</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="comment"># èµ„æºç±»å‹ï¼Œè¿™é‡Œæ˜¯Pod</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="comment"># å…ƒæ•°æ®ï¼ŒåŒ…å«Podçš„åç§°ã€æ ‡ç­¾ç­‰ä¿¡æ¯</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># Podçš„åç§°ï¼Œåœ¨å‘½åç©ºé—´å†…å¿…é¡»å”¯ä¸€</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx-pod</span></span><br><span class="line">  <span class="comment"># æ ‡ç­¾ï¼Œç”¨äºæ ‡è¯†å’Œé€‰æ‹©Pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">webserver</span></span><br><span class="line"><span class="comment"># è§„æ ¼ï¼Œå®šä¹‰Podçš„æœŸæœ›çŠ¶æ€ï¼Œè¿™æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># Podä¸­åŒ…å«çš„å®¹å™¨åˆ—è¡¨</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="comment"># å®¹å™¨çš„åç§°ï¼Œåœ¨Podå†…å¿…é¡»å”¯ä¸€</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">      <span class="comment"># è¦ä½¿ç”¨çš„å®¹å™¨é•œåƒ</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.21.6</span></span><br><span class="line">      <span class="comment"># å®¹å™¨éœ€è¦æš´éœ²çš„ç«¯å£</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="comment"># å®¹å™¨ç›‘å¬80ç«¯å£</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h4 id="4-åˆ›å»ºä¸éªŒè¯æ­¥éª¤"><a href="#4-åˆ›å»ºä¸éªŒè¯æ­¥éª¤" class="headerlink" title="4. åˆ›å»ºä¸éªŒè¯æ­¥éª¤"></a>4. åˆ›å»ºä¸éªŒè¯æ­¥éª¤</h4><ol>
<li><p><strong>ä¿å­˜æ–‡ä»¶ï¼š</strong> å°†ä¸Šè¿°YAMLå†…å®¹ä¿å­˜ä¸º <code>my-nginx-pod.yaml</code> æ–‡ä»¶ã€‚</p>
</li>
<li><p><strong>åº”ç”¨é…ç½®ï¼š</strong> åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»ºPodã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f my-nginx-pod.yaml</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šçœ‹åˆ°è¾“å‡ºï¼š<code>pod/my-nginx-pod created</code></p>
</li>
<li><p><strong>éªŒè¯çŠ¶æ€ï¼š</strong> æ£€æŸ¥Podæ˜¯å¦å·²æˆåŠŸåˆ›å»ºå¹¶æ­£åœ¨è¿è¡Œã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod my-nginx-pod</span><br><span class="line"><span class="comment"># æˆ–è€…ä½¿ç”¨ &#x27;kubectl get pods -l app=webserver&#x27; é€šè¿‡æ ‡ç­¾é€‰æ‹©</span></span><br></pre></td></tr></table></figure>
<p>é¢„æœŸè¾“å‡ºï¼Œ<code>STATUS</code> æ åº”ä¸º <code>Running</code>ï¼š</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">NAME</span>            READY   STATUS    RESTARTS   AGE</span><br><span class="line"><span class="attribute">my</span>-nginx-pod    <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">30</span>s</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>æŸ¥çœ‹è¯¦æƒ…ï¼š</strong> å¦‚æœPodçŠ¶æ€ä¸æ˜¯<code>Running</code>ï¼ˆä¾‹å¦‚<code>Pending</code>æˆ–<code>Error</code>ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨<code>describe</code>å‘½ä»¤æŸ¥çœ‹è¯¦ç»†äº‹ä»¶å’Œæ—¥å¿—ï¼Œä»¥è¿›è¡Œæ’æŸ¥ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod my-nginx-pod</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="5-æ‰©å±•çŸ¥è¯†-æœ€ä½³å®è·µ"><a href="#5-æ‰©å±•çŸ¥è¯†-æœ€ä½³å®è·µ" class="headerlink" title="5. æ‰©å±•çŸ¥è¯†&#x2F;æœ€ä½³å®è·µ"></a>5. æ‰©å±•çŸ¥è¯†&#x2F;æœ€ä½³å®è·µ</h4><ul>
<li><strong>é»„é‡‘æ³•åˆ™ï¼šä¸è¦ç›´æ¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åˆ›å»ºè£¸Pod (Naked Pod)ï¼</strong><ul>
<li><strong>åŸå› ï¼š</strong> ç›´æ¥åˆ›å»ºçš„Podä¸å…·å¤‡è‡ªæˆ‘ä¿®å¤èƒ½åŠ›ã€‚å¦‚æœPodæ‰€åœ¨çš„èŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œæˆ–è€…Podæœ¬èº«å› ä¸ºé”™è¯¯è€Œé€€å‡ºï¼ŒKubernetes<strong>ä¸ä¼š</strong>è‡ªåŠ¨é‡æ–°åˆ›å»ºå®ƒã€‚è¿™ä¸ªPodå°±ä¼šæ°¸è¿œæ¶ˆå¤±ã€‚</li>
</ul>
</li>
<li><strong>æ­£ç¡®çš„æ–¹å¼ï¼šä½¿ç”¨é«˜å±‚çº§çš„æ§åˆ¶å™¨ï¼</strong><ul>
<li>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ åº”è¯¥æ€»æ˜¯é€šè¿‡<strong>Deployment</strong>ã€<strong>StatefulSet</strong>æˆ–<strong>DaemonSet</strong>ç­‰æ§åˆ¶å™¨æ¥ç®¡ç†Podã€‚</li>
<li><strong>Deployment:</strong> æ˜¯æœ€å¸¸ç”¨çš„æ§åˆ¶å™¨ï¼Œé€‚ç”¨äºæ— çŠ¶æ€åº”ç”¨ã€‚å®ƒä¼šåˆ›å»ºä¸€ä¸ª<code>ReplicaSet</code>æ¥ç¡®ä¿æŒ‡å®šæ•°é‡çš„Podå‰¯æœ¬å§‹ç»ˆåœ¨è¿è¡Œã€‚å¦‚æœPodå¤±è´¥ï¼ŒDeploymentçš„ReplicaSetä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„Podæ¥æ›¿ä»£å®ƒï¼Œä»è€Œå®ç°äº†<strong>è‡ªæˆ‘ä¿®å¤</strong>å’Œ<strong>é«˜å¯ç”¨</strong>ã€‚</li>
<li><strong>ç¤ºä¾‹ (Deployment):</strong> ä¸€ä¸ªç®¡ç†Nginx Podçš„Deploymentä¼šæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Œå®ƒèƒ½ä¿è¯Podçš„å¥å£®æ€§ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ç»“è®ºï¼š</strong> åˆ›å»ºPodæ˜¯Kubernetesçš„åŸºç¡€æ“ä½œï¼Œé€šè¿‡ç¼–å†™YAMLæ–‡ä»¶å¹¶ä½¿ç”¨<code>kubectl apply</code>çš„å£°æ˜å¼æ–¹æ³•æ˜¯æ ‡å‡†å®è·µã€‚ç„¶è€Œï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¿…é¡»ä½¿ç”¨å¦‚Deploymentè¿™æ ·çš„æ§åˆ¶å™¨æ¥ç®¡ç†Podï¼Œä»¥ç¡®ä¿åº”ç”¨çš„å¥å£®æ€§å’Œé«˜å¯ç”¨æ€§ã€‚ </p>
<h3 id="ğŸ’¡-ç­”æ¡ˆç”Ÿæˆï¼š-1"><a href="#ğŸ’¡-ç­”æ¡ˆç”Ÿæˆï¼š-1" class="headerlink" title="ğŸ’¡ ç­”æ¡ˆç”Ÿæˆï¼š"></a>ğŸ’¡ ç­”æ¡ˆç”Ÿæˆï¼š</h3><h4 id="1-æ¦‚å¿µæˆ–å®šä¹‰-1"><a href="#1-æ¦‚å¿µæˆ–å®šä¹‰-1" class="headerlink" title="1. æ¦‚å¿µæˆ–å®šä¹‰"></a>1. æ¦‚å¿µæˆ–å®šä¹‰</h4><p><strong>Pod</strong> æ˜¯ Kubernetes ä¸­èƒ½å¤Ÿåˆ›å»ºå’Œç®¡ç†çš„<strong>æœ€å°ã€æœ€ç®€å•çš„éƒ¨ç½²å•å…ƒ</strong>ã€‚å®ƒä»£è¡¨äº†é›†ç¾¤ä¸­ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„å®ä¾‹ã€‚</p>
<p>ä¸€ä¸ªPodå°è£…äº†ä¸€ä¸ªæˆ–å¤šä¸ªç´§å¯†è€¦åˆçš„<strong>å®¹å™¨</strong>ï¼Œå¹¶ä¸ºè¿™äº›å®¹å™¨æä¾›äº†å…±äº«çš„<strong>å­˜å‚¨èµ„æº (Volumes)</strong> å’Œå…±äº«çš„**ç½‘ç»œå‘½åç©ºé—´ (Network Namespace)**ã€‚è¿™æ„å‘³ç€ï¼Œåœ¨åŒä¸€ä¸ªPodå†…çš„æ‰€æœ‰å®¹å™¨å…±äº«åŒä¸€ä¸ªIPåœ°å€å’Œç«¯å£ç©ºé—´ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡<code>localhost</code>äº’ç›¸é€šä¿¡ã€‚å®ƒä»¬è¿˜å¯ä»¥å…±äº«Podçº§åˆ«å®šä¹‰çš„å­˜å‚¨å·ï¼Œå®ç°æ•°æ®äº¤æ¢ã€‚</p>
<p>å¯ä»¥æŠŠPodæƒ³è±¡æˆä¸€ä¸ª<strong>â€œè±Œè±†èšâ€</strong>ï¼ˆPodçš„è‹±æ–‡åŸæ„ï¼‰ï¼Œè€Œé‡Œé¢çš„å®¹å™¨å°±æ˜¯â€œè±Œè±†â€ã€‚è¿™äº›è±Œè±†è¢«åŒ…è£¹åœ¨åŒä¸€ä¸ªç¯å¢ƒä¸­ï¼Œå…±äº«èµ„æºï¼Œç”Ÿå‘½å‘¨æœŸä¹Ÿç´§å¯†ç›¸è¿ã€‚</p>
<h4 id="2-ä½œç”¨ä¸æ ¸å¿ƒç›®çš„-Why-do-Pods-exist"><a href="#2-ä½œç”¨ä¸æ ¸å¿ƒç›®çš„-Why-do-Pods-exist" class="headerlink" title="2. ä½œç”¨ä¸æ ¸å¿ƒç›®çš„ (Why do Pods exist?)"></a>2. ä½œç”¨ä¸æ ¸å¿ƒç›®çš„ (Why do Pods exist?)</h4><p>Kubernetesä¸ç›´æ¥ç®¡ç†å®¹å™¨ï¼Œè€Œæ˜¯é€šè¿‡Podè¿™ä¸ªæ›´é«˜å±‚æ¬¡çš„æŠ½è±¡æ¥ç®¡ç†ã€‚å…¶æ ¸å¿ƒä½œç”¨ä¸»è¦æœ‰ä¸‰ç‚¹ï¼š</p>
<ul>
<li><p><strong>1. æä¾›æœ€å°çš„åŸå­è°ƒåº¦å’Œç®¡ç†å•å…ƒ (Atomic Unit of Scheduling):</strong></p>
<ul>
<li>Kubernetesçš„è°ƒåº¦å™¨ï¼ˆKube-schedulerï¼‰ä¸ä¼šå°†å•ä¸ªå®¹å™¨è°ƒåº¦åˆ°èŠ‚ç‚¹ä¸Šï¼Œè€Œæ˜¯å°†æ•´ä¸ªPodä½œä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„<strong>åŸå­å•å…ƒ</strong>è¿›è¡Œè°ƒåº¦ã€‚Podå†…çš„æ‰€æœ‰å®¹å™¨æ€»æ˜¯ä¼šè¢«ä¸€èµ·è°ƒåº¦åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ç»‘å®šçš„â€”â€”å®ƒä»¬ä¼šä¸€èµ·å¯åŠ¨ã€ä¸€èµ·åœæ­¢ã€‚</li>
</ul>
</li>
<li><p><strong>2. å®ç°å®¹å™¨é—´çš„ç´§å¯†åä½œ (Enabling Co-location and Resource Sharing):</strong></p>
<ul>
<li>è¿™æ˜¯Podè®¾è®¡çš„æ ¸å¿ƒç›®çš„ã€‚å½“å¤šä¸ªè¿›ç¨‹éœ€è¦ç´§å¯†åä½œã€å…±äº«èµ„æºæ—¶ï¼Œå°†å®ƒä»¬æ”¾åœ¨åŒä¸€ä¸ªPodä¸­æ˜¯æœ€ç†æƒ³çš„æ¨¡å¼ã€‚</li>
<li><strong>å…±äº«ç½‘ç»œ:</strong> å®¹å™¨å¯ä»¥é€šè¿‡<code>localhost</code>ç›´æ¥è®¿é—®å½¼æ­¤çš„ç«¯å£ï¼Œç®€åŒ–äº†æœåŠ¡å‘ç°å’Œé€šä¿¡ã€‚</li>
<li><strong>å…±äº«å­˜å‚¨:</strong> å®¹å™¨å¯ä»¥é€šè¿‡æŒ‚è½½åŒä¸€ä¸ª<code>Volume</code>æ¥å…±äº«æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªä¸»åº”ç”¨å®¹å™¨å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼Œå¦ä¸€ä¸ªâ€œè¾¹è½¦ï¼ˆSidecarï¼‰â€å®¹å™¨è¯»å–å¹¶ä¸ŠæŠ¥è¯¥æ—¥å¿—æ–‡ä»¶ã€‚</li>
</ul>
</li>
<li><p><strong>3. ä½œä¸ºåº”ç”¨å®ä¾‹çš„æŠ½è±¡ (Abstraction for Application Instances):</strong></p>
<ul>
<li>å¯¹äºKubernetesæ¥è¯´ï¼Œä¸€ä¸ªPodå°±ä»£è¡¨äº†ä½ çš„åº”ç”¨çš„ä¸€ä¸ªâ€œå®ä¾‹â€æˆ–â€œå‰¯æœ¬â€ã€‚å½“ä½ éœ€è¦æ°´å¹³æ‰©å±•åº”ç”¨æ—¶ï¼Œä½ æ˜¯åœ¨åˆ›å»ºæ›´å¤šçš„Podå‰¯æœ¬ï¼Œè€Œä¸æ˜¯æ›´å¤šçš„å•ä¸ªå®¹å™¨ã€‚è¿™ä½¿å¾—åƒ<code>Deployment</code>è¿™æ ·çš„æ§åˆ¶å™¨èƒ½å¤Ÿæ›´å®¹æ˜“åœ°ç®¡ç†åº”ç”¨çš„ä¼¸ç¼©ã€æ›´æ–°å’Œå¥åº·çŠ¶æ€ã€‚</li>
</ul>
</li>
</ul>
<h4 id="3-Pod-ä¸å®¹å™¨çš„åŒºåˆ«"><a href="#3-Pod-ä¸å®¹å™¨çš„åŒºåˆ«" class="headerlink" title="3. Pod ä¸å®¹å™¨çš„åŒºåˆ«"></a>3. Pod ä¸å®¹å™¨çš„åŒºåˆ«</h4><p>è¿™æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„åŒºåˆ«ï¼Œä¹Ÿæ˜¯é¢è¯•ä¸­çš„å¸¸è§è€ƒç‚¹ã€‚</p>
<table>
<thead>
<tr>
<th align="left">ç‰¹æ€§ (Feature)</th>
<th align="left">å®¹å™¨ (Container)</th>
<th align="left">Pod (Kubernetes)</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>åŸºæœ¬å•ä½ (Unit)</strong></td>
<td align="left">å®¹å™¨æ˜¯è¿è¡Œæ—¶çš„æœ€å°æ‰§è¡Œå•å…ƒï¼ˆå¦‚Dockerå®¹å™¨ï¼‰ã€‚</td>
<td align="left">Podæ˜¯Kubernetesä¸­<strong>æœ€å°çš„éƒ¨ç½²å’Œç®¡ç†å•å…ƒ</strong>ã€‚</td>
</tr>
<tr>
<td align="left"><strong>ç½‘ç»œ (Network)</strong></td>
<td align="left">é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå®¹å™¨éƒ½æœ‰è‡ªå·±éš”ç¦»çš„ç½‘ç»œå‘½åç©ºé—´ã€‚</td>
<td align="left"><strong>ä¸€ä¸ªPodæ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„IPåœ°å€</strong>ï¼ŒPodå†…çš„æ‰€æœ‰å®¹å™¨å…±äº«æ­¤IPã€‚</td>
</tr>
<tr>
<td align="left"><strong>èµ„æºå…±äº« (Sharing)</strong></td>
<td align="left">å®¹å™¨ä¹‹é—´é»˜è®¤æ˜¯éš”ç¦»çš„ã€‚</td>
<td align="left">Podä¸ºå†…éƒ¨çš„å®¹å™¨æä¾›äº†ä¸€ä¸ª<strong>å¼ºåˆ¶çš„èµ„æºå…±äº«ç¯å¢ƒ</strong>ã€‚</td>
</tr>
<tr>
<td align="left"><strong>ç”Ÿå‘½å‘¨æœŸ (Lifecycle)</strong></td>
<td align="left">ç”±å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚containerd, CRI-Oï¼‰ç›´æ¥ç®¡ç†ã€‚</td>
<td align="left">ç”±Kubernetesä½œä¸ºä¸€ä¸ªæ•´ä½“è¿›è¡Œç®¡ç†ï¼Œç”Ÿæ­»ä¸å…±ã€‚</td>
</tr>
<tr>
<td align="left"><strong>æ‰©å±•å•ä½ (Scaling)</strong></td>
<td align="left">åœ¨Kubernetesä¸­ï¼Œä¸ç›´æ¥ä»¥å®¹å™¨ä¸ºå•ä½è¿›è¡Œæ‰©å±•ã€‚</td>
<td align="left"><strong>æ˜¯Kubernetesæ°´å¹³æ‰©å±•çš„åŸºæœ¬å•ä½</strong>ï¼ˆHPAæ‰©å±•çš„æ˜¯Podæ•°é‡ï¼‰ã€‚</td>
</tr>
<tr>
<td align="left"><strong>å…¸å‹ç”¨é€” (Use Case)</strong></td>
<td align="left">è¿è¡Œå•ä¸ªåº”ç”¨ç¨‹åºæˆ–è¿›ç¨‹ã€‚</td>
<td align="left">è¿è¡Œä¸€ä¸ªä¸»åº”ç”¨ä»¥åŠå…¶ç´§å¯†è€¦åˆçš„è¾…åŠ©è¿›ç¨‹ï¼ˆå¦‚Sidecaræ¨¡å¼ï¼‰ã€‚</td>
</tr>
</tbody></table>
<h4 id="4-æ‰©å±•çŸ¥è¯†-æœ€ä½³å®è·µ"><a href="#4-æ‰©å±•çŸ¥è¯†-æœ€ä½³å®è·µ" class="headerlink" title="4. æ‰©å±•çŸ¥è¯†&#x2F;æœ€ä½³å®è·µ"></a>4. æ‰©å±•çŸ¥è¯†&#x2F;æœ€ä½³å®è·µ</h4><ul>
<li><strong>â€œä¸€ä¸ªPodï¼Œä¸€ä¸ªä¸»è¦è¿›ç¨‹â€åŸåˆ™:</strong> è™½ç„¶Podå¯ä»¥åŒ…å«å¤šä¸ªå®¹å™¨ï¼Œä½†æœ€ä½³å®è·µæ˜¯æ¯ä¸ªPodåªè¿è¡Œä¸€ä¸ªåº”ç”¨çš„ä¸»è¿›ç¨‹ã€‚å…¶ä»–å®¹å™¨åº”è¯¥æ˜¯è¾…åŠ©æ€§çš„â€œè¾¹è½¦â€ï¼ˆSidecarsï¼‰ï¼Œä¾‹å¦‚æ—¥å¿—æ”¶é›†å™¨ã€æœåŠ¡ç½‘æ ¼ä»£ç†ï¼ˆå¦‚Istio Envoyï¼‰ã€é…ç½®åŠ è½½å™¨ç­‰ã€‚ä¸è¦å°†å¤šä¸ªæ— å…³çš„åº”ç”¨å¡è¿›åŒä¸€ä¸ªPodã€‚</li>
<li><strong>Podæ˜¯â€œæ˜“é€çš„â€ (Ephemeral):</strong> Podè¢«è®¾è®¡ä¸ºå¯æ›¿ä»£å’Œä¸´æ—¶çš„ã€‚å½“ä¸€ä¸ªPodæ­»æ‰åï¼Œæ§åˆ¶å™¨ï¼ˆå¦‚Deploymentï¼‰ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Podæ¥æ›¿ä»£å®ƒã€‚å› æ­¤ï¼Œä»»ä½•éœ€è¦æŒä¹…åŒ–çš„æ•°æ®éƒ½å¿…é¡»ä½¿ç”¨<strong>æŒä¹…åŒ–å­˜å‚¨ï¼ˆPersistentVolumeï¼‰</strong>ï¼Œè€Œä¸èƒ½ä¾èµ–Podè‡ªèº«çš„ç”Ÿå‘½å‘¨æœŸã€‚</li>
<li><strong>é€šè¿‡æ§åˆ¶å™¨ç®¡ç†Pod:</strong> åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œä½ å‡ ä¹æ°¸è¿œä¸ä¼šç›´æ¥åˆ›å»ºå•ä¸ªPodã€‚è€Œæ˜¯é€šè¿‡æ›´é«˜çº§çš„æ§åˆ¶å™¨ï¼ˆå¦‚<code>Deployment</code>, <code>StatefulSet</code>, <code>DaemonSet</code>, <code>Job</code>ï¼‰æ¥åˆ›å»ºå’Œç®¡ç†Podï¼Œå› ä¸ºè¿™äº›æ§åˆ¶å™¨æä¾›äº†è‡ªæ„ˆã€æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰å…³é”®èƒ½åŠ›ã€‚</li>
</ul>
<p><strong>ç»“è®ºï¼š</strong> Podæ˜¯Kubernetesä¸­æœ€åŸºæœ¬çš„æ„å»ºå—ï¼Œå®ƒé€šè¿‡æä¾›ä¸€ä¸ªå…±äº«çš„æ‰§è¡Œç¯å¢ƒï¼Œå°†ä¸€ä¸ªæˆ–å¤šä¸ªç´§å¯†åä½œçš„å®¹å™¨ç»„åˆæˆä¸€ä¸ªåŸå­ç®¡ç†å•å…ƒï¼Œä»è€Œç®€åŒ–äº†åº”ç”¨çš„éƒ¨ç½²ã€è°ƒåº¦å’Œæ‰©å±•ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/k8s%20Rolling%20Update/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="å…­ä¸€">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/k8s%20Rolling%20Update/" class="post-title-link" itemprop="url">k8s Rolling Update</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-11 20:32:34 / ä¿®æ”¹æ—¶é—´ï¼š21:43:56" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/%E9%9D%A2%E8%AF%95%E9%A2%98/" itemprop="url" rel="index"><span itemprop="name">é¢è¯•é¢˜</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>3 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æè¿°åœ¨ Kubernetes ä¸­å¦‚ä½•è¿›è¡Œæ»šåŠ¨æ›´æ–°å’Œå›æ»šæ“ä½œã€‚	</p>
<h3 id="ğŸ¤”-åˆ†æè¿‡ç¨‹ï¼š"><a href="#ğŸ¤”-åˆ†æè¿‡ç¨‹ï¼š" class="headerlink" title="ğŸ¤” åˆ†æè¿‡ç¨‹ï¼š"></a>ğŸ¤” åˆ†æè¿‡ç¨‹ï¼š</h3><p>æ­¤é—®é¢˜è€ƒå¯Ÿçš„æ˜¯Kubernetesä¸­æœ€é‡è¦çš„åŠŸèƒ½ä¹‹ä¸€ï¼šæ— åœæœºæ›´æ–°å’Œå¿«é€Ÿå›æ»šã€‚æ ¸å¿ƒè€ƒå¯Ÿç‚¹æ˜¯<code>Deployment</code>æ§åˆ¶å™¨å¦‚ä½•é€šè¿‡ç®¡ç†<code>ReplicaSet</code>æ¥å®ç°è¿™ä¸€è¿‡ç¨‹ã€‚ä¸€ä¸ªä¼˜ç§€çš„å›ç­”éœ€è¦æ¸…æ™°åœ°é˜è¿°â€æ»šåŠ¨æ›´æ–°â€çš„å†…éƒ¨æœºåˆ¶ï¼ˆç‰¹åˆ«æ˜¯<code>maxSurge</code>å’Œ<code>maxUnavailable</code>å‚æ•°ï¼‰ã€å›æ»šæ˜¯å¦‚ä½•åˆ©ç”¨å†å²ç‰ˆæœ¬ï¼ˆæ—§çš„ReplicaSetï¼‰å®ç°çš„ï¼Œå¹¶èƒ½æä¾›å®Œæ•´çš„å‘½ä»¤è¡Œæ“ä½œç¤ºä¾‹ã€‚</p>
<h3 id="ğŸ’¡-ç­”æ¡ˆç”Ÿæˆï¼š"><a href="#ğŸ’¡-ç­”æ¡ˆç”Ÿæˆï¼š" class="headerlink" title="ğŸ’¡ ç­”æ¡ˆç”Ÿæˆï¼š"></a>ğŸ’¡ ç­”æ¡ˆç”Ÿæˆï¼š</h3><h4 id="1-æ¦‚å¿µæˆ–å®šä¹‰"><a href="#1-æ¦‚å¿µæˆ–å®šä¹‰" class="headerlink" title="1. æ¦‚å¿µæˆ–å®šä¹‰"></a>1. æ¦‚å¿µæˆ–å®šä¹‰</h4><ul>
<li><p><strong>æ»šåŠ¨æ›´æ–° (Rolling Update):</strong> æ˜¯Kubernetesä¸­<strong>é»˜è®¤çš„éƒ¨ç½²ç­–ç•¥</strong>ï¼Œæ—¨åœ¨å®ç°<strong>é›¶åœæœºæ—¶é—´ï¼ˆZero-Downtimeï¼‰</strong>çš„åº”ç”¨å‡çº§ã€‚å®ƒé€šè¿‡é€ä¸ªåœ°ç”¨æ–°ç‰ˆæœ¬çš„Podæ›¿æ¢æ—§ç‰ˆæœ¬çš„Podï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åœ°é”€æ¯æ‰€æœ‰æ—§Podå†åˆ›å»ºæ–°Podï¼Œä»è€Œä¿è¯åœ¨æ•´ä¸ªæ›´æ–°è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨æœåŠ¡å§‹ç»ˆæ˜¯å¯ç”¨çš„ã€‚</p>
</li>
<li><p><strong>å›æ»š (Rollback):</strong> æ˜¯ä¸€ä¸ªæ¢å¤æ“ä½œã€‚å½“æ–°ç‰ˆæœ¬çš„åº”ç”¨éƒ¨ç½²åå‡ºç°é—®é¢˜æ—¶ï¼Œå›æ»šæ“ä½œå¯ä»¥å°†åº”ç”¨<strong>å¿«é€Ÿåœ°æ¢å¤åˆ°ä¹‹å‰ä¸€ä¸ªç¨³å®šã€å¯ç”¨çš„ç‰ˆæœ¬</strong>ã€‚Kubernetesé€šè¿‡ä¿ç•™å†å²éƒ¨ç½²ç‰ˆæœ¬ï¼ˆä»¥ReplicaSetçš„å½¢å¼ï¼‰æ¥å®ç°è¿™ä¸€åŠŸèƒ½ã€‚</p>
</li>
</ul>
<p>è¿™ä¸¤ä¸ªåŠŸèƒ½éƒ½æ˜¯ç”±**<code>Deployment</code>**æ§åˆ¶å™¨æ¥ç®¡ç†çš„ã€‚</p>
<h4 id="2-å·¥ä½œåŸç†-æœºåˆ¶"><a href="#2-å·¥ä½œåŸç†-æœºåˆ¶" class="headerlink" title="2. å·¥ä½œåŸç†&#x2F;æœºåˆ¶"></a>2. å·¥ä½œåŸç†&#x2F;æœºåˆ¶</h4><p><strong>A. æ»šåŠ¨æ›´æ–°çš„å·¥ä½œåŸç†</strong></p>
<ol>
<li><strong>è§¦å‘æ›´æ–°ï¼š</strong> å½“ä½ ä¿®æ”¹ä¸€ä¸ª<code>Deployment</code>çš„Podæ¨¡æ¿ï¼ˆPod Templateï¼‰æ—¶ï¼Œä¾‹å¦‚æ›´æ–°äº†å®¹å™¨çš„é•œåƒç‰ˆæœ¬ï¼ˆ<code>spec.template.spec.containers[0].image</code>ï¼‰ï¼Œæ»šåŠ¨æ›´æ–°å°±ä¼šè¢«è§¦å‘ã€‚</li>
<li><strong>åˆ›å»ºæ–°ReplicaSetï¼š</strong> <code>Deployment</code>æ§åˆ¶å™¨ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„<code>ReplicaSet</code>ï¼ˆä»£è¡¨æ–°ç‰ˆæœ¬ï¼‰ï¼Œå¹¶å°†å…¶åˆå§‹å‰¯æœ¬æ•°è®¾ç½®ä¸º0ã€‚</li>
<li><strong>é€ä¸ªæ›¿æ¢ï¼š</strong> æ§åˆ¶å™¨ä¼šåŒæ—¶è¿›è¡Œä¸¤ä¸ªæ“ä½œï¼š<ul>
<li><strong>å¢åŠ æ–°ç‰ˆæœ¬Podï¼š</strong> ç¼“æ…¢åœ°å¢åŠ æ–°<code>ReplicaSet</code>çš„å‰¯æœ¬æ•°ã€‚</li>
<li><strong>å‡å°‘æ—§ç‰ˆæœ¬Podï¼š</strong> åŒæ—¶ç¼“æ…¢åœ°å‡å°‘æ—§<code>ReplicaSet</code>çš„å‰¯æœ¬æ•°ã€‚</li>
</ul>
</li>
<li><strong>æ§åˆ¶é€Ÿç‡ï¼š</strong> è¿™ä¸ªæ›¿æ¢è¿‡ç¨‹çš„é€Ÿåº¦å’Œå¯ç”¨æ€§ç”±ä¸¤ä¸ªå…³é”®å‚æ•°æ§åˆ¶ï¼Œå®ƒä»¬å®šä¹‰åœ¨<code>Deployment</code>çš„<code>spec.strategy.rollingUpdate</code>å­—æ®µä¸‹ï¼š<ul>
<li><code>maxUnavailable</code>ï¼šæ›´æ–°è¿‡ç¨‹ä¸­ï¼Œå…è®¸çš„ä¸å¯ç”¨Podçš„æœ€å¤§æ•°é‡ï¼ˆæˆ–ç™¾åˆ†æ¯”ï¼‰ã€‚ä¾‹å¦‚ï¼Œè®¾ç½®ä¸º1æ„å‘³ç€åœ¨ä»»ä½•æ—¶å€™ï¼Œè‡³å°‘è¦æœ‰ <code>(æœŸæœ›å‰¯æœ¬æ•° - 1)</code> ä¸ªPodåœ¨æä¾›æœåŠ¡ã€‚</li>
<li><code>maxSurge</code>ï¼šæ›´æ–°è¿‡ç¨‹ä¸­ï¼Œå…è®¸è¶…å‡ºçš„Podçš„æœ€å¤§æ•°é‡ï¼ˆæˆ–ç™¾åˆ†æ¯”ï¼‰ã€‚ä¾‹å¦‚ï¼Œè®¾ç½®ä¸º1æ„å‘³ç€åœ¨ä»»ä½•æ—¶å€™ï¼ŒPodæ€»æ•°æœ€å¤šå¯ä»¥è¾¾åˆ° <code>(æœŸæœ›å‰¯æœ¬æ•° + 1)</code> ä¸ªã€‚</li>
</ul>
</li>
<li><strong>å®Œæˆæ›´æ–°ï¼š</strong> å½“æ‰€æœ‰æ—§ç‰ˆæœ¬çš„Podéƒ½è¢«ç»ˆæ­¢ï¼Œå¹¶ä¸”æ‰€æœ‰æ–°ç‰ˆæœ¬çš„Podéƒ½å·²æˆåŠŸåˆ›å»ºå¹¶è¿›å…¥<code>Ready</code>çŠ¶æ€æ—¶ï¼Œæ›´æ–°è¿‡ç¨‹å®Œæˆã€‚æ—§çš„<code>ReplicaSet</code>å‰¯æœ¬æ•°å˜ä¸º0ï¼Œä½†å®ƒ<strong>ä¸ä¼šè¢«åˆ é™¤</strong>ï¼ˆé™¤éè¾¾åˆ°å†å²ç‰ˆæœ¬é™åˆ¶ï¼‰ï¼Œä»¥ä¾¿ç”¨äºå¯èƒ½çš„å›æ»šã€‚</li>
</ol>
<p><strong>B. å›æ»šçš„å·¥ä½œåŸç†</strong></p>
<ol>
<li><strong>ç‰ˆæœ¬å†å²ï¼š</strong> <code>Deployment</code>ä¼šä¿ç•™å…¶ç®¡ç†è¿‡çš„<code>ReplicaSet</code>ä½œä¸ºâ€œä¿®è®¢å†å²â€ï¼ˆRevisionsï¼‰ã€‚æ¯ä¸ª<code>ReplicaSet</code>éƒ½ä»£è¡¨äº†<code>Deployment</code>çš„ä¸€ä¸ªå†å²ç‰ˆæœ¬ã€‚</li>
<li><strong>è§¦å‘å›æ»šï¼š</strong> å½“ä½ æ‰§è¡Œå›æ»šå‘½ä»¤æ—¶ï¼ˆä¾‹å¦‚ <code>kubectl rollout undo</code>ï¼‰ã€‚</li>
<li><strong>é€†å‘æ“ä½œï¼š</strong> <code>Deployment</code>æ§åˆ¶å™¨ä¼šæ‰§è¡Œä¸€ä¸ªä¸æ»šåŠ¨æ›´æ–°ç›¸åçš„è¿‡ç¨‹ã€‚å®ƒä¼šå°†å½“å‰çš„<code>ReplicaSet</code>ï¼ˆæœ‰é—®é¢˜çš„ç‰ˆæœ¬ï¼‰çš„å‰¯æœ¬æ•°é€æ¸å‡å°‘ï¼ŒåŒæ—¶å°†ä¸Šä¸€ä¸ªï¼ˆæˆ–æŒ‡å®šï¼‰ç‰ˆæœ¬çš„<code>ReplicaSet</code>çš„å‰¯æœ¬æ•°é€æ¸å¢åŠ ï¼Œç›´åˆ°æ¢å¤åˆ°ç›®æ ‡ç‰ˆæœ¬çš„çŠ¶æ€ã€‚è¿™ä¸ªè¿‡ç¨‹åŒæ ·éµå¾ª<code>maxSurge</code>å’Œ<code>maxUnavailable</code>ç­–ç•¥ï¼Œç¡®ä¿å›æ»šè¿‡ç¨‹ä¹Ÿæ˜¯å¹³æ»‘çš„ã€‚</li>
</ol>
<hr>
<h4 id="3-å¦‚ä½•æ‰§è¡Œæ“ä½œï¼ˆå‘½ä»¤è¡Œç¤ºä¾‹ï¼‰"><a href="#3-å¦‚ä½•æ‰§è¡Œæ“ä½œï¼ˆå‘½ä»¤è¡Œç¤ºä¾‹ï¼‰" class="headerlink" title="3. å¦‚ä½•æ‰§è¡Œæ“ä½œï¼ˆå‘½ä»¤è¡Œç¤ºä¾‹ï¼‰"></a>3. å¦‚ä½•æ‰§è¡Œæ“ä½œï¼ˆå‘½ä»¤è¡Œç¤ºä¾‹ï¼‰</h4><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º <code>nginx-deployment</code> çš„<code>Deployment</code>ã€‚</p>
<p><strong>A. æ‰§è¡Œæ»šåŠ¨æ›´æ–°</strong></p>
<p>æœ€è§„èŒƒçš„æ–¹å¼æ˜¯ä¿®æ”¹YAMLæ–‡ä»¶ï¼Œç„¶ååº”ç”¨å®ƒã€‚</p>
<ol>
<li><p><strong>åˆå§‹éƒ¨ç½² (version 1):</strong><br><code>deployment.yaml</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.20</span> <span class="comment"># &lt;-- Version 1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deployment.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>è§¦å‘æ›´æ–° (to version 2):</strong><br>ä¿®æ”¹<code>deployment.yaml</code>æ–‡ä»¶ä¸­çš„é•œåƒä¸º<code>nginx:1.21</code>ï¼Œç„¶åå†æ¬¡åº”ç”¨ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (ä¿®æ”¹æ–‡ä»¶ä¸­çš„ image: nginx:1.21)</span></span><br><span class="line">kubectl apply -f deployment.yaml</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…ä½¿ç”¨å‘½ä»¤å¼æ–¹æ³•ï¼ˆé€‚åˆå¿«é€Ÿæ“ä½œï¼‰ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image deployment/nginx-deployment nginx=nginx:1.21</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ç›‘æ§æ›´æ–°çŠ¶æ€ï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout status deployment/nginx-deployment</span><br><span class="line"><span class="comment"># è¾“å‡ºå°†æ˜¾ç¤ºæ›´æ–°è¿›åº¦ï¼Œç›´åˆ°... &quot;deployment &quot;nginx-deployment&quot; successfully rolled out&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£å¯ä»¥å®æ—¶è§‚å¯ŸPodçš„å˜åŒ–</span></span><br><span class="line">kubectl get pods -l app=nginx -w</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>B. æ‰§è¡Œå›æ»šæ“ä½œ</strong></p>
<ol>
<li><p><strong>æŸ¥çœ‹å†å²ç‰ˆæœ¬ï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout <span class="built_in">history</span> deployment/nginx-deployment</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç¤ºä¾‹ï¼š</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">REVISION</span>  CHANGE-CAUSE</span><br><span class="line"><span class="number">1</span>         &lt;<span class="literal">none</span>&gt;          <span class="comment"># åˆå§‹éƒ¨ç½² nginx:1.20</span></span><br><span class="line"><span class="number">2</span>         &lt;<span class="literal">none</span>&gt;          <span class="comment"># æ›´æ–°åˆ° nginx:1.21</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>æ‰§è¡Œå›æ»šï¼ˆåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼‰ï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment/nginx-deployment</span><br></pre></td></tr></table></figure>
<p>è¿™æ¡å‘½ä»¤ä¼šå°†Deploymentå›æ»šåˆ°Revision 1 (<code>nginx:1.20</code>)ã€‚</p>
</li>
<li><p><strong>å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ï¼š</strong><br>å¦‚æœæƒ³å›æ»šåˆ°æ›´æ—©çš„ç‰ˆæœ¬ï¼ˆæ¯”å¦‚ä»ç‰ˆæœ¬3å›æ»šåˆ°ç‰ˆæœ¬1ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨<code>--to-revision</code>å‚æ•°ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment/nginx-deployment --to-revision=1</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ç›‘æ§å›æ»šçŠ¶æ€ï¼š</strong><br>åŒæ ·ä½¿ç”¨<code>rollout status</code>å‘½ä»¤æ¥ç›‘æ§å›æ»šè¿‡ç¨‹ã€‚</p>
</li>
</ol>
<h4 id="4-æ‰©å±•çŸ¥è¯†-æœ€ä½³å®è·µ"><a href="#4-æ‰©å±•çŸ¥è¯†-æœ€ä½³å®è·µ" class="headerlink" title="4. æ‰©å±•çŸ¥è¯†&#x2F;æœ€ä½³å®è·µ"></a>4. æ‰©å±•çŸ¥è¯†&#x2F;æœ€ä½³å®è·µ</h4><ul>
<li><strong>ä½¿ç”¨<code>Readiness Probes</code>ï¼š</strong> <strong>è¿™æ˜¯ç¡®ä¿é›¶åœæœºæ›´æ–°çš„å…³é”®ï¼</strong> <code>Deployment</code>åœ¨è®¤ä¸ºä¸€ä¸ªæ–°Podâ€œå¯ç”¨â€ä¹‹å‰ï¼Œä¼šç­‰å¾…å®ƒçš„<code>Readiness Probe</code>æˆåŠŸã€‚å¦‚æœæ–°ç‰ˆæœ¬çš„Podæœ‰é—®é¢˜ï¼ˆä¾‹å¦‚å¯åŠ¨å¤±è´¥æˆ–æ— æ³•å“åº”è¯·æ±‚ï¼‰ï¼Œå®ƒçš„<code>Readiness Probe</code>ä¼šå¤±è´¥ï¼Œæ»šåŠ¨æ›´æ–°å°±ä¼š<strong>è‡ªåŠ¨æš‚åœ</strong>ï¼Œä»è€Œé˜²æ­¢æœ‰é—®é¢˜çš„ç‰ˆæœ¬å®Œå…¨æ¥ç®¡æµé‡ï¼Œè¿™ç»™äº†ä½ æ—¶é—´å»è°ƒæŸ¥å’Œå›æ»šã€‚</li>
<li><strong>ç‰ˆæœ¬å†å²è®°å½• (<code>revisionHistoryLimit</code>)ï¼š</strong> åœ¨<code>Deployment</code>çš„<code>spec</code>ä¸­ï¼Œå¯ä»¥è®¾ç½®<code>revisionHistoryLimit</code>å­—æ®µï¼ˆé»˜è®¤ä¸º10ï¼‰ï¼Œç”¨æ¥æŒ‡å®šä¿ç•™æ—§<code>ReplicaSet</code>çš„æ•°é‡ã€‚è¿™æœ‰åŠ©äºé˜²æ­¢<code>etcd</code>ä¸­å­˜å‚¨è¿‡å¤šçš„å†å²è®°å½•ã€‚</li>
<li><strong>è®°å½•å˜æ›´åŸå›  (Change Cause)ï¼š</strong> åœ¨ä½¿ç”¨<code>kubectl apply</code>æˆ–<code>kubectl set image</code>æ—¶ï¼ŒåŠ ä¸Š<code>--record</code>æ ‡å¿—(å·²åºŸå¼ƒ, ä½†å¸¸è€ƒ)å¯ä»¥è®°å½•å‘½ä»¤åˆ°ä¿®è®¢å†å²ä¸­ï¼Œæ–¹ä¾¿è¿½æº¯ã€‚ç°åœ¨æ›´æ¨èçš„åšæ³•æ˜¯é€šè¿‡Gitç­‰ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿæ¥ç®¡ç†YAMLæ–‡ä»¶ï¼Œå˜æ›´åŸå› è‡ªç„¶è®°å½•åœ¨commit messageä¸­ï¼Œè¿™æ˜¯æ›´è§„èŒƒçš„GitOpså®è·µã€‚</li>
</ul>
<p><strong>ç»“è®ºï¼š</strong> Kubernetesé€šè¿‡<code>Deployment</code>æ§åˆ¶å™¨åŠå…¶ç®¡ç†çš„<code>ReplicaSet</code>å†å²ï¼Œæä¾›äº†å¼ºå¤§è€Œçµæ´»çš„æ»šåŠ¨æ›´æ–°å’Œå›æ»šæœºåˆ¶ã€‚é…ç½®å¥½<code>maxSurge</code>ã€<code>maxUnavailable</code>å’Œ<code>readinessProbe</code>æ˜¯å®ç°å®‰å…¨ã€é›¶åœæœºåº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„æ ¸å¿ƒå®è·µã€‚ </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/k8s%20Service&Ingress/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="å…­ä¸€">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/k8s%20Service&Ingress/" class="post-title-link" itemprop="url">k8s Service&Ingress</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-11 20:32:34 / ä¿®æ”¹æ—¶é—´ï¼š21:44:10" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/%E9%9D%A2%E8%AF%95%E9%A2%98/" itemprop="url" rel="index"><span itemprop="name">é¢è¯•é¢˜</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>2.6k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>2 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>è¯·è§£é‡Š Kubernetes ä¸­çš„ Service å’Œ Ingress çš„åŒºåˆ«ï¼Œå¹¶æè¿°å„è‡ªçš„ç”¨é€”ã€‚	</p>
<h3 id="ğŸ¤”-åˆ†æè¿‡ç¨‹ï¼š"><a href="#ğŸ¤”-åˆ†æè¿‡ç¨‹ï¼š" class="headerlink" title="ğŸ¤” åˆ†æè¿‡ç¨‹ï¼š"></a>ğŸ¤” åˆ†æè¿‡ç¨‹ï¼š</h3><p>è¯¥é—®é¢˜æ—¨åœ¨è€ƒå¯Ÿé¢è¯•è€…å¯¹Kubernetesä¸­ä¸¤ç§æ ¸å¿ƒç½‘ç»œèµ„æºâ€”â€”<code>Service</code>å’Œ<code>Ingress</code>çš„ç†è§£ã€‚æ ¸å¿ƒè€ƒå¯Ÿç‚¹åœ¨äºå®ƒä»¬åˆ†åˆ«åœ¨å“ªä¸ªç½‘ç»œå±‚çº§å·¥ä½œï¼ˆL4 vs L7ï¼‰ï¼Œå„è‡ªè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Œä»¥åŠå®ƒä»¬å¦‚ä½•ååŒå·¥ä½œã€‚ä¸€ä¸ªä¼˜ç§€çš„ç­”æ¡ˆéœ€è¦æ¸…æ™°åœ°å®šä¹‰ä¸¤è€…ï¼Œå¯¹æ¯”å…¶åŠŸèƒ½ï¼Œå¹¶èƒ½ç»“åˆå®é™…åº”ç”¨åœºæ™¯è¯´æ˜ä½•æ—¶ä½¿ç”¨å“ªä¸€ä¸ªã€‚</p>
<h3 id="ğŸ’¡-ç­”æ¡ˆç”Ÿæˆï¼š"><a href="#ğŸ’¡-ç­”æ¡ˆç”Ÿæˆï¼š" class="headerlink" title="ğŸ’¡ ç­”æ¡ˆç”Ÿæˆï¼š"></a>ğŸ’¡ ç­”æ¡ˆç”Ÿæˆï¼š</h3><h4 id="1-æ¦‚å¿µæˆ–å®šä¹‰"><a href="#1-æ¦‚å¿µæˆ–å®šä¹‰" class="headerlink" title="1. æ¦‚å¿µæˆ–å®šä¹‰"></a>1. æ¦‚å¿µæˆ–å®šä¹‰</h4><ul>
<li><p><strong>Service (æœåŠ¡):</strong> æ˜¯Kubernetesä¸­çš„ä¸€ä¸ªæ ¸å¿ƒAPIå¯¹è±¡ï¼Œå®ƒå®šä¹‰äº†ä¸€ç»„é€»è¾‘ä¸Šçš„Podï¼Œå¹¶ä¸ºå®ƒä»¬æä¾›äº†ä¸€ä¸ªå•ä¸€ã€ç¨³å®šçš„è®¿é—®å…¥å£ï¼ˆä¸€ä¸ªè™šæ‹ŸIPåœ°å€å’ŒDNSåç§°ï¼‰ã€‚<strong>Serviceä¸»è¦å·¥ä½œåœ¨ç½‘ç»œæ¨¡å‹çš„ç¬¬å››å±‚ï¼ˆL4 - TCP&#x2F;UDPï¼‰</strong>ï¼Œå®ƒå…³å¿ƒçš„æ˜¯å¦‚ä½•å°†ç½‘ç»œæµé‡å¯é åœ°è½¬å‘åˆ°åç«¯çš„Podï¼Œè€Œä¸å…³å¿ƒæµé‡çš„å…·ä½“å†…å®¹ã€‚</p>
</li>
<li><p><strong>Ingress (å…¥å£):</strong> æ˜¯ä¸€ä¸ªAPIå¯¹è±¡ï¼Œç”¨äºç®¡ç†å¯¹é›†ç¾¤å†…Serviceçš„å¤–éƒ¨è®¿é—®ï¼Œ<strong>ä¸»è¦å·¥ä½œåœ¨ç½‘ç»œæ¨¡å‹çš„ç¬¬ä¸ƒå±‚ï¼ˆL7 - HTTP&#x2F;Sï¼‰</strong>ã€‚Ingresså¯ä»¥æä¾›åŸºäºä¸»æœºåï¼ˆHost-basedï¼‰å’ŒURLè·¯å¾„ï¼ˆPath-basedï¼‰çš„è·¯ç”±ã€TLS&#x2F;SSLç»ˆæ­¢ä»¥åŠè´Ÿè½½å‡è¡¡ç­‰é«˜çº§åŠŸèƒ½ã€‚å®ƒæœ¬èº«ä¸æ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œè€Œæ˜¯ä¸€ç»„è·¯ç”±è§„åˆ™çš„é›†åˆï¼Œéœ€è¦ä¸€ä¸ª<strong>Ingress Controller</strong>æ¥ä½¿è¿™äº›è§„åˆ™ç”Ÿæ•ˆã€‚</p>
</li>
</ul>
<h4 id="2-å·¥ä½œåŸç†-æœºåˆ¶"><a href="#2-å·¥ä½œåŸç†-æœºåˆ¶" class="headerlink" title="2. å·¥ä½œåŸç†&#x2F;æœºåˆ¶"></a>2. å·¥ä½œåŸç†&#x2F;æœºåˆ¶</h4><ul>
<li><p><strong>Service çš„å·¥ä½œåŸç†:</strong></p>
<ol>
<li>å½“ä¸€ä¸ªServiceè¢«åˆ›å»ºæ—¶ï¼Œå®ƒä¼šè·å¾—ä¸€ä¸ªè™šæ‹Ÿçš„ã€ç¨³å®šçš„IPåœ°å€ï¼ˆ<code>ClusterIP</code>ï¼‰ã€‚</li>
<li><code>kube-proxy</code>ç»„ä»¶åœ¨é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå®ƒä¼šç›‘è§†Serviceå’Œå…¶åç«¯Podï¼ˆEndpointsï¼‰çš„å˜åŒ–ã€‚</li>
<li><code>kube-proxy</code>ä¼šæ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œåœ¨èŠ‚ç‚¹ä¸Šé…ç½®<code>iptables</code>è§„åˆ™æˆ–<code>IPVS</code>è§„åˆ™ã€‚</li>
<li>å½“æµé‡è¢«å‘é€åˆ°Serviceçš„<code>ClusterIP</code>æ—¶ï¼ŒèŠ‚ç‚¹çš„ç½‘ç»œåè®®æ ˆä¼šæ ¹æ®è¿™äº›è§„åˆ™ï¼Œå°†æµé‡è¿›è¡Œè´Ÿè½½å‡è¡¡å¹¶è½¬å‘ï¼ˆDNATï¼‰åˆ°ä¸€ä¸ªå¥åº·çš„åç«¯Podçš„å®é™…IPåœ°å€ä¸Šã€‚</li>
</ol>
</li>
<li><p><strong>Ingress çš„å·¥ä½œåŸç†:</strong></p>
<ol>
<li>ç®¡ç†å‘˜é¦–å…ˆåœ¨é›†ç¾¤ä¸­éƒ¨ç½²ä¸€ä¸ª<strong>Ingress Controller</strong>ï¼ˆä¾‹å¦‚ NGINX Ingress Controller, Traefik, HAProxy Ingressç­‰ï¼‰ã€‚Ingress Controlleræœ¬èº«æ˜¯ä¸€ä¸ªæˆ–ä¸€ç»„Podï¼Œå…¶ä¸­è¿è¡Œç€ä¸€ä¸ªåå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡å™¨ã€‚</li>
<li>å½“ç”¨æˆ·åˆ›å»ºä¸€ä¸ªIngressèµ„æºï¼ˆä¸€ä¸ªYAMLæ–‡ä»¶ï¼Œå®šä¹‰äº†è·¯ç”±è§„åˆ™ï¼‰æ—¶ï¼ŒIngress Controllerä¼šç›‘å¬åˆ°è¿™ä¸ªèµ„æºçš„åˆ›å»ºæˆ–å˜æ›´ã€‚</li>
<li>Ingress Controllerä¼šè§£æIngressèµ„æºä¸­çš„è§„åˆ™ï¼ˆä¾‹å¦‚ï¼Œ<code>host: foo.bar.com, path: /bar</code> è·¯ç”±åˆ° <code>service-a</code>ï¼‰ã€‚</li>
<li>ç„¶åï¼ŒIngress Controllerä¼šåŠ¨æ€åœ°æ›´æ–°å…¶å†…éƒ¨çš„åå‘ä»£ç†é…ç½®ï¼ˆå¦‚<code>nginx.conf</code>ï¼‰ï¼Œä½¿å…¶èƒ½å¤Ÿæ ¹æ®è¿™äº›è§„åˆ™æ¥è·¯ç”±å¤–éƒ¨æµé‡ã€‚</li>
<li>å¤–éƒ¨æµé‡é¦–å…ˆåˆ°è¾¾Ingress Controllerçš„å…¥å£ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ª<code>LoadBalancer</code>ç±»å‹çš„Serviceï¼‰ï¼Œç„¶åç”±Ingress Controlleræ ¹æ®HTTPè¯·æ±‚çš„ä¸»æœºåå’Œè·¯å¾„ï¼Œå°†æµé‡æ™ºèƒ½åœ°è½¬å‘åˆ°å¯¹åº”çš„åç«¯Serviceã€‚</li>
</ol>
</li>
</ul>
<h4 id="3-åº”ç”¨åœºæ™¯-ä½œç”¨-æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”"><a href="#3-åº”ç”¨åœºæ™¯-ä½œç”¨-æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”" class="headerlink" title="3. åº”ç”¨åœºæ™¯&#x2F;ä½œç”¨ (æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”)"></a>3. åº”ç”¨åœºæ™¯&#x2F;ä½œç”¨ (æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”)</h4><table>
<thead>
<tr>
<th align="left">ç‰¹æ€§</th>
<th align="left">Service</th>
<th align="left">Ingress</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>å·¥ä½œå±‚çº§</strong></td>
<td align="left"><strong>L4 (TCP&#x2F;UDP)</strong></td>
<td align="left"><strong>L7 (HTTP&#x2F;S)</strong></td>
</tr>
<tr>
<td align="left"><strong>ä¸»è¦ä½œç”¨</strong></td>
<td align="left">åœ¨é›†ç¾¤å†…éƒ¨æä¾›<strong>æœåŠ¡å‘ç°</strong>å’Œ<strong>è´Ÿè½½å‡è¡¡</strong></td>
<td align="left">æä¾›ä»é›†ç¾¤å¤–éƒ¨åˆ°å†…éƒ¨çš„<strong>HTTP&#x2F;Sè·¯ç”±</strong></td>
</tr>
<tr>
<td align="left"><strong>è·¯ç”±èƒ½åŠ›</strong></td>
<td align="left">åªèƒ½æ ¹æ®IPå’Œç«¯å£è¿›è¡Œè½¬å‘ï¼Œæ— æ³•è¯†åˆ«HTTPè·¯å¾„æˆ–ä¸»æœºå</td>
<td align="left">å¯æ ¹æ®HTTPä¸»æœºåå’ŒURLè·¯å¾„è¿›è¡Œæ™ºèƒ½è·¯ç”±</td>
</tr>
<tr>
<td align="left"><strong>å…¸å‹ç”¨é€”</strong></td>
<td align="left">1. é›†ç¾¤å†…éƒ¨å¾®æœåŠ¡ä¹‹é—´çš„é€šä¿¡<br>2. é€šè¿‡<code>NodePort</code>æˆ–<code>LoadBalancer</code>æš´éœ²å•ä¸ªéHTTPæœåŠ¡</td>
<td align="left">1. ä½¿ç”¨ä¸€ä¸ªå…¬ç½‘IPæš´éœ²å¤šä¸ªHTTP&#x2F;SæœåŠ¡<br>2. å®ç°ç°åº¦å‘å¸ƒã€è“ç»¿éƒ¨ç½²çš„æµé‡åˆ‡åˆ†<br>3. é›†ä¸­è¿›è¡ŒTLS&#x2F;SSLè¯ä¹¦ç®¡ç†å’Œå¸è½½</td>
</tr>
<tr>
<td align="left"><strong>ä¾èµ–å…³ç³»</strong></td>
<td align="left">Kubernetesæ ¸å¿ƒç»„ä»¶ï¼Œæ— éœ€é¢å¤–éƒ¨ç½²</td>
<td align="left"><strong>å¿…é¡»ä¾èµ–ä¸€ä¸ªIngress Controller</strong>æ‰èƒ½å·¥ä½œ</td>
</tr>
</tbody></table>
<p><strong>ç®€å•æ¥è¯´ï¼š</strong> ä½ éœ€è¦å…ˆæœ‰ä¸€ä¸ª<code>Service</code>æ¥æš´éœ²ä½ çš„åº”ç”¨ï¼ˆå“ªæ€•åªæ˜¯<code>ClusterIP</code>ç±»å‹ï¼‰ï¼Œç„¶åæ‰èƒ½åˆ›å»ºä¸€ä¸ª<code>Ingress</code>è§„åˆ™ï¼Œå‘Šè¯‰Ingress Controllerâ€œå½“æŸä¸ªURLè¢«è®¿é—®æ—¶ï¼Œè¯·æŠŠæµé‡è½¬å‘ç»™è¿™ä¸ª<code>Service</code>â€ã€‚</p>
<h4 id="4-ä¼˜åŠ¿-åŠ£åŠ¿ï¼ˆå¦‚é€‚ç”¨ï¼‰"><a href="#4-ä¼˜åŠ¿-åŠ£åŠ¿ï¼ˆå¦‚é€‚ç”¨ï¼‰" class="headerlink" title="4. ä¼˜åŠ¿&#x2F;åŠ£åŠ¿ï¼ˆå¦‚é€‚ç”¨ï¼‰"></a>4. ä¼˜åŠ¿&#x2F;åŠ£åŠ¿ï¼ˆå¦‚é€‚ç”¨ï¼‰</h4><ul>
<li><p><strong>Service (<code>LoadBalancer</code> ç±»å‹) çš„åŠ£åŠ¿:</strong></p>
<ul>
<li><strong>æˆæœ¬é«˜æ˜‚:</strong> æ¯æš´éœ²ä¸€ä¸ª<code>LoadBalancer</code>ç±»å‹çš„Serviceï¼Œé€šå¸¸éƒ½éœ€è¦äº‘æœåŠ¡å•†æä¾›ä¸€ä¸ªå…¬ç½‘IPå’Œä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨å®ä¾‹ï¼Œè¿™ä¼šå¸¦æ¥é¢å¤–çš„æˆæœ¬ã€‚</li>
<li><strong>åŠŸèƒ½å•ä¸€:</strong> åªèƒ½åšç®€å•çš„L4æµé‡è½¬å‘ï¼Œæ— æ³•æ»¡è¶³å¤æ‚çš„è·¯ç”±éœ€æ±‚ã€‚</li>
</ul>
</li>
<li><p><strong>Ingress çš„ä¼˜åŠ¿:</strong></p>
<ul>
<li><strong>æˆæœ¬æ•ˆç›Šé«˜:</strong> åªéœ€ä¸€ä¸ªå…¬ç½‘IPï¼ˆé€šè¿‡Ingress Controllerçš„LoadBalancerï¼‰ï¼Œå°±å¯ä»¥ä¸ºæ— æ•°ä¸ªåç«¯Serviceæä¾›å…¥å£ï¼Œæå¤§èŠ‚çœäº†IPèµ„æºå’Œæˆæœ¬ã€‚</li>
<li><strong>åŠŸèƒ½å¼ºå¤§:</strong> æä¾›äº†ä¸°å¯Œçš„L7è·¯ç”±èƒ½åŠ›ï¼Œé…ç½®çµæ´»ï¼Œæ˜¯ç°ä»£åŒ–Webåº”ç”¨æ¶æ„çš„äº‹å®æ ‡å‡†ã€‚</li>
</ul>
</li>
</ul>
<h4 id="5-æ‰©å±•çŸ¥è¯†-æœ€ä½³å®è·µ"><a href="#5-æ‰©å±•çŸ¥è¯†-æœ€ä½³å®è·µ" class="headerlink" title="5. æ‰©å±•çŸ¥è¯†&#x2F;æœ€ä½³å®è·µ"></a>5. æ‰©å±•çŸ¥è¯†&#x2F;æœ€ä½³å®è·µ</h4><ul>
<li><strong>Gateway API:</strong> Ingressæ­£åœ¨è¢«åŠŸèƒ½æ›´å¼ºå¤§ã€è§’è‰²æ›´æ¸…æ™°çš„<strong>Gateway API</strong>æ‰€é€æ­¥å–ä»£ã€‚Gateway APIå°†è·¯ç”±åŠŸèƒ½åˆ†è§£ä¸º<code>GatewayClass</code>, <code>Gateway</code>å’Œ<code>HTTPRoute</code>ç­‰è§’è‰²ï¼Œä½¿å¾—åŸºç¡€è®¾æ–½å›¢é˜Ÿã€é›†ç¾¤ç®¡ç†å‘˜å’Œåº”ç”¨å¼€å‘è€…å¯ä»¥æ›´å¥½åœ°ååŒå·¥ä½œã€‚äº†è§£Gateway APIæ˜¯å±•ç°ä½ çŸ¥è¯†å‰æ²¿æ€§çš„ä¸€ä¸ªåŠ åˆ†é¡¹ã€‚</li>
<li><strong>æœ€ä½³å®è·µ:</strong> åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯¹äºéœ€è¦å¯¹å¤–æš´éœ²çš„HTTP&#x2F;SæœåŠ¡ï¼Œ<strong>æ ‡å‡†åšæ³•</strong>æ˜¯ä½¿ç”¨<code>Ingress</code>ã€‚åç«¯Serviceçš„ç±»å‹åº”è®¾ç½®ä¸º<code>ClusterIP</code>ï¼Œè€Œä¸æ˜¯<code>NodePort</code>ï¼Œè¿™æ ·å¯ä»¥é¿å…ä¸å¿…è¦åœ°åœ¨èŠ‚ç‚¹ä¸Šæš´éœ²ç«¯å£ï¼Œå¢å¼ºå®‰å…¨æ€§ã€‚<code>Service (LoadBalancer)</code>é€šå¸¸åªç”¨äºæš´éœ²å•ä¸ªTCPæœåŠ¡ï¼ˆå¦‚æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ï¼‰ã€‚</li>
<li><strong>é€‰æ‹©Ingress Controller:</strong> NGINX Ingress Controllerå› å…¶ç¨³å®šæ€§å’Œå¹¿æ³›çš„ç¤¾åŒºæ”¯æŒæˆä¸ºæœ€å¸¸è§çš„é€‰æ‹©ã€‚Traefikåœ¨è‡ªåŠ¨åŒ–å’ŒåŠ¨æ€é…ç½®æ–¹é¢è¡¨ç°ä¼˜å¼‚ï¼Œå°¤å…¶é€‚åˆäº‘åŸç”Ÿç¯å¢ƒã€‚</li>
</ul>
<p><strong>ç»“è®ºï¼š</strong> Serviceæ˜¯å®ç°é›†ç¾¤å†…Podé—´é€šä¿¡å’Œè´Ÿè½½å‡è¡¡çš„L4æŠ½è±¡ï¼Œè€ŒIngressæ˜¯ç®¡ç†å¤–éƒ¨HTTP&#x2F;Sæµé‡åˆ°å†…éƒ¨æœåŠ¡çš„L7è·¯ç”±è§„åˆ™é›†åˆï¼Œä¸¤è€…ååŒå·¥ä½œï¼Œæ„æˆäº†Kuberneteså¼ºå¤§çš„ç½‘ç»œæœåŠ¡æš´éœ²èƒ½åŠ›ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/17/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><span class="page-number current">18</span><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/19/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">å…­ä¸€</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">273</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/huiaz" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;huiaz" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">å…­ä¸€</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.7m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">25:34</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true}});</script></body>
</html>
