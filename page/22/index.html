<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hui&#39;s Blog">
<meta property="og:url" content="http://example.com/page/22/index.html">
<meta property="og:site_name" content="Hui&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="六一">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/22/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hui's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hui's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Code Life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">代理模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:11:06" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WEB/" itemprop="url" rel="index"><span itemprop="name">WEB</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WEB/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="什么是正向代理？"><a href="#什么是正向代理？" class="headerlink" title="什么是正向代理？"></a>什么是正向代理？</h3><p><strong>正向代理（Forward Proxy）</strong>，通常我们所说的“代理服务器”指的就是正向代理。它是一个位于<strong>客户端</strong>和<strong>目标服务器</strong>之间的服务器。</p>
<ul>
<li><strong>工作原理：</strong> 客户端明确知道自己要访问的目标服务器，但它不直接与目标服务器通信，而是将请求发送给正向代理服务器，由代理服务器去访问目标服务器，然后将目标服务器的响应返回给客户端。</li>
<li><strong>隐藏谁？</strong> 隐藏的是真实的<strong>客户端</strong>。对于目标服务器来说，它只知道请求来自代理服务器，而不知道是哪个客户端发起的。</li>
<li><strong>应用场景：</strong><ul>
<li><strong>规避防火墙或网络限制：</strong> 例如，在某些地区或公司网络中，访问特定网站被限制，可以通过境外或未受限地区的正向代理服务器进行访问。</li>
<li><strong>访问内部资源：</strong> 例如，公司内部网络通过一个统一的正向代理出口访问互联网资源。</li>
<li><strong>提高访问速度：</strong> 代理服务器可以缓存内容，当多个用户访问同一资源时，可以直接从代理缓存中获取，加快速度。</li>
<li><strong>匿名访问：</strong> 隐藏真实 IP 地址，保护用户隐私。</li>
<li><strong>网络安全审计：</strong> 记录所有经过代理的请求，进行内容过滤和安全检查。</li>
</ul>
</li>
</ul>
<p><strong>简单理解：</strong> 客户端请求一个它想访问的网站A，告诉代理服务器，代理服务器代替客户端去访问网站A，然后把网站A的内容返回给客户端。客户端知道代理服务器的存在，并且是主动使用代理服务器的。</p>
<h3 id="什么是反向代理？"><a href="#什么是反向代理？" class="headerlink" title="什么是反向代理？"></a>什么是反向代理？</h3><p><strong>反向代理（Reverse Proxy）</strong> 也是一个代理服务器，但它位于<strong>用户（客户端）</strong>和<strong>后端服务器集群</strong>之间。</p>
<ul>
<li><strong>工作原理：</strong> 客户端发送请求到反向代理服务器，客户端并不知道背后有多少台服务器，也不知道具体是哪台服务器处理的请求。反向代理服务器接收请求后，再根据内部规则（如负载均衡算法、请求路由规则等）将请求转发给后端的一台或多台真实的服务器，然后将后端服务器的响应返回给客户端。</li>
<li><strong>隐藏谁？</strong> 隐藏的是真实的<strong>后端服务器</strong>。对于客户端来说，它只知道请求发给了反向代理服务器，而不知道背后有多少台（或哪台）后端服务器在提供服务。它误以为反向代理服务器就是真正的服务器。</li>
<li><strong>应用场景：</strong><ul>
<li><strong>负载均衡：</strong> 将客户端请求分发到多台后端服务器上，均衡各服务器的负载，提高系统性能和可用性。</li>
<li><strong>增强安全性：</strong> 隐藏后端服务器的真实 IP 地址和端口，只暴露反向代理服务器，后端服务器不直接暴露在公网，抵御外部攻击。</li>
<li><strong>SSL&#x2F;TLS 卸载：</strong> 在反向代理层处理 HTTPS 的加密解密工作，减轻后端服务器的计算压力，提高后端服务器的处理能力。</li>
<li><strong>统一入口和管理：</strong> 客户端无需知道后端服务的复杂性，所有请求都通过反向代理这一个统一入口。</li>
<li><strong>静态资源缓存：</strong> 反向代理服务器可以缓存静态文件，减轻后端服务器的压力，加速响应。</li>
<li><strong>A&#x2F;B 测试和灰度发布：</strong> 根据规则将一部分用户请求转发到新版本的服务上，实现平滑升级。</li>
</ul>
</li>
</ul>
<p><strong>简单理解：</strong> 客户端向代理服务器发送请求，它以为代理服务器就是它要访问的网站。代理服务器收到请求后，根据内部配置决定把请求转交给哪个真正的后端服务器，后端服务器处理完后，把结果返回给代理服务器，代理服务器再返回给客户端。客户端不知道它访问的网站实际上是由代理服务器背后的多台服务器提供服务的。</p>
<h3 id="如何使用-Nginx-做反向代理？"><a href="#如何使用-Nginx-做反向代理？" class="headerlink" title="如何使用 Nginx 做反向代理？"></a>如何使用 Nginx 做反向代理？</h3><p>Nginx 是一个非常强大的反向代理服务器。其配置相对简洁明了。</p>
<p>以下是一个基本的 Nginx 反向代理配置示例，假设你有两个后端服务器：<code>backend1.example.com</code> 和 <code>backend2.example.com</code>，它们都在 8000 端口提供服务。我们希望通过 Nginx 监听 80 端口，并将请求代理到这两台后端服务器。</p>
<p>我们将配置写在 Nginx 的配置文件中，通常是 <code>/etc/nginx/nginx.conf</code> 或在 <code>conf.d</code> 目录下的一个<code>.conf</code>文件，例如 <code>/etc/nginx/conf.d/proxy.conf</code>。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1: 定义一个上游服务器组 (upstream)，用于负载均衡后端服务器</span></span><br><span class="line"><span class="comment"># 这个 upstream 块定义了一个名为 &#x27;my_backend_servers&#x27; 的逻辑组</span></span><br><span class="line"><span class="section">upstream</span> my_backend_servers &#123;</span><br><span class="line">    <span class="comment"># server 指令指定了后端服务器的地址和端口</span></span><br><span class="line">    <span class="comment"># weight 参数表示服务器的权重，权重越高，被分配到的请求越多</span></span><br><span class="line">    <span class="comment"># 可选的 max_fails 和 fail_timeout 用于健康检查</span></span><br><span class="line">    <span class="attribute">server</span> backend1.example.com:<span class="number">8000</span> weight=<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com:<span class="number">8000</span> weight=<span class="number">1</span>;</span><br><span class="line">    <span class="comment"># 也可以是 IP 地址</span></span><br><span class="line">    <span class="comment"># server 192.168.1.10:8000 weight=3;</span></span><br><span class="line">    <span class="comment"># server 192.168.1.11:8000 weight=1;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 可选的负载均衡算法（默认是轮询）</span></span><br><span class="line">    <span class="comment"># round </span></span><br><span class="line">    <span class="comment"># least_conn; # 最少连接数，将请求发往连接数最少的服务器</span></span><br><span class="line">    <span class="comment"># ip_hash;    # 根据客户端IP的哈希值来分配请求，确保同一客户端请求始终发往同一服务器</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2: 配置一个 server 块来监听客户端请求</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>; <span class="comment"># Nginx 监听 80 端口，接收 HTTP 请求</span></span><br><span class="line">    <span class="attribute">server_name</span> your_domain.com www.your_domain.com; <span class="comment"># 你的域名，客户端通过这个域名访问Nginx</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># step 3: 配置 location 块来定义如何处理请求</span></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="comment"># proxy_pass 指令是实现反向代理的核心</span></span><br><span class="line">        <span class="comment"># 它将所有匹配 &#x27;/ &#x27; 路径的请求转发到上面定义的 &#x27;my_backend_servers&#x27; 上游组</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://my_backend_servers; </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 以下是常见的反向代理配置，用于正确处理请求头，确保后端服务器能获取到客户端的真实信息</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 设置 X-Real-IP 头，将客户端的真实 IP 地址传递给后端服务器</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="comment"># 设置 X-Forwarded-For 头，记录客户端到代理服务器的完整路径，</span></span><br><span class="line">        <span class="comment"># 如果有多个代理，会看到一个 IP 列表，第一个是真实客户端 IP</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="comment"># 设置 Host 头，将客户端请求的原始 Host 头传递给后端服务器</span></span><br><span class="line">        <span class="comment"># 否则，后端可能会看到Nginx服务器的Host或者upstream名字</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>; </span><br><span class="line">      </span><br><span class="line">        <span class="comment"># 允许后端服务器重定向到 HTTPS 或其他域名时使用正确的协议和主机名</span></span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 可选：设置连接和读取超时时间，防止因后端响应慢而导致客户端等待过久</span></span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">60s</span>;</span><br><span class="line">        <span class="attribute">proxy_send_timeout</span> <span class="number">60s</span>;</span><br><span class="line">        <span class="attribute">proxy_read_timeout</span> <span class="number">60s</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 可选：缓冲设置，Nginx会先接收后端服务器的响应，满足条件后才发送给客户端</span></span><br><span class="line">        <span class="comment"># 这对于处理慢速后端或优化网络传输有用</span></span><br><span class="line">        <span class="attribute">proxy_buffering</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">proxy_buffers</span> <span class="number">4</span> <span class="number">32k</span>;</span><br><span class="line">        <span class="attribute">proxy_buffer_size</span> <span class="number">64k</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果有静态文件，可以单独配置，让Nginx直接处理，不经过后端，提高效率</span></span><br><span class="line">    <span class="section">location</span> <span class="regexp">~* \.(jpg|jpeg|gif|png|css|js|ico|woff|woff2|ttf|svg|eot)$</span> &#123;</span><br><span class="line">        <span class="attribute">root</span> /var/www/your_static_files; <span class="comment"># 静态文件存放路径</span></span><br><span class="line">        <span class="attribute">expires</span> <span class="number">30d</span>; <span class="comment"># 缓存30天</span></span><br><span class="line">        <span class="attribute">access_log</span> <span class="literal">off</span>; <span class="comment"># 静态文件不记录访问日志</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置步骤和解释:</strong></p>
<ol>
<li><p><strong><code>upstream</code> 块:</strong></p>
<ul>
<li><code>upstream my_backend_servers &#123; ... &#125;</code>：这里定义了一个名为 <code>my_backend_servers</code> 的上游服务器组。Nginx 会通过这个组来管理和分发请求给后端服务器。</li>
<li><code>server backend1.example.com:8000 weight=3;</code>：指定了一个后端服务器的地址和端口。<ul>
<li><code>weight=3</code> 表示该服务器会比其他服务器获得更多的请求（权重是 3:1，即 <code>backend1</code> 获得 75% 的请求，<code>backend2</code> 获得 25%）。默认权重是 1。</li>
<li>可以添加多个 <code>server</code> 条目来包含所有的后端服务器。</li>
</ul>
</li>
<li><strong>负载均衡算法：</strong> 如果不指定，默认是 <strong>轮询（round-robin）</strong>，即依次将请求分发给组中的每个服务器。<ul>
<li><code>least_conn;</code>：将请求转发给当前活动连接数最少的服务器。适用于连接时间较长的场景。</li>
<li><code>ip_hash;</code>：根据客户端 IP 地址的哈希值来决定将请求转发给哪台服务器。这可以确保来自同一 IP 的请求始终由同一台服务器处理，对于会话粘性（session affinity）非常有用。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong><code>server</code> 块:</strong></p>
<ul>
<li><code>listen 80;</code>：Nginx 监听 80 端口，等待客户端的 HTTP 请求。</li>
<li><code>server_name your_domain.com www.your_domain.com;</code>：指定 Nginx 应该响应哪个域名。</li>
</ul>
</li>
<li><p><strong><code>location / &#123; ... &#125;</code> 块:</strong></p>
<ul>
<li><code>location / &#123; ... &#125;</code>：这个块定义了当请求的 URI 匹配 <code>/</code> 时（即所有请求）如何处理。</li>
<li><code>proxy_pass http://my_backend_servers;</code>：这是实现反向代理的核心指令。它告诉 Nginx 将匹配的请求转发到 <code>my_backend_servers</code> 这个上游组中定义的后端服务器之一。</li>
<li><strong><code>proxy_set_header</code> 配置项：</strong> 这些非常重要，它们用于将客户端请求的原始信息传递给后端服务器。<ul>
<li><code>X-Real-IP</code> 和 <code>X-Forwarded-For</code>：确保后端服务器能获取客户端的真实 IP 地址，而不是 Nginx 服务器的 IP。</li>
<li><code>Host</code>：将客户端请求的原始 <code>Host</code> 头传递给后端，这对于后端应用程序正确处理请求（例如处理虚拟主机、生成正确的回调 URL）至关重要。</li>
</ul>
</li>
<li><code>proxy_redirect off;</code>：此指令禁用 Nginx 默认的 <code>Location</code> 头修改行为。当后端服务器发送重定向响应时（例如 HTTP 301&#x2F;302），后端可能会返回一个内部 URL。<code>proxy_redirect off</code> 可以确保 Nginx 不会修改这些重定向 URL，从而防止意外的行为。通常是设置为 <code>off</code>。</li>
</ul>
</li>
</ol>
<p><strong>完成配置后的操作：</strong></p>
<ol>
<li><strong>保存配置文件。</strong></li>
<li><strong>测试配置语法：</strong> <code>sudo nginx -t</code><ul>
<li>如果输出 <code>test is successful</code>，则表示配置语法正确。如果有错误，需要根据提示进行修改。</li>
</ul>
</li>
<li><strong>重新加载 Nginx 配置：</strong> <code>sudo systemctl reload nginx</code> 或 <code>sudo service nginx reload</code><ul>
<li>这样 Nginx 就会在不中断现有连接的情况下加载新配置。</li>
</ul>
</li>
</ol>
<p>现在，当客户端访问 <code>http://your_domain.com</code> 时，Nginx 会接收请求，并根据 <code>my_backend_servers</code> 上游组中配置的负载均衡算法，将请求转发给 <code>backend1.example.com:8000</code> 或 <code>backend2.example.com:8000</code>。后端服务器处理请求后，响应会通过 Nginx 返回给客户端。客户端全程都不知道背后有多个后端服务器在工作，也看不到它们的真实 IP。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8F%AF%E8%A7%82%E6%B5%8B%E5%B9%B3%E5%8F%B0%20OpenObserve/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8F%AF%E8%A7%82%E6%B5%8B%E5%B9%B3%E5%8F%B0%20OpenObserve/" class="post-title-link" itemprop="url">云原生可观测平台 OpenObserve</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:19:47" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/%E5%8F%AF%E8%A7%82%E6%B5%8B/" itemprop="url" rel="index"><span itemprop="name">可观测</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>20 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="云原生可观测平台-OpenObserve"><a href="#云原生可观测平台-OpenObserve" class="headerlink" title="云原生可观测平台 OpenObserve"></a>云原生可观测平台 OpenObserve</h1><p><a target="_blank" rel="noopener" href="https://openobserve.ai/">OpenObserve（简称 O2）</a>是一个用 Rust 开发的开源云原生可观测平台，专为日志、指标、追踪而构建，设计用于 PB 级工作。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/wlukje.png" alt="OpenObserve"></p>
<p>与需要理解和调整大量配置置的 Elasticsearch 相比，它简单且易于操作。在 2 分钟内即可启动并运行 OpenObserve。对于使用 API 获取数据并执行搜索的用户来说，OpenObserve 可以无缝替代 Elasticsearch。OpenObserve 带有自己的用户界面，无需单独安装。与 Elasticsearch 相比，使用 OpenObserve 可以将日志存储成本降低约 140 倍。</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724479963977.png" alt="与 ES 对比"></p>
<h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><p>在详细了解 <code>O2</code> 之前，我们需要了解一些相关概念，这些概念是 <code>O2</code> 的基础。</p>
<p><strong>Organizations（组织）</strong></p>
<p>组织是 OpenObserve 中对各种流、用户、功能进行分组的逻辑实体。组织可以代表一个企业、企业的一个部门或一个应用程序。所有流、用户、功能等都限定在一个组织范围内。</p>
<p><strong>Streams（流）</strong></p>
<p>OpenObserve 中的流是共享相同源的事件序列（日志&#x2F;指标&#x2F;跟踪），例如来自特定应用程序的日志或来自企业的日志。比如日志就是一种流，用于记录来自应用程序的事件。</p>
<p><strong>Functions（函数）</strong></p>
<p>OpenObserve 中的函数可在摄取和查询期间使用，以帮助增强高级功能，如丰富、编辑、日志缩减、合规性等。函数是使用 <code>VRL</code> 脚本定义的。</p>
<p><strong>Parquet</strong></p>
<p><code>O2</code> 中的数据以 <code>parquet</code> 格式存储，这是一种列式存储格式，查询和存储效率很高。</p>
<p><strong>Timestamp（时间戳）</strong></p>
<p><code>_timestamp</code> 在 OpenObserve 中被视为时间戳列，如果 <code>_timestamp</code> 或 <code>@timestamp</code> 不存在于正在摄取的数据中，我们会将 <code>_timestamp</code> 添加到每个记录，其 <code>NOW</code> 值为微秒精度。</p>
<p>对于键为 <code>_timestamp/@timestamp</code> 的输入数据，对于值我们支持以下数据类型&#x2F;格式：</p>
<ul>
<li>微秒</li>
<li>字符串值</li>
<li>RFC 3339 和 ISO 8601 日期和时间字符串，例如 <code>1996-12-19T16:39:57-08:00</code></li>
<li>RFC 2822 日期和时间字符串，例如 <code>Tue, 1 Jul 2003 10:52:37 +0200</code></li>
</ul>
<p>如果用户想要支持 <code>_timestamp/@timestamp</code> 以外的键，用户可以使用 <code>ZO_COLUMN_TIMESTAMP</code> 配置来指定时间戳键。</p>
<p><strong>User Roles（用户角色）</strong></p>
<p>OpenObserve 中的用户可以具有 <code>admin</code> 或 <code>member</code> 角色。与具有 <code>member</code> 角色的用户相比，具有 <code>admin</code> 角色的用户拥有更大的权限，例如，具有 <code>admin</code> 角色的用户可以将其他用户添加到组织中。</p>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p>OpenObserve 可以在单节点下运行，也可以在集群中以 HA 模式运行。</p>
<h3 id="单节点模式"><a href="#单节点模式" class="headerlink" title="单节点模式"></a>单节点模式</h3><p>单节点模式也分几种架构，主要是数据存储的方式不同，主要有如下几种：</p>
<p><strong>SQLite 和本地磁盘模式</strong></p>
<p>如果你只需要进行简单使用和测试，或者对高可用性没有要求，可以使用此模式。当然你仍然可以在一台机器上每天处理超过 2 TB 的数据。在我们的测试中，使用默认配置，Mac M2 的处理速度为约 31 MB&#x2F;秒，即每分钟处理 1.8 GB，每天处理 2.6 TB。该模式也是运行 OpenObserve 的默认模式。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/89qru9.png" alt="SQLite本地模式"></p>
<p><strong>SQLite 和对象存储模式</strong></p>
<p>该模式和 OpenObserve 的默认模式基本上一致，只是数据存在了对象存储中，这样可以更好的支持高可用性，因为数据不会丢失。</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724480272710.png" alt="SQLite对象存储模式"></p>
<h3 id="高可用模式"><a href="#高可用模式" class="headerlink" title="高可用模式"></a>高可用模式</h3><p>HA 模式不支持本地磁盘存储，该模式下，OpenObserve 主要包括 <code>Router</code>、<code>Querier</code>、<code>Ingester</code>、<code>Compactor</code> 和 <code>AlertManager</code> 节点（组件），这些节点都可以水平扩展以适应更高的流量。另外使用 Etcd 或 NATS 用作集群协调器并存储节点信息，还用于集群事件。MySQL&#x2F;PostgreSQL 用于存储组织、用户、函数、报警规则、流模式和文件列表（<code>parquet</code> 文件的索引）等元数据。对象存储（例如 s3、minio、gcs 等）存储 <code>parquet</code> 文件的数据。</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724480321568.png" alt="Etcd对象存储"></p>
<p><strong>Ingester</strong></p>
<p><code>Ingester</code> 用于接收摄取请求并将数据转换为 <code>parquet</code> 格式然后存储在对象存储中，它们在将数据传输到对象存储之前将数据临时存储在 <code>WAL</code> 中。</p>
<blockquote>
<p>OpenObserve 中摄取的数据默认根据年月日和小时进行分区，我们还可以指定用于对数据进行分区的分区键。</p>
</blockquote>
<p>数据摄取流程如下所示：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724481289414.png" alt="Ingester Flow"></p>
<ol>
<li><p>从 HTTP &#x2F; gRPC API 请求接收数据。</p>
</li>
<li><p>逐行解析数据。</p>
</li>
<li><p>检查是否有任何用于转换数据的函数（摄取函数），按函数顺序调用每个摄取函数</p>
</li>
<li><p>检查时间戳字段，将时间戳转换为微秒；如果记录中不存在时间戳字段，则设置当前时间戳。</p>
</li>
<li><p>检查流 schema 以确定 schema 是否需要演变。在这里，如果我们发现需要更新 schema 以添加新字段或更改现有字段的数据类型，则获取 <code>lock</code> 来更新 schema。</p>
</li>
<li><p>评估实时报警（如果为流定义了任何报警）。</p>
</li>
<li><p>按小时桶中的时间戳写入</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">WAL</span></span><br></pre></td></tr></table></figure>

<p>文件，然后将请求中的记录转换为</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Arrow RecordBatch</span></span><br></pre></td></tr></table></figure>

<p>并写入 </p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Memtable</span></span><br></pre></td></tr></table></figure>

<ul>
<li>为每个 <code>organization/stream_type</code> 创建 <code>Memtable</code>，如果仅为日志摄取数据，则只有一个 <code>Memtable</code>。</li>
<li>WAL 文件和 <code>Metable</code> 是成对创建的，一个 WAL 文件有一个 <code>Memtable</code> 。WAL 文件位于 <code>data/wal/logs</code>。</li>
</ul>
</li>
<li><p>当 <code>Memtable</code> 大小达到 <code>ZO_MAX_FILE_SIZE_IN_MEMORY = 256MB</code> 或 WAL 文件达到 <code>ZO_MAX_FILE_SIZE_ON_DISK = 128MB</code> 时，我们将 <code>Memtable</code> 移动到 <code>Immutable</code> 并创建一个新的 <code>Memtable</code> 和 WAL 文件用于写入数据。</p>
</li>
<li><p>每 <code>ZO_MEM_PERSIST_INTERVAL=5</code> 秒会将 <code>Immutable</code> 转储到本地磁盘。一个 <code>Immutable</code> 将生成多个 <code>parquet</code> 文件，因为它可能包含多个流和多个分区，<code>parquet</code> 文件位于 <code>data/wal/files</code>。</p>
</li>
<li><p>每 <code>ZO_FILE_PUSH_INTERVAL=10</code> 秒，我们检查本地 <code>parquet</code> 文件，如果任何分区总大小超过 <code>ZO_MAX_FILE_SIZE_ON_DISK=128MB</code> 或任何文件已在 <code>ZO_MAX_FILE_RETENTION_TIME=600</code> 秒前，分区中的所有此类小文件将被合并为一个大文件（每个大文件将最大为 <code>ZO_COMPACT_MAX_FILE_SIZE=256MB</code>) ，它将被移动到对象存储。</p>
</li>
</ol>
<p>Ingester 包含三部分数据：</p>
<ol>
<li><code>Memtable</code> 中的数据</li>
<li><code>Immutable</code> 中的数据</li>
<li>WAL 中的 <code>parquet</code> 文件尚未上传到对象存储。</li>
</ol>
<p>这些数据都需要能够被查询到。</p>
<p><strong>Router</strong></p>
<p><code>Router</code>（路由器）将请求分发给 <code>ingester</code> 或 <code>querier</code>，它还通过浏览器提供 UI 界面，Router 实际上就是一个非常简单的代理，用于在摄取器和查询器之间发送适当的请求。</p>
<p><strong>Querier</strong></p>
<p><code>Querier</code>（查询器）用于查询数据，查询器节点是完全无状态的。数据查询流程如下：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/nln9vj.png" alt="Querier Flow"></p>
<ol>
<li>使用 http API 接收搜索请求。接收到查询请求的节点成为该查询的 <code>LEADER</code> 查询器。其他查询器都是 <code>WORKER</code> 查询器，用于查询。</li>
<li><code>LEADER</code> 解析并验证 SQL。</li>
<li><code>LEADER</code> 找到数据时间范围并从文件列表索引中获取文件列表。</li>
<li><code>LEADER</code> 从集群元数据中获取查询器节点。</li>
<li><code>LEADER</code> 对每个查询器要查询的文件列表进行分区。例如如果需要查询 100 个文件，并且有 5 个查询器节点，则每个查询器可以查询 20 个文件，<code>LEADER</code> 处理 20 个文件，<code>WORKERS</code> 各处理 20 个文件。</li>
<li><code>LEADER</code> 调用每个 <code>WORKER</code> 查询器上运行的 gRPC 服务，将搜索查询分派到查询器节点。查询器间通信使用 gRPC 进行。</li>
<li><code>LEADER</code> 收集、合并并将结果发送回用户。</li>
</ol>
<p>提示：</p>
<ol>
<li>默认情况下，查询器将在内存中缓存 <code>parquet</code> 文件。我们可以使用环境变量 <code>ZO_MEMORY_CACHE_MAX_SIZE</code> 配置查询器用于缓存的内存大小。默认缓存是使用特定查询器可用内存的 50% 来完成的。</li>
<li>在分布式环境中，每个查询器节点只会缓存一部分数据。</li>
<li>我们还可以选择在内存中缓存最新的 <code>parquet</code> 文件。当 <code>Ingester</code> 生成新的 <code>Parquet</code> 文件并将其上传到对象存储时，<code>Ingester</code> 将通知查询器缓存该文件。</li>
</ol>
<p><strong>Compactor</strong></p>
<p><code>Compactor</code>（压缩器）会将小文件合并成大文件，使搜索更加高效。<code>Compactor</code> 还处理数据保留策略、full stream 删除和文件列表索引更新。</p>
<p><strong>AlertManager</strong></p>
<p><code>AlertManager</code> 运行标准报警查询、报告作业并发送通知。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>由于 <code>O2</code> 用到的各个存储可选方案较多，这里我们选择使用 <code>PostgreSQL</code> 作为元数据存储，<code>Minio</code> 作为对象存储，<code>Nats</code> 作为集群协调器（建议使用 <code>Nats</code>，为了向后兼容，目前仍然支持 <code>Etcd</code>）。</p>
<p>接下来同样我们使用 <code>Helm</code> 来安装 <code>O2</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add openobserve https://charts.openobserve.ai</span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure>

<p>官方的这个 Helm Chart 默认会部署 PostgreSQL，但是需要提前安装对应的 <code>cloudnative-pg operator</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply --server-side -f \</span><br><span class="line">  https://raw.githubusercontent.com/cloudnative-pg/cloudnative-pg/release-1.23/releases/cnpg-1.23.1.yaml</span><br></pre></td></tr></table></figure>

<p>然后我们就可以在 Helm Chart 中使用 PostgreSQL 了，此外为了启用 <code>Minio</code> 和 <code>Nats</code>，我们需要在 <code>values.yaml</code> 中进行配置，修改后的 <code>values.yaml</code> 如下所示</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># o2-values.yaml</span></span><br><span class="line"><span class="comment"># auth:</span></span><br><span class="line"><span class="comment">#   ZO_ROOT_USER_EMAIL: &quot;root@example.com&quot; # default user email</span></span><br><span class="line"><span class="comment">#   ZO_ROOT_USER_PASSWORD: &quot;Complexpass#123&quot;  # default user password</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ingester:</span></span><br><span class="line">  <span class="attr">headless:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">persistence:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">storageClass:</span> <span class="string">&quot;nfs-client&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">querier:</span></span><br><span class="line">  <span class="attr">persistence:</span> <span class="comment"># If enabled it will be used for disk cache. Highly recommend to enable this for production</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">storageClass:</span> <span class="string">&quot;nfs-client&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"></span><br><span class="line"><span class="attr">nats:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">container:</span></span><br><span class="line">    <span class="attr">image:</span></span><br><span class="line">      <span class="attr">repository:</span> <span class="string">library/nats</span></span><br><span class="line">      <span class="attr">registry:</span> <span class="string">dhub.kubesre.xyz</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">cluster:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">jetstream:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">fileStore:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">pvc:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">size:</span> <span class="string">20Gi</span></span><br><span class="line">          <span class="attr">storageClassName:</span> <span class="string">&quot;nfs-client&quot;</span></span><br><span class="line">  <span class="attr">natsBox:</span></span><br><span class="line">    <span class="attr">container:</span></span><br><span class="line">      <span class="attr">image:</span></span><br><span class="line">        <span class="attr">registry:</span> <span class="string">dhub.kubesre.xyz</span></span><br><span class="line">  <span class="attr">reloader:</span></span><br><span class="line">    <span class="attr">image:</span></span><br><span class="line">      <span class="attr">registry:</span> <span class="string">dhub.kubesre.xyz</span></span><br><span class="line"></span><br><span class="line"><span class="attr">minio:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># if true then minio will be deployed as part of openobserve</span></span><br><span class="line">  <span class="attr">mode:</span> <span class="string">standalone</span> <span class="comment"># or distributed</span></span><br><span class="line">  <span class="attr">persistence:</span></span><br><span class="line">    <span class="attr">storageClass:</span> <span class="string">&quot;nfs-client&quot;</span></span><br><span class="line">  <span class="attr">consoleService:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">32001</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Postgres is used for storing openobserve metadata.</span></span><br><span class="line"><span class="comment"># Make sure to install cloudnative-pg operator before enabling this</span></span><br><span class="line"><span class="attr">postgres:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">pgadmin:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">instances:</span> <span class="number">2</span> <span class="comment"># creates a primary and a replica. replica will become primary if the primary fails</span></span><br><span class="line">    <span class="attr">storage:</span></span><br><span class="line">      <span class="attr">size:</span> <span class="string">10Gi</span></span><br><span class="line">      <span class="attr">pvcTemplate:</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">&quot;nfs-client&quot;</span></span><br></pre></td></tr></table></figure>

<p>然后我们就可以安装 <code>O2</code> 了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ helm upgrade --install o2 openobserve/openobserve -f o2-values.yaml --namespace openobserve --create-namespace</span><br><span class="line">Release <span class="string">&quot;o2&quot;</span> does not exist. Installing it now.</span><br><span class="line">NAME: o2</span><br><span class="line">LAST DEPLOYED: Sat Aug 24 17:29:23 2024</span><br><span class="line">NAMESPACE: openobserve</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">NOTES:</span><br><span class="line">1. Get the application URL by running these commands:</span><br><span class="line">  <span class="built_in">export</span> NODE_PORT=$(kubectl get --namespace openobserve -o jsonpath=<span class="string">&quot;&#123;.spec.ports[0].nodePort&#125;&quot;</span> services o2-openobserve)</span><br><span class="line">  <span class="built_in">export</span> NODE_IP=$(kubectl get nodes --namespace openobserve -o jsonpath=<span class="string">&quot;&#123;.items[0].status.addresses[0].address&#125;&quot;</span>)</span><br><span class="line">  <span class="built_in">echo</span> http://<span class="variable">$NODE_IP</span>:<span class="variable">$NODE_PORT</span></span><br></pre></td></tr></table></figure>

<p>安装完成后，我们可以通过 <code>kubectl get pods -n openobserve</code> 查看所有的 Pod 是否正常运行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods -n openobserve</span></span><br><span class="line">NAME                                          READY   STATUS    RESTARTS      AGE</span><br><span class="line">o2-minio-5ff8c55559-g6255                     1/1     Running   0             43m</span><br><span class="line">o2-nats-0                                     2/2     Running   0             32m</span><br><span class="line">o2-nats-1                                     2/2     Running   0             33m</span><br><span class="line">o2-nats-2                                     2/2     Running   0             33m</span><br><span class="line">o2-nats-box-588fb755c4-6qxl2                  1/1     Running   0             43m</span><br><span class="line">o2-openobserve-alertmanager-95796f856-c6xlg   1/1     Running   0             43m</span><br><span class="line">o2-openobserve-compactor-7f9b8cdb6b-kr8sp     1/1     Running   0             31m</span><br><span class="line">o2-openobserve-ingester-0                     1/1     Running   0             32m</span><br><span class="line">o2-openobserve-postgres-1                     1/1     Running   0             43m</span><br><span class="line">o2-openobserve-postgres-2                     1/1     Running   0             42m</span><br><span class="line">o2-openobserve-querier-0                      1/1     Running   0             43m</span><br><span class="line">o2-openobserve-router-58dc4b8fd7-vl42p        1/1     Running   0             31m</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get svc -n openobserve</span></span><br><span class="line">NAME                               TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)                         AGE</span><br><span class="line">o2-minio                           ClusterIP   10.96.2.46    &lt;none&gt;        9000/TCP                        43m</span><br><span class="line">o2-minio-console                   NodePort    10.96.0.196   &lt;none&gt;        9001:32001/TCP                  43m</span><br><span class="line">o2-nats                            ClusterIP   10.96.2.18    &lt;none&gt;        4222/TCP                        43m</span><br><span class="line">o2-nats-headless                   ClusterIP   None          &lt;none&gt;        4222/TCP,6222/TCP,8222/TCP      43m</span><br><span class="line">o2-openobserve-alertmanager        ClusterIP   10.96.1.79    &lt;none&gt;        5080/TCP,5081/TCP,5082/TCP      43m</span><br><span class="line">o2-openobserve-compactor           ClusterIP   10.96.0.207   &lt;none&gt;        5080/TCP,5081/TCP               43m</span><br><span class="line">o2-openobserve-ingester            ClusterIP   10.96.2.154   &lt;none&gt;        5080/TCP,5081/TCP               43m</span><br><span class="line">o2-openobserve-ingester-headless   ClusterIP   None          &lt;none&gt;        5080/TCP,5081/TCP               43m</span><br><span class="line">o2-openobserve-postgres-r          ClusterIP   10.96.0.123   &lt;none&gt;        5432/TCP                        43m</span><br><span class="line">o2-openobserve-postgres-ro         ClusterIP   10.96.3.208   &lt;none&gt;        5432/TCP                        43m</span><br><span class="line">o2-openobserve-postgres-rw         ClusterIP   10.96.0.165   &lt;none&gt;        5432/TCP                        43m</span><br><span class="line">o2-openobserve-querier             ClusterIP   10.96.3.13    &lt;none&gt;        5080/TCP,5081/TCP               43m</span><br><span class="line">o2-openobserve-router              NodePort    10.96.3.228   &lt;none&gt;        5080:31984/TCP,5081:32212/TCP   43m</span><br></pre></td></tr></table></figure>

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>安装完成后，我们可以通过 <code>http://&lt;NODE_IP&gt;:31984</code> 访问 <code>O2</code> 的 Web 界面，然后就可以开始使用了。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/gmomqz.png" alt="O2 Web"></p>
<p>使用默认的用户名 <code>root@example.com</code> 和密码 <code>Complexpass#123</code> 登录，然后就可以看到 <code>O2</code> 的主界面了。</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724494812951.png" alt="O2 Home"></p>
<p>因为现在我们还没有向 <code>O2</code> 中发送任何数据，所以暂时没有任何数据。我们可以切换到<strong>采集</strong>页面，里面就有各种遥测数据的采集方式。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/48nrag.png" alt="O2 采集"></p>
<h3 id="示例数据导入"><a href="#示例数据导入" class="headerlink" title="示例数据导入"></a>示例数据导入</h3><p>这里我们可以先使用 JSON API 来加载一些示例日志数据来了解一下 OpenObserve 的基本使用方法。先使用下面命令下载示例日志数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl -L https://zinc-public-data.s3.us-west-2.amazonaws.com/zinc-enl/sample-k8s-logs/k8slog_json.json.zip -o k8slog_json.json.zip</span><br><span class="line">$ unzip k8slog_json.json.zip</span><br></pre></td></tr></table></figure>

<p>然后使用下面命令将示例日志数据导入到 OpenObserve 中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://&lt;NodeIP&gt;:31984/api/default/default/_json -i -u <span class="string">&quot;root@example.com:Complexpass#123&quot;</span> -d <span class="string">&quot;@k8slog_json.json&quot;</span></span><br><span class="line">HTTP/1.1 100 Continue</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">content-length: 71</span><br><span class="line">content-type: application/json</span><br><span class="line">x-api-node: o2-openobserve-ingester-0</span><br><span class="line">access-control-allow-credentials: <span class="literal">true</span></span><br><span class="line"><span class="built_in">date</span>: Sat, 24 Aug 2024 10:31:05 GMT</span><br><span class="line">vary: accept-encoding</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;code&quot;</span>:200,<span class="string">&quot;status&quot;</span>:[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;default&quot;</span>,<span class="string">&quot;successful&quot;</span>:3846,<span class="string">&quot;failed&quot;</span>:0&#125;]&#125;%</span><br></pre></td></tr></table></figure>

<p>收据导入成功后，刷新页面即可看到有数据了：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724550564527.png" alt="OpenObserve Web"></p>
<p>在<strong>数据流</strong>页面可以看到我们导入的数据元信息：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/joltik.png" alt="Stream流"></p>
<p>然后切换到<strong>日志</strong>页面，从左侧的下拉列表中选择索引为 <code>default</code>，就可以看到日志数据了：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/9vqjlu.png" alt="O2 Logs"></p>
<p>现在我们就可以去根据直接的需求去查询日志了，比如要使用倒排索引搜索包含单词 <code>error</code> 的所有字段：</p>
<ul>
<li>在查询编辑器中使用 <code>match_all(&#39;error&#39;)</code></li>
<li><code>match_all</code> 仅搜索配置为全文搜索的字段。默认字段集包括 <code>log</code>、<code>message</code>、<code>content</code>、<code>data</code>、<code>events</code>、<code>json</code>。如果你希望全文搜索时扫描更多字段，可以在数据流页面进行配置。在特定字段中进行全文搜索应该使用 <code>str_match</code> 函数。</li>
</ul>
<p>要在没有倒排索引的情况下搜索包含单词 <code>error</code> 的所有字段：</p>
<ul>
<li><code>match_all_raw(&#39;error&#39;)</code>，区分大小写。</li>
<li><code>match_all_raw_ignore_case(error)</code>，这是不区分大小写的。</li>
<li><code>match_all_raw</code> 函数仅搜索配置为全文搜索的字段。默认字段集是 <code>log</code>、<code>message</code>、<code>content</code>、<code>data</code>、<code>events</code>、<code>json</code>。如果希望全文搜索时扫描更多字段，可以在数据流设置下进行配置。应该使用 <code>str_match</code> 在指定字段中进行全文搜索。</li>
</ul>
<p>如果仅搜索 <code>log</code> 字段中的 <code>error</code>，可以使用 <code>str_match(log, &#39;error&#39;)</code>，这比 <code>match_all_raw</code> 更有效，因为它在单个字段中搜索。</p>
<p>同样如果我们要搜索包含 <code>code</code> 为 200 的所有日志条目，则可以直接使用 <code>code=200</code> 查询即可，其中 <code>code</code> 是一个数字字段。如果要搜索 <code>code</code> 字段不包含任何值的所有日志条目，可以使用 <code>code is null</code>，但是需要注意使用 <code>code=&#39; &#39;</code> 不会产生正确的结果；同样的搜索 <code>code</code> 字段具有某个值的所有日志条目，则可以使用 <code>code is not null</code>，但是不能使用 <code>code!=&#39; &#39;</code>。另外也可以使用 <code>code &gt; 399</code> 或者 <code>code &gt;= 400</code> 来搜索 <code>code</code> 大于 399 或者大于等于 400 的所有日志条目。</p>
<p>此外我们还可以勾选 <code>SQL 模式</code> 来使用 SQL 查询语句来查询日志数据：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724501160877.png" alt="SQL Model"></p>
<p>同样现在我们可以去 Minio 中查看数据是否已经被正确的存储，使用用户名 <code>rootuser</code> 和密码 <code>rootpass123</code> 即可登录成功。</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724501849426.png" alt="minio console"></p>
<p>可以看到对象存储中已经有了我们的 <code>parquet</code> 文件数据。</p>
<h3 id="采集-Kubernetes-观测数据"><a href="#采集-Kubernetes-观测数据" class="headerlink" title="采集 Kubernetes 观测数据"></a>采集 Kubernetes 观测数据</h3><p><code>O2</code> 还支持通过 OpenTelemetry 采集器导入数据。这里我们可以使用 <code>OpenTelemetry</code> 来采集 Kubernetes 集群的观测数据，首先我们需要安装 <code>OpenTelemetry</code> 的 <code>Operator</code>，由于 <code>OpenTelemetry</code> 的 <code>Operator</code> 依赖 <code>cert-manager</code>，所以我们需要先安装 <code>cert-manager</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.1/cert-manager.yaml</span><br></pre></td></tr></table></figure>

<p>等待 <code>cert-manager</code> 安装完成后，我们就可以安装 <code>OpenTelemetry</code> 的 <code>Operator</code> 了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n cert-manager</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">cert-manager-cainjector-65c7bff89d-rxjts   1/1     Running   0          64s</span><br><span class="line">cert-manager-cbcf9668d-tlz2k               1/1     Running   0          64s</span><br><span class="line">cert-manager-webhook-594cb9799b-c5sd8      1/1     Running   0          64s</span><br><span class="line">$ kubectl apply -f https://github.com/open-telemetry/opentelemetry-operator/releases/latest/download/opentelemetry-operator.yaml</span><br><span class="line">$ kubectl get pods -n opentelemetry-operator-system</span><br><span class="line">NAME                                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">opentelemetry-operator-controller-manager-fd5689558-lchr7   2/2     Running   0          61s</span><br></pre></td></tr></table></figure>

<p>然后我们就可以来安装 OpenTelemetry 的 <code>Collector</code> 了，为了方便使用 O2 官方的 Helm Chart 已经提供了一个定制的 Chart 包，我们可以直接使用它，该采集器可以：</p>
<ul>
<li>从 K8s 集群中捕获日志、指标和 Events 事件并将其发送到 O2</li>
<li>在集群中配置 <code>auto-instrumentation</code> 自动埋点，以捕获 <code>Java</code>、<code>.Net</code>、<code>nodejs</code>、<code>python</code> 和 <code>Go</code> 语言编写的应用程序的链路追踪</li>
</ul>
<p>使用我们这里安装的 O2 集群的认证信息覆盖默认的认证信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># o2c-values.yaml</span></span><br><span class="line"><span class="attr">exporters:</span></span><br><span class="line">  <span class="attr">otlphttp/openobserve:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">http://o2-openobserve-router.openobserve.svc.cluster.local:5080/api/default</span></span><br><span class="line">    <span class="attr">headers:</span></span><br><span class="line">      <span class="attr">Authorization:</span> <span class="string">Basic</span> <span class="string">cm9vdEBleGFtcGxlLmNvbTpScmtORWxpenhCWWV4Qzhr</span> <span class="comment"># 替换成自己的</span></span><br><span class="line">      <span class="attr">stream-name:</span> <span class="string">k8s_logs</span> <span class="comment"># 替换成自己的数据流名称</span></span><br><span class="line">  <span class="attr">otlphttp/openobserve_k8s_events:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">http://o2-openobserve-router.openobserve.svc.cluster.local:5080/api/default</span></span><br><span class="line">    <span class="attr">headers:</span></span><br><span class="line">      <span class="attr">Authorization:</span> <span class="string">Basic</span> <span class="string">cm9vdEBleGFtcGxlLmNvbTpScmtORWxpenhCWWV4Qzhr</span> <span class="comment"># 替换成自己的</span></span><br><span class="line">      <span class="attr">stream-name:</span> <span class="string">k8s_events</span></span><br><span class="line"></span><br><span class="line"><span class="attr">agent:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">tolerations:</span> <span class="comment"># 如果需要在 master 节点上运行，需要添加这个容忍</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-role.kubernetes.io/control-plane&quot;</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">      <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure>

<p>其中 <code>endpoint</code> 地址为 <code>O2</code> 的 <code>router</code> 的 FQDN 地址，<code>Authorization</code> 中 <code>Basic</code> 后面 的值为<code>用户名:TOKEN</code>的 <code>base64</code> 编码（可以在 <code>O2</code> 采集页面获取），<code>stream-name</code> 为数据流名称。然后直接使用下面命令安装 <code>OpenTelemetry</code> 的 <code>Collector</code> 即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ helm upgrade --install o2c openobserve/openobserve-collector -f o2c-values.yaml --namespace openobserve-collector --create-namespace</span><br><span class="line">Release <span class="string">&quot;o2c&quot;</span> does not exist. Installing it now.</span><br><span class="line">NAME: o2c</span><br><span class="line">LAST DEPLOYED: Sun Aug 25 10:30:59 2024</span><br><span class="line">NAMESPACE: openobserve-collector</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">If everything proceeded without errors <span class="keyword">then</span> your cluster is now sending logs and metrics to OpenObserve.</span><br><span class="line"></span><br><span class="line">You can add following to your pods/namespaces to auto instrument your applications to send traces:</span><br><span class="line"></span><br><span class="line">  1. Java: instrumentation.opentelemetry.io/inject-java: <span class="string">&quot;openobserve-collector/openobserve-java&quot;</span></span><br><span class="line">  2. NodeJS: instrumentation.opentelemetry.io/inject-nodejs: <span class="string">&quot;openobserve-collector/openobserve-nodejs&quot;</span></span><br><span class="line">  3. Python: instrumentation.opentelemetry.io/inject-python: <span class="string">&quot;openobserve-collector/openobserve-python&quot;</span></span><br><span class="line">  4. DotNet: instrumentation.opentelemetry.io/inject-dotnet: <span class="string">&quot;openobserve-collector/openobserve-dotnet&quot;</span></span><br><span class="line">  5. Go: instrumentation.opentelemetry.io/inject-go: <span class="string">&quot;openobserve-collector/openobserve-go&quot;</span> , instrumentation.opentelemetry.io/otel-go-auto-target-exe: <span class="string">&quot;/path/to/container/executable&quot;</span></span><br><span class="line">  6. OpenTelemetry SDK environment variables only: instrumentation.opentelemetry.io/inject-sdk: <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>

<p>我们可以查看 <code>OpenTelemetry</code> 的 <code>Collector</code> 是否正常运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n openobserve-collector</span><br><span class="line">NAME                                                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">o2c-openobserve-collector-agent-collector-46r82                   1/1     Running   0          10m</span><br><span class="line">o2c-openobserve-collector-agent-collector-cbtnn                   1/1     Running   0          10m</span><br><span class="line">o2c-openobserve-collector-agent-collector-kkczz                   1/1     Running   0          10m</span><br><span class="line">o2c-openobserve-collector-gateway-collector-0                     1/1     Running   0          10m</span><br><span class="line">o2c-openobserve-collector-gateway-targetallocator-59c4468dxmfts   1/1     Running   0          10m</span><br></pre></td></tr></table></figure>

<p>其实这里我们部署的采集器就是一个 <code>agent</code> 和一个 <code>gateway</code>，在前面的额 OpenTelemetry 章节已经学习过了，只是这里我们是将数据导出到了 <code>O2</code> 中。</p>
<p>现在我们就可以去 <code>O2</code> 中查看我们的数据了，切换到<strong>数据流</strong>页面，可以看到我们的数据流已经被成功的导入了：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724554766473.png" alt="K8s 数据流"></p>
<p>可以看到现在我们的数据流中已经有了 <code>k8s_logs</code> 和 <code>k8s_events</code> 两个日志数据流，分别对应我们的日志和事件数据。除此之外还有很多 <code>metrics</code> 类型的数据流，可以看到指标中的每一个标签都是一个独立的 <code>stream</code> 数据流。</p>
<p>我们可以切换到<strong>日志</strong>页面，选择数据流 <code>k8s_logs</code>，就可以看到我们采集的 K8s 集群的日志数据了：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724554959302.png" alt="K8s Logs"></p>
<p>同样我们选择数据流 <code>k8s_events</code>，就可以看到我们采集的 K8s 集群的事件数据了：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724555070526.png" alt="K8s Events"></p>
<p>对于指标数据流，我们可以切换到<strong>指标</strong>页面，选择数据流 <code>k8s_metrics</code>，就可以看到我们采集的 K8s 集群指标数据了：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724555750006.png" alt="K8s Metrics"></p>
<p>左侧我们可以选择一个指标，然后就可以看到这个指标的标签列表，然后我们就可以在右侧填写 PromQL 语句来查询数据了，比如我们这里查询每个命名空间的内存使用情况，则可以使用下面的 PromQL 语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(k8s_pod_memory_usage) by (k8s_namespace_name)</span><br></pre></td></tr></table></figure>

<p>查询结果如下图所示：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724555851068.png" alt="PromQL 查询"></p>
<p>如果我们需要经常查询这个指标，这可以将其添加到仪表盘中，点击页面中的<strong>添加到仪表盘</strong>按钮即可，然后在<strong>仪表盘</strong>页面就可以看到我们的仪表盘了：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724556188258.png" alt="仪表盘"></p>
<p>和 Grafana 类似，我们也可以编辑面板，在面板右上角点击<code>Edit Panel</code>，就可以进入面板编辑页面了，点击最右侧的<strong>配置</strong>按钮，就可以编辑面板了，比如我们这里可以选择图例的单位、图例的显示名称等，编辑后可以点击<strong>应用</strong>按钮预览，如果满意可以点击<strong>保存</strong>按钮保存：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724556356367.png" alt="编辑面板"></p>
<p>同样我们也可以和 Grafana 一样配置一个变量，然后在面板上展示这个变量，比如我们这合理可以添加一个 <code>namespace</code> 变量，其值可以从 <code>k8s_namespace_phase</code> 这个数据流中获取，如下图所示：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724557329069.png" alt="变量设置"></p>
<p>当然现在我们需要去修改下面板的 PromQL 查询语句，需要将变量 <code>namespace</code> 传入，更改成：<code>sum(k8s_pod_memory_usage&#123;k8s_namespace_name =~ &quot;$namespace&quot;&#125;) by (k8s_namespace_name)</code> 即可：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724557440038.png" alt="修改PromQL"></p>
<p>现在我们就可以在面板上通过筛选 <code>namespace</code> 变量来查看不同命名空间的内存使用情况了：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1724557663548.png" alt="筛选面板"></p>
<p>接下来还有链路追踪的数据，因为上面我们安装的 <code>OpenTelemetry</code> 的 <code>Collector</code> 已经自动为我们创建了自动埋点的 <code>Instrumentation</code> 对象，如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get instrumentation -n openobserve-collector</span><br><span class="line">NAME                 AGE   ENDPOINT                                                                                          SAMPLER                    SAMPLER ARG</span><br><span class="line">openobserve-dotnet   99m   http://o2c-openobserve-collector-gateway-collector.openobserve-collector.svc.cluster.local:4318   parentbased_traceidratio   1</span><br><span class="line">openobserve-go       99m   http://o2c-openobserve-collector-gateway-collector.openobserve-collector.svc.cluster.local:4318   parentbased_traceidratio   1</span><br><span class="line">openobserve-java     99m   http://o2c-openobserve-collector-gateway-collector.openobserve-collector.svc.cluster.local:4318   parentbased_traceidratio   1</span><br><span class="line">openobserve-nodejs   99m   http://o2c-openobserve-collector-gateway-collector.openobserve-collector.svc.cluster.local:4317   parentbased_traceidratio   1</span><br><span class="line">openobserve-python   99m   http://o2c-openobserve-collector-gateway-collector.openobserve-collector.svc.cluster.local:4318   parentbased_traceidratio   1</span><br></pre></td></tr></table></figure>

<p>可以看到上面的 <code>Instrumentation</code> 对象已经配置了端点地址、采样器和采样器参数，地址就是我们的 <code>OpenTelemetry</code> 的 <code>Collector</code> 的地址（<code>gateway</code> 类型的），采样器是 <code>parentbased_traceidratio</code>，参数是 <code>1</code>，表示采样率为 <code>1</code>。</p>
<p>针对上面的这些语言编写的应用，我们就可以进行自动埋点，只需要在应用的 <code>Pod</code> 中添加对应的 <code>Annotation</code> 即可：</p>
<ul>
<li>Java: <code>instrumentation.opentelemetry.io/inject-java: &quot;openobserve-collector/openobserve-java&quot;</code></li>
<li>DotNet: <code>instrumentation.opentelemetry.io/inject-dotnet: &quot;openobserve-collector/openobserve-dotnet&quot;</code></li>
<li>NodeJS: <code>instrumentation.opentelemetry.io/inject-nodejs: &quot;openobserve-collector/openobserve-nodejs&quot;</code></li>
<li>Python: <code>instrumentation.opentelemetry.io/inject-python: &quot;openobserve-collector/openobserve-python&quot;</code></li>
<li>Go (Uses eBPF):<ul>
<li><code>instrumentation.opentelemetry.io/inject-go: &quot;openobserve-collector/openobserve-go&quot;</code></li>
<li><code>instrumentation.opentelemetry.io/otel-go-auto-target-exe: &quot;/path/to/container/executable&quot;</code></li>
</ul>
</li>
</ul>
<p>这里我们可以部署一个微服务 HOT Commerce 来演示在 Kubernetes 环境中如何使用 OpenTelemetry Operator 进行自动埋点，并将数据发送到 OpenObserve 中。</p>
<p>这个应用包含 5 个简单的微服务，每个微服务都是用不同的编程语言编写的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">                                                 /-&gt; review (python)</span><br><span class="line">                                                /</span><br><span class="line">frontend (go) -&gt; shop (nodejs) -&gt; product (java)</span><br><span class="line">                                                \</span><br><span class="line">                                                 \-&gt; price (dotnet)</span><br></pre></td></tr></table></figure>

<p>该应用对应的 Kubernetes 资源清单文件如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hotcommerce.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">price</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">hotcommerce</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">price</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">price</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">hotcommerce</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">price</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">price</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">instrumentation.opentelemetry.io/inject-dotnet:</span> <span class="string">&quot;openobserve-collector/openobserve-dotnet&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">price</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">public.ecr.aws/zinclabs/sample-price-service-dotnet:3</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;544Mi&quot;</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;448Mi&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">review</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">hotcommerce</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">review</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8004</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">review</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">hotcommerce</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">review</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">review</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">instrumentation.opentelemetry.io/inject-python:</span> <span class="string">&quot;openobserve-collector/openobserve-python&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">review</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">public.ecr.aws/zinclabs/sample-review-service:51</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8004</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;544Mi&quot;</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;448Mi&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">product</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">hotcommerce</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">product</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8003</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">product</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">hotcommerce</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">product</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">product</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">instrumentation.opentelemetry.io/inject-java:</span> <span class="string">&quot;openobserve-collector/openobserve-java&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">product</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">public.ecr.aws/zinclabs/sample-product-service-java:53</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REVIEW_SERVICE_URL</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;http://review.hotcommerce.svc.cluster.local&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PRICE_SERVICE_URL</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;http://price.hotcommerce.svc.cluster.local&quot;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8003</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;1048Mi&quot;</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;1048Mi&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">shop</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">hotcommerce</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">shop</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8002</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">shop</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">hotcommerce</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">shop</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">shop</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">instrumentation.opentelemetry.io/inject-nodejs:</span> <span class="string">&quot;openobserve-collector/openobserve-nodejs&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shop</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">public.ecr.aws/zinclabs/sample-shop-service-nodejs:51</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PRODUCT_SERVICE_URL</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;http://product.hotcommerce.svc.cluster.local&quot;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8002</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;544Mi&quot;</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;448Mi&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">hotcommerce</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8001</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">hotcommerce</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">instrumentation.opentelemetry.io/inject-go:</span> <span class="string">&quot;openobserve-collector/openobserve-go&quot;</span></span><br><span class="line">        <span class="attr">instrumentation.opentelemetry.io/otel-go-auto-target-exe:</span> <span class="string">&quot;/app&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">public.ecr.aws/zinclabs/sample-frontend-service-go:51</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SHOP_SERVICE_URL</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;http://shop.hotcommerce.svc.cluster.local&quot;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8001</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;543Mi&quot;</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;438Mi&quot;</span></span><br></pre></td></tr></table></figure>

<p>注意上面的每个 Deployment 应用中，我们都添加了对应的 <code>instrumentation.opentelemetry.io/inject-xxx</code> 的 <code>Annotation</code>，这样就可以实现自动埋点了。</p>
<p>直接使用下面命令部署 HOT Commerce 应用即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns hotcommerce</span><br><span class="line">kubectl apply -f hotcommerce.yaml</span><br></pre></td></tr></table></figure>

<p>部署完成后，我们先查看所有的服务是否正常运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n hotcommerce</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">frontend-57c47854f7-8cwbp   1/1     Running   0          6m56s</span><br><span class="line">price-5d99b949b8-gzqr6      1/1     Running   0          6m56s</span><br><span class="line">product-85f94894f-7s8hw     1/1     Running   0          6m56s</span><br><span class="line">review-98bc7596f-ptbhk      1/1     Running   0          6m57s</span><br><span class="line">shop-966895886-hgpxt        1/1     Running   0          6m56s</span><br><span class="line">$ kubectl get svc -n hotcommerce</span><br><span class="line">NAME       TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">frontend   NodePort    10.96.3.25    &lt;none&gt;        80:30826/TCP   4m42s</span><br><span class="line">price      ClusterIP   10.96.1.147   &lt;none&gt;        80/TCP         4m43s</span><br><span class="line">product    ClusterIP   10.96.3.134   &lt;none&gt;        80/TCP         4m42s</span><br><span class="line">review     ClusterIP   10.96.1.22    &lt;none&gt;        80/TCP         4m43s</span><br><span class="line">shop       ClusterIP   10.96.2.4     &lt;none&gt;        80/TCP         4m42s</span><br></pre></td></tr></table></figure>

<p>我们可以通过 <code>http://&lt;NodeIP&gt;:30826</code> 访问 <code>frontend</code> 服务了，当我们访问 <code>frontend</code> 服务时，<code>OpenTelemetry</code> 会自动为我们的应用程序生成链路追踪数据，并将其发送到 OpenTelemetry Collector，然后 Collector 会将数据发送到 OpenObserve 中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://192.168.0.111:30826/item/1</span><br><span class="line">&#123;<span class="string">&quot;description&quot;</span>:<span class="string">&quot;This is a sample product.&quot;</span>,<span class="string">&quot;id&quot;</span>:1,<span class="string">&quot;in_stock&quot;</span>:10,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;Sample Product&quot;</span>,<span class="string">&quot;price&quot;</span>:100,<span class="string">&quot;rating&quot;</span>:5,<span class="string">&quot;review&quot;</span>:<span class="string">&quot;This is a great product!&quot;</span>,<span class="string">&quot;warehouse_location&quot;</span>:<span class="string">&quot;A1-B2&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们就可以在 <code>O2</code> 中查看到有 <code>traces</code> 类型的数据流了。切换到<strong>追踪</strong>页面，就可以看到我们采集到的链路追踪数据了：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/ybu3mr.png" alt="K8s Traces"></p>
<p>点击一个 Trace ID，就可以查看这个链路追踪的详细信息了：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/ugwtlu.png" alt="Trace Detail"></p>
<p>这里我们可以看到这个链路追踪的详细信息，包括每个服务的调用时间、调用耗时、调用结果等信息。</p>
<p>到这里我们就实现了在 OpenObserve 中查看我们的 K8s 集群的观测数据，当然同样的对于非 K8s 集群的应用也可以直接将数据采集到 OpenObserve 中，比如 Fluentd、Vector、Prometheus、OpenTelemetry Collector 等。</p>
<blockquote>
<p>此外 O2 还有很多其他功能，比如报警、函数、前端性能监控等，可以关注后续文章。</p>
</blockquote>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><code>https://openobserve.ai/docs/</code></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/%E5%86%85%E6%A0%B8%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/%E5%86%85%E6%A0%B8%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">内核基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:14:58" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">内核</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>好的，我来帮你把这篇关于 <strong>Linux 内核基础</strong> 的内容翻译成中文，并保持原有的结构和重点。</p>
<hr>
<h1 id="Linux-内核基础"><a href="#Linux-内核基础" class="headerlink" title="Linux 内核基础"></a>Linux 内核基础</h1><p>关于 Linux 系统的组成已经有很多文章，但这里我们还是要简要回顾一下，以确保基本概念清晰。</p>
<p>严格来说，“Linux”一词仅指内核本身。有人认为内核本身就是一个操作系统（OS），也有人认为操作系统应该指由内核和各种软件组成的整体。在这里，我们采用后者的解释。</p>
<hr>
<h2 id="计算机启动的基本步骤"><a href="#计算机启动的基本步骤" class="headerlink" title="计算机启动的基本步骤"></a>计算机启动的基本步骤</h2><p>当一台现代计算机被启动或重置时，大体流程如下：</p>
<ol>
<li>CPU（或多核&#x2F;多处理器系统中的指定启动 CPU）初始化其内部硬件状态并加载微码。</li>
<li>CPU 开始执行初始引导代码，例如 x86 架构上的 BIOS，或 ARM 上的引导加载程序。</li>
<li>引导代码加载并执行内核。需要注意的是，在 x86 系统中，通常由 BIOS 先加载一个中间引导加载器（如 GRUB 或 syslinux），再去获取并启动内核。</li>
<li>内核配置硬件并执行 <strong>init 进程</strong>。</li>
<li>init 进程继续执行其他进程，以启动所需的软件。</li>
</ol>
<p>内核的作用是为程序提供统一的接口，并仲裁资源访问。系统中每个运行的程序都被称为 <strong>进程</strong>。内核让每个进程看起来就像是系统上唯一运行的进程一样，进程不需要关心物理内存布局、外设访问或网络的实现细节。</p>
<p>系统启动后执行的第一个进程具有特殊意义，它不会退出，而是负责一些维持系统运行的基本任务。在大多数情况下，这个进程就是 <code>/sbin/init</code> 程序。它通常会在启动时运行一个 shell 脚本，继续执行更多程序。</p>
<p>有些项目会选择让他们的主应用直接作为 init 进程运行。虽然这是可能的，但并不推荐，因为这样的程序非常难以调试和控制。一旦程序崩溃，系统就会停止运行，且几乎没有调试手段。</p>
<p>几乎所有类 Unix 系统都有 <strong>shell</strong> —— 一个交互式命令解析器。大多数常见 shell 遵循 <strong>Bourne shell</strong> 的语法。</p>
<hr>
<h2 id="Linux-内核简介"><a href="#Linux-内核简介" class="headerlink" title="Linux 内核简介"></a>Linux 内核简介</h2><p>来看一下 GNU&#x2F;Linux 操作系统的整体架构。我们可以从两个层面来理解操作系统（见图 1）：</p>
<ul>
<li><strong>用户空间（User Space）</strong>：用户应用程序运行的地方。</li>
<li><strong>内核空间（Kernel Space）</strong>：Linux 内核运行的地方。</li>
</ul>
<p>此外，还有 **GNU C 库 (glibc)**，它提供了系统调用接口，负责在用户空间应用和内核之间的切换。由于内核和用户程序在不同的受保护地址空间中运行，glibc 是二者之间的桥梁。</p>
<p>每个用户进程都有独立的虚拟地址空间，而内核则始终占据一个统一的地址空间。</p>
<p>Linux 内核可以进一步划分为三个层次：</p>
<ol>
<li><strong>系统调用接口（SCI）</strong>：实现基础功能（如 read、write）。</li>
<li><strong>架构无关的内核代码</strong>：通用于所有支持的处理器架构。</li>
<li><strong>架构相关代码（BSP）</strong>：特定处理器和平台的支持代码。</li>
</ol>
<hr>
<h2 id="Linux-内核的特性"><a href="#Linux-内核的特性" class="headerlink" title="Linux 内核的特性"></a>Linux 内核的特性</h2><p>Linux 内核有几个重要的架构属性：</p>
<ul>
<li>内核由多个子系统组成，每个子系统负责不同功能。</li>
<li>Linux 是一个 <strong>单体内核（monolithic kernel）</strong>，将所有基本服务都放在内核中。这与 <strong>微内核（microkernel）</strong> 不同，后者只提供核心服务（通信、I&#x2F;O、内存和进程管理），其余服务作为模块加载。</li>
<li>Linux 在内存和 CPU 使用上非常高效，且极其稳定。</li>
<li>最突出的特点是 <strong>可移植性</strong>：Linux 可以运行在各种不同的处理器和平台上。甚至支持无 MMU 的处理器（通过 <strong>uClinux</strong>）。</li>
</ul>
<hr>
<h2 id="Linux-内核的主要子系统"><a href="#Linux-内核的主要子系统" class="headerlink" title="Linux 内核的主要子系统"></a>Linux 内核的主要子系统</h2><p>下面来看看 Linux 内核的主要组成部分（见图 2）：</p>
<h3 id="1-系统调用接口（SCI）"><a href="#1-系统调用接口（SCI）" class="headerlink" title="1. 系统调用接口（SCI）"></a>1. 系统调用接口（SCI）</h3><p>这是用户空间和内核之间的桥梁，提供从用户态到内核态的调用方式。<br> 源码位置：<code>./linux/kernel</code> 和 <code>./linux/arch</code>。</p>
<h3 id="2-进程管理"><a href="#2-进程管理" class="headerlink" title="2. 进程管理"></a>2. 进程管理</h3><p>内核中的进程称为 <strong>线程</strong>，它们是 CPU 的虚拟化实例。Linux 没有严格区分进程和线程。<br> 提供的 API 包括：创建进程（fork、exec）、终止进程（kill、exit）、进程间通信和同步（signal、POSIX 机制）。</p>
<p>Linux 使用 <strong>O(1) 调度器</strong>，不论多少线程，调度所需时间都是常数时间，并支持 <strong>SMP（对称多处理）</strong>。<br> 源码位置：<code>./linux/kernel</code> 和 <code>./linux/arch</code>。</p>
<h3 id="3-内存管理"><a href="#3-内存管理" class="headerlink" title="3. 内存管理"></a>3. 内存管理</h3><p>Linux 将内存划分为 <strong>页（page，通常为 4KB）</strong> 来管理。<br> 提供了诸如 <strong>slab 分配器</strong> 的机制，用于更高效地分配和回收内存。<br> 当内存不足时，页面会被换出到磁盘（swap）。<br> 源码位置：<code>./linux/mm</code>。</p>
<h3 id="4-虚拟文件系统（VFS）"><a href="#4-虚拟文件系统（VFS）" class="headerlink" title="4. 虚拟文件系统（VFS）"></a>4. 虚拟文件系统（VFS）</h3><p>VFS 提供了一个通用的文件系统接口层，屏蔽不同文件系统的差异。<br> 上层 API：open、close、read、write。<br> 下层接口：具体文件系统插件（超过 50 种）。<br> 源码位置：<code>./linux/fs</code>。</p>
<p>VFS 下还有缓存层（buffer cache），优化了对物理设备的访问。</p>
<h3 id="5-网络栈"><a href="#5-网络栈" class="headerlink" title="5. 网络栈"></a>5. 网络栈</h3><p>Linux 的网络栈遵循分层设计：</p>
<ul>
<li>最上层是 <strong>sockets API</strong>，供用户空间使用。</li>
<li>下层依次是 TCP&#x2F;UDP、IP，再到链路层协议。<br> 源码位置：<code>./linux/net</code>。</li>
</ul>
<h3 id="6-设备驱动"><a href="#6-设备驱动" class="headerlink" title="6. 设备驱动"></a>6. 设备驱动</h3><p>Linux 内核的大部分代码在 <strong>设备驱动</strong> 中，它们使硬件可用。<br> 源码位置：<code>./linux/drivers</code>。</p>
<h3 id="7-架构相关代码"><a href="#7-架构相关代码" class="headerlink" title="7. 架构相关代码"></a>7. 架构相关代码</h3><p>不同 CPU 架构有各自的特定实现。<br> 源码位置：<code>./linux/arch</code>，例如 <code>./linux/arch/x86</code>。</p>
<hr>
<h2 id="Linux-内核的其他特性"><a href="#Linux-内核的其他特性" class="headerlink" title="Linux 内核的其他特性"></a>Linux 内核的其他特性</h2><ul>
<li>Linux 是一个强大的实验平台，支持大量新协议（如 SCTP、高速网络协议）。</li>
<li>支持 <strong>动态内核模块</strong>（可在运行时加载或卸载）。</li>
<li>支持虚拟化：通过 <strong>KVM（Kernel-based Virtual Machine）</strong>，Linux 可以作为宿主机操作系统运行其他操作系统（包括 Windows）。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" class="post-title-link" itemprop="url">分布式事务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:12:24" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>您好！RocketMQ 的事务消息机制确实非常强大，它解决了将本地事务与消息发送操作捆绑的原子性问题，避免了数据不一致。但正如任何技术方案一样，它也并非没有缺点。</p>
<p>作为后端开发专家，我来详细分析一下 RocketMQ 事务消息的优缺点，并探讨其他实现分布式事务消息的常见方案。</p>
<hr>
<h3 id="RocketMQ-事务消息的缺点"><a href="#RocketMQ-事务消息的缺点" class="headerlink" title="RocketMQ 事务消息的缺点"></a>RocketMQ 事务消息的缺点</h3><p>RocketMQ 的事务消息机制（通常基于两阶段提交思想的变种）通过生产者发送半消息、执行本地事务、回调检查等步骤来确保原子性。尽管它功能强大，但存在以下缺点：</p>
<ol>
<li><p><strong>实现复杂度增加：</strong></p>
<ul>
<li><strong>生产者回调：</strong> 生产者需要实现 <code>TransactionListener</code> 接口，提供 <code>executeLocalTransaction</code>（执行本地事务）和 <code>checkLocalTransaction</code>（本地事务回查）方法。这增加了生产者侧的代码逻辑和复杂度。</li>
<li><strong>消息状态管理：</strong> Broker 需要额外管理半消息（Half Message）的状态，包括半消息的存储、定时扫描回查、以及根据回查结果的提交或回滚操作。</li>
<li><strong>调试难度：</strong> 链条变长，涉及到生产者、Broker、本地数据库之间的多次交互和状态流转，一旦出现问题，调试和排查难度会相应增加。</li>
</ul>
</li>
<li><p><strong>性能开销与延迟：</strong></p>
<ul>
<li><strong>多一次网络交互：</strong> 相较于普通消息，事务消息多了一次半消息发送（Producer -&gt; Broker）和一次提交&#x2F;回滚指令（Producer -&gt; Broker）的网络交互。如果生产者宕机，还需要额外的回查请求（Broker -&gt; Producer）。这些额外的RPC调用会增加消息发送的整体延迟。</li>
<li><strong>Broker 资源占用：</strong> Broker 需要为半消息维护额外的存储和管理，并定期执行回查任务，这会增加 Broker 的CPU和网络资源消耗。</li>
<li><strong>阻塞风险：</strong> 当 Broker 回查生产者时，如果生产者处理回查的接口出现瓶颈或延迟，可能会影响半消息的最终确认，导致消息不能及时可见或被消费。</li>
</ul>
</li>
<li><p><strong>对生产者服务可用性的依赖：</strong></p>
<ul>
<li><strong>回查机制：</strong> 回查是 RocketMQ 事务消息的核心保证机制。这意味着在事务消息整个生命周期内，生产者服务必须随时保持可用，以便 Broker 能够进行回查。如果生产者服务长时间不可用，或者无法响应回查请求，半消息将一直处于不确定状态，无法被提交或回滚，从而阻塞系统的整体进度，甚至导致消息堆积。</li>
<li><strong>服务部署与伸缩：</strong> 生产者服务需要暴露一个回查接口，在容器化或微服务环境下，需要确保 Broker 能够正确地路由到可用的生产者实例。</li>
</ul>
</li>
<li><p><strong>消息可见性延迟：</strong></p>
<ul>
<li>半消息在本地事务执行完毕并发出Commit指令之前，对于消费者是不可见的。这意味着消息的最终可见性和消费，取决于本地事务的执行速度和Commit指令的发送成功。对于某些对极致实时性有要求的场景，这种延迟可能不被接受。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="其他事务消息实现方案"><a href="#其他事务消息实现方案" class="headerlink" title="其他事务消息实现方案"></a>其他事务消息实现方案</h3><p>除了 RocketMQ 的事务消息，业界还有多种方案来解决分布式事务场景下的“消息可靠发送”问题，其中最常见且成熟的是“本地消息表”方案，以及更宏观的“Saga 模式”：</p>
<h4 id="1-本地消息表（Local-Message-Table-Outbox-Pattern）"><a href="#1-本地消息表（Local-Message-Table-Outbox-Pattern）" class="headerlink" title="1. 本地消息表（Local Message Table &#x2F; Outbox Pattern）"></a>1. 本地消息表（Local Message Table &#x2F; Outbox Pattern）</h4><p>这是一种<strong>最经典、最通用、最可靠</strong>的分布式事务消息实现方案，常被称为“发件箱模式”（Outbox Pattern）。</p>
<ul>
<li><p><strong>工作原理：</strong></p>
<ol>
<li><strong>本地事务：</strong> 生产者服务在执行业务逻辑的<strong>同一个本地事务</strong>中，将业务数据和要发送的消息（通常是消息内容和状态）一同写入本地数据库。</li>
<li><strong>原子提交：</strong> 由于业务数据和消息都写入同一个本地事务，因此它们满足 ACID 特性，要么都成功，要么都失败。</li>
<li><strong>消息发送服务：</strong> 部署一个独立的、可靠的调度服务（或使用Quartz、XXL-Job等任务调度框架）。<ul>
<li>该服务会定期扫描本地消息表，查找状态为“待发送”的消息。</li>
<li>将这些消息发送到消息队列。</li>
<li>发送成功后，更新本地消息表中的消息状态为“已发送”。</li>
<li>发送失败则进行重试，或将状态标记为“发送失败”供人工介入。</li>
</ul>
</li>
<li><strong>消费者幂等性：</strong> 由于重试机制可能导致消息重复发送，消费者必须具备幂等性，即多次处理同一消息（通过消息ID或业务ID识别）的结果与处理一次相同。</li>
</ol>
</li>
<li><p><strong>优点：</strong></p>
<ul>
<li><strong>强一致性：</strong> 借助本地数据库事务，严格保证业务数据和消息的最终一致性。</li>
<li><strong>解耦：</strong> 消息发送逻辑从业务主流程中解耦，由一个独立的服务负责，不影响业务事务的性能。</li>
<li><strong>通用性：</strong> 不依赖于任何特定消息队列的事务机制，适用于任何MQ产品。</li>
<li><strong>可靠性高：</strong> 即使消息发送服务宕机，本地消息表中的消息也依然存在，重启后能继续发送。</li>
</ul>
</li>
<li><p><strong>缺点：</strong></p>
<ul>
<li><strong>数据量和轮询：</strong> 本地消息表会积累消息数据，需要定期清理。频繁的扫描会给数据库带来一定的压力。</li>
<li><strong>延迟：</strong> 消息的发送存在一定的延迟，取决于调度服务的扫描间隔。</li>
<li><strong>额外服务：</strong> 需要额外开发和维护一个消息发送服务。</li>
</ul>
</li>
</ul>
<h4 id="2-Saga-模式"><a href="#2-Saga-模式" class="headerlink" title="2. Saga 模式"></a>2. Saga 模式</h4><p>Saga 模式是一种处理<strong>长寿命分布式事务</strong>的模式，它不是传统意义上的事务消息实现，而是利用消息队列进行服务间通讯，从而协调一系列局部事务来达到最终一致性。</p>
<ul>
<li><p><strong>工作原理：</strong></p>
<ul>
<li>一个分布式事务由一系列（通常是两阶段提交的）局部事务组成，每个局部事务都有对应的补偿操作。</li>
<li>当一个局部事务完成时，它会发布一个事件来触发下一个局部事务。</li>
<li>如果任何一个局部事务失败，则执行其前面的所有已完成局部事务的补偿操作，以回滚整个分布式事务。</li>
<li>协调方式：通常有<strong>编排式（Orchestration）</strong>和<strong>协同式（Choreography）</strong>两种。<ul>
<li><strong>编排式：</strong> 单个协调器（Coordinator）负责所有局部事务的执行和补偿逻辑。</li>
<li><strong>协同式：</strong> 每个服务发布事件，其他服务监听事件并执行自己的局部事务。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>优点：</strong></p>
<ul>
<li><strong>高并发性：</strong> 局部事务可以独立执行，大大提高了系统的并发能力。</li>
<li><strong>高度解耦：</strong> 服务之间通过事件进行通信，降低了耦合度。</li>
<li><strong>适用于微服务架构：</strong> 能够很好地适应微服务架构的特性。</li>
</ul>
</li>
<li><p><strong>缺点：</strong></p>
<ul>
<li><strong>复杂性高：</strong> 补偿逻辑的实现是一个非常大的挑战。故障恢复、幂等性、逆向流程等都需要仔细考虑。</li>
<li><strong>最终一致性：</strong> 无法保证强一致性，只保证最终一致性。在事务中间阶段，数据可能处于不一致状态。</li>
<li><strong>调试和监控困难：</strong> 跨多个服务的事务流转，调试和监控非常复杂。</li>
</ul>
</li>
</ul>
<h4 id="3-XA-JTA（分布式事务协议）"><a href="#3-XA-JTA（分布式事务协议）" class="headerlink" title="3. XA &#x2F; JTA（分布式事务协议）"></a>3. XA &#x2F; JTA（分布式事务协议）</h4><p>传统意义上的分布式事务，如 XA 规范和基于 Java 的 JTA。</p>
<ul>
<li><p><strong>工作原理：</strong> 依赖于一个全局事务管理器（Transaction Manager）来协调多个资源管理器（Resource Manager，如数据库、支持 XA 的消息队列）的事务提交和回滚。通常采用两阶段提交（2PC）协议。</p>
</li>
<li><p><strong>优点：</strong></p>
<ul>
<li><strong>强一致性（ACID）：</strong> 保证全局事务的原子性、一致性、隔离性和持久性。</li>
</ul>
</li>
<li><p><strong>缺点：</strong></p>
<ul>
<li><strong>性能瓶颈：</strong> 2PC 是阻塞式的，所有参与者都必须等待协调器的指令才能提交或回滚，导致性能低下，不适合高并发场景。</li>
<li><strong>高耦合：</strong> 各个参与者之间以及与事务管理器之间耦合度高。</li>
<li><strong>资源锁定：</strong> 在提交阶段会长时间锁定资源。</li>
<li><strong>死锁风险：</strong> 如果协调器或参与者在关键阶段宕机，可能会导致资源长期锁定。</li>
<li><strong>兼容性差：</strong> 很多 NoSQL 数据库和现代消息队列不支持 XA 协议。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="总结与选择"><a href="#总结与选择" class="headerlink" title="总结与选择"></a>总结与选择</h3><p>在实际后端开发中，对于“将本地业务操作与消息发送捆绑”的场景：</p>
<ul>
<li><strong>RocketMQ 事务消息：</strong> 如果你使用的是 RocketMQ，并且可以容忍上述其缺点（实现复杂、性能开销、回查依赖），它是一个直接且相对内置的方案。</li>
<li><strong>本地消息表：</strong> 这是<strong>最推荐和最通用</strong>的方案。它提供了极高的可靠性，不依赖特定MQ产品，解耦性好，且在微服务实践中广泛应用。缺点是增加了额外的组件和一定的延迟。</li>
<li><strong>XA&#x2F;JTA：</strong> 几乎不推荐用于高并发的互联网应用，其性能瓶颈和高耦合性是致命缺陷。</li>
<li><strong>Saga 模式：</strong> 适用于更复杂的、跨多个服务的长流程分布式事务场景，它关注的是整个业务流程的最终一致性，而非单一的“本地事务+消息”的原子性。</li>
</ul>
<p>作为后端开发专家，我通常会根据业务的<strong>对一致性的要求、对延迟的容忍度、系统性能需求、团队技术栈以及架构复杂度</strong>来选择合适的方案。在绝大多数情况下，<strong>本地消息表方案提供了最佳的平衡点</strong>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/%E5%88%87%E7%89%87%E4%BD%9C%E4%B8%BA%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/%E5%88%87%E7%89%87%E4%BD%9C%E4%B8%BA%E5%87%BD%E6%95%B0/" class="post-title-link" itemprop="url">切片作为函数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:15:25" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Go-语言参数传递机制：总是值传递"><a href="#Go-语言参数传递机制：总是值传递" class="headerlink" title="Go 语言参数传递机制：总是值传递"></a>Go 语言参数传递机制：总是值传递</h3><p>首先，要明确 Go 语言中所有的参数传递都是<strong>值传递</strong>。这意味着当您将一个变量作为参数传递给函数时，函数会收到该变量的一个<strong>副本</strong>。</p>
<p>对于切片而言，这个“副本”不是底层数组的副本，而是<strong>切片头（slice header）的副本</strong>。切片头包含三个字段：</p>
<ol>
<li><strong>指向底层数组的指针 (pointer):</strong> 指向切片数据所在的底层数组的起始位置。</li>
<li><strong>长度 (length):</strong> 切片当前包含的元素个数。</li>
<li><strong>容量 (capacity):</strong> 从切片的第一个元素到其底层数组末尾的元素个数。</li>
</ol>
<p>函数接收到的是这个切片头的副本。这个副本中的指针，<strong>仍然指向原始切片所指向的那个底层数组</strong>。</p>
<h3 id="主要注意事项和场景分析"><a href="#主要注意事项和场景分析" class="headerlink" title="主要注意事项和场景分析"></a>主要注意事项和场景分析</h3><p>基于上述理解，我们可以分析切片作为函数参数时的不同行为：</p>
<hr>
<h3 id="注意事项-1：修改切片元素-共享底层数组"><a href="#注意事项-1：修改切片元素-共享底层数组" class="headerlink" title="注意事项 1：修改切片元素 (共享底层数组)"></a>注意事项 1：修改切片元素 (共享底层数组)</h3><ul>
<li><strong>行为：</strong> 如果在函数内部通过索引修改了切片中的元素，这些修改会反映到原始切片上。</li>
<li><strong>原因：</strong> 因为函数内部的切片和外部的切片共享同一个底层数组。函数只是通过切片头的副本操作了同一块内存区域。</li>
<li><strong>不需要返回：</strong> 在这种情况下，函数不需要返回切片，因为修改已经直接反映在原切片上。</li>
</ul>
<p><strong>示例：</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">modifyElements</span><span class="params">(s []<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Inside modifyElements (before): len=%d, cap=%d, value=%v, addr (slice header)=%p, addr (first element)=%p\n&quot;</span>,</span><br><span class="line">		<span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s, &amp;s, s) <span class="comment">// 注意 &amp;s 是切片头副本的地址，s 是底层数组首地址</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		s[<span class="number">0</span>] = <span class="number">999</span> <span class="comment">// 修改底层数组的第一个元素</span></span><br><span class="line">		s[<span class="number">1</span>] = <span class="number">888</span> <span class="comment">// 修改底层数组的第二个元素</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Inside modifyElements (after): len=%d, cap=%d, value=%v\n&quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mySlice := []<span class="type">int</span>&#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Initial mySlice: len=%d, cap=%d, value=%v, addr (slice header)=%p, addr (first element)=%p\n&quot;</span>,</span><br><span class="line">		<span class="built_in">len</span>(mySlice), <span class="built_in">cap</span>(mySlice), mySlice, &amp;mySlice, mySlice)</span><br><span class="line"></span><br><span class="line">	modifyElements(mySlice) <span class="comment">// 传递切片头副本</span></span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;After modifyElements: len=%d, cap=%d, value=%v\n&quot;</span>, <span class="built_in">len</span>(mySlice), <span class="built_in">cap</span>(mySlice), mySlice)</span><br><span class="line">	<span class="comment">// 输出: After modifyElements: len=4, cap=4, value=[999 888 30 40]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="注意事项-2：修改切片长度或容量-未触发扩容"><a href="#注意事项-2：修改切片长度或容量-未触发扩容" class="headerlink" title="注意事项 2：修改切片长度或容量 (未触发扩容)"></a>注意事项 2：修改切片长度或容量 (未触发扩容)</h3><ul>
<li><strong>行为：</strong> 如果在函数内部对切片进行了切片操作（如 <code>s = s[1:]</code>）或者 <code>append</code> 操作但<strong>未触发底层数组扩容</strong>，那么函数内部的切片头会更新，但原始切片头的长度和容量<strong>不会改变</strong>。</li>
<li><strong>原因：</strong> 这是因为函数操作的是切片头的副本。虽然副本的长度和容量更新了，但原始的切片头仍然保持不变。虽然它们仍指向同一个底层数组，但它们的“视图”不同了。</li>
<li><strong>需要返回：</strong> 如果您希望原始切片的长度或容量的改变生效，您<strong>必须</strong>返回新的切片。</li>
</ul>
<p><strong>示例：</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">growSliceWithoutRealloc</span><span class="params">(s []<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Inside growSliceWithoutRealloc (before): len=%d, cap=%d, value=%v\n&quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s)</span><br><span class="line">	<span class="comment">// 假设容量足够，追加元素不会触发扩容</span></span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="number">50</span>, <span class="number">60</span>) <span class="comment">// 修改的是 s 这个局部变量（切片头副本）</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;Inside growSliceWithoutRealloc (after): len=%d, cap=%d, value=%v\n&quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mySlice := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">2</span>, <span class="number">5</span>) <span class="comment">// len=2, cap=5</span></span><br><span class="line">	mySlice[<span class="number">0</span>] = <span class="number">10</span></span><br><span class="line">	mySlice[<span class="number">1</span>] = <span class="number">20</span></span><br><span class="line">	<span class="comment">// 底层数组：[10 20 &lt;empty&gt; &lt;empty&gt; &lt;empty&gt;]</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;Initial mySlice: len=%d, cap=%d, value=%v\n&quot;</span>, <span class="built_in">len</span>(mySlice), <span class="built_in">cap</span>(mySlice), mySlice)</span><br><span class="line"></span><br><span class="line">	growSliceWithoutRealloc(mySlice)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;After growSliceWithoutRealloc: len=%d, cap=%d, value=%v\n&quot;</span>, <span class="built_in">len</span>(mySlice), <span class="built_in">cap</span>(mySlice), mySlice)</span><br><span class="line">	<span class="comment">// 输出: Initial mySlice: len=2, cap=5, value=[10 20]</span></span><br><span class="line">	<span class="comment">//       Inside growSliceWithoutRealloc (before): len=2, cap=5, value=[10 20]</span></span><br><span class="line">	<span class="comment">//       Inside growSliceWithoutRealloc (after): len=4, cap=5, value=[10 20 50 60]</span></span><br><span class="line">	<span class="comment">//       After growSliceWithoutRealloc: len=2, cap=5, value=[10 20]  &lt;-- 原始切片未改变其长度/容量</span></span><br><span class="line">	<span class="comment">// 注意：虽然原始切片的值未更新，但底层数组实际上已被修改！</span></span><br><span class="line">	<span class="comment">// 如果您之后在mySlice上append，可能会覆盖 [50 60]！这正是陷阱所在。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的例子中，<code>growSliceWithoutRealloc</code> 内部追加了元素，实际上修改了底层数组。如果在 <code>main</code> 函数中，<code>mySlice</code> 再次进行 <code>append</code> 操作，它可能会覆盖掉函数内追加的 <code>50, 60</code>。这通常不是期望的行为。</p>
<hr>
<h3 id="注意事项-3：修改切片长度或容量-触发扩容"><a href="#注意事项-3：修改切片长度或容量-触发扩容" class="headerlink" title="注意事项 3：修改切片长度或容量 (触发扩容)"></a>注意事项 3：修改切片长度或容量 (触发扩容)</h3><ul>
<li><strong>行为：</strong> 如果在函数内部 <code>append</code> 元素时，导致需要分配新的、更大的底层数组（即触发了扩容），那么函数内部的切片头会更新，指向新的底层数组。<strong>原始切片头仍然指向旧的底层数组。</strong></li>
<li><strong>原因：</strong> 扩容意味着创建了一个全新的底层数组，函数内部的切片头副本现在指向新的内存地址，而原始切片头依然指向旧的内存地址。它们现在完全独立了（除了旧数组可能被新数组拷贝了一部分）。</li>
<li><strong>必须返回：</strong> 这种情况下同样，您<strong>必须</strong>返回新的切片，否则原始切片将不会有任何变化，且函数内新建的切片会被垃圾回收。</li>
</ul>
<p><strong>示例：</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">growSliceWithRealloc</span><span class="params">(s []<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Inside growSliceWithRealloc (before): len=%d, cap=%d, value=%v\n&quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s)</span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="number">500</span>, <span class="number">600</span>, <span class="number">700</span>) <span class="comment">// 假设会触发扩容 (例如，初始容量很小)</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;Inside growSliceWithRealloc (after): len=%d, cap=%d, value=%v\n&quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mySlice := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, <span class="number">1</span>) <span class="comment">// len=0, cap=1</span></span><br><span class="line">	mySlice = <span class="built_in">append</span>(mySlice, <span class="number">10</span>, <span class="number">20</span>) <span class="comment">// mySlice: len=2, cap=2 (已扩容一次)</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;Initial mySlice: len=%d, cap=%d, value=%v\n&quot;</span>, <span class="built_in">len</span>(mySlice), <span class="built_in">cap</span>(mySlice), mySlice)</span><br><span class="line"></span><br><span class="line">	growSliceWithRealloc(mySlice) <span class="comment">// 这会触发扩容</span></span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;After growSliceWithRealloc: len=%d, cap=%d, value=%v\n&quot;</span>, <span class="built_in">len</span>(mySlice), <span class="built_in">cap</span>(mySlice), mySlice)</span><br><span class="line">	<span class="comment">// 输出: Initial mySlice: len=2, cap=2, value=[10 20]</span></span><br><span class="line">	<span class="comment">//       Inside growSliceWithRealloc (before): len=2, cap=2, value=[10 20]</span></span><br><span class="line">	<span class="comment">//       Inside growSliceWithRealloc (after): len=5, cap=X, value=[10 20 500 600 700] (X是新容量，通常为4或8)</span></span><br><span class="line">	<span class="comment">//       After growSliceWithRealloc: len=2, cap=2, value=[10 20]  &lt;-- 原始切片完全未变（指向旧数组）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><p>基于以上分析，Go 语言中处理切片作为函数参数的<strong>最佳实践</strong>是：</p>
<ol>
<li><p><strong>如果函数唯一的作用是修改切片中的现有元素（通过索引），并且不改变其长度或容量，则无需返回切片。</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">zeroOut</span><span class="params">(s []<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> s &#123;</span><br><span class="line">        s[i] = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调用: zeroOut(mySlice)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>如果函数可能会改变切片的长度、容量（例如通过 <code>append</code> 或切片操作），那么它应该作为返回值返回新的切片。</strong> 这是一个非常常见的 Go 惯用法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">appendAndReturn</span><span class="params">(s []<span class="type">int</span>, vals ...<span class="type">int</span>)</span></span> []<span class="type">int</span> &#123;</span><br><span class="line">    s = <span class="built_in">append</span>(s, vals...)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调用: mySlice = appendAndReturn(mySlice, 100, 200)</span></span><br></pre></td></tr></table></figure>
<p>这样做会使代码意图明确，避免了上面提到的“隐式修改底层数组但原始切片头未更新”的陷阱。</p>
</li>
<li><p><strong>避免传递 <code>*[]T</code>（指向切片的指针）作为参数，除非您真的需要修改调用者作用域中的切片头本身，并且不希望通过返回值来实现。</strong> 这种模式较为罕见，通常没有直接返回切片清晰。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不推荐，除非有特殊理由</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">appendByModifyingPointer</span><span class="params">(s *[]<span class="type">int</span>, val <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    *s = <span class="built_in">append</span>(*s, val) <span class="comment">// 直接修改caller的slice header</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调用: appendByModifyingPointer(&amp;mySlice, 100)</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>Go 语言中切片作为函数参数是<strong>值传递</strong>，传递的是切片头的副本。</li>
<li>函数内部对切片元素的修改会反映到外部，因为它们共享底层数组。</li>
<li>函数内部对切片长度或容量的修改（通过 <code>append</code> 或切片操作）<strong>不会</strong>反映到外部，除非您将修改后的切片作为返回值返回。</li>
<li><strong>记住：如果函数会改变切片的长度或容量，请总是返回这个新的切片。这通常是最清晰和 Go 惯用的方式。</strong></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/%E5%8D%95%E6%9C%BA%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/%E5%8D%95%E6%9C%BA%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">单机模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:11:30" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/" itemprop="url" rel="index"><span itemprop="name">k8s-monitor</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/VectoriaMetrics/" itemprop="url" rel="index"><span itemprop="name">VectoriaMetrics</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>18k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>16 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="VictoriaMetrics"><a href="#VictoriaMetrics" class="headerlink" title="VictoriaMetrics"></a>VictoriaMetrics</h1><p><a target="_blank" rel="noopener" href="https://victoriametrics.com/">VictoriaMetrics(VM)</a> 是一个支持高可用、经济高效且可扩展的监控解决方案和时间序列数据库，可用于 Prometheus 监控数据做长期远程存储。</p>
<p>前面章节我们介绍了 Thanos 方案也可以用来解决 Prometheus 的高可用和远程存储的问题，那么为什么我们还要使用 VictoriaMetrics 呢？相对于 Thanos，VictoriaMetrics 主要是一个可水平扩容的<strong>本地全量持久化存储方案</strong>，VictoriaMetrics 不仅仅是时序数据库，它的优势主要体现在一下几点。</p>
<ul>
<li>对外支持 Prometheus 相关的 API，可以直接用于 Grafana 作为 Prometheus 数据源使用</li>
<li>指标数据摄取和查询具备高性能和良好的可扩展性，性能比 InfluxDB 和 TimescaleDB 高出 20 倍</li>
<li>在处理高基数时间序列时，内存方面也做了优化，比 InfluxDB 少 10x 倍，比 Prometheus、Thanos 或 Cortex 少 7 倍</li>
<li>高性能的数据压缩方式，与 TimescaleDB 相比，可以将多达 70 倍的数据点存入有限的存储空间，与 Prometheus、Thanos 或 Cortex 相比，所需的存储空间减少 7 倍</li>
<li>它针对具有高延迟 IO 和低 IOPS 的存储进行了优化</li>
<li>提供全局的查询视图，多个 Prometheus 实例或任何其他数据源可能会将数据摄取到 VictoriaMetrics</li>
<li>操作简单<ul>
<li>VictoriaMetrics 由一个没有外部依赖的小型可执行文件组成</li>
<li>所有的配置都是通过明确的命令行标志和合理的默认值完成的</li>
<li>所有数据都存储在 - storageDataPath 命令行参数指向的目录中</li>
<li>可以使用 <code>vmbackup/vmrestore</code> 工具轻松快速地从实时快照备份到 S3 或 GCS 对象存储中</li>
</ul>
</li>
<li>支持从第三方时序数据库获取数据源</li>
<li>由于存储架构，它可以保护存储在非正常关机（即 OOM、硬件重置或 kill -9）时免受数据损坏</li>
<li>同样支持指标的 relabel 操作</li>
</ul>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p>VM 分为单节点和集群两个方案，根据业务需求选择即可。单节点版直接运行一个二进制文件既，官方建议采集数据点(data points)低于 100w&#x2F;s，推荐 VM 单节点版，简单好维护，但不支持告警。集群版支持数据水平拆分。下图是 <code>VictoriaMetrics</code> 集群版官方的架构图。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/kuromt.jpg" alt="VM官方架构"></p>
<p>主要包含以下几个组件：</p>
<ul>
<li><code>vmstorage</code>：数据存储以及查询结果返回，默认端口为 8482</li>
<li><code>vminsert</code>：数据录入，可实现类似分片、副本功能，默认端口 8480</li>
<li><code>vmselect</code>：数据查询，汇总和数据去重，默认端口 8481</li>
<li><code>vmagent</code>：数据指标抓取，支持多种后端存储，会占用本地磁盘缓存，默认端口 8429</li>
<li><code>vmalert</code>：报警相关组件，不如果不需要告警功能可以不使用该组件，默认端口为 8880</li>
</ul>
<p>集群方案把功能拆分为 vmstorage、 vminsert、vmselect 组件，如果要替换 Prometheus，还需要使用 vmagent、vmalert。从上图也可以看出 vminsert 以及 vmselect（几乎）都是无状态的，所以扩展很简单，只有 vmstorage 是有状态的。</p>
<p>接下来我们就分别来介绍了 VM 的单节点和集群两个方案的使用。</p>
<h2 id="单节点"><a href="#单节点" class="headerlink" title="单节点"></a>单节点</h2><p>这里我们采集 node-exporter 为例进行说明，首先使用 Prometheus 采集数据，然后将 Prometheus 数据远程写入 VM 远程存储，由于 VM 提供了 <code>vmagent</code> 组件，最后我们使用 VM 来完全替换 Prometheus，可以使架构更简单、更低的资源占用。</p>
<p>这里我们将所有资源运行在 <code>kube-vm</code> 命名空间之下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl create ns kube-vm</span><br></pre></td></tr></table></figure>

<p>首先我们这 <code>kube-vm</code> 命名空间下面使用 DaemonSet 控制器运行 node-exporter，对应的资源清单文件如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vm-node-exporter.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">node-exporter</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostPID:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostIPC:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">prom/node-exporter:v1.3.1</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--web.listen-address=$(HOSTIP):9111</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--path.procfs=/host/proc</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--path.sysfs=/host/sys</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--path.rootfs=/host/root</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.hwmon</span> <span class="comment"># 禁用不需要的一些采集器</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.nfs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.nfsd</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.nvme</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.dmi</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.arp</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--collector.filesystem.ignored-mount-points=^/(dev|proc|sys|var/lib/containerd/.+|/var/lib/docker/.+|var/lib/kubelet/pods/.+)($|/)</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--collector.filesystem.ignored-fs-types=^(autofs|binfmt_misc|cgroup|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|mqueue|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|sysfs|tracefs)$</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9111</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOSTIP</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">status.hostIP</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">150m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">180Mi</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">150m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">180Mi</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">65534</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">proc</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/host/proc</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sys</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/host/sys</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/host/root</span></span><br><span class="line">              <span class="attr">mountPropagation:</span> <span class="string">HostToContainer</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">tolerations:</span> <span class="comment"># 添加容忍</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">&#x27;Exists&#x27;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">proc</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/proc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/dev</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sys</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>

<p>由于前面章节中我们也创建了 node-exporter，为了防止端口冲突，这里我们使用参数 <code>--web.listen-address=$(HOSTIP):9111</code> 配置端口为 <code>9111</code>。直接应用上面的资源清单即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vm-node-exporter.yaml</span><br><span class="line">☸ ➜ kubectl get pods -n kube-vm -owide</span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE    IP              NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">node-exporter-c4d76   1/1     Running   0          118s   192.168.0.109   node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">node-exporter-hzt8s   1/1     Running   0          118s   192.168.0.111   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">node-exporter-zlxwb   1/1     Running   0          118s   192.168.0.110   node1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>然后重新部署一套独立的 Prometheus，为了简单我们直接使用 <code>static_configs</code> 静态配置方式来抓取 node-exporter 的指标，配置清单如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vm-prom-config.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval: 15s</span></span><br><span class="line"><span class="string">      scrape_timeout: 15s</span></span><br><span class="line"><span class="string">    scrape_configs:</span></span><br><span class="line"><span class="string">    - job_name: &quot;nodes&quot;</span></span><br><span class="line"><span class="string">      static_configs:</span></span><br><span class="line"><span class="string">      - targets: [&#x27;192.168.0.109:9111&#x27;, &#x27;192.168.0.110:9111&#x27;, &#x27;192.168.0.111:9111&#x27;]</span></span><br><span class="line"><span class="string">      relabel_configs: # 通过 relabeling 从 __address__ 中提取 IP 信息，为了后面验证 VM 是否兼容 relabeling</span></span><br><span class="line"><span class="string">      - source_labels: [__address__]</span></span><br><span class="line"><span class="string">        regex: &quot;(.*):(.*)&quot;</span></span><br><span class="line"><span class="string">        replacement: &quot;$&#123;1&#125;&quot;</span></span><br><span class="line"><span class="string">        target_label: &#x27;ip&#x27;</span></span><br><span class="line"><span class="string">        action: replace</span></span><br></pre></td></tr></table></figure>

<p>上面配置中通过 <code>relabel</code> 操作从 <code>__address__</code> 中将 IP 信息提取出来，后面可以用来验证 VM 是否兼容 <code>relabel</code> 操作。</p>
<p>同样要给 Prometheus 数据做持久化，所以也需要创建一个对应的 PVC 资源对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apiVersion: storage.k8s.io/v1</span></span><br><span class="line"><span class="comment"># kind: StorageClass</span></span><br><span class="line"><span class="comment"># metadata:</span></span><br><span class="line"><span class="comment">#   name: local-storage</span></span><br><span class="line"><span class="comment"># provisioner: kubernetes.io/no-provisioner</span></span><br><span class="line"><span class="comment"># volumeBindingMode: WaitForFirstConsumer</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-data</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">20Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/k8s/prometheus</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">nodeAffinity:</span></span><br><span class="line">    <span class="attr">required:</span></span><br><span class="line">      <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">node2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-data</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">20Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">local-storage</span></span><br></pre></td></tr></table></figure>

<p>然后直接创建 Prometheus 即可，将上面的 PVC 和 ConfigMap 挂载到容器中，通过 <code>--config.file</code> 参数指定配置文件文件路径，指定 TSDB 数据路径等，资源清单文件如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vm-prom-deploy.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">prometheus-data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">prom/prometheus:v2.35.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--config.file=/etc/prometheus/prometheus.yaml&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--storage.tsdb.path=/prometheus&#x27;</span> <span class="comment"># 指定tsdb数据路径</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--storage.tsdb.retention.time=2d&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--web.enable-lifecycle&#x27;</span> <span class="comment"># 支持热更新，直接执行localhost:9090/-/reload立即生效</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&#x27;/etc/prometheus&#x27;</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&#x27;/prometheus&#x27;</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http</span></span><br></pre></td></tr></table></figure>

<p>直接应用上面的资源清单即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vm-prom-config.yaml</span><br><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vm-prom-pvc.yaml</span><br><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vm-prom-deploy.yaml</span><br><span class="line">☸ ➜ kubectl get pods -n kube-vm -owide</span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE     IP              NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">node-exporter-c4d76       1/1     Running   0          27m     192.168.0.109   node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">node-exporter-hzt8s       1/1     Running   0          27m     192.168.0.111   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">node-exporter-zlxwb       1/1     Running   0          27m     192.168.0.110   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">prometheus-dfc9f6-2w2vf   1/1     Running   0          4m58s   10.244.2.102    node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">☸ ➜ kubectl get svc -n kube-vm</span><br><span class="line">NAME         TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">prometheus   NodePort   10.103.38.114   &lt;none&gt;        9090:31890/TCP   4m10s</span><br></pre></td></tr></table></figure>

<p>部署完成后可以通过 <code>http://&lt;node-ip&gt;:31890</code> 访问 Prometheus，正常可以看到采集的 3 个 node 节点的指标任务。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/ma9ow6.png"></p>
<p>同样的方式重新部署 Grafana，资源清单如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vm-grafana.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">grafana-data</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">grafana/grafana:main</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_SECURITY_ADMIN_USER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">admin</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_SECURITY_ADMIN_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">admin321</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/grafana</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">storage</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-data</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/k8s/grafana</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">nodeAffinity:</span></span><br><span class="line">    <span class="attr">required:</span></span><br><span class="line">      <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">node2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-data</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">local-storage</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vm-grafana.yaml</span><br><span class="line">☸ ➜ kubectl get svc -n kube-vm |grep grafana</span><br><span class="line">grafana      NodePort   10.97.111.153   &lt;none&gt;        3000:31800/TCP   62s</span><br></pre></td></tr></table></figure>

<p>同样通过 <code>http://&lt;node-ip&gt;:31800</code> 就可以访问 Grafana 了，进入 Grafana 配置 Prometheus 数据源。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/1yq8cp.png" alt="Grafana 数据源"></p>
<p>然后导入 <a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/16098">16098</a> 这个 Dashboard，导入后效果如下图所示。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/ryr3oo.png" alt="node exporter dashboard"></p>
<p>到这里就完成了使用 Prometheus 收集节点监控指标，接下来我们来使用 VM 来改造现有方案。</p>
<h3 id="远程存储-VictoriaMetrics"><a href="#远程存储-VictoriaMetrics" class="headerlink" title="远程存储 VictoriaMetrics"></a>远程存储 VictoriaMetrics</h3><p>首先需要一个单节点模式的 VM，运行 VM 很简单，可以直接下载对应的二进制文件启动，也可以使用 docker 镜像一键启动，我们这里同样部署到 Kubernetes 集群中。资源清单文件如下所示。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vm-grafana.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">victoria-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">victoria-metrics</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">victoria-metrics</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">victoria-metrics-data</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vm</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">victoriametrics/victoria-metrics:v1.76.1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-storageDataPath=/var/lib/victoria-metrics-data</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-retentionPeriod=1w</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8428</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/victoria-metrics-data</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">storage</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">victoria-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8428</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">victoria-metrics</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">victoria-metrics-data</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">20Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/k8s/vm</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">nodeAffinity:</span></span><br><span class="line">    <span class="attr">required:</span></span><br><span class="line">      <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">node2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">victoria-metrics-data</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">20Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">local-storage</span></span><br></pre></td></tr></table></figure>

<p>这里我们使用 <code>-storageDataPath</code> 参数指定了数据存储目录，然后同样将该目录进行了持久化，<code>-retentionPeriod</code> 参数可以用来配置数据的保持周期。直接应用上面的资源清单即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vm-single-node-deploy.yaml</span><br><span class="line">☸ ➜ kubectl get svc victoria-metrics -n kube-vm</span><br><span class="line">NAME               TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">victoria-metrics   NodePort   10.106.216.248   &lt;none&gt;        8428:31953/TCP   75m</span><br><span class="line">☸ ➜ kubectl get pods -n kube-vm -l app=victoria-metrics</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">victoria-metrics-57d47f4587-htb88   1/1     Running   0          3m12s</span><br><span class="line">☸ ➜ kubectl logs -f victoria-metrics-57d47f4587-htb88 -n kube-vm</span><br><span class="line">2022-04-22T08:59:14.431Z        info    VictoriaMetrics/lib/logger/flag.go:12   build version: victoria-metrics-20220412-134346-tags-v1.76.1-0-gf8de318bf</span><br><span class="line">2022-04-22T08:59:14.431Z        info    VictoriaMetrics/lib/logger/flag.go:13   command line flags</span><br><span class="line">2022-04-22T08:59:14.431Z        info    VictoriaMetrics/lib/logger/flag.go:20   flag &quot;retentionPeriod&quot;=&quot;1w&quot;</span><br><span class="line">2022-04-22T08:59:14.431Z        info    VictoriaMetrics/lib/logger/flag.go:20   flag &quot;storageDataPath&quot;=&quot;/var/lib/victoria-metrics-data&quot;</span><br><span class="line">2022-04-22T08:59:14.431Z        info    VictoriaMetrics/app/victoria-metrics/main.go:52 starting VictoriaMetrics at &quot;:8428&quot;...</span><br><span class="line">2022-04-22T08:59:14.432Z        info    VictoriaMetrics/app/vmstorage/main.go:97        opening storage at &quot;/var/lib/victoria-metrics-data&quot; with -retentionPeriod=1w</span><br><span class="line">......</span><br><span class="line">2022-04-22T08:59:14.449Z        info    VictoriaMetrics/app/victoria-metrics/main.go:61 started VictoriaMetrics in 0.017 seconds</span><br><span class="line">2022-04-22T08:59:14.449Z        info    VictoriaMetrics/lib/httpserver/httpserver.go:91 starting http server at http://127.0.0.1:8428/</span><br></pre></td></tr></table></figure>

<p>到这里我们单节点的 <code>VictoriaMetrics</code> 就部署成功了。接下来我们只需要在 Prometheus 中配置远程写入我们的 VM 即可，更改 Prometheus 配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vm-prom-config2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval: 15s</span></span><br><span class="line"><span class="string">      scrape_timeout: 15s</span></span><br><span class="line"><span class="string">    remote_write:    # 远程写入到远程 VM 存储</span></span><br><span class="line"><span class="string">    - url: http://victoria-metrics:8428/api/v1/write</span></span><br><span class="line"><span class="string">    scrape_configs:</span></span><br><span class="line"><span class="string">    - job_name: &quot;nodes&quot;</span></span><br><span class="line"><span class="string">      static_configs:</span></span><br><span class="line"><span class="string">      - targets: [&#x27;192.168.0.109:9111&#x27;, &#x27;192.168.0.110:9111&#x27;, &#x27;192.168.0.111:9111&#x27;]</span></span><br><span class="line"><span class="string">      relabel_configs: # 通过 relabeling 从 __address__ 中提取 IP 信息，为了后面验证 VM 是否兼容 relabeling</span></span><br><span class="line"><span class="string">      - source_labels: [__address__]</span></span><br><span class="line"><span class="string">        regex: &quot;(.*):(.*)&quot;</span></span><br><span class="line"><span class="string">        replacement: &quot;$&#123;1&#125;&quot;</span></span><br><span class="line"><span class="string">        target_label: &#x27;ip&#x27;</span></span><br><span class="line"><span class="string">        action: replace</span></span><br></pre></td></tr></table></figure>

<p>重新更新 Prometheus 的配置资源对象：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vm-prom-config2.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新后执行 reload 操作重新加载 prometheus 配置</span></span><br><span class="line">☸ ➜ curl -X POST &quot;http://192.168.0.111:31890/-/reload&quot;</span><br></pre></td></tr></table></figure>

<p>配置生效后 Prometheus 就会开始将数据远程写入 VM 中，我们可以查看 VM 的持久化数据目录是否有数据产生来验证：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ ll /data/k8s/vm/data/</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 4 root root 38 Apr 22 17:15 big</span><br><span class="line">-rw-r--r-- 1 root root  0 Apr 22 16:59 flock.lock</span><br><span class="line">drwxr-xr-x 4 root root 38 Apr 22 17:15 small</span><br></pre></td></tr></table></figure>

<p>现在我们去直接将 Grafana 中的数据源地址修改成 VM 的地址：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1650619046819.png" alt="修改数据源"></p>
<p>修改完成后重新访问 node-exporter 的 dashboard，正常可以显示，证明 VM 是兼容的。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/srine5.png" alt="节点dashboard"></p>
<h3 id="替换-Prometheus"><a href="#替换-Prometheus" class="headerlink" title="替换 Prometheus"></a>替换 Prometheus</h3><p>上面我们将 Prometheus 数据远程写入到了 VM，但是 Prometheus 开启 remote write 功能后会增加其本身的资源占用，理论上其实我们也可以完全用 VM 来替换掉 Prometheus，这样就不需要远程写入了，而且本身 VM 就比 Prometheus 占用更少的资源。</p>
<p>现在我们先停掉 Prometheus 的服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl scale deploy prometheus --replicas=0 -n kube-vm</span><br></pre></td></tr></table></figure>

<p>然后将 Prometheus 的配置文件挂载到 VM 容器中，使用参数 <code>-promscrape.config</code> 来指定 Prometheus 的配置文件路径，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vm-single-node-deploy2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">victoria-metrics</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">victoria-metrics</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">victoria-metrics</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">victoria-metrics-data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vm</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">victoriametrics/victoria-metrics:v1.76.1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-storageDataPath=/var/lib/victoria-metrics-data</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-retentionPeriod=1w</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-promscrape.config=/etc/prometheus/prometheus.yaml</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8428</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/victoria-metrics-data</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">storage</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/prometheus</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br></pre></td></tr></table></figure>

<p>记得先将 Prometheus 配置文件中的 remote_write 模块去掉，然后重新更新 VM 即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vm-prom-config.yaml</span><br><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vm-single-node-deploy2.yaml</span><br><span class="line">☸ ➜ kubectl get pods -n kube-vm -l app=victoria-metrics</span><br><span class="line">NAME                                READY   STATUS    RESTARTS       AGE</span><br><span class="line">victoria-metrics-8466844968-ncfnp   1/1     Running   2 (3m3s ago)   3m45s</span><br><span class="line">☸ ➜ kubectl logs -f victoria-metrics-8466844968-ncfnp -n kube-vm</span><br><span class="line">......</span><br><span class="line">2022-04-22T10:01:59.837Z        info    VictoriaMetrics/app/victoria-metrics/main.go:61 started VictoriaMetrics in 0.022 seconds</span><br><span class="line">2022-04-22T10:01:59.837Z        info    VictoriaMetrics/lib/httpserver/httpserver.go:91 starting http server at http://127.0.0.1:8428/</span><br><span class="line">2022-04-22T10:01:59.837Z        info    VictoriaMetrics/lib/httpserver/httpserver.go:92 pprof handlers are exposed at http://127.0.0.1:8428/debug/pprof/</span><br><span class="line">2022-04-22T10:01:59.838Z        info    VictoriaMetrics/lib/promscrape/scraper.go:103   reading Prometheus configs from &quot;/etc/prometheus/prometheus.yaml&quot;</span><br><span class="line">2022-04-22T10:01:59.838Z        info    VictoriaMetrics/lib/promscrape/config.go:96     starting service discovery routines...</span><br><span class="line">2022-04-22T10:01:59.839Z        info    VictoriaMetrics/lib/promscrape/config.go:102    started service discovery routines in 0.000 seconds</span><br><span class="line">2022-04-22T10:01:59.840Z        info    VictoriaMetrics/lib/promscrape/scraper.go:395   static_configs: added targets: 3, removed targets: 0; total targets: 3</span><br></pre></td></tr></table></figure>

<p>从 VM 日志中可以看出成功读取了 Prometheus 的配置，并抓取了 3 个指标（node-exporter）。 现在我们再去 Grafana 查看 node-exporter 的 Dashboard 是否可以正常显示。先保证数据源是 VM 的地址。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/gtnpt6.png" alt="vm数据源"></p>
<p>这样我们就使用 VM 替换掉了 Prometheus，我们也可以这 Grafana 的 Explore 页面去探索采集到的指标。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/qobjui.png" alt="node dashboard"></p>
<h3 id="UI-界面"><a href="#UI-界面" class="headerlink" title="UI 界面"></a>UI 界面</h3><p>VM 单节点版本本身自带了一个 Web UI 界面 - <a target="_blank" rel="noopener" href="https://github.com/VictoriaMetrics/VictoriaMetrics/tree/master/app/vmui">vmui</a>，不过目前功能比较简单，可以直接通过 VM 的 NodePort 端口进行访问。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl get svc victoria-metrics -n kube-vm</span><br><span class="line">NAME               TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">victoria-metrics   NodePort   10.106.216.248   &lt;none&gt;        8428:31953/TCP   75m</span><br></pre></td></tr></table></figure>



<p>我们这里可以通过 <code>http://&lt;node-ip&gt;:31953</code> 访问到 vmui：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/vsf32g.png" alt="vmui"></p>
<p>可以通过 <code>/vmui</code> 这个 endpoint 访问 UI 界面：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/f16t5o.jpg" alt="vmui web ui"></p>
<p>如果你想查看采集到的指标 targets，那么可以通过 <code>/targets</code> 这个 endpoint 来获取：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/o4cymc.png" alt="targets"></p>
<p>这些功能基本上可以满足我们的一些需求，但是还是太过简单，如果你习惯了 Prometheus 的 UI 界面，那么我们可以使用 <code>promxy</code> 来代替 <code>vmui</code>，而且 <code>promxy</code> 还可以进行多个 VM 单节点的数据聚合，以及 targets 查看等，对应的资源清单文件如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vm-promxy.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promxy-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">config.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    promxy:</span></span><br><span class="line"><span class="string">      server_groups:</span></span><br><span class="line"><span class="string">      - static_configs:</span></span><br><span class="line"><span class="string">        - targets: [victoria-metrics:8428]  # 指定vm地址，有多个则往后追加即可</span></span><br><span class="line"><span class="string">        path_prefix: /prometheus  # 配置前缀</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promxy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">promxy</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">promxy</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--config=/etc/promxy/config.yaml&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--web.enable-lifecycle&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--log-level=trace&#x27;</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ROLE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;/bin/promxy&#x27;</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/jacksontj/promxy</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">promxy</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8082</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&#x27;/etc/promxy/&#x27;</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">promxy-config</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">args:</span> <span class="comment"># container to reload configs on configmap change</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--volume-dir=/etc/promxy&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--webhook-url=http://localhost:8082/-/reload&#x27;</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">jimmidyson/configmap-reload:v0.1</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">promxy-server-configmap-reload</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&#x27;/etc/promxy/&#x27;</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">promxy-config</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">promxy-config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">promxy-config</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promxy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">promxy</span></span><br></pre></td></tr></table></figure>

<p>直接应用上面的资源对象即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vm-promxy.yaml</span><br><span class="line">☸ ➜ kubectl get pods -n kube-vm -l app=promxy</span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">promxy-5f7dfdbc64-l4kjq   2/2     Running   0          6m45s</span><br><span class="line">☸ ➜ kubectl get svc promxy -n kube-vm</span><br><span class="line">NAME               TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">promxy             NodePort   10.110.19.254    &lt;none&gt;        8082:30618/TCP   6m12s</span><br></pre></td></tr></table></figure>

<p>访问 Promxy 的页面效果和 Prometheus 自带的 Web UI 基本一致的。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/qr3o59.png" alt="promxy"></p>
<p>这里面我们简单介绍了单机版的 <code>victoriametrics</code> 的基本使用。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/%E5%88%87%E7%89%87%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/%E5%88%87%E7%89%87%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/" class="post-title-link" itemprop="url">切片内存分配</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:15:21" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="核心概念回顾：切片的结构"><a href="#核心概念回顾：切片的结构" class="headerlink" title="核心概念回顾：切片的结构"></a>核心概念回顾：切片的结构</h3><p>在深入容量增长之前，我们先回顾一下 Go 切片的基本结构。一个切片实际上是一个轻量级的数据结构，它包含三个字段：</p>
<ol>
<li><strong>指向底层数组的指针 (Pointer)：</strong> 指向切片数据所在的底层数组的起始位置。</li>
<li><strong>长度 (Length, <code>len</code>)：</strong> 切片当前包含的元素个数。</li>
<li><strong>容量 (Capacity, <code>cap</code>)：</strong> 从切片的第一个元素（即指针指向的位置）开始，到其底层数组末尾的元素个数。这表示切片在不重新分配底层数组的情况下，可以容纳的最大元素数量。</li>
</ol>
<h3 id="何时触发容量增长？"><a href="#何时触发容量增长？" class="headerlink" title="何时触发容量增长？"></a>何时触发容量增长？</h3><p>切片的容量增长主要发生在调用内置函数 <code>append()</code> 时。当您向一个切片 <code>s</code> 追加元素，导致其当前长度 <code>len(s)</code> 超过其容量 <code>cap(s)</code> 时，Go 运行时就需要为切片分配一个新的、更大的底层数组。</p>
<h3 id="容量增长策略详解"><a href="#容量增长策略详解" class="headerlink" title="容量增长策略详解"></a>容量增长策略详解</h3><p>Go 语言的切片容量增长策略旨在平衡两个主要目标：</p>
<ol>
<li><strong>减少内存重新分配的频率：</strong> 频繁地分配新数组和拷贝数据会带来性能开销。</li>
<li><strong>避免内存过度浪费：</strong> 每次都分配一个远超所需的大容量可能会浪费大量内存。</li>
</ol>
<p>Go 的增长策略是一个动态的过程，其具体实现可能会随 Go 版本更新而略有调整，但核心思想是不变的。目前的策略概括起来是：</p>
<ol>
<li><p><strong>期望的新容量 (<code>newCap</code>) 计算：</strong> 首先，runtime 会计算一个期望的新容量，这个容量必须至少能够容纳 <code>oldLen + addedCount</code> 的元素。</p>
</li>
<li><p><strong>实际分配的容量 (<code>allocCap</code>) 确定（核心扩容逻辑）：</strong></p>
<ul>
<li><strong>如果旧容量 (<code>oldCap</code>) 小于 1024（这个阈值可能会变动）：</strong> 通常会采用<strong>翻倍</strong>的策略。新的容量 (<code>allocCap</code>) 会被设置为 <code>oldCap * 2</code>。这种方式在大约 <code>log2(所需容量)</code> 次扩容后就能达到目标，减少了扩容频率。</li>
<li><strong>如果旧容量 (<code>oldCap</code>) 大于或等于 1024：</strong> 增长策略会变得更加保守，以避免过度浪费内存。通常会采用<strong>大约 1.25 倍</strong>的增长因子（例如，<code>newCap = oldCap + oldCap/4</code>），并持续增长直到达到或超过所需容量。这种方式在高容量时提供了一个更线性的增长。</li>
<li><strong>最终确定：</strong> 无论哪种情况，最终分配的容量 (<code>allocCap</code>) 都会被调整，使其能够至少容纳所有现有元素和新追加的元素 (<code>oldLen + addedCount</code>)。并且，<code>allocCap</code> 还会根据内存分配器的需求向上取整，以满足内存对齐等要求。</li>
</ul>
</li>
</ol>
<h3 id="底层机制：新数组与数据拷贝"><a href="#底层机制：新数组与数据拷贝" class="headerlink" title="底层机制：新数组与数据拷贝"></a>底层机制：新数组与数据拷贝</h3><p>当切片需要扩容时，Go 运行时会执行以下步骤：</p>
<ol>
<li><strong>分配新的、更大的底层数组：</strong> 根据上述容量增长策略计算出的新容量大小，在堆上分配一块新的连续内存空间。</li>
<li><strong>数据拷贝：</strong> 将旧底层数组中的所有元素（从原始切片的起点到终点）拷贝到新分配的数组中。</li>
<li><strong>更新切片头信息：</strong><ul>
<li>切片的指针会更新为指向新分配的底层数组的起始位置。</li>
<li>切片的长度会更新为 <code>oldLen + addedCount</code>。</li>
<li>切片的容量会更新为新分配数组的实际容量 (<code>allocCap</code>)。</li>
</ul>
</li>
<li><strong>旧数组的回收：</strong> 一旦旧的底层数组不再有任何引用指向它（即旧切片变量不再使用，或者新的切片已经指向了新的数组），Go 的垃圾回收器会在适当的时候自动回收这部分内存。</li>
</ol>
<p><strong>示例：</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	s := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, <span class="number">1</span>) <span class="comment">// len=0, cap=1</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;Initial: len=%d, cap=%d, addr=%p\n&quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s)</span><br><span class="line"></span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="number">1</span>) <span class="comment">// len=1, cap=1 (未扩容)</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;Append 1: len=%d, cap=%d, addr=%p\n&quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s)</span><br><span class="line"></span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="number">2</span>) <span class="comment">// len=2, cap=1 -&gt; 扩容，新容量翻倍 (1*2=2)</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;Append 2: len=%d, cap=%d, addr=%p\n&quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s)</span><br><span class="line"></span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="number">3</span>) <span class="comment">// len=3, cap=2 -&gt; 扩容，新容量翻倍 (2*2=4)</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;Append 3: len=%d, cap=%d, addr=%p\n&quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s)</span><br><span class="line"></span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="number">4</span>) <span class="comment">// len=4, cap=4 (未扩容)</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;Append 4: len=%d, cap=%d, addr=%p\n&quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s)</span><br><span class="line"></span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="number">5</span>) <span class="comment">// len=5, cap=4 -&gt; 扩容，新容量翻倍 (4*2=8)</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;Append 5: len=%d, cap=%d, addr=%p\n&quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 如果持续追加到容量超过1024，你会发现增长因子会从2变为1.25左右</span></span><br><span class="line">    <span class="comment">// for i := 0; i &lt; 1000; i++ &#123;</span></span><br><span class="line">    <span class="comment">//    s = append(s, i)</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// fmt.Printf(&quot;Append many: len=%d, cap=%d, addr=%p\n&quot;, len(s), cap(s), s)</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>输出示例（地址可能不同）：</strong></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Initial</span>: len=<span class="number">0</span>, cap=<span class="number">1</span>, addr=<span class="number">0</span>xc0000a6000</span><br><span class="line"><span class="attribute">Append</span> <span class="number">1</span>: len=<span class="number">1</span>, cap=<span class="number">1</span>, addr=<span class="number">0</span>xc0000a6000</span><br><span class="line"><span class="attribute">Append</span> <span class="number">2</span>: len=<span class="number">2</span>, cap=<span class="number">2</span>, addr=<span class="number">0</span>xc0000aa000  // 地址改变，底层数组已扩容</span><br><span class="line"><span class="attribute">Append</span> <span class="number">3</span>: len=<span class="number">3</span>, cap=<span class="number">4</span>, addr=<span class="number">0</span>xc0000ac000  // 地址改变，底层数组已扩容</span><br><span class="line"><span class="attribute">Append</span> <span class="number">4</span>: len=<span class="number">4</span>, cap=<span class="number">4</span>, addr=<span class="number">0</span>xc0000ac000</span><br><span class="line"><span class="attribute">Append</span> <span class="number">5</span>: len=<span class="number">5</span>, cap=<span class="number">8</span>, addr=<span class="number">0</span>xc0000ae000  // 地址改变，底层数组已扩容</span><br></pre></td></tr></table></figure>
<p>从输出中可以清晰地看到，当 <code>len</code> 超过 <code>cap</code> 时，<code>cap</code> 会翻倍增长，<code>addr</code> 也会改变，这说明创建了新的底层数组并进行了数据拷贝。</p>
<h3 id="性能考量与优化"><a href="#性能考量与优化" class="headerlink" title="性能考量与优化"></a>性能考量与优化</h3><p>由于扩容涉及到内存重新分配和数据拷贝，它是一个潜在的性能开销点。为了优化性能，您可以：</p>
<ol>
<li><strong>预分配容量：</strong> 如果您能大致预估切片最终需要的元素数量，可以在创建切片时就为其分配足够的容量，使用 <code>make([]T, initialLength, maxCapacity)</code>。这样可以减少甚至避免多次扩容操作。<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设我们知道切片最终大约会有1000个元素</span></span><br><span class="line">mySlice := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, <span class="number">1000</span>) <span class="comment">// 预分配1000容量</span></span><br><span class="line"><span class="comment">// 现在可以追加多达1000个元素而无需扩容</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">500</span>; i++ &#123;</span><br><span class="line">    mySlice = <span class="built_in">append</span>(mySlice, i)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...知道容量不足1000时才会触发扩容</span></span><br></pre></td></tr></table></figure></li>
<li><strong>避免不必要的 <code>append</code>：</strong> 在某些场景下，直接操作底层数组或使用固定大小的数组可能比频繁使用 <code>append</code> 更高效。</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Go 语言的切片容量增长机制是其高效的基础之一。它通过智能的扩容策略（小容量翻倍，大容量线性增长）和底层的垃圾回收机制，为开发者提供了灵活且安全的动态数组体验，同时隐藏了复杂的内存管理细节。理解这一机制有助于您更好地利用 Go 切片，并编写出高性能的应用程序。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/%E5%9C%A8%20Kubernetes%20%E4%B8%8A%E9%83%A8%E7%BD%B2%20LLM%20%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/%E5%9C%A8%20Kubernetes%20%E4%B8%8A%E9%83%A8%E7%BD%B2%20LLM%20%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">在 Kubernetes 上部署 LLM 大语言模型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:20:02" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/%E5%A4%A7%E6%A8%A1%E5%9E%8B/" itemprop="url" rel="index"><span itemprop="name">大模型</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="在-Kubernetes-上部署-LLM-大语言模型"><a href="#在-Kubernetes-上部署-LLM-大语言模型" class="headerlink" title="在 Kubernetes 上部署 LLM 大语言模型"></a>在 Kubernetes 上部署 LLM 大语言模型</h1><p>从今年开始，人们对大型语言模型 (LLM) 及其在 GPU 基础设施上的部署的兴趣显着增加。这种不断增长的热情是由人工智能和机器学习的进步推动的，这需要 GPU 能够有效提供大量的计算能力。GPU 领先制造商 Nvidia 的股价也因这一趋势而飙升。同样诞生了大量的大模型，对于这些模型的部署和管理也变得越来越重要，在这方面 <code>Ollama</code> 和 <code>OpenUI</code> 是一个不错的选择。</p>
<p><a target="_blank" rel="noopener" href="https://ollama.com/">Ollama</a> 是一个开源的机器学习模型部署工具，它可以帮助您将模型部署到生产环境中，简化大型语言模型 (LLM) 的管理和交互。Ollama 拥有各种一流的开源模型，例如 <code>Llama 3</code>、<code>Phi 3</code>、<code>Mistral</code> 等等，我们可以将 Ollama 看成是 Docker，但是专注于机器学习模型。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/5y0t41.png" alt="img"></p>
<p>使用 <code>Ollama</code> 部署模型非常简单，就类似于使用 Docker 部署应用程序一样。但是，如果你对 CLI 不熟悉，那么使用 <code>Ollama</code> 会有点痛苦。为了解决这个问题，我们可以使用一个 <a target="_blank" rel="noopener" href="https://github.com/open-webui/open-webui">open-webui</a> 的项目，它提供了一个漂亮的界面，可以让您更轻松地部署模型。</p>
<p>为了更好地管理 Ollama，我们可以将 Ollama 部署到 Kubernetes 集群中。这样，我们就可以更好地管理 Ollama，而不需要担心 Ollama 的高可用性、扩展性等问题。</p>
<p>当然首先需要一个 Kubernetes 集群，最好带有 GPU，但即使没有 GPU，<code>llama3</code> 模型在仅使用 CPU 的情况下也能表现得相对较好。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl version</span><br><span class="line">Client Version: v1.28.11</span><br><span class="line">Kustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3</span><br><span class="line">Server Version: v1.28.7</span><br></pre></td></tr></table></figure>

<h2 id="部署-Ollama-到-Kubernetes"><a href="#部署-Ollama-到-Kubernetes" class="headerlink" title="部署 Ollama 到 Kubernetes"></a>部署 Ollama 到 Kubernetes</h2><p>要部署 Ollama 和 Open-WebUI 到 Kubernetes 很简单，因为 Open-WebUI 项目提供了一个 Helm Chart，可以让我们更轻松地部署 Ollama 和 Open-WebUI。这个 charts 包被托管在 <a target="_blank" rel="noopener" href="https://helm.openwebui.com/">https://helm.openwebui.com</a>，我们可以使用 Helm 添加这个 repo：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add open-webui https://helm.openwebui.com/</span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure>

<p><code>open-webui</code> 这个 charts 包默认情况下会部署 <code>Ollama</code>，我们可以根据自己的需求进行配置，例如我们可以配置 <code>Ollama</code> 是否使用 GPU，是否开启数据持久化等等，我们可以覆盖默认的配置来进行配置，如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># myvalues.yaml</span></span><br><span class="line"><span class="attr">ollama:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 自动安装 Ollama Helm Chart</span></span><br><span class="line">  <span class="attr">ollama:</span> <span class="comment"># 配置 Ollama</span></span><br><span class="line">    <span class="attr">gpu:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment"># 是否使用 GPU</span></span><br><span class="line">    <span class="comment">#   type: &#x27;nvidia&#x27;</span></span><br><span class="line">    <span class="comment">#   number: 1</span></span><br><span class="line">    <span class="comment"># models:  # 容器启动的时候加载的模型</span></span><br><span class="line">    <span class="comment">#  - llama3</span></span><br><span class="line">    <span class="comment">#  - mistral</span></span><br><span class="line">  <span class="attr">persistentVolume:</span> <span class="comment"># 配置持久化存储</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">storageClass:</span> <span class="string">nfs-client</span> <span class="comment"># 指定 storageClass</span></span><br><span class="line">    <span class="comment"># existingClaim: &quot;&quot;  # 也可以使用已经存在的 PVC</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== Pipelines 配置 ==========</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pipelines:</span> <span class="comment"># OpenAI API 插件框架</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">persistence:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">storageClass:</span> <span class="string">&quot;nfs-client&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== open-webui 配置 ==========</span></span><br><span class="line"><span class="comment"># ingress: # 配置 Ingress</span></span><br><span class="line"><span class="comment">#   enabled: false</span></span><br><span class="line"><span class="comment">#   host: &quot;open-webui.example.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置持久化存储</span></span><br><span class="line"><span class="attr">persistence:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment">#   existingClaim: &quot;&quot;  # 也可以使用已经存在的 PVC</span></span><br><span class="line">  <span class="attr">storageClass:</span> <span class="string">&quot;nfs-client&quot;</span> <span class="comment"># 指定 storageClass</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span> <span class="comment"># 设置 Service 类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定 OpenAI API URL，如果不指定，默认使用 Pipelines 服务的端点  https://api.openai.com/v1</span></span><br><span class="line"><span class="comment"># openaiBaseApiUrl: &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置额外的环境变量</span></span><br><span class="line"><span class="attr">extraEnvVars:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HF_ENDPOINT</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">https://hf-mirror.com</span></span><br><span class="line"><span class="comment"># - name: OPENAI_API_KEY # 指定 OpenAI API Key</span></span><br><span class="line"><span class="comment">#   value: &quot;0p3n-w3bu!&quot;</span></span><br></pre></td></tr></table></figure>

<p>在上面的配置中，我们可以配置 <code>Ollama</code> 是否使用 GPU，是否开启数据持久化等等，对于 <code>open-webui</code> 部分，我们配置的是一个 <code>NodePort</code> 类型的 Service，这样我们就可以通过 Node 的 IP 和 NodePort 来访问 Open-WebUI 项目，当然你也可以配置 Ingress 来访问。</p>
<blockquote>
<p>注意：Open-WebUI 项目默认会去访问 <code>huggingface</code> 的模型仓库，因为某些原因，默认情况下国内是无法访问的，所以我们需要配置 <code>HF_ENDPOINT</code> 环境变量来指定一个镜像地址 <code>https://hf-mirror.com</code>，否则会出错。</p>
</blockquote>
<p>然后我们可以使用 Helm 安装这个 charts 包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install ollama open-webui/open-webui -f myvalues.yaml --create-namespace --namespace kube-ai</span><br></pre></td></tr></table></figure>

<p>部署完成后，会在 <code>kube-ai</code> 这个命名空间下运行几个 Pod，我们可以查看 Pod 的状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-ai</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS        AGE</span><br><span class="line">open-webui-0                            1/1     Running   0               2m11s</span><br><span class="line">open-webui-ollama-944dd68fc-wxsjf       1/1     Running   0               24h</span><br><span class="line">open-webui-pipelines-557f6f95cd-dfgh8   1/1     Running   0               25h</span><br></pre></td></tr></table></figure>

<p>因为上面我们配置的是 <code>NodePort</code> 类型的 Service，所以我们可以通过 Node 的 IP 和 NodePort 来访问 Open-WebUI 项目：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc -n kube-ai</span><br><span class="line">NAME                   TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">open-webui             NodePort    10.96.1.212   &lt;none&gt;        80:31009/TCP     25h</span><br><span class="line">open-webui-ollama      ClusterIP   10.96.2.112   &lt;none&gt;        11434/TCP        25h</span><br><span class="line">open-webui-pipelines   NodePort    10.96.2.170   &lt;none&gt;        9099:32322/TCP   25h</span><br></pre></td></tr></table></figure>

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>现在我们就可以通过 <code>http://NodeIP:31009</code> 来访问 Open-WebUI 项目了。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/hucrq0.png" alt="img"></p>
<p>第一次使用的时候需要注册一个账号，然后我们就可以登录到 Open-WebUI 项目主页了。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/uzhcjk.png" alt="img"></p>
<p>如果你有 <code>ollama</code> 在其他地方运行，我们可以将其添加为另一个连接。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/7j8rpp.png" alt="img"></p>
<p>首先需要配置连接 <code>ollama</code> 的地址，然后我们就可以连接到 <code>ollama</code> 了，连接成功后，我们就可以看到 <code>ollama</code> 的模型列表了。</p>
<p>点击左下角的用户头像，然后选择 <code>管理员面板</code>，在管理员面板页面选择 <code>设置</code> 标签页，然后切换到 <code>外部连接</code> 配置项，我们可以设置 <code>Ollama API</code> 地址，我们这里使用的是 Helm 部署的 <code>Ollama</code>，默认已经为我们配置好了 <code>Ollama API</code> 地址。</p>
<p>接下来切换到 <code>模型</code> 标签页，我们就可以从 <code>Ollama</code> 的模型仓库中拉取模型了，可以下载的模型可以从 <code>https://ollama.com/library</code> 查看。比如我们这里选择 <code>llama3</code> 模型，输入 <code>llama3</code> 然后点击右侧的拉取下载按钮，就会开始下载这个模型了，在页面中也可以看到下载的进度。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/irjyks.png" alt="img"></p>
<p>模型拉取完成后，切回到首页，我们就可以选择切换到 <code>llama3</code> 模型了。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/cmo4xw.png" alt="img"></p>
<p>接下来我们就可以使用 <code>llama3</code> 模型为我们服务了。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/h2auy4.png" alt="img"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在本文中，我们探讨了使用 Open WebUI 在 Kubernetes 集群上部署 <code>llama3</code> 的过程。通过容器化和编排技术，我们成功地将 AI powered 的聊天机器人部署到了可扩展和维护的环境中。Open WebUI 的简洁界面和 Kubernetes 的强大自动化能力，让我们简化了部署过程，减少了手动干预。随着世界对 AI 驱动解决方案的不断依赖，这种技术组合将扮演关键角色，快速地带领创新应用程序 llama3 告诉市场。 AI Powered 的聊天机器人的未来看起来非常光明，Open WebUI 和 Kubernetes 将继续领先，期待着下一个令人兴奋的发展！（这一段就来自 <code>llama3</code> 模型生成）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/%E5%8F%98%E5%8C%96%E7%8E%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/%E5%8F%98%E5%8C%96%E7%8E%87/" class="post-title-link" itemprop="url">变化率</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:10:01" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/" itemprop="url" rel="index"><span itemprop="name">k8s-monitor</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/Prometheus/" itemprop="url" rel="index"><span itemprop="name">Prometheus</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/Prometheus/Query-PromQL/" itemprop="url" rel="index"><span itemprop="name">Query PromQL</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="变化率"><a href="#变化率" class="headerlink" title="变化率"></a>变化率</h1><p>通常来说直接绘制一个原始的 <code>Counter</code> 类型的指标数据用处不大，因为它们会一直增加，一般来说是不会去直接关心这个数值的，因为 <code>Counter</code> 一旦重置，总计数就没有意义了，比如我们直接执行下面的查询语句：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">demo_api_request_duration_seconds_count&#123;job=&quot;demo&quot;&#125;</span><br></pre></td></tr></table></figure>



<p>可以得到下图所示的图形：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/x1hbsd.png" alt="Prometheus Counter Graph"></p>
<p>可以看到所有的都是不断增长的，一般来说我们更想要知道的是 Counter 指标的变化率，PromQL 提供了不同的函数来计算变化率。</p>
<h2 id="rate"><a href="#rate" class="headerlink" title="rate"></a>rate</h2><p>用于计算变化率的最常见函数是 <code>rate()</code>，<code>rate()</code> 函数用于计算在指定时间范围内计数器平均每秒的增加量。因为是计算一个时间范围内的平均值，所以我们需要在序列选择器之后添加一个范围选择器。</p>
<p>例如我们要计算 <code>demo_api_request_duration_seconds_count</code> 在最近五分钟内的每秒平均变化率，则可以使用下面的查询语句：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(demo_api_request_duration_seconds_count[5m])</span><br></pre></td></tr></table></figure>



<p>可以得到如下所示的图形：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/kmzal5.png" alt="Prometheus Rate Graph"></p>
<p>现在绘制的图形看起来显然更加有意义了，进行 rate 计算的时候是选择指定时间范围下的第一和最后一个样本进行计算，下图是表示瞬时计算的计算方式：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/6wsfkn.png" alt="rate"></p>
<p>往往我们需要的是绘制一个图形，那么就需要进行区间查询，指定一个时间范围内进行多次计算，将结果串联起来形成一个图形：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/d6cs62.png" alt="rate"></p>
<p>对于 <code>rate()</code> 和相关函数有几个需要说明的：</p>
<ul>
<li>当被抓取指标进的程重启时，<code>Counter</code> 指标可能会重置为 0，但 <code>rate()</code> 函数会自动处理这个问题，它会假设 <code>Counter</code> 指标的值只要是减少了就认为是被重置了，然后它可以调整后续的样本，例如，如果时间序列的值为<code>[5,10,4,6]</code>，则将其视为<code>[5,10,14,16]</code>。</li>
<li>变化率是从指定的时间范围下包含的样本进行计算的，需要注意的是这个时间窗口的边界并不一定就是一个样本数据，可能会不完全对齐，所以，即使对于每次都是增加整数的 <code>Counter</code>，也可能计算结果是非整数。</li>
</ul>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/mlhttg.png" alt="rate 注意点"></p>
<p>另外我们需要注意当把 <code>rate()</code> 与一个聚合运算符（例如 <code>sum()</code>）或一个随时间聚合的函数（任何以 <code>_over_time</code> 结尾的函数）结合起来使用时，总是先取用 <code>rate()</code> 函数，然后再进行聚合，否则，当你的目标重新启动时，<code>rate()</code> 函数无法检测到 Counter 的重置。</p>
<blockquote>
<p><strong>注意</strong>：<code>rate()</code> 函数需要在指定窗口下至少有两个样本才能计算输出。一般来说，比较好的做法是选择范围窗口大小至少是抓取间隔的<code>4</code>倍，这样即使在遇到窗口对齐或抓取故障时也有可以使用的样本进行计算，例如，对于 1 分钟的抓取间隔，你可以使用 4 分钟的 Rate 计算，但是通常将其四舍五入为 5 分钟。所以如果使用 <code>query_range</code> 区间查询，例如在绘图中，那么范围应该至少是步长的大小，否则会丢失一些数据。</p>
</blockquote>
<h2 id="irate"><a href="#irate" class="headerlink" title="irate"></a>irate</h2><p>由于使用 rate 或者 increase 函数去计算样本的平均增长速率，容易陷入<strong>长尾问题</strong>当中，其无法反应在时间窗口内样本数据的突发变化。</p>
<p>例如，对于主机而言在 2 分钟的时间窗口内，可能在某一个由于访问量或者其它问题导致 CPU 占用 100%的情况，但是通过计算在时间窗口内的平均增长率却无法反应出该问题。</p>
<p>为了解决该问题，PromQL 提供了另外一个灵敏度更高的函数<code>irate(v range-vector)</code>。irate 同样用于计算区间向量的计算率，但是其反应出的是<strong>瞬时增长率</strong>。</p>
<p>irate 函数是通过区间向量中最后两个样本数据来计算区间向量的增长速率。这种方式可以避免在时间窗口范围内的<strong>长尾问题</strong>，并且体现出更好的灵敏度，通过 irate 函数绘制的图标能够更好的反应样本数据的瞬时变化状态。那既然是使用最后两个点计算，那为什么还要指定类似于 <code>[1m]</code> 的时间范围呢？这个 <code>[1m]</code> 不是用来计算的，irate 在计算的时候会最多向前在 <code>[1m]</code> 范围内找点，如果超过 <code>[1m]</code> 没有找到数据点，这个点的计算就放弃了。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/q94h15.png" alt="irate"></p>
<p>由于 <code>rate()</code> 提供了更平滑的结果，因此在长期趋势分析或者告警中更推荐使用 rate 函数，因为当速率只出现一个短暂的峰值时，不应该触发该报警。</p>
<p>使用 <code>irate()</code> 函数上面的表达式会出现一些短暂下降的图形：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/mjwavm.png" alt="irate 示例"></p>
<p>除了计算每秒速率，你还可以使用 <code>increase()</code> 函数查询指定时间范围内的总增量，它基本上相当于速率乘以时间范围选择器中的秒数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">increase(demo_api_request_duration_seconds_count&#123;job=&quot;demo&quot;&#125;[1h])</span><br></pre></td></tr></table></figure>



<p>比如上面表达式的结果和使用 <code>rate()</code> 函数计算的结果整体图形趋势都是一样的，只是 Y 轴的数据不一样而已，一个表示数量，一个表示百分比。<code>rate()</code>、<code>irate()</code> 和 <code>increase()</code> 函数只能输出非负值的结果，对于跟踪一个可以上升或下降的值的指标（如温度、内存或磁盘空间），可以使用 <code>delta()</code> 和 <code>deriv()</code> 函数来代替。</p>
<p><code>deriv()</code> 函数可以计算一个区间向量中各个时间序列二阶导数，使用简单线性回归，<code>deriv(v range-vector)</code> 的参数是一个区间向量，返回一个瞬时向量，这个函数一般只用在 Gauge 类型的时间序列上。例如，要计算在 15 分钟的窗口下，每秒钟磁盘使用量上升或下降了多少：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/eylry7.png" alt="deriv 函数"></p>
<p>还有另外一个 <code>predict_linear()</code> 函数可以预测一个 <code>Gauge</code> 类型的指标在未来指定一段时间内的值，例如我们可以根据过去 15 分钟的变化情况，来预测一个小时后的磁盘使用量是多少，可以用如下所示的表达式来查询：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">predict_linear(demo_disk_usage_bytes&#123;job=&quot;demo&quot;&#125;[15m], 3600)</span><br></pre></td></tr></table></figure>



<p><img data-src="https://mudutestmenu.mudu.tv/upload/03wg8r.png" alt="磁盘空间预测"></p>
<p>这个函数可以用于报警，告诉我们磁盘是否会在几个小时候内用完。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/%E5%9F%BA%E4%BA%8E%20Jenkins%E3%80%81Gitlab%E3%80%81Harbor%E3%80%81Helm%20%E5%92%8C%20Kubernetes%20%E7%9A%84%20CICD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/%E5%9F%BA%E4%BA%8E%20Jenkins%E3%80%81Gitlab%E3%80%81Harbor%E3%80%81Helm%20%E5%92%8C%20Kubernetes%20%E7%9A%84%20CICD/" class="post-title-link" itemprop="url">基于 Jenkins、Gitlab、Harbor、Helm 和 Kubernetes 的 CICD</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:13:25" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/Devops/" itemprop="url" rel="index"><span itemprop="name">Devops</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>23k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>21 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="基于-Jenkins、Gitlab、Harbor、Helm-和-Kubernetes-的-CI-CD"><a href="#基于-Jenkins、Gitlab、Harbor、Helm-和-Kubernetes-的-CI-CD" class="headerlink" title="基于 Jenkins、Gitlab、Harbor、Helm 和 Kubernetes 的 CI&#x2F;CD"></a>基于 Jenkins、Gitlab、Harbor、Helm 和 Kubernetes 的 CI&#x2F;CD</h1><p><a target="_blank" rel="noopener" href="https://www.qikqiak.com/post/gitlab-ci-k8s-cluster-feature/">上节课和大家介绍了<code>Gitlab CI</code>结合<code>Kubernetes</code>进行 CI&#x2F;CD 的完整过程</a>。这节课结合前面所学的知识点给大家介绍一个完整的示例：使用 Jenkins + Gitlab + Harbor + Helm + Kubernetes 来实现一个完整的 CI&#x2F;CD 流水线作业。</p>
<p>其实前面的课程中我们就<a target="_blank" rel="noopener" href="https://www.qikqiak.com/post/kubernetes-jenkins1/">已经学习了 Jenkins Pipeline 与 Kubernetes 的完美结合</a>，我们利用 Kubernetes 来动态运行 Jenkins 的 Slave 节点，可以和好的来解决传统的 Jenkins Slave 浪费大量资源的缺点。之前的示例中我们是将项目放置在 Github 仓库上的，将 Docker 镜像推送到了 Docker Hub，这节课我们来结合我们前面学习的知识点来综合运用下，使用 Jenkins、Gitlab、Harbor、Helm、Kubernetes 来实现一个完整的持续集成和持续部署的流水线作业。</p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p>下图是我们当前示例的流程图</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/asuwh2.jpg" alt="ci/cd demo"></p>
<ul>
<li><ol>
<li>开发人员提交代码到 Gitlab 代码仓库</li>
</ol>
</li>
<li><ol>
<li>通过 Gitlab 配置的 Jenkins Webhook 触发 Pipeline 自动构建</li>
</ol>
</li>
<li><ol>
<li>Jenkins 触发构建构建任务，根据 Pipeline 脚本定义分步骤构建</li>
</ol>
</li>
<li><ol>
<li>先进行代码静态分析，单元测试</li>
</ol>
</li>
<li><ol>
<li>然后进行 Maven 构建（Java 项目）</li>
</ol>
</li>
<li><ol>
<li>根据构建结果构建 Docker 镜像</li>
</ol>
</li>
<li><ol>
<li>推送 Docker 镜像到 Harbor 仓库</li>
</ol>
</li>
<li><ol>
<li>触发更新服务阶段，使用 Helm 安装&#x2F;更新 Release</li>
</ol>
</li>
<li><ol>
<li>查看服务是否更新成功。</li>
</ol>
</li>
</ul>
<h2 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h2><p>本次示例项目是一个完整的基于 Spring Boot、Spring Security、JWT、React 和 Ant Design 构建的一个开源的投票应用，项目地址：<a target="_blank" rel="noopener" href="https://github.com/callicoder/spring-security-react-ant-design-polls-app%E3%80%82">https://github.com/callicoder/spring-security-react-ant-design-polls-app。</a></p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/gps51x.jpg" alt="polling app1"></p>
<p>我们将会在该项目的基础上添加部分代码，并实践 CI&#x2F;CD 流程。</p>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p>首先需要更改的是服务端配置，我们需要将数据库链接的配置更改成环境变量的形式，写死了的话就没办法进行定制了，修改服务端文件<code>src/main/resources/application.properties</code>，将下面的数据库配置部分修改成如下形式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.url= jdbc:mysql://$&#123;DB_HOST:localhost&#125;:$&#123;DB_PORT:3306&#125;/$&#123;DB_NAME:polling_app&#125;?useSSL=false&amp;serverTimezone=UTC&amp;useLegacyDatetimeCode=false</span><br><span class="line">spring.datasource.username= $&#123;DB_USER:root&#125;</span><br><span class="line">spring.datasource.password= $&#123;DB_PASSWORD:root&#125;</span><br></pre></td></tr></table></figure>

<p>当环境变量中有上面的数据配置的时候，就会优先使用环境变量中的值，没有的时候就会用默认的值进行数据库配置。</p>
<p>由于我们要将项目部署到 Kubernetes 集群中去，所以我们需要将服务端进行容器化，所以我们在项目根目录下面添加一个<code>Dockerfile</code>文件进行镜像构建：</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> cnych &lt;icnych@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> LANG en_US.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> LANGUAGE en_US:en</span><br><span class="line"><span class="keyword">ENV</span> LC_ALL en_US.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/polls-0.0.1-SNAPSHOT.jar /app/polls.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-Djava.security.egd=file:/dev/./urandom&quot;</span>, <span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/app/polls.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>由于服务端代码是基于<code>Spring Boot</code>构建的，所以我们这里使用一个<code>openjdk</code>的基础镜像，将打包过后的<code>jar</code>包放入镜像之中，然后用过<code>java -jar</code>命令直接启动即可，这里就会存在一个问题了，我们是在 Jenkins 的 Pipeline 中去进行镜像构建的，这个时候项目中并没有打包好的<code>jar</code>包文件，那么我们应该如何获取打包好的<code>jar</code>包文件呢？这里我们可以使用两种方法：</p>
<p>第一种就是如果你用于镜像打包的 Docker 版本大于<code>17.06</code>版本的话，那么我墙裂推荐你使用 Docker 的多阶段构建功能来完成镜像的打包过程，我们只需要将上面的<code>Dockerfile</code>文件稍微更改下即可，将使用<code>maven</code>进行构建的工作放到同一个文件中：</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> maven:<span class="number">3.6</span>-alpine as BUILD</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> src /usr/app/src</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> pom.xml /usr/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> mvn -f /usr/app/pom.xml clean package -Dmaven.test.skip=<span class="literal">true</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> cnych &lt;icnych@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> LANG en_US.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> LANGUAGE en_US:en</span><br><span class="line"><span class="keyword">ENV</span> LC_ALL en_US.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=BUILD /usr/app/target/polls-0.0.1-SNAPSHOT.jar /app/polls.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-Djava.security.egd=file:/dev/./urandom&quot;</span>, <span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/app/polls.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>前面课程中我们就讲解过 Docker 的多阶段构建，这里我们定义了两个阶段，第一个阶段利用<code>maven:3.6-alpine</code>这个基础镜像将我们的项目进行打包，然后将该阶段打包生成的<code>jar</code>包文件复制到第二阶段进行最后的镜像打包，这样就可以很好的完成我们的 Docker 镜像的构建工作。</p>
<p>第二种方式就是我们传统的方式，在 Jenkins Pipeline 中添加一个<code>maven</code>构建的阶段，然后在第二个 Docker 构建的阶段就可以直接获取到前面的<code>jar</code>包了，也可以很方便的完成镜像的构建工作，为了更加清楚的说明 Jenkins Pipeline 的用法，我们这里采用这种方式，所以 Dockerfile 文件还是使用第一个就行。</p>
<p>现在我们可以将服务端的代码推送到 Gitlab 上去，我们这里的仓库地址为：<a target="_blank" rel="noopener" href="http://git.qikqiak.com/course/polling-app-server.git">http://git.qikqiak.com/course/polling-app-server.git</a></p>
<blockquote>
<p>注意，这里我们只推送的服务端代码。</p>
</blockquote>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>客户端我们需要修改 API 的链接地址，修改文件<code>src/constants/index.js</code>中<code>API_BASE_URL</code>的地址，我们同样通过环境变量来进行区分，如果有环境变量<code>APISERVER_URL</code>，则优先使用这个环境变量来作为 API 请求的地址：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable constant_">API_URL</span> = <span class="string">&quot;http://localhost:8080/api&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">APISERVER_URL</span>) &#123;</span><br><span class="line">  <span class="variable constant_">API_URL</span> = <span class="string">`<span class="subst">$&#123;process.env.APISERVER_URL&#125;</span>/api`</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">API_BASE_URL</span> = <span class="variable constant_">API_URL</span>;</span><br></pre></td></tr></table></figure>

<p>因为我们这里的项目使用的就是前后端分离的架构，所以我们同样需要将前端代码进行单独的部署，同样我们要将项目部署到 Kubernetes 环境中，所以也需要做容器化，同样在项目根目录下面添加一个<code>Dockerfile</code>文件：</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx:<span class="number">1.15</span>.<span class="number">10</span>-alpine</span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> build /usr/share/nginx/html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> nginx.conf</span></span><br><span class="line">/etc/nginx/conf.d/default.conf</span><br></pre></td></tr></table></figure>

<p>由于前端页面是单纯的静态页面，所以一般我们使用一个<code>nginx</code>镜像来运行，所以我们提供一个<code>nginx.conf</code>配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    gzip on;</span><br><span class="line"></span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    root   /usr/share/nginx/html;</span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri /index.html;</span><br><span class="line">        expires 1h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们可以看到我们需要将前面页面打包到一个<code>build</code>目录，然后将改目录添加到 nginx 镜像中的<code>/usr/share/nginx/html</code>目录，这样当 nginx 镜像启动的时候就是直接使用的改文件夹下面的文件。</p>
<p>所以现在我们需要获取打包后的目录<code>build</code>，同样的，和上面服务端项目一样，我们可以使用两种方式来完成这个工作。</p>
<p>第一种方式自然是推荐的 Docker 的多阶段构建，我们在一个<code>node</code>镜像的环境中就可以打包我们的前端项目了，所以我们可以更改下<code>Dockerfile</code>文件，先进行 node 打包，然后再进行 nginx 启动：</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:alpine as BUILD</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/src/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /usr/src/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> . /usr/src/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    npm run build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> nginx:<span class="number">1.15</span>.<span class="number">10</span>-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> cnych &lt;icnych@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=BUILD /usr/src/app/build /usr/share/nginx/html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> nginx.conf</span></span><br><span class="line">/etc/nginx/conf.d/default.conf</span><br></pre></td></tr></table></figure>

<p>第二种方式和上面一样在 Jenkins Pipeline 中添加一个打包构建的阶段即可，我们这里采用这种方式，所以 Dockerfile 文件还是使用第一个就行。</p>
<p>现在我们可以将客户端的代码推送到 Gitlab 上去，我们这里的仓库地址为：<a target="_blank" rel="noopener" href="http://git.qikqiak.com/course/polling-app-client.git">http://git.qikqiak.com/course/polling-app-client.git</a></p>
<h2 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h2><p>现在项目准备好了，接下来我们可以开始 Jenkins 的配置，还记得前面在 Pipeline 结合 Kubernetes 的课程中我们使用了一个<code>kubernetes</code>的 Jenkins 插件，但是之前使用的方式有一些不妥的地方，我们 Jenkins Pipeline 构建任务绑定到了一个固定的 Slave Pod 上面，这样就需要我们的 Slave Pod 中必须包含一系列构建所需要的依赖，比如 docker、maven、node、java 等等，这样就难免需要我们自己定义一个很庞大的 Slave 镜像，我们直接直接在 Pipeline 中去自定义 Slave Pod 中所需要用到的容器模板，这样我们需要什么镜像只需要在 Slave Pod Template 中声明即可，完全不需要去定义一个庞大的 Slave 镜像了。</p>
<p>首先去掉 Jenkins 中 kubernetes 插件中的 Pod Template 的定义，Jenkins -&gt; 系统管理 -&gt; 系统设置 -&gt; 云 -&gt; Kubernetes 区域，删除下方的<code>Kubernetes Pod Template</code> -&gt; 保存。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/mgvywr.jpg" alt="jenkins kubernetes plugin"></p>
<p>然后新建一个名为<code>polling-app-server</code>类型为<code>流水线(Pipeline)</code>的任务：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/q0sszq.jpg" alt="new pipeline task"></p>
<p>然后在这里需要勾选<code>触发远程构建</code>的触发器，其中令牌我们可以随便写一个字符串，然后记住下面的 URL，将 JENKINS_URL 替换成 Jenkins 的地址,我们这里的地址就是：<code>http://jenkins.qikqiak.com/job/polling-app-server/build?token=server321</code></p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/97bafe.jpg" alt="trigger"></p>
<p>然后在下面的<code>流水线</code>区域我们可以选择<code>Pipeline script</code>然后在下面测试流水线脚本，我们这里选择<code>Pipeline script from SCM</code>，意思就是从代码仓库中通过<code>Jenkinsfile</code>文件获取<code>Pipeline script</code>脚本定义，然后选择 SCM 来源为<code>Git</code>，在出现的列表中配置上仓库地址<code>http://git.qikqiak.com/course/polling-app-server.git</code>，由于我们是在一个 Slave Pod 中去进行构建，所以如果使用 SSH 的方式去访问 Gitlab 代码仓库的话就需要频繁的去更新 SSH-KEY，所以我们这里采用直接使用用户名和密码的形式来方式：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/okhb8t.jpg" alt="pipeline scm"></p>
<p>在<code>Credentials</code>区域点击<code>添加</code>按钮添加我们访问 Gitlab 的用户名和密码：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/6pnehi.jpg" alt="gitlab auth"></p>
<p>然后需要我们配置用于构建的分支，如果所有的分支我们都想要进行构建的话，只需要将<code>Branch Specifier</code>区域留空即可，一般情况下不同的环境对应的分支才需要构建，比如 master、develop、test 等，平时开发的 feature 或者 bugfix 的分支没必要频繁构建，我们这里就只配置 master 和 develop 两个分支用户构建：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/ldka7t.jpg" alt="gitlab branch config"></p>
<p>然后前往 Gitlab 中配置项目<code>polling-app-server</code> Webhook，settings -&gt; Integrations，填写上面得到的 trigger 地址：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/x48fhk.jpg" alt="webhook"></p>
<p>保存后，可以直接点击<code>Test</code> -&gt; <code>Push Event</code>测试是否可以正常访问 Webhook 地址，这里需要注意的是我们需要配置下 Jenkins 的安全配置，否则这里的触发器没权限访问 Jenkins，系统管理 -&gt; 全局安全配置：取消<code>防止跨站点请求伪造</code>，勾选上<code>匿名用户具有可读权限</code>：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/klrcrw.jpg" alt="security config"></p>
<p>如果测试出现了<code>Hook executed successfully: HTTP 201</code>则证明 Webhook 配置成功了，否则就需要检查下 Jenkins 的安全配置是否正确了。</p>
<p>配置成功后我们只需要往 Gitlab 仓库推送代码就会触发 Pipeline 构建了。接下来我们直接在服务端代码仓库根目录下面添加<code>Jenkinsfile</code>文件，用于描述流水线构建流程。</p>
<p>首先定义最简单的流程，要注意这里和前面课程的不同之处，这里我们使用<code>podTemplate</code>来定义不同阶段使用的的容器，有哪些阶段呢？</p>
<p>Clone 代码 -&gt; 代码静态分析 -&gt; 单元测试 -&gt; Maven 打包 -&gt; Docker 镜像构建&#x2F;推送 -&gt; Helm 更新服务。</p>
<p>Clone 代码在默认的 Slave 容器中即可；静态分析和单元测试我们这里直接忽略，有需要这个阶段的同学自己添加上即可；Maven 打包肯定就需要 Maven 的容器了；Docker 镜像构建&#x2F;推送是不是就需要 Docker 环境了呀；最后的 Helm 更新服务是不是就需要一个有 Helm 的容器环境了，所以我们这里就可以很简单的定义<code>podTemplate</code>了，如下定义：(添加一个<code>kubectl</code>工具用于测试)</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> label = <span class="string">&quot;slave-$&#123;UUID.randomUUID().toString()&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">podTemplate(<span class="attr">label:</span> label, <span class="attr">containers:</span> [</span><br><span class="line">  containerTemplate(<span class="attr">name:</span> <span class="string">&#x27;maven&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;maven:3.6-alpine&#x27;</span>, <span class="attr">command:</span> <span class="string">&#x27;cat&#x27;</span>, <span class="attr">ttyEnabled:</span> <span class="literal">true</span>),</span><br><span class="line">  containerTemplate(<span class="attr">name:</span> <span class="string">&#x27;docker&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;docker&#x27;</span>, <span class="attr">command:</span> <span class="string">&#x27;cat&#x27;</span>, <span class="attr">ttyEnabled:</span> <span class="literal">true</span>),</span><br><span class="line">  containerTemplate(<span class="attr">name:</span> <span class="string">&#x27;kubectl&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;cnych/kubectl&#x27;</span>, <span class="attr">command:</span> <span class="string">&#x27;cat&#x27;</span>, <span class="attr">ttyEnabled:</span> <span class="literal">true</span>),</span><br><span class="line">  containerTemplate(<span class="attr">name:</span> <span class="string">&#x27;helm&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;cnych/helm&#x27;</span>, <span class="attr">command:</span> <span class="string">&#x27;cat&#x27;</span>, <span class="attr">ttyEnabled:</span> <span class="literal">true</span>)</span><br><span class="line">], <span class="attr">volumes:</span> [</span><br><span class="line">  hostPathVolume(<span class="attr">mountPath:</span> <span class="string">&#x27;/root/.m2&#x27;</span>, <span class="attr">hostPath:</span> <span class="string">&#x27;/var/run/m2&#x27;</span>),</span><br><span class="line">  hostPathVolume(<span class="attr">mountPath:</span> <span class="string">&#x27;/home/jenkins/.kube&#x27;</span>, <span class="attr">hostPath:</span> <span class="string">&#x27;/root/.kube&#x27;</span>),</span><br><span class="line">  hostPathVolume(<span class="attr">mountPath:</span> <span class="string">&#x27;/var/run/docker.sock&#x27;</span>, <span class="attr">hostPath:</span> <span class="string">&#x27;/var/run/docker.sock&#x27;</span>)</span><br><span class="line">]) &#123;</span><br><span class="line">  node(label) &#123;</span><br><span class="line">    <span class="keyword">def</span> myRepo = checkout scm</span><br><span class="line">    <span class="keyword">def</span> gitCommit = myRepo.GIT_COMMIT</span><br><span class="line">    <span class="keyword">def</span> gitBranch = myRepo.GIT_BRANCH</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;单元测试&#x27;</span>) &#123;</span><br><span class="line">      echo <span class="string">&quot;测试阶段&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;代码编译打包&#x27;</span>) &#123;</span><br><span class="line">      container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">        echo <span class="string">&quot;打码编译打包阶段&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;构建 Docker 镜像&#x27;</span>) &#123;</span><br><span class="line">      container(<span class="string">&#x27;docker&#x27;</span>) &#123;</span><br><span class="line">        echo <span class="string">&quot;构建 Docker 镜像阶段&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;运行 Kubectl&#x27;</span>) &#123;</span><br><span class="line">      container(<span class="string">&#x27;kubectl&#x27;</span>) &#123;</span><br><span class="line">        echo <span class="string">&quot;查看 K8S 集群 Pod 列表&quot;</span></span><br><span class="line">        sh <span class="string">&quot;kubectl get pods&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;运行 Helm&#x27;</span>) &#123;</span><br><span class="line">      container(<span class="string">&#x27;helm&#x27;</span>) &#123;</span><br><span class="line">        echo <span class="string">&quot;查看 Helm Release 列表&quot;</span></span><br><span class="line">        sh <span class="string">&quot;helm list&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这段<code>groovy</code>脚本比较简单，我们需要注意的是<code>volumes</code>区域的定义，将容器中的<code>/root/.m2</code>目录挂载到宿主机上是为了给<code>Maven</code>构建添加缓存的，不然每次构建的时候都需要去重新下载依赖，这样就非常慢了；挂载<code>.kube</code>目录是为了能够让<code>kubectl</code>和<code>helm</code>两个工具可以读取到 Kubernetes 集群的连接信息，不然我们是没办法访问到集群的；最后挂载<code>/var/run/docker.sock</code>文件是为了能够让我们的<code>docker</code>这个容器获取到<code>Docker Daemon</code>的信息的，因为<code>docker</code>这个镜像里面只有客户端的二进制文件，我们需要使用宿主机的<code>Docker Daemon</code>来构建镜像，当然我们也需要在运行 Slave Pod 的节点上拥有访问集群的文件，然后在每个<code>Stage</code>阶段使用特定需要的容器来进行任务的描述即可，所以这几个<code>volumes</code>都是非常重要的</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span> [</span><br><span class="line">  hostPathVolume(<span class="attr">mountPath:</span> <span class="string">&#x27;/root/.m2&#x27;</span>, <span class="attr">hostPath:</span> <span class="string">&#x27;/var/run/m2&#x27;</span>),</span><br><span class="line">  hostPathVolume(<span class="attr">mountPath:</span> <span class="string">&#x27;/home/jenkins/.kube&#x27;</span>, <span class="attr">hostPath:</span> <span class="string">&#x27;/root/.kube&#x27;</span>),</span><br><span class="line">  hostPathVolume(<span class="attr">mountPath:</span> <span class="string">&#x27;/var/run/docker.sock&#x27;</span>, <span class="attr">hostPath:</span> <span class="string">&#x27;/var/run/docker.sock&#x27;</span>)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>另外一个值得注意的就是<code>label</code>标签的定义，我们这里使用 UUID 生成一个随机的字符串，这样可以让 Slave Pod 每次的名称都不一样，而且这样就不会被固定在一个 Pod 上面了，以后有多个构建任务的时候就不会存在等待的情况了，这和我们之前的课程中讲到的固定在一个 label 标签上有所不同。</p>
<p>然后我们将上面的<code>Jenkinsfile</code>文件提交到 Gitlab 代码仓库上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add Jenkinsfile</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit -m <span class="string">&quot;添加 Jenkinsfile 文件&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git push origin master</span></span><br></pre></td></tr></table></figure>

<p>然后切换到 Jenkins 页面上，正常情况就可以看到我们的流水线任务<code>polling-app-server</code>已经被触发构建了，然后回到我们的 Kubernetes 集群中可以看到多了一个 slave 开头的 Pod，里面有 5 个容器，就是我们上面 podTemplate 中定义的 4 个容器，加上一个默认的 jenkins slave 容器，同样的，构建任务完成后，这个 Pod 也会被自动销毁掉：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods -n kube-ops</span></span><br><span class="line">NAME                                                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">jenkins-7fbfcc5ddc-xsqmt                                  1/1       Running   0          1d</span><br><span class="line">slave-6e898009-62a2-4798-948f-9c80c3de419b-0jwml-6t6hb   5/5       Running   0          36s</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>正常可以看到 Jenkins 中的任务构建成功了：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/k4xfxg.jpg" alt="build successfully"></p>
<h2 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h2><p>第一个阶段：单元测试，我们可以在这个阶段是运行一些单元测试或者静态代码分析的脚本，我们这里直接忽略。</p>
<p>第二个阶段：代码编译打包，我们可以看到我们是在一个<code>maven</code>的容器中来执行的，所以我们只需要在该容器中获取到代码，然后在代码目录下面执行 maven 打包命令即可，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;代码编译打包&#x27;</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">      echo <span class="string">&quot;2. 代码编译打包阶段&quot;</span></span><br><span class="line">      sh <span class="string">&quot;mvn clean package -Dmaven.test.skip=true&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (exc) &#123;</span><br><span class="line">    println <span class="string">&quot;构建失败 - $&#123;currentBuild.fullDisplayName&#125;&quot;</span></span><br><span class="line">    <span class="keyword">throw</span>(exc)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三个阶段：构建 Docker 镜像，要构建 Docker 镜像，就需要提供镜像的名称和 tag，要推送到 Harbor 仓库，就需要提供登录的用户名和密码，所以我们这里使用到了<code>withCredentials</code>方法，在里面可以提供一个<code>credentialsId</code>为<code>dockerhub</code>的认证信息，如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;构建 Docker 镜像&#x27;</span>) &#123;</span><br><span class="line">  withCredentials([[<span class="attr">$class:</span> <span class="string">&#x27;UsernamePasswordMultiBinding&#x27;</span>,</span><br><span class="line">    <span class="symbol">credentialsId:</span> <span class="string">&#x27;dockerhub&#x27;</span>,</span><br><span class="line">    <span class="symbol">usernameVariable:</span> <span class="string">&#x27;DOCKER_HUB_USER&#x27;</span>,</span><br><span class="line">    <span class="symbol">passwordVariable:</span> <span class="string">&#x27;DOCKER_HUB_PASSWORD&#x27;</span>]]) &#123;</span><br><span class="line">      container(<span class="string">&#x27;docker&#x27;</span>) &#123;</span><br><span class="line">        echo <span class="string">&quot;3. 构建 Docker 镜像阶段&quot;</span></span><br><span class="line">        sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">          docker login $&#123;dockerRegistryUrl&#125; -u $&#123;DOCKER_HUB_USER&#125; -p $&#123;DOCKER_HUB_PASSWORD&#125;</span></span><br><span class="line"><span class="string">          docker build -t $&#123;image&#125;:$&#123;imageTag&#125; .</span></span><br><span class="line"><span class="string">          docker push $&#123;image&#125;:$&#123;imageTag&#125;</span></span><br><span class="line"><span class="string">          &quot;&quot;&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 ${image} 和 ${imageTag} 我们可以在上面定义成全局变量：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> imageTag = sh(<span class="attr">script:</span> <span class="string">&quot;git rev-parse --short HEAD&quot;</span>, <span class="attr">returnStdout:</span> <span class="literal">true</span>).trim()</span><br><span class="line"><span class="keyword">def</span> dockerRegistryUrl = <span class="string">&quot;registry.qikqiak.com&quot;</span></span><br><span class="line"><span class="keyword">def</span> imageEndpoint = <span class="string">&quot;course/polling-app-server&quot;</span></span><br><span class="line"><span class="keyword">def</span> image = <span class="string">&quot;$&#123;dockerRegistryUrl&#125;/$&#123;imageEndpoint&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>docker 的用户名和密码信息则需要通过<code>凭据</code>来进行添加，进入 jenkins 首页 -&gt; 左侧菜单<code>凭据</code> -&gt; <code>添加凭据</code>，选择用户名和密码类型的，其中 ID 一定要和上面的<code>credentialsId</code>的值保持一致：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/vzchpe.jpg" alt="add docker hub credential"></p>
<p>第四个阶段：运行 kubectl 工具，其实在我们当前使用的流水线中是用不到 kubectl 工具的，那么为什么我们这里要使用呢？这还不是因为我们暂时还没有去写应用的 Helm Chart 包吗？所以我们先去用原始的 YAML 文件来编写应用部署的资源清单文件，这也是我们写出 Chart 包前提，因为只有知道了应用如何部署才可能知道 Chart 包如何编写，所以我们先编写应用部署资源清单。</p>
<p>首先当然就是 Deployment 控制器了，如下所示：（k8s.yaml）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">polling-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">course</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">polling-server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">polling-server</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myreg</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">&lt;IMAGE&gt;:&lt;IMAGE_TAG&gt;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">polling-server</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">api</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_HOST</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">mysql</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PORT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;3306&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">polling_app</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_USER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">polling</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">polling321</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">polling-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">course</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">polling-server</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">api-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">api</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">course</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">dbport</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">rootPassW0rd</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_DATABASE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">polling_app</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_USER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">polling</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">polling321</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">course</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dbport</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">dbport</span></span><br></pre></td></tr></table></figure>

<p>可以看到我们上面的 YAML 文件中添加使用的镜像是用标签代替的：<code>&lt;IMAGE&gt;:&lt;IMAGE_TAG&gt;</code>，这是因为我们的镜像地址是动态的，下依赖我们在上一个阶段打包出来的镜像地址的，所以我们这里用标签代替，然后将标签替换成真正的值即可，另外为了保证应用的稳定性，我们还在应用中添加了健康检查，所以需要在代码中添加一个健康检查的 Controller：（src&#x2F;main&#x2F;java&#x2F;com&#x2F;example&#x2F;polls&#x2F;controller&#x2F;StatusController.java）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.polls.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/_status/healthz&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StatusController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">healthCheck</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;UP&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后就是环境变量了，还记得前面我们更改了资源文件中数据库的配置吗？（src&#x2F;main&#x2F;resources&#x2F;application.properties）因为要尽量通用，我们在部署应用的时候很有可能已经有一个外部的数据库服务了，所以这个时候通过环境变量传入进来即可。另外由于我们这里使用的是私有镜像仓库，所以需要在集群中提前创建一个对应的 Secret 对象：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl create secret docker-registry myreg --docker-server=registry.qikqiak.com --docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD --docker-email=DOCKER_EMAIL --namespace course</span></span><br></pre></td></tr></table></figure>

<p>在代码根目录下面创建一个 manifests 的目录，用来存放上面的资源清单文件，正常来说是不是我们只需要在镜像构建成功后，将上面的 k8s.yaml 文件中的镜像标签替换掉就 OK，所以这一步的动作如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;运行 Kubectl&#x27;</span>) &#123;</span><br><span class="line">  container(<span class="string">&#x27;kubectl&#x27;</span>) &#123;</span><br><span class="line">    echo <span class="string">&quot;查看 K8S 集群 Pod 列表&quot;</span></span><br><span class="line">    sh <span class="string">&quot;kubectl get pods&quot;</span></span><br><span class="line">    sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">      sed -i &quot;s/&lt;IMAGE&gt;/$&#123;image&#125;&quot; manifests/k8s.yaml</span></span><br><span class="line"><span class="string">      sed -i &quot;s/&lt;IMAGE_TAG&gt;/$&#123;imageTag&#125;&quot; manifests/k8s.yaml</span></span><br><span class="line"><span class="string">      kubectl apply -f k8s.yaml</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第五阶段：运行 Helm 工具，就是直接使用 Helm 来部署应用了，现在有了上面的基本的资源对象了，要创建 Chart 模板就相对容易了，Chart 模板仓库地址：<a target="_blank" rel="noopener" href="https://github.com/cnych/polling-helm%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E6%A0%B9%E6%8D%AE%60values.yaml%60%E6%96%87%E4%BB%B6%E6%9D%A5%E8%BF%9B%E8%A1%8C%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%89%E8%A3%85%EF%BC%8C%E6%A8%A1%E6%9D%BF%E4%B8%AD%E6%88%91%E4%BB%AC%E5%AE%9A%E4%B9%89%E4%BA%86%E5%8F%AF%E4%BB%A5%E6%8C%87%E5%AE%9A%E4%BD%BF%E7%94%A8%E5%A4%96%E9%83%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1%E6%88%96%E8%80%85%E5%86%85%E9%83%A8%E7%8B%AC%E7%AB%8B%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%85%B7%E4%BD%93%E7%9A%84%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%8E%BB%E7%9C%8B%E6%A8%A1%E6%9D%BF%E4%B8%AD%E7%9A%84%E5%AE%9A%E4%B9%89%E3%80%82%E9%A6%96%E5%85%88%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%85%88%E4%BD%BF%E7%94%A8%E8%BF%99%E4%B8%AA%E6%A8%A1%E6%9D%BF%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD%E6%9D%A5%E6%B5%8B%E8%AF%95%E4%B8%8B%E3%80%82%E9%A6%96%E5%85%88%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD">https://github.com/cnych/polling-helm，我们可以根据`values.yaml`文件来进行自定义安装，模板中我们定义了可以指定使用外部数据库服务或者内部独立的数据库服务，具体的我们可以去看模板中的定义。首先我们可以先使用这个模板在集群中来测试下。首先在集群中</a> Clone 上面的 Chart 模板：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/cnych/polling-helm.git</span></span><br></pre></td></tr></table></figure>

<p>然后我们使用内部的数据库服务，新建一个 custom.yaml 文件来覆盖 values.yaml 文件中的值：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">persistence:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">    <span class="attr">database:</span></span><br><span class="line">      <span class="attr">storageClass:</span> <span class="string">&quot;database&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">database:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">internal</span></span><br><span class="line">  <span class="attr">internal:</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">&quot;polling&quot;</span></span><br><span class="line">    <span class="comment"># 数据库用户</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">&quot;polling&quot;</span></span><br><span class="line">    <span class="comment"># 数据库用户密码</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&quot;polling321&quot;</span></span><br></pre></td></tr></table></figure>

<p>可以看到我们这里使用了一个名为<code>database</code>的 StorgeClass 对象，所以还得创建先创建这个资源对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">database</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span></span><br></pre></td></tr></table></figure>

<p>然后我们就可以在 Chart 根目录下面安装应用，执行下面的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm upgrade --install polling -f custom.yaml . --namespace course</span></span><br><span class="line">Release &quot;polling&quot; does not exist. Installing it now.</span><br><span class="line">NAME:   polling</span><br><span class="line">LAST DEPLOYED: Sat May  4 23:31:42 2019</span><br><span class="line">NAMESPACE: course</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/Pod(related)</span><br><span class="line">NAME                                  READY  STATUS             RESTARTS  AGE</span><br><span class="line">polling-polling-api-6b699478d6-lqwhw  0/1    ContainerCreating  0         0s</span><br><span class="line">polling-polling-ui-587bbfb7b5-xr2ff   0/1    ContainerCreating  0         0s</span><br><span class="line">polling-polling-database-0            0/1    Pending            0         0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Secret</span><br><span class="line">NAME                      TYPE    DATA  AGE</span><br><span class="line">polling-polling-database  Opaque  1     0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Service</span><br><span class="line">NAME                      TYPE       CLUSTER-IP     EXTERNAL-IP  PORT(S)   AGE</span><br><span class="line">polling-polling-api       ClusterIP  10.109.19.220  &lt;none&gt;       8080/TCP  0s</span><br><span class="line">polling-polling-database  ClusterIP  10.98.136.190  &lt;none&gt;       3306/TCP  0s</span><br><span class="line">polling-polling-ui        ClusterIP  10.108.170.43  &lt;none&gt;       80/TCP    0s</span><br><span class="line"></span><br><span class="line">==&gt; v1beta2/Deployment</span><br><span class="line">NAME                 DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE</span><br><span class="line">polling-polling-api  1        1        1           0          0s</span><br><span class="line">polling-polling-ui   1        1        1           0          0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/StatefulSet</span><br><span class="line">NAME                      DESIRED  CURRENT  AGE</span><br><span class="line">polling-polling-database  1        1        0s</span><br><span class="line"></span><br><span class="line">==&gt; v1beta1/Ingress</span><br><span class="line">NAME                     HOSTS              ADDRESS  PORTS  AGE</span><br><span class="line">polling-polling-ingress  ui.polling.domain  80       0s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line">1. Get the application URL by running these commands:</span><br><span class="line">  http://ui.polling.domain</span><br><span class="line"></span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意我们这里安装也是使用的<code>helm upgrade</code>命令，这样有助于安装和更新的时候命令统一。</p>
</blockquote>
<p>安装完成后，查看下 Pod 的运行状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods -n course</span></span><br><span class="line">NAME                                   READY     STATUS    RESTARTS   AGE</span><br><span class="line">polling-polling-api-6b699478d6-lqwhw   1/1       Running   0          3m</span><br><span class="line">polling-polling-database-0             1/1       Running   0          3m</span><br><span class="line">polling-polling-ui-587bbfb7b5-xr2ff    1/1       Running   0          3m</span><br></pre></td></tr></table></figure>

<p>然后我们可以在本地<code>/etc/hosts</code>里面加上<code>http://ui.polling.domain</code>的的映射，这样我们就可以通过这个域名来访问我们安装的应用了，可以注册、登录、发表投票内容了：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/iqklnk.png" alt="polling app"></p>
<p>这样我们就完成了使用 Helm Chart 安装应用的过程，但是现在我们使用的包还是直接使用的 git 仓库中的，平常我们正常安装的时候都是使用的 Chart 仓库中的包，所以我们需要将该 Chart 包上传到一个仓库中去，比较幸运的是我们的 Harbor 也是支持 Helm Chart 包的。我们可以选择手动通过 Harbor 的 Dashboard 将 Chart 包进行上传，也可以通过使用<code>Helm Push</code>插件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm plugin install https://github.com/chartmuseum/helm-push</span></span><br><span class="line">Downloading and installing helm-push v0.7.1 ...</span><br><span class="line">https://github.com/chartmuseum/helm-push/releases/download/v0.7.1/helm-push_0.7.1_linux_amd64.tar.gz</span><br><span class="line"></span><br><span class="line">Installed plugin: push</span><br></pre></td></tr></table></figure>

<p>当然我们需要首先将 Harbor 提供的仓库添加到 helm repo 中，由于是私有仓库，所以在添加的时候我们需要添加用户名和密码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm repo add course https://registry.qikqiak.com/chartrepo/course --username=&lt;harbor用户名&gt; --password=&lt;harbor密码&gt;</span></span><br><span class="line">&quot;course&quot; has been added to your repositories</span><br></pre></td></tr></table></figure>

<p>这里的 repo 的地址是<code>&lt;Harbor URL&gt;/chartrepo/&lt;Harbor中项目名称&gt;</code>，Harbor 中每个项目是分开的 repo，如果不提供项目名称，则默认使用<code>library</code>这个项目。</p>
<blockquote>
<p>需要注意的是如果你的 Harbor 是采用的自建的 https 证书，这里就需要提供 ca 证书和私钥文件了，否则会出现证书校验失败的错误<code>x509: certificate signed by unknown authority</code>。我们这里是通过<code>cert-manager</code>为 Harbor 提供的一个信任的 https 证书，所以没有指定 ca 证书相关的参数。</p>
</blockquote>
<p>然后我们将上面的<code>polling-helm</code>这个 Chart 包上传到 Harbor 仓库中去：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm push polling-helm course</span></span><br><span class="line">Pushing polling-0.1.0.tgz to course...</span><br><span class="line">Done.</span><br></pre></td></tr></table></figure>

<p>这个时候我们登录的 Harbor 仓库中去，查看 course 这个项目下面的<code>Helm Charts</code>就可以发现多了一个 polling 的应用了：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/luic4t.png" alt="helm chart"></p>
<p>我们也可以在右下角看到有添加仓库和安装 Chart 的相关命令。</p>
<p>到这里 Helm 相关的工作就准备好了。那么我们如何在 Jenkins Pipeline 中去使用 Helm 呢？我们可以回顾下，我们平时的一个 CI&#x2F;CD 的流程：开发代码 -&gt; 提交代码 -&gt; 触发镜像构建 -&gt; 修改镜像 tag -&gt; 推送到镜像仓库中去 -&gt; 然后更改 YAML 文件镜像版本 -&gt; 使用 kubectl 工具更新应用。</p>
<p>现在我们是不是直接使用 Helm 了，就不需要去手动更改 YAML 文件了，也不需要使用 kubectl 工具来更新应用了，而是只需要去覆盖下 helm 中的镜像版本，直接 upgrade 是不是就可以达到应用更新的结果了。我们可以去查看下 chart 包的 values.yaml 文件中关于 api 服务的定义：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">api:</span></span><br><span class="line">  <span class="attr">image:</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">cnych/polling-api</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="number">0.0</span><span class="number">.7</span></span><br><span class="line">    <span class="attr">pullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure>

<p>我们是不是只需要将上面关于 api 服务使用的镜像用我们这里 Jenkins 构建后的替换掉就可以了，这样我们更改上面的最后<code>运行 Helm</code>的阶段如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;运行 Helm&#x27;</span>) &#123;</span><br><span class="line">  container(<span class="string">&#x27;helm&#x27;</span>) &#123;</span><br><span class="line">    echo <span class="string">&quot;更新 polling 应用&quot;</span></span><br><span class="line">    sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">      helm upgrade --install polling polling --set persistence.persistentVolumeClaim.database.storageClass=database --set database.type=internal --set database.internal.database=polling --set database.internal.username=polling --set database.internal.password=polling321 --set api.image.repository=$&#123;image&#125; --set api.image.tag=$&#123;imageTag&#125; --set imagePullSecrets[0].name=myreg --namespace course</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然我们可以将需要更改的值都放入一个 YAML 之中来进行修改，我们这里通过<code>--set</code>来覆盖对应的值，这样整个 API 服务的完整 Jenkinsfile 文件如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> label = <span class="string">&quot;slave-$&#123;UUID.randomUUID().toString()&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> helmLint(String chartDir) &#123;</span><br><span class="line">    println <span class="string">&quot;校验 chart 模板&quot;</span></span><br><span class="line">    sh <span class="string">&quot;helm lint $&#123;chartDir&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> helmInit() &#123;</span><br><span class="line">  println <span class="string">&quot;初始化 helm client&quot;</span></span><br><span class="line">  sh <span class="string">&quot;helm init --client-only --stable-repo-url https://mirror.azure.cn/kubernetes/charts/&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> helmRepo(Map args) &#123;</span><br><span class="line">  println <span class="string">&quot;添加 course repo&quot;</span></span><br><span class="line">  sh <span class="string">&quot;helm repo add --username $&#123;args.username&#125; --password $&#123;args.password&#125; course https://registry.qikqiak.com/chartrepo/course&quot;</span></span><br><span class="line"></span><br><span class="line">  println <span class="string">&quot;更新 repo&quot;</span></span><br><span class="line">  sh <span class="string">&quot;helm repo update&quot;</span></span><br><span class="line"></span><br><span class="line">  println <span class="string">&quot;获取 Chart 包&quot;</span></span><br><span class="line">  sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    helm fetch course/polling</span></span><br><span class="line"><span class="string">    tar -xzvf polling-0.1.0.tgz</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> helmDeploy(Map args) &#123;</span><br><span class="line">    helmInit()</span><br><span class="line">    helmRepo(args)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (args.dry_run) &#123;</span><br><span class="line">        println <span class="string">&quot;Debug 应用&quot;</span></span><br><span class="line">        sh <span class="string">&quot;helm upgrade --dry-run --debug --install $&#123;args.name&#125; $&#123;args.chartDir&#125; --set persistence.persistentVolumeClaim.database.storageClass=database --set api.image.repository=$&#123;args.image&#125; --set api.image.tag=$&#123;args.tag&#125; --set imagePullSecrets[0].name=myreg --namespace=$&#123;args.namespace&#125;&quot;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        println <span class="string">&quot;部署应用&quot;</span></span><br><span class="line">        sh <span class="string">&quot;helm upgrade --install $&#123;args.name&#125; $&#123;args.chartDir&#125; --set persistence.persistentVolumeClaim.database.storageClass=database --set api.image.repository=$&#123;args.image&#125; --set api.image.tag=$&#123;args.tag&#125; --set imagePullSecrets[0].name=myreg --namespace=$&#123;args.namespace&#125;&quot;</span></span><br><span class="line">        echo <span class="string">&quot;应用 $&#123;args.name&#125; 部署成功. 可以使用 helm status $&#123;args.name&#125; 查看应用状态&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">podTemplate(<span class="attr">label:</span> label, <span class="attr">containers:</span> [</span><br><span class="line">  containerTemplate(<span class="attr">name:</span> <span class="string">&#x27;maven&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;maven:3.6-alpine&#x27;</span>, <span class="attr">command:</span> <span class="string">&#x27;cat&#x27;</span>, <span class="attr">ttyEnabled:</span> <span class="literal">true</span>),</span><br><span class="line">  containerTemplate(<span class="attr">name:</span> <span class="string">&#x27;docker&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;docker&#x27;</span>, <span class="attr">command:</span> <span class="string">&#x27;cat&#x27;</span>, <span class="attr">ttyEnabled:</span> <span class="literal">true</span>),</span><br><span class="line">  containerTemplate(<span class="attr">name:</span> <span class="string">&#x27;helm&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;cnych/helm&#x27;</span>, <span class="attr">command:</span> <span class="string">&#x27;cat&#x27;</span>, <span class="attr">ttyEnabled:</span> <span class="literal">true</span>)</span><br><span class="line">], <span class="attr">volumes:</span> [</span><br><span class="line">  hostPathVolume(<span class="attr">mountPath:</span> <span class="string">&#x27;/root/.m2&#x27;</span>, <span class="attr">hostPath:</span> <span class="string">&#x27;/var/run/m2&#x27;</span>),</span><br><span class="line">  hostPathVolume(<span class="attr">mountPath:</span> <span class="string">&#x27;/home/jenkins/.kube&#x27;</span>, <span class="attr">hostPath:</span> <span class="string">&#x27;/root/.kube&#x27;</span>),</span><br><span class="line">  hostPathVolume(<span class="attr">mountPath:</span> <span class="string">&#x27;/var/run/docker.sock&#x27;</span>, <span class="attr">hostPath:</span> <span class="string">&#x27;/var/run/docker.sock&#x27;</span>)</span><br><span class="line">]) &#123;</span><br><span class="line">  node(label) &#123;</span><br><span class="line">    <span class="keyword">def</span> myRepo = checkout scm</span><br><span class="line">    <span class="keyword">def</span> gitCommit = myRepo.GIT_COMMIT</span><br><span class="line">    <span class="keyword">def</span> gitBranch = myRepo.GIT_BRANCH</span><br><span class="line">    <span class="keyword">def</span> imageTag = sh(<span class="attr">script:</span> <span class="string">&quot;git rev-parse --short HEAD&quot;</span>, <span class="attr">returnStdout:</span> <span class="literal">true</span>).trim()</span><br><span class="line">    <span class="keyword">def</span> dockerRegistryUrl = <span class="string">&quot;registry.qikqiak.com&quot;</span></span><br><span class="line">    <span class="keyword">def</span> imageEndpoint = <span class="string">&quot;course/polling-api&quot;</span></span><br><span class="line">    <span class="keyword">def</span> image = <span class="string">&quot;$&#123;dockerRegistryUrl&#125;/$&#123;imageEndpoint&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;单元测试&#x27;</span>) &#123;</span><br><span class="line">      echo <span class="string">&quot;1.测试阶段&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;代码编译打包&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">          echo <span class="string">&quot;2. 代码编译打包阶段&quot;</span></span><br><span class="line">          sh <span class="string">&quot;mvn clean package -Dmaven.test.skip=true&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (exc) &#123;</span><br><span class="line">        println <span class="string">&quot;构建失败 - $&#123;currentBuild.fullDisplayName&#125;&quot;</span></span><br><span class="line">        <span class="keyword">throw</span>(exc)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;构建 Docker 镜像&#x27;</span>) &#123;</span><br><span class="line">      withCredentials([[<span class="attr">$class:</span> <span class="string">&#x27;UsernamePasswordMultiBinding&#x27;</span>,</span><br><span class="line">        <span class="symbol">credentialsId:</span> <span class="string">&#x27;dockerhub&#x27;</span>,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;DOCKER_HUB_USER&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;DOCKER_HUB_PASSWORD&#x27;</span>]]) &#123;</span><br><span class="line">          container(<span class="string">&#x27;docker&#x27;</span>) &#123;</span><br><span class="line">            echo <span class="string">&quot;3. 构建 Docker 镜像阶段&quot;</span></span><br><span class="line">            sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">              docker login $&#123;dockerRegistryUrl&#125; -u $&#123;DOCKER_HUB_USER&#125; -p $&#123;DOCKER_HUB_PASSWORD&#125;</span></span><br><span class="line"><span class="string">              docker build -t $&#123;image&#125;:$&#123;imageTag&#125; .</span></span><br><span class="line"><span class="string">              docker push $&#123;image&#125;:$&#123;imageTag&#125;</span></span><br><span class="line"><span class="string">              &quot;&quot;&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;运行 Helm&#x27;</span>) &#123;</span><br><span class="line">      withCredentials([[<span class="attr">$class:</span> <span class="string">&#x27;UsernamePasswordMultiBinding&#x27;</span>,</span><br><span class="line">        <span class="symbol">credentialsId:</span> <span class="string">&#x27;dockerhub&#x27;</span>,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;DOCKER_HUB_USER&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;DOCKER_HUB_PASSWORD&#x27;</span>]]) &#123;</span><br><span class="line">          container(<span class="string">&#x27;helm&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// todo，也可以做一些其他的分支判断是否要直接部署</span></span><br><span class="line">            echo <span class="string">&quot;4. [INFO] 开始 Helm 部署&quot;</span></span><br><span class="line">            helmDeploy(</span><br><span class="line">                <span class="attr">dry_run     :</span> <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">name        :</span> <span class="string">&quot;polling&quot;</span>,</span><br><span class="line">                <span class="attr">chartDir    :</span> <span class="string">&quot;polling&quot;</span>,</span><br><span class="line">                <span class="attr">namespace   :</span> <span class="string">&quot;course&quot;</span>,</span><br><span class="line">                <span class="attr">tag         :</span> <span class="string">&quot;$&#123;imageTag&#125;&quot;</span>,</span><br><span class="line">                <span class="attr">image       :</span> <span class="string">&quot;$&#123;image&#125;&quot;</span>,</span><br><span class="line">                <span class="attr">username    :</span> <span class="string">&quot;$&#123;DOCKER_HUB_USER&#125;&quot;</span>,</span><br><span class="line">                <span class="attr">password    :</span> <span class="string">&quot;$&#123;DOCKER_HUB_PASSWORD&#125;&quot;</span></span><br><span class="line">            )</span><br><span class="line">            echo <span class="string">&quot;[INFO] Helm 部署应用成功...&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于我们没有将 chart 包放入到 API 服务的代码仓库中，这是因为我们这里使用的 chart 包涉及到两个应用，一个 API 服务，一个是前端展示的服务，所以我们这里是通过脚本里面去主动获取到 chart 包来进行安装的，如果 chart 包跟随代码仓库一起管理当然就要简单许多了。</p>
<p>现在我们去更新 Jenkinsfile 文件，然后提交到 gitlab 中，然后去观察下 Jenkins 中的构建是否成功，我们重点观察下 Helm 阶段：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/v7hhwa.png" alt="jenkins helm console"></p>
<p>当然我们还可以去做一些必要的判断工作，比如根据分支判断是否需要自动部署等等，同样也可以切换到 Blue Occean 界面查看构建结果。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/niark2.jpg" alt="jenkins blue occean"></p>
<p>现在大家可以尝试去修改下代码，然后提交代码到 gitlab 上，观察下 Jenkins 是否能够自动帮我们完成整个 CI&#x2F;CD 的过程。</p>
<p>作业：现在还有一个前端展示的项目：<a target="_blank" rel="noopener" href="https://github.com/cnych/polling-app-client%EF%BC%8C%E5%A4%A7%E5%AE%B6%E9%92%88%E5%AF%B9%E8%BF%99%E4%B8%AA%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8%E4%B8%8A%E9%9D%A2%E7%9A%84">https://github.com/cnych/polling-app-client，大家针对这个项目使用上面的</a> gitlab + jenkins + harbor + helm 来完成一个 Jenkins Pipeline 流水线的编写，尝试去修改下前端页面内容，看是否能够生效。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/21/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><span class="page-number current">22</span><a class="page-number" href="/page/23/">23</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/23/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">六一</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">273</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/huiaz" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;huiaz" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">六一</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.7m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">25:34</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true}});</script></body>
</html>
