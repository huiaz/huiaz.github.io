<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hui&#39;s Blog">
<meta property="og:url" content="http://example.com/page/15/index.html">
<meta property="og:site_name" content="Hui&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="六一">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/15/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hui's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hui's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Code Life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/Thanos%20Query%20Frontend/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/Thanos%20Query%20Frontend/" class="post-title-link" itemprop="url">Thanos Query Frontend</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:08:02" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/" itemprop="url" rel="index"><span itemprop="name">k8s-monitor</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/Thanos/" itemprop="url" rel="index"><span itemprop="name">Thanos</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Query-Frontend"><a href="#Query-Frontend" class="headerlink" title="Query Frontend"></a>Query Frontend</h1><p>前面我们了解到 querier 这个组件可以提供一个统一的查询入口，所以当查询的数据规模较大的时候，对 querier 组件也会有很大的压力，为此 Thanos 也提供了一个 <code>Query Frontend</code> 的组件来提升性能，当然该组件是可选的。</p>
<p>Thanos Query Frontend 是 Thanos Query 的前端，它的目标是将大型查询拆分为多个较小的查询，并缓存查询结果来提升性能。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Thanos Query Frontend 组件通过 <code>thanos query-frontend</code> 命令实现了一个放在 querier 前面的服务，以改进读取路径。它基于 Cortex Query Frontend 组件，所以你可以找到一些 Cortex 常见的特性，如查询拆分和结果缓存。可以使用下列命令来启动 Thanos Query Frontend：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">thanos query-frontend \</span><br><span class="line">    --http-address     &quot;0.0.0.0:9090&quot; \</span><br><span class="line">    --query-frontend.downstream-url=&quot;&lt;thanos-querier&gt;:&lt;querier-http-port&gt;&quot;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>目前只有范围查询（<code>/api/v1/query_range</code> 接口调用）实际上是通过 Query Frontend 处理的。所有其他 API 调用只是直接转到下游查询器，这意味着只有范围查询被拆分和缓存，但我们也计划支持即时查询。</p>
</blockquote>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><h3 id="查询拆分"><a href="#查询拆分" class="headerlink" title="查询拆分"></a>查询拆分</h3><p>query frontend 会将多天的的查询拆分为多个单天的查询，游下游的 querier 去并行处理这些已拆分的查询。返回的查询结果由 query frontend 进行汇聚。这样可以防止大时间跨度的查询导致 queier 发生 OOM，并且能够更快的执行查询以及更好的查询负载均衡。查询前端根据配置的 <code>--query-range.split-interval</code> 标志将长查询拆分为多个短查询，<code>--query-range.split-interval</code> 的默认值为 24 小时，启用缓存时，它应该大于 0。</p>
<h3 id="重试机制"><a href="#重试机制" class="headerlink" title="重试机制"></a>重试机制</h3><p>query frontend 支持在 HTTP 请求失败时重试查询的重试机制，有一个 <code>--query-range.max-retries-per-request</code> 标志来限制最大重试次数。</p>
<h3 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h3><p>query frontend 支持将查询结果进行缓存用以加速后续的查询。当缓存的结果不够完整时，query frontend 会计算出所需要的子查询并分配给下游的 querier 并行执行，子查询的步长会对齐以提升查询结果的可缓存性。当前支持的缓存后端有：memcached，redis 和内存，下面是这些缓存后端的一些配置。</p>
<p><strong>内存缓存</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">type:</span> <span class="string">IN-MEMORY</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">max_size:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">max_size_items:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">validity:</span> <span class="string">0s</span></span><br></pre></td></tr></table></figure>



<p>max_size 表示在内存中缓存的最大尺寸，单位可以是 KB、MB、GB。如果 max_size 和 max_size_items 都没有设置，就不会创建缓存。如果只设置 max_size 或 max_size_items 中的任意一个，则对其他字段没有限制。</p>
<p><strong>memcached</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">type:</span> <span class="string">MEMCACHED</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">addresses:</span> [<span class="string">your-memcached-addresses</span>]</span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">500ms</span></span><br><span class="line">  <span class="attr">max_idle_connections:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">max_item_size:</span> <span class="string">1MiB</span></span><br><span class="line">  <span class="attr">max_async_concurrency:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">max_async_buffer_size:</span> <span class="number">10000</span></span><br><span class="line">  <span class="attr">max_get_multi_concurrency:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">max_get_multi_batch_size:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">dns_provider_update_interval:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">expiration:</span> <span class="string">24h</span></span><br></pre></td></tr></table></figure>



<p>expiration 表示指定 memcached 缓存有效时间，如果设置为 0，则使用默认的 24 小时过期时间，上面的配置是默认的 memcached 配置。</p>
<p><strong>Redis</strong></p>
<p>默认的 Redis 配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">type:</span> <span class="string">REDIS</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">addr:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">db:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">dial_timeout:</span> <span class="string">5s</span></span><br><span class="line">  <span class="attr">read_timeout:</span> <span class="string">3s</span></span><br><span class="line">  <span class="attr">write_timeout:</span> <span class="string">3s</span></span><br><span class="line">  <span class="attr">pool_size:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">min_idle_conns:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">idle_timeout:</span> <span class="string">5m0s</span></span><br><span class="line">  <span class="attr">max_conn_age:</span> <span class="string">0s</span></span><br><span class="line">  <span class="attr">max_get_multi_concurrency:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">get_multi_batch_size:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">max_set_multi_concurrency:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">set_multi_batch_size:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">expiration:</span> <span class="string">24h0m0s</span></span><br></pre></td></tr></table></figure>



<p>expiration 表示指定 Redis 缓存有效时间，如果设置为 0，则使用默认的 24 小时过期时间。</p>
<h3 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h3><p>query frontend 还支持通过配置 <code>--query-frontend.log-queries-longer-than</code> 标志来记录运行时间超过某个持续时间的查询。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装 query frontend 最重要的就是通过 <code>-query-frontend.downstream-url</code> 指定下游的 querier，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># thanos-query-frontend.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-query-frontend</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-query-frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">thanos-query-frontend</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">thanos-query-frontend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">thanosio/thanos:v0.25.1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">query-frontend</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.level=info</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.format=logfmt</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--query-frontend.compress-responses</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--http-address=0.0.0.0:9090</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--query-frontend.downstream-url=http://thanos-querier.kube-mon.svc.cluster.local:9090</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--query-range.split-interval=12h</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--query-range.max-retries-per-request=10</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--query-frontend.log-queries-longer-than=10s</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--labels.split-interval=12h</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--labels.max-retries-per-request=10</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">|-</span></span><br><span class="line"><span class="string">              --query-range.response-cache-config=&quot;config&quot;:</span></span><br><span class="line"><span class="string">                max_size: &quot;200MB&quot;</span></span><br><span class="line"><span class="string">                max_size_items: 0</span></span><br><span class="line"><span class="string">                validity: 0s</span></span><br><span class="line"><span class="string">              type: IN-MEMORY</span></span><br><span class="line"><span class="string"></span>            <span class="bullet">-</span> <span class="string">|-</span></span><br><span class="line"><span class="string">              --labels.response-cache-config=&quot;config&quot;:</span></span><br><span class="line"><span class="string">                max_size: &quot;200MB&quot;</span></span><br><span class="line"><span class="string">                max_size_items: 0</span></span><br><span class="line"><span class="string">                validity: 0s</span></span><br><span class="line"><span class="string">              type: IN-MEMORY</span></span><br><span class="line"><span class="string"></span>          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_IP_ADDRESS</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">status.hostIP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">4</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/healthy</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">20</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/ready</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-query-frontend</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-query-frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9090</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-query-frontend</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>



<p>这里我们开启了缓存，使用内存缓存，直接通过 <code>-query-range.response-cache-config</code> 参数来配置缓存配置，也可以通过 <code>-query-range.response-cache-config-file</code> 指定缓存配置文件，两种方式均可，为了验证结果，这里创建了一个 NodePort 类型的 Service，直接创建上面的资源对象即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/thanos/manifests/thanos-query-frontend.yaml</span><br><span class="line">☸ ➜ kubectl get pods -n kube-mon -l app=thanos-query-frontend</span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">thanos-query-frontend-78954bc857-nkxkk   1/1     Running   0          151m</span><br><span class="line">☸ ➜ kubectl get svc -n kube-mon -l app=thanos-query-frontend</span><br><span class="line">NAME                    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">thanos-query-frontend   NodePort   10.97.182.150   &lt;none&gt;        9090:30514/TCP   152m</span><br></pre></td></tr></table></figure>



<p>然后可以通过任意节点的 30514 端口访问到查询前端：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/jccsq0.png" alt="查询前端"></p>
<p>该前端页面和 querier 组件是一致的，但是在 querier 前面缓存包装了一层。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/Thanos%20Receiver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/Thanos%20Receiver/" class="post-title-link" itemprop="url">Thanos Receiver</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:08:07" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/" itemprop="url" rel="index"><span itemprop="name">k8s-monitor</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/Thanos/" itemprop="url" rel="index"><span itemprop="name">Thanos</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Receiver"><a href="#Receiver" class="headerlink" title="Receiver"></a>Receiver</h1><p>前面我们提到 Thanos 有 <code>Sidecar</code> 和 <code>Receiver</code> 两种不同的架构模式，前面的章节我们已经学习了 Sidecar 模式的是呀，接下来我们再来了解下 Receiver 模式是如何工作的。</p>
<p>我们知道 Sidecar 是在每一个 Prometheus 的实例旁边添加一个 sidecar 组件来上传数据，但是数据上传并不是实时的，而是每 2h 上传一个数据块，所以远程存储的数据并不是实时的，Prometheus 需要各自持久化部分数据，这也是现在使用的 Sidecar 模式的弊端，但这并非是 Thanos 团队引入 Receiver 的决定性因素。</p>
<blockquote>
<p>Receiver is only recommended for uses for whom pushing is the only viable solution, for example, analytics use cases or cases where the data ingestion must be client initiated, such as software as a service type environments.</p>
</blockquote>
<p>按照文档中的说法，Receiver 只推荐用于多租户以及 Prometheus 配置受限的场景下，比如：</p>
<ul>
<li>租户使用某些 SaaS 服务对集群进行监控，如 Openshift Operator 部署的 Prometheus</li>
<li>由于安全或权限问题，监控团队无法在被监控集群中配置 Sidecar</li>
<li>被监控集群部署的是非容器化部署的 Prometheus</li>
</ul>
<p>这是因为 Receiver 会暂存多个 Prometheus 实例的 TSDB，当数据量较大时可能会发生 OOM，另外根据 官方文档，开启远程写入还将增加 Prometheus 约 25% 的内存使用。我们并非一定要在 Receiver 和 Sidecar 之间做出抉择，比如 Lastpass 就采用 Sidecar 与 Receiver 混合部署的方式，可以参考文档 <a target="_blank" rel="noopener" href="https://krisztianfekete.org/adopting-thanos-at-lastpass/%E3%80%82">https://krisztianfekete.org/adopting-thanos-at-lastpass/。</a></p>
<p>Thanos Receiver 组件可以接收来自任何 Prometheus 实例的 <strong>remote write</strong> 远程写入请求，并将数据存储在其本地 TSDB 中，同样我们也可以选择将这些 TSDB 块定期上传到对象存储中，此外 Receiver 同样也暴露了 Store API 接口，这样 Thanos Querier 组件也是可以实时查询接收到的指标的，不需要再去通过 Sidecar 获取最新的数据。</p>
<h2 id="多租户"><a href="#多租户" class="headerlink" title="多租户"></a>多租户</h2><p>Thanos Receiver 组件也支持多租户，通过 remote write 请求的 HTTP Header（通过参数<code>--receive.tenant-header=&quot;THANOS-TENANT&quot;</code>配置）获取租户的 ID，为了防止数据库级别的数据泄露，每个租户都有一个单独的 TSDB 实例，数据成功提交到租户的 TSDB，就代表 remote write 请求成功了。指标会被添加标签 <code>tenant_id</code>（通过参数<code>--receive.tenant-label-name=&quot;tenant_id&quot;</code>配置）来标识指标的所属租户。</p>
<p>我们可以在 Prometheus 中通过如下所示配置在 <code>remote_write</code> 请求中附加 Header：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">remote_write:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://tenants:19291/api/v1/receive</span></span><br><span class="line">    <span class="attr">headers:</span></span><br><span class="line">      <span class="attr">THANOS-TENANT:</span> <span class="string">a</span></span><br></pre></td></tr></table></figure>



<p>如果希望实现多个 Receiver 的负载均衡和数据复制，则需要借助配置文件（通过<code>--receive.hashrings-file=&lt;path&gt;</code>参数指定）将多个 Receiver 组成哈希环，配置文件如下所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hashring&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tenant-a&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;endpoints&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;tenant-a-1.thanos.local:19291/api/v1/receive&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;tenant-a-2.thanos.local:19291/api/v1/receive&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tenants&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;tenant-a&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hashring&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tenants-b-c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;endpoints&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;tenant-b-c-1.thanos.local:19291/api/v1/receive&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;tenant-b-c-2.thanos.local:19291/api/v1/receive&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tenants&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;tenant-b&quot;</span><span class="punctuation">,</span> <span class="string">&quot;tenant-c&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hashring&quot;</span><span class="punctuation">:</span> <span class="string">&quot;soft-tenants&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;endpoints&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http://soft-tenants-1.thanos.local:19291/api/v1/receive&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>



<p>上面这个配置文件表示租户 ID 为 a 的写请求，将由 <code>tenant-a-1</code> 与 <code>tenant-a-2</code> 这两个 Receiver 进行处理，租户 ID 为 b 或 c 的写请求，将由 <code>tenant-b-c-1</code>、<code>tenant-b-c-2</code> 这两个 Receiver 处理，没有配置 <code>THANOS-TENANT</code> header 或其值不为 a、b、c 之一的写请求，则由 <code>soft-tenants-1</code> 这个 Receiver 处理。</p>
<p>这里涉及到两个概念：硬租户与软租户。</p>
<ul>
<li><code>Soft tenancy</code>：如果哈希环配置文件中未显式指定租户，则任何租户均被视为有效匹配。所有未设置 HTTP Header 或租户 ID 与其他哈希环不匹配的租户写请求，都将被分配给该哈希环。相应的 Receiver 将会为指标添加默认租户标签和值（可通过参数<code>–receive.default-tenant-id</code>指定）。</li>
<li><code>Hard tenancy</code>：所有的 remote write 请求必须通过 HTTP Header 显式地指定租户 ID，请求将进入匹配到的哈希环进行处理。</li>
</ul>
<blockquote>
<p>注意：remote write 请求可以发送给一组 Receiver 中任意一个，但是最终请求会交由匹配到的 Receiver 进行处理。所以可以在 Receiver 前面添加负载均衡器来随机分发请求实现 Receiver 的负载均衡。</p>
</blockquote>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>用于创建 Thanos Receiver 的资源清单如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># thanos-receiver.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-receiver</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-receiver</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">thanos-receiver</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">thanos-receiver</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment">#节点数量</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">thanos-receiver</span></span><br><span class="line">        <span class="attr">thanos-store-api:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">100</span></span><br><span class="line">              <span class="attr">podAffinityTerm:</span></span><br><span class="line">                <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">                <span class="attr">labelSelector:</span></span><br><span class="line">                  <span class="attr">matchExpressions:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                      <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                      <span class="attr">values:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">thanos-receiver</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos-receiver</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">thanosio/thanos:v0.25.1</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">receive</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--grpc-address=0.0.0.0:10901</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--http-address=0.0.0.0:10902</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--remote-write.address=0.0.0.0:19291</span> <span class="comment"># 提供给 prometheus 的 remote_write 端口</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--receive.replication-factor=3</span> <span class="comment"># 副本数，详细解释参考https://thanos.io/tip/proposals-done/201812-thanos-remote-receive.md/#:~:text=--receive.replication-factor=3</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--objstore.config-file=/etc/secret/thanos.yaml</span> <span class="comment"># 对象存储配置文件</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--tsdb.path=/var/thanos/receiver</span> <span class="comment"># 本地tsdb路径</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--tsdb.retention=1d</span> <span class="comment"># 热数据的保存时间</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--label=receive_replica=&quot;$(NAME)&quot;</span> <span class="comment"># 用于过滤重复数据的标签</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--receive.local-endpoint=$(NAME).thanos-receiver:10901</span> <span class="comment"># 节点endpoint，hashring 中记录的节点host需要与此处保持一致</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--receive.hashrings-file=/var/lib/thanos-receive/hashring.json</span> <span class="comment"># hashring文件，用于记录集群节点</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">10901</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">10902</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">19291</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">remote-write</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">8</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/healthy</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10902</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">20</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/ready</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10902</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/thanos/receiver</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hashring-config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/lib/thanos-receive</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">object-storage-config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/secret</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">object-storage-config</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hashring-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">hashring-config</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">accessModes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">longhorn</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-receiver</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">10901</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">10901</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">10902</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">10902</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">remote-write</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">19291</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">19291</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-receiver</span></span><br></pre></td></tr></table></figure>



<p>由于 Thanos Receiver 同样会将数据同步到对象存储，所以同样将对象存储的配置挂载到容器中，通过 <code>--objstore.config-file</code> 参数指定配置文件路径，为了能够直接对接到 Store 组件，同样这里为 Pod 添加一个 <code>thanos-store-api: &quot;true&quot;</code> 的标签即可（Service 会进行自动关联）被 query 组件服务发现。</p>
<p>Thanos Receiver 支持将接收到的时间序列复制到同一哈希环中的其他 Receiver，复制因子通过在 Receiver 上设置一个标志来控制，并指示应该存储在哈希环中的任何时间序列的最大副本数。如果 Thanos Receiver 接收到的写入请求中的任何时间序列未成功写入至少 <code>(REPLICATION_FACTOR + 1)/2</code> 个节点，则 Receiver 会以错误响应，例如，要尝试存储每个时间序列的 3 个副本并确保每个时间序列成功写入目标哈希环中的至少 2 个 Thanos Receiver，所以需要配置 <code>--receive.replication-factor=3</code> 参数。</p>
<p>此外 Thanos Receiver 本地同样有数据，所以也需要做持久化。</p>
<p>通过参数 <code>--label=receive_replica=&quot;$(NAME)&quot;</code> 指定用于重复过滤的标签为 <code>receive_replica</code>，这样我们同样需要在 query 组件参数中添加该标签 <code>--query.replica-label=receive_replica</code> 用于查询的时候去重：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">args:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">query</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--log.level=debug</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--query.replica-label=replica</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--query.replica-label=receive_replica</span> <span class="comment"># 添加该参数</span></span><br><span class="line">  <span class="comment"># Discover local store APIs using DNS SRV.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--store=dnssrv+thanos-store-gateway:10901</span></span><br></pre></td></tr></table></figure>



<p>最后一个比较重要的参数就是 <code>--receive.hashrings-file=/var/lib/thanos-receive/hashring.json</code>，用来指定 hashring 文件，该文件用于记录集群节点，这里我们通过一个 ConfigMap 挂载到容器中去，资源清单如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># thanos-receiver-hashring.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hashring-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">hashring.json:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    [</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        &quot;endpoints&quot;: [ </span></span><br><span class="line"><span class="string">            &quot;thanos-receiver-0.thanos-receiver:10901&quot;,</span></span><br><span class="line"><span class="string">            &quot;thanos-receiver-1.thanos-receiver:10901&quot;,</span></span><br><span class="line"><span class="string">            &quot;thanos-receiver-2.thanos-receiver:10901&quot;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br></pre></td></tr></table></figure>



<p>其中的 <code>endpoints</code> 用来记录所有 Receiver 节点的 host 地址的。然后直接应用上面的资源清单即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/thanos/manifests/thanos-receiver-hashring.yaml</span><br><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/thanos/manifests/thanos-receiver.yaml</span><br><span class="line">☸ ➜ kubectl get pods -n kube-mon -l app=thanos-receiver</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">thanos-receiver-0   1/1     Running   0          100s</span><br><span class="line">thanos-receiver-1   1/1     Running   0          89s</span><br><span class="line">thanos-receiver-2   1/1     Running   0          72s</span><br></pre></td></tr></table></figure>



<p>此外要记得为 Querier 组件添加 <code>- --query.replica-label=receive_replica</code> 参数，由于我们添加了 <code>thanos-store-api: &quot;true&quot;</code> 参数，所以会自动被 Store 发现，我们可以在查询前端页面验证 Store 组件，正常就会包含上面我们新增的 3 各 Receiver：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1650270714727.png" alt="store"></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>由于现在我们已经使用了 Receiver 模式了，只需要 Prometheus 将数据以 remote write 的形式传入 Receiver 即可，所以可以将 Sidecar 组件停掉了，现在我们的 Prometheus 变成了近乎无状态的了，只需要 Prometheus 应用本身，然后加上 remote write 地址即可，在 Prometheus 配置文件中新增远程写的接口地址：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus-config1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yaml.tmpl:</span> <span class="string">|</span> <span class="comment"># 注意这里的名称是 prometheus.yaml.tmpl</span></span><br><span class="line">    <span class="attr">global:</span></span><br><span class="line">      <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line">      <span class="attr">scrape_timeout:</span> <span class="string">15s</span></span><br><span class="line">      <span class="attr">external_labels:</span></span><br><span class="line">        <span class="attr">cluster:</span> <span class="string">ydzs-test</span></span><br><span class="line">        <span class="attr">replica:</span> <span class="string">$(POD_NAME)</span>  <span class="comment"># 每个 Prometheus 有一个唯一的标签</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">rule_files:</span>  <span class="comment"># 报警规则文件配置</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/prometheus/rules/*rules.yaml</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 指定 remote write 地址</span></span><br><span class="line">    <span class="attr">remote_write:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://thanos-receiver:19291/api/v1/receive</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ...... 省略其他配置</span></span><br></pre></td></tr></table></figure>



<p>在配置文件中通过 <code>remote_write.url</code> 来指定远程写入接口地址。正常现在也不需要 Sidecar 容器了，这里我们为了用一个 StatefulSet 来运行两个 Prometheus 副本，可以借助 Sidecar 来帮我们渲染 <code>prometheus.yaml.tmpl</code> 模板文件(因为 Prometheus 本身是不支持环境变量替换的)，这里的 Sidecar 仅作渲染用，同样需要去掉 <code>thanos-store-api: &quot;true&quot;</code> 标签，因为不需要直接对接 Store 了，修改后的资源清单文件如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># thanos-sidecar1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">thanos-store-api:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">thanos-store-api:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">100</span></span><br><span class="line">              <span class="attr">podAffinityTerm:</span></span><br><span class="line">                <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">                <span class="attr">labelSelector:</span></span><br><span class="line">                  <span class="attr">matchExpressions:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                      <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                      <span class="attr">values:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-rules</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-rules</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-shared</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fix-permissions</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">busybox:stable</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">chown</span>, <span class="string">-R</span>, <span class="string">&#x27;nobody:nobody&#x27;</span>, <span class="string">/prometheus</span>]</span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/prometheus</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">prom/prometheus:v2.34.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--config.file=/etc/prometheus-shared/prometheus.yaml&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--storage.tsdb.path=/prometheus&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--storage.tsdb.retention.time=6h&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--storage.tsdb.no-lockfile&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--storage.tsdb.min-block-duration=2h&#x27;</span> <span class="comment"># Thanos处理数据压缩</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--storage.tsdb.max-block-duration=2h&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--web.enable-admin-api&#x27;</span> <span class="comment"># 通过一些命令去管理数据</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--web.enable-lifecycle&#x27;</span> <span class="comment"># 支持热更新  localhost:9090/-/reload 加载</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-shared</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus-shared/</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-rules</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/rules</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/prometheus</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">thanosio/thanos:v0.25.1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sidecar</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.level=debug</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--reloader.config-file=/etc/prometheus/prometheus.yaml.tmpl</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--reloader.config-envsubst-file=/etc/prometheus-shared/prometheus.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--reloader.rule-dir=/etc/prometheus/rules/</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-shared</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus-shared/</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-rules</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/rules</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span> <span class="comment"># 由于prometheus每2h生成一个TSDB数据块，所以还是需要保存本地的数据</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">longhorn</span> <span class="comment"># 不要用nfs存储</span></span><br><span class="line">        <span class="attr">accessModes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">2Gi</span></span><br></pre></td></tr></table></figure>



<p>重新更新上面两个资源清单文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/thanos/manifests/prometheus-config1.yaml</span><br><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/thanos/manifests/thanos-sidecar1.yaml</span><br></pre></td></tr></table></figure>



<p>更新后 Prometheus 就会将数据远程写入到 Thanos Receiver 组件中去，然后 Receiver 也会定时将数据上传到对象存储中，而 Receiver 实现了 Store API，所以也可以直接通过 Query 组件查询获取到数据，这样最新的数据就会从 Receiver 组件中获取，而历史的数据就可以去 Store 对象存储中获取了。现在我们这 Query 中去查询数据就可以获取到最新的指标数据，由于配置了去重，所以查询出来的数据也会自动去重：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/1650273376822.png" alt="数据"></p>
<p>由于我们这里暂时只有一个集群，所以没有演示 Receiver 的多租户模式，这部分内容我们将这后续多集群章节中介绍。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/Thanos%20Store/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/Thanos%20Store/" class="post-title-link" itemprop="url">Thanos Store</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:08:16" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/" itemprop="url" rel="index"><span itemprop="name">k8s-monitor</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/Thanos/" itemprop="url" rel="index"><span itemprop="name">Thanos</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Store-组件"><a href="#Store-组件" class="headerlink" title="Store 组件"></a>Store 组件</h1><p>上面我们安装了 Thanos 的 Sidecar 和 Querier 组件，已经可以做到 Prometheus 的高可用，通过 Querier 提供一个统一的入口来查询监控数据，而且还可以对监控数据自动去重，但是还有一个非常重要的地方是还没有配置对象存储，如果想要查看历史监控数据就不行了，这个时候我们就需要去配置 Thanos Store 组件，将历史监控指标存储在对象存储中去。</p>
<p>目前 Thanos 支持的对象存储有：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/20200401105052.png" alt="Thanos Store Object Store"></p>
<p>要在生产环境使用最好使用 <code>Stable</code> 状态的，比如 S3 或者兼容 S3 的服务，比如 Ceph、Minio 等等。</p>
<p>对于国内用户当然最方便的还是直接使用阿里云 OSS 或者腾讯云 COS 这样的服务，但是很多时候可能我们的服务并不是跑在公有云上面的，所以这里我们用 Minio 来部署一个兼容 S3 协议的对象存储服务。</p>
<h2 id="安装-Minio"><a href="#安装-Minio" class="headerlink" title="安装 Minio"></a>安装 Minio</h2><p><a target="_blank" rel="noopener" href="https://min.io/">MinIO</a> 是一个基于 Apache License v2.0 开源协议的高性能分布式对象存储服务，为大规模私有云基础设施而设计。它兼容亚马逊 S3 云存储服务接口，非常适合于存储大容量非结构化的数据，例如图片、视频、日志文件、备份数据和容器&#x2F;虚拟机镜像等，而一个对象文件可以是任意大小，从几 kb 到最大 5T 不等。</p>
<p>要安装 Minio 非常容易的，同样我们这里将 Minio 安装到 Kubernetes 集群中，可以直接参考官方文档 <a target="_blank" rel="noopener" href="https://docs.min.io/cn/deploy-minio-on-kubernetes.html">使用 Kubernetes 部署 MinIO</a>，在 Kubernetes 集群下面可以部署独立、分布式或共享几种模式，可以根据实际情况部署，我们这里只是单纯测试用最简单的独立模式即可。</p>
<p>直接使用如下所示的 Deployment 来管理 Minio 的服务：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># minio-deploy.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">minio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">minio</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">minio-pvc</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">minio</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">&#x27;/data&#x27;</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">minio/minio:latest</span></span><br><span class="line">          <span class="attr">args:</span> [<span class="string">&#x27;server&#x27;</span>, <span class="string">&#x27;--console-address&#x27;</span>, <span class="string">&#x27;:9001&#x27;</span>, <span class="string">&#x27;/data&#x27;</span>]</span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MINIO_ACCESS_KEY</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;minio&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MINIO_SECRET_KEY</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;minio123&#x27;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9000</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9001</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/minio/health/ready</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/minio/health/live</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>



<p>由于新版本的镜像区分了 Console 和 API 两个服务的端口，所以在启动的时候我们需要通过 <code>--console-address</code> 参数来指定 Console 服务的端口，默认的 API 服务在 9000 端口上。</p>
<p>然后通过一个名为 <code>minio-pvc</code> 的 PVC 对象将数据持久化：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># minio-pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">minio-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10G</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">longhorn</span> <span class="comment"># 最好使用LocalPV</span></span><br></pre></td></tr></table></figure>



<p>最后我们可以通过 NodePort 类型的 Service 服务将 Minio 暴露给外部用户使用：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># minio-svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">minio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">console</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9001</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30091</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">api</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">minio</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>



<p>直接创建上面的资源对象即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/thanos/manifests/minio.yaml</span><br></pre></td></tr></table></figure>



<p>部署成功后，可以在浏览器中访问 <code>http://&lt;nodeip&gt;:30091</code> 访问到 MinIO Console 服务，通过上面定义的 <code>MINIO_ACCESS_KEY</code> 和 <code>MINIO_SECRET_KEY</code> 即可登录：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/20220321110506.png" alt="MinIO"></p>
<p>然后创建一个名为 <code>thanos</code> 的 bucket 桶：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/20220321110706.png" alt="Bucket"></p>
<h2 id="安装-Thanos-Store"><a href="#安装-Thanos-Store" class="headerlink" title="安装 Thanos Store"></a>安装 Thanos Store</h2><p>现在对象存储准备好了，我们就可以来部署 Store 组件了，该组件会从对象存储给 Querier 提供 metrics 数据。</p>
<p>根据上面创建的 Minio 创建一个如下所示的对象存储配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># thanos-storage-minio.yaml</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">s3</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">bucket:</span> <span class="string">thanos</span></span><br><span class="line">  <span class="attr">endpoint:</span> <span class="string">minio.default.svc.cluster.local:9000</span></span><br><span class="line">  <span class="attr">access_key:</span> <span class="string">minio</span></span><br><span class="line">  <span class="attr">secret_key:</span> <span class="string">minio123</span></span><br><span class="line">  <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">signature_version2:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>



<p>使用上面的配置文件来创建一个 Secret 对象：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl create secret generic thanos-objectstorage --from-file=thanos.yaml=thanos-storage-minio.yaml -n kube-mon</span><br></pre></td></tr></table></figure>



<p>然后创建 Store 组件的资源清单文件，这里有一个需要注意的地方是需要添加一个 <code>thanos-store-api: &quot;true&quot;</code> 的标签，这样前面我们创建的 <code>thanos-store-gateway</code> 这个 Headless Service 就可以自动发现到这个服务，Querier 组件查询数据的时候除了可以通过 Sidecar 去获取数据也可以通过这个 Store 组件去对象存储里面获取数据了。将上面的 Secret 对象通过 Volume 形式挂载到容器中的 <code>/etc/secret</code> 目录下，通过 <code>objstore.config-file</code> 参数指定即可：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># thanos-store.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-store-gateway</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-store-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">thanos-store-gateway</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">thanos-store-gateway</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">thanos-store-gateway</span></span><br><span class="line">        <span class="attr">thanos-store-api:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">100</span></span><br><span class="line">              <span class="attr">podAffinityTerm:</span></span><br><span class="line">                <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">                <span class="attr">labelSelector:</span></span><br><span class="line">                  <span class="attr">matchExpressions:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                      <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                      <span class="attr">values:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">thanos-store-gateway</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">thanosio/thanos:v0.25.1</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;store&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--log.level=debug&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--data-dir=/data&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--objstore.config-file=/etc/secret/thanos.yaml&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--index-cache-size=500MB&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--chunk-pool-size=500MB&#x27;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">10902</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">10901</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10902</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/healthy</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10902</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/ready</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">object-storage-config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/secret</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">object-storage-config</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">accessModes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">longhorn</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>



<p>Store Gateway 实际也可以做到一定程度的无状态，它会需要一点磁盘空间来对对象存储做索引以加速查询，但数据不那么重要，是可以删除的，删除后会自动去拉对象存储查数据重新建立索引，这里为了避免每次重启都重新建立索引，所以用 StatefulSet 部署 Store Gateway，挂载一个小容量的 PV。部署两个副本，可以实现 Store Gateway 的高可用。</p>
<p>然后直接创建上面的资源对象即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/thanos/manifests/thanos-store.yaml</span><br><span class="line">☸ ➜ kubectl get pods -n kube-mon -l thanos-store-api=true</span><br><span class="line">NAME                     READY   STATUS    RESTARTS      AGE</span><br><span class="line">prometheus-0             2/2     Running   0             20m</span><br><span class="line">prometheus-1             2/2     Running   0             21m</span><br><span class="line">thanos-store-gateway-0   1/1     Running   0             24m</span><br><span class="line">thanos-store-gateway-1   1/1     Running   0             24m</span><br></pre></td></tr></table></figure>



<p>部署成功后这个时候去 Thano 的 Querier 页面上查看 Store 信息就可以发现这里我们配置的 Store 组件了：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/20220321180715.png" alt="Thano Store"></p>
<p>到这里证明我们的 Store 组件也配置成功了。但是还有一个明显的问题是这里我们只是配置去对象存储中查询数据的，那什么地方往对象存储中写入数据呢？当然还是在 Sidecar 组件里面了。所以同样我们需要把 <code>objstore.config-file</code> 参数和 Secret 对象也要配置到 Sidecar 组件中去：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">......</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">object-storage-config</span></span><br><span class="line">  <span class="attr">secret:</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">thanos-objectstorage</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="attr">args:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">sidecar</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--log.level=debug</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--tsdb.path=/prometheus</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--prometheus.url=http://localhost:9090</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--reloader.config-file=/etc/prometheus/prometheus.yaml.tmpl</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--reloader.config-envsubst-file=/etc/prometheus-shared/prometheus.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--reloader.rule-dir=/etc/prometheus/rules/</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">--objstore.config-file=/etc/secret/thanos.yaml</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="attr">volumeMounts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">object-storage-config</span></span><br><span class="line">  <span class="attr">mountPath:</span> <span class="string">/etc/secret</span></span><br><span class="line">  <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">......</span></span><br></pre></td></tr></table></figure>



<p>配置完成后重新更新 Sidecar 组件即可，配置生效过后正常的话就会有数据传入到 MinIO 里面去了（本地有超过两小时的 TSDB 块数据），我们可以去 MinIO 的页面上查看验证：</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/20200401130226.png" alt="MinIO"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/Thanos%20Querier/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/Thanos%20Querier/" class="post-title-link" itemprop="url">Thanos Querier</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:07:53" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/" itemprop="url" rel="index"><span itemprop="name">k8s-monitor</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/Thanos/" itemprop="url" rel="index"><span itemprop="name">Thanos</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Querier-组件"><a href="#Querier-组件" class="headerlink" title="Querier 组件"></a>Querier 组件</h1><p>现在我们就创建成功了两个 Prometheus 实例，但是我们真正去使用的时候并不是像上面提到的在前面加一个负载均衡器去查询监控数据，而是使用 Thanos 的 <code>Querier</code> 组件来提供一个全局的统一查询入口。对于 <code>Quierier</code> 最重要的就是要配置上 Thanos 的 Sidecar 地址，我们这里完全可以直接使用 Headless Service 去自动发现：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># thanos-querier.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-querier</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-querier</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">thanos-querier</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">thanos-querier</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">100</span></span><br><span class="line">              <span class="attr">podAffinityTerm:</span></span><br><span class="line">                <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">                <span class="attr">labelSelector:</span></span><br><span class="line">                  <span class="attr">matchExpressions:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                      <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                      <span class="attr">values:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">thanos-querier</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">thanosio/thanos:v0.25.1</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">query</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.level=debug</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--query.replica-label=replica</span></span><br><span class="line">            <span class="comment"># Discover local store APIs using DNS SRV.</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--store=dnssrv+thanos-store-gateway:10901</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">10902</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">10901</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/healthy</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/-/healthy</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-querier</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-querier</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">thanos-querier</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>



<p>容器中的参数 <code>--store=dnssrv+thanos-store-gateway:10901</code> 可以帮助自动发现可以查询指标数据的所有组件；然后创建一个 <code>thanos-querier</code> 的 Serivce 对象可以来提供一个运行 <code>PromQL</code> 的 web 页面，也提供了一个是否对不同集群数据进行去重的入口。直接创建上面的对象：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/thanos/manifests/thanos-querier.yaml</span><br><span class="line">☸ ➜ kubectl get pods -n kube-mon -l app=thanos-querier</span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">thanos-querier-cf566866b-r4jcj   1/1     Running   0          3m26s</span><br><span class="line">☸ ➜ kubectl get svc -n kube-mon -l app=thanos-querier</span><br><span class="line">NAME             TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">thanos-querier   NodePort   10.110.193.50   &lt;none&gt;        9090:31278/TCP   5m11s</span><br></pre></td></tr></table></figure>



<p>部署完成后我们就可以通过 <code>http://&lt;任意节点IP&gt;:31278</code> 去访问 <code>Querier</code> 了，在 <code>Stores</code> 页面下面就会显示通过服务发现获取到的 Sidecar 信息：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/i920dy.png" alt="Thano Querier"></p>
<p>在 <code>Graph</code> 页面下同样可以去使用 <code>PromQL</code> 语句来查询监控信息，这个页面和 Prometheus 原生的页面几乎是一致的，比如我们查询 master 节点的负载信息：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/fz5sbc.png" alt="Thanos Queirer"></p>
<p>这里我没有勾上 <code>deduplication</code>，所以 Thanos 不会帮我合并数据，所以能够看到 <code>prometheus-0</code> 和 <code>prometheus-1</code> 两条数据，因为我们有两个副本去抓取监控数据。</p>
<p>如果将 <code>deduplication</code> 选中，结果会根据 <code>replica</code> 这个标签进行合并，如果两个副本都有对应的数据，<code>Querier</code> 会取 timestamp 更小的结果：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/i852zp.png" alt="Thanos Queirer"></p>
<p>当然这个时候我们在前面章节中 Grafana 里面配置的 Prometheus 的数据源也就失效了，因为现在监控数据的来源是 <code>Thanos Querier</code>，所以我们需要重新配置 Prometheus 的数据源地址为 <code>http://thanos-querier:9090</code>：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/imybfm.png" alt="change grafana ds"></p>
<p>之前的监控图表也可以正常显示了：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/n73ak8.png" alt="node exporter grafana dashboard"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/Thanos%20sidecar/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/Thanos%20sidecar/" class="post-title-link" itemprop="url">Thanos sidecar</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:08:10" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/" itemprop="url" rel="index"><span itemprop="name">k8s-monitor</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/Thanos/" itemprop="url" rel="index"><span itemprop="name">Thanos</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>9 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Thanos-Sidecar-组件"><a href="#Thanos-Sidecar-组件" class="headerlink" title="Thanos Sidecar 组件"></a>Thanos Sidecar 组件</h1><p>首先将前面章节中的 Prometheus 相关的资源对象全部删除，然后我们需要在 Prometheus 中去自动发现集群的一些资源对象，所以依然需要对应的 RBAC 权限声明：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus-rbac.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;extensions&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/metrics</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nonResourceURLs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br></pre></td></tr></table></figure>



<p>然后需要部署 Prometheus 的配置文件，下面的资源对象是创建 Prometheus 配置文件的模板，该模板将由 Thanos sidecar 组件进行读取，最终会通过该模板生成实际的配置文件，在同一个 Pod 中的 Prometheus 容器将读取最终的配置文件，在配置文件中添加 <code>external_labels</code> 标签是非常重要的，以便让 <code>Queirer</code> 可以基于这些标签对数据进行去重处理：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus-config.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yaml.tmpl:</span> <span class="string">|</span> <span class="comment"># 注意这里的名称是 prometheus.yaml.tmpl</span></span><br><span class="line">    <span class="attr">global:</span></span><br><span class="line">      <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line">      <span class="attr">scrape_timeout:</span> <span class="string">15s</span></span><br><span class="line">      <span class="attr">external_labels:</span></span><br><span class="line">        <span class="attr">cluster:</span> <span class="string">ydzs-test</span></span><br><span class="line">        <span class="attr">replica:</span> <span class="string">$(POD_NAME)</span>  <span class="comment"># 每个 Prometheus 有一个唯一的标签</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">rule_files:</span>  <span class="comment"># 报警规则文件配置</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/prometheus/rules/*rules.yaml</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">alerting:</span></span><br><span class="line">      <span class="attr">alert_relabel_configs:</span>  <span class="comment"># 我们希望告警从不同的副本中也是去重的</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">regex:</span> <span class="string">replica</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">labeldrop</span></span><br><span class="line">      <span class="attr">alertmanagers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">path_prefix:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;alertmanager:9093&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line">    <span class="string">......</span>  <span class="comment"># 其他抓取任务配置和前面章节中的配置保持一致即可</span></span><br></pre></td></tr></table></figure>



<p>上面配置了报警规则文件，由于这里配置文件太大了，所以为了更加清晰，我们将报警规则文件拆分到另外的 ConfigMap 对象中来，下面我们配置了两个报警规则：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus-rules.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-rules</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">alert-rules.yaml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    groups:</span></span><br><span class="line"><span class="string">      - name: K8sObjects_Alerts</span></span><br><span class="line"><span class="string">        rules:</span></span><br><span class="line"><span class="string">        - alert: Deployment_Replicas_0</span></span><br><span class="line"><span class="string">          expr: |</span></span><br><span class="line"><span class="string">            sum(kube_deployment_status_replicas) by (deployment, namespace) &lt; 1</span></span><br><span class="line"><span class="string">          for: 1m</span></span><br><span class="line"><span class="string">          labels:</span></span><br><span class="line"><span class="string">            severity: warning</span></span><br><span class="line"><span class="string">          annotations:</span></span><br><span class="line"><span class="string">            summary: Deployment &#123;&#123;$labels.deployment&#125;&#125; of &#123;&#123;$labels.namespace&#125;&#125; is currently having no pods running</span></span><br><span class="line"><span class="string">            description: Has no pods running in Deployment &#123;&#123;$labels.deployment&#125;&#125; of &#123;&#123;$labels.namespace&#125;&#125;, you can describe to get events, or get replicas status.</span></span><br></pre></td></tr></table></figure>



<p>Thanos 通过 Sidecar 和现有的 Prometheus 进行集成，将 Prometheus 的数据备份到对象存储中，所以首先我们需要将 Prometheus 和 Sidecar 部署在同一个 Pod 中，另外 Prometheus 中一定要开启下面两个参数：</p>
<ul>
<li><code>--web.enable-admin-api</code> 允许 Thanos 的 Sidecar 从 Prometheus 获取元数据。</li>
<li><code>--web.enable-lifecycle</code> 允许 Thanos 的 Sidecar 重新加载 Prometheus 的配置和规则文件。</li>
</ul>
<p>由于 Prometheus 默认每<code>2h</code>生成一个 TSDB 数据块，所以仍然并不意味着 Prometheus 可以是完全无状态的，因为如果它崩溃并重新启动，我们将丢失〜2 个小时的指标，因此强烈建议依然对 Prometheus 做数据持久化，所以我们这里使用了 <code>StatefulSet</code> 来管理这个应用，添加 <code>volumeClaimTemplates</code> 来声明了数据持久化的 PVC 模板：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># thanos-sidecar.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">thanos-store-api:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">thanos-store-api:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">100</span></span><br><span class="line">              <span class="attr">podAffinityTerm:</span></span><br><span class="line">                <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">                <span class="attr">labelSelector:</span></span><br><span class="line">                  <span class="attr">matchExpressions:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                      <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                      <span class="attr">values:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-rules</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-rules</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-shared</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fix-permissions</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">busybox:stable</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">chown</span>, <span class="string">-R</span>, <span class="string">&quot;nobody:nobody&quot;</span>, <span class="string">/prometheus</span>]</span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/prometheus</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">prom/prometheus:v2.34.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--config.file=/etc/prometheus-shared/prometheus.yaml&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.path=/prometheus&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.retention.time=6h&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.no-lockfile&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.min-block-duration=2h&quot;</span> <span class="comment"># Thanos处理数据压缩</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.max-block-duration=2h&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--web.enable-admin-api&quot;</span> <span class="comment"># 通过一些命令去管理数据</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--web.enable-lifecycle&quot;</span> <span class="comment"># 支持热更新  localhost:9090/-/reload 加载</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-shared</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus-shared/</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-rules</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/rules</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/prometheus</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">thanos</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">thanosio/thanos:v0.25.1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sidecar</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.level=debug</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--tsdb.path=/prometheus</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--prometheus.url=http://localhost:9090</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--reloader.config-file=/etc/prometheus/prometheus.yaml.tmpl</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--reloader.config-envsubst-file=/etc/prometheus-shared/prometheus.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--reloader.rule-dir=/etc/prometheus/rules/</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-sidecar</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">10902</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">10901</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-shared</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus-shared/</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-rules</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/rules</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/prometheus</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span> <span class="comment"># 由于prometheus每2h生成一个TSDB数据块，所以还是需要保存本地的数据</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">longhorn</span> <span class="comment"># 不要用nfs存储</span></span><br><span class="line">        <span class="attr">accessModes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">2Gi</span></span><br></pre></td></tr></table></figure>



<p>由于 Prometheus 和 Thanos 的 Sidecar 在同一个 Pod 中了，所以我们完全可以用 <code>localhost</code> 就可以访问到了，然后将数据目录做了声明挂载，所以同样可以在两个容器中共享数据目录了，一定要注意几个配置文件的挂载方式。此外在上面的配置文件中我们通过 <code>POD_NAME</code> 这个环境变量作为 <code>external</code> 标签附加到了 Prometheus 实例上，这里我们通过 <code>Downward API</code> 去设置该环境变量。</p>
<p>由于现在使用的是 <code>StatefulSet</code> 控制器，所以需要创建一个 Headless Service，而且后面的 Thanos Query 还将使用该无头服务来查询所有 Prometheus 实例中的数据，当然我们也可以为每一个 Prometheus 实例去创建一个 Service 对象便于调试，当然这个不是必须的：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus-headless.yaml</span></span><br><span class="line"><span class="comment"># 该服务为 querier 创建 srv 记录，以便查找 store-api 的信息</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">thanos-store-gateway</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-mon</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">10901</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">grpc</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">thanos-store-api:</span> <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>



<p>然后我们就可以使用上面的这些资源对象来创建带有 Thanos Sidecar 容器的高可用 Prometheus 应用了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/thanos/manifests/prometheus-rbac.yaml</span><br><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/thanos/manifests/prometheus-config.yaml</span><br><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/thanos/manifests/prometheus-rules.yaml</span><br><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/thanos/manifests/prometheus-headless.yaml</span><br><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/thanos/manifests/thanos-sidecar.yaml</span><br><span class="line">☸ ➜ kubectl get pods -n kube-mon -l app=prometheus</span><br><span class="line">NAME           READY   STATUS    RESTARTS      AGE</span><br><span class="line">prometheus-0   2/2     Running   1 (78s ago)   106s</span><br><span class="line">prometheus-1   2/2     Running   1 (47s ago)   75s</span><br></pre></td></tr></table></figure>



<p>创建成功后可以看到 Prometheus 中包含两个容器，其中的 Sidecar 容器启动的时候有两个非常重要的参数 <code>--reloader.config-file</code> 与 <code>--reloader.config-envsubst-file</code>，第一个参数是指定 Prometheus 配置文件的模板文件，然后通过渲染配置模板文件，这里就是将 <code>external_labels.replica: $(POD_NAME)</code> 的标签值用环境变量 POD_NAME 进行替换，然后将渲染后的模板文件放到 <code>config-envsubst-file</code> 指定的路径，也就是 <code>/etc/prometheus-shared/prometheus.yaml</code>，所以应用主容器也通过 <code>--config.file</code> 来指定的该配置文件路径。我们也可以查看 Sidecar 容器的相关日志来验证：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl logs -f prometheus-0 -n kube-mon -c thanos</span><br><span class="line">level=debug ts=2022-03-20T03:30:48.476658968Z caller=main.go:66 msg=&quot;maxprocs: Updating GOMAXPROCS=[1]: using minimum allowed GOMAXPROCS&quot;</span><br><span class="line">level=info ts=2022-03-20T03:30:48.477201922Z caller=sidecar.go:123 msg=&quot;no supported bucket was configured, uploads will be disabled&quot;</span><br><span class="line">level=info ts=2022-03-20T03:30:48.477275662Z caller=options.go:27 protocol=gRPC msg=&quot;disabled TLS, key and cert must be set to enable&quot;</span><br><span class="line">level=info ts=2022-03-20T03:30:48.477623162Z caller=sidecar.go:357 msg=&quot;starting sidecar&quot;</span><br><span class="line">level=info ts=2022-03-20T03:30:48.477804709Z caller=intrumentation.go:75 msg=&quot;changing probe status&quot; status=healthy</span><br><span class="line">level=info ts=2022-03-20T03:30:48.477833439Z caller=http.go:73 service=http/server component=sidecar msg=&quot;listening for requests and metrics&quot; address=0.0.0.0:10902</span><br><span class="line">level=info ts=2022-03-20T03:30:48.477973149Z caller=tls_config.go:195 service=http/server component=sidecar msg=&quot;TLS is disabled.&quot; http2=false</span><br><span class="line">level=debug ts=2022-03-20T03:30:48.478060891Z caller=promclient.go:623 msg=&quot;build version&quot; url=http://localhost:9090/api/v1/status/buildinfo</span><br><span class="line">level=info ts=2022-03-20T03:30:48.479035037Z caller=intrumentation.go:56 msg=&quot;changing probe status&quot; status=ready</span><br><span class="line">level=info ts=2022-03-20T03:30:48.480670711Z caller=grpc.go:131 service=gRPC/server component=sidecar msg=&quot;listening for serving gRPC&quot; address=0.0.0.0:10901</span><br><span class="line">level=warn ts=2022-03-20T03:30:48.480775546Z caller=sidecar.go:172 msg=&quot;failed to fetch prometheus version. Is Prometheus running? Retrying&quot; err=&quot;perform GET request against http://localhost:9090/api/v1/status/buildinfo: Get \&quot;http://localhost:9090/api/v1/status/buildinfo\&quot;: dial tcp [::1]:9090: connect: connection refused&quot;</span><br><span class="line">level=error ts=2022-03-20T03:30:48.480838975Z caller=runutil.go:101 component=reloader msg=&quot;function failed. Retrying in next tick&quot; err=&quot;trigger reload: reload request failed: Post \&quot;http://localhost:9090/-/reload\&quot;: dial tcp [::1]:9090: connect: connection refused&quot;</span><br><span class="line">level=debug ts=2022-03-20T03:30:50.478628169Z caller=promclient.go:623 msg=&quot;build version&quot; url=http://localhost:9090/api/v1/status/buildinfo</span><br><span class="line">level=info ts=2022-03-20T03:30:50.479976025Z caller=sidecar.go:179 msg=&quot;successfully loaded prometheus version&quot;</span><br><span class="line">level=info ts=2022-03-20T03:30:50.481937285Z caller=sidecar.go:201 msg=&quot;successfully loaded prometheus external labels&quot; external_labels=&quot;&#123;cluster=\&quot;ydzs-test\&quot;, replica=\&quot;prometheus-0\&quot;&#125;&quot;</span><br><span class="line">level=info ts=2022-03-20T03:30:53.485019736Z caller=reloader.go:373 component=reloader msg=&quot;Reload triggered&quot; cfg_in=/etc/prometheus/prometheus.yaml.tmpl cfg_out=/etc/prometheus-shared/prometheus.yaml watched_dirs=/etc/prometheus/rules/</span><br><span class="line">level=info ts=2022-03-20T03:30:53.485067975Z caller=reloader.go:235 component=reloader msg=&quot;started watching config file and directories for changes&quot; cfg=/etc/prometheus/prometheus.yaml.tmpl out=/etc/prometheus-shared/prometheus.yaml dirs=/etc/prometheus/rules/</span><br></pre></td></tr></table></figure>



<p>由于在 Sidecar 中我们并没有配置对象存储相关参数，所以出现了 <code>no supported bucket was configured, uploads will be disabled</code> 的警告信息，也就是现在并不会上传我们的指标数据，到这里我们就将 Thanos Sidecar 组件成功部署上了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/Thanos-%E6%9E%B6%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/Thanos-%E6%9E%B6%E6%9E%84/" class="post-title-link" itemprop="url">Thanos-架构</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:08:20" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/" itemprop="url" rel="index"><span itemprop="name">k8s-monitor</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/Thanos/" itemprop="url" rel="index"><span itemprop="name">Thanos</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Thanos-架构"><a href="#Thanos-架构" class="headerlink" title="Thanos 架构"></a>Thanos 架构</h1><p><a target="_blank" rel="noopener" href="https://thanos.io/">Thanos</a> 是一个基于 Prometheus 实现的监控方案，其主要设计目的是解决原生 Prometheus 上的痛点，并且做进一步的提升，主要的特性有：<strong>全局查询，高可用，动态拓展，长期存储</strong>。</p>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p>Thanos 主要由如下几个特定功能的组件组成：</p>
<ul>
<li>边车组件（Sidecar）：连接到 Prometheus，并把 Prometheus 暴露给查询网关（Querier&#x2F;Query），以供实时查询，并且可以上传 Prometheus 数据到云存储，以供长期保存</li>
<li>查询网关（Querier）：实现 Prometheus API 以聚合来自底层组件（如边车组件 Sidecar，或是存储网关 Store Gateway）的数据</li>
<li>存储网关（Store Gateway）：将云存储中的数据内容暴露出来</li>
<li>压缩器（Compactor）：将云存储中的数据进行压缩和下采样和保留</li>
<li>接收器（Receiver）：从 Prometheus 的远程写入 WAL 接收数据，将其暴露出去或者上传到云存储</li>
<li>规则组件（Ruler）：根据 Thanos 中的数据评估记录和警报规则</li>
<li>查询前端：实现 Prometheus 的 API，将其代理给 Query，同时缓存响应</li>
</ul>
<p>从使用角度来看有两种方式去使用 Thanos，sidecar 模式和 receiver 模式。</p>
<p><strong>sidecar 架构模式</strong></p>
<p>Thanos Sidecar 组件需要和 Pormetheus 实例一起部署，用于代理 Thanos Querier 组件对本地 Prometheus 的数据读取，允许 Querier 使用通用、高效的 StoreAPI 查询 Prometheus 数据。第二是将 Prometheus 本地监控数据通过对象存储接口上传到对象存储中，这个上传是实时的，只要发现有新的监控数据保存到磁盘，会将这些监控数据上传至对象存储。</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/20220318155719.png" alt="sidecar"></p>
<p>Thanos Sidecar 组件在 Prometheus 的远程读 API 之上实现了 Thanos 的 Store API，这使得 Querier 可以将 Prometheus 服务器视为时间序列数据的另一个来源，而无需直接与它的 API 进行交互。</p>
<p>因为 Prometheus 每 2 小时生成一个时序数据块，Thanos Sidecar 会每隔 2 小时将这个块上传到一个对象存储桶中。这样 Prometheus 服务器就可以以相对较低的存储空间运行，同时通过对象存储提供历史数据，使得监控数据具有持久性和可查询性。但是这样并不意味着 Prometheus 可以完全无状态，因为如果 Prometheus 崩溃并重新启动，我们将失去大约 2 个小时的指标数据，所以 Prometheus 在实际运行中还是需要持久性磁盘的。</p>
<p><strong>receiver 架构模式</strong></p>
<p>Thanos Receiver 实现了 Prometheus 远程写 API，它构建在现有的 Prometheus TSDB 之上，并保持其实用性，同时通过长期存储、水平可伸缩性和下采样扩展其功能。Prometheus 实例被配置为连续地向它写入指标，然后 Thanos Receiver 默认每 2 小时将时间序列格式的监控数据块上传到一个对象存储的桶中。Thanos Receiver 同样暴露了 Store API，以便 Thanos Querier 可以实时查询接收到的指标。</p>
<p><img data-src="https://picdn.youdianzhishi.com/images/20220318160814.png" alt="receiver"></p>
<p>这两种模式有各种的优缺点，具体使用哪种模式需要结合生产环境综合考虑。</p>
<h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><p>Thanos 是同时支持 Prometheus 读和写的远程存储方案，首先我们先看下 sidecar 模式下指标写入的整个流程：</p>
<ul>
<li>首先 Prometheus 从所采集服务的 metrics 接口抓取指标数据，同时根据自身所配置的 <code>recording rules</code> 定期对抓取到的指标数据进行评估，将结果以 TSDB 格式分块存储到本地，每个数据块的存储时长为 2 小时，且默认禁用了压缩功能。</li>
<li>然后 <code>sidecar</code> 嗅探到 Prometheus 的数据存储目录生成了新的只读数据块时，会将该数据块上传到对象存储桶中做为长期历史数据保存，在上传时会将数据块中的 <code>meta.json</code> 进行修改添加 thanos 相关的字段，如 <code>external_labels</code>。</li>
<li><code>rule</code> 根据所配置的 <code>recording rules</code> 定期地向 <code>query</code> 发起查询获取评估所需的指标值，并将结果以 TSDB 格式分块存储到本地。每个数据块的存储时长为 2 小时，且默认禁用了压缩功能，每个数据块的 <code>meta.json</code> 也附带了 thanos 拓展的 <code>external_lables</code> 字段。当本地生成了新的只读数据块时，其自身会将该数据块上传到远端对象存储桶中做为长期历史数据保存。</li>
<li><code>compact</code> 定期将对象存储中地数据块进行压缩和降准采样，进行压缩时数据块中的 truck 会进行合并，对应的 <code>meta.json</code> 中的 level 也会一同增长，每次压缩累加 1，初始值为 1。在进行降准采样时会创建新的数据块，根据采样步长从原有的数据块中抽取值存储到新的数据块中，在 <code>meta.json</code> 中记录 <code>resolution</code> 为采样步长。</li>
</ul>
<p>读取指标的流程为：</p>
<ul>
<li>首先客户端通过 <code>query API</code> 向 <code>query</code> 发起查询，<code>query</code> 将请求转换成 <code>StoreAPI</code> 发送到其他的 <code>query</code>、<code>sidecar</code>、<code>rule</code> 和 <code>store</code> 上。</li>
<li><code>sidecar</code> 接收到来自于 <code>query</code> 发起的查询请求后将其转换成 <code>query API</code> 请求，发送给其绑定的 Prometheus，由 Prometheus 从本地读取数据并响应，返回短期的本地采集和评估数据。</li>
<li><code>rule</code> 接收到来自于 <code>query</code> 发起的查询请求后直接从本地读取数据并响应，返回短期的本地评估数据。</li>
<li><code>store</code> 接收到来自于 <code>query</code> 发起的查询请求后首先从对象存储桶中遍历数据块的 <code>meta.json</code>，根据其中记录的时间范围和标签先进行一次过滤。接下来从对象存储桶中读取数据块的 <code>index</code> 和 <code>chunks</code> 进行查询，部分查询频率较高的<code>index</code> 会被缓存下来，下次查询使用到时可以直接读取。最终返回长期的历史采集和评估指标。</li>
</ul>
<p>对于发送报警的流程如下所示：</p>
<ul>
<li>Prometheus 根据自身配置的 <code>alerting</code> 规则定期地对自身采集的指标进行评估，当告警条件满足的情况下发起告警到 Alertmanager 上。</li>
<li><code>rule</code> 根据自身配置的 <code>alerting</code> 规则定期的向 <code>query</code> 发起查询请求获取评估所需的指标，当告警条件满足的情况下发起告警到 Alertmanager 上。</li>
<li>Alertmanager 接收到来自于 Prometheus 和 <code>rule</code> 的告警消息后进行分组合并后发出告警通知。</li>
</ul>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><p>Thanos 相比起原生的 Prometheus 具有以下的一些优势：</p>
<ul>
<li>统一查询入口——以 <code>Querier</code> 作为统一的查询入口，其自身实现了 Prometheus 的查询接口和 <code>StoreAPI</code>，可为其他的 <code>Querier</code> 提供查询服务，在查询时会从每个 Prometheus 实例的 <code>Sidecar</code> 和 <code>Store Gateway</code> 获取到指标数据。</li>
<li>查询去重——每个数据块都会带有特定的集群标签， <code>Querier</code> 在做查询时会去除集群标签，将指标名称和标签一致的序列根据时间排序合并。虽然指标数据来自不同的采集源，但是只会响应一份结果而不是多份重复的结果。</li>
<li>高空间利用率——每个 Prometheus 本身不存储长时间的数据，<code>Sidecar</code> 会将 Prometheus 已经持久化的数据块上传到对象存储中。<code>Compactor</code> 会定时将远端对象存储中的长期数据进行压缩，并且根据采样时长做清理，节约存储空间。</li>
<li>高可用——<code>Querier</code> 是无状态服务，天生支持水平拓展和高可用。<code>Store</code>、<code>Rule</code> 和 <code>Sidecar</code> 是有状态服务，在多副本部署的情况下也支持高可用，不过会产生数据冗余，需要牺牲存储空间。</li>
<li>存储长期数据——Prometheus 实例的 <code>Sidecar</code> 会将本地数据上传到远端对象存储中作为长期数据</li>
<li>横向拓展——当 Prometheus 的指标采集压力过大时，可以创建新的 Prometheus 实例，将 <code>scrape job</code> 拆分给多个 Prometheus，<code>Querier</code> 从多个 Prometheus 查询汇聚结果，降低单个 Prometheus 的压力</li>
<li>跨集群查询——需要合并多个集群的查询结果时，仅需要在每个集群的 <code>Querier</code> 之上再添加一层 <code>Querier</code> 即可，这样的层层嵌套，可以使得集群规模无限制拓展。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/WebSocket%20%E5%92%8C%20HTTP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/WebSocket%20%E5%92%8C%20HTTP/" class="post-title-link" itemprop="url">WebSocket 和 HTTP</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:08:57" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WEB/" itemprop="url" rel="index"><span itemprop="name">WEB</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WEB/Http/" itemprop="url" rel="index"><span itemprop="name">Http</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>WebSocket 和 HTTP 都是应用层协议，用于在客户端和服务器之间传输数据。然而，它们在<strong>通信模式、连接方式、数据流向和使用场景</strong>上存在根本性的区别。理解这些区别对于选择适合你应用的通信协议至关重要。</p>
<hr>
<h3 id="主要区别概览"><a href="#主要区别概览" class="headerlink" title="主要区别概览"></a>主要区别概览</h3><table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">HTTP (通常指 HTTP&#x2F;1.1)</th>
<th align="left">WebSocket</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>通信模式</strong></td>
<td align="left"><strong>请求-响应 (Request-Response)</strong> 模型</td>
<td align="left"><strong>全双工 (Full-duplex)</strong> 持久连接</td>
</tr>
<tr>
<td align="left"><strong>连接方式</strong></td>
<td align="left"><strong>短连接</strong> (默认)。每次请求-响应后连接通常关闭或保持短暂的 Keep-Alive</td>
<td align="left"><strong>长连接</strong>。一次握手后连接持续开放，直到一方关闭</td>
</tr>
<tr>
<td align="left"><strong>数据流向</strong></td>
<td align="left">单向。客户端发起请求，服务器响应，然后循环。</td>
<td align="left">双向。客户端和服务器可以随时互相发送消息，无需等待请求。</td>
</tr>
<tr>
<td align="left"><strong>开销</strong></td>
<td align="left">每次请求都包含完整的头部信息，开销较大。</td>
<td align="left">初始握手开销较大，一旦建立，后续数据帧只有很小的头部开销。</td>
</tr>
<tr>
<td align="left"><strong>传输效率</strong></td>
<td align="left">对于实时、高频数据交换效率低。</td>
<td align="left">对于实时、高频数据交换效率高。</td>
</tr>
<tr>
<td align="left"><strong>协议类型</strong></td>
<td align="left">无状态 (Stateless)。每次请求都是独立的。</td>
<td align="left">有状态 (Stateful)。连接建立后，双方都知道彼此的状态。</td>
</tr>
<tr>
<td align="left"><strong>URL 模式</strong></td>
<td align="left"><code>http://</code> 或 <code>https://</code></td>
<td align="left"><code>ws://</code> 或 <code>wss://</code></td>
</tr>
<tr>
<td align="left"><strong>防火墙</strong></td>
<td align="left">易于穿透（80&#x2F;443端口开放）。</td>
<td align="left">基于 HTTP 升级，通常也能穿透（80&#x2F;443端口）。</td>
</tr>
<tr>
<td align="left"><strong>错误处理</strong></td>
<td align="left">内置错误码 (2xx, 4xx, 5xx等)。</td>
<td align="left">依赖于应用程序层或连接状态。</td>
</tr>
<tr>
<td align="left"><strong>典型应用</strong></td>
<td align="left">网页浏览、API 调用、文件下载、表单提交。</td>
<td align="left">实时聊天、游戏、股票行情、在线协作、推送通知、物联网。</td>
</tr>
</tbody></table>
<hr>
<h3 id="详细解释："><a href="#详细解释：" class="headerlink" title="详细解释："></a>详细解释：</h3><h4 id="1-通信模式："><a href="#1-通信模式：" class="headerlink" title="1. 通信模式："></a>1. 通信模式：</h4><ul>
<li><strong>HTTP：</strong> 遵循经典的<strong>请求-响应</strong>模型。客户端发送一个请求，服务器处理请求并返回一个响应。这个过程是单向的，每一次通信都由客户端发起。服务器无法主动向客户端推送数据，除非客户端先发起请求。</li>
<li><strong>WebSocket：</strong> 提供<strong>全双工</strong>通信。一旦连接建立，客户端和服务器可以互相独立地发送数据，无需等待对方的请求。这就像一个电话线：双方都可以随时说话。</li>
</ul>
<h4 id="2-连接方式："><a href="#2-连接方式：" class="headerlink" title="2. 连接方式："></a>2. 连接方式：</h4><ul>
<li><strong>HTTP：</strong> 默认是<strong>短连接</strong>。在 HTTP&#x2F;1.0 中，每次请求-响应后，TCP 连接都会关闭。在 HTTP&#x2F;1.1 中引入了 <code>Keep-Alive</code>，允许在单个 TCP 连接上进行多个请求-响应，以减少 TCP 握手&#x2F;挥手的开销，但本质上仍是请求-响应模式，连接一般在一段时间不活动后关闭。</li>
<li><strong>WebSocket：</strong> 采用<strong>长连接</strong>。它通过一个特殊的 HTTP 请求（带有 <code>Upgrade</code> 头）来进行握手。如果服务器支持，则连接从 HTTP 升级到 WebSocket 协议，之后这条 TCP 连接会一直保持开放，直到客户端或服务器明确关闭它。</li>
</ul>
<h4 id="3-数据流向："><a href="#3-数据流向：" class="headerlink" title="3. 数据流向："></a>3. 数据流向：</h4><ul>
<li><strong>HTTP：</strong> <strong>单向</strong>。客户端是主动方，服务器是被动方。服务器只在接收到请求后才能发送响应。</li>
<li><strong>WebSocket：</strong> <strong>双向</strong>。一旦建立了连接，客户端和服务器都可以主动向对方发送数据，使得实时数据传输成为可能。</li>
</ul>
<h4 id="4-开销："><a href="#4-开销：" class="headerlink" title="4. 开销："></a>4. 开销：</h4><ul>
<li><strong>HTTP：</strong> 由于其无状态特性，每个 HTTP 请求都需要包含完整的请求头（如 <code>Cookie</code>, <code>User-Agent</code>, <code>Accept</code> 等），这会增加额外的传输开销。对于频繁的小数据传输，头部开销会变得非常显著。</li>
<li><strong>WebSocket：</strong> 初始设置（HTTP 升级握手）开销较大。但一旦连接建立，后续的数据传输只包含一个小得多的帧头（通常只有几字节），大大减少了传输开销。这使其在连续、高频的数据交换中非常高效。</li>
</ul>
<h4 id="5-传输效率："><a href="#5-传输效率：" class="headerlink" title="5. 传输效率："></a>5. 传输效率：</h4><ul>
<li><strong>HTTP：</strong> 对于需要频繁交互的场景（如聊天、游戏），HTTP 效率很低。每次数据交换都需要建立连接（或重用 Keep-Alive 连接）、发送请求、等待响应，并包含完整的 HTTP 头。这会导致高延迟和资源浪费。</li>
<li><strong>WebSocket：</strong> 高效。由于持久连接和最小化的帧头，WebSocket 在实时应用中提供了非常低的延迟和高吞吐量。</li>
</ul>
<h4 id="6-协议类型："><a href="#6-协议类型：" class="headerlink" title="6. 协议类型："></a>6. 协议类型：</h4><ul>
<li><strong>HTTP：</strong> <strong>无状态</strong>。服务器不保留客户端在上次请求中的任何信息（除非使用 Cookie 或Session 等机制来模拟状态）。每个请求都是独立的。</li>
<li><strong>WebSocket：</strong> <strong>有状态</strong>。连接一旦建立，客户端和服务器都知道彼此的存在和状态。这种连接的存在本身就代表了一种状态。</li>
</ul>
<h4 id="7-URL-模式："><a href="#7-URL-模式：" class="headerlink" title="7. URL 模式："></a>7. URL 模式：</h4><ul>
<li><strong>HTTP：</strong> 使用 <code>http://</code> 或 <code>https://</code>。</li>
<li><strong>WebSocket：</strong> 使用 <code>ws://</code> 或 <code>wss://</code>。<code>wss://</code> 对应 HTTPS，表示 WebSocket 连接也是加密的（推荐使用）。</li>
</ul>
<h4 id="8-应用场景："><a href="#8-应用场景：" class="headerlink" title="8. 应用场景："></a>8. 应用场景：</h4><ul>
<li><p><strong>HTTP：</strong> 适用于非实时、非交互式应用，以及请求-响应模式的数据获取，如：</p>
<ul>
<li>浏览静态网页和动态网页。</li>
<li>RESTful API 调用。</li>
<li>文件下载、图片加载。</li>
<li>表单提交。</li>
</ul>
</li>
<li><p><strong>WebSocket：</strong> 适用于需要实时、低延迟、双向通信的场景，如：</p>
<ul>
<li>实时聊天应用。</li>
<li>多人在线游戏。</li>
<li>即时股票行情、体育赛事比分推送。</li>
<li>在线协作工具（如 Google Docs）。</li>
<li>地理位置服务推送。</li>
<li>物联网 (IoT) 设备通信。</li>
<li>实时通知中心。</li>
</ul>
</li>
</ul>
<hr>
<p><strong>总结：</strong></p>
<p>HTTP 擅长于请求-响应式的“拉取”数据模型，而 WebSocket 则专注于“推拉结合”的实时双向通信，极大地提高了实时数据传输的效率和性能。在现代 Web 开发中，根据具体需求，两者往往会结合使用。例如，网页的初始加载和静态资源获取使用 HTTP，而网页内的实时交互则通过 WebSocket 实现。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/YAML%20%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/YAML%20%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6/" class="post-title-link" itemprop="url">K8S YAML 资源清单文件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:09:33" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">基础知识</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="K8S-YAML-资源清单文件"><a href="#K8S-YAML-资源清单文件" class="headerlink" title="K8S YAML 资源清单文件"></a>K8S YAML 资源清单文件</h1><p>前面我们得 Kubernetes 集群已经搭建成功了，现在我们就可以在集群里面来跑我们的应用了。要在集群里面运行我们自己的应用，首先我们需要知道几个概念。</p>
<p>第一个当然就是应用的镜像，因为我们在集群中运行的是容器，所以首先需要将我们的应用打包成镜像。镜像准备好了，Kubernetes 集群也准备好了，其实我们就可以把我们的应用部署到集群中了。但是镜像到集群中运行这个过程如何完成呢？必然有一个地方可以来描述我们的应用，然后把这份描述告诉集群，然后集群按照这个描述来部署应用。</p>
<p>在之前 Docker 环境下面我们是直接通过命令 <code>docker run</code> 来运行我们的应用的，在 Kubernetes 环境下面我们同样也可以用类似 <code>kubectl run</code> 这样的命令来运行我们的应用，但是在 Kubernetes 中却是不推荐使用命令行的方式，而是希望使用我们称为<strong>资源清单</strong>的东西来描述应用，资源清单可以用 YAML 或者 JSON 文件来编写，一般来说 YAML 文件更方便阅读和理解，所以我们的课程中都会使用 YAML 文件来进行描述。</p>
<p>通过一个资源清单文件来定义好一个应用后，我们就可以通过 kubectl 工具来直接运行它：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f xxxx.yaml</span><br></pre></td></tr></table></figure>

<p>我们知道 kubectl 是直接操作 APIServer 的，所以就相当于把我们的清单提交给了 APIServer，然后集群获取到清单描述的应用信息后存入到 etcd 数据库中，然后 <code>kube-scheduler</code> 组件发现这个时候有一个 Pod 还没有绑定到节点上，就会对这个 Pod 进行一系列的调度，把它调度到一个最合适的节点上，然后把这个节点和 Pod 绑定到一起（写回到 etcd），然后节点上的 kubelet 组件这个时候 watch 到有一个 Pod 被分配过来了，就去把这个 Pod 的信息拉取下来，然后根据描述通过容器运行时把容器创建出来，最后当然同样把 Pod 状态再写回到 etcd 中去，这样就完成了一整个的创建流程。</p>
<h2 id="第一个容器化应用"><a href="#第一个容器化应用" class="headerlink" title="第一个容器化应用"></a>第一个容器化应用</h2><p>比如现在我们通过 YAML 文件编写了一个如下的资源清单，命名为 nginx-deployment.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  <span class="comment"># API版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>  <span class="comment"># API对象类型</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deploy</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">chapter:</span> <span class="string">first-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span>  <span class="comment"># Pod 副本数量</span></span><br><span class="line">  <span class="attr">template:</span>  <span class="comment"># Pod 模板</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line"><span class="string">NAME</span>           <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">nginx-deploy</span>   <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">12m</span></span><br></pre></td></tr></table></figure>

<p>Deployment 这个资源对象就是用来定义多副本应用的对象，而且还支持对每个副本进行滚动更新，上面我们的资源清单中的描述中有一个属性 <code>replicas: 2</code>，所以最后生成两个副本的 Pod。</p>
<p>而这个 Deployment 定义的副本 Pod 具体是什么样的，是通过下面的 Pod 模板来定义的，就是 template 下面的定义，这个模板中定义了我们的 Pod 中只有一个名为 nginx 的容器，容器使用的镜像是 <code>nginx:1.7.9</code>（spec.containers[0].image），并且这个容器监听的端口是 80（<code>spec.containers[0].ports[0].containerPort</code>），另外我们还为 Pod 添加了一个 <code>app: nginx</code> 这样的 Label 标签，这里需要非常注意的是上面的 <code>selector.matchLabels</code> 区域就是来表示我们的 Deployment 来管理哪些 Pod 的，所以这个地方需要和 Pod 模板中的 Label 标签保持一致，这个 Label 标签之前我们也提到过是非常重要的。</p>
<p>另外我们也可以发现每个 API 对象都有一个 <code>Metadata</code> 的字段，用来表示该对象的元数据的，比如定义 name、namespace 等，比如上面 Deployment 和 Pod 模板中都有这个字段，至于为什么 Pod 模板中没有 name 这个元信息呢，这是因为 Deployment 这个控制器会自动在他自己的 name 基础上生成 Pod 名，不过 Deployment 下面定义的 Label 标签就没有 Pod 中定义的 Label 标签那么重要了，只是起到一个对该对象标识和过滤的作用。比如我们在查询对象的时候可以带上标签来进行过滤：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get deployment -l chapter=first-app</span></span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deploy   2/2     2            2           51m</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods -l app=nginx</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deploy-54f57cf6bf-2fdjz   1/1     Running   0          51m</span><br><span class="line">nginx-deploy-54f57cf6bf-57287   1/1     Running   0          51m</span><br></pre></td></tr></table></figure>

<p>到这里我们就完成了我们的第一个应用的容器化部署，但是往往我们在部署应用的过程中或多或少会遇到一些问题，这个时候我们可以使用一个 <code>kubectl describe</code> 命令来查看资源对象的详细信息，比如我们用下面的命令来查看 Pod 的详细信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl describe pod nginx-deploy-54f57cf6bf-2fdjz</span></span><br><span class="line">Name:         nginx-deploy-54f57cf6bf-2fdjz</span><br><span class="line">Namespace:    default</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         node2/10.151.30.23</span><br><span class="line">Start Time:   Sat, 09 Nov 2019 15:20:32 +0800</span><br><span class="line">Labels:       app=nginx</span><br><span class="line">              pod-template-hash=54f57cf6bf</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">Status:       Running</span><br><span class="line">IP:           10.244.2.199</span><br><span class="line">IPs:</span><br><span class="line">  IP:           10.244.2.199</span><br><span class="line">Controlled By:  ReplicaSet/nginx-deploy-54f57cf6bf</span><br><span class="line">Containers:</span><br><span class="line">  nginx:</span><br><span class="line">    Container ID:   docker://e40e78eee7a431b6e7277b414967cce936ac750e2a8ba30298302cdd89e54300</span><br><span class="line">    Image:          nginx:1.7.9</span><br><span class="line">    Image ID:       docker-pullable://nginx@sha256:e3456c851a152494c3e4ff5fcc26f240206abac0c9d794affb40e0714846c451</span><br><span class="line">    Port:           80/TCP</span><br><span class="line">    Host Port:      0/TCP</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Sat, 09 Nov 2019 15:20:35 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-5tsh4 (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-5tsh4:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-5tsh4</span><br><span class="line">    Optional:    false</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age        From                 Message</span><br><span class="line">  ----    ------     ----       ----                 -------</span><br><span class="line">  Normal  Scheduled  &lt;unknown&gt;  default-scheduler    Successfully assigned default/nginx-deploy-54f57cf6bf-2fdjz to node2</span><br><span class="line">  Normal  Pulled     52m        kubelet, node2  Container image &quot;nginx:1.7.9&quot; already present on machine</span><br><span class="line">  Normal  Created    52m        kubelet, node2  Created container nginx</span><br><span class="line">  Normal  Started    52m        kubelet, node2  Started container nginx</span><br></pre></td></tr></table></figure>

<p>我们可以看到看到很多这个 Pod 的详细信息，比如调度到的节点、状态、IP 等，一般我们比较关心的是下面的 <code>Events</code> 部分，就是我们说的<strong>事件</strong>。</p>
<p>在 Kubernetes 创建资源对象的过程中，对该对象的一些重要操作，都会被记录在这个对象的 <code>Events</code> 里面，可以通过 <code>kubectl describe</code> 指令查看对应的结果。所以这个指令也会是以后我们排错过程中会经常使用的命令，一定要记住这个重要的命令。比如上面我们描述的这个 Pod，我们可以看到它被创建之后，被调度器调度（Successfully assigned）到了 node2 节点上，然后指定的镜像已经在该节点上存在了，所以没有再去拉取镜像，然后创建我们定义的 nginx 容器，最后启动定义的容器。</p>
<p>另外一个方面如果我们相对我们的应用进行升级的话应该怎么办呢？这个操作在我们日常工作中还是非常常见的，而在 Kubernetes 这里也是非常简单的，我们只需要修改我们的资源清单文件即可，比如我们把镜像升级到最新版本 <code>nginx:latest</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:latest</span> <span class="comment"># 这里被从 1.7.9 修改为latest</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>然后我们可以通过<code>kubectl apply</code>命令来直接更新，这个命令也是推荐我们使用的，我们不必关心当前的操作是创建，还是更新，执行的命令始终是 <code>kubectl apply</code>，Kubernetes 则会根据 YAML 文件的内容变化，自动进行具体的处理，所以无论是创建还是更新都可以直接使用这个命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx-deployment.yaml</span><br></pre></td></tr></table></figure>

<p>通过这个命令就可以来更新我们的应用了，由于我们这里使用的是一个 Deployment 的控制器，所以会滚动更新我们的应用，我们可以通过在命令后面加上 <code>--watch</code> 参数来查看 Pod 的更新过程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods -l app=nginx --watch</span></span><br><span class="line">NAME                            READY   STATUS              RESTARTS   AGE</span><br><span class="line">nginx-deploy-54f57cf6bf-2fdjz   1/1     Terminating         0          72m</span><br><span class="line">nginx-deploy-54f57cf6bf-57287   1/1     Running             0          72m</span><br><span class="line">nginx-deploy-786b576769-69lrl   1/1     Running             0          4s</span><br><span class="line">nginx-deploy-786b576769-wwmvz   0/1     ContainerCreating   0          2s</span><br><span class="line">nginx-deploy-54f57cf6bf-2fdjz   0/1     Terminating         0          72m</span><br><span class="line">nginx-deploy-786b576769-wwmvz   1/1     Running             0          3s</span><br><span class="line">nginx-deploy-54f57cf6bf-57287   1/1     Terminating         0          72m</span><br><span class="line">nginx-deploy-54f57cf6bf-57287   0/1     Terminating         0          72m</span><br><span class="line">nginx-deploy-54f57cf6bf-57287   0/1     Terminating         0          72m</span><br><span class="line">nginx-deploy-54f57cf6bf-57287   0/1     Terminating         0          72m</span><br><span class="line">nginx-deploy-54f57cf6bf-2fdjz   0/1     Terminating         0          72m</span><br><span class="line">nginx-deploy-54f57cf6bf-2fdjz   0/1     Terminating         0          72m</span><br></pre></td></tr></table></figure>

<p>可以看到更新过程是先杀掉了一个 Pod，然后又重新创建了一个新的 Pod，然后又杀掉一个旧的 Pod，再创建一个新的 Pod，这样交替替换的，最后剩下两个新的 Pod，这就是我们所说的滚动更新，滚动更新对于我们的应用持续提供服务是非常重要的手段，在日常工作中更新应用肯定会采用这种方式。</p>
<p>最后，如果需要把我们的应用从集群中删除掉，可以用 <code>kubectl delete</code> 命令来清理：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f nginx-deployment.yaml</span><br></pre></td></tr></table></figure>

<h2 id="YAML-文件"><a href="#YAML-文件" class="headerlink" title="YAML 文件"></a>YAML 文件</h2><p>上面我们在 Kubernetes 中部署了我们的第一个容器化应用，我们了解到要部署应用最重要的就是编写应用的资源清单文件。那么如何编写资源清单文件呢？日常使用的时候我们都是使用 YAML 文件来编写，但是现状却是大部分同学对 JSON 更加熟悉，对 YAML 文件的格式不是很熟悉，所以也导致很多同学在编写资源清单的时候似懂非懂的感觉，所以在了解如何编写资源清单之前我们非常有必要来了解下 YAML 文件的用法。</p>
<p><code>YAML</code> 是专门用来写配置文件的语言，非常简洁和强大，远比 <code>JSON</code> 格式方便。<code>YAML</code>语言（发音 &#x2F;ˈjæməl&#x2F;）的设计目标，就是方便人类读写。它实质上是一种通用的数据串行化格式。</p>
<p>它的基本语法规则如下：</p>
<ul>
<li>大小写敏感</li>
<li>使用缩进表示层级关系</li>
<li>缩进时不允许使用<code>Tab</code>键，只允许使用空格</li>
<li>缩进的空格数目不重要，只要相同层级的元素左侧对齐即可</li>
<li><code>#</code> 表示注释，从这个字符一直到行尾，都会被解析器忽略</li>
</ul>
<p>在 Kubernetes 中，我们只需要了解两种结构类型就行了：</p>
<ul>
<li>Lists（列表）</li>
<li>Maps（字典）</li>
</ul>
<p>也就是说，你可能会遇到 Lists 的 Maps 和 Maps 的 Lists，等等。不过不用担心，你只要掌握了这两种结构也就可以了，其他更加复杂的我们暂不讨论。</p>
<h3 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h3><p>首先我们来看看 <code>Maps</code>，我们都知道 <code>Map</code> 是字典，就是一个 <strong>key:value</strong> 的键值对，<code>Maps</code> 可以让我们更加方便的去书写配置信息，例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br></pre></td></tr></table></figure>

<p>第一行的<code>---</code>是分隔符，是可选的，在单一文件中，可用连续三个连字号<code>---</code>区分多个文件。这里我们可以看到，我们有两个键：kind 和 apiVersion，他们对应的值分别是：v1 和 Pod。上面的 YAML 文件转换成 JSON 格式的话，你肯定就容易明白了：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pod&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们在创建一个相对复杂一点的 YAML 文件，创建一个 KEY 对应的值不是字符串而是一个 Maps：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ydzs-site</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web</span></span><br></pre></td></tr></table></figure>

<p>上面的 YAML 文件，metadata 这个 KEY 对应的值就是一个 <code>Maps</code> 了，而且嵌套的 labels 这个 KEY 的值又是一个 Map，你可以根据你自己的情况进行多层嵌套。</p>
<p>上面我们也提到了 YAML 文件的语法规则，YAML 处理器是根据行缩进来知道内容之间的嗯关联性的。比如我们上面的 YAML 文件，<strong>我用了两个空格作为缩进，空格的数量并不重要，但是你得保持一致，并且至少要求一个空格</strong>（什么意思？就是你别一会缩进两个空格，一会缩进 4 个空格）。我们可以看到 name 和 labels 是相同级别的缩进，所以 YAML 处理器就知道了他们属于同一个 Map，而 app 是 labels 的值是因为 app 的缩进更大。</p>
<p>!!! warning “注意”</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：在 YAML 文件中绝对不要使用 tab 键来进行缩进。</span><br></pre></td></tr></table></figure>

<p>同样的，我们可以将上面的 YAML 文件转换成 JSON 文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Pod&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kube100-site&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;app&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>或许你对上面的 JSON 文件更熟悉，但是你不得不承认 YAML 文件的语义化程度更高吧？</p>
<h3 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h3><p><code>Lists</code>就是列表，说白了就是数组，在 YAML 文件中我们可以这样定义：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">args</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Cat</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Dog</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Fish</span></span><br></pre></td></tr></table></figure>

<p>你可以有任何数量的项在列表中，每个项的定义以破折号（<code>-</code>）开头的，与父元素之间可以缩进也可以不缩进。对应的 JSON 格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Cat&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Dog&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Fish&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>当然，Lists 的子项也可以是 Maps，Maps 的子项也可以是 Lists 如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ydzs-site</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">front-end</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flaskapp-demo</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">cnych/flaskapp</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>



<p>比如这个 YAML 文件，我们定义了一个叫 containers 的 List 对象，每个子项都由 name、image、ports 组成，每个 ports 都有一个 key 为 containerPort 的 Map 组成，同样的，我们可以转成如下 JSON 格式文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Pod&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ydzs-site&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;app&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;spec&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;containers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;front-end&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nginx&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;containerPort&quot;</span><span class="punctuation">:</span> <span class="string">&quot;80&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flaskapp-demo&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cnych/flaskapp&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;containerPort&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5000&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>是不是觉得用 JSON 格式的话文件明显比 YAML 文件更复杂了呢？</p>
<h2 id="如何编写资源清单"><a href="#如何编写资源清单" class="headerlink" title="如何编写资源清单"></a>如何编写资源清单</h2><p>上面我们了解了 YAML 文件的基本语法，现在至少可以保证我们的编写的 YAML 文件语法是合法的，那么要怎么编写符合 Kubernetes API 对象的资源清单呢？比如我们怎么知道 Pod、Deployment 这些资源对象有哪些功能、有哪些字段呢？</p>
<p>一些简单的资源对象我们可能可以凭借记忆写出对应的资源清单，但是 Kubernetes 发展也非常快，版本迭代也很快，每个版本中资源对象可能又有很多变化，那么有没有一种办法可以让我们做到有的放矢呢？</p>
<p>实际上是有的，最简单的方法就是查找 Kubernetes API 文档，比如我们现在使用的是 v1.22.2 版本的集群，可以通过地址 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.22/">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.22/</a> 查找到对应的 API 文档，在这个文档中我们可以找到所有资源对象的一些字段。</p>
<p>比如我们要了解创建一个 Deployment 资源对象需要哪些字段，我们可以打开上面的 API 文档页面，在左侧侧边栏找到 <code>Deployment v1 apps</code>，点击下面的 <code>Write Operations</code>，然后点击 <code>Create</code>，然后我们查找到创建 Deployment 需要提交的 Body 参数</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/p0a0sv.jpg" alt="deployment body parameter"></p>
<p>然后点击 Body，进入到参数详情页：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/7ykrw4.jpg" alt="deployment spec"></p>
<p>这个时候我们就可以看到我们创建 Deployment 需要的一些字段了，比如 apiVersion、kind、metadata、spec 等，而且每个字段都有对应的文档说明，比如我们像要了解 DeploymentSpec 下面有哪些字段，继续点击进去查看就行：</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/oojp25.jpg" alt="deployment spec detail"></p>
<p>每个字段具体什么含义以及每个字段下面是否还有其他字段都可以这样去追溯。</p>
<p>但是如果平时我们编写资源清单的时候都这样去查找文档势必会效率低下，Kubernetes 也考虑到了这点，我们可以直接通过 kubectl 命令行工具来获取这些字段信息，同样的，比如我们要获取 Deployment 的字段信息，我们可以通过 <code>kubectl explain</code> 命令来了解：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl explain deployment</span></span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Deployment enables declarative updates for Pods and ReplicaSets.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion   &lt;string&gt;</span><br><span class="line">     APIVersion defines the versioned schema of this representation of an</span><br><span class="line">     object. Servers should convert recognized schemas to the latest internal</span><br><span class="line">     value, and may reject unrecognized values. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources</span><br><span class="line"></span><br><span class="line">   kind &lt;string&gt;</span><br><span class="line">     Kind is a string value representing the REST resource this object</span><br><span class="line">     represents. Servers may infer this from the endpoint the client submits</span><br><span class="line">     requests to. Cannot be updated. In CamelCase. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds</span><br><span class="line"></span><br><span class="line">   metadata &lt;Object&gt;</span><br><span class="line">     Standard object metadata.</span><br><span class="line"></span><br><span class="line">   spec &lt;Object&gt;</span><br><span class="line">     Specification of the desired behavior of the Deployment.</span><br><span class="line"></span><br><span class="line">   status   &lt;Object&gt;</span><br><span class="line">     Most recently observed status of the Deployment.</span><br></pre></td></tr></table></figure>



<p>我们可以看到上面的信息和我们在 API 文档中查看到的基本一致，比如我们看到其中 <code>spec</code> 字段是一个 <code>&lt;Object&gt;</code> 类型的，证明该字段下面是一个对象，我们可以继续去查看这个字段下面的详细信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl explain deployment.spec</span></span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">RESOURCE: spec &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Specification of the desired behavior of the Deployment.</span><br><span class="line"></span><br><span class="line">     DeploymentSpec is the specification of the desired behavior of the</span><br><span class="line">     Deployment.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   minReadySeconds  &lt;integer&gt;</span><br><span class="line">     Minimum number of seconds for which a newly created pod should be ready</span><br><span class="line">     without any of its container crashing, for it to be considered available.</span><br><span class="line">     Defaults to 0 (pod will be considered available as soon as it is ready)</span><br><span class="line"></span><br><span class="line">   paused   &lt;boolean&gt;</span><br><span class="line">     Indicates that the deployment is paused.</span><br><span class="line"></span><br><span class="line">   progressDeadlineSeconds  &lt;integer&gt;</span><br><span class="line">     The maximum time in seconds for a deployment to make progress before it is</span><br><span class="line">     considered to be failed. The deployment controller will continue to process</span><br><span class="line">     failed deployments and a condition with a ProgressDeadlineExceeded reason</span><br><span class="line">     will be surfaced in the deployment status. Note that progress will not be</span><br><span class="line">     estimated during the time a deployment is paused. Defaults to 600s.</span><br><span class="line"></span><br><span class="line">   replicas &lt;integer&gt;</span><br><span class="line">     Number of desired pods. This is a pointer to distinguish between explicit</span><br><span class="line">     zero and not specified. Defaults to 1.</span><br><span class="line"></span><br><span class="line">   revisionHistoryLimit &lt;integer&gt;</span><br><span class="line">     The number of old ReplicaSets to retain to allow rollback. This is a</span><br><span class="line">     pointer to distinguish between explicit zero and not specified. Defaults to</span><br><span class="line">     10.</span><br><span class="line"></span><br><span class="line">   selector &lt;Object&gt; -required-</span><br><span class="line">     Label selector for pods. Existing ReplicaSets whose pods are selected by</span><br><span class="line">     this will be the ones affected by this deployment. It must match the pod</span><br><span class="line">     template&#x27;s labels.</span><br><span class="line"></span><br><span class="line">   strategy &lt;Object&gt;</span><br><span class="line">     The deployment strategy to use to replace existing pods with new ones.</span><br><span class="line"></span><br><span class="line">   template &lt;Object&gt; -required-</span><br><span class="line">     Template describes the pods that will be created.</span><br></pre></td></tr></table></figure>



<p>如果一个字段显示的是 <code>required</code>，这就证明该自动是必填的，也就是我们在创建这个资源对象的时候必须声明这个字段，每个字段的类型也都完全为我们进行了说明，所以有了 <code>kubectl explain</code> 这个命令我们就完全可以写出一个不熟悉的资源对象的清单说明了，这个命令我们也是必须要记住的，会在以后的工作中为我们提供很大的帮助。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/ansible-install-mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/ansible-install-mysql/" class="post-title-link" itemprop="url">Ansible</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:23:24" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/Ansible/" itemprop="url" rel="index"><span itemprop="name">Ansible</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><p>name: Install and Configure MySQL Server<br>hosts: databases  # 针对 inventory 文件中 [databases] 组的主机执行<br>become: yes       # 提权至 root 用户执行任务，因为安装软件需要管理员权限</p>
<p>vars:</p>
<h1 id="使用变量可以轻松适应不同操作系统，例如-CentOS-可能叫-‘mariadb-server’"><a href="#使用变量可以轻松适应不同操作系统，例如-CentOS-可能叫-‘mariadb-server’" class="headerlink" title="使用变量可以轻松适应不同操作系统，例如 CentOS 可能叫 ‘mariadb-server’"></a>使用变量可以轻松适应不同操作系统，例如 CentOS 可能叫 ‘mariadb-server’</h1><p>  mysql_package_name: mysql-server<br>  mysql_service_name: mysql</p>
<p>tasks:</p>
<ul>
<li><p>name: Update APT cache (for Debian&#x2F;Ubuntu)<br>ansible.builtin.apt:<br>  update_cache: yes<br>  cache_valid_time: 3600 # 缓存有效期1小时<br>when: ansible_os_family &#x3D;&#x3D; “Debian” # 条件判断：仅在 Debian 系系统上执行</p>
</li>
<li><p>name: Install MySQL Package<br>ansible.builtin.package:<br>  name: ““ # 使用变量指定包名<br>  state: present                  # 幂等性：确保这个包已安装，如果未安装则安装，已安装则不做任何事<br>notify:                          # 通知：如果此任务状态为 “changed”（即新安装了软件），则触发下面的 handler</p>
<ul>
<li>Restart MySQL Service</li>
</ul>
</li>
<li><p>name: Ensure MySQL service is running and enabled on boot<br>ansible.builtin.service:<br>  name: ““ # 使用变量指定服务名<br>  state: started                  # 幂等性：确保服务是启动状态<br>  enabled: yes                    # 幂等性：确保服务是开机自启</p>
</li>
</ul>
<p>handlers:</p>
<h1 id="Handlers-只有在被-notify-通知时才会执行，常用于服务重启等场景"><a href="#Handlers-只有在被-notify-通知时才会执行，常用于服务重启等场景" class="headerlink" title="Handlers 只有在被 notify 通知时才会执行，常用于服务重启等场景"></a>Handlers 只有在被 notify 通知时才会执行，常用于服务重启等场景</h1><ul>
<li>name: Restart MySQL Service<br>ansible.builtin.service:<br>  name: ““<br>  state: restarted</li>
</ul>
</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">### 如何使用这个 Playbook</span></span><br><span class="line"></span><br><span class="line">1.  **创建 Inventory 文件 (`inventory.ini`)**</span><br><span class="line"></span><br><span class="line">    首先，你需要一个资产清单文件来定义 `databases` 组里有哪些服务器。</span><br><span class="line"></span><br><span class="line">    ```ini</span><br><span class="line">    # inventory.ini</span><br><span class="line"></span><br><span class="line">    [databases]</span><br><span class="line">    db_server_1   <span class="attribute">ansible_host</span>=192.168.1.10</span><br><span class="line">    db_server_2   <span class="attribute">ansible_host</span>=192.168.1.11</span><br><span class="line"></span><br><span class="line">    # 如果你的用户名和目标机器不一样，可以这样指定</span><br><span class="line">    # db_server_1   <span class="attribute">ansible_host</span>=192.168.1.10   <span class="attribute">ansible_user</span>=remote_user</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p><strong>执行 Playbook</strong></p>
<p>在控制节点上，将 <code>install_mysql.yml</code> 和 <code>inventory.ini</code> 文件放在同一个目录下，然后运行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i inventory.ini install_mysql.yml</span><br></pre></td></tr></table></figure>
<ul>
<li><code>ansible-playbook</code>: 执行 Playbook 的命令。</li>
<li><code>-i inventory.ini</code>: 指定要使用的资产清单文件。</li>
<li><code>install_mysql.yml</code>: 指定要执行的 Playbook 文件。</li>
</ul>
<p>如果需要输入 <code>sudo</code> 密码，可以加上 <code>-K</code> (大写) 参数，<code>ansible-playbook</code> 会提示你输入。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i inventory.ini install_mysql.yml -K</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="运维工程师的关键解读"><a href="#运维工程师的关键解读" class="headerlink" title="运维工程师的关键解读"></a>运维工程师的关键解读</h3><ul>
<li>**幂等性 (Idempotency)**：这是此 Playbook 的核心优势。你可以安全地反复运行这个 Playbook。如果 MySQL 已经安装并正在运行，Ansible 会检查状态，发现一切正常，报告 <code>ok</code> 并跳过所有操作。这使得配置管理非常可靠。</li>
<li><strong>抽象与可移植性</strong>：<ul>
<li>我们使用了通用的 <code>ansible.builtin.package</code> 模块，它会自动适配目标系统的包管理器（在 Ubuntu 上用 <code>apt</code>，在 CentOS 上用 <code>dnf</code>&#x2F;<code>yum</code>）。</li>
<li>通过 <code>vars</code> 定义包名和服务名，如果你的目标机器是 CentOS 7&#x2F;8，你只需要将 <code>vars</code> 修改为 <code>mariadb-server</code> 和 <code>mariadb</code>，整个 Playbook 的逻辑都不用变。</li>
</ul>
</li>
<li><strong>Handlers 的使用</strong>：我们将“重启服务”的操作放在 <code>handlers</code> 块中，并通过 <code>notify</code> 来触发。这样做的好处是，只有在软件包<strong>确实被新安装或更新</strong>（任务状态为 <code>changed</code>）时，服务才会被重启。如果软件包本来就装好了，服务就不会被不必要地重启。这在生产环境中至关重要。</li>
<li>**条件判断 (When)**：<code>Update APT cache</code> 这个任务只针对 Debian&#x2F;Ubuntu 系统，因为 CentOS&#x2F;RHEL 不需要这个步骤。<code>when: ansible_os_family == &quot;Debian&quot;</code> 实现了精准的目标控制。</li>
</ul>
<p>这个 Playbook 虽然简单，但已经包含了编写高质量 Ansible 自动化任务的多个核心思想。在实际生产中，你还可以在此基础上增加<strong>安全配置</strong>（如运行 <code>mysql_secure_installation</code> 的等效任务）、<strong>创建数据库和用户</strong>、<strong>分发自定义配置文件</strong>等任务。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/ansible/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/ansible/" class="post-title-link" itemprop="url">Ansible基础架构</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:24:21" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/Ansible/" itemprop="url" rel="index"><span itemprop="name">Ansible</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h3 id="Ansible-基础架构"><a href="#Ansible-基础架构" class="headerlink" title="Ansible 基础架构"></a>Ansible 基础架构</h3><p>Ansible 的架构非常简洁和优雅，这是它广受欢迎的关键原因之一。其核心理念是 <strong>“无客户端”（Agentless）</strong>。</p>
<p>其架构主要由以下几个部分组成：</p>
<ol>
<li><p><strong>控制节点 (Control Node)</strong></p>
<ul>
<li><strong>定义：</strong> 任何安装了 Ansible 的机器都可以作为控制节点。你就是在这个节点上编写和执行 Ansible 命令和 Playbook 的。</li>
<li><strong>要求：</strong> 通常是一台 Linux 或 macOS 系统（Windows 可以通过 WSL 使用）。需要安装 Python。</li>
<li><strong>功能：</strong><ul>
<li>管理整个自动化任务的执行。</li>
<li>存储 Inventory、Playbooks 和 Roles。</li>
<li>通过 SSH（默认）或 WinRM（用于 Windows）连接到受管节点。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>受管节点 (Managed Nodes &#x2F; Target Hosts)</strong></p>
<ul>
<li><strong>定义：</strong> 被 Ansible 管理和配置的服务器或网络设备。这些是你希望执行自动化任务的目标机器。</li>
<li><strong>要求：</strong><ul>
<li><strong>Linux&#x2F;Unix 系统：</strong> 只需要 SSH 服务和 Python 环境。Ansible 会自动推送并执行所需的 Python 模块，然后删除，完全<strong>无需安装任何 Agent</strong>。</li>
<li><strong>Windows 系统：</strong> 需要开启 WinRM 服务，Ansible 通过它进行通信。</li>
</ul>
</li>
<li><strong>特点：</strong> 保持”干净”，无需维护额外的客户端软件，极大地降低了管理的复杂性和安全风险。</li>
</ul>
</li>
<li><p><strong>Inventory（资产清单）</strong></p>
<ul>
<li><strong>定义：</strong> 一个描述受管节点信息的文件。它告诉 Ansible，“你的管辖范围是哪些机器”。</li>
<li><strong>格式：</strong> 通常是 INI 或 YAML 格式。</li>
<li><strong>功能：</strong><ul>
<li>列出所有受管主机的 IP 地址或主机名。</li>
<li>对主机进行**分组 (groups)**，比如 <code>[webservers]</code>、<code>[databases]</code>。这使得你可以针对特定的一组机器执行任务。</li>
<li>可以定义主机变量（如特定主机的 SSH 端口、用户名）和组变量（如 <code>webservers</code> 组通用的配置参数）。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Modules（模块）</strong></p>
<ul>
<li><strong>定义：</strong> Ansible 的<strong>“工具箱”</strong>。每个模块都是一个独立的小程序，负责执行一个特定的任务，比如安装软件包 (<code>yum</code>&#x2F;<code>apt</code> 模块)、管理服务 (<code>service</code> 模块)、操作文件 (<code>copy</code>&#x2F;<code>file</code> 模块)等。</li>
<li><strong>特点：</strong><ul>
<li>Ansible 拥有数千个内置模块，覆盖了系统管理、云服务、网络设备等几乎所有场景。</li>
<li><strong>幂等性 (Idempotency)</strong> 是大多数模块的核心特性。这意味着一个操作执行一次和执行多次的效果是相同的。例如，用 <code>service</code> 模块确保一个服务是“启动”状态，如果它已经启动了，Ansible 就不会做任何事；如果没启动，才会去启动它。这让自动化任务非常安全和可预测。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Playbooks（剧本）</strong></p>
<ul>
<li><strong>定义：</strong> Ansible 的<strong>“编排语言”</strong>和<strong>“任务蓝图”</strong>。它是一个 YAML 格式的文件，用来定义一系列有序的任务（Tasks），以及这些任务应该在哪些主机上执行。</li>
<li><strong>功能：</strong><ul>
<li><strong>定义一个或多个“剧目 (Plays)”：</strong> 每个 Play 将一组主机（通过 <code>hosts:</code> 关键字指定）与一系列任务绑定。</li>
<li><strong>调用模块：</strong> 每个任务（Task）本质上就是对一个模块的调用。</li>
<li><strong>逻辑控制：</strong> 支持变量、循环、条件判断，以及通过 Handlers 实现事件驱动（如“配置文件变更后重启服务”）。</li>
<li><strong>编排复杂的流程：</strong> 可以定义多阶段、跨多组主机的复杂部署和配置流程。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Plugins（插件）</strong></p>
<ul>
<li><strong>定义：</strong> 用于扩展 Ansible 核心功能的代码。</li>
<li><strong>类型：</strong> 包括回调插件（<code>callback plugins</code>，用于自定义输出）、连接插件（<code>connection plugins</code>，如 <code>docker</code> 连接）等，提供了强大的扩展能力。</li>
</ul>
</li>
</ol>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>Ansible 的工作流程非常直观，可以分解为以下几个步骤：</p>
<ol>
<li><p><strong>解析命令&#x2F;Playbook：</strong></p>
<ul>
<li>用户在<strong>控制节点</strong>上执行一个 <code>ansible</code> 命令（用于临时任务）或 <code>ansible-playbook</code> 命令。</li>
<li>Ansible 首先会读取并解析指定的 Playbook（YAML 文件）。</li>
</ul>
</li>
<li><p><strong>读取 Inventory：</strong></p>
<ul>
<li>Ansible 根据 Playbook 中 <code>hosts:</code> 指令或命令行参数，去 Inventory 文件中查找目标主机。它会识别出所有匹配的主机 IP、分组和相关变量。</li>
</ul>
</li>
<li><p><strong>建立连接：</strong></p>
<ul>
<li>Ansible 通过 SSH（默认）或指定的连接插件，尝试与每一个目标<strong>受管节点</strong>建立连接。它会使用 Inventory 中定义的用户、密码或 SSH 密钥进行认证。</li>
</ul>
</li>
<li><p><strong>推送并执行模块：</strong></p>
<ul>
<li>这是 <strong>Agentless</strong> 的核心所在。对于每一个在 Playbook 中定义的 Task：<ul>
<li>Ansible 在控制节点上找到该任务所需的<strong>模块</strong>（一个 Python 文件）和参数。</li>
<li>它会将这个模块文件以及相关参数打包成一个临时的 Python 脚本。</li>
<li>通过已建立的 SSH 连接，将这个<strong>临时的 Python 脚本上传</strong>到受管节点的临时目录中（如 <code>~/.ansible/tmp/</code>）。</li>
<li>在受管节点上，通过 SSH <strong>执行这个 Python 脚本</strong> (<code>python /path/to/tmp/script.py</code>)。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>模块执行与返回结果：</strong></p>
<ul>
<li>在受管节点上，这个临时脚本开始执行真正的任务（比如调用 <code>yum</code> 命令）。</li>
<li>执行完成后，脚本会以 <strong>JSON 格式</strong>输出结果（包括是否成功、是否有变更、详细信息等）。</li>
<li>Ansible 在控制节点上通过 SSH 捕获这个 JSON 输出。</li>
</ul>
</li>
<li><p><strong>清理临时文件：</strong></p>
<ul>
<li>任务执行完毕后，Ansible 会自动删除在受管节点上创建的那个<strong>临时 Python 脚本</strong>。这就是为什么受管节点上不需要安装任何常驻进程的原因——它只是在需要时“借用”一下 Python 解释器。</li>
</ul>
</li>
<li><p><strong>处理结果与反馈：</strong></p>
<ul>
<li>控制节点解析收到的 JSON 结果，并根据结果更新任务状态（<code>ok</code>, <code>changed</code>, <code>failed</code>）。</li>
<li>它将结果输出到用户的终端，并根据 Playbook 的逻辑继续执行下一个任务、处理 Handler，或在失败时中止。</li>
</ul>
</li>
</ol>
<p>整个过程周而复始，直到 Playbook 中的所有任务都执行完毕。这种简单、安全且强大的工作模式，使其成为运维自动化领域的首选工具。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/14/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><span class="page-number current">15</span><a class="page-number" href="/page/16/">16</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/16/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">六一</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">273</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/huiaz" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;huiaz" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">六一</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.7m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">25:34</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true}});</script></body>
</html>
