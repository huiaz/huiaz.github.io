<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hui&#39;s Blog">
<meta property="og:url" content="http://example.com/page/20/index.html">
<meta property="og:site_name" content="Hui&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="六一">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/20/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hui's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hui's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Code Life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/mysql_backup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/mysql_backup/" class="post-title-link" itemprop="url">mysql_backup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:49:36" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/scripts/" itemprop="url" rel="index"><span itemprop="name">scripts</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/scripts/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Python-脚本，用于备份-MySQL-数据库。"><a href="#Python-脚本，用于备份-MySQL-数据库。" class="headerlink" title="Python 脚本，用于备份 MySQL 数据库。"></a>Python 脚本，用于备份 MySQL 数据库。</h3><h3 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h3><ol>
<li><strong>配置与代码分离</strong>: 不会将数据库密码、路径等敏感或易变信息硬编码在脚本里，而是使用一个单独的配置文件 <code>config.ini</code>。</li>
<li><strong>安全第一</strong>: 使用 MySQL 的标准认证文件 <code>.my.cnf</code> 来存储数据库凭证，避免在命令行或配置文件中出现明文密码。这是 <code>mysqldump</code> 工具推荐的最佳实践。</li>
<li><strong>日志记录</strong>: 详细记录脚本的每一次运行、成功、失败及错误信息，便于审计和排查问题。</li>
<li><strong>自动化压缩</strong>: 备份文件通常很大，脚本会自动使用 <code>gzip</code> 进行压缩，节省磁盘空间。</li>
<li><strong>备份轮转 (Rotation)</strong>: 自动删除旧的备份，只保留最近的 N 份，防止备份文件无限增长占满磁盘。</li>
<li><strong>健壮性</strong>: 脚本会检查必要的工具（如 <code>mysqldump</code>, <code>gzip</code>）是否存在，并提供清晰的错误处理。</li>
</ol>
<hr>
<h3 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h3><p>建议采用以下文件结构来组织你的备份脚本和配置：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/opt/mysql_backup/</span></span><br><span class="line">├── backup_mysql.py        <span class="comment"># 主程序脚本</span></span><br><span class="line">├── config.ini             <span class="comment"># 脚本的配置文件</span></span><br><span class="line">└── <span class="string">.my.cnf</span>                <span class="comment"># MySQL 认证文件 (权限需设为 600)</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="步骤-1-创建-MySQL-认证文件-my-cnf"><a href="#步骤-1-创建-MySQL-认证文件-my-cnf" class="headerlink" title="步骤 1: 创建 MySQL 认证文件 (.my.cnf)"></a>步骤 1: 创建 MySQL 认证文件 (<code>.my.cnf</code>)</h3><p>这个文件让 <code>mysqldump</code> 命令可以自动登录，无需在命令行中输入密码。</p>
<p><strong><code>/opt/mysql_backup/.my.cnf</code></strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqldump]</span></span><br><span class="line"><span class="attr">user</span> = your_backup_user</span><br><span class="line"><span class="attr">password</span> = <span class="string">&quot;Your_Very_Secure_Password&quot;</span></span><br><span class="line"><span class="attr">host</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">port</span> = <span class="number">3306</span></span><br></pre></td></tr></table></figure>

<p><strong>极其重要</strong>: 设置严格的文件权限，只有运行脚本的用户可以读写。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 600 /opt/mysql_backup/.my.cnf</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="步骤-2-创建脚本配置文件-config-ini"><a href="#步骤-2-创建脚本配置文件-config-ini" class="headerlink" title="步骤 2: 创建脚本配置文件 (config.ini)"></a>步骤 2: 创建脚本配置文件 (<code>config.ini</code>)</h3><p>这个文件控制脚本的行为。</p>
<p><strong><code>/opt/mysql_backup/config.ini</code></strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="comment"># 要备份的数据库名称，多个用逗号分隔</span></span><br><span class="line"><span class="comment"># 如果要备份所有数据库，使用 __ALL__</span></span><br><span class="line"><span class="attr">databases</span> = my_app_db,another_db</span><br><span class="line"></span><br><span class="line"><span class="section">[backup]</span></span><br><span class="line"><span class="comment"># 备份文件存储目录</span></span><br><span class="line"><span class="attr">backup_dir</span> = /data/backups/mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保留最近多少份备份</span></span><br><span class="line"><span class="attr">retention_days</span> = <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定 MySQL 认证文件的路径</span></span><br><span class="line"><span class="comment"># 这是我们上一步创建的 .my.cnf 文件</span></span><br><span class="line"><span class="attr">defaults_file</span> = /opt/mysql_backup/.my.cnf</span><br><span class="line"></span><br><span class="line"><span class="section">[logging]</span></span><br><span class="line"><span class="comment"># 日志文件路径</span></span><br><span class="line"><span class="attr">log_file</span> = /var/log/mysql_backup.log</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="步骤-3-编写-Python-备份脚本-backup-mysql-py"><a href="#步骤-3-编写-Python-备份脚本-backup-mysql-py" class="headerlink" title="步骤 3: 编写 Python 备份脚本 (backup_mysql.py)"></a>步骤 3: 编写 Python 备份脚本 (<code>backup_mysql.py</code>)</h3><p>这是核心的执行脚本。</p>
<p><strong><code>/opt/mysql_backup/backup_mysql.py</code></strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> configparser <span class="keyword">import</span> ConfigParser</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 配置区 ---</span></span><br><span class="line">CONFIG_FILE = os.path.join(os.path.dirname(os.path.abspath(__file__)), <span class="string">&#x27;config.ini&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logging</span>(<span class="params">log_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;配置日志记录器&quot;&quot;&quot;</span></span><br><span class="line">    logging.basicConfig(</span><br><span class="line">        level=logging.INFO,</span><br><span class="line">        <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>,</span><br><span class="line">        handlers=[</span><br><span class="line">            logging.FileHandler(log_file),</span><br><span class="line">            logging.StreamHandler(sys.stdout) <span class="comment"># 同时输出到控制台和文件</span></span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_config</span>(<span class="params">config_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;加载配置文件&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(config_path):</span><br><span class="line">        logging.error(<span class="string">f&quot;配置文件未找到: <span class="subst">&#123;config_path&#125;</span>&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    parser = ConfigParser()</span><br><span class="line">    parser.read(config_path)</span><br><span class="line">    <span class="keyword">return</span> parser</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_tools</span>(<span class="params">*tools</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检查必要的命令行工具是否存在&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> tool <span class="keyword">in</span> tools:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> shutil.which(tool):</span><br><span class="line">            logging.error(<span class="string">f&quot;必需工具未找到: <span class="subst">&#123;tool&#125;</span>。请确保它已安装并在系统 PATH 中。&quot;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rotate_backups</span>(<span class="params">backup_dir, retention_days</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;删除旧的备份文件&quot;&quot;&quot;</span></span><br><span class="line">    logging.info(<span class="string">f&quot;开始轮转备份，保留最近 <span class="subst">&#123;retention_days&#125;</span> 天的备份...&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        now = datetime.now()</span><br><span class="line">        cutoff = now - datetime.timedelta(days=retention_days)</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(backup_dir):</span><br><span class="line">            file_path = os.path.join(backup_dir, filename)</span><br><span class="line">            <span class="keyword">if</span> os.path.isfile(file_path):</span><br><span class="line">                file_mod_time = datetime.fromtimestamp(os.path.getmtime(file_path))</span><br><span class="line">                <span class="keyword">if</span> file_mod_time &lt; cutoff:</span><br><span class="line">                    logging.info(<span class="string">f&quot;删除旧备份: <span class="subst">&#123;filename&#125;</span>&quot;</span>)</span><br><span class="line">                    os.remove(file_path)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;备份轮转失败: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backup_database</span>(<span class="params">db_name, backup_dir, defaults_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;执行单个数据库的备份和压缩&quot;&quot;&quot;</span></span><br><span class="line">    timestamp = datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d_%H-%M-%S&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 特殊处理备份所有数据库的情况</span></span><br><span class="line">    <span class="keyword">if</span> db_name == <span class="string">&#x27;__ALL__&#x27;</span>:</span><br><span class="line">        backup_filename_base = <span class="string">f&quot;all-databases_<span class="subst">&#123;timestamp&#125;</span>.sql&quot;</span></span><br><span class="line">        db_option = <span class="string">&quot;--all-databases&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        backup_filename_base = <span class="string">f&quot;<span class="subst">&#123;db_name&#125;</span>_<span class="subst">&#123;timestamp&#125;</span>.sql&quot;</span></span><br><span class="line">        db_option = db_name</span><br><span class="line"></span><br><span class="line">    backup_filepath = os.path.join(backup_dir, <span class="string">f&quot;<span class="subst">&#123;backup_filename_base&#125;</span>.gz&quot;</span>)</span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">f&quot;开始备份数据库 &#x27;<span class="subst">&#123;db_option&#125;</span>&#x27; 到 <span class="subst">&#123;backup_filepath&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用管道将 mysqldump 的输出直接传给 gzip，高效且不产生中间文件</span></span><br><span class="line">    mysqldump_cmd = [</span><br><span class="line">        <span class="string">&#x27;mysqldump&#x27;</span>,</span><br><span class="line">        <span class="string">f&#x27;--defaults-extra-file=<span class="subst">&#123;defaults_file&#125;</span>&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--single-transaction&#x27;</span>,  <span class="comment"># 对InnoDB表进行一致性备份</span></span><br><span class="line">        <span class="string">&#x27;--routines&#x27;</span>,            <span class="comment"># 备份存储过程和函数</span></span><br><span class="line">        <span class="string">&#x27;--triggers&#x27;</span>,            <span class="comment"># 备份触发器</span></span><br><span class="line">        <span class="string">&#x27;--events&#x27;</span>,              <span class="comment"># 备份事件</span></span><br><span class="line">        db_option</span><br><span class="line">    ]</span><br><span class="line">    gzip_cmd = [<span class="string">&#x27;gzip&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 创建备份目录（如果不存在）</span></span><br><span class="line">        os.makedirs(backup_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(backup_filepath, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f_out:</span><br><span class="line">            p_dump = subprocess.Popen(mysqldump_cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">            p_gzip = subprocess.Popen(gzip_cmd, stdin=p_dump.stdout, stdout=f_out, stderr=subprocess.PIPE)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 等待 mysqldump 完成并将输出传递给 gzip</span></span><br><span class="line">            p_dump.stdout.close()</span><br><span class="line">          </span><br><span class="line">            <span class="comment"># 获取错误输出</span></span><br><span class="line">            dump_stderr = p_dump.stderr.read().decode()</span><br><span class="line">            gzip_stderr = p_gzip.stderr.read().decode()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 等待进程结束并检查返回码</span></span><br><span class="line">            p_dump.wait()</span><br><span class="line">            p_gzip.wait()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> p_dump.returncode != <span class="number">0</span>:</span><br><span class="line">                logging.error(<span class="string">f&quot;mysqldump 失败 (数据库: <span class="subst">&#123;db_option&#125;</span>). 返回码: <span class="subst">&#123;p_dump.returncode&#125;</span>&quot;</span>)</span><br><span class="line">                logging.error(<span class="string">f&quot;mysqldump 错误信息: <span class="subst">&#123;dump_stderr&#125;</span>&quot;</span>)</span><br><span class="line">                os.remove(backup_filepath) <span class="comment"># 删除不完整的备份文件</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> p_gzip.returncode != <span class="number">0</span>:</span><br><span class="line">                logging.error(<span class="string">f&quot;gzip 失败 (数据库: <span class="subst">&#123;db_option&#125;</span>). 返回码: <span class="subst">&#123;p_gzip.returncode&#125;</span>&quot;</span>)</span><br><span class="line">                logging.error(<span class="string">f&quot;gzip 错误信息: <span class="subst">&#123;gzip_stderr&#125;</span>&quot;</span>)</span><br><span class="line">                os.remove(backup_filepath)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        logging.info(<span class="string">f&quot;数据库 &#x27;<span class="subst">&#123;db_option&#125;</span>&#x27; 成功备份并压缩到 <span class="subst">&#123;backup_filepath&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;备份数据库 &#x27;<span class="subst">&#123;db_option&#125;</span>&#x27; 时发生意外错误: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主执行函数&quot;&quot;&quot;</span></span><br><span class="line">    config = load_config(CONFIG_FILE)</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 提取配置</span></span><br><span class="line">    log_file = config.get(<span class="string">&#x27;logging&#x27;</span>, <span class="string">&#x27;log_file&#x27;</span>, fallback=<span class="string">&#x27;/tmp/mysql_backup.log&#x27;</span>)</span><br><span class="line">    setup_logging(log_file)</span><br><span class="line">  </span><br><span class="line">    logging.info(<span class="string">&quot;=&quot;</span>*<span class="number">30</span>)</span><br><span class="line">    logging.info(<span class="string">&quot;MySQL 备份脚本启动&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">&quot;=&quot;</span>*<span class="number">30</span>)</span><br><span class="line">  </span><br><span class="line">    check_tools(<span class="string">&#x27;mysqldump&#x27;</span>, <span class="string">&#x27;gzip&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    databases_str = config.get(<span class="string">&#x27;mysql&#x27;</span>, <span class="string">&#x27;databases&#x27;</span>)</span><br><span class="line">    backup_dir = config.get(<span class="string">&#x27;backup&#x27;</span>, <span class="string">&#x27;backup_dir&#x27;</span>)</span><br><span class="line">    retention_days = config.getint(<span class="string">&#x27;backup&#x27;</span>, <span class="string">&#x27;retention_days&#x27;</span>)</span><br><span class="line">    defaults_file = config.get(<span class="string">&#x27;backup&#x27;</span>, <span class="string">&#x27;defaults_file&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> databases_str:</span><br><span class="line">        logging.error(<span class="string">&quot;配置文件中未指定要备份的数据库 [mysql] -&gt; databases。&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    databases_to_backup = [db.strip() <span class="keyword">for</span> db <span class="keyword">in</span> databases_str.split(<span class="string">&#x27;,&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">    all_success = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> db <span class="keyword">in</span> databases_to_backup:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> backup_database(db, backup_dir, defaults_file):</span><br><span class="line">            all_success = <span class="literal">False</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> all_success:</span><br><span class="line">        logging.info(<span class="string">&quot;所有指定的数据库备份任务成功完成。&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.error(<span class="string">&quot;部分数据库备份任务失败，请检查日志。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 执行备份轮转</span></span><br><span class="line">    rotate_backups(backup_dir, retention_days)</span><br><span class="line">  </span><br><span class="line">    logging.info(<span class="string">&quot;MySQL 备份脚本执行完毕。&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="步骤-4-设置定时任务-Cron-Job"><a href="#步骤-4-设置定时任务-Cron-Job" class="headerlink" title="步骤 4: 设置定时任务 (Cron Job)"></a>步骤 4: 设置定时任务 (Cron Job)</h3><p>最后，使用 <code>cron</code> 来让这个脚本每天定时运行，例如在凌晨3点。</p>
<ol>
<li><p>打开 crontab 编辑器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br></pre></td></tr></table></figure>
</li>
<li><p>在文件末尾添加一行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 每天凌晨 3:00 执行 MySQL 数据库备份</span><br><span class="line">0 3 * * * /usr/bin/python3 /opt/mysql_backup/backup_mysql.py</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>请确保 <code>/usr/bin/python3</code> 是你系统中 Python 3 解释器的正确路径（可以通过 <code>which python3</code> 命令查找）。</li>
<li><code>/opt/mysql_backup/backup_mysql.py</code> 是脚本的绝对路径。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/n9e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/n9e/" class="post-title-link" itemprop="url">n9e</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:49:59" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/n9e/" itemprop="url" rel="index"><span itemprop="name">n9e</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>7.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">n9e_v8</span></span><br><span class="line"></span><br><span class="line">7vfwNNFsGPAYcheujZUy  </span><br></pre></td></tr></table></figure>

<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">&quot;3.7&quot;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line"><span class="symbol">  mysql:</span></span><br><span class="line"><span class="symbol">    image:</span> <span class="string">&quot;mysql:8&quot;</span></span><br><span class="line"><span class="symbol">    container_name:</span> mysql</span><br><span class="line"><span class="symbol">    hostname:</span> mysql</span><br><span class="line"><span class="symbol">    restart:</span> always</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line"><span class="symbol">      TZ:</span> Asia/Shanghai</span><br><span class="line"><span class="symbol">      MYSQL_ROOT_PASSWORD:</span> <span class="number">1234</span></span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - ./mysqldata:<span class="keyword">/var/</span>lib<span class="keyword">/mysql/</span></span><br><span class="line">      - ../initsql:/docker-entrypoint-initdb.d/</span><br><span class="line">      - .<span class="keyword">/etc-mysql/</span>my.cnf:<span class="keyword">/etc/</span>my.cnf</span><br><span class="line"><span class="symbol">    network_mode:</span> host</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">  redis:</span></span><br><span class="line"><span class="symbol">    image:</span> <span class="string">&quot;redis:6.2&quot;</span></span><br><span class="line"><span class="symbol">    container_name:</span> redis</span><br><span class="line"><span class="symbol">    hostname:</span> redis</span><br><span class="line"><span class="symbol">    restart:</span> always</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line"><span class="symbol">      TZ:</span> Asia/Shanghai</span><br><span class="line"><span class="symbol">    network_mode:</span> host</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">  prometheus:</span></span><br><span class="line"><span class="symbol">    image:</span> prom/prometheus:v2<span class="number">.55</span><span class="number">.1</span></span><br><span class="line"><span class="symbol">    container_name:</span> prometheus</span><br><span class="line"><span class="symbol">    hostname:</span> prometheus</span><br><span class="line"><span class="symbol">    restart:</span> always</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line"><span class="symbol">      TZ:</span> Asia/Shanghai</span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - ./etc-prometheus:<span class="keyword">/etc/</span>prometheus</span><br><span class="line"><span class="symbol">    network_mode:</span> host</span><br><span class="line"><span class="symbol">    command:</span></span><br><span class="line">      - <span class="string">&quot;--config.file=/etc/prometheus/prometheus.yml&quot;</span></span><br><span class="line">      - <span class="string">&quot;--storage.tsdb.path=/prometheus&quot;</span></span><br><span class="line">      - <span class="string">&quot;--web.console.libraries=/usr/share/prometheus/console_libraries&quot;</span></span><br><span class="line">      - <span class="string">&quot;--web.console.templates=/usr/share/prometheus/consoles&quot;</span></span><br><span class="line">      - <span class="string">&quot;--enable-feature=remote-write-receiver&quot;</span></span><br><span class="line">      - <span class="string">&quot;--query.lookback-delta=2m&quot;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">  n9e:</span></span><br><span class="line"><span class="symbol">    image:</span> flashcatcloud/nightingale:latest</span><br><span class="line"><span class="symbol">    container_name:</span> n9e</span><br><span class="line"><span class="symbol">    hostname:</span> n9e</span><br><span class="line"><span class="symbol">    restart:</span> always</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line"><span class="symbol">      GIN_MODE:</span> release</span><br><span class="line"><span class="symbol">      TZ:</span> Asia/Shanghai</span><br><span class="line"><span class="symbol">      WAIT_HOSTS:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span>, <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span></span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - ./etc-nightingale:<span class="keyword">/app/</span>etc</span><br><span class="line"><span class="symbol">    network_mode:</span> host</span><br><span class="line"><span class="symbol">    depends_on:</span></span><br><span class="line">      - mysql</span><br><span class="line">      - redis</span><br><span class="line">      - prometheus</span><br><span class="line"><span class="symbol">    command:</span> &gt;</span><br><span class="line">      sh -c <span class="string">&quot;/app/n9e&quot;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">  categraf:</span></span><br><span class="line"><span class="symbol">    image:</span> <span class="string">&quot;flashcatcloud/categraf:latest&quot;</span></span><br><span class="line"><span class="symbol">    container_name:</span> <span class="string">&quot;categraf&quot;</span></span><br><span class="line"><span class="symbol">    hostname:</span> <span class="string">&quot;categraf01&quot;</span></span><br><span class="line"><span class="symbol">    restart:</span> always</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line"><span class="symbol">      TZ:</span> Asia/Shanghai</span><br><span class="line"><span class="symbol">      HOST_PROC:</span> <span class="keyword">/hostfs/</span>proc</span><br><span class="line"><span class="symbol">      HOST_SYS:</span> <span class="keyword">/hostfs/</span>sys</span><br><span class="line"><span class="symbol">      HOST_MOUNT_PREFIX:</span> /hostfs</span><br><span class="line"><span class="symbol">      WAIT_HOSTS:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">17000</span>, <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">20090</span></span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - ./etc-categraf:<span class="keyword">/etc/</span>categraf/conf</span><br><span class="line">      - /:/hostfs</span><br><span class="line"><span class="symbol">    network_mode:</span> host</span><br><span class="line"><span class="symbol">    depends_on:</span></span><br><span class="line">      - n9e</span><br></pre></td></tr></table></figure>

<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">&quot;3.7&quot;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line"><span class="symbol">  n9e:</span></span><br><span class="line"><span class="symbol">    image:</span> muduregistry.tencentcloudcr.com<span class="keyword">/ops/</span>nightingale:v8<span class="number">.0</span><span class="number">.0</span>-beta<span class="number">.14</span></span><br><span class="line"><span class="symbol">    container_name:</span> n9e</span><br><span class="line"><span class="symbol">    hostname:</span> n9e</span><br><span class="line"><span class="symbol">    restart:</span> always</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line"><span class="symbol">      GIN_MODE:</span> release</span><br><span class="line"><span class="symbol">      TZ:</span> Asia/Shanghai</span><br><span class="line"><span class="symbol">      WAIT_HOSTS:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span>, <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span></span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - ./etc-nightingale:<span class="keyword">/app/</span>etc</span><br><span class="line"><span class="symbol">    network_mode:</span> host</span><br><span class="line"><span class="symbol">    command:</span> &gt;</span><br><span class="line">      sh -c <span class="string">&quot;/app/n9e&quot;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">  categraf:</span></span><br><span class="line"><span class="symbol">    image:</span> <span class="string">&quot;muduregistry.tencentcloudcr.com/ops/categraf:v0.4.12&quot;</span></span><br><span class="line"><span class="symbol">    container_name:</span> <span class="string">&quot;categraf&quot;</span></span><br><span class="line"><span class="symbol">    hostname:</span> <span class="string">&quot;categraf01&quot;</span></span><br><span class="line"><span class="symbol">    restart:</span> always</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line"><span class="symbol">      TZ:</span> Asia/Shanghai</span><br><span class="line"><span class="symbol">      HOST_PROC:</span> <span class="keyword">/hostfs/</span>proc</span><br><span class="line"><span class="symbol">      HOST_SYS:</span> <span class="keyword">/hostfs/</span>sys</span><br><span class="line"><span class="symbol">      HOST_MOUNT_PREFIX:</span> /hostfs</span><br><span class="line"><span class="symbol">      WAIT_HOSTS:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">17000</span>, <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">20090</span></span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - ./etc-categraf:<span class="keyword">/etc/</span>categraf/conf</span><br><span class="line">      - /:/hostfs</span><br><span class="line"><span class="symbol">    network_mode:</span> host</span><br><span class="line"><span class="symbol">    depends_on:</span></span><br><span class="line">      - n9e</span><br></pre></td></tr></table></figure>



<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[Global]</span></span><br><span class="line"><span class="attr">RunMode</span> = <span class="string">&quot;release&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Log]</span></span><br><span class="line"><span class="comment"># log write dir</span></span><br><span class="line"><span class="attr">Dir</span> = <span class="string">&quot;logs&quot;</span></span><br><span class="line"><span class="comment"># log level: DEBUG INFO WARNING ERROR</span></span><br><span class="line"><span class="attr">Level</span> = <span class="string">&quot;INFO&quot;</span></span><br><span class="line"><span class="comment"># stdout, stderr, file</span></span><br><span class="line"><span class="attr">Output</span> = <span class="string">&quot;stdout&quot;</span></span><br><span class="line"><span class="comment"># # rotate by time</span></span><br><span class="line"><span class="comment"># KeepHours = 4</span></span><br><span class="line"><span class="comment"># # rotate by size</span></span><br><span class="line"><span class="comment"># RotateNum = 3</span></span><br><span class="line"><span class="comment"># # unit: MB</span></span><br><span class="line"><span class="comment"># RotateSize = 256</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[HTTP]</span></span><br><span class="line"><span class="comment"># http listening address</span></span><br><span class="line"><span class="attr">Host</span> = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="comment"># http listening port</span></span><br><span class="line"><span class="attr">Port</span> = <span class="string">17000</span></span><br><span class="line"><span class="comment"># https cert file path</span></span><br><span class="line"><span class="attr">CertFile</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># https key file path</span></span><br><span class="line"><span class="attr">KeyFile</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># whether print access log</span></span><br><span class="line"><span class="attr">PrintAccessLog</span> = <span class="string">false</span></span><br><span class="line"><span class="comment"># whether enable pprof</span></span><br><span class="line"><span class="attr">PProf</span> = <span class="string">false</span></span><br><span class="line"><span class="comment"># expose prometheus /metrics?</span></span><br><span class="line"><span class="attr">ExposeMetrics</span> = <span class="string">true</span></span><br><span class="line"><span class="comment"># http graceful shutdown timeout, unit: s</span></span><br><span class="line"><span class="attr">ShutdownTimeout</span> = <span class="string">30</span></span><br><span class="line"><span class="comment"># max content length: 64M</span></span><br><span class="line"><span class="attr">MaxContentLength</span> = <span class="string">67108864</span></span><br><span class="line"><span class="comment"># http server read timeout, unit: s</span></span><br><span class="line"><span class="attr">ReadTimeout</span> = <span class="string">20</span></span><br><span class="line"><span class="comment"># http server write timeout, unit: s</span></span><br><span class="line"><span class="attr">WriteTimeout</span> = <span class="string">40</span></span><br><span class="line"><span class="comment"># http server idle timeout, unit: s</span></span><br><span class="line"><span class="attr">IdleTimeout</span> = <span class="string">120</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[HTTP.ShowCaptcha]</span></span><br><span class="line"><span class="attr">Enable</span> = <span class="string">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[HTTP.APIForAgent]</span></span><br><span class="line"><span class="attr">Enable</span> = <span class="string">true</span></span><br><span class="line"><span class="comment"># [HTTP.APIForAgent.BasicAuth]</span></span><br><span class="line"><span class="comment"># user001 = &quot;ccc26da7b9aba533cbb263a36c07dcc5&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[HTTP.APIForService]</span></span><br><span class="line"><span class="attr">Enable</span> = <span class="string">false</span></span><br><span class="line"><span class="attr">[HTTP.APIForService.BasicAuth]</span></span><br><span class="line"><span class="attr">user001</span> = <span class="string">&quot;ccc26da7b9aba533cbb263a36c07dcc5&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[HTTP.JWTAuth]</span></span><br><span class="line"><span class="comment"># unit: min</span></span><br><span class="line"><span class="attr">AccessExpired</span> = <span class="string">1500</span></span><br><span class="line"><span class="comment"># unit: min</span></span><br><span class="line"><span class="attr">RefreshExpired</span> = <span class="string">10080</span></span><br><span class="line"><span class="attr">RedisKeyPrefix</span> = <span class="string">&quot;/jwt/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[HTTP.ProxyAuth]</span></span><br><span class="line"><span class="comment"># if proxy auth enabled, jwt auth is disabled</span></span><br><span class="line"><span class="attr">Enable</span> = <span class="string">false</span></span><br><span class="line"><span class="comment"># username key in http proxy header</span></span><br><span class="line"><span class="attr">HeaderUserNameKey</span> = <span class="string">&quot;X-User-Name&quot;</span></span><br><span class="line"><span class="attr">DefaultRoles</span> = <span class="string">[&quot;Standard&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[HTTP.RSA]</span></span><br><span class="line"><span class="comment"># open RSA</span></span><br><span class="line"><span class="attr">OpenRSA</span> = <span class="string">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[DB]</span></span><br><span class="line"><span class="comment"># postgres: host=%s port=%s user=%s dbname=%s password=%s sslmode=%s</span></span><br><span class="line"><span class="comment"># postgres: DSN=&quot;host=127.0.0.1 port=5432 user=root dbname=n9e_v6 password=1234 sslmode=disable&quot;</span></span><br><span class="line"><span class="attr">DSN</span>=<span class="string">&quot;n9e_v8:7vfwNNFsGPAYcheujZUy@tcp(10.10.4.15:3306)/n9e_v8?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&amp;allowNativePasswords=true&quot;</span></span><br><span class="line"><span class="comment"># enable debug mode or not</span></span><br><span class="line"><span class="attr">Debug</span> = <span class="string">false</span></span><br><span class="line"><span class="comment"># mysql postgres</span></span><br><span class="line"><span class="attr">DBType</span> = <span class="string">&quot;mysql&quot;</span></span><br><span class="line"><span class="comment"># unit: s</span></span><br><span class="line"><span class="attr">MaxLifetime</span> = <span class="string">7200</span></span><br><span class="line"><span class="comment"># max open connections</span></span><br><span class="line"><span class="attr">MaxOpenConns</span> = <span class="string">150</span></span><br><span class="line"><span class="comment"># max idle connections</span></span><br><span class="line"><span class="attr">MaxIdleConns</span> = <span class="string">50</span></span><br><span class="line"><span class="comment"># enable auto migrate or not</span></span><br><span class="line"><span class="comment"># EnableAutoMigrate = false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Redis]</span></span><br><span class="line"><span class="comment"># address, ip:port or ip1:port,ip2:port for cluster and sentinel(SentinelAddrs)</span></span><br><span class="line"><span class="attr">Address</span> = <span class="string">&quot;10.10.4.113:6379&quot;</span></span><br><span class="line"><span class="attr">Username</span> = <span class="string">&quot;n9e&quot;</span></span><br><span class="line"><span class="attr">Password</span> = <span class="string">&quot;ReNt9qRtYmYnsgxH94Rr&quot;</span></span><br><span class="line"><span class="attr">DB</span> = <span class="string">8</span></span><br><span class="line"><span class="comment"># UseTLS = false</span></span><br><span class="line"><span class="comment"># TLSMinVersion = &quot;1.2&quot;</span></span><br><span class="line"><span class="comment"># standalone cluster sentinel</span></span><br><span class="line"><span class="attr">RedisType</span> = <span class="string">&quot;standalone&quot;</span></span><br><span class="line"><span class="comment"># Mastername for sentinel type</span></span><br><span class="line"><span class="comment"># MasterName = &quot;mymaster&quot;</span></span><br><span class="line"><span class="comment"># SentinelUsername = &quot;&quot;</span></span><br><span class="line"><span class="comment"># SentinelPassword = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Alert]</span></span><br><span class="line"><span class="attr">[Alert.Heartbeat]</span></span><br><span class="line"><span class="comment"># auto detect if blank</span></span><br><span class="line"><span class="attr">IP</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># unit ms</span></span><br><span class="line"><span class="attr">Interval</span> = <span class="string">1000</span></span><br><span class="line"><span class="attr">EngineName</span> = <span class="string">&quot;default&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># [Alert.Alerting]</span></span><br><span class="line"><span class="comment"># NotifyConcurrency = 10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Center]</span></span><br><span class="line"><span class="attr">MetricsYamlFile</span> = <span class="string">&quot;./etc/metrics.yaml&quot;</span></span><br><span class="line"><span class="attr">I18NHeaderKey</span> = <span class="string">&quot;X-Language&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Center.AnonymousAccess]</span></span><br><span class="line"><span class="attr">PromQuerier</span> = <span class="string">true</span></span><br><span class="line"><span class="attr">AlertDetail</span> = <span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Pushgw]</span></span><br><span class="line"><span class="comment"># use target labels in database instead of in series</span></span><br><span class="line"><span class="attr">LabelRewrite</span> = <span class="string">true</span></span><br><span class="line"><span class="attr">ForceUseServerTS</span> = <span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># [Pushgw.DebugSample]</span></span><br><span class="line"><span class="comment"># ident = &quot;xx&quot;</span></span><br><span class="line"><span class="comment"># __name__ = &quot;xx&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># [Pushgw.WriterOpt]</span></span><br><span class="line"><span class="comment"># QueueMaxSize = 1000000</span></span><br><span class="line"><span class="comment"># QueuePopSize = 1000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[[Pushgw.Writers]]</span></span><br><span class="line"><span class="comment"># Url = &quot;http://127.0.0.1:8480/insert/0/prometheus/api/v1/write&quot;</span></span><br><span class="line"><span class="attr">Url</span> = <span class="string">&quot;http://127.0.0.1:9090/api/v1/write&quot;</span></span><br><span class="line"><span class="comment"># Basic auth username</span></span><br><span class="line"><span class="attr">BasicAuthUser</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># Basic auth password</span></span><br><span class="line"><span class="attr">BasicAuthPass</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># timeout settings, unit: ms</span></span><br><span class="line"><span class="attr">Headers</span> = <span class="string">[&quot;X-From&quot;, &quot;n9e&quot;]</span></span><br><span class="line"><span class="attr">Timeout</span> = <span class="string">10000</span></span><br><span class="line"><span class="attr">DialTimeout</span> = <span class="string">3000</span></span><br><span class="line"><span class="attr">TLSHandshakeTimeout</span> = <span class="string">30000</span></span><br><span class="line"><span class="attr">ExpectContinueTimeout</span> = <span class="string">1000</span></span><br><span class="line"><span class="attr">IdleConnTimeout</span> = <span class="string">90000</span></span><br><span class="line"><span class="comment"># time duration, unit: ms</span></span><br><span class="line"><span class="attr">KeepAlive</span> = <span class="string">30000</span></span><br><span class="line"><span class="attr">MaxConnsPerHost</span> = <span class="string">0</span></span><br><span class="line"><span class="attr">MaxIdleConns</span> = <span class="string">100</span></span><br><span class="line"><span class="attr">MaxIdleConnsPerHost</span> = <span class="string">100</span></span><br><span class="line"><span class="comment">## Optional TLS Config</span></span><br><span class="line"><span class="comment"># UseTLS = false</span></span><br><span class="line"><span class="comment"># TLSCA = &quot;/etc/n9e/ca.pem&quot;</span></span><br><span class="line"><span class="comment"># TLSCert = &quot;/etc/n9e/cert.pem&quot;</span></span><br><span class="line"><span class="comment"># TLSKey = &quot;/etc/n9e/key.pem&quot;</span></span><br><span class="line"><span class="comment"># InsecureSkipVerify = false</span></span><br><span class="line"><span class="comment"># [[Writers.WriteRelabels]]</span></span><br><span class="line"><span class="comment"># Action = &quot;replace&quot;</span></span><br><span class="line"><span class="comment"># SourceLabels = [&quot;__address__&quot;]</span></span><br><span class="line"><span class="comment"># Regex = &quot;([^:]+)(?::\\d+)?&quot;</span></span><br><span class="line"><span class="comment"># Replacement = &quot;$1:80&quot;</span></span><br><span class="line"><span class="comment"># TargetLabel = &quot;__address__&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[Ibex]</span></span><br><span class="line"><span class="attr">Enable</span> = <span class="string">true</span></span><br><span class="line"><span class="attr">RPCListen</span> = <span class="string">&quot;0.0.0.0:20090&quot;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">      <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">      <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">      <span class="attribute">server_name</span>  n9e.mudutv.com;</span><br><span class="line">      <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/mudutv.com2024.pem;  <span class="comment">#需要将cert-file-name.pem替换成已上传的证书文件的名称。</span></span><br><span class="line">      <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/mudutv.com2024.key; <span class="comment">#需要将cert-file-name.key替换成已上传的证书密钥文件的名称。</span></span><br><span class="line">      <span class="attribute">ssl_session_timeout</span> <span class="number">5m</span>;</span><br><span class="line">      <span class="attribute">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class="line">      <span class="comment">#表示使用的加密套件的类型。</span></span><br><span class="line">      <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>; <span class="comment">#表示使用的TLS协议的类型。</span></span><br><span class="line">      <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">   	 	<span class="comment"># Proxy Grafana Live WebSocket connections.</span></span><br><span class="line">    	<span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="variable">$connection_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:17000;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/new&make/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/new&make/" class="post-title-link" itemprop="url">new&make</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:50:13" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><code>make</code> 和 <code>new</code> 是 Go 语言中两个非常重要但又容易混淆的内置函数，它们都与内存分配有关。深入理解它们的区别是掌握 Go 内存管理和数据结构使用的关键。</p>
<p>让我们来详细分解它们：</p>
<h3 id="1-new-函数"><a href="#1-new-函数" class="headerlink" title="1. new() 函数"></a>1. <code>new()</code> 函数</h3><ul>
<li><strong>用途：</strong> <code>new()</code> 函数用于<strong>为指定类型分配内存，并返回一个指向该类型零值的指针。</strong></li>
<li><strong>语法：</strong> <code>new(Type)</code><ul>
<li><code>Type</code> 是你想要分配内存的类型（例如 <code>int</code>, <code>string</code>, <code>struct</code>, <code>array</code> 等）。</li>
</ul>
</li>
<li><strong>返回值：</strong> 返回类型 <code>*Type</code>，即一个指向 <code>Type</code> 类型零值的指针。</li>
<li><strong>分配什么？</strong><ul>
<li><code>new</code> 分配的是内存空间，用于存储该类型的一个实例。</li>
<li>分配的内存会被初始化为该类型的<strong>零值</strong>：<ul>
<li>数值类型 (int, float): <code>0</code></li>
<li>布尔类型 (bool): <code>false</code></li>
<li>字符串类型 (string): <code>&quot;&quot;</code></li>
<li>指针类型 (<code>*Type</code>): <code>nil</code></li>
<li>结构体类型 (<code>struct</code>): 其所有成员都会被初始化为各自的零值。</li>
<li>数组类型 (<code>array</code>): 其所有元素都会被初始化为各自的零值。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>示例：</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 为一个 int 类型分配内存，并返回指向其零值(0)的指针</span></span><br><span class="line">	pInt := <span class="built_in">new</span>(<span class="type">int</span>)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;pInt 的类型: %T, 值为: %v, 指向的值: %d\n&quot;</span>, pInt, pInt, *pInt) </span><br><span class="line">	<span class="comment">// Output: pInt 的类型: *int, 值为: 0x..., 指向的值: 0</span></span><br><span class="line"></span><br><span class="line">	*pInt = <span class="number">42</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;修改后 pInt 指向的值: %d\n&quot;</span>, *pInt) </span><br><span class="line">	<span class="comment">// Output: 修改后 pInt 指向的值: 42</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 为一个 Student 结构体分配内存，并返回指向其零值实例的指针</span></span><br><span class="line">	<span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">		Name <span class="type">string</span></span><br><span class="line">		Age  <span class="type">int</span></span><br><span class="line">	&#125;</span><br><span class="line">	pStudent := <span class="built_in">new</span>(Student)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;pStudent 的类型: %T, 值为: %v, 指向的值: %+v\n&quot;</span>, pStudent, pStudent, *pStudent) </span><br><span class="line">	<span class="comment">// Output: pStudent 的类型: *main.Student, 值为: 0x..., 指向的值: &#123;Name: Age:0&#125;</span></span><br><span class="line"></span><br><span class="line">	pStudent.Name = <span class="string">&quot;Alice&quot;</span></span><br><span class="line">	pStudent.Age = <span class="number">20</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;修改后 pStudent 指向的值: %+v\n&quot;</span>, *pStudent) </span><br><span class="line">	<span class="comment">// Output: 修改后 pStudent 指向的值: &#123;Name:Alice Age:20&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// new 也可以用于数组，但返回的是指向完整数组的指针，通常不这么用</span></span><br><span class="line">	pArr := <span class="built_in">new</span>([<span class="number">5</span>]<span class="type">int</span>)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;pArr 的类型: %T, 值为: %v, 指向的值: %v\n&quot;</span>, pArr, pArr, *pArr)</span><br><span class="line">	<span class="comment">// Output: pArr 的类型: *[5]int, 值为: 0x..., 指向的值: [0 0 0 0 0]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-make-函数"><a href="#2-make-函数" class="headerlink" title="2. make() 函数"></a>2. <code>make()</code> 函数</h3><ul>
<li><strong>用途：</strong> <code>make()</code> 函数用于<strong>创建切片 (slice)、映射 (map) 和通道 (channel) 这三种内置引用类型，并进行初始化。</strong> 它不仅仅是分配内存，还会初始化这些数据结构，使其能立即使用。</li>
<li><strong>语法：</strong><ul>
<li>切片: <code>make(type, length, capacity)</code> 或 <code>make(type, length)</code></li>
<li>映射: <code>make(type, capacity)</code> 或 <code>make(type)</code></li>
<li>通道: <code>make(type, capacity)</code> 或 <code>make(type)</code></li>
</ul>
</li>
<li><strong>返回值：</strong> 返回的是一个<strong>已初始化且可用的对应类型的值</strong>（不是指针）。</li>
<li><strong>分配什么？</strong><ul>
<li><code>make</code> 除了分配底层数据所需的内存外，还会初始化其内部数据结构（例如，切片的长度、容量和指向底层数组的指针；映射的哈希表结构；通道的缓存区和同步机制）。</li>
<li><code>make</code> 创建的这些类型（切片、映射、通道）本身就是引用类型Header，它们内部包含指向底层数据的指针。因此，当你在函数间传递这些类型时，它们的行为类似于指针，传递的是对同一底层数据的引用。</li>
</ul>
</li>
</ul>
<p><strong>示例：</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建一个长度为5，容量为5的 int 切片</span></span><br><span class="line">	mySlice := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">5</span>)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;mySlice 的类型: %T, 值为: %v, 长度: %d, 容量: %d\n&quot;</span>, mySlice, mySlice, <span class="built_in">len</span>(mySlice), <span class="built_in">cap</span>(mySlice))</span><br><span class="line">	<span class="comment">// Output: mySlice 的类型: []int, 值为: [0 0 0 0 0], 长度: 5, 容量: 5</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个长度为0，容量为10的 int 切片</span></span><br><span class="line">	mySlice2 := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;mySlice2 的类型: %T, 值为: %v, 长度: %d, 容量: %d\n&quot;</span>, mySlice2, mySlice2, <span class="built_in">len</span>(mySlice2), <span class="built_in">cap</span>(mySlice2))</span><br><span class="line">	<span class="comment">// Output: mySlice2 的类型: []int, 值为: [], 长度: 0, 容量: 10</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个 string 到 int 的映射</span></span><br><span class="line">	myMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;myMap 的类型: %T, 值为: %v, 长度: %d\n&quot;</span>, myMap, myMap, <span class="built_in">len</span>(myMap))</span><br><span class="line">	<span class="comment">// Output: myMap 的类型: map[string]int, 值为: map[], 长度: 0</span></span><br><span class="line"></span><br><span class="line">	myMap[<span class="string">&quot;apple&quot;</span>] = <span class="number">1</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;myMap 修改后: %v\n&quot;</span>, myMap)</span><br><span class="line">	<span class="comment">// Output: myMap 修改后: map[apple:1]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个容量为3的 int 通道</span></span><br><span class="line">	myChannel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">3</span>)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;myChannel 的类型: %T, 值为: %v\n&quot;</span>, myChannel, myChannel)</span><br><span class="line">	<span class="comment">// Output: myChannel 的类型: chan int, 值为: 0x... (某个地址)</span></span><br><span class="line"></span><br><span class="line">	myChannel &lt;- <span class="number">1</span></span><br><span class="line">	myChannel &lt;- <span class="number">2</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;myChannel 元素数量: %d\n&quot;</span>, <span class="built_in">len</span>(myChannel))</span><br><span class="line">	<span class="comment">// Output: myChannel 元素数量: 2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="new-和-make-的核心区别总结"><a href="#new-和-make-的核心区别总结" class="headerlink" title="new 和 make 的核心区别总结"></a><code>new</code> 和 <code>make</code> 的核心区别总结</h3><table>
<thead>
<tr>
<th align="left">特征</th>
<th align="left"><code>new()</code></th>
<th align="left"><code>make()</code></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>用途</strong></td>
<td align="left">仅用于分配内存，并初始化为零值。</td>
<td align="left">用于创建并初始化切片、映射、通道这三种特殊引用类型。</td>
</tr>
<tr>
<td align="left"><strong>处理类型</strong></td>
<td align="left">任何类型 (<code>int</code>, <code>string</code>, <code>struct</code>, <code>array</code>, <code>pointer</code>, etc.)</td>
<td align="left">仅限切片 (<code>[]Type</code>), 映射 (<code>map</code>), 通道 (<code>chan</code>)</td>
</tr>
<tr>
<td align="left"><strong>返回值</strong></td>
<td align="left"><strong>指向零值的指针</strong> (<code>*Type</code>)</td>
<td align="left"><strong>已初始化且可用的类型值本身</strong>（非指针，但这些类型内部包含指针）</td>
</tr>
<tr>
<td align="left"><strong>功能</strong></td>
<td align="left">分配内存，置零。</td>
<td align="left">分配内存，并初始化内部数据结构使其可以立即使用（如设置切片长度&#x2F;容量，初始化哈希表，创建通道缓冲区）。</td>
</tr>
<tr>
<td align="left"><strong>常见场景</strong></td>
<td align="left">获取任何类型变量的指针，尤其是在需要在堆上分配变量时。</td>
<td align="left">创建集合类型（切片、映射）和并发同步原语（通道）。</td>
</tr>
</tbody></table>
<h3 id="什么时候使用哪个？"><a href="#什么时候使用哪个？" class="headerlink" title="什么时候使用哪个？"></a>什么时候使用哪个？</h3><ul>
<li><p><strong>使用 <code>new</code>：</strong></p>
<ul>
<li>当你需要一个变量的<strong>指针</strong>，并且希望它被初始化为其类型的零值时。</li>
<li>当你需要在堆上明确地分配一个变量的内存，并获得其地址时（尽管 Go 的 GC 使得直接考虑堆栈分配不那么重要，但 <code>new</code> 明确表示新内存分配）。</li>
<li>例如：<code>p := new(MyStruct)</code></li>
</ul>
</li>
<li><p><strong>使用 <code>make</code>：</strong></p>
<ul>
<li>当你需要创建<strong>切片、映射或通道</strong>时。这是创建这些内置引用类型的唯一正确方式。</li>
<li>你通常不应该使用 <code>new([]int)</code> 来创建切片，因为它只会返回一个指向 <code>nil</code> 切片头的指针，而不会初始化底层数组，导致无法使用。</li>
<li>例如：<code>s := make([]int, 10)</code>, <code>m := make(map[string]int)</code>, <code>c := make(chan int)</code></li>
</ul>
</li>
</ul>
<p>理解了 <code>make</code> 和 <code>new</code> 的这些根本区别，您将能更自信、更高效地在 Go 语言中进行内存管理和数据结构的操作。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/nginx%20%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/nginx%20%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/" class="post-title-link" itemprop="url">nginx 动静分离</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:50:44" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WEB/" itemprop="url" rel="index"><span itemprop="name">WEB</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WEB/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="什么是动静分离？"><a href="#什么是动静分离？" class="headerlink" title="什么是动静分离？"></a>什么是动静分离？</h3><p><strong>动静分离</strong>是一种 Web 架构优化技术，其核心思想是将网站的动态内容和静态内容分离开来，由不同的服务器或服务进行处理。</p>
<ul>
<li><strong>动态内容：</strong> 指的是需要服务器端程序（如 PHP, Java, Python, Node.js 等）处理，从数据库中查询数据，经过业务逻辑计算后才能生成的响应。例如：用户登录页面、购物车、文章详情页（需要查询数据库）、API 接口等。这些内容通常会频繁变化，且生成成本较高。</li>
<li><strong>静态内容：</strong> 指的是不需要服务器端程序处理，可以直接从文件系统读取并返回给客户端的文件。例如：HTML 页面、CSS 样式表、JavaScript 脚本、图片、字体文件、视频等。这些内容通常不经常变化，且生成成本为零。</li>
</ul>
<h3 id="为什么要实现动静分离？"><a href="#为什么要实现动静分离？" class="headerlink" title="为什么要实现动静分离？"></a>为什么要实现动静分离？</h3><ol>
<li><p><strong>提高系统性能：</strong></p>
<ul>
<li><strong>专业化处理：</strong> Nginx 非常擅长高效地处理静态文件（高性能 Web 服务器）。将静态内容交给 Nginx 直接处理，可以减轻后端应用服务器的压力，让后端服务器专注于处理复杂的动态业务逻辑。</li>
<li><strong>减少资源消耗：</strong> 动态请求需要更多 CPU、内存和数据库资源。将这部分请求和静态请求分离，可以避免应用服务器因为处理大量静态请求而资源耗尽，从而提高动态请求的响应速度。</li>
<li><strong>充分利用缓存：</strong> 静态文件可以被 Nginx 和浏览器长时间缓存，极大地减少了重复请求和传输，进一步提高性能。</li>
</ul>
</li>
<li><p><strong>提高系统可用性和稳定性：</strong></p>
<ul>
<li><strong>故障隔离：</strong> 如果动态应用服务器出现故障，Nginx 仍然可以正常提供静态资源（如错误页面），避免整个网站完全瘫痪。</li>
<li><strong>弹性伸缩：</strong> 静态资源通常更容易扩容，可以通过 CDN 或多台 Nginx 服务器轻松应对高并发。动态服务器可以独立地进行扩容和维护。</li>
</ul>
</li>
<li><p><strong>提高安全性：</strong></p>
<ul>
<li>将敏感的动态应用服务器与公共网络隔离开来，仅通过 Nginx 暴露必要的端口，可以降低安全风险。</li>
</ul>
</li>
</ol>
<h3 id="动静分离的原理"><a href="#动静分离的原理" class="headerlink" title="动静分离的原理"></a>动静分离的原理</h3><p>动静分离的原理非常简单明了，主要依赖于 Nginx 的<strong>基于 URL 路径匹配和代理转发</strong>的能力。</p>
<ol>
<li><strong>Nginx 作为统一入口：</strong> 所有来自客户端的请求首先都到达 Nginx 服务器。</li>
<li><strong>URL 规则匹配：</strong> Nginx 根据客户端请求的 URL 路径、文件扩展名等，通过 <code>location</code> 指令中定义的规则进行匹配。</li>
<li><strong>分流处理：</strong><ul>
<li><strong>静态请求：</strong> 如果请求的 URL 匹配到静态资源的模式（例如 <code>/static/</code> 目录下的文件，或 <code>.js</code>、<code>.css</code>、<code>.png</code> 等扩展名的文件），Nginx 会直接从其配置的本地文件系统（<code>root</code> 或 <code>alias</code> 指定的目录）中查找并返回这些文件给客户端。同时，Nginx 会应用缓存策略（如 <code>expires</code>）来优化后续访问。</li>
<li><strong>动态请求：</strong> 如果请求的 URL 没有匹配到静态资源的模式（例如 <code>/api/</code> 路径、<code>.php</code> 后缀等），Nginx 会将其判断为动态请求。此时，Nginx 会将这个请求通过 <code>proxy_pass</code> 指令转发给后端部署动态应用的应用服务器（如 Tomcat、PHP-FPM、Node.js 应用等）进行处理。后端应用服务器处理完后，将结果返回给 Nginx，Nginx 再将结果返回给客户端。</li>
</ul>
</li>
</ol>
<p><strong>核心思想：</strong> Nginx 根据请求的特性（主要是 URL）充当一个智能的分发器，将不同类型的请求发送到最适合处理它们的组件。</p>
<h3 id="在-Nginx-中如何配置动静分离？"><a href="#在-Nginx-中如何配置动静分离？" class="headerlink" title="在 Nginx 中如何配置动静分离？"></a>在 Nginx 中如何配置动静分离？</h3><p>下面是一个典型的 Nginx 动静分离配置示例。假设我们的应用结构如下：</p>
<ul>
<li><strong>静态文件：</strong> 放在 Nginx 服务器本地的 <code>/var/www/mywebapp/static/</code> 目录下。</li>
<li><strong>动态应用：</strong> 运行在 <code>http://127.0.0.1:8080</code> 的后端应用服务器。</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># 静态文件的 MIME 类型映射</span></span><br><span class="line">    <span class="attribute">include</span> mime.types; </span><br><span class="line">    <span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 配置日志格式和访问日志</span></span><br><span class="line">    <span class="attribute">log_format</span> main <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;</span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/access.log main;</span><br><span class="line">    <span class="attribute">error_log</span> /var/log/nginx/<span class="literal">error</span>.log <span class="literal">warn</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 启用 Gzip 压缩，进一步优化静态文件传输</span></span><br><span class="line">    <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_min_length</span> <span class="number">1k</span>;</span><br><span class="line">    <span class="attribute">gzip_buffers</span> <span class="number">4</span> <span class="number">16k</span>;</span><br><span class="line">    <span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">0</span>;</span><br><span class="line">    <span class="attribute">gzip_comp_level</span> <span class="number">6</span>;</span><br><span class="line">    <span class="attribute">gzip_types</span> text/plain application/javascript application/x-javascript text/css application/xml text/xml image/svg+xml;</span><br><span class="line">    <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="comment"># gzip_proxied any; # 如果 Nginx 前面还有一层代理，可能需要这个</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义后端动态应用服务器（如果有多个可以进行负载均衡）</span></span><br><span class="line">    <span class="section">upstream</span> dynamic_backend &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>; <span class="comment"># 后端应用服务器地址和端口</span></span><br><span class="line">        <span class="comment"># server 192.168.1.2:8080; # 另一个后端服务器</span></span><br><span class="line">        <span class="comment"># least_conn; # 负载均衡算法</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> your_domain.com; <span class="comment"># 替换为你的域名或IP</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1. 静态文件处理 (使用 location 匹配文件扩展名)</span></span><br><span class="line">        <span class="comment"># 匹配常用的静态文件扩展名，并直接由 Nginx 服务</span></span><br><span class="line">        <span class="section">location</span> <span class="regexp">~* \.(css|js|jpg|jpeg|gif|png|ico|woff|woff2|ttf|svg|eot)$</span> &#123;</span><br><span class="line">            <span class="attribute">root</span> /var/www/mywebapp; <span class="comment"># 静态文件的根目录 (这里假设是 /var/www/mywebapp/static/)</span></span><br><span class="line">            <span class="comment"># 如果静态文件在 root 的子目录，如 /var/www/mywebapp/static/</span></span><br><span class="line">            <span class="comment"># 可以写成 root /var/www/mywebapp; 当请求 /static/a.png 时，Nginx 会去 /var/www/mywebapp/static/a.png 找</span></span><br><span class="line">            <span class="comment"># 为了更明确，你也可以使用 alias 指令：</span></span><br><span class="line">            <span class="comment"># alias /var/www/mywebapp/static_files/; # 注意 alias 后面要带斜杠</span></span><br><span class="line"></span><br><span class="line">            <span class="attribute">expires</span> <span class="number">30d</span>; <span class="comment"># 设置浏览器缓存 30 天</span></span><br><span class="line">            <span class="attribute">access_log</span> <span class="literal">off</span>; <span class="comment"># 静态文件访问频率高，通常关闭日志减少IO</span></span><br><span class="line">            <span class="attribute">log_not_found</span> <span class="literal">off</span>; <span class="comment"># 不记录找不到静态文件的日志</span></span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="comment"># 2. 静态文件处理 (使用 location 匹配特定目录)</span></span><br><span class="line">        <span class="comment"># 如果你的静态文件都在一个明确的目录下，比如 /static/</span></span><br><span class="line">        <span class="section">location</span> /static/ &#123;</span><br><span class="line">            <span class="attribute">root</span> /var/www/mywebapp; <span class="comment"># Nginx 会从 /var/www/mywebapp/static/ 查找文件</span></span><br><span class="line">            <span class="attribute">expires</span> <span class="number">30d</span>;</span><br><span class="line">            <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">            <span class="attribute">log_not_found</span> <span class="literal">off</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. 动态请求处理</span></span><br><span class="line">        <span class="comment"># 匹配所有其他请求，将其转发给后端应用服务器</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://dynamic_backend; <span class="comment"># 将请求代理到后端动态服务器</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 传递客户端真实 IP 等信息给后端</span></span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>; <span class="comment"># 传递原始请求协议 (http/https)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 保持后端连接，提高效率</span></span><br><span class="line">            <span class="attribute">proxy_connect_timeout</span> <span class="number">60s</span>;</span><br><span class="line">            <span class="attribute">proxy_send_timeout</span> <span class="number">60s</span>;</span><br><span class="line">            <span class="attribute">proxy_read_timeout</span> <span class="number">60s</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 禁用代理缓冲，对于动态内容实时性要求较高时有用</span></span><br><span class="line">            <span class="attribute">proxy_buffering</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 在这里可以添加 try_files 指令用于处理特定的 URL 重写或默认页面</span></span><br><span class="line">            <span class="comment"># 例如，如果后端应用是 SPA (Single Page Application)，</span></span><br><span class="line">            <span class="comment"># 所有的非API请求都应该返回 index.html</span></span><br><span class="line">            <span class="comment"># try_files $uri $uri/ /index.html;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果你的动态应用是 API 接口，可以单独配置</span></span><br><span class="line">        <span class="comment"># location /api/ &#123;</span></span><br><span class="line">        <span class="comment">#     proxy_pass http://dynamic_backend;</span></span><br><span class="line">        <span class="comment">#     proxy_set_header Host $host;</span></span><br><span class="line">        <span class="comment">#     proxy_set_header X-Real-IP $remote_addr;</span></span><br><span class="line">        <span class="comment">#     # ... 其他代理头和超时设置</span></span><br><span class="line">        <span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理 favicon.ico 请求，通常是静态文件</span></span><br><span class="line">        <span class="section">location</span> = /favicon.ico &#123;</span><br><span class="line">            <span class="attribute">alias</span> /var/www/mywebapp/static/favicon.ico;</span><br><span class="line">            <span class="attribute">expires</span> <span class="number">30d</span>;</span><br><span class="line">            <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">            <span class="attribute">log_not_found</span> <span class="literal">off</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置步骤和要点："><a href="#配置步骤和要点：" class="headerlink" title="配置步骤和要点："></a>配置步骤和要点：</h4><ol>
<li><p><strong>确定静态文件存放位置：</strong></p>
<ul>
<li>将所有 CSS、JS、图片、字体等静态文件统一存放在 Nginx 服务器本地的一个目录下，例如 <code>/var/www/mywebapp/static/</code>。</li>
<li>在前端代码中，确保引用这些静态文件时使用 <code>/static/</code> 或其他特定路径，便于 Nginx 匹配。</li>
</ul>
</li>
<li><p><strong>配置 <code>root</code> 或 <code>alias</code> 指令：</strong></p>
<ul>
<li><code>root</code> 指令：Nginx 会将请求的 URI 附加到 <code>root</code> 路径之后，形成完整的文件路径。例如，<code>root /var/www/mywebapp;</code> 时，请求 <code>/static/a.js</code> 会去 <code>/var/www/mywebapp/static/a.js</code> 找。</li>
<li><code>alias</code> 指令：<code>alias</code> 指定的路径会替换 <code>location</code> 匹配到的部分。例如，<code>location /static/ &#123; alias /var/www/mywebapp/static_files/; &#125;</code> 时，请求 <code>/static/a.js</code> 会去 <code>/var/www/mywebapp/static_files/a.js</code> 找。注意 <code>alias</code> 结尾通常需要加斜杠。</li>
<li><strong>建议：</strong> 如果静态文件都在一个明确的子目录下（如 <code>/static/</code>），使用 <code>root</code> 结合合适的 <code>location</code> 匹配通常更简洁。如果静态文件分散在不同位置，或者 <code>location</code> 匹配的是正则表达式，<code>alias</code> 可能更灵活。</li>
</ul>
</li>
<li><p><strong>配置 <code>expires</code> 指令：</strong> 对静态文件设置合理的缓存时间，加速浏览器访问。</p>
</li>
<li><p><strong>配置 <code>access_log off;</code> 和 <code>log_not_found off;</code>：</strong> 针对静态文件，关闭访问日志和找不到文件的日志，减少 Nginx 的 I&#x2F;O 负担，提高性能。</p>
</li>
<li><p><strong>配置 <code>gzip</code> 压缩：</strong> 启用 Gzip 压缩，可以有效减小传输的静态文件大小，进一步提升加载速度。</p>
</li>
<li><p><strong>定义 <code>upstream</code> 块：</strong> 如果有多个后端动态服务器，可以在 <code>upstream</code> 块中定义它们，并配置负载均衡策略。</p>
</li>
<li><p><strong>配置 <code>proxy_pass</code> 指令：</strong> 将动态请求转发给 <code>upstream</code> 定义的后端服务器。</p>
</li>
<li><p><strong>传递 <code>proxy_set_header</code>：</strong> 至关重要，它确保后端应用能获取到客户端的真实 IP 地址、请求的原始 Host 等信息。</p>
</li>
<li><p><strong>测试和重载 Nginx：</strong></p>
<ul>
<li><code>sudo nginx -t</code> (测试配置文件语法)</li>
<li><code>sudo systemctl reload nginx</code> 或 <code>sudo service nginx reload</code> (重新加载配置)</li>
</ul>
</li>
</ol>
<p>通过上述配置，Nginx 就能清晰地将静态和动态请求分流，实现高效的动静分离。这是现代高性能 Web 架构中不可或缺的一环。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/mysql/" class="post-title-link" itemprop="url">mysql-ansible</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:49:41" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/scripts/" itemprop="url" rel="index"><span itemprop="name">scripts</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/scripts/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>好的，没问题。我们接着刚才安装 MySQL 的 Playbook 进行扩展，加入<strong>分发自定义配置文件</strong>、<strong>确保 MySQL 安全性（类似 <code>mysql_secure_installation</code>）</strong>、<strong>创建数据库和用户</strong>这几个关键任务。</p>
<p>这是一个更完整、更贴近生产环境的 Playbook。</p>
<hr>
<h3 id="项目文件结构"><a href="#项目文件结构" class="headerlink" title="项目文件结构"></a>项目文件结构</h3><p>为了更好地管理配置文件和敏感信息，我们采用以下文件结构：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── inventory.ini             <span class="comment"># 资产清单</span></span><br><span class="line">├── mysql_playbook.yml      <span class="comment"># 主 Playbook 文件</span></span><br><span class="line">├── templates/</span><br><span class="line">│   └── <span class="keyword">my</span>.cnf.j2             <span class="comment"># MySQL 配置文件模板</span></span><br><span class="line">└── files/</span><br><span class="line">    └── .<span class="keyword">my</span>.cnf               <span class="comment"># 用于 Ansible 控制节点连接数据库的认证文件</span></span><br></pre></td></tr></table></figure>

<h3 id="1-templates-my-cnf-j2-配置文件模板"><a href="#1-templates-my-cnf-j2-配置文件模板" class="headerlink" title="1. templates/my.cnf.j2 (配置文件模板)"></a>1. <code>templates/my.cnf.j2</code> (配置文件模板)</h3><p>这是一个 Jinja2 模板。它允许我们使用 Ansible 的变量来动态生成配置文件内容。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># templates/my.cnf.j2</span></span><br><span class="line"><span class="comment"># This configuration is managed by Ansible. Do not edit manually.</span></span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">bind-address</span>            = &#123;&#123; mysql_bind_address &#125;&#125;</span><br><span class="line"><span class="attr">max_connections</span>         = &#123;&#123; mysql_max_connections &#125;&#125;</span><br><span class="line"><span class="attr">innodb_buffer_pool_size</span> = &#123;&#123; (ansible_memtotal_mb * <span class="number">0.6</span>) | int &#125;&#125;M</span><br><span class="line"><span class="comment"># ... 其他你需要的配置项</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>&#123;&#123; variable &#125;&#125;</code>: 这是 Jinja2 的语法，Ansible 会在执行时用 Playbook 中定义的变量替换它。</li>
<li><code>&#123;&#123; (ansible_memtotal_mb * 0.6) | int &#125;&#125;M</code>: 这是一个高级用法。它使用了 Ansible 自动收集的 <strong>Fact</strong> (<code>ansible_memtotal_mb</code>)，动态计算出合适的 <code>innodb_buffer_pool_size</code> (这里设置为总内存的 60%)，并确保结果是整数。这让配置可以自适应不同规格的服务器。</li>
</ul>
<h3 id="2-files-my-cnf-数据库认证文件"><a href="#2-files-my-cnf-数据库认证文件" class="headerlink" title="2. files/.my.cnf (数据库认证文件)"></a>2. <code>files/.my.cnf</code> (数据库认证文件)</h3><p>为了让 Ansible 能够登录 MySQL 并执行管理任务（如创建用户），我们需要提供 root 用户的密码。直接在 Playbook 里写明文密码是不安全的。一个较好的实践是，在<strong>首次配置</strong>MySQL root 密码后，将密码存放在一个受控的文件中。</p>
<p><strong>注意：</strong> 这个文件应该严格控制权限 (<code>chmod 600</code>)，并且在生产中，推荐使用 Ansible Vault 来加密它。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># files/.my.cnf</span></span><br><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="attr">user</span>=root</span><br><span class="line"><span class="attr">password</span>=<span class="string">&quot;Your_Secure_Root_Password&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-mysql-playbook-yml-完整的-Playbook"><a href="#3-mysql-playbook-yml-完整的-Playbook" class="headerlink" title="3. mysql_playbook.yml (完整的 Playbook)"></a>3. <code>mysql_playbook.yml</code> (完整的 Playbook)</h3><p>这个 Playbook 在之前的基础上增加了新的 <code>roles</code> 和 <code>tasks</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">and</span> <span class="string">Secure</span> <span class="string">MySQL</span> <span class="string">Server</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">databases</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="comment"># --- 包和服务相关的变量 ---</span></span><br><span class="line">    <span class="attr">mysql_package_name:</span> <span class="string">mysql-server</span></span><br><span class="line">    <span class="attr">mysql_service_name:</span> <span class="string">mysql</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 自定义配置相关的变量 ---</span></span><br><span class="line">    <span class="attr">mysql_bind_address:</span> <span class="string">&quot;0.0.0.0&quot;</span>       <span class="comment"># 允许远程连接</span></span><br><span class="line">    <span class="attr">mysql_max_connections:</span> <span class="number">500</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 数据库和用户相关的变量 ---</span></span><br><span class="line">    <span class="attr">db_name:</span> <span class="string">&quot;my_app_db&quot;</span></span><br><span class="line">    <span class="attr">db_user:</span> <span class="string">&quot;my_app_user&quot;</span></span><br><span class="line">    <span class="attr">db_password:</span> <span class="string">&quot;A_Very_Strong_Password_For_App&quot;</span> <span class="comment"># 生产环境建议使用 Ansible Vault 加密</span></span><br><span class="line">    <span class="attr">db_host:</span> <span class="string">&quot;%&quot;</span> <span class="comment"># &#x27;%&#x27; 允许任何主机连接, &#x27;localhost&#x27; 仅本地</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="comment"># ------------------ 任务1: 安装 ------------------</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Update</span> <span class="string">APT</span> <span class="string">cache</span> <span class="string">(for</span> <span class="string">Debian/Ubuntu)</span></span><br><span class="line">      <span class="attr">ansible.builtin.apt:</span></span><br><span class="line">        <span class="attr">update_cache:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">&quot;Debian&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">MySQL</span> <span class="string">packages</span> <span class="string">and</span> <span class="string">Python</span> <span class="string">dependencies</span></span><br><span class="line">      <span class="attr">ansible.builtin.package:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; mysql_package_name &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">python3-pymysql</span>  <span class="comment"># Ansible 操作 MySQL 需要的 Python 库</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------ 任务2: 分发配置文件 ------------------</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Distribute</span> <span class="string">custom</span> <span class="string">MySQL</span> <span class="string">configuration</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">ansible.builtin.template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">templates/my.cnf.j2</span> <span class="comment"># 源文件是模板文件</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/mysql/mysql.conf.d/mysqld.cnf</span> <span class="comment"># 目标路径</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&#x27;0644&#x27;</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">MySQL</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------ 任务3: 启动并使能服务 ------------------</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ensure</span> <span class="string">MySQL</span> <span class="string">service</span> <span class="string">is</span> <span class="string">running</span> <span class="string">and</span> <span class="string">enabled</span></span><br><span class="line">      <span class="attr">ansible.builtin.service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; mysql_service_name &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------ 任务4: 确保数据库安全 ------------------</span></span><br><span class="line">    <span class="comment"># 这是一个幂等的安全设置流程，替代手动运行 mysql_secure_installation</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">the</span> <span class="string">root</span> <span class="string">password</span> <span class="string">for</span> <span class="string">the</span> <span class="string">first</span> <span class="string">time</span></span><br><span class="line">      <span class="attr">community.mysql.mysql_user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">&quot;Your_Secure_Root_Password&quot;</span> <span class="comment"># 同样，生产环境用 Vault</span></span><br><span class="line">        <span class="attr">login_unix_socket:</span> <span class="string">/var/run/mysqld/mysqld.sock</span></span><br><span class="line">      <span class="attr">when:</span> <span class="literal">True</span> <span class="comment"># 实际场景中可能需要更复杂的逻辑判断是否首次运行</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">.my.cnf</span> <span class="string">file</span> <span class="string">with</span> <span class="string">root</span> <span class="string">password</span> <span class="string">to</span> <span class="string">the</span> <span class="string">remote</span> <span class="string">root</span> <span class="string">user&#x27;s</span> <span class="string">home</span></span><br><span class="line">      <span class="attr">ansible.builtin.copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">files/.my.cnf</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/root/.my.cnf</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&#x27;0600&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Remove</span> <span class="string">anonymous</span> <span class="string">MySQL</span> <span class="string">users</span></span><br><span class="line">      <span class="attr">community.mysql.mysql_user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">host_all:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line">        <span class="attr">login_user:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">login_password:</span> <span class="string">&quot;Your_Secure_Root_Password&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Remove</span> <span class="string">the</span> <span class="string">test</span> <span class="string">database</span></span><br><span class="line">      <span class="attr">community.mysql.mysql_db:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line">        <span class="attr">login_user:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">login_password:</span> <span class="string">&quot;Your_Secure_Root_Password&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------ 任务5: 创建应用数据库和用户 ------------------</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">the</span> <span class="string">application</span> <span class="string">database</span></span><br><span class="line">      <span class="attr">community.mysql.mysql_db:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; db_name &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">        <span class="attr">login_user:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">login_password:</span> <span class="string">&quot;Your_Secure_Root_Password&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">the</span> <span class="string">application</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">community.mysql.mysql_user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; db_user &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; db_password &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">priv:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; db_name &#125;&#125;</span>.*:ALL&quot;</span> <span class="comment"># 授予用户在指定数据库上的所有权限</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; db_host &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">        <span class="attr">login_user:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">login_password:</span> <span class="string">&quot;Your_Secure_Root_Password&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">MySQL</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">ansible.builtin.service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; mysql_service_name &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<h3 id="关键解读与改进"><a href="#关键解读与改进" class="headerlink" title="关键解读与改进"></a>关键解读与改进</h3><ol>
<li><p><strong>分发配置文件 (任务2)</strong>:</p>
<ul>
<li>我们使用 <code>ansible.builtin.template</code> 模块，它能识别 Jinja2 模板并进行渲染。</li>
<li><code>src</code> 指向控制节点上的模板文件，<code>dest</code> 指向受管节点上的目标路径。</li>
<li><code>notify: Restart MySQL Service</code> 确保了只要配置文件发生变更，MySQL 服务就会自动重启以应用新配置。</li>
</ul>
</li>
<li><p><strong>确保数据库安全 (任务4)</strong>:</p>
<ul>
<li>这一系列任务以<strong>幂等</strong>的方式实现了 <code>mysql_secure_installation</code> 脚本的核心功能：设置 root 密码、删除匿名用户、移除 test 数据库。</li>
<li><strong><code>community.mysql.mysql_user</code></strong> 和 <strong><code>community.mysql.mysql_db</code></strong> 是 Ansible 社区提供的专用模块，用于管理 MySQL 用户和数据库，功能强大。</li>
<li>为了让 Ansible 能以 root 身份登录数据库执行这些操作，我们先通过 <code>copy</code> 模块将包含 root 密码的 <code>.my.cnf</code> 文件安全地放置到服务器的 <code>/root/</code> 目录下。后续的 <code>mysql_*</code> 模块会自动读取这个文件进行认证。这是比在每个任务中都写 <code>login_password</code> 更优雅的方式。</li>
</ul>
</li>
<li><p><strong>创建数据库和用户 (任务5)</strong>:</p>
<ul>
<li>同样使用 <code>mysql_db</code> 和 <code>mysql_user</code> 模块。</li>
<li><code>priv: &quot;&#123;&#123; db_name &#125;&#125;.*:ALL&quot;</code> 是一个非常关键的参数，它精确地授予了新用户在指定数据库上的所有权限 (<code>GRANT ALL ON my_app_db.* TO ...</code>)。</li>
<li>所有的数据库名、用户名、密码都通过 <code>vars</code> 定义，使得整个 Playbook <strong>配置驱动</strong>，修改时只需调整变量区即可，无需改动任务逻辑。</li>
</ul>
</li>
<li><p><strong>依赖安装</strong>:</p>
<ul>
<li>注意，我们在安装任务中加入了 <code>python3-pymysql</code>。这是 Ansible 操作 MySQL 所必需的 Python 库，必须在受管节点上安装。</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/panic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/panic/" class="post-title-link" itemprop="url">panic</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:51:17" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Go中的“异常”场景分为两类：<strong>预期错误（通过error处理）</strong> 和 <strong>非预期错误&#x2F;程序崩溃（通过panic）</strong>。</p>
<h3 id="一、-预期错误（Errors）：通过-error-类型显式处理"><a href="#一、-预期错误（Errors）：通过-error-类型显式处理" class="headerlink" title="一、 预期错误（Errors）：通过 error 类型显式处理"></a>一、 预期错误（Errors）：通过 <code>error</code> 类型显式处理</h3><p>这是Go语言处理错误的核心机制。函数通过返回一个 <code>error</code> 类型的值来指示操作是否成功。</p>
<p><strong>常见触发场景：</strong></p>
<ol>
<li><p><strong>文件操作失败：</strong></p>
<ul>
<li>打开不存在的文件 (<code>os.Open</code>)</li>
<li>写入文件权限不足 (<code>file.Write</code>)</li>
<li>读取到文件末尾 (<code>io.EOF</code>)</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">f, err := os.Open(<span class="string">&quot;non_existent_file.txt&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Error opening file:&quot;</span>, err) <span class="comment">// 会打印错误</span></span><br><span class="line">    <span class="comment">// log.Fatal(err) // 实际应用中可能直接终止或向上抛出</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>网络操作失败：</strong></p>
<ul>
<li>无法连接到服务器 (<code>net.Dial</code>)</li>
<li>HTTP请求超时或网络中断 (<code>http.Get</code>)</li>
<li>DNS解析失败 (<code>net.LookupHost</code>)</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">resp, err := http.Get(<span class="string">&quot;http://invalid.url&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Error making HTTP request:&quot;</span>, err) <span class="comment">// 比如: dial tcp: lookup invalid.url: no such host</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>类型转换失败：</strong></p>
<ul>
<li><code>strconv</code> 系列函数，如字符串转整数 (<code>strconv.Atoi</code>)，如果字符串不是有效数字。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="string">&quot;abc&quot;</span></span><br><span class="line">i, err := strconv.Atoi(s)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Error converting string to int:&quot;</span>, err) <span class="comment">// strconv.Atoi: parsing &quot;abc&quot;: invalid syntax</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    fmt.Println(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>JSON&#x2F;XML编解码失败：</strong></p>
<ul>
<li>传入的JSON字符串格式不正确，无法解析到Go结构体。</li>
<li>结构体中的字段无法被正确编码成JSON。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	invalidJSON := <span class="string">`&#123; &quot;Name&quot;: &quot;Alice&quot;, &quot;Age&quot;: &quot;twenty&quot; &#125;`</span> <span class="comment">// Age不是数字，无法解码到int</span></span><br><span class="line">	<span class="keyword">var</span> u2 User</span><br><span class="line">	err := json.Unmarshal([]<span class="type">byte</span>(invalidJSON), &amp;u2)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;JSON unmarshal error:&quot;</span>, err) <span class="comment">// Output: json: cannot unmarshal string into Go struct field User.Age of type int</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不合法的输入&#x2F;参数：</strong></p>
<ul>
<li>函数接收到不符合业务逻辑要求的值（例如，负数作为年龄）。这种情况通常通过<code>if</code>条件判断，并手动返回自定义<code>error</code>。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">withdraw</span><span class="params">(balance, amount <span class="type">float64</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> amount &lt;= <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;withdrawal amount must be positive&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> amount &gt; balance &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;insufficient balance&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="二、-非预期错误-程序崩溃（Panics）：通过-recover-处理，通常不建议"><a href="#二、-非预期错误-程序崩溃（Panics）：通过-recover-处理，通常不建议" class="headerlink" title="二、 非预期错误 &#x2F; 程序崩溃（Panics）：通过 recover 处理，通常不建议"></a>二、 非预期错误 &#x2F; 程序崩溃（Panics）：通过 <code>recover</code> 处理，通常不建议</h3><p><code>panic</code> 是Go语言中用于处理无法恢复的错误的一种机制，它会导致当前Goroutine停止执行，然后沿调用栈向上查找 <code>defer</code> 函数，直到找到一个 <code>recover</code> 调用来捕获这个 <code>panic</code>。如果没有 <code>defer</code> 和 <code>recover</code> 捕获，<code>panic</code> 会导致整个程序崩溃。</p>
<p><strong>注意：</strong> 在Go中，<code>panic</code> 应该只用于<strong>表示不可恢复的错误</strong>（例如，程序内部逻辑错误，不应该发生的情况）。对于常规的、可预期的错误，始终应该使用 <code>error</code> 类型。</p>
<p><strong>常见触发 <code>panic</code> 的场景：</strong></p>
<ol>
<li><p><strong>空指针解引用 (<code>nil pointer dereference</code>)：</strong> 试图访问一个 <code>nil</code> 指针指向的数据。这是最常见的 <code>panic</code> 原因之一。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p *<span class="type">int</span> <span class="comment">// p 是 nil</span></span><br><span class="line">fmt.Println(*p) <span class="comment">// 触发 panic: runtime error: invalid memory address or nil pointer dereference</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>数组&#x2F;切片越界访问 (<code>index out of range</code>)：</strong> 尝试访问数组或切片中不存在的索引。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arr := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">fmt.Println(arr[<span class="number">3</span>]) <span class="comment">// 触发 panic: runtime error: index out of range [3] with length 3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>向已关闭的通道发送数据 (<code>send on closed channel</code>) 或从已关闭且无数据的通道接收数据 (<code>receive on closed channel</code>)：</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line"><span class="built_in">close</span>(ch)</span><br><span class="line">ch &lt;- <span class="number">1</span> <span class="comment">// 触发 panic: send on closed channel</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="comment">// close(ch)</span></span><br><span class="line"><span class="comment">// &lt;-ch // 第一次读会返回零值和false</span></span><br><span class="line"><span class="comment">// &lt;-ch // 再次从已关闭且无数据的通道读取，不会panic，而是持续返回零值和false</span></span><br><span class="line"><span class="comment">// 但是，如果使用range遍历已关闭的通道，当通道中没有数据时，range循环会正常结束，不会panic。</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>类型断言失败 (<code>interface conversion</code>):</strong></p>
<ul>
<li>当使用 <code>value := i.(Type)</code> 这种单返回值断言语法时，如果接口 <code>i</code> 中存储的值类型与 <code>Type</code> 不匹配，会触发 <code>panic</code>。</li>
<li>使用 <code>value, ok := i.(Type)</code> 这种双返回值语法时，如果类型不匹配，<code>ok</code> 会是 <code>false</code>，不会 <code>panic</code>，这是推荐的做法。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i <span class="keyword">interface</span>&#123;&#125; = <span class="number">10</span></span><br><span class="line"><span class="comment">// s := i.(string) // 触发 panic: interface conversion: interface &#123;&#125; is int, not string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确的做法是使用双返回值</span></span><br><span class="line"><span class="keyword">if</span> s, ok := i.(<span class="type">string</span>); ok &#123;</span><br><span class="line">	fmt.Println(s)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;Type assertion failed: not a string&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>并发操作中的竞争条件：</strong> 虽然不是直接触发 <code>panic</code> 的语法，但未正确同步的并发操作可能导致数据损坏，进而引发其他形式的 <code>panic</code>（如空指针解引用）。</p>
</li>
<li><p><strong>栈溢出 (<code>stack overflow</code>)：</strong> 递归调用深度过大导致栈空间耗尽。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">infiniteRecursion</span><span class="params">()</span></span> &#123;</span><br><span class="line">    infiniteRecursion() <span class="comment">// 永无止境的递归</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    infiniteRecursion() <span class="comment">// 触发 panic: runtime: goroutine stack exceeds 250000000-byte limit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>显式调用 <code>panic()</code> 函数：</strong> 开发者可以主动调用 <code>panic()</code> 来抛出恐慌。</p>
<ul>
<li>这通常用于表示程序遇到了一个无法处理的、不应该发生的致命错误。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">criticalOperation</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> someConditionIsBad &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;critical system error: state corrupted!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>对未初始化的 <code>map</code> 进行写入操作：</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> m <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span> <span class="comment">// 未初始化，m 是 nil</span></span><br><span class="line">m[<span class="string">&quot;key&quot;</span>] = <span class="number">10</span>        <span class="comment">// 触发 panic: assignment to entry in nil map</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确做法：</span></span><br><span class="line"><span class="comment">// m = make(map[string]int)</span></span><br><span class="line"><span class="comment">// m[&quot;key&quot;] = 10</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="如何处理-panic"><a href="#如何处理-panic" class="headerlink" title="如何处理 panic"></a>如何处理 <code>panic</code></h3><p>虽然不推荐 <code>panic</code> 作为常规错误处理机制，但在某些情况下，尤其是在库函数或顶层 Goroutine 中，你可能需要用 <code>defer</code> 和 <code>recover</code> 来捕获和处理 <code>panic</code>，以防止程序崩溃或进行清理工作。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">protect</span><span class="params">(fn <span class="keyword">func</span>()</span></span>) &#123;</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;Recovered from panic: %v\n&quot;</span>, r)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    fn()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mightPanic</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// ... some operations</span></span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">&quot;something went terribly wrong!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Before calling mightPanic&quot;</span>)</span><br><span class="line">    protect(mightPanic)</span><br><span class="line">    fmt.Println(<span class="string">&quot;After calling mightPanic (if recovered)&quot;</span>) <span class="comment">// 这行会被执行</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 另一种 panic 场景，没有 recover</span></span><br><span class="line">    <span class="comment">// var x []int</span></span><br><span class="line">    <span class="comment">// fmt.Println(x[0]) // 程序会崩溃</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong></p>
<p>Go语言鼓励通过 <code>error</code> 类型进行错误处理，这是一种显式且可预测的方式。<code>panic</code> 是一种更重量级的机制，用于表示程序状态已损坏，无法继续安全执行的不可恢复的错误。在设计Go程序时，应优先考虑使用 <code>error</code> 来处理可预期的失败，而将 <code>panic</code> 保留给真正意义上的致命、无法恢复的程序内部错误。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/python%20thread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/python%20thread/" class="post-title-link" itemprop="url">python thread</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:53:20" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/scripts/" itemprop="url" rel="index"><span itemprop="name">scripts</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Python-多线程"><a href="#Python-多线程" class="headerlink" title="Python 多线程"></a>Python 多线程</h3><p>然而，在使用之前，必须理解一个核心概念：**Python 的全局解释器锁 (Global Interpreter Lock - GIL)**。</p>
<ul>
<li><strong>GIL 的影响</strong>：GIL 保证了在任何时刻，只有一个线程在执行 Python 字节码。这意味着，如果你的任务是 <strong>CPU 密集型</strong>的（例如，复杂的数学计算、视频编码），多线程<strong>无法</strong>利用多核 CPU 来实现真正的并行计算，效率提升不大甚至可能下降。</li>
<li><strong>多线程的优势所在</strong>：对于 <strong>I&#x2F;O 密集型</strong>任务（例如，网络请求、读写文件、数据库查询），一个线程在等待 I&#x2F;O 操作（比如等待网络响应）时，会被阻塞。GIL 在此时会释放，允许另一个线程运行。这样，多个线程可以“轮流”执行，当一个在等待时，另一个在工作，从而极大地减少了总的等待时间，提升了脚本的整体执行效率。</li>
</ul>
<p><strong>结论先行：在 Python 中，多线程是优化 I&#x2F;O 密集型任务的利器。</strong></p>
<hr>
<h3 id="如何使用多线程：从基础到最佳实践"><a href="#如何使用多线程：从基础到最佳实践" class="headerlink" title="如何使用多线程：从基础到最佳实践"></a>如何使用多线程：从基础到最佳实践</h3><p>我们以一个常见的运维场景为例：检查一组服务器的网站是否能正常访问。</p>
<h4 id="场景1：单线程（串行执行）"><a href="#场景1：单线程（串行执行）" class="headerlink" title="场景1：单线程（串行执行）"></a>场景1：单线程（串行执行）</h4><p>这是未使用多线程的原始脚本，它会一个接一个地检查 URL。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">urls = [</span><br><span class="line">    <span class="string">&#x27;https://www.python.org&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https://www.google.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https://www.github.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https://www.microsoft.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https://www.amazon.com&#x27;</span>,</span><br><span class="line">    <span class="comment"># 假设还有更多</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(url, timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span>: Status <span class="subst">&#123;response.status_code&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span>: FAILED - <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">start_time = time.time()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">    check_url(url)</span><br><span class="line"></span><br><span class="line">end_time = time.time()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;\nTotal execution time: <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> seconds.&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>问题</strong>：如果每个请求平均耗时 1 秒，那么检查 5 个 URL 就会耗时约 5 秒。如果检查 100 个，就会耗时 100 秒，效率极低。</p>
<hr>
<h4 id="场景2：使用-threading-模块（手动管理）"><a href="#场景2：使用-threading-模块（手动管理）" class="headerlink" title="场景2：使用 threading 模块（手动管理）"></a>场景2：使用 <code>threading</code> 模块（手动管理）</h4><p>这是基础的多线程实现方式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="comment"># ... (urls 和 check_url 函数与上面相同) ...</span></span><br><span class="line"></span><br><span class="line">start_time = time.time()</span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">    <span class="comment"># 1. 为每个任务创建一个线程对象</span></span><br><span class="line">    thread = threading.Thread(target=check_url, args=(url,))</span><br><span class="line">    threads.append(thread)</span><br><span class="line">    <span class="comment"># 2. 启动线程</span></span><br><span class="line">    thread.start()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 等待所有线程执行完毕</span></span><br><span class="line"><span class="comment"># 这一步至关重要！主线程会在这里阻塞，直到所有子线程都结束。</span></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.join()</span><br><span class="line"></span><br><span class="line">end_time = time.time()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;\nTotal execution time: <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> seconds.&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>效率提升</strong>：现在，所有网络请求几乎是同时发出的。总耗时不再是所有请求时间的总和，而是取决于<strong>最慢的那个请求</strong>的时间。对于 5 个 URL，总耗时可能就在 1 秒左右。</p>
<hr>
<h3 id="最佳实践：使用-concurrent-futures-ThreadPoolExecutor"><a href="#最佳实践：使用-concurrent-futures-ThreadPoolExecutor" class="headerlink" title="最佳实践：使用 concurrent.futures.ThreadPoolExecutor"></a>最佳实践：使用 <code>concurrent.futures.ThreadPoolExecutor</code></h3><p>手动管理线程（创建、启动、加入）比较繁琐，且容易出错。Python 3 引入的 <code>ThreadPoolExecutor</code> 提供了一个更高级、更简洁、更安全的接口，是现代 Python 开发中的<strong>首选方案</strong>。</p>
<p>它会自动管理一个线程池，你只需要把任务提交给它即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"></span><br><span class="line"><span class="comment"># ... (urls 和 check_url 函数与上面相同) ...</span></span><br><span class="line"></span><br><span class="line">start_time = time.time()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置最大并发线程数，例如 5 个</span></span><br><span class="line"><span class="comment"># 如果不设置，它会根据 CPU 核心数选择一个合理的值</span></span><br><span class="line">max_workers = <span class="number">5</span></span><br><span class="line"><span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=max_workers) <span class="keyword">as</span> executor:</span><br><span class="line">    <span class="comment"># 使用 executor.map 来提交所有任务，它会返回一个结果的迭代器</span></span><br><span class="line">    <span class="comment"># 这种方式简洁，会自动处理任务的提交和结果的收集</span></span><br><span class="line">    executor.<span class="built_in">map</span>(check_url, urls)</span><br><span class="line"></span><br><span class="line">end_time = time.time()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;\nTotal execution time: <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> seconds.&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>为何这是最佳实践？</strong></p>
<ol>
<li><strong>代码简洁</strong>：使用 <code>with</code> 语句可以确保线程池在使用完毕后被正确关闭。<code>executor.map</code> 一行代码就替代了之前复杂的循环和 <code>join</code>。</li>
<li><strong>资源可控</strong>：通过 <code>max_workers</code> 参数，你可以精确控制并发量，防止因创建过多线程而耗尽系统资源。</li>
<li><strong>易于获取结果</strong>：<code>executor.map</code> 按照任务提交的顺序返回结果。如果你需要更灵活地处理结果（比如谁先完成就先处理谁），可以使用 <code>executor.submit</code> 和 <code>concurrent.futures.as_completed</code>。</li>
</ol>
<hr>
<h3 id="处理线程安全问题：使用锁-Lock"><a href="#处理线程安全问题：使用锁-Lock" class="headerlink" title="处理线程安全问题：使用锁 (Lock)"></a>处理线程安全问题：使用锁 (Lock)</h3><p>当多个线程需要<strong>修改同一个共享变量</strong>时，可能会发生“竞态条件”（Race Condition），导致数据不一致。</p>
<p><strong>例子：</strong> 多个线程同时对一个计数器执行 <code>+1</code> 操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一个共享的变量</span></span><br><span class="line">counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker</span>():</span><br><span class="line">    <span class="keyword">global</span> counter</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100000</span>):</span><br><span class="line">        <span class="comment"># 这是一个不安全的操作</span></span><br><span class="line">        counter += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">threads = [threading.Thread(target=worker) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.start()</span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 理论上结果应该是 10 * 100000 = 1000000</span></span><br><span class="line"><span class="comment"># 但实际运行结果几乎每次都小于这个值！</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Final counter value: <span class="subst">&#123;counter&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>原因</strong>：<code>counter += 1</code> 并非原子操作，它包含“读取-修改-写入”三步。一个线程可能在读取了旧值后被切换，另一个线程也读取了这个旧值，导致最终的写入覆盖了前一个线程的结果。</p>
<p><strong>解决方案：使用 <code>threading.Lock</code></strong></p>
<p>锁可以确保在同一时间只有一个线程能进入代码的“临界区”。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">counter = <span class="number">0</span></span><br><span class="line"><span class="comment"># 创建一个锁对象</span></span><br><span class="line">lock = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">safe_worker</span>():</span><br><span class="line">    <span class="keyword">global</span> counter</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100000</span>):</span><br><span class="line">        <span class="comment"># 使用 &#x27;with&#x27; 语句能自动获取和释放锁，非常安全</span></span><br><span class="line">        <span class="keyword">with</span> lock:</span><br><span class="line">            counter += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">threads = [threading.Thread(target=safe_worker) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.start()</span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 现在结果总是正确的 1000000</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Final counter value: <span class="subst">&#123;counter&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>作为运维工程师，你应该这样应用多线程：</p>
<ol>
<li><strong>识别场景</strong>：首先判断你的任务是 I&#x2F;O 密集型（适合多线程）还是 CPU 密集型（应考虑多进程 <code>multiprocessing</code>）。</li>
<li>**首选 <code>ThreadPoolExecutor</code>**：它是最现代、最安全、最方便的方式。用它来处理并发的网络请求、文件操作等。</li>
<li><strong>控制并发量</strong>：通过 <code>max_workers</code> 设置合理的线程数，避免对服务器或目标 API 造成过大压力。</li>
<li><strong>注意线程安全</strong>：如果多个线程需要操作共享数据（如全局列表、字典、计数器），<strong>必须</strong>使用 <code>threading.Lock</code> 或其他同步原语来保护它，防止数据损坏。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/python-%E5%A2%9E%E9%87%8F%E5%A4%87%E4%BB%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/python-%E5%A2%9E%E9%87%8F%E5%A4%87%E4%BB%BD/" class="post-title-link" itemprop="url">python-增量备份</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:53:26" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/scripts/" itemprop="url" rel="index"><span itemprop="name">scripts</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Python 实现的、生产级别的文件增量备份脚本。这个方案的核心是<strong>基于文件大小（偏移量）进行追踪</strong>，这对于 append-only（只追加写入）的文件（如日志）来说是最高效的。</p>
<h3 id="核心机制"><a href="#核心机制" class="headerlink" title="核心机制"></a>核心机制</h3><ol>
<li><strong>状态追踪文件（State File）</strong>: 我们需要一个地方记录上次备份到了源文件的哪个位置。最简单可靠的方法就是创建一个与备份文件关联的状态文件（例如 <code>my_app.log.state</code>），里面只存一个数字：上次备份完成时源文件的字节大小（offset）。</li>
<li><strong>备份逻辑</strong>:<ul>
<li><strong>首次运行</strong>: 状态文件不存在。脚本会从头（偏移量 0）开始，完整备份整个源文件，然后将源文件的当前大小写入状态文件。</li>
<li><strong>后续运行</strong>: 脚本首先读取状态文件，获取上次备份的偏移量 <code>last_offset</code>。</li>
<li>然后获取源文件当前的实际大小 <code>current_size</code>。</li>
<li><strong>情况 A (文件增长)</strong>: 如果 <code>current_size &gt; last_offset</code>，说明有新内容。脚本会打开源文件，将文件指针移动（<code>seek</code>）到 <code>last_offset</code>，然后读取从该位置到文件末尾的所有新数据，并将其追加（append）到备份文件中。成功后，更新状态文件为 <code>current_size</code>。</li>
<li><strong>情况 B (文件被截断或替换)</strong>: 如果 <code>current_size &lt; last_offset</code>，这是一个重要的<strong>边缘情况</strong>（例如日志轮转 log rotation）。这说明源文件已经不是原来的那个了。此时必须从头开始进行一次全量备份，以防数据丢失。成功后，更新状态文件为新的 <code>current_size</code>。</li>
<li><strong>情况 C (无变化)</strong>: 如果 <code>current_size == last_offset</code>，说明文件没有变化，脚本什么也不做，干净地退出。</li>
</ul>
</li>
</ol>
<h3 id="Python-实现脚本"><a href="#Python-实现脚本" class="headerlink" title="Python 实现脚本"></a>Python 实现脚本</h3><p>这个脚本使用了 <code>argparse</code> 来处理命令行参数，具备良好的错误处理和清晰的日志输出，可以直接用于自动化任务（如 Cron Job）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># incremental_backup.py</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">对单个文件进行增量备份的专业脚本。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">该脚本通过追踪源文件的字节偏移量来实现增量备份。</span></span><br><span class="line"><span class="string">它非常适合备份持续追加写入的文件，如应用程序日志、访问日志等。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">核心特性：</span></span><br><span class="line"><span class="string">- 状态持久化：使用 .state 文件记录上次备份的偏移量。</span></span><br><span class="line"><span class="string">- 自动化处理：能够处理文件首次备份、增量更新和文件截断（如日志轮转）。</span></span><br><span class="line"><span class="string">- 健壮性：包含完整的错误处理和清晰的输出。</span></span><br><span class="line"><span class="string">- 易于集成：通过命令行参数接收源文件和备份目录，方便与 cron 等工具集成。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_incremental_backup</span>(<span class="params">source_path: <span class="built_in">str</span>, backup_dir: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    执行对单个文件的增量备份。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        source_path (str): 要备份的源文件的绝对路径。</span></span><br><span class="line"><span class="string">        backup_dir (str): 存放备份文件和状态文件的目录。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 1. 验证输入和环境</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isabs(source_path):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 源文件路径 &#x27;<span class="subst">&#123;source_path&#125;</span>&#x27; 必须是绝对路径。&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(source_path):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 源文件不存在: <span class="subst">&#123;source_path&#125;</span>&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.makedirs(backup_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 无法创建备份目录 &#x27;<span class="subst">&#123;backup_dir&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 定义文件路径</span></span><br><span class="line">    source_filename = os.path.basename(source_path)</span><br><span class="line">    backup_file_path = os.path.join(backup_dir, source_filename)</span><br><span class="line">    state_file_path = os.path.join(backup_dir, <span class="string">f&quot;<span class="subst">&#123;source_filename&#125;</span>.state&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 获取上次备份的偏移量</span></span><br><span class="line">    last_offset = <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(state_file_path):</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(state_file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                content = f.read().strip()</span><br><span class="line">                <span class="keyword">if</span> content:</span><br><span class="line">                    last_offset = <span class="built_in">int</span>(content)</span><br><span class="line">    <span class="keyword">except</span> (IOError, ValueError) <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;警告: 无法读取或解析状态文件 &#x27;<span class="subst">&#123;state_file_path&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>。将执行全量备份。&quot;</span>)</span><br><span class="line">        last_offset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. 获取源文件当前大小</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        current_size = os.path.getsize(source_path)</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 在处理过程中源文件 &#x27;<span class="subst">&#123;source_path&#125;</span>&#x27; 已消失。&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5. 比较并决定备份策略</span></span><br><span class="line">    <span class="keyword">if</span> current_size == last_offset:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;信息: 文件 &#x27;<span class="subst">&#123;source_path&#125;</span>&#x27; 未发生变化。无需备份。&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> current_size &lt; last_offset:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;警告: 文件 &#x27;<span class="subst">&#123;source_path&#125;</span>&#x27; 大小已减小 (可能已被截断或替换)。&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;将从头开始执行全量备份。&quot;</span>)</span><br><span class="line">        last_offset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    bytes_to_backup = current_size - last_offset</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;信息: 检测到新数据。准备从偏移量 <span class="subst">&#123;last_offset&#125;</span> 开始备份 <span class="subst">&#123;bytes_to_backup&#125;</span> 字节。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 6. 执行备份操作</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(source_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> src_file:</span><br><span class="line">            <span class="comment"># 如果是全量备份，用 &#x27;wb&#x27;；如果是增量，用 &#x27;ab&#x27;</span></span><br><span class="line">            mode = <span class="string">&#x27;wb&#x27;</span> <span class="keyword">if</span> last_offset == <span class="number">0</span> <span class="keyword">else</span> <span class="string">&#x27;ab&#x27;</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(backup_file_path, mode) <span class="keyword">as</span> bak_file:</span><br><span class="line">                src_file.seek(last_offset)</span><br><span class="line">                <span class="comment"># 为防止大文件一次性读入内存，可以分块读写</span></span><br><span class="line">                chunk_size = <span class="number">8192</span> <span class="comment"># 8KB</span></span><br><span class="line">                <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                    chunk = src_file.read(chunk_size)</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    bak_file.write(chunk)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> IOError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 备份文件时发生 I/O 错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 7. 成功后，更新状态文件</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(state_file_path, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="built_in">str</span>(current_size))</span><br><span class="line">    <span class="keyword">except</span> IOError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;严重错误: 备份已完成，但无法更新状态文件 &#x27;<span class="subst">&#123;state_file_path&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;下次运行时可能会产生重复数据。请手动修复。&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;成功: 已将 <span class="subst">&#123;bytes_to_backup&#125;</span> 字节备份到 &#x27;<span class="subst">&#123;backup_file_path&#125;</span>&#x27;。&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;状态已更新，新偏移量为: <span class="subst">&#123;current_size&#125;</span>。&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">&quot;对指定文件进行高效的增量备份。&quot;</span>,</span><br><span class="line">        formatter_class=argparse.RawTextHelpFormatter</span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(<span class="string">&quot;source_file&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;要备份的源文件（推荐使用绝对路径）。&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;backup_dir&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;用于存放备份文件和状态文件的目录。&quot;</span>)</span><br><span class="line">  </span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">  </span><br><span class="line">    run_incremental_backup(args.source_file, args.backup_dir)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="如何使用该脚本"><a href="#如何使用该脚本" class="headerlink" title="如何使用该脚本"></a>如何使用该脚本</h3><ol>
<li><strong>保存脚本</strong>: 将代码保存为 <code>incremental_backup.py</code>。</li>
<li><strong>授予执行权限</strong>: <code>chmod +x incremental_backup.py</code></li>
<li><strong>创建测试文件</strong>: <code>echo &quot;Line 1&quot; &gt;&gt; /tmp/my_app.log</code></li>
</ol>
<h4 id="第一次运行（全量备份）"><a href="#第一次运行（全量备份）" class="headerlink" title="第一次运行（全量备份）"></a>第一次运行（全量备份）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ./incremental_backup.py /tmp/my_app.log /var/backups/logs</span><br><span class="line">信息: 检测到新数据。准备从偏移量 0 开始备份 7 字节。</span><br><span class="line">成功: 已将 7 字节备份到 <span class="string">&#x27;/var/backups/logs/my_app.log&#x27;</span>。</span><br><span class="line">状态已更新，新偏移量为: 7。</span><br></pre></td></tr></table></figure>
<p>此时，<code>/var/backups/logs/</code> 目录下会生成 <code>my_app.log</code> 和 <code>my_app.log.state</code> 两个文件。</p>
<h4 id="第二次运行（增量备份）"><a href="#第二次运行（增量备份）" class="headerlink" title="第二次运行（增量备份）"></a>第二次运行（增量备份）</h4><p>首先，向源文件追加内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;Another line&quot;</span> &gt;&gt; /tmp/my_app.log</span><br></pre></td></tr></table></figure>
<p>然后再次运行脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ./incremental_backup.py /tmp/my_app.log /var/backups/logs</span><br><span class="line">信息: 检测到新数据。准备从偏移量 7 开始备份 13 字节。</span><br><span class="line">成功: 已将 13 字节备份到 <span class="string">&#x27;/var/backups/logs/my_app.log&#x27;</span>。</span><br><span class="line">状态已更新，新偏移量为: 20。</span><br></pre></td></tr></table></figure>
<p>你会发现，只有新的内容被追加到了备份文件中。</p>
<h4 id="第三次运行（无变化）"><a href="#第三次运行（无变化）" class="headerlink" title="第三次运行（无变化）"></a>第三次运行（无变化）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./incremental_backup.py /tmp/my_app.log /var/backups/logs</span><br><span class="line">信息: 文件 <span class="string">&#x27;/tmp/my_app.log&#x27;</span> 未发生变化。无需备份。</span><br></pre></td></tr></table></figure>

<h4 id="第四次运行（处理日志轮转）"><a href="#第四次运行（处理日志轮转）" class="headerlink" title="第四次运行（处理日志轮转）"></a>第四次运行（处理日志轮转）</h4><p>模拟日志轮转，创建一个全新的、更小的文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;Log rotated&quot;</span> &gt; /tmp/my_app.log</span><br></pre></td></tr></table></figure>
<p>再次运行脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./incremental_backup.py /tmp/my_app.log /var/backups/logs</span><br><span class="line">警告: 文件 <span class="string">&#x27;/tmp/my_app.log&#x27;</span> 大小已减小 (可能已被截断或替换)。</span><br><span class="line">将从头开始执行全量备份。</span><br><span class="line">信息: 检测到新数据。准备从偏移量 0 开始备份 12 字节。</span><br><span class="line">成功: 已将 12 字节备份到 <span class="string">&#x27;/var/backups/logs/my_app.log&#x27;</span>。</span><br><span class="line">状态已更新，新偏移量为: 12。</span><br></pre></td></tr></table></figure>
<p>备份文件被<strong>覆盖</strong>，以反映新的源文件内容。</p>
<p>这个 Python 脚本健壮、可重入，并且处理了关键的边缘情况，完全符合生产环境的运维要求。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/rune%20%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/rune%20%E7%B1%BB%E5%9E%8B/" class="post-title-link" itemprop="url">rune 类型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:54:34" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="rune-类型的定义"><a href="#rune-类型的定义" class="headerlink" title="rune 类型的定义"></a>rune 类型的定义</h2><p><code>rune</code> 是 Go 语言中的一个内置类型，它的定义非常简单：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="type">rune</span> = <span class="type">int32</span></span><br></pre></td></tr></table></figure>

<p>也就是说，<code>rune</code> 在底层就是一个 <code>int32</code> 类型的别名。但它有着特殊的语义含义。</p>
<h2 id="rune-的意义：Unicode-码点"><a href="#rune-的意义：Unicode-码点" class="headerlink" title="rune 的意义：Unicode 码点"></a>rune 的意义：Unicode 码点</h2><p><code>rune</code> 类型的主要意义在于它<strong>代表一个 Unicode 码点（Code Point）</strong>。</p>
<h3 id="什么是-Unicode-码点？"><a href="#什么是-Unicode-码点？" class="headerlink" title="什么是 Unicode 码点？"></a>什么是 Unicode 码点？</h3><p>Unicode 是一个国际标准，旨在为世界上所有的文字和符号提供一个唯一的数字标识。这个唯一的数字就叫做<strong>码点（Code Point）</strong>。</p>
<p>例如：</p>
<ul>
<li>字母 ‘A’ 的 Unicode 码点是 U+0041</li>
<li>汉字 ‘中’ 的 Unicode 码点是 U+4E2D</li>
<li>表情符号 ‘😀’ 的 Unicode 码点是 U+1F600</li>
</ul>
<h2 id="为什么需要-rune-类型？"><a href="#为什么需要-rune-类型？" class="headerlink" title="为什么需要 rune 类型？"></a>为什么需要 rune 类型？</h2><p>这要从 Go 语言中字符串的内部表示说起。</p>
<h3 id="Go-字符串的内部表示"><a href="#Go-字符串的内部表示" class="headerlink" title="Go 字符串的内部表示"></a>Go 字符串的内部表示</h3><p>在 Go 语言中，<strong>字符串底层是以 UTF-8 编码的字节序列（<code>[]byte</code>）存储的</strong>。</p>
<p>UTF-8 是一种可变长度的编码方式：</p>
<ul>
<li>ASCII 字符（如英文字母、数字）占用 1 个字节</li>
<li>大部分常用汉字占用 3 个字节</li>
<li>一些生僻字符或表情符号可能占用 4 个字节</li>
</ul>
<h3 id="问题的出现"><a href="#问题的出现" class="headerlink" title="问题的出现"></a>问题的出现</h3><p>当我们需要遍历字符串或获取字符串长度时，这种可变长度的编码方式会带来问题：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s := <span class="string">&quot;Hello世界&quot;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// len(s) 返回的是字节数，不是字符数</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;字节长度:&quot;</span>, <span class="built_in">len</span>(s)) <span class="comment">// 输出: 11 (5个英文字母 + 2个汉字*3字节)</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 使用传统的 range 遍历字符串</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;按字节遍历:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;索引 %d: 字节 %v\n&quot;</span>, i, s[i])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 输出:</span></span><br><span class="line">    <span class="comment">// 索引 0: 字节 72 (H)</span></span><br><span class="line">    <span class="comment">// 索引 1: 字节 101 (e)</span></span><br><span class="line">    <span class="comment">// 索引 2: 字节 108 (l)</span></span><br><span class="line">    <span class="comment">// 索引 3: 字节 108 (l)</span></span><br><span class="line">    <span class="comment">// 索引 4: 字节 111 (o)</span></span><br><span class="line">    <span class="comment">// 索引 5: 字节 228 (世的第一个字节)</span></span><br><span class="line">    <span class="comment">// 索引 6: 字节 184 (世的第二个字节)</span></span><br><span class="line">    <span class="comment">// 索引 7: 字节 173 (世的第三个字节)</span></span><br><span class="line">    <span class="comment">// 索引 8: 字节 231 (界的第一个字节)</span></span><br><span class="line">    <span class="comment">// 索引 9: 字节 149 (界的第二个字节)</span></span><br><span class="line">    <span class="comment">// 索引 10: 字节 140 (界的第三个字节)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，按字节遍历并不能正确处理多字节的 Unicode 字符。</p>
<h3 id="rune-如何解决这个问题"><a href="#rune-如何解决这个问题" class="headerlink" title="rune 如何解决这个问题"></a>rune 如何解决这个问题</h3><p>使用 <code>rune</code> 类型，我们可以正确地处理 Unicode 字符：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s := <span class="string">&quot;Hello世界&quot;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 将字符串转换为 []rune 切片</span></span><br><span class="line">    runes := []<span class="type">rune</span>(s)</span><br><span class="line">    fmt.Println(<span class="string">&quot;rune 长度(字符数):&quot;</span>, <span class="built_in">len</span>(runes)) <span class="comment">// 输出: 7 (5个英文字母 + 2个汉字)</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 按 rune 遍历</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;按 rune 遍历:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i, r := <span class="keyword">range</span> runes &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;索引 %d: rune %U 字符 %c\n&quot;</span>, i, r, r)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 输出:</span></span><br><span class="line">    <span class="comment">// 索引 0: rune U+0048 字符 H</span></span><br><span class="line">    <span class="comment">// 索引 1: rune U+0065 字符 e</span></span><br><span class="line">    <span class="comment">// 索引 2: rune U+006C 字符 l</span></span><br><span class="line">    <span class="comment">// 索引 3: rune U+006C 字符 l</span></span><br><span class="line">    <span class="comment">// 索引 4: rune U+006F 字符 o</span></span><br><span class="line">    <span class="comment">// 索引 5: rune U+4E16 字符 世</span></span><br><span class="line">    <span class="comment">// 索引 6: rune U+754C 字符 界</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="rune-的主要用途"><a href="#rune-的主要用途" class="headerlink" title="rune 的主要用途"></a>rune 的主要用途</h2><h3 id="1-正确处理-Unicode-字符串长度"><a href="#1-正确处理-Unicode-字符串长度" class="headerlink" title="1. 正确处理 Unicode 字符串长度"></a>1. 正确处理 Unicode 字符串长度</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s := <span class="string">&quot;Go语言真棒！😀&quot;</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;字节长度: %d\n&quot;</span>, <span class="built_in">len</span>(s))           <span class="comment">// 字节长度: 17</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;字符长度: %d\n&quot;</span>, <span class="built_in">len</span>([]<span class="type">rune</span>(s)))   <span class="comment">// 字符长度: 8</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-字符串索引和切片操作"><a href="#2-字符串索引和切片操作" class="headerlink" title="2. 字符串索引和切片操作"></a>2. 字符串索引和切片操作</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s := <span class="string">&quot;Hello世界&quot;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取前5个字符（而不是前5个字节）</span></span><br><span class="line">    runes := []<span class="type">rune</span>(s)</span><br><span class="line">    firstFiveChars := <span class="type">string</span>(runes[:<span class="number">5</span>])</span><br><span class="line">    fmt.Println(firstFiveChars) <span class="comment">// 输出: Hello</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取第6个字符（第一个汉字）</span></span><br><span class="line">    sixthChar := <span class="type">string</span>(runes[<span class="number">5</span>])</span><br><span class="line">    fmt.Println(sixthChar) <span class="comment">// 输出: 世</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-字符处理和遍历"><a href="#3-字符处理和遍历" class="headerlink" title="3. 字符处理和遍历"></a>3. 字符处理和遍历</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s := <span class="string">&quot;Go语言😀&quot;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 正确的字符遍历方式</span></span><br><span class="line">    <span class="keyword">for</span> i, r := <span class="keyword">range</span> s &#123; <span class="comment">// range string 直接返回 rune 和字节索引</span></span><br><span class="line">        fmt.Printf(<span class="string">&quot;字节索引 %d: 字符 %c (rune %U)\n&quot;</span>, i, r, r)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 输出:</span></span><br><span class="line">    <span class="comment">// 字节索引 0: 字符 G (rune U+0047)</span></span><br><span class="line">    <span class="comment">// 字节索引 1: 字符 o (rune U+006F)</span></span><br><span class="line">    <span class="comment">// 字节索引 2: 字符 语 (rune U+8BED)</span></span><br><span class="line">    <span class="comment">// 字节索引 5: 字符 言 (rune U+8A00)</span></span><br><span class="line">    <span class="comment">// 字节索引 8: 字符 😀 (rune U+1F600)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-字符检测和转换"><a href="#4-字符检测和转换" class="headerlink" title="4. 字符检测和转换"></a>4. 字符检测和转换</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;unicode&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    runes := []<span class="type">rune</span>(<span class="string">&quot;Hello世界123&quot;</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> _, r := <span class="keyword">range</span> runes &#123;</span><br><span class="line">        <span class="keyword">switch</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> unicode.IsLetter(r):</span><br><span class="line">            fmt.Printf(<span class="string">&quot;%c 是字母\n&quot;</span>, r)</span><br><span class="line">        <span class="keyword">case</span> unicode.IsDigit(r):</span><br><span class="line">            fmt.Printf(<span class="string">&quot;%c 是数字\n&quot;</span>, r)</span><br><span class="line">        <span class="keyword">case</span> unicode.IsSpace(r):</span><br><span class="line">            fmt.Printf(<span class="string">&quot;%c 是空格\n&quot;</span>, r)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            fmt.Printf(<span class="string">&quot;%c 是其他字符\n&quot;</span>, r)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>rune</code> 类型在 Go 语言中的核心意义是：</p>
<ol>
<li><strong>正确表示 Unicode 字符</strong>：每个 <code>rune</code> 代表一个完整的 Unicode 码点。</li>
<li><strong>解决多字节字符处理问题</strong>：使我们能够准确计算字符串中的字符数、正确遍历字符串、以及进行字符级别的操作。</li>
<li><strong>国际化支持</strong>：使得 Go 程序能够正确处理各种语言的文本，包括中文、日文、韩文、阿拉伯文以及各种表情符号。</li>
</ol>
<p>理解 <code>rune</code> 类型对于任何需要处理文本的 Go 程序员来说都是至关重要的，尤其是在构建国际化应用时。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/shell-awk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/shell-awk/" class="post-title-link" itemprop="url">shell-awk</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:59:08" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/scripts/" itemprop="url" rel="index"><span itemprop="name">scripts</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>好的。<code>awk</code> 是我们运维工程师处理文本数据的“瑞士军刀”，功能极其强大。它可以像一个微型编程语言一样，对文本行和字段进行格式化、过滤、计算和报告。</p>
<p>掌握 <code>awk</code> 的核心在于理解它的基本工作模式：**<code>awk &#39;pattern &#123; action &#125;&#39; filename</code>**。</p>
<ul>
<li><p><strong>工作原理</strong>：<code>awk</code> <strong>逐行</strong>读取输入文件。对于每一行，它会检查是否匹配 <code>pattern</code>。如果匹配，就执行 <code>action</code> 中的代码。</p>
</li>
<li><p><strong>核心概念</strong>：</p>
<ul>
<li><strong>记录（Record）</strong>：<code>awk</code> 处理的单位，默认是一行文本。</li>
<li><strong>字段（Field）</strong>：每条记录中，通过<strong>字段分隔符</strong>分割出来的部分。默认的分隔符是空格或制表符。</li>
<li><strong>内置变量</strong>：<ul>
<li><code>$0</code>：表示整行记录。</li>
<li><code>$1</code>, <code>$2</code>, <code>$3</code>, …：表示第 1、第 2、第 3 个字段。</li>
<li><code>NF</code> (Number of Fields)：当前记录的字段总数。</li>
<li><code>NR</code> (Number of Records)：已处理的记录总数（即行号）。</li>
<li><code>FS</code> (Field Separator)：输入字段分隔符（默认为空格）。</li>
<li><code>OFS</code> (Output Field Separator)：输出字段分隔符（默认为空格）。</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="一、基本用法：字段提取与格式化输出"><a href="#一、基本用法：字段提取与格式化输出" class="headerlink" title="一、基本用法：字段提取与格式化输出"></a>一、基本用法：字段提取与格式化输出</h3><p>这是 <code>awk</code> 最常见的用途。</p>
<p><strong>假设我们有以下 <code>netstat.txt</code> 文件：</strong></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Proto</span> Recv-Q Send-Q Local-Address           Foreign-Address         State</span><br><span class="line"><span class="attribute">tcp</span>        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0.0.1:3306</span>          <span class="number">0.0.0.0</span>:*               LISTEN</span><br><span class="line"><span class="attribute">tcp</span>        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0.0.0:22</span>              <span class="number">0.0.0.0</span>:*               LISTEN</span><br><span class="line"><span class="attribute">tcp</span>        <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168.1.10:22</span>         <span class="number">192.168.1.100:54321</span>     ESTABLISHED</span><br><span class="line"><span class="attribute">tcp6</span>       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">80</span>                   :::*                    LISTEN</span><br></pre></td></tr></table></figure>

<p><strong>任务：提取本地地址和状态</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认以空格为分隔符，$4 是本地地址，$6 是状态</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $4, $6&#125;&#x27;</span> netstat.txt</span><br></pre></td></tr></table></figure>
<p><strong>输出：</strong></p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Local-Address State</span><br><span class="line"><span class="number">127.0.0.1:3306</span> LISTEN</span><br><span class="line"><span class="number">0.0.0.0:22</span> LISTEN</span><br><span class="line"><span class="number">192.168.1.10:22</span> ESTABLISHED</span><br><span class="line">:::<span class="number">80</span> LISTEN</span><br></pre></td></tr></table></figure>

<p><strong>任务：自定义输出格式</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 printf 进行格式化输出，更整洁</span></span><br><span class="line">awk <span class="string">&#x27;&#123;printf &quot;本地地址: %-25s | 状态: %s\n&quot;, $4, $6&#125;&#x27;</span> netstat.txt</span><br></pre></td></tr></table></figure>
<p><strong>输出：</strong></p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">本地地址: <span class="keyword">Local</span>-Address             | <span class="type">状态: State</span></span><br><span class="line">本地地址: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span>            | <span class="type">状态: LISTEN</span></span><br><span class="line">本地地址: <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">22</span>                | <span class="type">状态: LISTEN</span></span><br><span class="line">本地地址: <span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span>:<span class="number">22</span>           | <span class="type">状态: ESTABLISHED</span></span><br><span class="line">本地地址: :::<span class="number">80</span>                     | <span class="type">状态: LISTEN</span></span><br></pre></td></tr></table></figure>

<h3 id="二、使用模式（Pattern）进行行过滤"><a href="#二、使用模式（Pattern）进行行过滤" class="headerlink" title="二、使用模式（Pattern）进行行过滤"></a>二、使用模式（Pattern）进行行过滤</h3><p><code>pattern</code> 部分决定了 <code>action</code> 是否执行。它可以是正则表达式、条件判断等。</p>
<p><strong>假设我们有 <code>/etc/passwd</code> 文件，格式为 <code>user:pass:uid:gid:gecos:home:shell</code></strong></p>
<p><strong>任务：只打印 shell 为 <code>/bin/bash</code> 的用户</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 /.../ 表示正则表达式匹配</span></span><br><span class="line"><span class="comment"># $NF 表示最后一个字段</span></span><br><span class="line">awk -F<span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;$NF == &quot;/bin/bash&quot; &#123;print $1&#125;&#x27;</span> /etc/passwd</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-F&#39;:&#39;</code>：这是一个非常重要的选项，用于将<strong>输入字段分隔符（FS）</strong>设置为冒号。</li>
<li><code>$NF == &quot;/bin/bash&quot;</code>：这是一个条件<strong>模式</strong>。只有当最后一个字段完全等于 <code>&quot;/bin/bash&quot;</code> 时，<code>&#123;...&#125;</code> 中的 <code>action</code> 才会执行。</li>
</ul>
<p><strong>任务：打印 UID 大于 1000 的所有用户</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $3 &gt; 1000 是一个数值比较模式</span></span><br><span class="line">awk -F<span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;$3 &gt; 1000 &#123;printf &quot;用户名: %-15s UID: %s\n&quot;, $1, $3&#125;&#x27;</span> /etc/passwd</span><br></pre></td></tr></table></figure>

<h3 id="三、BEGIN-和-END-块：初始化与总结"><a href="#三、BEGIN-和-END-块：初始化与总结" class="headerlink" title="三、BEGIN 和 END 块：初始化与总结"></a>三、BEGIN 和 END 块：初始化与总结</h3><p><code>awk</code> 提供了两个特殊的 <code>pattern</code>：</p>
<ul>
<li><code>BEGIN &#123; ... &#125;</code>：在处理任何行<strong>之前</strong>执行一次。通常用于初始化变量、打印表头。</li>
<li><code>END &#123; ... &#125;</code>：在处理完所有行<strong>之后</strong>执行一次。通常用于进行最终计算、打印总计或摘要。</li>
</ul>
<p><strong>任务：统计系统上有多少个用户，并打印表头和结尾</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">awk -F<span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;BEGIN &#123;</span></span><br><span class="line"><span class="string">  print &quot;===== 系统用户列表 =====&quot;;</span></span><br><span class="line"><span class="string">  count = 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  # 对每一行都执行，增加计数器</span></span><br><span class="line"><span class="string">  count++;</span></span><br><span class="line"><span class="string">  print &quot;用户 &quot; NR &quot;: &quot; $1;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">END &#123;</span></span><br><span class="line"><span class="string">  print &quot;----------------------&quot;;</span></span><br><span class="line"><span class="string">  print &quot;总计: &quot; count &quot; 个用户。&quot;;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span> /etc/passwd</span><br></pre></td></tr></table></figure>
<p><strong>输出：</strong></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">===== 系统用户列表 =====</span></span><br><span class="line">用户 1: root</span><br><span class="line">用户 2: daemon</span><br><span class="line"><span class="bullet">...</span></span><br><span class="line"><span class="bullet"></span><span class="section">用户 25: ops_user</span></span><br><span class="line"><span class="section">----------------------</span></span><br><span class="line">总计: 25 个用户。</span><br></pre></td></tr></table></figure>

<h3 id="四、高级应用：计算与聚合"><a href="#四、高级应用：计算与聚合" class="headerlink" title="四、高级应用：计算与聚合"></a>四、高级应用：计算与聚合</h3><p><code>awk</code> 内部支持变量和算术运算，非常适合做数据聚合。</p>
<p><strong>任务：计算 Nginx 访问日志中，所有请求返回的总字节数</strong></p>
<p>假设 <code>access.log</code> 格式如下，第10个字段是返回的字节数：<br><code>1.2.3.4 - - [27/Oct/2023:10:00:00 +0800] &quot;GET /index.html HTTP/1.1&quot; 200 12345 ...</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  total_bytes += $10; # 将每行的第10个字段累加到变量 total_bytes</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">END &#123;</span></span><br><span class="line"><span class="string">  # 将字节转换为 MB 并打印</span></span><br><span class="line"><span class="string">  printf &quot;总传输流量: %.2f MB\n&quot;, total_bytes / 1024 / 1024;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span> access.log</span><br></pre></td></tr></table></figure>
<p><strong>输出：</strong></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">总传输流量: 153.21 MB</span></span><br></pre></td></tr></table></figure>

<p><strong>任务：统计访问量排名前 10 的 IP 地址（经典运维场景）</strong></p>
<p>这通常需要和 <code>sort</code>, <code>uniq</code> 等命令结合使用，但 <code>awk</code> 自身也能完成大部分工作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用关联数组 (associative array) 来统计</span></span><br><span class="line">awk <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  ip_counts[$1]++; # 使用 IP 地址($1)作为数组的键，值是出现次数</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">END &#123;</span></span><br><span class="line"><span class="string">  # 遍历数组并打印结果</span></span><br><span class="line"><span class="string">  for (ip in ip_counts) &#123;</span></span><br><span class="line"><span class="string">    print ip_counts[ip], ip;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span> access.log | <span class="built_in">sort</span> -nr | <span class="built_in">head</span> -n 10</span><br></pre></td></tr></table></figure>
<p>这里，<code>awk</code> 负责<strong>统计</strong>每个 IP 的出现次数，然后将结果通过<strong>管道</strong>交给 <code>sort -nr</code> (按数值倒序排) 和 <code>head</code> (取前10)，这是命令组合的典范。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><strong>基础</strong>：<code>awk &#39;&#123;print $1, $2&#125;&#39;</code> 用于提取和打印字段。</li>
<li><strong>分隔符</strong>：<code>awk -F&#39;分隔符&#39;</code> 是处理 CSV 或其他非空格分隔文件的关键。</li>
<li><strong>过滤</strong>：<code>awk &#39;pattern &#123;action&#125;&#39;</code> 用于根据条件（如 <code>$3 &gt; 1000</code> 或 <code>/error/</code>）只处理特定的行。</li>
<li><strong>报告</strong>：<code>BEGIN</code> 和 <code>END</code> 块用于生成带表头和摘要的专业报告。</li>
<li><strong>计算</strong>：<code>awk</code> 内置变量和运算能力，使其能直接在命令行完成复杂的数据统计和聚合任务。</li>
</ul>
<p>对于我们运维来说，<code>awk</code> 是日志分析、系统监控数据处理和自动化报告生成不可或缺的工具。熟练掌握它能极大地提升工作效率。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/19/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/21/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">六一</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">273</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/huiaz" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;huiaz" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">六一</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.7m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">25:34</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true}});</script></body>
</html>
