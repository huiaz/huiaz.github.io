<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hui&#39;s Blog">
<meta property="og:url" content="http://example.com/page/21/index.html">
<meta property="og:site_name" content="Hui&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="六一">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/21/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hui's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hui's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Code Life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/shell-clean/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/shell-clean/" class="post-title-link" itemprop="url">shell-clean</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:59:12" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/scripts/" itemprop="url" rel="index"><span itemprop="name">scripts</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="系统临时文件清理脚本"><a href="#系统临时文件清理脚本" class="headerlink" title="系统临时文件清理脚本"></a>系统临时文件清理脚本</h3><h3 id="核心特性"><a href="#核心特性" class="headerlink" title="核心特性"></a>核心特性</h3><ul>
<li><strong>可配置</strong>: 你可以轻松修改要清理的目录和文件的保留天数。</li>
<li><strong>安全第一</strong>:<ul>
<li>默认提供 <strong>Dry Run（演练）模式</strong>，只显示将要删除的文件，而不执行任何删除操作，防止误删。</li>
<li>强制要求以 root 权限运行，因为清理系统目录需要高权限。</li>
<li>只删除文件和空的子目录，避免意外删除仍在使用的目录结构。</li>
</ul>
</li>
<li><strong>详细日志</strong>: 记录每次运行的详细操作，包括清理的目录、释放的空间以及执行时间，便于审计和问题排查。</li>
<li><strong>效率</strong>: 使用 <code>find</code> 命令内置的 <code>-delete</code> 选项，比 <code>find ... -exec rm &#123;&#125; +</code> 更高效。</li>
</ul>
<hr>
<h3 id="Shell-脚本：clean-tmp-files-sh"><a href="#Shell-脚本：clean-tmp-files-sh" class="headerlink" title="Shell 脚本：clean_tmp_files.sh"></a>Shell 脚本：<code>clean_tmp_files.sh</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># Script: clean_tmp_files.sh</span></span><br><span class="line"><span class="comment"># Author: Your Name (Ops Engineer)</span></span><br><span class="line"><span class="comment"># Date: 2023-10-27</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Description:</span></span><br><span class="line"><span class="comment">#   定期清理系统中的临时文件和缓存。此脚本设计为通过 cron 任务自动运行。</span></span><br><span class="line"><span class="comment">#   它会删除指定目录下超过特定天数的旧文件和空目录。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Features:</span></span><br><span class="line"><span class="comment">#   - 可配置的保留天数和目标目录。</span></span><br><span class="line"><span class="comment">#   - Dry Run 模式，用于测试和验证，不执行实际删除。</span></span><br><span class="line"><span class="comment">#   - 详细的日志记录，包括释放的空间统计。</span></span><br><span class="line"><span class="comment">#   - 操作前进行 root 权限检查。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Usage:</span></span><br><span class="line"><span class="comment">#   常规执行: sudo ./clean_tmp_files.sh</span></span><br><span class="line"><span class="comment">#   演练模式: sudo ./clean_tmp_files.sh --dry-run</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 配置段 ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件保留天数：只删除修改时间早于 N 天的文件</span></span><br><span class="line">RETENTION_DAYS=14</span><br><span class="line"></span><br><span class="line"><span class="comment"># 要清理的目录列表 (使用数组)</span></span><br><span class="line"><span class="comment"># 推荐清理的目录：/tmp, /var/tmp, 以及应用产生的缓存/日志目录</span></span><br><span class="line">TARGET_DIRS=(</span><br><span class="line">  <span class="string">&quot;/tmp&quot;</span></span><br><span class="line">  <span class="string">&quot;/var/tmp&quot;</span></span><br><span class="line">  <span class="comment"># &quot;/var/log/old_logs&quot;  # 可根据需要添加其他目录</span></span><br><span class="line">  <span class="comment"># &quot;/home/*/.cache&quot;     # 清理所有用户的 .cache 目录 (请谨慎使用！)</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志文件路径</span></span><br><span class="line">LOG_FILE=<span class="string">&quot;/var/log/system_cleanup.log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 脚本主体 ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 变量</span></span><br><span class="line">DRY_RUN=<span class="literal">false</span></span><br><span class="line">TOTAL_SPACE_FREED_KB=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 函数：记录日志</span></span><br><span class="line"><span class="comment"># 用法: log_message &quot;INFO&quot; &quot;这是一条信息&quot;</span></span><br><span class="line"><span class="function"><span class="title">log_message</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> level=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">  <span class="built_in">local</span> message=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">  <span class="built_in">local</span> timestamp</span><br><span class="line">  timestamp=$(<span class="built_in">date</span> +<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">  <span class="comment"># 同时输出到控制台和日志文件</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;timestamp&#125;</span> [<span class="variable">$&#123;level&#125;</span>] <span class="variable">$&#123;message&#125;</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$&#123;LOG_FILE&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否为 root 用户</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$EUID</span> -ne 0 ]]; <span class="keyword">then</span></span><br><span class="line">   log_message <span class="string">&quot;ERROR&quot;</span> <span class="string">&quot;此脚本必须以 root 权限运行。&quot;</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析命令行参数</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;--dry-run&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">  DRY_RUN=<span class="literal">true</span></span><br><span class="line">  log_message <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;===== Dry Run 演练模式已启动，不会删除任何文件 =====&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">log_message <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;===== 系统清理任务开始 =====&quot;</span></span><br><span class="line">log_message <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;文件保留策略: 删除 <span class="variable">$&#123;RETENTION_DAYS&#125;</span> 天前的旧文件。&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 循环处理每个目标目录</span></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">dir</span> <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;TARGET_DIRS[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$dir</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    log_message <span class="string">&quot;WARN&quot;</span> <span class="string">&quot;目录不存在，跳过: <span class="variable">$&#123;dir&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">continue</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  log_message <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;正在处理目录: <span class="variable">$&#123;dir&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 1. 计算清理前的可用空间 (单位: KB)</span></span><br><span class="line">  space_before_kb=$(<span class="built_in">df</span> -k <span class="string">&quot;<span class="variable">$dir</span>&quot;</span> | <span class="built_in">tail</span> -n 1 | awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 2. 删除旧文件</span></span><br><span class="line">  log_message <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;查找并删除早于 <span class="variable">$&#123;RETENTION_DAYS&#125;</span> 天的文件...&quot;</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$DRY_RUN</span>&quot;</span> = <span class="literal">true</span> ]; <span class="keyword">then</span></span><br><span class="line">    find <span class="string">&quot;<span class="variable">$dir</span>&quot;</span> -<span class="built_in">type</span> f -mtime +<span class="string">&quot;<span class="variable">$&#123;RETENTION_DAYS&#125;</span>&quot;</span> -<span class="built_in">print</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="comment"># -xtype l 避免跨文件系统追查符号链接，增加安全性</span></span><br><span class="line">    <span class="comment"># 使用 -delete 更高效</span></span><br><span class="line">    find <span class="string">&quot;<span class="variable">$dir</span>&quot;</span> -xtype f -mtime +<span class="string">&quot;<span class="variable">$&#123;RETENTION_DAYS&#125;</span>&quot;</span> -delete</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 3. 删除遗留的空目录</span></span><br><span class="line">  <span class="comment"># 注意：从最深层开始删除，所以 -depth 是必须的</span></span><br><span class="line">  log_message <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;查找并删除空目录...&quot;</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$DRY_RUN</span>&quot;</span> = <span class="literal">true</span> ]; <span class="keyword">then</span></span><br><span class="line">    find <span class="string">&quot;<span class="variable">$dir</span>&quot;</span> -<span class="built_in">type</span> d -empty -<span class="built_in">print</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    find <span class="string">&quot;<span class="variable">$dir</span>&quot;</span> -<span class="built_in">type</span> d -empty -delete</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 4. 计算并报告释放的空间</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$DRY_RUN</span>&quot;</span> = <span class="literal">false</span> ]; <span class="keyword">then</span></span><br><span class="line">      space_after_kb=$(<span class="built_in">df</span> -k <span class="string">&quot;<span class="variable">$dir</span>&quot;</span> | <span class="built_in">tail</span> -n 1 | awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>)</span><br><span class="line">      space_freed_kb=$((space_after_kb - space_before_kb))</span><br><span class="line">      TOTAL_SPACE_FREED_KB=$((TOTAL_SPACE_FREED_KB + space_freed_kb))</span><br><span class="line">    </span><br><span class="line">      <span class="comment"># 将 KB 转换为更易读的 MB</span></span><br><span class="line">      space_freed_mb=$(<span class="built_in">echo</span> <span class="string">&quot;scale=2; <span class="variable">$&#123;space_freed_kb&#125;</span> / 1024&quot;</span> | bc)</span><br><span class="line">      log_message <span class="string">&quot;SUCCESS&quot;</span> <span class="string">&quot;在目录 <span class="variable">$&#123;dir&#125;</span> 中释放了约 <span class="variable">$&#123;space_freed_mb&#125;</span> MB 空间。&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 任务总结 ---</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$DRY_RUN</span>&quot;</span> = <span class="literal">false</span> ]; <span class="keyword">then</span></span><br><span class="line">    total_freed_mb=$(<span class="built_in">echo</span> <span class="string">&quot;scale=2; <span class="variable">$&#123;TOTAL_SPACE_FREED_KB&#125;</span> / 1024&quot;</span> | bc)</span><br><span class="line">    log_message <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;总共释放空间: 约 <span class="variable">$&#123;total_freed_mb&#125;</span> MB。&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">log_message <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;===== 系统清理任务结束 =====&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$&#123;LOG_FILE&#125;</span>&quot;</span> <span class="comment"># 在日志中添加空行，便于分隔</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<h3 id="如何使用和部署"><a href="#如何使用和部署" class="headerlink" title="如何使用和部署"></a>如何使用和部署</h3><ol>
<li><p><strong>保存脚本</strong>: 将上面的代码保存为 <code>clean_tmp_files.sh</code> 文件，例如放在 <code>/usr/local/sbin/</code> 目录下。</p>
</li>
<li><p><strong>授予执行权限</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> +x /usr/local/sbin/clean_tmp_files.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>安装 <code>bc</code> (如果需要)</strong>:  脚本使用 <code>bc</code> 来进行浮点数计算以显示MB。大多数系统自带，如果没有，请安装。</p>
<ul>
<li>Debian&#x2F;Ubuntu: <code>sudo apt-get install bc</code></li>
<li>CentOS&#x2F;RHEL: <code>sudo yum install bc</code></li>
</ul>
</li>
<li><p><strong>测试（Dry Run 模式）</strong>:<br>在执行任何实际删除之前，请务必先用 <code>--dry-run</code> 模式运行，检查脚本将要删除哪些文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> /usr/local/sbin/clean_tmp_files.sh --dry-run</span><br></pre></td></tr></table></figure>
<p>观察输出，确认列表中的文件都是可以安全删除的。</p>
</li>
<li><p><strong>正式执行</strong>:<br>确认无误后，不带参数运行脚本即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> /usr/local/sbin/clean_tmp_files.sh</span><br></pre></td></tr></table></figure>
<p>你可以通过 <code>tail -f /var/log/system_cleanup.log</code> 来实时查看日志。</p>
</li>
</ol>
<h3 id="设置-Cron-定时任务"><a href="#设置-Cron-定时任务" class="headerlink" title="设置 Cron 定时任务"></a>设置 Cron 定时任务</h3><p>要让这个脚本定期自动运行，最好的方式是使用 <code>cron</code>。</p>
<ol>
<li><p><strong>编辑 root 用户的 crontab</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> crontab -e</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>添加任务条目</strong>:<br>在文件末尾添加一行。例如，设置在<strong>每周日凌晨 3:30</strong> 执行清理任务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 每周日凌晨 3:30 执行系统临时文件清理任务</span><br><span class="line">30 3 * * 0 /usr/local/sbin/clean_tmp_files.sh &gt;/dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

<ul>
<li><code>30 3 * * 0</code>: 分、时、日、月、周（0代表周日）。</li>
<li><code>&gt;/dev/null 2&gt;&amp;1</code>: 这是很重要的部分。它会将脚本的所有标准输出（stdout）和标准错误（stderr）都重定向到 <code>/dev/null</code>（即丢弃）。因为我们已经在脚本内部实现了向 <code>/var/log/system_cleanup.log</code> 的日志记录，所以不需要 cron 再通过邮件发送输出了。</li>
</ul>
</li>
</ol>
<p>这样，你就拥有了一个自动化、安全且可追溯的系统清理方案。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/shell-notify/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/shell-notify/" class="post-title-link" itemprop="url">shell-notify</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:59:17" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/scripts/" itemprop="url" rel="index"><span itemprop="name">scripts</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="文件监控"><a href="#文件监控" class="headerlink" title="文件监控"></a>文件监控</h3><p>在 Shell 中，实现文件监控主要有两种策略：</p>
<ol>
<li><strong>轮询检查（Polling）</strong>：定时检查文件的元数据（如修改时间、大小、校验和），适用于对实时性要求不高的场景。</li>
<li><strong>事件驱动（Event-Driven）</strong>：利用系统工具（如 <code>inotifywait</code>）实时捕捉文件系统的事件，效率高，响应快，是生产环境中的<strong>首选方案</strong>。</li>
</ol>
<p>下面我将分别介绍这两种方法，并重点推荐使用 <code>inotifywait</code> 的专业方案。</p>
<hr>
<h3 id="方法一：轮询检查（基于-stat-和-md5sum）"><a href="#方法一：轮询检查（基于-stat-和-md5sum）" class="headerlink" title="方法一：轮询检查（基于 stat 和 md5sum）"></a>方法一：轮询检查（基于 <code>stat</code> 和 <code>md5sum</code>）</h3><p>这种方法简单直接，不依赖任何额外工具，但效率较低，且有延迟。</p>
<h4 id="核心思路"><a href="#核心思路" class="headerlink" title="核心思路"></a>核心思路</h4><ol>
<li>在一个无限循环 <code>while true; do ... done</code> 中执行。</li>
<li>记录文件当前的 MD5 校验和或修改时间。</li>
<li><code>sleep</code> 一段时间。</li>
<li>再次获取文件的校验和或修改时间，与之前记录的值进行比较。</li>
<li>如果发生变化，则执行相应操作（如发送警报、记录日志）。</li>
</ol>
<h4 id="示例脚本：监控-etc-hosts-文件的内容变化"><a href="#示例脚本：监控-etc-hosts-文件的内容变化" class="headerlink" title="示例脚本：监控 /etc/hosts 文件的内容变化"></a>示例脚本：监控 <code>/etc/hosts</code> 文件的内容变化</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># file_monitor_polling.sh: A simple file monitor using polling (md5sum).</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line">FILE_TO_WATCH=<span class="string">&quot;/etc/hosts&quot;</span></span><br><span class="line">SLEEP_INTERVAL=5 <span class="comment"># Check every 5 seconds</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Sanity Checks ---</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;<span class="variable">$FILE_TO_WATCH</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;错误: 文件不存在: <span class="variable">$FILE_TO_WATCH</span>&quot;</span> &gt;&amp;2</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;开始监控文件: <span class="variable">$FILE_TO_WATCH</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;按 [CTRL+C] 停止监控。&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Get initial checksum ---</span></span><br><span class="line">last_checksum=$(<span class="built_in">md5sum</span> <span class="string">&quot;<span class="variable">$FILE_TO_WATCH</span>&quot;</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;初始 MD5 校验和: <span class="variable">$last_checksum</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Monitoring Loop ---</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># Get current checksum</span></span><br><span class="line">    current_checksum=$(<span class="built_in">md5sum</span> <span class="string">&quot;<span class="variable">$FILE_TO_WATCH</span>&quot;</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Compare checksums</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$current_checksum</span>&quot;</span> != <span class="string">&quot;<span class="variable">$last_checksum</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        timestamp=$(<span class="built_in">date</span> +<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;[<span class="variable">$timestamp</span>] 文件已变更! (<span class="variable">$FILE_TO_WATCH</span>)&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;  - 旧校验和: <span class="variable">$last_checksum</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;  - 新校验和: <span class="variable">$current_checksum</span>&quot;</span></span><br><span class="line">      </span><br><span class="line">        <span class="comment"># 在这里执行你的操作，例如发送邮件、重启服务等</span></span><br><span class="line">        <span class="comment"># mail -s &quot;警报: $FILE_TO_WATCH 已被修改&quot; your_email@example.com &lt; /dev/null</span></span><br><span class="line">      </span><br><span class="line">        <span class="comment"># Update the checksum for the next check</span></span><br><span class="line">        last_checksum=<span class="string">&quot;<span class="variable">$current_checksum</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span> <span class="string">&quot;<span class="variable">$SLEEP_INTERVAL</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>优点</strong>：</p>
<ul>
<li>简单，无需额外工具。</li>
<li>可移植性强。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li><strong>性能差</strong>：频繁计算 MD5 对大文件来说是昂贵的。</li>
<li><strong>延迟高</strong>：变更发生在 <code>sleep</code> 期间，你无法立即知道。</li>
<li><strong>信息有限</strong>：你只知道文件被改了，但不知道是哪个进程、哪个用户改的，也不知道是哪种操作（写入、删除、重命名等）。</li>
</ul>
<hr>
<h3 id="方法二：事件驱动（基于-inotifywait）-专业推荐"><a href="#方法二：事件驱动（基于-inotifywait）-专业推荐" class="headerlink" title="方法二：事件驱动（基于 inotifywait）- 专业推荐"></a>方法二：事件驱动（基于 <code>inotifywait</code>）- 专业推荐</h3><p><code>inotify</code> 是 Linux 内核的一个子系统，它能监控文件系统事件并通知应用程序。<code>inotify-tools</code> 包中的 <code>inotifywait</code> 命令是其在 Shell 中的接口。</p>
<h4 id="核心优势"><a href="#核心优势" class="headerlink" title="核心优势"></a>核心优势</h4><ul>
<li><strong>实时性</strong>：事件发生时，内核立即通知，几乎没有延迟。</li>
<li><strong>高性能</strong>：由内核驱动，CPU 占用极低，比轮询高效得多。</li>
<li><strong>信息丰富</strong>：可以精确地监控多种事件，如 <code>modify</code> (修改), <code>create</code> (创建), <code>delete</code> (删除), <code>move</code> (移动), <code>access</code> (访问) 等。</li>
</ul>
<h4 id="安装-inotify-tools"><a href="#安装-inotify-tools" class="headerlink" title="安装 inotify-tools"></a>安装 <code>inotify-tools</code></h4><p>在大多数 Linux 发行版中，都可以通过包管理器轻松安装。</p>
<ul>
<li><strong>Debian&#x2F;Ubuntu</strong>: <code>sudo apt-get install inotify-tools</code></li>
<li><strong>CentOS&#x2F;RHEL</strong>: <code>sudo yum install inotify-tools</code></li>
</ul>
<h4 id="示例脚本：实时监控-var-log-app-目录"><a href="#示例脚本：实时监控-var-log-app-目录" class="headerlink" title="示例脚本：实时监控 /var/log/app/ 目录"></a>示例脚本：实时监控 <code>/var/log/app/</code> 目录</h4><p>这个脚本将监控一个目录下所有的新文件、修改和删除操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># file_monitor_inotify.sh: A professional file monitor using inotifywait.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line"><span class="comment"># 监控单个文件: DIR_TO_WATCH=&quot;/etc/nginx/nginx.conf&quot;</span></span><br><span class="line"><span class="comment"># 监控整个目录及其子目录:</span></span><br><span class="line">DIR_TO_WATCH=<span class="string">&quot;/var/log/app/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Sanity Checks ---</span></span><br><span class="line"><span class="comment"># 检查 inotifywait 命令是否存在</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">command</span> -v inotifywait &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;错误: 本脚本需要 &#x27;inotifywait&#x27; 命令，请安装 &#x27;inotify-tools&#x27; 包。&quot;</span> &gt;&amp;2</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$DIR_TO_WATCH</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;错误: 目录不存在: <span class="variable">$DIR_TO_WATCH</span>&quot;</span> &gt;&amp;2</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;实时监控目录: <span class="variable">$DIR_TO_WATCH</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;监控的事件: MODIFY, CREATE, DELETE&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;按 [CTRL+C] 停止监控。&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Monitoring Loop ---</span></span><br><span class="line"><span class="comment"># -m, --monitor:   持续监控，而不是在第一个事件后退出。</span></span><br><span class="line"><span class="comment"># -r, --recursive: 递归监控所有子目录。</span></span><br><span class="line"><span class="comment"># -q, --quiet:     只打印事件信息。</span></span><br><span class="line"><span class="comment"># -e &lt;event&gt;:      指定要监控的事件。</span></span><br><span class="line"><span class="comment"># --format:        自定义输出格式。</span></span><br><span class="line"><span class="comment">#    %T: 时间</span></span><br><span class="line"><span class="comment">#    %w: 监控的文件或目录的路径</span></span><br><span class="line"><span class="comment">#    %f: 触发事件的文件名 (如果有)</span></span><br><span class="line"><span class="comment">#    %e: 触发的事件名称</span></span><br><span class="line">inotifywait -m -q -r \</span><br><span class="line">    -e modify,create,delete \</span><br><span class="line">    --timefmt <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span> \</span><br><span class="line">    --format <span class="string">&#x27;%T %w%f %e&#x27;</span> \</span><br><span class="line">    <span class="string">&quot;<span class="variable">$DIR_TO_WATCH</span>&quot;</span> | <span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">        <span class="comment"># `read` 命令会逐行读取 inotifywait 的输出</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;[警报] 检测到文件系统事件: <span class="variable">$line</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 在这里执行你的自动化操作</span></span><br><span class="line">        <span class="comment"># 例如，如果配置文件被修改，则自动重载服务</span></span><br><span class="line">        <span class="comment"># if [[ &quot;$line&quot; == *&quot;/etc/nginx/nginx.conf MODIFY&quot;* ]]; then</span></span><br><span class="line">        <span class="comment">#    echo &quot;Nginx 配置文件已修改，正在尝试重载...&quot;</span></span><br><span class="line">        <span class="comment">#    systemctl reload nginx</span></span><br><span class="line">        <span class="comment"># fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>如何运行：</strong><br><code>./file_monitor_inotify.sh</code></p>
<p>当你在此目录下创建、修改或删除文件时，脚本会立即打印出类似下面的信息：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">实时监控目录: /<span class="keyword">var</span>/<span class="keyword">log</span>/<span class="keyword">app</span>/</span><br><span class="line">监控的事件: MODIFY, CREATE, DELETE</span><br><span class="line">按 [CTRL+C] 停止监控。</span><br><span class="line">[警报] 检测到文件系统事件: 2023-10-27 15:30:10 /<span class="keyword">var</span>/<span class="keyword">log</span>/<span class="keyword">app</span>/new_log.txt CREATE</span><br><span class="line">[警报] 检测到文件系统事件: 2023-10-27 15:30:15 /<span class="keyword">var</span>/<span class="keyword">log</span>/<span class="keyword">app</span>/new_log.txt MODIFY</span><br><span class="line">[警报] 检测到文件系统事件: 2023-10-27 15:30:20 /<span class="keyword">var</span>/<span class="keyword">log</span>/<span class="keyword">app</span>/new_log.txt DELETE_SELF</span><br></pre></td></tr></table></figure>

<h3 id="总结与选择"><a href="#总结与选择" class="headerlink" title="总结与选择"></a>总结与选择</h3><ul>
<li>对于<strong>临时</strong>或<strong>简单</strong>的检查，或者在无法安装新工具的受限环境中，<strong>轮询法</strong>是可行的。</li>
<li>对于<strong>所有生产级别的、需要高实时性和高性能</strong>的监控任务，**<code>inotifywait</code>** 是<strong>绝对的最佳选择</strong>。它更可靠、更高效，并能提供更丰富的上下文信息，是每个运维工程师都应该掌握的工具。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/shell-service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/shell-service/" class="post-title-link" itemprop="url">shell-service</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:59:21" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/scripts/" itemprop="url" rel="index"><span itemprop="name">scripts</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>检查系统中所有服务（基于 <code>systemd</code>）的状态。</p>
<hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># Script Name:  check_all_services.sh</span></span><br><span class="line"><span class="comment"># Description:  检查并分类系统中所有 systemd 服务的状态。</span></span><br><span class="line"><span class="comment"># Author:       [Your Name/Team]</span></span><br><span class="line"><span class="comment"># Date:         (creation date)</span></span><br><span class="line"><span class="comment"># Version:      1.1</span></span><br><span class="line"><span class="comment"># Pre-requisite: 运行在基于 systemd 的 Linux 系统上 (e.g., CentOS 7+, Ubuntu 15.04+, Debian 8+)。</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 定义颜色，让输出更易读 ---</span></span><br><span class="line">RED=<span class="string">&#x27;\033[0;31m&#x27;</span></span><br><span class="line">GREEN=<span class="string">&#x27;\033[0;32m&#x27;</span></span><br><span class="line">YELLOW=<span class="string">&#x27;\033[1;33m&#x27;</span></span><br><span class="line">BLUE=<span class="string">&#x27;\033[0;34m&#x27;</span></span><br><span class="line">NC=<span class="string">&#x27;\033[0m&#x27;</span> <span class="comment"># No Color</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 权限检查 ---</span></span><br><span class="line"><span class="comment"># 检查所有服务状态通常需要 root 权限，脚本应当先验证。</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$EUID</span> -ne 0 ]]; <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>警告: 此脚本需要 root 权限才能获取所有服务信息。正在以非 root 用户身份尝试...<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;部分服务状态可能无法获取。&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;BLUE&#125;</span>===========================================<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;BLUE&#125;</span>   正在检查系统所有服务状态...       <span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;BLUE&#125;</span>===========================================<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 初始化状态数组 ---</span></span><br><span class="line"><span class="comment"># 使用数组来存储不同状态的服务，便于分类报告。</span></span><br><span class="line"><span class="built_in">declare</span> -a active_services</span><br><span class="line"><span class="built_in">declare</span> -a failed_services</span><br><span class="line"><span class="built_in">declare</span> -a inactive_services</span><br><span class="line"><span class="built_in">declare</span> -a other_services</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 数据处理 ---</span></span><br><span class="line"><span class="comment"># 从 systemctl 获取所有服务单元，并通过循环进行处理。</span></span><br><span class="line"><span class="comment"># 使用 process substitution &#x27;&lt; &lt;(...)&#x27; 确保循环内的变量在循环结束后依然有效。</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> -r unit load active sub description; <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 跳过 systemctl 输出的表头和表尾</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$unit</span>&quot;</span> == <span class="string">&quot;UNIT&quot;</span> || -z <span class="string">&quot;<span class="variable">$unit</span>&quot;</span> || <span class="string">&quot;<span class="variable">$unit</span>&quot;</span> == <span class="string">&quot;LOAD&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据 &#x27;ActiveState&#x27; 进行分类</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$active</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">      <span class="string">&quot;active&quot;</span>)</span><br><span class="line">        active_services+=(<span class="string">&quot;<span class="variable">$unit</span> (<span class="variable">$&#123;sub&#125;</span>)&quot;</span>) <span class="comment"># (running), (exited), (waiting)</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">&quot;failed&quot;</span>)</span><br><span class="line">        <span class="comment"># 失败的服务是首要关注点</span></span><br><span class="line">        failed_services+=(<span class="string">&quot;<span class="variable">$unit</span>&quot;</span>)</span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">&quot;inactive&quot;</span>)</span><br><span class="line">        inactive_services+=(<span class="string">&quot;<span class="variable">$unit</span> (<span class="variable">$&#123;sub&#125;</span>)&quot;</span>) <span class="comment"># (dead)</span></span><br><span class="line">        ;;</span><br><span class="line">      *)</span><br><span class="line">        other_services+=(<span class="string">&quot;<span class="variable">$unit</span> (<span class="variable">$active</span>/<span class="variable">$sub</span>)&quot;</span>)</span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="comment"># --no-pager 确保命令不进入交互模式</span></span><br><span class="line"><span class="comment"># --type=service 只列出服务类型</span></span><br><span class="line"><span class="comment"># --all 显示所有单元，包括非活动的</span></span><br><span class="line"><span class="keyword">done</span> &lt; &lt;(systemctl list-units --<span class="built_in">type</span>=service --all --no-pager)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 生成报告 ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 打印摘要信息</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;--- 服务状态摘要 ---&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>Active/Running: <span class="variable">$&#123;#active_services[@]&#125;</span><span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>Failed:         <span class="variable">$&#123;#failed_services[@]&#125;</span><span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>Inactive/Dead:  <span class="variable">$&#123;#inactive_services[@]&#125;</span><span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----------------------&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 详细列出异常的服务（这是最重要的部分）</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;#failed_services[@]&#125;</span> -gt 0 ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>--- [!!] 以下服务处于失败状态 (Failed) [!!] ---<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">for</span> service <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;failed_services[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;  - <span class="variable">$&#123;RED&#125;</span><span class="variable">$&#123;service&#125;</span><span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>--- [OK] 系统中没有处于 &#x27;failed&#x27; 状态的服务 ---<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 可选：列出未运行的服务，用于排查依赖问题或确认服务已停止</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;#inactive_services[@]&#125;</span> -gt 0 ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>--- [+] 以下服务处于非活动状态 (Inactive/Dead) ---<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="comment"># 如果非活动的服务太多，可以只显示一部分，或者添加一个命令行参数来控制是否显示</span></span><br><span class="line">    <span class="comment"># 在此我们全部显示</span></span><br><span class="line">    <span class="keyword">for</span> service <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;inactive_services[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;  - <span class="variable">$&#123;service&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 检查是否有需要关注的 &quot;failed&quot; 服务，并据此设置退出码</span></span><br><span class="line"><span class="comment"># 这对于自动化任务链（如 Jenkins job）非常重要</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;#failed_services[@]&#125;</span> -gt 0 ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>总结: 系统存在严重的服务故障，请立即排查！<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1 <span class="comment"># 以失败状态码退出，表示有问题</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>总结: 系统服务状态检查通过，无严重故障。<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 0 <span class="comment"># 以成功状态码退出</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="如何使用这个脚本"><a href="#如何使用这个脚本" class="headerlink" title="如何使用这个脚本"></a>如何使用这个脚本</h3><ol>
<li><strong>保存脚本</strong>: 将上面的代码保存到一个文件中，例如 <code>check_services.sh</code>。</li>
<li><strong>授予执行权限</strong>: 在终端中运行 <code>chmod +x check_services.sh</code>。</li>
<li><strong>执行脚本</strong>:<ul>
<li>推荐使用 <code>sudo</code> 执行以获取最全的信息：<code>sudo ./check_services.sh</code></li>
<li>不使用 <code>sudo</code> 也能运行，但可能会因为权限不足而漏掉一些信息。</li>
</ul>
</li>
</ol>
<h3 id="这个脚本的优点（运维工程师视角）"><a href="#这个脚本的优点（运维工程师视角）" class="headerlink" title="这个脚本的优点（运维工程师视角）"></a>这个脚本的优点（运维工程师视角）</h3><ul>
<li><strong>自动化和高效</strong>: 一键执行，替代了手动敲打多个命令并肉眼分析的繁琐过程。</li>
<li><strong>突出重点</strong>: 使用<strong>颜色</strong>和<strong>分类</strong>将最需要关注的 <code>failed</code> 服务放在最显眼的位置，大大缩短了故障发现时间。</li>
<li><strong>信息全面</strong>: 不仅报告了失败的服务，也列出了未运行的服务，这对于判断是“正常停止”还是“异常退出”非常有帮助。</li>
<li><strong>健壮性</strong>: 脚本首先检查了运行权限，并给出了友好的提示。</li>
<li><strong>适用于自动化流水线</strong>: 脚本的<strong>退出码 (<code>exit 0</code> 或 <code>exit 1</code>)</strong> 设计使其可以无缝集成到 Jenkins、Ansible 或其他自动化工具中。如果脚本返回 <code>1</code>，自动化系统就知道任务失败，可以触发告警或后续动作。</li>
<li><strong>代码清晰</strong>: 良好的注释和变量命名使得脚本易于理解和维护，方便团队协作。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/shell-%E5%8F%82%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/shell-%E5%8F%82%E6%95%B0/" class="post-title-link" itemprop="url">Shell-参数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:56:13" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/scripts/" itemprop="url" rel="index"><span itemprop="name">scripts</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>—- | :————– | :———————————————————– |<br>| <strong><code>$0</code></strong> | <code>./backup.sh</code>   | 脚本的名称，即命令本身。                                     |<br>| <strong><code>$1</code></strong> | <code>/var/www/html</code> | 第一个参数。                                                 |<br>| <strong><code>$2</code></strong> | <code>/mnt/backups</code>  | 第二个参数。                                                 |<br>| <strong><code>$3</code></strong> | (未设置，为空)  | 第三个参数。                                                 |<br>| …      | …             | 以此类推。对于超过 9 的参数，需要用花括号括起来，如 <code>$&#123;10&#125;</code>。 |</p>
<h3 id="特殊的位置相关变量"><a href="#特殊的位置相关变量" class="headerlink" title="特殊的位置相关变量"></a>特殊的位置相关变量</h3><p>除了 <code>$0</code>, <code>$1</code>, <code>$2</code> 等，还有一些特殊变量可以让我们更方便地处理所有参数。这些变量在运维脚本中极其常用。</p>
<table>
<thead>
<tr>
<th align="left">变量</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong><code>$#</code></strong></td>
<td align="left"><strong>参数的总个数</strong>。不包括 <code>$0</code>。在上面的例子中，<code>$#</code> 的值是 <code>2</code>。这是检查用户输入是否正确的关键。</td>
</tr>
<tr>
<td align="left"><strong><code>$*</code></strong></td>
<td align="left"><strong>所有参数的单个字符串</strong>。它将所有位置参数（<code>$1</code>, <code>$2</code>, …）视为一个<strong>单一的字符串</strong>，参数之间默认由环境变量 <code>IFS</code> (内部字段分隔符，通常是空格) 的第一个字符分隔。例如 <code>&quot;$1 $2 $3&quot;</code>。</td>
</tr>
<tr>
<td align="left"><strong><code>$@</code></strong></td>
<td align="left"><strong>所有参数的独立字符串列表</strong>。它将每个位置参数（<code>$1</code>, <code>$2</code>, …）视为一个<strong>独立的、被引起来的字符串</strong>。例如 <code>&quot;$1&quot; &quot;$2&quot; &quot;$3&quot;</code>。<strong>这是在循环中安全处理所有参数的黄金标准</strong>。</td>
</tr>
<tr>
<td align="left"><strong><code>$?</code></strong></td>
<td align="left"><strong>上一个命令的退出状态码</strong>。虽然不是严格意义上的位置参数，但它与参数处理紧密相关，用于判断操作是否成功。<code>0</code> 表示成功，非 <code>0</code> 表示失败。</td>
</tr>
</tbody></table>
<h3 id="vs-的关键区别（运维必知）"><a href="#vs-的关键区别（运维必知）" class="headerlink" title="$* vs. $@ 的关键区别（运维必知）"></a><code>$*</code> vs. <code>$@</code> 的关键区别（运维必知）</h3><p>当<strong>不使用双引号</strong>时，<code>$*</code> 和 <code>$@</code> 的行为是相同的。但当<strong>使用双引号</strong>时，它们的区别就至关重要了，尤其是在处理包含空格的参数时。</p>
<p><strong>始终优先使用 <code>&quot;$@&quot;</code></strong></p>
<p><strong>示例脚本 <code>test_params.sh</code>：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--- 使用 \&quot;\$*\&quot; ---&quot;</span></span><br><span class="line"><span class="keyword">for</span> arg <span class="keyword">in</span> <span class="string">&quot;$*&quot;</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;参数: &#x27;<span class="variable">$arg</span>&#x27;&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--- 使用 \&quot;\$@\&quot; ---&quot;</span></span><br><span class="line"><span class="keyword">for</span> arg <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;参数: &#x27;<span class="variable">$arg</span>&#x27;&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>执行:</strong><br><code>./test_params.sh &quot;file one.txt&quot; &quot;file two.log&quot; &quot;a&quot;</code></p>
<p><strong>输出:</strong></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--- 使用 <span class="string">&quot;$*&quot;</span> ---</span><br><span class="line">参数: &#x27;<span class="keyword">file</span> <span class="keyword">one</span>.txt <span class="keyword">file</span> <span class="keyword">two</span>.<span class="keyword">log</span> a&#x27;  # 所有参数被合并成了一个字符串</span><br><span class="line"></span><br><span class="line">--- 使用 <span class="string">&quot;$@&quot;</span> ---</span><br><span class="line">参数: &#x27;<span class="keyword">file</span> <span class="keyword">one</span>.txt&#x27;                  # 每个参数都保持独立</span><br><span class="line">参数: &#x27;<span class="keyword">file</span> <span class="keyword">two</span>.<span class="keyword">log</span>&#x27;</span><br><span class="line">参数: &#x27;a&#x27;</span><br></pre></td></tr></table></figure>
<p><strong>结论</strong>：在需要遍历所有参数的场景（如批量操作文件、服务器列表），必须使用 <code>for arg in &quot;$@&quot;</code> 来确保每个参数被正确处理。</p>
<h3 id="使用方法与实战示例"><a href="#使用方法与实战示例" class="headerlink" title="使用方法与实战示例"></a>使用方法与实战示例</h3><h4 id="示例-1-强制用户提供正确数量的参数"><a href="#示例-1-强制用户提供正确数量的参数" class="headerlink" title="示例 1: 强制用户提供正确数量的参数"></a>示例 1: 强制用户提供正确数量的参数</h4><p>一个健壮的脚本应该首先检查用户是否提供了必要的参数。</p>
<p><strong><code>backup.sh</code>:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查参数数量是否不等于 2</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -ne 2 ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;错误: 参数数量不正确！&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;用法: <span class="variable">$0</span> &lt;源目录&gt; &lt;目标目录&gt;&quot;</span></span><br><span class="line">  <span class="built_in">exit</span> 1 <span class="comment"># 以错误状态码退出</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">SOURCE_DIR=<span class="variable">$1</span></span><br><span class="line">DEST_DIR=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;脚本名称: <span class="variable">$0</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;源目录: <span class="variable">$&#123;SOURCE_DIR&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;目标目录: <span class="variable">$&#123;DEST_DIR&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;开始备份...&quot;</span></span><br><span class="line"><span class="comment"># rsync -avh &quot;$&#123;SOURCE_DIR&#125;&quot; &quot;$&#123;DEST_DIR&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>执行:</strong></p>
<ul>
<li><code>./backup.sh /my/data</code><ul>
<li>输出: <code>错误: 参数数量不正确！...</code></li>
</ul>
</li>
<li><code>./backup.sh /my/data /backup/target</code><ul>
<li>输出: <code>脚本名称: ./backup.sh ...</code> 正常执行。</li>
</ul>
</li>
</ul>
<h4 id="示例-2-批量操作多个目标"><a href="#示例-2-批量操作多个目标" class="headerlink" title="示例 2: 批量操作多个目标"></a>示例 2: 批量操作多个目标</h4><p>这是一个典型的运维场景，比如检查多台服务器上某个服务的状态。</p>
<p><strong><code>check_services.sh</code>:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">SERVICE_NAME=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否至少提供了服务名</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -lt 1 ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;错误: 请至少提供一个服务名称作为参数。&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;用法: <span class="variable">$0</span> &lt;服务名&gt; [服务器1_IP] [服务器2_IP] ...&quot;</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 shift 将第一个参数（服务名）消耗掉，剩下的就是服务器列表</span></span><br><span class="line"><span class="built_in">shift</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果没有提供服务器列表，则默认检查本地</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;未提供服务器列表，将检查本地服务 [<span class="variable">$&#123;SERVICE_NAME&#125;</span>] 的状态...&quot;</span></span><br><span class="line">  systemctl status <span class="string">&quot;<span class="variable">$&#123;SERVICE_NAME&#125;</span>&quot;</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;将在以下服务器上批量检查服务 [<span class="variable">$&#123;SERVICE_NAME&#125;</span>] 的状态:&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 &quot;$@&quot; 安全地遍历所有剩余的参数（服务器列表）</span></span><br><span class="line"><span class="keyword">for</span> server <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;--- 检查 <span class="variable">$&#123;server&#125;</span> ---&quot;</span></span><br><span class="line">  ssh <span class="string">&quot;user@<span class="variable">$&#123;server&#125;</span>&quot;</span> <span class="string">&quot;systemctl is-active <span class="variable">$&#123;SERVICE_NAME&#125;</span>&quot;</span></span><br><span class="line">  <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;状态: 运行中&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;状态: 未运行或失败&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>执行:</strong> <code>./check_services.sh nginx 192.168.1.100 192.168.1.101</code></p>
<p><strong>解释</strong>：</p>
<ol>
<li><code>SERVICE_NAME=&quot;$1&quot;</code> 保存第一个参数 <code>nginx</code>。</li>
<li><code>shift</code> 命令会将所有位置参数向左移动一位。<code>$1</code> 被丢弃，原来的<code>$2</code>(<code>192.168.1.100</code>) 成为新的 <code>$1</code>，原来的 <code>$3</code> 成为新的 <code>$2</code>。<code>$#</code> 的值也会相应减少。</li>
<li><code>for server in &quot;$@&quot;</code> 循环遍历新的参数列表，即所有服务器 IP。</li>
</ol>
<p>掌握位置参数是编写功能强大、灵活且用户友好的 Shell 脚本的第一步。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/shell-%E7%AE%A1%E9%81%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/shell-%E7%AE%A1%E9%81%93/" class="post-title-link" itemprop="url">shell-管道</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：21:57:23" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/scripts/" itemprop="url" rel="index"><span itemprop="name">scripts</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="管道（Pipeline）"><a href="#管道（Pipeline）" class="headerlink" title="管道（Pipeline）"></a>管道（Pipeline）</h3><hr>
<h3 id="一、管道（-）的机制是什么？"><a href="#一、管道（-）的机制是什么？" class="headerlink" title="一、管道（|）的机制是什么？"></a>一、管道（<code>|</code>）的机制是什么？</h3><p>从机制上讲，管道符 <code>|</code> 做了一件非常简单但强大的事情：<strong>它将前一个命令的标准输出（stdout）连接到后一个命令的标准输入（stdin）。</strong></p>
<p>为了完全理解这一点，你必须先了解三个标准的 I&#x2F;O 流：</p>
<ol>
<li>**标准输入 (stdin)**：文件描述符为 <code>0</code>。命令默认从这里读取数据（通常是键盘）。</li>
<li>**标准输出 (stdout)**：文件描述符为 <code>1</code>。命令默认向这里写入正常的输出（通常是屏幕）。</li>
<li>**标准错误 (stderr)**：文件描述符为 <code>2</code>。命令默认向这里写入错误或诊断信息（通常也是屏幕）。</li>
</ol>
<p>当你在两个命令之间放置一个 <code>|</code> 时，Shell 会在内存中创建一个管道，然后：</p>
<ul>
<li><strong>重定向</strong>：将 <code>command1</code> 的 <code>stdout</code> 重定向到这个管道的写入端。</li>
<li><strong>重定向</strong>：将 <code>command2</code> 的 <code>stdin</code> 重定向到这个管道的读取端。</li>
<li><strong>并发执行</strong>：<code>command1</code> 和 <code>command2</code> <strong>同时</strong>开始执行。<code>command1</code> 产生输出，<code>command2</code> 立即可以开始读取和处理，无需等待 <code>command1</code> 完全结束。这极大地提高了效率，尤其是在处理大数据流时。</li>
</ul>
<p><strong>一个关键点</strong>：默认情况下，管道**只连接 <code>stdout</code>**。<code>stderr</code>（错误信息）不会通过管道传递，它会直接显示在终端上。</p>
<hr>
<h3 id="二、核心应用场景"><a href="#二、核心应用场景" class="headerlink" title="二、核心应用场景"></a>二、核心应用场景</h3><p>管道的本质是<strong>数据流处理</strong>。我们通过组合各种小程序，构建一条数据处理流水线，对数据进行<strong>过滤、转换、聚合、统计</strong>。</p>
<p>以下是一些运维工作中经典的管道应用。</p>
<h4 id="1-数据过滤（Filtering）"><a href="#1-数据过滤（Filtering）" class="headerlink" title="1. 数据过滤（Filtering）"></a>1. 数据过滤（Filtering）</h4><p>这是最常见的应用。从大量输出中筛选出我们关心的行。</p>
<p><strong>场景</strong>：在 Nginx 的访问日志中查找所有 404 错误。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat 会把文件内容输出到 stdout</span></span><br><span class="line"><span class="comment"># grep 从它的 stdin 读取数据，并只输出匹配 &quot; 404 &quot; 的行</span></span><br><span class="line"><span class="built_in">cat</span> /var/log/nginx/access.log | grep <span class="string">&quot; 404 &quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>专业实践</strong>：避免“无用的 cat”（Useless Use of cat）。<code>grep</code> 本身就可以接收文件名作为参数，以上命令可以优化为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot; 404 &quot;</span> /var/log/nginx/access.log</span><br></pre></td></tr></table></figure>
<p>管道真正的威力体现在多级过滤中。</p>
<p><strong>场景</strong>：查找 SSH 登录失败，且尝试用户为 <code>root</code> 的日志。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u sshd | grep <span class="string">&quot;Failed password&quot;</span> | grep <span class="string">&quot;for root&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-数据转换（Transforming）"><a href="#2-数据转换（Transforming）" class="headerlink" title="2. 数据转换（Transforming）"></a>2. 数据转换（Transforming）</h4><p>使用 <code>sed</code>, <code>awk</code>, <code>tr</code>, <code>cut</code> 等工具修改或提取数据流中的特定部分。</p>
<p><strong>场景</strong>：列出当前系统中所有用户的 Shell 类型，并去除重复项。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. awk -F&#x27;:&#x27; &#x27;&#123;print $7&#125;&#x27;：以冒号为分隔符，打印第 7 个字段（Shell 路径）</span></span><br><span class="line"><span class="comment"># 2. sort：对结果进行排序，这是 uniq 的前提</span></span><br><span class="line"><span class="comment"># 3. uniq：删除连续的重复行</span></span><br><span class="line"><span class="built_in">cat</span> /etc/passwd | awk -F<span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print $7&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span></span><br></pre></td></tr></table></figure>

<h4 id="3-聚合与统计（Aggregation-Counting）"><a href="#3-聚合与统计（Aggregation-Counting）" class="headerlink" title="3. 聚合与统计（Aggregation &amp; Counting）"></a>3. 聚合与统计（Aggregation &amp; Counting）</h4><p>使用 <code>wc</code>, <code>sort</code>, <code>uniq</code> 等工具对数据进行计数和汇总。</p>
<p><strong>场景</strong>：统计当前服务器上每个 IP 的 TCP 连接数，并按连接数从高到低排序。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. netstat -nt：列出所有 TCP 连接，不解析主机名</span></span><br><span class="line"><span class="comment"># 2. grep &#x27;^tcp&#x27;：只保留 TCP 连接行</span></span><br><span class="line"><span class="comment"># 3. awk &#x27;&#123;print $5&#125;&#x27;：提取第 5 列（远程地址）</span></span><br><span class="line"><span class="comment"># 4. sed &#x27;s/::ffff://&#x27; | cut -d: -f1：清理 IPv6 前缀，并按冒号分割，取 IP 部分</span></span><br><span class="line"><span class="comment"># 5. sort | uniq -c：排序并统计每个 IP 的出现次数</span></span><br><span class="line"><span class="comment"># 6. sort -nr：按数值反向（从大到小）排序</span></span><br><span class="line">netstat -nt | grep <span class="string">&#x27;^tcp&#x27;</span> | awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span> | sed <span class="string">&#x27;s/::ffff://&#x27;</span> | <span class="built_in">cut</span> -d: -f1 | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br></pre></td></tr></table></figure>
<p>这条命令完美地展示了如何通过一条流水线解决一个复杂的运维问题。</p>
<hr>
<h3 id="三、专业脚本中的最佳实践"><a href="#三、专业脚本中的最佳实践" class="headerlink" title="三、专业脚本中的最佳实践"></a>三、专业脚本中的最佳实践</h3><p>在编写自动化脚本时，使用管道需要注意以下几点，以确保脚本的健壮性。</p>
<h4 id="1-使用-set-o-pipefail"><a href="#1-使用-set-o-pipefail" class="headerlink" title="1. 使用 set -o pipefail"></a>1. 使用 <code>set -o pipefail</code></h4><p>默认情况下，一个管道命令的退出状态码 (<code>$?</code>) 只由<strong>最后一个命令</strong>决定。这意味着即使前面的命令失败了，只要最后一个命令成功（例如 <code>wc -l</code>），整个管道也会被认为是成功的。这会掩盖错误，非常危险。</p>
<p><code>set -o pipefail</code> 可以改变这个行为：<strong>只要管道中任何一个命令以非零状态退出，整个管道的退出状态码就是那个失败命令的状态码。</strong></p>
<p><strong>示例：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -o pipefail <span class="comment"># &lt;--- 关键！</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设 non_existent_command 不存在</span></span><br><span class="line">non_existent_command | <span class="built_in">echo</span> <span class="string">&quot;This part will run&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果没有 set -o pipefail, $? 会是 0 (因为 echo 成功了)</span></span><br><span class="line"><span class="comment"># 如果有 set -o pipefail, $? 会是 127 (命令未找到)</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Exit status: $?&quot;</span> </span><br></pre></td></tr></table></figure>
<p><strong>建议：在所有需要可靠错误处理的 Shell 脚本开头都加上 <code>set -o pipefail</code>。</strong></p>
<h4 id="2-处理-stderr"><a href="#2-处理-stderr" class="headerlink" title="2. 处理 stderr"></a>2. 处理 <code>stderr</code></h4><p>如果你想让错误信息也进入管道（例如，统一记录到日志文件），你需要将 <code>stderr</code> 重定向到 <code>stdout</code>。</p>
<p><code>2&gt;&amp;1</code> 就是这个作用：将文件描述符 <code>2</code> (stderr) 重定向到文件描述符 <code>1</code> (stdout)。</p>
<p><strong>场景</strong>：执行一个可能会产生正常输出和错误信息的命令，并用 <code>grep</code> 同时过滤它们。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># find 命令如果遇到权限不足的目录会产生 stderr</span></span><br><span class="line"><span class="comment"># 2&gt;&amp;1 将这些错误信息和正常找到的文件路径一起送入 grep 的 stdin</span></span><br><span class="line">find / -name <span class="string">&quot;*.log&quot;</span> 2&gt;&amp;1 | grep <span class="string">&quot;Permission denied&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><strong>机制</strong>：管道 <code>|</code> 将左侧命令的 <code>stdout</code> 连接到右侧命令的 <code>stdin</code>，并让它们并发执行。</li>
<li><strong>应用</strong>：通过组合 <code>grep</code>, <code>awk</code>, <code>sed</code>, <code>sort</code>, <code>uniq</code>, <code>wc</code> 等命令，构建数据处理流水线，实现高效的<strong>过滤、转换和统计</strong>。</li>
<li><strong>专业实践</strong>：<ul>
<li>在脚本中始终使用 <code>set -o pipefail</code> 来确保能捕捉到管道中的任何失败。</li>
<li>了解 <code>2&gt;&amp;1</code> 的用法，以便在需要时将 <code>stderr</code> 也纳入管道处理。</li>
</ul>
</li>
</ul>
<p>熟练掌握管道，是区分 Shell 新手和专家的分水岭，也是我们运维工程师实现高效自动化的基石。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/top/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/top/" class="post-title-link" itemprop="url">top</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:08:29" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/Command/" itemprop="url" rel="index"><span itemprop="name">Command</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Linux-top-命令"><a href="#Linux-top-命令" class="headerlink" title="Linux top 命令"></a>Linux <code>top</code> 命令</h3><h3 id="top-命令是什么？"><a href="#top-命令是什么？" class="headerlink" title="top 命令是什么？"></a><code>top</code> 命令是什么？</h3><p><code>top</code>（Table of Processes 的缩写）是 Linux 和其他类 Unix 操作系统中最常用的性能监控工具之一。它提供了一个动态、实时的系统进程视图，可以帮助系统管理员和开发者监控系统负载、识别资源占用高的进程，从而进行性能分析和故障排查。</p>
<hr>
<h3 id="top-命令界面详解"><a href="#top-命令界面详解" class="headerlink" title="top 命令界面详解"></a><code>top</code> 命令界面详解</h3><p>当您在终端输入 <code>top</code> 并回车后，会看到一个全屏的、持续更新的界面。这个界面主要分为两部分：<strong>系统摘要信息区</strong> 和 <strong>进程列表区</strong>。</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">top - 14:30:50 up<span class="number"> 3 </span>days, 21:22, <span class="number"> 1 </span>user,  load average: 0.05, 0.08, 0.09</span><br><span class="line">Tasks:<span class="number"> 236 </span>total,  <span class="number"> 1 </span>running,<span class="number"> 235 </span>sleeping,  <span class="number"> 0 </span>stopped,  <span class="number"> 0 </span>zombie</span><br><span class="line">%Cpu(s):  1.5 us,  0.5 sy,  0.0 ni, 98.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">MiB Mem :  15833.6 total,   7938.4 free,   4855.2 used,   3040.0 buff/cache</span><br><span class="line">MiB Swap:   2048.0 total,   2048.0 free,      0.0 used.  10654.7 avail Mem</span><br><span class="line"></span><br><span class="line">    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND</span><br><span class="line"> <span class="number"> 1234 </span>root     <span class="number"> 20 </span> <span class="number"> 0 </span> 12.5g   1.1g   123m S   3.0   7.2   12:34.56 application</span><br><span class="line"> <span class="number"> 5678 </span>mysql    <span class="number"> 20 </span> <span class="number"> 0 </span>  8.2g 512.5m    12m S   1.5   3.2   5:43.21  mysqld</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>



<h4 id="第一部分：系统摘要信息-Summary-Area"><a href="#第一部分：系统摘要信息-Summary-Area" class="headerlink" title="第一部分：系统摘要信息 (Summary Area)"></a>第一部分：系统摘要信息 (Summary Area)</h4><ol>
<li><strong>第一行：任务队列信息</strong><ul>
<li><code>top - 14:30:50</code>：当前系统时间。</li>
<li><code>up 3 days, 21:22</code>：系统已运行时间。</li>
<li><code>1 user</code>：当前登录的用户数。</li>
<li><code>load average: 0.05, 0.08, 0.09</code>：系统负载平均值，分别对应过去 1 分钟、5 分钟、15 分钟的平均负载。这个值可以直观地表示系统的繁忙程度。<ul>
<li><strong>解读</strong>：如果这个值除以 CPU 核心数，结果持续大于 1，说明 CPU 可能存在瓶颈。</li>
</ul>
</li>
</ul>
</li>
<li><strong>第二行：任务（进程）状态</strong><ul>
<li><code>Tasks: 236 total</code>：当前总进程数。</li>
<li><code>1 running</code>：正在运行的进程数。</li>
<li><code>235 sleeping</code>：正在“睡眠”（等待事件或资源）的进程数。</li>
<li><code>0 stopped</code>：被停止的进程数（例如通过 <code>Ctrl+Z</code>）。</li>
<li><code>0 zombie</code>：僵尸进程数。如果这个值不为 0，需要关注，可能存在程序缺陷。</li>
</ul>
</li>
<li><strong>第三行：CPU 状态</strong><ul>
<li><code>%Cpu(s):</code> 显示了 CPU 时间的分配情况。</li>
<li><code>us</code> (user)：用户空间程序占用的 CPU 百分比。</li>
<li><code>sy</code> (system)：内核空间程序占用的 CPU 百分比。</li>
<li><code>ni</code> (nice)：被调整过优先级的用户进程占用的 CPU 百分比。</li>
<li><code>id</code> (idle)：空闲 CPU 百分比。<strong>这个值越高，说明 CPU 越空闲</strong>。</li>
<li><code>wa</code> (I&#x2F;O wait)：等待 I&#x2F;O 操作完成所占用的 CPU 百分比。<strong>这个值如果持续很高，表明磁盘 I&#x2F;O 可能存在瓶颈</strong>。</li>
<li><code>hi</code> (hardware interrupt)：处理硬件中断所占用的 CPU 百分比。</li>
<li><code>si</code> (software interrupt)：处理软件中断所占用的 CPU 百分比。</li>
<li><code>st</code> (steal time)：（主要用于虚拟机）被虚拟化管理程序“偷走”的 CPU 时间。</li>
</ul>
</li>
<li><strong>第四行：物理内存（RAM）使用情况</strong><ul>
<li><code>MiB Mem :</code></li>
<li><code>total</code>：总物理内存。</li>
<li><code>free</code>：空闲内存。</li>
<li><code>used</code>：已使用内存。</li>
<li><code>buff/cache</code>：用作内核缓冲区和页面缓存的内存。Linux 会尽可能利用空闲内存做缓存以提升性能，所以 <code>used</code> 高不一定代表内存不足。</li>
</ul>
</li>
<li><strong>第五行：交换空间（Swap）使用情况</strong><ul>
<li><code>MiB Swap:</code></li>
<li><code>total</code>：总交换空间大小。</li>
<li><code>free</code>：空闲交换空间。</li>
<li><code>used</code>：已使用交换空间。如果这个值持续增加，说明物理内存可能不足。</li>
<li><code>avail Mem</code>：可用的内存，是 <code>free</code> 和大部分 <code>buff/cache</code> 的总和，这个指标比 <code>free</code> 更能真实地反映系统可用内存。</li>
</ul>
</li>
</ol>
<h4 id="第二部分：进程列表区-Process-List-Area"><a href="#第二部分：进程列表区-Process-List-Area" class="headerlink" title="第二部分：进程列表区 (Process List Area)"></a>第二部分：进程列表区 (Process List Area)</h4><p>这里列出了当前系统中的各个进程信息，默认按 CPU 使用率降序排列。</p>
<ul>
<li><code>PID</code>：进程 ID。</li>
<li><code>USER</code>：进程所有者的用户名。</li>
<li><code>PR</code>：进程优先级（Priority）。</li>
<li><code>NI</code>：Nice 值。负值表示高优先级，正值表示低优先级。</li>
<li><code>VIRT</code> (Virtual Memory Size)：进程使用的虚拟内存总量 (KB)。</li>
<li><code>RES</code> (Resident Memory Size)：进程使用的、未被换出的物理内存大小 (KB)。<strong>这是衡量进程实际内存占用的重要指标</strong>。</li>
<li><code>SHR</code> (Shared Memory Size)：共享内存大小 (KB)。</li>
<li><code>S</code>：进程状态（D&#x3D;不可中断的睡眠状态, R&#x3D;运行, S&#x3D;睡眠, T&#x3D;跟踪&#x2F;停止, Z&#x3D;僵尸进程）。</li>
<li><code>%CPU</code>：自上次更新以来进程所使用的 CPU 时间百分比。</li>
<li><code>%MEM</code>：进程使用的物理内存百分比。</li>
<li><code>TIME+</code>：进程启动后累计使用的 CPU 时间，精确到百分之一秒。</li>
<li><code>COMMAND</code>：启动进程的命令名或命令行。</li>
</ul>
<hr>
<h3 id="日常使用交互命令"><a href="#日常使用交互命令" class="headerlink" title="日常使用交互命令"></a>日常使用交互命令</h3><p>在 <code>top</code> 运行界面，可以输入以下单字符命令进行交互，无需回车：</p>
<table>
<thead>
<tr>
<th>按键</th>
<th>功能</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>P</code></td>
<td>按 <strong>CPU</strong> 使用率排序</td>
<td>(大写 P) 这是默认排序方式，用于快速找到最耗 CPU 的进程。</td>
</tr>
<tr>
<td><code>M</code></td>
<td>按 <strong>内存</strong> 使用率排序</td>
<td>(大写 M) 用于快速找到最耗内存的进程。</td>
</tr>
<tr>
<td><code>N</code></td>
<td>按 <strong>PID</strong> 排序</td>
<td>(大写 N)</td>
</tr>
<tr>
<td><code>T</code></td>
<td>按 <strong>运行时间</strong> 排序</td>
<td>(大写 T)</td>
</tr>
<tr>
<td><code>q</code></td>
<td><strong>退出</strong> <code>top</code></td>
<td></td>
</tr>
<tr>
<td><code>k</code></td>
<td><strong>终止</strong> (kill) 进程</td>
<td>会提示输入要终止的 PID 和发送的信号（默认是 15，即 SIGTERM）。</td>
</tr>
<tr>
<td><code>r</code></td>
<td><strong>重新设置</strong> (renice) 进程优先级</td>
<td>会提示输入要操作的 PID 和新的 nice 值。</td>
</tr>
<tr>
<td><code>h</code></td>
<td>显示<strong>帮助</strong>菜单</td>
<td></td>
</tr>
<tr>
<td><code>1</code></td>
<td>切换 <strong>CPU 核心</strong> 显示模式</td>
<td>在多核 CPU 系统上，按 <code>1</code> 可以在总览和各核心独立显示之间切换。这对于观察 CPU 核心负载是否均衡非常有用。</td>
</tr>
<tr>
<td><code>f</code></td>
<td><strong>字段管理</strong></td>
<td>进入字段选择界面，可以自定义显示或隐藏哪些列。</td>
</tr>
<tr>
<td><code>c</code></td>
<td>切换 <strong>命令</strong> 显示模式</td>
<td>在 <code>COMMAND</code> 列切换显示命令名和完整的命令行路径及参数。</td>
</tr>
<tr>
<td><code>z</code></td>
<td><strong>彩色</strong>显示</td>
<td>切换是否使用彩色高亮显示，便于观察。</td>
</tr>
<tr>
<td><code>u</code></td>
<td>按<strong>用户</strong>过滤</td>
<td>输入用户名，只显示该用户的进程。</td>
</tr>
</tbody></table>
<hr>
<h3 id="问题排查案例"><a href="#问题排查案例" class="headerlink" title="问题排查案例"></a>问题排查案例</h3><p><code>top</code> 是排查线上问题的“第一现场”，以下是几个经典案例。</p>
<h4 id="案例一：发现并处理-CPU-占用率过高的进程"><a href="#案例一：发现并处理-CPU-占用率过高的进程" class="headerlink" title="案例一：发现并处理 CPU 占用率过高的进程"></a>案例一：发现并处理 CPU 占用率过高的进程</h4><p><strong>问题场景</strong>：应用响应缓慢，感觉服务器很卡。</p>
<p><strong>排查步骤</strong>：</p>
<ol>
<li><p>打开 top：</p>
<p>在终端输入 top。默认就是按 CPU 使用率 %CPU 降序排列。</p>
</li>
<li><p>定位元凶：</p>
<p>观察列表顶部的几个进程。假设发现一个名为 java 的进程 %CPU 持续在 100% 甚至更高（在多核系统上可能超过 100%）。这通常就是问题的根源。记下它的 PID，例如 1234。</p>
</li>
<li><p><strong>分析进程（可选但推荐）</strong>：</p>
<ul>
<li><strong>查看完整命令</strong>：按 <code>c</code> 键，查看 <code>COMMAND</code> 列，确认这个 <code>java</code> 进程是哪个应用。例如，可能会显示为 <code>java -jar my-app.jar</code>。</li>
<li><strong>分析线程</strong>：在 <code>top</code> 界面按 <code>H</code>（大写），可以切换到线程视图，看到是该 <code>java</code> 进程下的哪个线程在消耗 CPU。这对于 Java 应用问题排查（结合 <code>jstack</code>）尤其有用。</li>
</ul>
</li>
<li><p><strong>处理进程</strong>：</p>
<ul>
<li><strong>优雅地终止</strong>：按 <code>k</code>，输入 <code>PID</code> <code>1234</code>，然后按回车（使用默认信号 15&#x2F;SIGTERM）。这会尝试让程序正常关闭。</li>
<li><strong>强制杀死</strong>：如果优雅终止无效，再次按 <code>k</code>，输入 <code>PID</code> <code>1234</code>，然后输入信号 <code>9</code> (SIGKILL)，回车强制杀死。</li>
<li><strong>重启服务</strong>：杀死进程后，根据业务需要，手动或通过服务管理工具（如 <code>systemctl</code>）重启应用。</li>
</ul>
</li>
</ol>
<h4 id="案例二：发现并处理内存泄漏"><a href="#案例二：发现并处理内存泄漏" class="headerlink" title="案例二：发现并处理内存泄漏"></a>案例二：发现并处理内存泄漏</h4><p><strong>问题场景</strong>：系统越来越慢，Swap 分区开始被使用，最终可能导致应用被 OOM Killer（Out of Memory Killer）杀死。</p>
<p><strong>排查步骤</strong>：</p>
<ol>
<li><p>打开 top 并按内存排序：</p>
<p>输入 top，然后按 M (大写 M)，进程列表会按 %MEM 或 RES (物理内存占用) 降序排列。</p>
</li>
<li><p>定位元凶：</p>
<p>观察列表顶部的进程。如果发现某个进程的 RES (物理内存占用) 和 %MEM (内存使用百分比) 持续、缓慢地增长，并且从不下降，那么这个进程很可能存在内存泄漏。同时，观察摘要区的 Swap used 是否在增加。</p>
</li>
<li><p>确认问题：</p>
<p>记下该进程的 PID。持续观察几分钟甚至几小时，确认内存占用确实是只增不减的趋势。</p>
</li>
<li><p><strong>处理与分析</strong>：</p>
<ul>
<li><strong>临时解决方案</strong>：如果系统濒临崩溃，可以先 <code>kill</code> 掉该进程并重启，暂时恢复服务。</li>
<li><strong>根本原因分析</strong>：内存泄漏需要代码层面的修复。你需要通知相关的开发人员，并提供你观察到的现象（哪个进程、内存增长情况等）。开发者可能会使用如 Valgrind (C&#x2F;C++)、MAT (Java) 或 memory-profiler (Python) 等更专业的工具来定位具体的泄漏点。</li>
</ul>
</li>
</ol>
<h4 id="案例三：排查-I-O-瓶颈"><a href="#案例三：排查-I-O-瓶颈" class="headerlink" title="案例三：排查 I&#x2F;O 瓶颈"></a>案例三：排查 I&#x2F;O 瓶颈</h4><p><strong>问题场景</strong>：应用响应慢，但 <code>top</code> 显示 CPU 空闲率 <code>%id</code> 很高，CPU 并没有跑满。</p>
<p><strong>排查步骤</strong>：</p>
<ol>
<li><p>观察 CPU 等待 I&#x2F;O (wa)：</p>
<p>在 top 的摘要信息区，重点关注 %Cpu(s) 这一行的 wa 值。如果这个值持续很高（例如，超过 20%），说明 CPU 有大量时间在等待磁盘或网络 I&#x2F;O 操作完成。</p>
</li>
<li><p>定位引起 I&#x2F;O 的进程：</p>
<p>虽然 top 本身不能直接按 I&#x2F;O 排序，但通常高 I&#x2F;O 的进程也会伴随一定的 sy (系统内核) CPU 占用。你可以观察 S (状态) 列，如果一个进程长时间处于 D (不可中断的睡眠) 状态，它很可能就在等待 I&#x2F;O。</p>
</li>
<li><p>使用更专业的工具确认：</p>
<p>当 top 指示出 I&#x2F;O 问题时，通常需要结合其他工具进一步分析。</p>
<ul>
<li><code>iotop</code>：一个类似 <code>top</code> 的工具，专门用来显示磁盘 I&#x2F;O 的使用情况，可以清晰地看到哪个进程正在进行大量的读写操作。</li>
<li><code>iostat -x 1</code>：可以详细地看到每个磁盘设备的读写速率、等待时间等关键指标。</li>
</ul>
</li>
<li><p><strong>解决问题</strong>：</p>
<ul>
<li><strong>数据库问题</strong>：可能是慢查询导致了大量的磁盘读。需要优化 SQL 或索引。</li>
<li><strong>日志写入过多</strong>：应用产生了大量日志，占满了磁盘带宽。可以调整日志级别或优化日志写入方式。</li>
<li><strong>磁盘性能不足</strong>：物理磁盘本身性能达到了瓶颈，考虑更换更快的磁盘（如 SSD）。</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/shell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/shell/" class="post-title-link" itemprop="url">shell-mail</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:00:25" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/scripts/" itemprop="url" rel="index"><span itemprop="name">scripts</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Shell 脚本，用于检查磁盘使用率并在超过阈值时发送告警邮件。</p>
<p>这个脚本考虑了几个重要的实践：</p>
<ul>
<li><strong>可配置性</strong>：阈值和收件人作为变量定义，方便修改。</li>
<li><strong>明确性</strong>：邮件内容清晰地指明了问题服务器、挂载点和当前使用率。</li>
<li><strong>排除项</strong>：可以轻松排除某些文件系统（如 tmpfs, devtmpfs）。</li>
<li><strong>锁机制</strong>：防止脚本在前一个实例仍在运行时重复执行。</li>
</ul>
<hr>
<h3 id="check-disk-usage-sh"><a href="#check-disk-usage-sh" class="headerlink" title="check_disk_usage.sh"></a><code>check_disk_usage.sh</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># Script Name: check_disk_usage.sh</span></span><br><span class="line"><span class="comment"># Description: Checks the disk usage of local filesystems. If any filesystem&#x27;s</span></span><br><span class="line"><span class="comment">#              usage exceeds a defined threshold, it sends an alert email.</span></span><br><span class="line"><span class="comment"># Author:      Your Name (Your Team)</span></span><br><span class="line"><span class="comment"># Date:        YYYY-MM-DD</span></span><br><span class="line"><span class="comment"># Version:     1.1</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line"><span class="comment"># Set the disk usage threshold (e.g., 85 for 85%).</span></span><br><span class="line">THRESHOLD=85</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the email address to receive the alerts.</span></span><br><span class="line"><span class="comment"># For multiple recipients, separate them with commas: &quot;admin1@example.com,admin2@example.com&quot;</span></span><br><span class="line">MAIL_RECIPIENT=<span class="string">&quot;sysadmin@example.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Advanced Configuration ---</span></span><br><span class="line"><span class="comment"># Temporary file to store the disk usage report.</span></span><br><span class="line">REPORT_FILE=<span class="string">&quot;/tmp/disk_usage_report.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Lock file to prevent concurrent execution.</span></span><br><span class="line">LOCK_FILE=<span class="string">&quot;/var/run/check_disk_usage.lock&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Filesystems to exclude from the check (use a pipe-separated list for egrep).</span></span><br><span class="line"><span class="comment"># This is useful for ignoring virtual/temporary filesystems.</span></span><br><span class="line">EXCLUDE_FSTYPES=<span class="string">&quot;tmpfs|devtmpfs|iso9660&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Pre-execution Checks ---</span></span><br><span class="line"><span class="comment"># Check for root privileges if necessary (e.g., for creating lock file in /var/run)</span></span><br><span class="line"><span class="comment"># if [[ $EUID -ne 0 ]]; then</span></span><br><span class="line"><span class="comment">#   echo &quot;This script must be run as root to create a lock file in /var/run.&quot;</span></span><br><span class="line"><span class="comment">#   exit 1</span></span><br><span class="line"><span class="comment"># fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Simple lock mechanism.</span></span><br><span class="line"><span class="keyword">if</span> [ -e <span class="string">&quot;<span class="variable">$LOCK_FILE</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Script is already running. Exiting.&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">touch</span> <span class="string">&quot;<span class="variable">$LOCK_FILE</span>&quot;</span></span><br><span class="line">    <span class="comment"># Ensure lock file is removed on script exit, interrupt, or termination.</span></span><br><span class="line">    <span class="built_in">trap</span> <span class="string">&#x27;rm -f &quot;$LOCK_FILE&quot;; exit&#x27;</span> INT TERM EXIT</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Main Logic ---</span></span><br><span class="line"><span class="comment"># Get the hostname for the email subject.</span></span><br><span class="line">HOSTNAME=$(hostname -f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Clear the previous report file.</span></span><br><span class="line">&gt; <span class="string">&quot;<span class="variable">$REPORT_FILE</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Flag to track if any filesystem exceeds the threshold.</span></span><br><span class="line">ALERT_TRIGGERED=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use `df` to get disk usage information.</span></span><br><span class="line"><span class="comment"># -P: Use POSIX output format to prevent line wrapping on long device names.</span></span><br><span class="line"><span class="comment"># -hT: Human-readable sizes and show Filesystem Type.</span></span><br><span class="line"><span class="comment"># We process with `awk` to skip the header and parse the data.</span></span><br><span class="line"><span class="built_in">df</span> -PT | awk <span class="string">&#x27;NR&gt;1&#x27;</span> | egrep -v <span class="string">&quot;^(<span class="variable">$&#123;EXCLUDE_FSTYPES&#125;</span>)&quot;</span> | <span class="keyword">while</span> <span class="built_in">read</span> -r FILESYSTEM TYPE SIZE USED AVAIL PERCENT MOUNTED; <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># Extract the numerical percentage value.</span></span><br><span class="line">    CURRENT_USAGE=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$PERCENT</span>&quot;</span> | sed <span class="string">&#x27;s/%//&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Compare current usage with the threshold.</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$CURRENT_USAGE</span>&quot;</span> -gt <span class="string">&quot;<span class="variable">$THRESHOLD</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># If threshold is exceeded, set the flag and append to the report.</span></span><br><span class="line">        ALERT_TRIGGERED=<span class="literal">true</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;High Disk Usage Alert on <span class="variable">$&#123;HOSTNAME&#125;</span>:&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT_FILE</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;--------------------------------------------------&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT_FILE</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Mount Point : <span class="variable">$&#123;MOUNTED&#125;</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT_FILE</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Usage       : <span class="variable">$&#123;CURRENT_USAGE&#125;</span>% (Threshold: <span class="variable">$&#123;THRESHOLD&#125;</span>%)&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT_FILE</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Filesystem  : <span class="variable">$&#123;FILESYSTEM&#125;</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT_FILE</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Total Size  : <span class="variable">$&#123;SIZE&#125;</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT_FILE</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT_FILE</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Send Alert ---</span></span><br><span class="line"><span class="comment"># If the alert flag was triggered, send the email.</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$ALERT_TRIGGERED</span>&quot;</span> = <span class="literal">true</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># Construct the email subject.</span></span><br><span class="line">    MAIL_SUBJECT=<span class="string">&quot;[CRITICAL] Disk Usage Alert on <span class="variable">$&#123;HOSTNAME&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Use `mail` or `sendmail` command to send the report.</span></span><br><span class="line">    <span class="comment"># The `mail` command is simpler and widely available.</span></span><br><span class="line">    mail -s <span class="string">&quot;<span class="variable">$&#123;MAIL_SUBJECT&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;MAIL_RECIPIENT&#125;</span>&quot;</span> &lt; <span class="string">&quot;<span class="variable">$&#123;REPORT_FILE&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Optional: Log that an alert was sent.</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date)</span>: High disk usage detected. Alert sent to <span class="variable">$&#123;MAIL_RECIPIENT&#125;</span>.&quot;</span> &gt;&gt; /var/log/disk_monitor.log</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment"># Optional: Log that everything is normal.</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date)</span>: Disk usage check OK. No alerts.&quot;</span> &gt;&gt; /var/log/disk_monitor.log</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Cleanup ---</span></span><br><span class="line"><span class="comment"># The trap command will handle the removal of the lock file.</span></span><br><span class="line"><span class="comment"># You can also explicitly remove the report file if you want.</span></span><br><span class="line"><span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$REPORT_FILE</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The &#x27;exit&#x27; in the trap will be called here, removing the lock file.</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<h3 id="如何使用和部署"><a href="#如何使用和部署" class="headerlink" title="如何使用和部署"></a>如何使用和部署</h3><ol>
<li><p><strong>保存脚本</strong>: 将上面的代码保存为 <code>check_disk_usage.sh</code> 文件。</p>
</li>
<li><p><strong>设置权限</strong>: 赋予脚本执行权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x check_disk_usage.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>配置邮件发送工具</strong>:<br>确保你的服务器上安装并配置了邮件发送工具，如 <code>mailutils</code> (提供了 <code>mail</code> 命令) 或 <code>postfix</code>、<code>sendmail</code>。</p>
<ul>
<li><strong>在 Debian&#x2F;Ubuntu 上</strong>: <code>sudo apt-get update &amp;&amp; sudo apt-get install -y mailutils</code></li>
<li><strong>在 CentOS&#x2F;RHEL 上</strong>: <code>sudo yum install -y mailx</code></li>
</ul>
</li>
<li><p><strong>配置 Cron Job</strong>:<br>为了让这个脚本能自动定期运行，需要将它添加到一个 <code>cron</code> 任务中。</p>
<ul>
<li>打开 crontab 进行编辑: <code>crontab -e</code></li>
<li>添加一行来让脚本每 10 分钟运行一次：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/10 * * * * /path/to/your/check_disk_usage.sh &gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure></li>
<li><code>/path/to/your/check_disk_usage.sh</code> 必须是脚本的<strong>绝对路径</strong>。</li>
<li><code>&gt; /dev/null 2&gt;&amp;1</code> 会将脚本的所有标准输出和错误输出重定向到 “黑洞”，这样 cron 就不会因为脚本有输出（如 “Disk usage check OK”）而发送邮件，只有在告警条件满足时脚本内部才会发送邮件。</li>
</ul>
</li>
</ol>
<h3 id="运维工程师的关键解读"><a href="#运维工程师的关键解读" class="headerlink" title="运维工程师的关键解读"></a>运维工程师的关键解读</h3><ul>
<li><strong>可靠性 (<code>trap</code> 和锁文件)</strong>: <code>trap</code> 命令确保了即使脚本被中断（Ctrl+C）或被系统终止，锁文件也能被清理掉，防止下次无法运行。锁文件本身防止了因系统高负载导致脚本执行时间过长，而在上一次尚未结束时 <code>cron</code>又启动了新的实例。</li>
<li><strong>兼容性 (<code>df -P</code>)</strong>: 使用 <code>-P</code> 选项可以保证 <code>df</code> 的输出格式是标准的，不会因为挂载点名称太长而换行，这让后续的 <code>awk</code> 解析更加稳定。</li>
<li><strong>过滤 (<code>egrep -v</code>)</strong>: 直接排除不关心的文件系统类型，让告警更精确，避免了对 <code>/dev/shm</code> 等内存文件系统的误报。</li>
<li><strong>日志</strong>: 即使不发送告警，脚本也会在日志文件中留下一条记录，这对于事后排查“监控脚本当时是否正常运行”非常有帮助。</li>
<li><strong>清晰的告警信息</strong>: 邮件内容包含了所有排查问题所需的关键信息：主机名、挂载点、使用率、阈值。这使得接收到告警的人可以立即采取行动，而无需再登录服务器去确认。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/websocket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/websocket/" class="post-title-link" itemprop="url">websocket</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:09:04" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WEB/" itemprop="url" rel="index"><span itemprop="name">WEB</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WEB/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="什么是-WebSocket？"><a href="#什么是-WebSocket？" class="headerlink" title="什么是 WebSocket？"></a>什么是 WebSocket？</h3><p>HTTP 协议是无状态的，它是一种请求-响应模型：客户端发出请求，服务器响应，然后连接通常会关闭。这种模式对于静态资源、一次性数据交互非常高效。</p>
<p>然而，对于需要实时、双向通信的场景（如聊天应用、股票行情、在线游戏、协同编辑等），传统的 HTTP 循环请求（轮询、长轮询）效率低下，会导致大量不必要的请求和延迟。</p>
<p><strong>WebSocket 协议</strong>正是为了解决这个问题而诞生的。</p>
<p><strong>核心思想：</strong></p>
<p>WebSocket 协议提供了一种在单个 TCP 连接上进行<strong>全双工（Full-duplex）</strong>通信的机制。这意味着客户端和服务器可以在任意时间点互相发送消息，而不需要每次都建立和关闭连接，也不需要客户端不断地发起新的 HTTP 请求。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li><strong>握手（Handshake）：</strong><ul>
<li>客户端首先通过标准的 HTTP 请求发起一个特殊的“握手”过程。这个 HTTP 请求会包含一些特殊的 Header，如 <code>Upgrade: websocket</code> 和 <code>Connection: Upgrade</code>，表示客户端希望将当前的 HTTP 连接升级为 WebSocket 连接。</li>
<li>服务器如果支持 WebSocket，并且同意升级，则会返回一个特殊的 HTTP 响应（状态码 101 Switching Protocols），表明连接已成功切换到 WebSocket 协议。</li>
<li>在握手过程中，还会协商一些参数，如 WebSocket 协议版本和密钥。</li>
</ul>
</li>
<li><strong>数据帧传输：</strong><ul>
<li>一旦握手成功，原始的 HTTP&#x2F;TCP 连接就升级为了 WebSocket 连接。</li>
<li>从这时起，客户端和服务器不再使用 HTTP 协议，而是使用 WebSocket 协议定义的数据帧进行双向通信。这些数据帧更轻量级，开销远小于 HTTP 请求。</li>
<li>连接会一直保持开放，直到客户端或服务器明确关闭它。</li>
</ul>
</li>
</ol>
<p><strong>WebSocket 的优点：</strong></p>
<ul>
<li><strong>实时性：</strong> 实现了真正的实时双向通信，数据可以即时推送。</li>
<li><strong>低延迟：</strong> 无需重复建立 TCP 连接和发送 HTTP Header，大大减少了网络延迟。</li>
<li><strong>高效性：</strong> 减少了不必要的协议开销，数据传输更高效。</li>
<li><strong>全双工：</strong> 客户端和服务器可以同时发送和接收数据。</li>
<li><strong>保持连接：</strong> 连接一旦建立，会一直保持，直到一方主动关闭。</li>
</ul>
<p><strong>WebSocket 的应用场景：</strong></p>
<ul>
<li><strong>即时通讯：</strong> 聊天应用、消息通知。</li>
<li><strong>在线游戏：</strong> 多人游戏的状态同步。</li>
<li><strong>实时数据推送：</strong> 股票行情、体育赛事比分、物联网数据监控。</li>
<li><strong>协同编辑：</strong> 多个用户同时编辑一个文档。</li>
<li><strong>地理位置共享：</strong> 实时跟踪用户位置。</li>
</ul>
<h3 id="如何在-Nginx-中配置-WebSocket-代理？"><a href="#如何在-Nginx-中配置-WebSocket-代理？" class="headerlink" title="如何在 Nginx 中配置 WebSocket 代理？"></a>如何在 Nginx 中配置 WebSocket 代理？</h3><p>Nginx 作为反向代理服务器，可以直接将客户端的 WebSocket 握手请求转发到后端的 WebSocket 服务器，并在握手成功后，负责传输后续的 WebSocket 数据帧。</p>
<p>配置 Nginx 代理 WebSocket 的关键在于处理好 <strong>HTTP 升级头（Upgrade Header）</strong>和 <strong>连接头（Connection Header）</strong>。</p>
<h4 id="核心配置解析"><a href="#核心配置解析" class="headerlink" title="核心配置解析"></a>核心配置解析</h4><ol>
<li><p>**<code>proxy_http_version 1.1;</code>**：</p>
<ul>
<li>WebSocket 协议的握手依赖于 HTTP&#x2F;1.1 协议的升级机制。此指令确保 Nginx 使用 HTTP&#x2F;1.1 协议与后端服务器通信。</li>
</ul>
</li>
<li><p>**<code>proxy_set_header Upgrade $http_upgrade;</code>**：</p>
<ul>
<li>将客户端请求中的 <code>Upgrade</code> 头（例如 <code>Upgrade: websocket</code>）原样传递给后端服务器。这是 WebSocket 握手的重要标志。</li>
</ul>
</li>
<li><p>**<code>proxy_set_header Connection &quot;upgrade&quot;;</code>**：</p>
<ul>
<li>将客户端请求中的 <code>Connection</code> 头设置为 <code>upgrade</code>，告诉后端服务器，客户端希望将连接升级为 WebSocket。<strong>注意：</strong> 对于Nginx 1.4+ 版本，如果 <code>proxy_set_header Upgrade $http_upgrade;</code> 配置存在，Nginx 会自动处理 <code>Connection</code> 头。但为了兼容性和明确性，显式设置通常不会有坏处。</li>
</ul>
</li>
<li><p><strong><code>proxy_read_timeout</code> 和 <code>proxy_send_timeout</code>：</strong></p>
<ul>
<li>由于 WebSocket 连接是长连接，需要确保代理超时设置足够长，或者干脆禁用，以避免连接过早断开。默认的 Nginx <code>proxy_read_timeout</code> 是 60 秒，这对于长期活动的 WebSocket 连接通常不够。可以根据实际需求设置为一个较大的值，或者更彻底地利用 Nginx Plus 或一些模块实现更健壮的超时管理。</li>
<li><strong>一个普遍的建议：</strong> 对于 WebSocket 代理，这两个超时通常设置为远大于普通 HTTP 请求的生命周期，甚至可以设置为几天或几周（如果你的业务场景需要）。或者，如果后端应用本身有心跳机制，则设置略高于心跳周期即可。</li>
</ul>
</li>
</ol>
<h4 id="Nginx-配置示例"><a href="#Nginx-配置示例" class="headerlink" title="Nginx 配置示例"></a>Nginx 配置示例</h4><p>以下是一个标准的 Nginx WebSocket 代理配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">upstream</span> websocket_backend &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.1.10:8000</span>; <span class="comment"># WebSocket 后端服务器地址和端口</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.1.11:8000</span>; <span class="comment"># 可以有多个后端服务器进行负载均衡</span></span><br><span class="line">        <span class="comment"># 负载均衡算法也可以在这里配置，例如：</span></span><br><span class="line">        <span class="comment"># least_conn;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> your_websocket_domain.com; <span class="comment"># 你的域名</span></span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="comment"># 1. 确保使用 HTTP/1.1 协议</span></span><br><span class="line">            <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 2. 传递 Upgrade 头，告知后端是 WebSocket 握手</span></span><br><span class="line">            <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 3. 传递 Connection 头，告知后端升级连接</span></span><br><span class="line">            <span class="comment"># Nginx 1.13.0+ 版本可以简单写成：proxy_set_header Connection &quot;&quot;;</span></span><br><span class="line">            <span class="comment"># 更兼容的写法是：</span></span><br><span class="line">            <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;upgrade&quot;</span>; <span class="comment"># 或者 $connection_upgrade; （Nginx 1.3.11+）</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 4. 传递其他常用代理头，保持客户端信息</span></span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 5. 非常重要：设置足够长的超时时间</span></span><br><span class="line">            <span class="attribute">proxy_read_timeout</span> <span class="number">3600s</span>;  <span class="comment"># 例如，设置为 1 小时 (3600 秒)</span></span><br><span class="line">            <span class="attribute">proxy_send_timeout</span> <span class="number">3600s</span>;  <span class="comment"># 如果你的 WebSocket 需要长周期存在</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 6. 后端 WebSocket 服务器的地址</span></span><br><span class="line">            <span class="attribute">proxy_pass</span> http://websocket_backend;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 7. 可选：禁止代理缓冲，确保实时传输</span></span><br><span class="line">            <span class="comment"># 对于 WebSocket 这种数据流协议，不应缓冲</span></span><br><span class="line">            <span class="attribute">proxy_buffering</span> <span class="literal">off</span>; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置注意事项和最佳实践："><a href="#配置注意事项和最佳实践：" class="headerlink" title="配置注意事项和最佳实践："></a>配置注意事项和最佳实践：</h4><ol>
<li><p><strong>SSL&#x2F;TLS 加密 (WSS)：</strong> 生产环境中强烈建议为 WebSocket 连接使用 WSS (WebSocket Secure)，即在 Nginx 中配置 SSL&#x2F;TLS。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> your_websocket_domain.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx/certs/your_domain.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/certs/your_domain.key;</span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> HIGH:!aNULL:!MD5;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://websocket_backend; <span class="comment"># 注意这里是 http，Nginx 会终止 SSL</span></span><br><span class="line">        <span class="comment"># 其他 timeout, headers 等配置同上</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Nginx 在这里做了 SSL 卸载 (SSL Termination)，客户端到 Nginx 是 <code>wss://</code>，Nginx 到后端可以是 <code>ws://</code> (HTTP)。如果后端也支持 WSS，你也可以配置 Nginx 到后端也用 HTTPS&#x2F;WSS。</p>
</li>
<li><p><strong>超时设置：</strong> <code>proxy_read_timeout</code> 和 <code>proxy_send_timeout</code> 的值非常关键。如果设置得太短，长时间没有数据传输的 WebSocket 连接可能会被 Nginx 意外关闭，导致客户端重连。根据业务需要，将其设置为一个安全且足够长的时间。例如，很多实时应用会设置心跳机制，Nginx 的超时应略大于应用程序的心跳周期。</p>
</li>
<li><p><strong>缓冲机制：</strong> <code>proxy_buffering off;</code> 是非常重要的。对于流式协议如 WebSocket，Nginx 不应该缓存数据。禁用缓冲可以确保数据在客户端和服务器之间实时传输，避免不必要的延迟。</p>
</li>
<li><p><strong>长连接优化：</strong> Nginx 在处理 WebSocket 时，会保持后端连接活跃，这对于提高性能很有帮助。</p>
</li>
<li><p><strong>负载均衡：</strong> 如示例所示，你可以将多个 WebSocket 服务器配置在 <code>upstream</code> 块中，实现 WebSocket 连接的负载均衡。Nginx 会根据你选择的负载均衡算法（如轮询、最少连接）将新的 WebSocket 握手请求分发到不同的后端服务器。一旦 WebSocket 连接建立，它通常会被“粘”在某个后端服务器上（除非后端服务器故障）。</p>
</li>
</ol>
<p>配置完成后，记得使用 <code>sudo nginx -t</code> 检查语法，然后 <code>sudo systemctl reload nginx</code> 或 <code>sudo service nginx reload</code> 重新加载配置。</p>
<p>通过正确的 Nginx 配置，你可以充分利用 Nginx 作为高性能反向代理的优势，为你的 WebSocket 应用提供稳定、高效的服务。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/vmagent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/vmagent/" class="post-title-link" itemprop="url">vmagent</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:08:51" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/" itemprop="url" rel="index"><span itemprop="name">k8s-monitor</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s-monitor/VectoriaMetrics/" itemprop="url" rel="index"><span itemprop="name">VectoriaMetrics</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="vmagent"><a href="#vmagent" class="headerlink" title="vmagent"></a>vmagent</h1><p>vmagent 可以帮助我们从各种来源收集指标并将它们存储这 VM 或者任何其他支持 remote write 协议的 Prometheus 兼容的存储系统中。</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><p>vmagent 相比于 Prometheus 抓取指标来说具有更多的灵活性，比如除了拉取（pull）指标还可以推送（push）指标，此外还有很多其他特性：</p>
<ul>
<li>可以替换 prometheus 的 scraping target</li>
<li>支持从 Kafka 读写数据</li>
<li>支持基于 prometheus relabeling 的模式添加、移除、修改 labels，可以在数据发送到远端存储之前进行数据的过滤</li>
<li>支持多种数据协议，influx line 协议，graphite 文本协议，opentsdb 协议，prometheus remote write 协议，json lines 协议，csv 数据等</li>
<li>支持收集数据的同时，并复制到多种远端存储系统</li>
<li>支持不可靠远端存储，如果远程存储不可用，收集的指标会在 <code>-remoteWrite.tmpDataPath</code> 缓冲，一旦与远程存储的连接被修复，缓冲的指标就会被发送到远程存储，缓冲区的最大磁盘用量可以用 <code>-remoteWrite.maxDiskUsagePerURL</code> 来限制。</li>
<li>相比 prometheus 使用更少的内存、cpu、磁盘 io 以及网络带宽</li>
<li>当需要抓取大量目标时，抓取目标可以分散到多个 vmagent 实例中</li>
<li>可以通过在抓取时间和将其发送到远程存储系统之前限制唯一时间序列的数量来处理高基数和高流失率问题</li>
<li>可以从多个文件中加载 scrape 配置</li>
</ul>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/bvwcoo.jpg" alt="vmagent"></p>
<p>接下来我们以抓取 Kubernetes 集群指标为例说明如何使用 vmagent，我们这里使用自动发现的方式来进行配置。vmagent 是兼容 prometheus 中的 <code>kubernetes_sd_configs</code> 配置的，所以我们同样可以使用。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>要让 vmagent 自动发现监控的资源对象，需要访问 APIServer 获取资源对象，所以首先需要配置 rbac 权限，创建如下所示的资源清单。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vmagent-rbac.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmagent</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmagent</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;networking.k8s.io&#x27;</span>, <span class="string">&#x27;extensions&#x27;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/metrics</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpointslices</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">app</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;list&#x27;</span>, <span class="string">&#x27;watch&#x27;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&#x27;&#x27;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&#x27;get&#x27;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nonResourceURLs:</span> [<span class="string">&#x27;/metrics&#x27;</span>, <span class="string">&#x27;/metrics/resources&#x27;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&#x27;get&#x27;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmagent</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmagent</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">vmagent</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br></pre></td></tr></table></figure>

<p>然后添加 vmagent 配置，我们先只配置自动发现 Kubernetes 节点的任务，创建如下所示的 ConfigMap 对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vmagent-config.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmagent-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">scrape.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval: 15s</span></span><br><span class="line"><span class="string">      scrape_timeout: 15s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">nodes</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">&quot;(.*):10250&quot;</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">&quot;$&#123;1&#125;:9111&quot;</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br></pre></td></tr></table></figure>

<p>这里我们通过自动发现 Kubernetes 节点获取节点监控指标，需要注意 <code>node</code> 这种 role 的自动发现默认获取的是节点的 <code>10250</code> 端口，这里我们需要通过 <code>relabel</code> 将其 <code>replace</code> 为 <code>9111</code>。</p>
<p>然后添加 vmagent 部署资源清单，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vmagent-deploy.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmagent-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-client</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmagent</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">vmagent</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">vmagent</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">vmagent</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">vmagent</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">agent</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">&#x27;victoriametrics/vmagent:v1.77.0&#x27;</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-promscrape.config=/config/scrape.yml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-remoteWrite.tmpDataPath=/tmpData</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-remoteWrite.url=http://vminsert:8480/insert/0/prometheus</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-envflag.enable=true</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-envflag.prefix=VM_</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-loggerFormat=json</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">8429</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmpdata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/tmpData</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmpdata</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">vmagent-pvc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">vmagent-config</span></span><br></pre></td></tr></table></figure>

<p>我们将 vmagent 配置通过 ConfigMap 挂载到容器 <code>/config/scrape.yml</code>，另外通过 <code>-remoteWrite.url=http://vminsert:8480/insert/0/prometheus</code> 指定远程写入的地址，这里我们写入前面的 vminsert 服务，另外有一个参数 <code>-remoteWrite.tmpDataPath</code>，该路径会在远程存储不可用的时候用来缓存收集的指标，当远程存储修复后，缓存的指标就会被正常发送到远程写入，所以最好持久化该目录。</p>
<h2 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h2><p>单个 vmagent 实例可以抓取数万个抓取目标，但是有时由于 CPU、网络、内存等方面的限制，这还不够。在这种情况下，抓取目标可以在多个 vmagent 实例之间进行拆分。集群中的每个 vmagent 实例必须使用具有不同 <code>-promscrape.cluster.memberNum</code> 值的相同 <code>-promscrape.config</code> 配置文件，该参数值必须在 <code>0 ... N-1</code> 范围内，其中 <code>N</code> 是集群中 vmagent 实例的数量。集群中 vmagent 实例的数量必须传递给 <code>-promscrape.cluster.membersCount</code> 命令行标志。例如，以下命令可以在两个 vmagent 实例的集群中传播抓取目标：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vmagent -promscrape.cluster.membersCount=2 -promscrape.cluster.memberNum=0 -promscrape.config=/path/config.yml ...</span><br><span class="line">vmagent -promscrape.cluster.membersCount=2 -promscrape.cluster.memberNum=1 -promscrape.config=/path/config.yml ...</span><br></pre></td></tr></table></figure>

<p>当 vmagent 在 Kubernetes 中运行时，可以将 <code>-promscrape.cluster.memberNum</code> 设置为 StatefulSet pod 名称，pod 名称必须以 <code>0 ... promscrape.cluster.memberNum-1</code> 范围内的数字结尾，例如，<code>-promscrape.cluster.memberNum=vmagent-0</code>。</p>
<p>默认情况下，每个抓取目标仅由集群中的单个 vmagent 实例抓取。如果需要在多个 vmagent 实例之间复制抓取目标，则可以通过 <code>-promscrape.cluster.replicationFactor</code> 参数设置为所需的副本数。例如，以下命令启动一个包含三个 vmagent 实例的集群，其中每个目标由两个 vmagent 实例抓取：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vmagent -promscrape.cluster.membersCount=3 -promscrape.cluster.replicationFactor=2 -promscrape.cluster.memberNum=0 -promscrape.config=/path/to/config.yml ...</span><br><span class="line">vmagent -promscrape.cluster.membersCount=3 -promscrape.cluster.replicationFactor=2 -promscrape.cluster.memberNum=1 -promscrape.config=/path/to/config.yml ...</span><br><span class="line">vmagent -promscrape.cluster.membersCount=3 -promscrape.cluster.replicationFactor=2 -promscrape.cluster.memberNum=2 -promscrape.config=/path/to/config.yml ...</span><br></pre></td></tr></table></figure>

<p>需要注意的是如果每个目标被多个 vmagent 实例抓取，则必须在 <code>-remoteWrite.url</code> 指向的远程存储上启用重复数据删除。</p>
<p>所以如果你抓取的监控目标非常大，那么我们建议使用 vmagent 集群模式，那么可以使用 StatefulSet 方式进行部署</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vmagent-sts.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmagent</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">prometheus.io/scrape:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">prometheus.io/port:</span> <span class="string">&#x27;8429&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">vmagent</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8429</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmagent</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">vmagent</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">vmagent</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">vmagent</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">vmagent</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">vmagent</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">agent</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">victoriametrics/vmagent:v1.77.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-promscrape.config=/config/scrape.yml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-remoteWrite.tmpDataPath=/tmpData</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-promscrape.cluster.membersCount=2</span></span><br><span class="line">            <span class="comment"># - -promscrape.cluster.replicationFactor=2 # 可以配置副本数</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-promscrape.cluster.memberNum=$(POD_NAME)</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-remoteWrite.url=http://vminsert:8480/insert/0/prometheus</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-envflag.enable=true</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-envflag.prefix=VM_</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-loggerFormat=json</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">8429</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmpdata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/tmpData</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/config</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">vmagent-config</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">tmpdata</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">accessModes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">nfs-client</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>

<p>我们这里就使用 StatefulSet 的形式来管理 vmagent，直接应用上面的资源即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">先将前面示例中的 prometheus 停掉</span></span><br><span class="line">☸ ➜ kubectl scale deploy prometheus --replicas=0 -n kube-vm</span><br><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vmagent-rbac.yaml</span><br><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vmagent-config.yaml</span><br><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vmagent-sts.yaml</span><br><span class="line">☸ ➜ kubectl get pods -n kube-vm -l app=vmagent</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">vmagent-0   1/1     Running   0          3m43s</span><br><span class="line">vmagent-1   1/1     Running   0          2m9s</span><br></pre></td></tr></table></figure>

<p>这里我们部署了两个 vmagent 实例来抓取监控指标，我们这里一共 3 个节点。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl get nodes</span><br><span class="line">NAME      STATUS   ROLES                  AGE   VERSION</span><br><span class="line">master1   Ready    control-plane,master   44d   v1.22.8</span><br><span class="line">node1     Ready    &lt;none&gt;                 44d   v1.22.8</span><br><span class="line">node2     Ready    &lt;none&gt;                 44d   v1.22.8</span><br></pre></td></tr></table></figure>

<p>所以两个 vmagent 实例会分别采集部分指标，我们可以通过查看日志来进行验证：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl logs -f vmagent-0 -n kube-vm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">......</span></span><br><span class="line">&#123;&quot;ts&quot;:&quot;2022-05-10T04:44:44.004Z&quot;,&quot;level&quot;:&quot;info&quot;,&quot;caller&quot;:&quot;VictoriaMetrics/lib/promscrape/scraper.go:393&quot;,&quot;msg&quot;:&quot;static_configs: added targets: 1, removed targets: 0; total targets: 1&quot;&#125;</span><br><span class="line">&#123;&quot;ts&quot;:&quot;2022-05-10T04:44:44.006Z&quot;,&quot;level&quot;:&quot;info&quot;,&quot;caller&quot;:&quot;VictoriaMetrics/lib/promscrape/scraper.go:393&quot;,&quot;msg&quot;:&quot;kubernetes_sd_configs: added targets: 2, removed targets: 0; total targets: 2&quot;&#125;</span><br><span class="line">☸ ➜ kubectl logs -f vmagent-1 -n kube-vm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">......</span></span><br><span class="line">&#123;&quot;ts&quot;:&quot;2022-05-10T04:46:17.893Z&quot;,&quot;level&quot;:&quot;info&quot;,&quot;caller&quot;:&quot;VictoriaMetrics/lib/promscrape/scraper.go:393&quot;,&quot;msg&quot;:&quot;kubernetes_sd_configs: added targets: 1, removed targets: 0; total targets: 1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>从日志可以看出 <code>vmagent-0</code> 实例发现了 2 个 targets，<code>vmagent-1</code> 实例发现了 1 个 targets，这也符合我们预期的。</p>
<p>接下来我们再新增其他内容的监控，比如 APIServer、容器等等，配置如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vmagent-config2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmagent-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-vm</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">scrape.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval: 15s</span></span><br><span class="line"><span class="string">      scrape_timeout: 15s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">nodes</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">&quot;(.*):10250&quot;</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">&quot;$&#123;1&#125;:9111&quot;</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">apiserver</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">        <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">default;kubernetes;https</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_namespace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_service_name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_endpoint_port_name</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">cadvisor</span></span><br><span class="line">      <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">        <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">replacement:</span> <span class="string">/metrics/cadvisor</span> </span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_pod_container_init</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">keep_if_equal</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_service_annotation_prometheus_io_port</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_pod_container_port_number</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_service_annotation_prometheus_io_scrape</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(https?)</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_service_annotation_prometheus_io_scheme</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__scheme__</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_service_annotation_prometheus_io_path</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__address__</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_service_annotation_prometheus_io_port</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_pod_name</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">pod</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_namespace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_service_name</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">service</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">replacement:</span> <span class="string">$&#123;1&#125;</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_service_name</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">job</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">source_labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">__meta_kubernetes_pod_node_name</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">node</span></span><br></pre></td></tr></table></figure>

<p>大部分的配置在前面 Prometheus 章节都介绍过了，核心就是通过 <code>relabel_configs</code> 来控制抓取的任务，vmagent 是兼容传统的 prometheus 重新标记规则的，但也有一些独特的 action，比如上面配置中我们使用了一个 <code>keep_if_equal</code> 的操作，该操作的意思是如果指定的标签值相等则将该条数据保留下来。</p>
<p>有时，如果某个指标包含两个具有相同值的标签，则需要删除它。这可以通过 vmagent 支持的 <code>drop_if_equal</code> 操作来完成。例如，如果以下 relabel 规则包含 <code>real_port</code> 和 <code>required_port</code> 的相同标签值，则它会删除指标：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">action:</span> <span class="string">drop_if_equal</span></span><br><span class="line">  <span class="attr">source_labels:</span> [<span class="string">real_port</span>, <span class="string">needed_port</span>]</span><br></pre></td></tr></table></figure>

<p>该规则将删除以下指标：<code>foo&#123;real_port=&quot;123&quot;,needed_port=&quot;123&quot;&#125;</code>，但会保留以下指标：<code>foo&#123;real_port=&quot;123&quot;,needed_port=&quot;456&quot;&#125;</code>。</p>
<p>有时可能需要只对指标子集应用 relabel，在这种情况下，可以将 <code>if</code> 选项添加到 <code>relabel_configs</code> 规则中，例如以下规则仅将 <code>&#123;foo=&quot;bar&quot;&#125;</code> 标签添加到与 <code>metric&#123;label=~&quot;x|y&quot;&#125;</code> 序列选择器匹配的指标：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">if:</span> <span class="string">&#x27;metric&#123;label=~&quot;x|y&quot;&#125;&#x27;</span></span><br><span class="line">  <span class="attr">target_label:</span> <span class="string">&#x27;foo&#x27;</span></span><br><span class="line">  <span class="attr">replacement:</span> <span class="string">&#x27;bar&#x27;</span></span><br></pre></td></tr></table></figure>

<p><code>if</code> 选项可以简化传统的 <code>relabel_configs</code> 规则，例如，以下规则可以删除与 <code>foo&#123;bar=&quot;baz&quot;&#125;</code> 序列选择器匹配的指标：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">if:</span> <span class="string">&#x27;foo&#123;bar=&quot;baz&quot;&#125;&#x27;</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">drop</span></span><br></pre></td></tr></table></figure>

<p>这相当于以下传统的规则：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">  <span class="attr">source_labels:</span> [<span class="string">__name__</span>, <span class="string">bar</span>]</span><br><span class="line">  <span class="attr">regex:</span> <span class="string">&#x27;foo;baz&#x27;</span></span><br></pre></td></tr></table></figure>

<p>不过需要注意的是 Prometheus 还不支持 <code>if</code> 选项，现在只支持 VictoriaMetrics。</p>
<p>现在更新 vmagent 的配置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">☸ ➜ kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vmagent-config2.yaml</span><br></pre></td></tr></table></figure>

<p>配置刷新有两种方式：</p>
<ul>
<li>发送 SUGHUP 信号给 vmagent 进程</li>
<li>向 <code>http://vmagent:8429/-/reload</code> 发送一个 http 请求</li>
</ul>
<p>刷新后就可以开始采集上面的指标了，同样我们也可以通过 <code>http://vmselect/select/0/vmui/</code> 来访问 vmui，比如现在我们来查询 pod 的内存使用率，可以使用如下的查询语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(container_memory_working_set_bytes&#123;image!=&quot;&quot;&#125;) by(namespace, pod) / sum(container_spec_memory_limit_bytes&#123;image!=&quot;&quot;&#125;) by(namespace, pod) * 100 != +inf</span><br></pre></td></tr></table></figure>

<p><img data-src="https://mudutestmenu.mudu.tv/upload/ppyv8m.jpg" alt="vmui"></p>
<p>vmagent 作为采集指标重要的一环，当然对它的监控也不可少。vmagent 通过 <code>http://vmagent:8429/metrics</code> 暴露了很多指标，如 <code>vmagent_remotewrite_conns</code> 远程存储连接，<code>vm_allowed_memory_bytes</code> 可使用的内存大小，我们把一些重要的指标收集起来，通过 Grafana 进行展示，能够更好的帮助我们分析 vmagent 的状态。</p>
<p>我们可以使用 <a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/12683">https://grafana.com/grafana/dashboards/12683</a> 来展示 vmagent 的状态。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/4viigu.png" alt="vmagent grafana"></p>
<p>此外如果想要查看 vmagent 的抓取的 targets，也通过通过 vmagent 提供的简单页面查看，不过只能查看到指定 vmagent 的，不能直接查看所有的 targets。</p>
<p><img data-src="https://mudutestmenu.mudu.tv/upload/tgwz8g.jpg" alt="vmagent targets"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/11/%E4%B8%BA%E4%BB%80%E4%B9%88%20TCP%20%E6%8C%A5%E6%89%8B%E9%9C%80%E8%A6%81%E6%9C%89%20TIME_WAIT%20%E7%8A%B6%E6%80%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="六一">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/11/%E4%B8%BA%E4%BB%80%E4%B9%88%20TCP%20%E6%8C%A5%E6%89%8B%E9%9C%80%E8%A6%81%E6%9C%89%20TIME_WAIT%20%E7%8A%B6%E6%80%81/" class="post-title-link" itemprop="url">为什么 TCP 挥手需要有 TIME_WAIT 状态</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-09-11 20:32:34 / 修改时间：22:17:52" itemprop="dateCreated datePublished" datetime="2025-09-11T20:32:34+08:00">2025-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WEB/" itemprop="url" rel="index"><span itemprop="name">WEB</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WEB/Http/" itemprop="url" rel="index"><span itemprop="name">Http</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><code>TIME_WAIT</code> 状态是 TCP 四次挥手过程中一个非常关键且必要的阶段，它主要位于<strong>主动关闭连接的一方</strong>。它的存在是为了解决两个核心问题：</p>
<h3 id="问题一：确保四次挥手最后一个-ACK-报文可靠到达，防止服务器端重传-FIN-报文。"><a href="#问题一：确保四次挥手最后一个-ACK-报文可靠到达，防止服务器端重传-FIN-报文。" class="headerlink" title="问题一：确保四次挥手最后一个 ACK 报文可靠到达，防止服务器端重传 FIN 报文。"></a>问题一：确保四次挥手最后一个 ACK 报文可靠到达，防止服务器端重传 FIN 报文。</h3><ul>
<li><strong>场景：</strong> 假设 TCP 没有 <code>TIME_WAIT</code> 状态，客户端（主动关闭方）发送了最后一个 <code>ACK</code> 后立即关闭连接，进入 <code>CLOSED</code> 状态。</li>
<li><strong>潜在问题：</strong> 如果最后一个 <code>ACK</code> 在网络中丢失了，服务器端就没有收到这个 <code>ACK</code>。根据 TCP 的可靠性机制，服务器会认为它的 <code>FIN</code> 报文没有被确认，就会尝试<strong>重传</strong> <code>FIN</code> 报文。</li>
<li><strong>后果：</strong><ul>
<li>如果客户端已经立即进入 <code>CLOSED</code> 状态并释放了端口，而服务器重传的 <code>FIN</code> 报文到达时，如果客户端的该端口已经被新的连接占用（或直接拒绝接收），服务器将永远无法收到对 <code>FIN</code> 的确认，它会一直停留在 <code>LAST_ACK</code> 状态，耗尽资源并最终超时。</li>
<li><code>TIME_WAIT</code> 状态让客户端保持一个足够长的时间（2 MSL，通常是 1-4 分钟），如果服务器重传 <code>FIN</code> 报文，客户端依然可以发送新的 <code>ACK</code> 报文作为回应，并重置 <code>TIME_WAIT</code> 定时器。这样，服务器最终会收到确认，从而能够顺利关闭连接，进入 <code>CLOSED</code> 状态。</li>
</ul>
</li>
</ul>
<h3 id="问题二：防止“旧连接”的迟到报文段干扰“新连接”。"><a href="#问题二：防止“旧连接”的迟到报文段干扰“新连接”。" class="headerlink" title="问题二：防止“旧连接”的迟到报文段干扰“新连接”。"></a>问题二：防止“旧连接”的迟到报文段干扰“新连接”。</h3><ul>
<li><strong>场景：</strong> 客户端关闭一个连接后，可能很快又会用相同的源 IP 地址、源端口号、目的 IP 地址、目的端口号，重新建立一个新的连接。这在短连接、高并发的场景中尤其常见。</li>
<li><strong>潜在问题：</strong> 如果没有 <code>TIME_WAIT</code>，或者 <code>TIME_WAIT</code> 时间太短，那么在旧连接关闭后，新的连接可能很快被建立起来。此时，网络中可能还漂浮着旧连接的，因为网络延迟而“迟到”的数据报文段。</li>
<li><strong>后果：</strong> 这些迟到的旧报文段，如果被新的连接接收并处理，可能会被误认为属于新连接的数据，从而导致数据混乱、应用程序行为异常甚至崩溃。</li>
<li><strong><code>TIME_WAIT</code> 的作用：</strong> <code>TIME_WAIT</code> 状态持续 2 * MSL (Maximum Segment Lifetime，最长报文段寿命) 的时间。MSL 是一个 TCP 报文段在网络中能够存活的最长时间。2 MSL 意味着：<ul>
<li>保证客户端发送的最后一个 <code>ACK</code> 在网络中来回一趟（1 MSL）有足够时间到达服务器。</li>
<li>保证服务器重传 <code>FIN</code> 报文（如果丢失的话）有足够时间到达客户端（另一个 MSL），并且客户端可以重新发送 <code>ACK</code>。</li>
<li>最重要的是，确保在该连接终止后，在网络中所有可能滞留的、属于该连接的<strong>任何迟到报文段都已超时和消逝</strong>。这样，当一个新的连接建立时，就不会受到旧报文段的干扰。</li>
</ul>
</li>
</ul>
<h3 id="TIME-WAIT-状态的缺点："><a href="#TIME-WAIT-状态的缺点：" class="headerlink" title="TIME_WAIT 状态的缺点："></a><code>TIME_WAIT</code> 状态的缺点：</h3><p>尽管 <code>TIME_WAIT</code> 状态至关重要，但它也有一些缺点，尤其是在高并发的短连接服务器上：</p>
<ul>
<li><strong>端口资源占用：</strong> 在 <code>TIME_WAIT</code> 期间，端口仍然被占用，不能立即用于新的连接。在高并发场景下，这可能导致端口耗尽问题（通常体现在客户端），因为客户端的瞬态端口是有限的。</li>
<li><strong>系统资源消耗：</strong> 每个处于 <code>TIME_WAIT</code> 的连接都需要占用一定的内存和系统资源。</li>
</ul>
<h3 id="如何应对-TIME-WAIT-引起的端口耗尽问题："><a href="#如何应对-TIME-WAIT-引起的端口耗尽问题：" class="headerlink" title="如何应对 TIME_WAIT 引起的端口耗尽问题："></a>如何应对 <code>TIME_WAIT</code> 引起的端口耗尽问题：</h3><ol>
<li><strong>缩短 MSL 值：</strong> 在某些操作系统中可以调整 MSL 值，从而缩短 <code>TIME_WAIT</code> 持续时间。但这需要谨慎，以免引入“旧报文段”问题。</li>
<li><strong><code>SO_REUSEADDR</code> 选项：</strong> 在服务器端，设置 <code>SO_REUSEADDR</code> 套接字选项可以让服务器在处于 <code>TIME_WAIT</code> 状态时，快速重用一个端口进行绑定。这主要解决服务器重启后无法立即绑定到之前端口的问题，但通常不解决客户端端口耗尽的问题。</li>
<li><strong>合理调整 <code>net.ipv4.tcp_tw_reuse</code> 和 <code>net.ipv4.tcp_tw_recycle</code> (Linux)：</strong><ul>
<li><code>tcp_tw_reuse</code>：允许将处于 <code>TIME_WAIT</code> 状态的端口重新用于新的 TCP 连接，但仅限于主动发起的新连接（通常是客户端），且要求新的连接的对方的 TCP 时间戳必须<strong>大于</strong>旧连接的时间戳，以避免旧报文段问题。</li>
<li><code>tcp_tw_recycle</code>：这个选项在 Linux 4.12 之后已经被弃用或不再建议使用，因为它会导致 NAT 环境下的连接问题。它通过依赖时间戳来回收 <code>TIME_WAIT</code> 端口，但如果中间存在 NAT 设备，不同客户端可能共享同一个公网 IP，导致时间戳问题。</li>
</ul>
</li>
</ol>
<p>总而言之，<code>TIME_WAIT</code> 状态是 TCP 保证连接可靠性和避免数据混乱的一个必要设计，其牺牲了一部分端口即时可用性来换取更强的健壮性。理解其原因有助于在实际开发和运维中做更好的权衡。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/20/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/22/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">六一</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">273</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/huiaz" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;huiaz" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">六一</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.7m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">25:34</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true}});</script></body>
</html>
